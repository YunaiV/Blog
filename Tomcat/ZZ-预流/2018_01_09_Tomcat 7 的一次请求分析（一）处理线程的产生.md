title: Tomcat 7 çš„ä¸€æ¬¡è¯·æ±‚åˆ†æï¼ˆä¸€ï¼‰å¤„ç†çº¿ç¨‹çš„äº§ç”Ÿ
date: 2018-01-09
tag: 
categories: Tomcat
permalink: Tomcat/yuliu/A-request-analysis-1-process-the-generation-of-threads
author: é¢„æµ
from_url: https://juejin.im/user/59356fea570c35005b5fc55b/posts
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://juejin.im/post/5a6d73a36fb9a01cba42d1d7 ã€Œé¢„æµã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åœ¨é»˜è®¤çš„é…ç½®ä¸‹Tomcatå¯åŠ¨å¥½ä¹‹åä¼šçœ‹åˆ°åå°ä¸Šæ€»å…±æœ‰6ä¸ªçº¿ç¨‹åœ¨è¿è¡Œã€‚å…¶ä¸­1ä¸ªç”¨æˆ·çº¿ç¨‹ï¼Œå‰©ä¸‹5ä¸ªä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚

![img](https://user-gold-cdn.xitu.io/2018/1/31/1614b60773dd2a06?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 å¦‚æœä½ å¯¹ç”¨æˆ·çº¿ç¨‹ã€å®ˆæŠ¤çº¿ç¨‹ç­‰æ¦‚å¿µä¸ç†Ÿæ‚‰ï¼Œè¯·å‚çœ‹å‰ä¸€ç¯‡æ–‡ç« â€”â€”

Tomcat 7 æœåŠ¡å™¨å…³é—­åŸç†

ã€‚ è¿™é‡Œé‡ç‚¹å…³æ³¨ä»¥ http-bio-8080 å¼€å¤´çš„ä¸¤ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼ˆå³ http-bio-8080-Acceptor-0 å’Œ http-bio-8080-AsyncTimeout ï¼‰ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬åœ¨ Tomcat çš„é»˜è®¤é…ç½®ä¸‹å‘å¸ƒ web åº”ç”¨æ—¶å®é™…å¤„ç†è¯·æ±‚çš„çº¿ç¨‹ã€‚å…ˆçœ‹ä¸‹è¿™ä¸¤ä¸ªçº¿ç¨‹åœ¨å®¹å™¨å¯åŠ¨æ—¶æ˜¯å¦‚ä½•äº§ç”Ÿå’Œå¯åŠ¨çš„ã€‚



åœ¨å‰é¢å°† Tomcat å¯åŠ¨çš„ç³»åˆ—æ–‡ç« ä¸­çœ‹åˆ° Tomcat å®¹å™¨å¯åŠ¨æ—¶ä¼šç”¨ Digester è¯»å– server.xml æ–‡ä»¶äº§ç”Ÿç›¸åº”çš„ç»„ä»¶å¯¹è±¡å¹¶é‡‡å–é“¾å¼è°ƒç”¨çš„æ–¹å¼è°ƒç”¨å®ƒä»¬çš„ init å’Œ start æ–¹æ³•ï¼Œåœ¨ Digester è¯»å–åˆ° server.xml ä¸­çš„ connector èŠ‚ç‚¹æ—¶æ˜¯è¿™ä¹ˆå¤„ç†çš„ï¼š

```Java
        digester.addRule("Server/Service/Connector",
                         new ConnectorCreateRule());
        digester.addRule("Server/Service/Connector",
                         new SetAllPropertiesRule(new String[]{"executor"}));
        digester.addSetNext("Server/Service/Connector",
                            "addConnector",
                            "org.apache.catalina.connector.Connector");

```

ä»¥ä¸Šä»£ç è§`org.apache.catalina.startup.Catalina`ç±»çš„ 366 åˆ° 372 è¡Œã€‚æ‰€ä»¥åœ¨ç¢°åˆ° server.xml æ–‡ä»¶ä¸­çš„ Server/Service/Connector èŠ‚ç‚¹æ—¶å°†ä¼šè§¦å‘ ConnectorCreateRule ç±»çš„ begin æ–¹æ³•çš„è°ƒç”¨ï¼š

```Java
     1	    public void begin(String namespace, String name, Attributes attributes)
     2	            throws Exception {
     3	        Service svc = (Service)digester.peek();
     4	        Executor ex = null;
     5	        if ( attributes.getValue("executor")!=null ) {
     6	            ex = svc.getExecutor(attributes.getValue("executor"));
     7	        }
     8	        Connector con = new Connector(attributes.getValue("protocol"));
     9	        if ( ex != null )  _setExecutor(con,ex);
    10
    11	        digester.push(con);
    12	    }

```

åœ¨ç¬¬ 8 è¡Œï¼Œä¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­ Server/Service/Connector èŠ‚ç‚¹çš„ protocol å±æ€§è°ƒç”¨ `org.apache.catalina.connector.Connector` ç±»çš„æ„é€ æ–¹æ³•ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ server.xml æ–‡ä»¶ä¸­ Server/Service/Connector èŠ‚ç‚¹å…±æœ‰ä¸¤å¤„é…ç½®ï¼š

```XML
<Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />

<Connector port="8009" protocol="AJP/1.3" redirectPort="8443" />

```

å…ˆçœ‹ç¬¬ä¸€ä¸ª Connector èŠ‚ç‚¹ï¼Œè°ƒç”¨ Connector çš„æ„é€ æ–¹æ³•æ—¶ä¼šä¼ å…¥å­—ç¬¦ä¸² HTTP/1.1

```Java
     1	    public Connector(String protocol) {
     2	        setProtocol(protocol);
     3	        // Instantiate protocol handler
     4	        try {
     5	            Class<?> clazz = Class.forName(protocolHandlerClassName);
     6	            this.protocolHandler = (ProtocolHandler) clazz.newInstance();
     7	        } catch (Exception e) {
     8	            log.error(sm.getString(
     9	                    "coyoteConnector.protocolHandlerInstantiationFailed"), e);
    10	        }
    11	    }

```

è¿™é‡Œå…ˆä¼šæ‰§è¡Œ `org.apache.catalina.connector.Connector` ç±»çš„ setProtocol æ–¹æ³•ï¼š

```Java
     1	    public void setProtocol(String protocol) {
     2
     3	        if (AprLifecycleListener.isAprAvailable()) {
     4	            if ("HTTP/1.1".equals(protocol)) {
     5	                setProtocolHandlerClassName
     6	                    ("org.apache.coyote.http11.Http11AprProtocol");
     7	            } else if ("AJP/1.3".equals(protocol)) {
     8	                setProtocolHandlerClassName
     9	                    ("org.apache.coyote.ajp.AjpAprProtocol");
    10	            } else if (protocol != null) {
    11	                setProtocolHandlerClassName(protocol);
    12	            } else {
    13	                setProtocolHandlerClassName
    14	                    ("org.apache.coyote.http11.Http11AprProtocol");
    15	            }
    16	        } else {
    17	            if ("HTTP/1.1".equals(protocol)) {
    18	                setProtocolHandlerClassName
    19	                    ("org.apache.coyote.http11.Http11Protocol");
    20	            } else if ("AJP/1.3".equals(protocol)) {
    21	                setProtocolHandlerClassName
    22	                    ("org.apache.coyote.ajp.AjpProtocol");
    23	            } else if (protocol != null) {
    24	                setProtocolHandlerClassName(protocol);
    25	            }
    26	        }
    27
    28	    }

```

æ‰€ä»¥æ­¤æ—¶ä¼šè°ƒç”¨`setProtocolHandlerClassName("org.apache.coyote.http11.Http11Protocol")`ä»è€Œå°† Connector ç±»å®ä¾‹å˜é‡ protocolHandlerClassName å€¼è®¾ç½®ä¸º`org.apache.coyote.http11.Http11Protocol`ï¼Œæ¥ä¸‹æ¥åœ¨ Connector çš„æ„é€ æ–¹æ³•ä¸­å°±ä¼šæ ¹æ® protocolHandlerClassName å˜é‡çš„å€¼äº§ç”Ÿä¸€ä¸ª`org.apache.coyote.http11.Http11Protocol`å¯¹è±¡ï¼Œå¹¶å°†è¯¥å¯¹è±¡èµ‹å€¼ç»™ Connector ç±»çš„å®ä¾‹å˜é‡ protocolHandler ã€‚åœ¨ Http11Protocol ç±»çš„æ„é€ æ–¹æ³•ä¸­ä¼šäº§ç”Ÿä¸€ä¸ª`org.apache.tomcat.util.net.JIoEndpoint`å¯¹è±¡ï¼š

```Java
     1	    public Http11Protocol() {
     2	        endpoint = new JIoEndpoint();
     3	        cHandler = new Http11ConnectionHandler(this);
     4	        ((JIoEndpoint) endpoint).setHandler(cHandler);
     5	        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
     6	        setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
     7	        setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
     8	    }

```

å‡ ä¸ªç›¸å…³å¯¹è±¡çš„æ„é€ æ–¹æ³•è°ƒç”¨æ—¶åºå›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­`org.apache.coyote.AbstractProtocol`æ˜¯`org.apache.coyote.http11.Http11Protocol`çš„çˆ¶ç±»`org.apache.tomcat.util.net.AbstractEndpoint`æ˜¯`org.apache.tomcat.util.net.JIoEndpoint`çš„çˆ¶ç±»ã€‚

![img](https://user-gold-cdn.xitu.io/2018/1/31/1614b682edd6e75a?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 æ¥ä¸‹æ¥å®¹å™¨å¯åŠ¨å„ç»„ä»¶æ—¶ä¼šè°ƒç”¨

```Java
org.apache.catalina.connector.Connector
```

çš„ start æ–¹æ³•ï¼Œå¦‚å‰é¢åˆ†æ Tomcat å¯åŠ¨æ—¶æ‰€è¿°ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨

```Java
org.apache.catalina.connector.Connector
```

ç±»çš„ startInternal æ–¹æ³•ï¼š



```Java
    protected void startInternal() throws LifecycleException {

        // Validate settings before starting
        if (getPort() < 0) {
            throw new LifecycleException(sm.getString(
                    "coyoteConnector.invalidPort", Integer.valueOf(getPort())));
        }

        setState(LifecycleState.STARTING);

        try {
            protocolHandler.start();
        } catch (Exception e) {
            String errPrefix = "";
            if(this.service != null) {
                errPrefix += "service.getName(): \"" + this.service.getName() + "\"; ";
            }

            throw new LifecycleException
                (errPrefix + " " + sm.getString
                 ("coyoteConnector.protocolHandlerStartFailed"), e);
        }

        mapperListener.start();
    }

```

åœ¨ç¬¬ 12 è¡Œï¼Œå°†ä¼šè°ƒç”¨å®ä¾‹å˜é‡ protocolHandler çš„ start æ–¹æ³•ã€‚åœ¨ä¸Šé¢åˆ†æ Connector ç±»çš„æ„é€ å‡½æ•°æ—¶å‘ç° protocolHandler å˜é‡çš„å€¼å°±æ˜¯`org.apache.coyote.http11.Http11Protocol`å¯¹è±¡ï¼Œæ‰€ä»¥æ­¤æ—¶å°†ä¼šè°ƒç”¨è¯¥ç±»çš„ start æ–¹æ³•ã€‚åœ¨ Http11Protocol ç±»ä¸­æ²¡æœ‰å®šä¹‰ start æ–¹æ³•ï¼Œè¿™é‡Œå°†ä¼šè°ƒç”¨å…¶çˆ¶ç±»`org.apache.coyote.AbstractProtocol`ä¸­çš„ start æ–¹æ³•ï¼š

```Java
    public void start() throws Exception {
        if (getLog().isInfoEnabled())
            getLog().info(sm.getString("abstractProtocolHandler.start",
                    getName()));
        try {
            endpoint.start();
        } catch (Exception ex) {
            getLog().error(sm.getString("abstractProtocolHandler.startError",
                    getName()), ex);
            throw ex;
        }
    }

```

è¿™é‡Œä¼šè°ƒç”¨ endpoint å¯¹è±¡çš„ start æ–¹æ³•ï¼Œè€Œ endpoint æ˜¯`org.apache.tomcat.util.net.JIoEndpoint`ç±»çš„å®ä¾‹ï¼ˆåœ¨ä¸Šé¢è®² Http11Protocol ç±»çš„æ„é€ æ–¹æ³•æ—¶æ‰€æåˆ°ï¼‰ï¼Œè¿™é‡Œæœ€ç»ˆä¼šæ‰§è¡Œè¯¥ç±»çš„ startInternal æ–¹æ³•ï¼š

```Java
     1	    @Override
     2	    public void startInternal() throws Exception {
     3
     4	        if (!running) {
     5	            running = true;
     6	            paused = false;
     7
     8	            // Create worker collection
     9	            if (getExecutor() == null) {
    10	                createExecutor();
    11	            }
    12
    13	            initializeConnectionLatch();
    14
    15	            startAcceptorThreads();
    16
    17	            // Start async timeout thread
    18	            Thread timeoutThread = new Thread(new AsyncTimeout(),
    19	                    getName() + "-AsyncTimeout");
    20	            timeoutThread.setPriority(threadPriority);
    21	            timeoutThread.setDaemon(true);
    22	            timeoutThread.start();
    23	        }
    24	    }

```

æ­£æ˜¯åœ¨è¿™é‡Œäº§ç”Ÿå¹¶å¯åŠ¨æœ¬æ–‡å¼€å¤´æåˆ°çš„ http-bio-8080-Acceptor-0 å’Œ http-bio-8080-AsyncTimeout ä¸¤ä¸ªçº¿ç¨‹ã€‚ç¬¬ 17 åˆ° 22 è¡Œå°±æ˜¯äº§ç”Ÿå’Œå¯åŠ¨ http-bio-8080-AsyncTimeout çº¿ç¨‹ï¼Œç¬¬ 15 è¡Œè¿™é‡Œè°ƒç”¨çˆ¶ç±»`org.apache.tomcat.util.net.AbstractEndpoint`çš„ startAcceptorThreads æ–¹æ³•ï¼š

```Java
     1	    protected final void startAcceptorThreads() {
     2	        int count = getAcceptorThreadCount();
     3	        acceptors = new Acceptor[count];
     4
     5	        for (int i = 0; i < count; i++) {
     6	            acceptors[i] = createAcceptor();
     7	            String threadName = getName() + "-Acceptor-" + i;
     8	            acceptors[i].setThreadName(threadName);
     9	            Thread t = new Thread(acceptors[i], threadName);
    10	            t.setPriority(getAcceptorThreadPriority());
    11	            t.setDaemon(getDaemon());
    12	            t.start();
    13	        }
    14	    }
    15
    16
    17	    /**
    18	     * Hook to allow Endpoints to provide a specific Acceptor implementation.
    19	     */
    20	    protected abstract Acceptor createAcceptor();

```

åœ¨è¿™é‡Œå°†äº§ç”Ÿå’Œå¯åŠ¨ http-bio-8080-Acceptor-0 çº¿ç¨‹ã€‚æ³¨æ„åœ¨æ„é€ è¯¥çº¿ç¨‹æ—¶ç¬¬ 6 è¡Œå°†ä¼šè°ƒç”¨ç¬¬ 20 è¡Œçš„æŠ½è±¡æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å…·ä½“å®ç°æ˜¯åœ¨ JIoEndpoint ç±»ä¸­ï¼š

```Java
    @Override
    protected AbstractEndpoint.Acceptor createAcceptor() {
        return new Acceptor();
    }

```

ä»¥ä¸Šä¾¿æ˜¯æœ¬æ–‡å¼€å¤´æ‰€è¿°çš„ä¸¤ä¸ªåå°çº¿ç¨‹äº§ç”Ÿå’Œå¯åŠ¨çš„æµç¨‹ï¼Œå…¶ç›¸å…³ç±»è°ƒç”¨çš„æ—¶åºå›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://user-gold-cdn.xitu.io/2018/1/31/1614b6c63a19dfeb?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 åŒç†ï¼Œajp-bio-8009-Acceptor-0 å’Œ ajp-bio-8009-AsyncTimeout ä¸¤ä¸ªå®ˆæŠ¤çº¿ç¨‹çš„äº§ç”Ÿå’Œå¯åŠ¨æ–¹å¼ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼Œä¸å†èµ˜è¿°ã€‚