title: Tomcat 7 æœåŠ¡å™¨å…³é—­åŸç†
date: 2018-01-09
tag: 
categories: Tomcat
permalink: Tomcat/yuliu/Server-shutdown-principle
author: é¢„æµ
from_url: https://juejin.im/post/5a6d77916fb9a01c9c1f4440
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://juejin.im/post/5a6d77916fb9a01c9c1f4440 ã€Œé¢„æµã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä¹‹å‰çš„[å‡ ç¯‡æ–‡ç« ](#)è®²äº† Tomcat çš„å¯åŠ¨è¿‡ç¨‹ï¼Œåœ¨é»˜è®¤çš„é…ç½®ä¸‹å¯åŠ¨å®Œä¹‹åä¼šçœ‹åˆ°åå°å®é™…ä¸Šæ€»å…±æœ‰ 6 ä¸ªçº¿ç¨‹åœ¨è¿è¡Œã€‚å³ 1 ä¸ªç”¨æˆ·çº¿ç¨‹ï¼Œå‰©ä¸‹ 5 ä¸ªä¸ºå®ˆæŠ¤çº¿ç¨‹(ä¸‹å›¾ä¸­çš„ Daemon Thread )ã€‚

![img](https://user-gold-cdn.xitu.io/2018/1/28/1613b9baf08c55d8?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 å¦‚æœå¯¹ä»€ä¹ˆå«å®ˆæŠ¤çº¿ç¨‹çš„æ¦‚å¿µæ¯”è¾ƒé™Œç”Ÿï¼Œè¿™é‡Œå†é‡å¤ä¸€ä¸‹ï¼š



æ‰€è°“å®ˆæŠ¤çº¿ç¨‹ï¼Œæ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åœ¨åå°æä¾›ä¸€ç§é€šç”¨æœåŠ¡çš„çº¿ç¨‹ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹ã€‚è¿™ç§çº¿ç¨‹å¹¶ä¸å±äºç¨‹åºä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ï¼Œå½“æ‰€æœ‰çš„éå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿå°±ç»ˆæ­¢äº†ï¼ŒåŒæ—¶ä¼šæ€æ­»è¿›ç¨‹ä¸­çš„æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹ã€‚åè¿‡æ¥è¯´ï¼Œåªè¦ä»»ä½•éå®ˆæŠ¤çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œç¨‹åºå°±ä¸ä¼šç»ˆæ­¢ã€‚

ç”¨æˆ·çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ä¸¤è€…å‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼Œå”¯ä¸€çš„ä¸åŒä¹‹å¤„å°±åœ¨äºè™šæ‹Ÿæœºçš„ç¦»å¼€ï¼šå¦‚æœç”¨æˆ·çº¿ç¨‹å·²ç»å…¨éƒ¨é€€å‡ºè¿è¡Œäº†ï¼Œåªå‰©ä¸‹å®ˆæŠ¤çº¿ç¨‹å­˜åœ¨äº†ï¼Œè™šæ‹Ÿæœºä¹Ÿå°±é€€å‡ºäº†ã€‚å› ä¸ºæ²¡æœ‰äº†è¢«å®ˆæŠ¤è€…ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¹Ÿå°±æ²¡æœ‰å·¥ä½œå¯åšäº†ï¼Œä¹Ÿå°±æ²¡æœ‰ç»§ç»­è¿è¡Œç¨‹åºçš„å¿…è¦äº†ã€‚å°†çº¿ç¨‹è½¬æ¢ä¸ºå®ˆæŠ¤çº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨ Thread å¯¹è±¡çš„ setDaemon(true) æ–¹æ³•æ¥å®ç°ã€‚

Tomcat çš„å…³é—­æ­£æ˜¯åˆ©ç”¨äº†è¿™ä¸ªåŸç†ï¼Œå³åªè¦å°†é‚£å”¯ä¸€çš„ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å…³é—­ï¼Œåˆ™æ•´ä¸ªåº”ç”¨å°±å…³é—­äº†ã€‚

è¦ç ”ç©¶è¿™ä¸ªç”¨æˆ·çº¿ç¨‹æ€ä¹ˆè¢«å…³é—­çš„å¾—å…ˆä»è¿™ä¸ªçº¿ç¨‹ä»ä½•äº§ç”Ÿè¯´èµ·ã€‚åœ¨å‰é¢åˆ†æ Tomcat çš„å¯åŠ¨æ—¶æˆ‘ä»¬æ˜¯ä»`org.apache.catalina.startup.Bootstrap`ç±»çš„ main æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œè¯¥ç±»çš„ 453 åˆ° 456 è¡Œæ˜¯ Tomcat å¯åŠ¨æ—¶ä¼šæ‰§è¡Œçš„ä»£ç ï¼š

![img](https://user-gold-cdn.xitu.io/2018/1/28/1613b9cba3e0463c?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 å‰é¢çš„æ–‡ç« é‡Œåˆ†æäº† daemon.load å’Œ daemon.start æ–¹æ³•ï¼Œè¿™é‡Œè¯·æ³¨æ„

```Java
daemon.setAwait(true);
```

 è¿™å¥ï¼Œå®ƒçš„ä½œç”¨æ˜¯é€šè¿‡åå°„è°ƒç”¨

```Java
org.apache.catalina.startup.Catalina
```

ç±»çš„ setAwait(true) æ–¹æ³•ï¼Œæœ€ç»ˆå°† Catalina ç±»çš„å®ä¾‹å˜é‡ await è®¾å€¼ä¸º true ã€‚



Catalina ç±»çš„ setAwait æ–¹æ³•ä»£ç ï¼š

```Java
    /**
     * Set flag.
     */
    public void setAwait(boolean await)
        throws Exception {

        Class<?> paramTypes[] = new Class[1];
        paramTypes[0] = Boolean.TYPE;
        Object paramValues[] = new Object[1];
        paramValues[0] = Boolean.valueOf(await);
        Method method =
            catalinaDaemon.getClass().getMethod("setAwait", paramTypes);
        method.invoke(catalinaDaemon, paramValues);

    }

```

å¦‚å‰æ–‡åˆ†æï¼ŒTomcat å¯åŠ¨æ—¶ä¼šè°ƒç”¨`org.apache.catalina.startup.Catalina`ç±»çš„ start æ–¹æ³•ï¼Œçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„ä»£ç ï¼š

```Java
     1	    /**
     2	     * Start a new server instance.
     3	     */
     4	    public void start() {
     5
     6	        if (getServer() == null) {
     7	            load();
     8	        }
     9
    10	        if (getServer() == null) {
    11	            log.fatal("Cannot start server. Server instance is not configured.");
    12	            return;
    13	        }
    14
    15	        long t1 = System.nanoTime();
    16
    17	        // Start the new server
    18	        try {
    19	            getServer().start();
    20	        } catch (LifecycleException e) {
    21	            log.fatal(sm.getString("catalina.serverStartFail"), e);
    22	            try {
    23	                getServer().destroy();
    24	            } catch (LifecycleException e1) {
    25	                log.debug("destroy() failed for failed Server ", e1);
    26	            }
    27	            return;
    28	        }
    29
    30	        long t2 = System.nanoTime();
    31	        if(log.isInfoEnabled()) {
    32	            log.info("Server startup in " + ((t2 - t1) / 1000000) + " ms");
    33	        }
    34
    35	        // Register shutdown hook
    36	        if (useShutdownHook) {
    37	            if (shutdownHook == null) {
    38	                shutdownHook = new CatalinaShutdownHook();
    39	            }
    40	            Runtime.getRuntime().addShutdownHook(shutdownHook);
    41
    42	            // If JULI is being used, disable JULI's shutdown hook since
    43	            // shutdown hooks run in parallel and log messages may be lost
    44	            // if JULI's hook completes before the CatalinaShutdownHook()
    45	            LogManager logManager = LogManager.getLogManager();
    46	            if (logManager instanceof ClassLoaderLogManager) {
    47	                ((ClassLoaderLogManager) logManager).setUseShutdownHook(
    48	                        false);
    49	            }
    50	        }
    51
    52	        if (await) {
    53	            await();
    54	            stop();
    55	        }
    56	    }

```

å‰æ–‡åˆ†æå¯åŠ¨æ—¶å‘ç°é€šè¿‡ç¬¬ 19 è¡Œ getServer().start() çš„è¿™æ¬¡æ–¹æ³•è°ƒç”¨ï¼ŒTomcat æ¥ä¸‹æ¥ä¼šä¸€æ­¥æ­¥å¯åŠ¨æ‰€æœ‰åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„ç»„ä»¶ã€‚åé¢çš„ä»£ç æ²¡æœ‰åˆ†æï¼Œè¿™é‡Œè¯·å…³æ³¨æœ€åç¬¬ 52 åˆ° 55 è¡Œï¼Œä¸Šé¢è¯´åˆ°å·²ç»å°† Catalina ç±»çš„å®ä¾‹å˜é‡ await è®¾å€¼ä¸º trueï¼Œæ‰€ä»¥è¿™é‡Œå°†ä¼šæ‰§è¡Œ Catalina ç±»çš„ await æ–¹æ³•ï¼š

```Java
    /**
     * Await and shutdown.
     */
    public void await() {

        getServer().await();

    }

```

è¯¥æ–¹æ³•å°±ä¸€å¥è¯ï¼Œæ„æ€æ˜¯è°ƒç”¨`org.apache.catalina.core.StandardServer`ç±»çš„ await æ–¹æ³•ï¼š

```Java
     1	    /**
     2	     * Wait until a proper shutdown command is received, then return.
     3	     * This keeps the main thread alive - the thread pool listening for http
     4	     * connections is daemon threads.
     5	     */
     6	    @Override
     7	    public void await() {
     8	        // Negative values - don't wait on port - tomcat is embedded or we just don't like ports
     9	        if( port == -2 ) {
    10	            // undocumented yet - for embedding apps that are around, alive.
    11	            return;
    12	        }
    13	        if( port==-1 ) {
    14	            try {
    15	                awaitThread = Thread.currentThread();
    16	                while(!stopAwait) {
    17	                    try {
    18	                        Thread.sleep( 10000 );
    19	                    } catch( InterruptedException ex ) {
    20	                        // continue and check the flag
    21	                    }
    22	                }
    23	            } finally {
    24	                awaitThread = null;
    25	            }
    26	            return;
    27	        }
    28
    29	        // Set up a server socket to wait on
    30	        try {
    31	            awaitSocket = new ServerSocket(port, 1,
    32	                    InetAddress.getByName(address));
    33	        } catch (IOException e) {
    34	            log.error("StandardServer.await: create[" + address
    35	                               + ":" + port
    36	                               + "]: ", e);
    37	            return;
    38	        }
    39
    40	        try {
    41	            awaitThread = Thread.currentThread();
    42
    43	            // Loop waiting for a connection and a valid command
    44	            while (!stopAwait) {
    45	                ServerSocket serverSocket = awaitSocket;
    46	                if (serverSocket == null) {
    47	                    break;
    48	                }
    49
    50	                // Wait for the next connection
    51	                Socket socket = null;
    52	                StringBuilder command = new StringBuilder();
    53	                try {
    54	                    InputStream stream;
    55	                    try {
    56	                        socket = serverSocket.accept();
    57	                        socket.setSoTimeout(10 * 1000);  // Ten seconds
    58	                        stream = socket.getInputStream();
    59	                    } catch (AccessControlException ace) {
    60	                        log.warn("StandardServer.accept security exception: "
    61	                                + ace.getMessage(), ace);
    62	                        continue;
    63	                    } catch (IOException e) {
    64	                        if (stopAwait) {
    65	                            // Wait was aborted with socket.close()
    66	                            break;
    67	                        }
    68	                        log.error("StandardServer.await: accept: ", e);
    69	                        break;
    70	                    }
    71
    72	                    // Read a set of characters from the socket
    73	                    int expected = 1024; // Cut off to avoid DoS attack
    74	                    while (expected < shutdown.length()) {
    75	                        if (random == null)
    76	                            random = new Random();
    77	                        expected += (random.nextInt() % 1024);
    78	                    }
    79	                    while (expected > 0) {
    80	                        int ch = -1;
    81	                        try {
    82	                            ch = stream.read();
    83	                        } catch (IOException e) {
    84	                            log.warn("StandardServer.await: read: ", e);
    85	                            ch = -1;
    86	                        }
    87	                        if (ch < 32)  // Control character or EOF terminates loop
    88	                            break;
    89	                        command.append((char) ch);
    90	                        expected--;
    91	                    }
    92	                } finally {
    93	                    // Close the socket now that we are done with it
    94	                    try {
    95	                        if (socket != null) {
    96	                            socket.close();
    97	                        }
    98	                    } catch (IOException e) {
    99	                        // Ignore
   100	                    }
   101	                }
   102
   103	                // Match against our command string
   104	                boolean match = command.toString().equals(shutdown);
   105	                if (match) {
   106	                    log.info(sm.getString("standardServer.shutdownViaPort"));
   107	                    break;
   108	                } else
   109	                    log.warn("StandardServer.await: Invalid command '"
   110	                            + command.toString() + "' received");
   111	            }
   112	        } finally {
   113	            ServerSocket serverSocket = awaitSocket;
   114	            awaitThread = null;
   115	            awaitSocket = null;
   116
   117	            // Close the server socket and return
   118	            if (serverSocket != null) {
   119	                try {
   120	                    serverSocket.close();
   121	                } catch (IOException e) {
   122	                    // Ignore
   123	                }
   124	            }
   125	        }
   126	    }

```

è¿™æ®µä»£ç å°±ä¸ä¸€ä¸€åˆ†æï¼Œæ€»ä½“ä½œç”¨å¦‚æ–¹æ³•å‰çš„æ³¨é‡Šæ‰€è¯´ï¼Œå³â€œ**ä¸€ç›´ç­‰å¾…åˆ°æ¥æ”¶åˆ°ä¸€ä¸ªæ­£ç¡®çš„å…³é—­å‘½ä»¤åè¯¥æ–¹æ³•å°†ä¼šè¿”å›ã€‚è¿™æ ·ä¼šä½¿ä¸»çº¿ç¨‹ä¸€ç›´å­˜æ´»â€”â€”ç›‘å¬httpè¿æ¥çš„çº¿ç¨‹æ± æ˜¯å®ˆæŠ¤çº¿ç¨‹**â€ã€‚

ç†Ÿæ‚‰ Java çš„ Socket ç¼–ç¨‹çš„è¯å¯¹è¿™æ®µä»£ç å°±å¾ˆå®¹æ˜“ç†è§£ï¼Œå°±æ˜¯é»˜è®¤åœ°å€ï¼ˆåœ°å€å€¼ç”±å®ä¾‹å˜é‡ address å®šä¹‰ï¼Œé»˜è®¤ä¸º`localhost`ï¼‰çš„é»˜è®¤çš„ç«¯å£ï¼ˆç«¯å£å€¼ç”±å®ä¾‹å˜é‡ port å®šä¹‰ï¼Œé»˜è®¤ä¸º`8005`ï¼‰ä¸Šç›‘å¬ Socket è¿æ¥ï¼Œå½“å‘ç°ç›‘å¬åˆ°çš„è¿æ¥çš„è¾“å…¥æµä¸­çš„å†…å®¹ä¸é»˜è®¤é…ç½®çš„å€¼åŒ¹é…ï¼ˆè¯¥å€¼é»˜è®¤ä¸ºå­—ç¬¦ä¸²`SHUTDOWN`ï¼‰åˆ™è·³å‡ºå¾ªç¯ï¼Œè¯¥æ–¹æ³•è¿”å›ï¼ˆç¬¬ 103 åˆ° 107 è¡Œï¼‰ã€‚å¦åˆ™è¯¥æ–¹æ³•ä¼šä¸€ç›´å¾ªç¯æ‰§è¡Œä¸‹å»ã€‚ ä¸€èˆ¬æ¥è¯´è¯¥ç”¨æˆ·ä¸»çº¿ç¨‹ä¼šé˜»å¡ï¼ˆç¬¬ 56 è¡Œï¼‰ç›´åˆ°æœ‰è®¿é—®`localhost:8005`çš„è¿æ¥å‡ºç°ã€‚ æ­£å› ä¸ºå¦‚æ­¤æ‰å‡ºç°å¼€å¤´çœ‹è§çš„ä¸»çº¿ç¨‹ä¸€ç›´ Running çš„æƒ…å†µï¼Œè€Œå› ä¸ºè¿™ä¸ªçº¿ç¨‹ä¸€ç›´ Running ï¼Œå…¶å®ƒå®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šä¸€ç›´å­˜åœ¨ã€‚

è¯´å®Œè¿™ä¸ªçº¿ç¨‹çš„äº§ç”Ÿï¼Œæ¥ä¸‹æ¥çœ‹çœ‹è¿™ä¸ªçº¿ç¨‹çš„å…³é—­ï¼ŒæŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œè¿™ä¸ªçº¿ç¨‹æä¾›äº†ä¸€ä¸ªå…³é—­æœºåˆ¶ï¼Œå³åªè¦è®¿é—®`localhost:8005`ï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ªå†…å®¹ä¸º`SHUTDOWN`çš„å­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥å…³é—­å®ƒäº†ã€‚

Tomcat æ­£æ˜¯è¿™ä¹ˆåšçš„ï¼Œä¸€èˆ¬æ¥è¯´å…³é—­ Tomcat é€šè¿‡æ‰§è¡Œ shutdown.bat æˆ– shutdown.sh è„šæœ¬ï¼Œå…³äºè¿™æ®µè„šæœ¬å¯å‚ç…§åˆ†æå¯åŠ¨è„šæœ¬é‚£ç¯‡æ–‡ç« ï¼Œæœºåˆ¶ç±»ä¼¼ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ`org.apache.catalina.startup.Bootstrap`ç±»çš„ main æ–¹æ³•ï¼Œå¹¶ä¼ å…¥å…¥å‚`"stop"`ï¼Œçœ‹ä¸‹æœ¬æ–‡ç¬¬ 2 å¼ å›¾ç‰‡ä¸­`org.apache.catalina.startup.Bootstrap`ç±»çš„ç¬¬ 458 è¡Œï¼Œæ¥ç€å°†è°ƒç”¨`org.apache.catalina.startup.Catalina`ç±» stopServer æ–¹æ³•ï¼š

```Java
     1	    public void stopServer(String[] arguments) {
     2
     3	        if (arguments != null) {
     4	            arguments(arguments);
     5	        }
     6
     7	        Server s = getServer();
     8	        if( s == null ) {
     9	            // Create and execute our Digester
    10	            Digester digester = createStopDigester();
    11	            digester.setClassLoader(Thread.currentThread().getContextClassLoader());
    12	            File file = configFile();
    13	            FileInputStream fis = null;
    14	            try {
    15	                InputSource is =
    16	                    new InputSource(file.toURI().toURL().toString());
    17	                fis = new FileInputStream(file);
    18	                is.setByteStream(fis);
    19	                digester.push(this);
    20	                digester.parse(is);
    21	            } catch (Exception e) {
    22	                log.error("Catalina.stop: ", e);
    23	                System.exit(1);
    24	            } finally {
    25	                if (fis != null) {
    26	                    try {
    27	                        fis.close();
    28	                    } catch (IOException e) {
    29	                        // Ignore
    30	                    }
    31	                }
    32	            }
    33	        } else {
    34	            // Server object already present. Must be running as a service
    35	            try {
    36	                s.stop();
    37	            } catch (LifecycleException e) {
    38	                log.error("Catalina.stop: ", e);
    39	            }
    40	            return;
    41	        }
    42
    43	        // Stop the existing server
    44	        s = getServer();
    45	        if (s.getPort()>0) {
    46	            Socket socket = null;
    47	            OutputStream stream = null;
    48	            try {
    49	                socket = new Socket(s.getAddress(), s.getPort());
    50	                stream = socket.getOutputStream();
    51	                String shutdown = s.getShutdown();
    52	                for (int i = 0; i < shutdown.length(); i++) {
    53	                    stream.write(shutdown.charAt(i));
    54	                }
    55	                stream.flush();
    56	            } catch (ConnectException ce) {
    57	                log.error(sm.getString("catalina.stopServer.connectException",
    58	                                       s.getAddress(),
    59	                                       String.valueOf(s.getPort())));
    60	                log.error("Catalina.stop: ", ce);
    61	                System.exit(1);
    62	            } catch (IOException e) {
    63	                log.error("Catalina.stop: ", e);
    64	                System.exit(1);
    65	            } finally {
    66	                if (stream != null) {
    67	                    try {
    68	                        stream.close();
    69	                    } catch (IOException e) {
    70	                        // Ignore
    71	                    }
    72	                }
    73	                if (socket != null) {
    74	                    try {
    75	                        socket.close();
    76	                    } catch (IOException e) {
    77	                        // Ignore
    78	                    }
    79	                }
    80	            }
    81	        } else {
    82	            log.error(sm.getString("catalina.stopServer"));
    83	            System.exit(1);
    84	        }
    85	    }

```

ç¬¬ 8 åˆ° 41 è¡Œæ˜¯è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¯å‚ç…§[å‰é¢åˆ†æ Digester çš„æ–‡ç« ](https://link.juejin.im?target=https%3A%2F%2Fjuejin.im%2Fpost%2F5a6d1ff6f265da3e243bc1de)ï¼Œä¸å†èµ˜è¿°ã€‚ä»ç¬¬ 49 è¡Œå¼€å§‹ï¼Œå³å‘`localhost:8005`å‘èµ·ä¸€ä¸ª Socket è¿æ¥ï¼Œå¹¶å†™å…¥`SHUTDOWN`å­—ç¬¦ä¸²ã€‚ è¿™æ ·å°†ä¼šå…³é—­ Tomcat ä¸­çš„é‚£å”¯ä¸€çš„ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹ï¼Œæ¥ç€æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹å°†ä¼šé€€å‡ºï¼ˆç”± JVM ä¿è¯ï¼‰ï¼Œä¹‹åæ•´ä¸ªåº”ç”¨å…³é—­ã€‚

ä»¥ä¸Šåˆ†æ Tomcat çš„é»˜è®¤å…³é—­æœºåˆ¶ï¼Œä½†è¿™æ˜¯é€šè¿‡è¿è¡Œè„šæœ¬æ¥å…³é—­ï¼Œæˆ‘è§‰å¾—è¿™æ ·æ¯”è¾ƒéº»çƒ¦ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½é€šè¿‡ä¸€ç§åœ¨çº¿è®¿é—®çš„æ–¹å¼å…³é—­ Tomcat å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œæ¯”è¾ƒæš´åŠ›çš„ç©æ³•æ˜¯ç›´æ¥æ”¹`org.apache.catalina.core.StandardServer`çš„æºç ç¬¬ 500 è¡Œï¼Œå°†

```Java
boolean match = command.toString().equals(shutdown);

```

æ”¹æˆ

```Java
boolean match = command.toString().equals(â€œGET /SHUTDOWN HTTP/1.1â€);

```

æˆ–è€…ä¿®æ”¹ server.xml æ–‡ä»¶ï¼Œæ‰¾åˆ° Server èŠ‚ç‚¹ï¼Œå°†åŸæ¥çš„

```XML
<Server port="8005" shutdown="SHUTDOWN">

```

æ”¹æˆ

```XML
<Server port="8005" shutdown="GET /SHUTDOWN HTTP/1.1">

```

è¿™æ ·ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥`http://localhost:8005/SHUTDOWN`å°±å¯ä»¥å…³é—­ Tomcat äº†ï¼ŒåŸç†ï¼Ÿçœ‹æ‡‚äº†ä¸Šé¢çš„æ–‡ç« ï¼Œè¿™ä¸ªåº”è¯¥ä¸éš¾ã€‚