title: Tomcat 7 è‡ªåŠ¨åŠ è½½ç±»åŠæ£€æµ‹æ–‡ä»¶å˜åŠ¨åŸç†
date: 2018-01-17
tag: 
categories: Tomcat
permalink: Tomcat/yuliu/Automatic-loading-of-classes-and-detection-of-file-changes
author: é¢„æµ
from_url: https://juejin.im/post/5a7e49f95188257a6c690183
wechat_url: 

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://juejin.im/post/5a7e49f95188257a6c690183 ã€Œé¢„æµã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åœ¨ä¸€èˆ¬çš„ web åº”ç”¨å¼€å‘é‡Œé€šå¸¸ä¼šä½¿ç”¨å¼€å‘å·¥å…·ï¼ˆå¦‚ Eclipseã€IntelJ ï¼‰é›†æˆ tomcat ï¼Œè¿™æ ·å¯ä»¥å°† web å·¥ç¨‹é¡¹ç›®ç›´æ¥å‘å¸ƒåˆ° tomcat ä¸­ï¼Œç„¶åä¸€é”®å¯åŠ¨ã€‚ç»å¸¸é‡åˆ°çš„ä¸€ç§æƒ…å†µæ˜¯ç›´æ¥ä¿®æ”¹ä¸€ä¸ªç±»çš„æºæ–‡ä»¶ï¼Œæ­¤æ—¶å¼€å‘å·¥å…·ä¼šç›´æ¥å°†ç¼–è¯‘åçš„ class æ–‡ä»¶å‘å¸ƒåˆ° tomcat çš„ web å·¥ç¨‹é‡Œï¼Œä½†å¦‚æœ tomcat æ²¡æœ‰é…ç½®åº”ç”¨çš„è‡ªåŠ¨åŠ è½½åŠŸèƒ½çš„è¯ï¼Œå½“å‰ JVM ä¸­è¿è¡Œçš„ class è¿˜æ˜¯æºæ–‡ä»¶ä¿®æ”¹ä¹‹å‰ç¼–è¯‘å¥½çš„ class æ–‡ä»¶ã€‚å¯ä»¥é‡å¯ tomcat æ¥åŠ è½½æ–°çš„ class æ–‡ä»¶ï¼Œä½†è¿™æ ·åšéœ€è¦å†æ‰‹å·¥ç‚¹å‡»ä¸€æ¬¡`restart`ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨åº”ç”¨ä¸­å³æ—¶çœ‹åˆ° java æ–‡ä»¶ä¿®æ”¹ä¹‹åçš„æ‰§è¡Œæƒ…å†µï¼Œå¯ä»¥åœ¨ tomcat ä¸­å°†åº”ç”¨é…ç½®æˆè‡ªåŠ¨åŠ è½½æ¨¡å¼ï¼Œå…¶é…ç½®å¾ˆç®€å•ï¼Œåªè¦åœ¨é…ç½®æ–‡ä»¶çš„`Context`èŠ‚ç‚¹ä¸­åŠ ä¸Šä¸€ä¸ª reloadable å±æ€§ä¸º`true`å³å¯ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```XML
<Context path="/HelloWorld" docBase="C:/apps/apache-tomcat/DeployedApps/HelloWorld" reloadable="true"/>

```

å¦‚æœä½ çš„å¼€å‘å·¥å…·å·²ç»é›†æˆäº† tomcat çš„è¯åº”è¯¥ä¼šæœ‰ä¸€ä¸ªæ“ä½œç•Œé¢é…ç½®æ¥ä»£æ›¿æ‰‹å·¥æ·»åŠ æ–‡ä»¶ä¿¡æ¯ï¼Œå¦‚ Eclipse ä¸­æ˜¯å¦‚ä¸‹ç•Œé¢æ¥é…ç½®çš„ï¼š

![img](https://user-gold-cdn.xitu.io/2018/2/10/1617d5349f778d28?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 æ­¤æ—¶éœ€è¦æŠŠ

```
Auto reloading enabled
```

å‰é¢çš„å¤é€‰æ¡†é’©ä¸Šã€‚å…¶èƒŒåçš„åŸç†å®é™…ä¹Ÿæ˜¯åœ¨ server.xml æ–‡ä»¶ä¸­åŠ ä¸Š Context èŠ‚ç‚¹çš„æè¿°ï¼š



```XML
<Context docBase="test" path="/test" reloadable="true"/>

```

è¿™æ · Tomcat å°±ä¼šç›‘æ§æ‰€é…ç½®çš„ web åº”ç”¨å®é™…è·¯å¾„ä¸‹çš„`/WEB-INF/classes`å’Œ`/WEB-INF/lib`ä¸¤ä¸ªç›®å½•ä¸‹æ–‡ä»¶çš„å˜åŠ¨ï¼Œå¦‚æœå‘ç”Ÿå˜æ›´ tomcat å°†ä¼šè‡ªåŠ¨é‡å¯è¯¥åº”ç”¨ã€‚

ç†Ÿæ‚‰ Tomcat çš„äººåº”è¯¥éƒ½ç”¨è¿‡è¿™ä¸ªåŠŸèƒ½ï¼Œå°±ä¸å†è¯¦è¿°å®ƒçš„é…ç½®æ­¥éª¤äº†ã€‚æˆ‘æ„Ÿå…´è¶£çš„æ˜¯è¿™ä¸ªè‡ªåŠ¨åŠ è½½åŠŸèƒ½åœ¨ Tomcat 7 ä¸­æ˜¯æ€ä¹ˆå®ç°çš„ã€‚

åœ¨[å‰é¢çš„æ–‡ç« ](https://link.juejin.im?target=https%3A%2F%2Fjuejin.im%2Fpost%2F5a7976a95188257a666ef0f1)ä¸­æ›¾ç»è®²è¿‡ Tomcat 7 åœ¨å¯åŠ¨å®Œæˆåä¼šæœ‰ä¸€ä¸ªåå°çº¿ç¨‹`ContainerBackgroundProcessor[StandardEngine[Catalina]]`ï¼Œè¿™ä¸ªçº¿ç¨‹å°†ä¼šå®šæ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰æ‰§è¡Œ Engineã€Hostã€Contextã€Wrapper å„å®¹å™¨ç»„ä»¶åŠä¸å®ƒä»¬ç›¸å…³çš„å…¶å®ƒç»„ä»¶çš„ backgroundProcess æ–¹æ³•ï¼Œè¿™æ®µä»£ç åœ¨æ‰€æœ‰å®¹å™¨ç»„ä»¶çš„çˆ¶ç±»`org.apache.catalina.core.ContainerBase`ç±»çš„ backgroundProcess`æ–¹æ³•ä¸­ï¼š

```Java
public void backgroundProcess() {

    if (!getState().isAvailable())
        return;

    if (cluster != null) {
        try {
            cluster.backgroundProcess();
        } catch (Exception e) {
            log.warn(sm.getString("containerBase.backgroundProcess.cluster", cluster), e);
        }
    }
    if (loader != null) {
        try {
            loader.backgroundProcess();
        } catch (Exception e) {
            log.warn(sm.getString("containerBase.backgroundProcess.loader", loader), e);
        }
    }
    if (manager != null) {
        try {
            manager.backgroundProcess();
        } catch (Exception e) {
            log.warn(sm.getString("containerBase.backgroundProcess.manager", manager), e);
        }
    }
    Realm realm = getRealmInternal();
    if (realm != null) {
        try {
            realm.backgroundProcess();
        } catch (Exception e) {
            log.warn(sm.getString("containerBase.backgroundProcess.realm", realm), e);
        }
    }
    Valve current = pipeline.getFirst();
    while (current != null) {
        try {
            current.backgroundProcess();
        } catch (Exception e) {
            log.warn(sm.getString("containerBase.backgroundProcess.valve", current), e);
        }
        current = current.getNext();
    }
    fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, null);
}

```

ä¸è‡ªåŠ¨åŠ è½½ç±»ç›¸å…³çš„ä»£ç åœ¨ loader çš„ backgroundProcess æ–¹æ³•çš„è°ƒç”¨æ—¶ã€‚æ¯ä¸€ä¸ª StandardContext ä¼šå…³è”ä¸€ä¸ª`loader`å˜é‡ï¼Œè¯¥å˜é‡çš„åˆå§‹åŒ–åœ¨`org.apache.catalina.core.StandardContext`ç±»çš„ startInternal æ–¹æ³•ä¸­çš„è¿™æ®µä»£ç ï¼š

```Java
if (getLoader() == null) {
    WebappLoader webappLoader = new WebappLoader(getParentClassLoader());
    webappLoader.setDelegate(getDelegate());
    setLoader(webappLoader);
}

```

æ‰€ä»¥ä¸Šé¢çš„ loader.backgroundProcess() æ–¹æ³•çš„è°ƒç”¨å°†ä¼šæ‰§è¡Œ`org.apache.catalina.loader.WebappLoader`ç±»çš„ backgroundProcess æ–¹æ³•ï¼š

```Java
public void backgroundProcess() {
    if (reloadable && modified()) {
        try {
            Thread.currentThread().setContextClassLoader
                (WebappLoader.class.getClassLoader());
            if (container instanceof StandardContext) {
                ((StandardContext) container).reload();
            }
        } finally {
            if (container.getLoader() != null) {
                Thread.currentThread().setContextClassLoader
                    (container.getLoader().getClassLoader());
            }
        }
    } else {
        closeJARs(false);
    }
}

```

å…¶ä¸­`reloadable`å˜é‡çš„å€¼å°±æ˜¯æœ¬æ–‡å¼€å§‹æåˆ°çš„é…ç½®æ–‡ä»¶çš„ Context èŠ‚ç‚¹çš„`reloadable`å±æ€§çš„å€¼ï¼Œå½“å®ƒä¸º`true`å¹¶ä¸” modified() æ–¹æ³•è¿”å›ä¹Ÿæ˜¯`true`æ—¶å°±ä¼šæ‰§è¡Œ StandardContext çš„ reload æ–¹æ³•ï¼š

```Java
public synchronized void reload() {

    // Validate our current component state
    if (!getState().isAvailable())
        throw new IllegalStateException
            (sm.getString("standardContext.notStarted", getName()));

    if(log.isInfoEnabled())
        log.info(sm.getString("standardContext.reloadingStarted",
                getName()));

    // Stop accepting requests temporarily.
    setPaused(true);

    try {
        stop();
    } catch (LifecycleException e) {
        log.error(
            sm.getString("standardContext.stoppingContext", getName()), e);
    }

    try {
        start();
    } catch (LifecycleException e) {
        log.error(
            sm.getString("standardContext.startingContext", getName()), e);
    }

    setPaused(false);

    if(log.isInfoEnabled())
        log.info(sm.getString("standardContext.reloadingCompleted",
                getName()));

}

```

reload æ–¹æ³•ä¸­å°†å…ˆæ‰§è¡Œ stop æ–¹æ³•å°†åŸæœ‰çš„è¯¥ web åº”ç”¨åœæ‰ï¼Œå†è°ƒç”¨ start æ–¹æ³•å¯åŠ¨è¯¥ Context ï¼Œstart æ–¹æ³•çš„åˆ†æå‰æ–‡å·²ç»è¯´è¿‡ï¼Œstop æ–¹æ³•å¯ä»¥å‚ç…§ start æ–¹æ³•ä¸€æ ·åˆ†æï¼Œä¸å†èµ˜è¿°ã€‚

è¿™é‡Œé‡ç‚¹è¦è¯´çš„æ˜¯ä¸Šé¢æåˆ°çš„ç›‘æ§æ–‡ä»¶å˜åŠ¨çš„æ–¹æ³• modified ï¼Œåªæœ‰å®ƒè¿”å›`true`æ‰ä¼šå¯¼è‡´åº”ç”¨è‡ªåŠ¨åŠ è½½ã€‚çœ‹ä¸‹è¯¥æ–¹æ³•çš„å®ç°ï¼š

```Java
public boolean modified() {
    return classLoader != null ? classLoader.modified() : false ;
}

```

å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢å®é™…è°ƒç”¨çš„æ˜¯ WebappLoader çš„å®ä¾‹å˜é‡ classLoader çš„ modified æ–¹æ³•æ¥åˆ¤æ–­çš„ï¼Œä¸‹æ–‡å°±è¯¦ç»†åˆ†æè¿™ä¸ª modified æ–¹æ³•çš„å®ç°ã€‚

å…ˆç®€è¦è¯´ä¸€ä¸‹ Tomcat ä¸­çš„åŠ è½½å™¨ã€‚åœ¨ Tomcat 7 ä¸­æ¯ä¸€ä¸ª web åº”ç”¨å¯¹åº”ä¸€ä¸ª Context èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹åœ¨ JVM ä¸­å°±å¯¹åº”ä¸€ä¸ª`org.apache.catalina.core.StandardContext`å¯¹è±¡ï¼Œè€Œæ¯ä¸€ä¸ª StandardContext å¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªåŠ è½½å™¨å®ä¾‹å˜é‡ï¼ˆå³å…¶çˆ¶ç±»`org.apache.catalina.core.ContainerBase`çš„`loader`å®ä¾‹å˜é‡ï¼‰ï¼Œå‰é¢å·²ç»çœ‹åˆ°è¿™ä¸ª loader å˜é‡å®é™…ä¸Šæ˜¯`org.apache.catalina.loader.WebappLoader`å¯¹è±¡ã€‚è€Œæ¯ä¸€ä¸ª WebappLoader å¯¹è±¡å†…éƒ¨å…³è”äº†ä¸€ä¸ª classLoader å˜é‡ï¼ˆå°±è¿™è¿™ä¸ªç±»çš„å®šä¹‰ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è¯¥å˜é‡çš„ç±»å‹æ˜¯`org.apache.catalina.loader.WebappClassLoader`ï¼‰ã€‚

åœ¨ Tomcat 7 çš„æºç ä¸­ç»™å‡ºäº† 6 ä¸ª web åº”ç”¨ï¼š

![img](https://user-gold-cdn.xitu.io/2018/2/10/1617d5b6b02086a6?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 æ‰€ä»¥åœ¨ Tomcat å¯åŠ¨å®Œæˆä¹‹åç†è®ºä¸Šåº”è¯¥æœ‰ 6 ä¸ª StandardContext å¯¹è±¡ï¼Œ6 ä¸ª WebappLoader å¯¹è±¡ï¼Œ6 ä¸ª WebappClassLoader å¯¹è±¡ã€‚ç”¨ jvisualvm è§‚å¯Ÿå®é™…æƒ…å†µä¹Ÿè¯å®äº†ä¸Šé¢çš„åˆ¤æ–­ï¼š



StandardContext å®ä¾‹æ•°ï¼š

![StandardContext å®ä¾‹æ•°](https://user-gold-cdn.xitu.io/2018/2/10/1617d5c1b060968e?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



WebappLoader å®ä¾‹æ•°ï¼š

![WebappLoader å®ä¾‹æ•°](https://user-gold-cdn.xitu.io/2018/2/10/1617d5c7236af2e9?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



WebappClassLoader å®ä¾‹æ•°

![WebappClassLoader å®ä¾‹æ•°](https://user-gold-cdn.xitu.io/2018/2/10/1617d5cebcce1ff4?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



ä¸Šé¢è®²è¿‡äº† WebappLoader çš„åˆå§‹åŒ–ä»£ç ï¼Œæ¥ä¸‹æ¥è®²ä¸€ä¸‹ WebappClassLoader çš„å¯¹è±¡åˆå§‹åŒ–ä»£ç ã€‚åŒæ ·è¿˜æ˜¯åœ¨ StandardContext ç±»çš„ startInternal æ–¹æ³•ä¸­ï¼Œæœ‰å¦‚ä¸‹ä¸¤æ®µä»£ç ï¼š

```Java
if (getLoader() == null) {
    WebappLoader webappLoader = new WebappLoader(getParentClassLoader());
    webappLoader.setDelegate(getDelegate());
    setLoader(webappLoader);
}

```

è¿™ä¸€æ®µæ˜¯ä¸Šé¢å·²ç»è¯´è¿‡çš„ WebappLoader çš„åˆå§‹åŒ–ã€‚

```Java
try {

    if (ok) {

        // Start our subordinate components, if any
        if ((loader != null) && (loader instanceof Lifecycle))
            ((Lifecycle) loader).start();

```

è¿™ä¸€æ®µä¸ WebappLoader çš„å¯¹è±¡ç›¸å…³ï¼Œæ‰§è¡Œçš„å°±æ˜¯ WebappLoader ç±»çš„ start æ–¹æ³•ï¼Œå› ä¸º WebappLoader ç»§æ‰¿è‡ª LifecycleBase ç±»ï¼Œæ‰€ä»¥è°ƒç”¨å®ƒçš„ start æ–¹æ³•æœ€ç»ˆå°†ä¼šæ‰§è¡Œè¯¥ç±»è‡ªå®šä¹‰çš„ startInternal æ–¹æ³•ï¼Œçœ‹ä¸‹ startInternal æ–¹æ³•ä¸­çš„è¿™æ®µä»£ç ï¼š

```Java
classLoader = createClassLoader();
classLoader.setResources(container.getResources());
classLoader.setDelegate(this.delegate);
classLoader.setSearchExternalFirst(searchExternalFirst);
if (container instanceof StandardContext) {
    classLoader.setAntiJARLocking(
            ((StandardContext) container).getAntiJARLocking());
    classLoader.setClearReferencesStatic(
            ((StandardContext) container).getClearReferencesStatic());
    classLoader.setClearReferencesStopThreads(
            ((StandardContext) container).getClearReferencesStopThreads());
    classLoader.setClearReferencesStopTimerThreads(
            ((StandardContext) container).getClearReferencesStopTimerThreads());
    classLoader.setClearReferencesHttpClientKeepAliveThread(
            ((StandardContext) container).getClearReferencesHttpClientKeepAliveThread());
}

for (int i = 0; i < repositories.length; i++) {
    classLoader.addRepository(repositories[i]);
}

// Configure our repositories
setRepositories();
setClassPath();

setPermissions();

((Lifecycle) classLoader).start();

```

ä¸€å¼€å§‹è°ƒç”¨äº† createClassLoader æ–¹æ³•ï¼š

```Java
/**
 * Create associated classLoader.
 */
private WebappClassLoader createClassLoader()
    throws Exception {

    Class clazz = Class.forName(loaderClass);
    WebappClassLoader classLoader = null;

    if (parentClassLoader == null) {
        parentClassLoader = container.getParentClassLoader();
    }
    Class[] argTypes = { ClassLoader.class };
    Object[] args = { parentClassLoader };
    Constructor constr = clazz.getConstructor(argTypes);
    classLoader = (WebappClassLoader) constr.newInstance(args);

    return classLoader;

}

```

å¯ä»¥çœ‹å‡ºè¿™é‡Œé€šè¿‡åå°„å®ä¾‹åŒ–äº†ä¸€ä¸ª WebappClassLoader å¯¹è±¡ã€‚

å›åˆ°æ–‡ä¸­ä¸Šé¢æçš„é—®é¢˜ï¼Œçœ‹ä¸‹ WebappClassLoader çš„ modified æ–¹æ³•ä»£ç ï¼š

```Java
/**
 * Have one or more classes or resources been modified so that a reload
 * is appropriate?
 */
public boolean modified() {

    if (log.isDebugEnabled())
        log.debug("modified()");

    // Checking for modified loaded resources
    int length = paths.length;

    // A rare race condition can occur in the updates of the two arrays
    // It's totally ok if the latest class added is not checked (it will
    // be checked the next time
    int length2 = lastModifiedDates.length;
    if (length > length2)
        length = length2;

    for (int i = 0; i < length; i++) {
        try {
            long lastModified =
                ((ResourceAttributes) resources.getAttributes(paths[i]))
                .getLastModified();
            if (lastModified != lastModifiedDates[i]) {
                if( log.isDebugEnabled() )
                    log.debug("  Resource '" + paths[i]
                              + "' was modified; Date is now: "
                              + new java.util.Date(lastModified) + " Was: "
                              + new java.util.Date(lastModifiedDates[i]));
                return (true);
            }
        } catch (NamingException e) {
            log.error("    Resource '" + paths[i] + "' is missing");
            return (true);
        }
    }

    length = jarNames.length;

    // Check if JARs have been added or removed
    if (getJarPath() != null) {

        try {
            NamingEnumeration enumeration =
                resources.listBindings(getJarPath());
            int i = 0;
            while (enumeration.hasMoreElements() && (i < length)) {
                NameClassPair ncPair = enumeration.nextElement();
                String name = ncPair.getName();
                // Ignore non JARs present in the lib folder
                if (!name.endsWith(".jar"))
                    continue;
                if (!name.equals(jarNames[i])) {
                    // Missing JAR
                    log.info("    Additional JARs have been added : '"
                             + name + "'");
                    return (true);
                }
                i++;
            }
            if (enumeration.hasMoreElements()) {
                while (enumeration.hasMoreElements()) {
                    NameClassPair ncPair = enumeration.nextElement();
                    String name = ncPair.getName();
                    // Additional non-JAR files are allowed
                    if (name.endsWith(".jar")) {
                        // There was more JARs
                        log.info("    Additional JARs have been added");
                        return (true);
                    }
                }
            } else if (i < jarNames.length) {
                // There was less JARs
                log.info("    Additional JARs have been added");
                return (true);
            }
        } catch (NamingException e) {
            if (log.isDebugEnabled())
                log.debug("    Failed tracking modifications of '"
                    + getJarPath() + "'");
        } catch (ClassCastException e) {
            log.error("    Failed tracking modifications of '"
                      + getJarPath() + "' : " + e.getMessage());
        }

    }

    // No classes have been modified
    return (false);

}

```

è¿™æ®µä»£ç ä»æ€»ä½“ä¸Šçœ‹å…±åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ£€æŸ¥ web åº”ç”¨ä¸­çš„ class æ–‡ä»¶æ˜¯å¦æœ‰å˜åŠ¨ï¼Œæ ¹æ® class æ–‡ä»¶çš„æœ€è¿‘ä¿®æ”¹æ—¶é—´æ¥æ¯”è¾ƒï¼Œå¦‚æœæœ‰ä¸åŒåˆ™ç›´æ¥è¿”å›`true`ï¼Œå¦‚æœ class æ–‡ä»¶è¢«åˆ é™¤ä¹Ÿè¿”å›`true`ã€‚ç¬¬äºŒéƒ¨åˆ†æ£€æŸ¥ web åº”ç”¨ä¸­çš„ jar æ–‡ä»¶æ˜¯å¦æœ‰å˜åŠ¨ï¼Œå¦‚æœæœ‰åŒæ ·è¿”å›`true`ã€‚ç¨æœ‰ç¼–ç¨‹ç»éªŒçš„äººå¯¹äºä»¥ä¸Šæ¯”è¾ƒä»£ç éƒ½å®¹æ˜“ç†è§£ï¼Œä½†å¯¹è¿™äº›å˜é‡çš„å€¼ï¼Œç‰¹åˆ«æ˜¯é‡Œé¢æ¯”è¾ƒæ—¶ç»å¸¸ç”¨åˆ° WebappClassLoader ç±»çš„å®ä¾‹å˜é‡çš„å€¼æ˜¯åœ¨ä»€ä¹ˆåœ°æ–¹èµ‹å€¼çš„ä¼šæ¯”è¾ƒå›°æƒ‘ï¼Œè¿™é‡Œå°±è¿™ç‚¹åšä¸€ä¸‹è¯´æ˜ã€‚

ä»¥ class æ–‡ä»¶å˜åŠ¨çš„æ¯”è¾ƒä¸ºä¾‹ï¼Œæ¯”è¾ƒçš„å…³é”®ä»£ç æ˜¯ï¼š

```Java
long lastModified =
                    ((ResourceAttributes) resources.getAttributes(paths[i]))
                    .getLastModified();
                if (lastModified != lastModifiedDates[i]) {

```

å³ä» WebappClassLoader çš„å®ä¾‹å˜é‡`resources`ä¸­å–å‡ºæ–‡ä»¶å½“å‰çš„æœ€è¿‘ä¿®æ”¹æ—¶é—´ï¼Œä¸ WebappClassLoader åŸæ¥ç¼“å­˜çš„è¯¥æ–‡ä»¶çš„æœ€è¿‘ä¿®æ”¹æ—¶é—´åšæ¯”è¾ƒã€‚

å…³äº resources.getAttributes æ–¹æ³•ï¼Œçœ‹ä¸‹ resources çš„å£°æ˜ç±»å‹`javax.naming.directory.DirContext`å¯çŸ¥å®é™…è¿™é‡Œé¢æ‰§è¡Œçš„æ˜¯é€šå¸¸çš„ JNDI æŸ¥è¯¢ä¸€ä¸ªå±æ€§çš„æ–¹æ³•ï¼ˆå¦‚æœå¯¹ JNDI ä¸ç†Ÿæ‚‰è¯·çœ‹ä¸€ä¸‹ JNDI çš„ç›¸å…³æ–‡æ¡£å¤§è‡´äº†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œä¸å†åšå•ç‹¬ä»‹ç»ï¼‰ï¼Œæ‰€ä»¥æœ‰å¿…è¦æŠŠ resources å˜é‡ç©¶ç«Ÿæ˜¯ä½•å¯¹è±¡æ‹å‡ºæ¥è¯´ä¸€ä¸‹ã€‚

åœ¨ä¸Šé¢çœ‹ WebappLoader çš„ startInternal æ–¹æ³•çš„æºç é‡Œ createClassLoader() æ–¹æ³•è°ƒç”¨å¹¶èµ‹å€¼ç»™ classLoader ä¸‹ä¸€è¡Œï¼š

```Java
classLoader.setResources(container.getResources());

```

è¿™é‡Œè®¾ç½®çš„ resources å°±æ˜¯ä¸Šé¢ç”¨åˆ°çš„ resources å˜é‡ï¼Œå¯ä»¥çœ‹åˆ°å®ƒå®é™…æ˜¯ WebappLoader æ‰€å…³è”å®¹å™¨çš„å®ä¾‹å˜é‡ resources ã€‚æŒ‰å‰é¢çš„æè¿°æ‰€å…³è”çš„å®¹å™¨å³ StandardContext ï¼Œå†æ¥çœ‹çœ‹ StandardContext ä¸­ resources æ˜¯æ€ä¹ˆèµ‹å€¼çš„ã€‚

è¿˜æ˜¯åœ¨ StandardContext çš„ startInternal æ–¹æ³•ä¸­ï¼Œå¼€å¤´éƒ¨åˆ†æœ‰è¿™æ®µä»£ç ï¼š

```Java
// Add missing components as necessary
if (webappResources == null) {   // (1) Required by Loader
    if (log.isDebugEnabled())
        log.debug("Configuring default Resources");
    try {
        if ((getDocBase() != null) && (getDocBase().endsWith(".war")) &&
                (!(new File(getBasePath())).isDirectory()))
            setResources(new WARDirContext());
        else
            setResources(new FileDirContext());
    } catch (IllegalArgumentException e) {
        log.error("Error initializing resources: " + e.getMessage());
        ok = false;
    }
}
if (ok) {
    if (!resourcesStart()) {
        log.error( "Error in resourceStart()");
        ok = false;
    }
}

```

å› ä¸ºé»˜è®¤çš„åº”ç”¨æ˜¯ä¸æ˜¯ war åŒ…å‘å¸ƒï¼Œè€Œæ˜¯ä»¥ç›®å½•å½¢å¼å‘å¸ƒçš„æ‰€ä»¥ä¼šæ‰§è¡Œ`setResources(new FileDirContext())`æ–¹æ³•ã€‚è¿™é‡Œç¨å¾®æ›²æŠ˜çš„åœ°æ–¹æ˜¯ setResources é‡Œå®é™…åªæ˜¯ç»™ StandardContext çš„ webappResources å˜é‡èµ‹å€¼ï¼Œè€Œ StandardContext çš„ resources å˜é‡èµ‹ä¸º`null`ï¼Œåœ¨ä¸Šé¢æºç ä¸­çš„æœ€å resourcesStart æ–¹æ³•çš„è°ƒç”¨ä¸­æ‰ä¼šç»™ resources èµ‹å€¼ã€‚çœ‹ä¸‹ resourcesStart æ–¹æ³•ï¼š

```Java
public boolean resourcesStart() {

    boolean ok = true;

    Hashtable env = new Hashtable();
    if (getParent() != null)
        env.put(ProxyDirContext.HOST, getParent().getName());
    env.put(ProxyDirContext.CONTEXT, getName());

    try {
        ProxyDirContext proxyDirContext =
            new ProxyDirContext(env, webappResources);
        if (webappResources instanceof FileDirContext) {
            filesystemBased = true;
            ((FileDirContext) webappResources).setAllowLinking
                (isAllowLinking());
        }
        if (webappResources instanceof BaseDirContext) {
            ((BaseDirContext) webappResources).setDocBase(getBasePath());
            ((BaseDirContext) webappResources).setCached
                (isCachingAllowed());
            ((BaseDirContext) webappResources).setCacheTTL(getCacheTTL());
            ((BaseDirContext) webappResources).setCacheMaxSize
                (getCacheMaxSize());
            ((BaseDirContext) webappResources).allocate();
            // Alias support
            ((BaseDirContext) webappResources).setAliases(getAliases());

            if (effectiveMajorVersion >=3 && addWebinfClassesResources) {
                try {
                    DirContext webInfCtx =
                        (DirContext) webappResources.lookup(
                                "/WEB-INF/classes");
                    // Do the lookup to make sure it exists
                    webInfCtx.lookup("META-INF/resources");
                    ((BaseDirContext) webappResources).addAltDirContext(
                            webInfCtx);
                } catch (NamingException e) {
                    // Doesn't exist - ignore and carry on
                }
            }
        }
        // Register the cache in JMX
        if (isCachingAllowed()) {
            String contextName = getName();
            if (!contextName.startsWith("/")) {
                contextName = "/" + contextName;
            }
            ObjectName resourcesName =
                new ObjectName(this.getDomain() + ":type=Cache,host="
                               + getHostname() + ",context=" + contextName);
            Registry.getRegistry(null, null).registerComponent
                (proxyDirContext.getCache(), resourcesName, null);
        }
        this.resources = proxyDirContext;
    } catch (Throwable t) {
        ExceptionUtils.handleThrowable(t);
        log.error(sm.getString("standardContext.resourcesStart"), t);
        ok = false;
    }

    return (ok);

}

```

å¯ä»¥çœ‹å‡º resources èµ‹çš„æ˜¯ proxyDirContext å¯¹è±¡ï¼Œè€Œ proxyDirContext æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä»£ç†çš„å°±æ˜¯ webappResources ï¼ŒæŒ‰ä¸Šé¢çš„æè¿°å³`org.apache.naming.resources.FileDirContext`ã€‚

`org.apache.naming.resources.FileDirContext`ç»§æ‰¿è‡ªæŠ½è±¡çˆ¶ç±»`org.apache.naming.resources.BaseDirContext`ï¼Œè€Œ BaseDirContext åˆå®ç°äº†`javax.naming.directory.DirContext`æ¥å£ã€‚æ‰€ä»¥ JNDI æ“ä½œä¸­çš„ lookupã€bindã€getAttributesã€rebindã€search ç­‰æ–¹æ³•éƒ½å·²ç»åœ¨è¿™ä¸¤ä¸ªç±»ä¸­å®ç°äº†ã€‚å½“ç„¶é‡Œé¢è¿˜æœ‰ JNDI è§„èŒƒä¹‹å¤–çš„æ–¹æ³•å¦‚ list ç­‰ã€‚

è¿™é‡Œå°±çœ‹ä¸‹å‰é¢çœ‹åˆ°çš„ getAttributes æ–¹æ³•çš„è°ƒç”¨ï¼Œåœ¨ BaseDirContext ç±»ä¸­æ‰€æœ‰çš„ getAttributes æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨æŠ½è±¡æ–¹æ³• doGetAttributes æ¥è¿”å›æŸ¥è¯¢å±æ€§çš„ç»“æœï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ FileDirContext çš„å®šä¹‰å¦‚ä¸‹ï¼š

```Java
protected Attributes doGetAttributes(String name, String[] attrIds)
    throws NamingException {

    // Building attribute list
    File file = file(name);

    if (file == null)
        return null;

    return new FileResourceAttributes(file);

}

```

å¯ä»¥çœ‹åˆ°å†…éƒ¨æ‰§è¡Œäº† file æ–¹æ³•ï¼š

```Java
/**
 * Return a File object representing the specified normalized
 * context-relative path if it exists and is readable.  Otherwise,
 * return null.
 *
 * @param name Normalized context-relative path (with leading '/')
 */
protected File file(String name) {

    File file = new File(base, name);
    if (file.exists() && file.canRead()) {

        if (allowLinking)
            return file;

        // Check that this file belongs to our root path
        String canPath = null;
        try {
            canPath = file.getCanonicalPath();
        } catch (IOException e) {
            // Ignore
        }
        if (canPath == null)
            return null;

        // Check to see if going outside of the web application root
        if (!canPath.startsWith(absoluteBase)) {
            return null;
        }

        // Case sensitivity check - this is now always done
        String fileAbsPath = file.getAbsolutePath();
        if (fileAbsPath.endsWith("."))
            fileAbsPath = fileAbsPath + "/";
        String absPath = normalize(fileAbsPath);
        canPath = normalize(canPath);
        if ((absoluteBase.length() < absPath.length())
            && (absoluteBase.length() < canPath.length())) {
            absPath = absPath.substring(absoluteBase.length() + 1);
            if (absPath == null)
                return null;
            if (absPath.equals(""))
                absPath = "/";
            canPath = canPath.substring(absoluteBase.length() + 1);
            if (canPath.equals(""))
                canPath = "/";
            if (!canPath.equals(absPath))
                return null;
        }

    } else {
        return null;
    }
    return file;

}

```

äº†è§£ java çš„æ–‡ä»¶æ“ä½œçš„äººè¿™æ®µä»£ç å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œå®é™…å°±æ˜¯æ ¹æ®ä¼ å…¥çš„æ–‡ä»¶åæŸ¥æ‰¾ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›åŒ…è£…äº†çš„æ–‡ä»¶å±æ€§å¯¹è±¡ FileResourceAttributes ã€‚ FileResourceAttributes ç±»å®é™…æ˜¯å¯¹`java.io.File`ç±»åšäº†ä¸€å±‚åŒ…è£…ï¼Œå¦‚ getLastModified æ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯ File ç±»çš„ lastModified æ–¹æ³•è¿”å›ï¼š

```Java
long lastModified =
                    ((ResourceAttributes) resources.getAttributes(paths[i]))
                    .getLastModified();
                if (lastModified != lastModifiedDates[i]) {

```

ä»¥ä¸Šåˆ†æäº†ä¸Šé¢è¿™æ®µä»£ç ä¸­`((ResourceAttributes) resources.getAttributes(paths[i])).getLastModified()`è¿™éƒ¨åˆ†ï¼Œä½†ä¸¤ä¸ªå†…ç½®å˜é‡`paths`å’Œ`lastModifiedDates`å€¼ç©¶ç«Ÿä»€ä¹ˆæ—¶å€™èµ‹çš„å‘¢ï¼Ÿ

è¿™ä¸ªç®€è¦è¯´ä¸€ä¸‹ WebappClassLoader è¿™ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„ç”¨æ³•ï¼Œåœ¨ Tomcat ä¸­æ‰€æœ‰ web åº”ç”¨å†…`WEB-INF\classes`ç›®å½•ä¸‹çš„ class æ–‡ä»¶éƒ½æ˜¯ç”¨è¿™ä¸ªç±»åŠ è½½å™¨æ¥åŠ è½½çš„ï¼Œä¸€èˆ¬çš„è‡ªå®šä¹‰åŠ è½½å™¨éƒ½æ˜¯è¦†å†™ ClassLoader çš„ findClass æ–¹æ³•ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ã€‚WebappClassLoader è¦†ç›–çš„æ˜¯ URLClassLoader ç±»çš„ findClass æ–¹æ³•ï¼Œè€Œåœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨æœ€ç»ˆä¼šè°ƒç”¨`findResourceInternal(String name, String path)`æ–¹æ³•ï¼š

![img](https://user-gold-cdn.xitu.io/2018/2/10/1617d6e950ff2d30?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 è¯¥æ–¹æ³•ä»£ç æ®µè¾ƒé•¿ï¼Œä¸ºä¸åç¦»ä¸»é¢˜ï¼Œæ‘˜å‡ºæœ¬æ–‡æè¿°ç›¸å…³çš„ä»£ç æ®µï¼š



```Java
// Register the full path for modification checking
// Note: Only syncing on a 'constant' object is needed
synchronized (allPermission) {

    int j;

    long[] result2 =
        new long[lastModifiedDates.length + 1];
    for (j = 0; j < lastModifiedDates.length; j++) {
        result2[j] = lastModifiedDates[j];
    }
    result2[lastModifiedDates.length] = entry.lastModified;
    lastModifiedDates = result2;

    String[] result = new String[paths.length + 1];
    for (j = 0; j < paths.length; j++) {
        result[j] = paths[j];
    }
    result[paths.length] = fullPath;
    paths = result;

}

```

è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åŠ è½½ä¸€ä¸ªæ–°çš„ class æ–‡ä»¶æ—¶ä¼šç»™ WebappClassLoader çš„å®ä¾‹å˜é‡`lastModifiedDates`å’Œ`paths`æ•°ç»„æ·»åŠ å…ƒç´ ã€‚è¿™é‡Œå°±è§£ç­”äº†ä¸Šé¢æåˆ°çš„æ–‡ä»¶å˜æ›´æ¯”è¾ƒä»£ç çš„ç–‘é—®ã€‚è¦è¯´æ˜çš„æ˜¯åœ¨ tomcat å¯åŠ¨å web åº”ç”¨ä¸­æ‰€æœ‰çš„ class æ–‡ä»¶å¹¶ä¸æ˜¯å…¨éƒ¨åŠ è½½çš„ï¼Œè€Œæ˜¯é…ç½®åœ¨ web.xml ä¸­æè¿°çš„éœ€è¦ä¸åº”ç”¨ä¸€èµ·åŠ è½½çš„æ‰ä¼šç«‹å³åŠ è½½ï¼Œå¦åˆ™åªæœ‰åˆ°è¯¥ç±»é¦–æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šç”±ç±»åŠ è½½å™¨åŠ è½½ã€‚

å…³äº Tomcat çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¯é¢˜ï¼Œå¯è¯´çš„åœ°æ–¹å¾ˆå¤šï¼Œåé¢ä¼šä¸“æ–‡å¦è¿°ã€‚è€Œå…³äº jar åŒ…æ–‡ä»¶å˜åŠ¨çš„æ¯”è¾ƒä»£ç åŒ class æ–‡ä»¶æ¯”è¾ƒçš„ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯å–å‡ºå½“å‰ web åº”ç”¨`WEB-INF\lib`ç›®å½•ä¸‹çš„æ‰€æœ‰ jar æ–‡ä»¶ï¼Œä¸ WebappClassLoader å†…éƒ¨ç¼“å­˜çš„`jarNames`æ•°ç»„åšæ¯”è¾ƒï¼Œå¦‚æœæ–‡ä»¶åä¸åŒæˆ–æ–°åŠ æˆ–åˆ é™¤äº† jar æ–‡ä»¶éƒ½è¿”å›`true`ã€‚

ä½†è¿™é‡Œ jarNames å˜é‡çš„åˆå§‹èµ‹å€¼ä»£ç åœ¨ WebappClassLoader ç±»çš„ addJar æ–¹æ³•ä¸­çš„å¼€å¤´éƒ¨åˆ†ï¼š

```Java
if ((jarPath != null) && (jar.startsWith(jarPath))) {

    String jarName = jar.substring(jarPath.length());
    while (jarName.startsWith("/"))
        jarName = jarName.substring(1);

    String[] result = new String[jarNames.length + 1];
    for (i = 0; i < jarNames.length; i++) {
        result[i] = jarNames[i];
    }
    result[jarNames.length] = jarName;
    jarNames = result;

}

```

è€Œ addJar æ–¹æ³•æ˜¯åœ¨ WebappLoader ç±»çš„ startInternal æ–¹æ³•ä¸­ï¼Œä¸Šé¢å·²ç»ç»™å‡ºä¸è¿™ä¸ªç›¸å…³çš„ä»£ç ï¼Œé‡Œé¢çš„è¿™æ®µä»£ç éƒ¨åˆ†ï¼š

```Java
// Configure our repositories
setRepositories();
setClassPath();

```

åœ¨ setRepositories çš„æ–¹æ³•æœ€åéƒ¨åˆ†ï¼š

```Java
try {
    JarFile jarFile = new JarFile(destFile);
    classLoader.addJar(filename, jarFile, destFile);
} catch (Exception ex) {
    // Catch the exception if there is an empty jar file
    // Should ignore and continue loading other jar files
    // in the dir
}

loaderRepositories.add( filename );

```

å³åœ¨ tomcat å¯åŠ¨æ—¶çš„åŠ è½½webåº”ç”¨çš„è¿‡ç¨‹é‡Œå°±ä¼šåŠ è½½è¯¥åº”ç”¨çš„ lib ç›®å½•ä¸‹çš„æ‰€æœ‰ jar æ–‡ä»¶ï¼ŒåŒæ—¶ç»™ WebappClassLoader çš„å®ä¾‹å˜é‡ jarNames æ·»åŠ æ•°ç»„å…ƒç´ ã€‚

addJar æ–¹æ³•çš„è°ƒç”¨è·¯å¾„ï¼š

![addJar æ–¹æ³•çš„è°ƒç”¨è·¯å¾„](https://user-gold-cdn.xitu.io/2018/2/10/1617d721b5b8a8f4?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



åœ¨çœ‹ jar åŒ…åŠ è½½çš„ä»£ç æ—¶ä¼šä¸æ–­ç¢°åˆ° resources å¯¹è±¡ listã€getAttributes ç­‰æ–¹æ³•çš„è°ƒç”¨ï¼Œè®°ä½è¿™é‡Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ä¸Šé¢æåˆ°çš„ FileDirContext çš„ç›¸å…³æ–¹æ³•ï¼Œä¹Ÿå³å¯¹äºæ–‡ä»¶çš„æŸ¥è¯¢è®¿é—®æ–¹æ³•å°±æ¸…æ¥šäº†ã€‚