title: Nacos æºç åˆ†æ â€”â€” å¦‚ä½•å®ç°æ³¨å†Œå‘ç°
date: 2019-02-05
tag:
categories: Nacos
permalink: Nacos/huangyunbin/How-to-achieve-registration-discovery
author: é»„äº‘æ–Œ
from_url: https://www.jianshu.com/p/e1e3ecedc8b3
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/e1e3ecedc8b3 ã€Œé»„äº‘æ–Œã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [æ³¨å†Œä¸€ä¸ªæœåŠ¡](http://www.iocoder.cn/Nacos/huangyunbin/How-to-achieve-registration-discovery/)
  - [å¢åŠ å®ä¾‹ipçš„æ¥å£](http://www.iocoder.cn/Nacos/huangyunbin/How-to-achieve-registration-discovery/)
- [è·å–ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰ip](http://www.iocoder.cn/Nacos/huangyunbin/How-to-achieve-registration-discovery/)
  - [é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æ³¨å†Œipçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªæ˜¯æ”¹äº†raftçš„å¯¹åº”çš„keyçš„å€¼ï¼Œclusterçš„æ•°æ®æ€ä¹ˆä¿æŒä¸€è‡´çš„å‘¢ï¼Ÿ](http://www.iocoder.cn/Nacos/huangyunbin/How-to-achieve-registration-discovery/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# æ³¨å†Œä¸€ä¸ªæœåŠ¡



![img](https://upload-images.jianshu.io/upload_images/7835103-92553bb9610eb123.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)





![img](https://upload-images.jianshu.io/upload_images/7835103-7e5be049a0ccc601.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



### å¦‚æœè¿™ä¸ªæœåŠ¡ä¹‹å‰æ²¡æœ‰ï¼Œç¬¬ä¸€æ¬¡æ³¨å†Œï¼Œæ„å»ºè¿™ä¸ªæœåŠ¡ä¿¡æ¯



![img](https://upload-images.jianshu.io/upload_images/7835103-8e427698ca3fb4ac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



### å¦‚æœæœåŠ¡æœ‰äº†ï¼Œå°±å¢åŠ è¿™ä¸ªæœåŠ¡çš„å®ä¾‹ip



![img](https://upload-images.jianshu.io/upload_images/7835103-de1b6fe46bc733d1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



### è¿™ä¸ªæ­¥éª¤å°±æ˜¯å’Œå¢åŠ å®ä¾‹ipçš„æ¥å£æ˜¯ä¸€æ ·çš„é€»è¾‘äº†

------

## å¢åŠ å®ä¾‹ipçš„æ¥å£



![img](https://upload-images.jianshu.io/upload_images/7835103-31325be7852d8497.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)





![img](https://upload-images.jianshu.io/upload_images/7835103-0d3ab4205d92cee4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)





![img](https://upload-images.jianshu.io/upload_images/7835103-1d4fddac9472d2ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



### è¿™ä¸ªçœŸçš„æ˜¯æœ‰ç‚¹ç»•å•Šï¼Œç»ˆäºæ¥åˆ°çœŸæ­£å¤„ç†çš„onAddIP4Domäº†

#### è¿™é‡Œçš„é‡ç‚¹å°±newIPsäº†ï¼Œå°±æ˜¯æ›´æ–°åçš„ipåˆ—è¡¨



![img](https://upload-images.jianshu.io/upload_images/7835103-e8c984cd2dfa8b4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)





![img](https://upload-images.jianshu.io/upload_images/7835103-78d8c304fa436ef5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



### ipAddressMap.values() å…¶å®å°±æ˜¯æ—§çš„ipåŠ ä¸ŠnewIPs



![img](https://upload-images.jianshu.io/upload_images/7835103-4393594d18b69d93.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



public static final String IPADDRESS_DATA_ID_PRE = "com.alibaba.nacos.naming.iplist.";

### è¿™ä¸ªå°±æ˜¯å­˜ipåˆ—è¡¨çš„keyäº†ï¼Œåé¢å°±æ˜¯æˆ‘ä¹‹å‰è¯´è¿‡çš„raftçš„ä¸œè¥¿äº†ã€‚

æˆ‘ä»¬å†å›å¤´çœ‹çœ‹newIPsæ˜¯æ€ä¹ˆæ¥çš„



![img](https://upload-images.jianshu.io/upload_images/7835103-071b3fff0cce5820.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



### å…¶å®æ˜¯æœ€å¼€å§‹è¯·æ±‚å‚æ•°ä¸­çš„ipListæ¥çš„ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥å›æƒ³èµ·æ³¨å†ŒæœåŠ¡çš„æ—¶å€™å°±å‡ºç°è¿‡çš„



![img](https://upload-images.jianshu.io/upload_images/7835103-7d886046b0673e20.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



------

# è·å–ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰ip



![img](https://upload-images.jianshu.io/upload_images/7835103-7f3c22489036c6c4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



```Java
    srvedIPs = domObj.srvIPs(clientIP, Arrays.asList(StringUtils.split(clusters, ",")));
```

### å¦‚æœæ²¡ä¼ clusterså‚æ•°ï¼Œå°±æ‰¾åˆ°æ‰€æœ‰çš„cluster



![img](https://upload-images.jianshu.io/upload_images/7835103-430b0547a34fb601.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



### ä»æ¯ä¸ªclusteræ‹¿å‡ºipåˆ—è¡¨ï¼Œç»„åˆå°±å¾—åˆ°æ‰€æœ‰çš„ipåˆ—è¡¨äº†



![img](https://upload-images.jianshu.io/upload_images/7835103-d160788004032c8f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



## é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æ³¨å†Œipçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªæ˜¯æ”¹äº†raftçš„å¯¹åº”çš„keyçš„å€¼ï¼Œclusterçš„æ•°æ®æ€ä¹ˆä¿æŒä¸€è‡´çš„å‘¢ï¼Ÿ

#### VirtualClusterDomain åœ¨æ„é€ æ–¹æ³•ä¸­æ³¨å†Œäº†ä¸€ä¸ªRaftListener



![img](https://upload-images.jianshu.io/upload_images/7835103-82bd1b2bbd3c3e54.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/694/format/webp)





![img](https://upload-images.jianshu.io/upload_images/7835103-52a7158417636a43.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



```Java
public static final String IPADDRESS_DATA_ID_PRE = "com.alibaba.nacos.naming.iplist.";
```

### å…³æ³¨çš„è¿™ä¸ªkeyå°±æ˜¯ipåˆ—è¡¨çš„keyäº†ã€‚

### raftå­˜çš„ipåˆ—è¡¨å˜åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘ï¼š



![img](https://upload-images.jianshu.io/upload_images/7835103-da3fac47677209f6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)
