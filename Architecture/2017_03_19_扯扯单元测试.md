title: è°ˆè°ˆå•å…ƒæµ‹è¯•
date: 2017-03-19
tags:
categories: 
permalink: Architecture/talk-about-java-unit-test

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Architecture/talk-about-java-unit-test/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
- [2. é€‰å‹](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
  - [2.1 JUnit](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
  - [2.2 Mockito](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
  - [2.3 PowerMock](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
- [3. å®è·µ](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
  - [3.1 Service å±‚](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
  - [3.2 Controller å±‚](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
  - [3.3 Dao å±‚](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)
- [4. å»ºè®®](http://www.iocoder.cn/Architecture/talk-about-java-unit-test/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

**æœ¬æ–‡ä¸»è¦é¢å‘Javaå·¥ç¨‹å¸ˆï¼Œè§è°…**

# 1. ä¸ºä»€ä¹ˆåšå•å…ƒæµ‹è¯•

* æå‡é‡å¤æµ‹è¯•æ•ˆç‡
* æå‡ä»£ç è´¨é‡
* æå‡éƒ¨ç½²å¯é æ€§

# 2. é€‰å‹

## 2.1 JUnit

> å•å…ƒæµ‹è¯•å¥—ä»¶

ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ TestNG ï¼Ÿåœ¨æ•´åˆ TestNG + Mockito + PowerMock + Spring æ—¶ï¼ŒSpring å®¹å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œ `@Autowired` çš„å±æ€§æ— æ³•æ³¨å…¥ï¼ŒæŸ¥æ‰¾èµ„æ–™ï¼ŒåŸºæœ¬æ— è§£ï¼Œåªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œé€‰æ‹© JUnit ã€‚ä»åŠŸèƒ½å¼ºå¤§ç¨‹åº¦ï¼Œæ˜“ç”¨æ€§ä¸Šï¼Œä¸ªäººè¾ƒä¸ºæ¨è TestNG ã€‚

## 2.2 Mockito

> Mock å·¥å…·

ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ JMock ã€EasyMock ï¼Ÿå› ä¸º API ä¸Šæ›´åŠ è½»é‡çº§ï¼Œç”¨èµ·æ¥çˆ½çˆ½çš„ã€‚

## 2.3 PowerMock

> ä½œä¸º Mockito çš„è¡¥å……ï¼Œå¢åŠ å¯¹ `private`ã€`static`ã€`final` çš„æ”¯æŒã€‚

ä¸ºä»€ä¹ˆ Mockito ä¸è‡ªå·±æ”¯æŒï¼Ÿ[Mockito-And-Private-Methods](https://github.com/mockito/mockito/wiki/Mockito-And-Private-Methods) ä½œè€…æœ‰è‡ªå·±çš„è€ƒè™‘ï¼Œä¸è¿‡å¯¹äºä½¿ç”¨è€…ï¼Œå¢åŠ äº†å¾ˆå¤šæ•´åˆçš„ç—›è‹¦ã€‚

# 3. å®è·µ

## 3.1 Service å±‚

> æ–¹æ¡ˆä¸€ï¼š

* ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ
* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ

> æ–¹æ¡ˆäºŒï¼š

* ä¾èµ–çš„ Dao å±‚ä»£ç ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“ï¼Œä¾‹å¦‚è¯´ h2database 
* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ

**ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚ä»å¯é æ€§è§’åº¦è€ƒè™‘ï¼Œç›¸å¯¹çœŸå®çš„æ¨¡æ‹Ÿäº† Dao å±‚ï¼Œä¾‹å¦‚æ•°æ®æ’å…¥åï¼Œå¯ä»¥è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ¤æ–­Serviceæ˜¯å¦æ­£ç¡®è®¾ç½®å€¼ï¼Œæ˜¯å¦æœ‰å±æ€§æ¼è®¾ç½®ä¼šè®¾ç½®é”™ï¼›å½“ç„¶ï¼Œè¯¥æ–¹æ¡ˆåœ¨ç»´æŠ¤ä¸Šä¼šç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œå„æœ‰åˆ©å¼Šã€‚**

## 3.2 Controller å±‚

> æ–¹æ¡ˆä¸€ï¼š

* ä¾èµ–çš„ Service å±‚ä»£ç ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿ

> æ–¹æ¡ˆäºŒï¼š

* ä¾èµ–çš„ Service å±‚ã€**è¯»**ã€‘ç±»é€»è¾‘ï¼Œæ‰§è¡ŒçœŸå®é€»è¾‘ã€‚è¯»å–ä¾èµ–çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚
* ä¾èµ–çš„ Service å±‚ã€**å†™**ã€‘ç±»é€»è¾‘ï¼Œä½¿ç”¨ mock è¿›è¡Œæ¨¡æ‹Ÿã€‚å’Œ Controller ç±»çš„é€»è¾‘æˆ–è€…è¿”å›æœ‰å…³ç³»çš„æ•°æ®ï¼Œä½¿ç”¨å†…åµŒæ•°æ®åº“æ’å…¥ã€‚

**ä¸ªäººè¾ƒä¸ºæ¨èæ–¹æ¡ˆäºŒã€‚åŸå› åŒ Service å±‚å•å…ƒæµ‹è¯•ã€‚**

å¦å¤–ï¼Œå¤§éƒ¨åˆ†äº’è”ç½‘å…¬å¸ MVC æ¡†æ¶é€‰ç”¨çš„æ˜¯ SpringMVC ï¼Œå¯ä»¥ä½¿ç”¨ SpringMVC Test æ¡†æ¶ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```
MockMvcBuilders.standaloneSetup(XXXController).build()
```

## 3.3 Dao å±‚

ä½¿ç”¨å†…åµŒçš„æ•°æ®å®ç°è¿›è¡Œæµ‹è¯•ã€‚

* MySQL ï¼š[h2database](https://github.com/h2database/h2database) 
* MongoDB ï¼š[fongo](https://github.com/fakemongo/fongo)
* Redis ï¼š[embedded-redis](https://github.com/kstyrc/embedded-redis)

# 4. å»ºè®®

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

1. åŠ  QQï¼š**7685413**ï¼Œè¿›è¡Œäº’ç›¸äº¤æµã€‚ğŸ˜œã€‚
2. å½“ä½¿ç”¨ TestNG + Mockito + PowerMock ï¼Œæµ‹è¯•ç±»ä½¿ç”¨ IObjectFactory è€Œä¸è¦å»ç»§æ‰¿ PowerMockTestCase ã€‚Java æ— æ³•å¤šç»§æ‰¿ï¼Œå¦‚æœæ­¤æ—¶ä½ æœ‰å¿…é¡»ç»§æ‰¿çš„ç±»å°±ååˆ†æ£˜æ‰‹ã€‚

```
@ObjectFactory  
public IObjectFactory getObjectFactory() {  
	return new PowerMockObjectFactory();  
}   
```	

3. å½“ä½¿ç”¨ PowerMockTestCase æ¯ä¸ªæµ‹è¯•å•å…ƒæ‰§è¡Œå®Œåï¼Œä¼šæ¸…ç†æ‰å¯¹æ–¹æ³•çš„ mockã€‚å› æ­¤ï¼Œå¦‚æœæœ‰å…¬ç”¨çš„ mock æ–¹æ³•ï¼Œéœ€è¦ä½¿ç”¨ä¸‹ @BeforeMethodï¼ˆTestNGï¼‰ã€@Beforeï¼ˆJUnitï¼‰é‡Œåœ¨è¿›è¡Œä¸€æ¬¡mockã€‚
4. å½“ä½¿ç”¨ Mockito + PowerMock ï¼Œå¯¹æµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæœ‰éœ€è¦å¯¹æµ‹è¯•ç±»çš„ä¸€äº›ç§æœ‰æ–¹æ³•ã€æˆ–è€…é™æ€æ–¹æ³•è¿›è¡Œ mock æ—¶ï¼Œä¸è¦ä½¿ç”¨ @Spyï¼Œè€Œè¦ä½¿ç”¨PowerMokito.spy()è¿›è¡Œ mock ã€‚å¾ˆé…¸çˆ½ã€‚

