title: è°ˆè°ˆ ID
date: 2017-03-04
tags:
categories: æŠ€æœ¯æ‚æ–‡
permalink: Architecture/talk-about-global-id

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

- [1. æ•°æ®åº“è‡ªå¢](#)
- [2. ç±»UUIDç®—æ³•](#)
- [3. SnowFlake](#)
	- [3.1 Twitter-Snowflake](#)
	- [3.2 Instagram SnowFlake](#)
	- [3.3 Simpleflake](#)
	- [3.4 Boundary flake](#)
	- [3.5 è‡ªå·±çš„æƒ³æ³•](#)
- [4. å‚è€ƒæ–‡ç« ](#)
- [è‰ç¨¿](#)


åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ•°æ®åº“çš„idæ˜¯ä¸å¯å°‘çš„ã€‚åœ¨å„ä¸ªåœºæ™¯ä¸‹ä¼šæœ‰ä¸åŒçš„é€‰æ‹©ï¼Œæœ¬æ–‡å¯¹äº’è”ç½‘ä¸Šå¸¸è§çš„IDç®—æ³•è¿›è¡Œå½’çº³ï¼Œå¸Œæœ›å¯¹å·¥ç¨‹å¸ˆä»¬æœ‰ä¸€ç‚¹ç‚¹å¸®åŠ©ã€‚

# 1. æ•°æ®åº“è‡ªå¢
1. MySQLã€Oracleã€PGSQLç­‰å…³ç³»æ•°æ®åº“çš„idä¸»é”®è‡ªå¢
2. Redisã€Memcachedç­‰K/Væ•°æ®åº“çš„incræ“ä½œè‡ªå¢
    * éœ€è¦è€ƒè™‘æŒä¹…åŒ–çš„é—®é¢˜
3. MongoDBè‡ªå·±ç»´æŠ¤ä¸€ä¸ªidè‡ªå¢é›†åˆ
    * MongoDBçš„Updateæ“ä½œæ”¯æŒincræ“ä½œï¼Œå› æ­¤å¯ä»¥è¿™ä¹ˆåšã€‚
    * è¯¥æ–¹å¼é€‚ç”¨äºæ”¯æŒè¯¥æ“ä½œçš„å…¶ä»–æ•°æ®åº“ã€‚

# 2. ç±»UUIDç®—æ³•
1. UUID
2. MongoDBçš„ObjectId

# 3. SnowFlake

## 3.1 Twitter-Snowflake
 
>  Twitter-Snowflakeç®—æ³•äº§ç”Ÿçš„èƒŒæ™¯ç›¸å½“ç®€å•ï¼Œä¸ºäº†æ»¡è¶³Twitteræ¯ç§’ä¸Šä¸‡æ¡æ¶ˆæ¯çš„è¯·æ±‚ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½å¿…é¡»åˆ†é…ä¸€æ¡å”¯ä¸€çš„idï¼Œè¿™äº›idè¿˜éœ€è¦ä¸€äº›å¤§è‡´çš„é¡ºåºï¼ˆæ–¹ä¾¿å®¢æˆ·ç«¯æ’åºï¼‰ï¼Œå¹¶ä¸”åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸åŒæœºå™¨äº§ç”Ÿçš„idå¿…é¡»ä¸åŒã€‚

64bitsä»å·¦å¾€å³ä¾æ¬¡æ˜¯

* 1bit ä¿ç•™
* 41bits æ—¶é—´æˆ³
    * æ”¯æŒ69.7å¹´éœ€è¦çš„idã€‚2 ^41 /365/24/60/60/1000=69.7
* 10bits work-id
    * æ”¯æŒ1024ä¸ªwork
* 12bits sequence-id
    * æ”¯æŒæ¯workæ¯æ¯«ç§’4096ä¸ªid
    * æ”¯æŒæ¯workæ¯ç§’4096000ä¸ªid
    * è‹¥å½“å‰æ¯«ç§’è¶…è¿‡4096ï¼Œåˆ™sleep1æ¯«ç§’ï¼Œè·å–ä¸‹ä¸€æ¯«ç§’çš„è‡ªå¢
 
** snowflakeçš„æ„ä¹‰ï¼Œä¸ä»…ä»…åœ¨äºæä¾›äº†è§£å†³æ–¹å¼ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç§åŸºäºLongé•¿åº¦å®ç°å…·æœ‰æ—¶é—´ç›¸å…³æ€§çš„idè‡ªå¢åºåˆ—ã€‚å› æ­¤ï¼Œå¾ˆå¤šå…¬å¸åŸºäºå®ƒè¿›è¡ŒäºŒæ¬¡æ”¹é€ é€‚åº”è‡ªå·±çš„åœºæ™¯ **

## 3.2 Instagram SnowFlake

å»ä¸­æ€§åŒ–ï¼ŒåŸºäºPGSQLå®ç°

64bitsä»å·¦è‡³å³ä¾æ¬¡æ˜¯

* 41bits æ—¶é—´æˆ³
* 13bits logic-shard-id
* 10bits sequence-id

å®ç°æ–¹å¼

* æ ¹æ®`share-key`è·å–å¯¹åº”çš„PGSQLå®ä¾‹-åº“
* idä½¿ç”¨PGSQLçš„å­˜å‚¨è¿‡ç¨‹
* 13bits = `share-keyå¯¹åº”å€¼%logic-share-id` 
* 10bits = `è¯¥Tableçš„auto_increment_id%(2 ^10)`

å¥½å¤„

* å»ä¸­æ€§åŒ–
* æ ¹æ®idå¯ä»¥è·å¾—å¯¹åº”PGSQLå®ä¾‹-åº“

## 3.3 Simpleflake

64bits

 * å»ä¸­æ€§åŒ–
 * å°†work-idçš„12bitsç»™sequence-idã€‚å®Œå…¨éšæœºï¼Œæ¯æ¯«ç§’æœ‰1/(2^22 )å‡ºç°å†²çªçš„æƒ…å†µã€‚æ•°æ®é‡å¤§æ—¶éœ€è¦æ³¨æ„ã€‚
 * æœªæ¥å¯ä»¥å¹³æ»‘è¿ç§»åˆ°Twitter SnowFlake

## 3.4 Boundary flake

å»ä¸­æ€§åŒ–ï¼ŒåŸºäºerlangå®ç°
128bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯

* 64bits æ—¶é—´æˆ³
    * å’Œæ¯«ç§’æ—¶é—´æˆ³ç­‰é•¿
* 48bits work-id
    * å’Œmacåœ°å€ç­‰é•¿ï¼Œä½¿ç”¨æ—¶è¦é¿å…ç›¸åŒmacå¤šä¸ªè¿›ç¨‹
* 14bits sequence-id

## 3.5 è‡ªå·±çš„æƒ³æ³•

***å‚è€ƒInstagram SnowFlakeçš„åšæ³•***

å»ä¸­å¿ƒåŒ–ï¼ŒåŸºäºrediså®ç°
64bitsä»å·¦åˆ°å³ä¾æ¬¡æ˜¯

* 1bit ä¿ç•™
* 41bits æ—¶é—´æˆ³
* 12bits åŸºäºlogic-shard-id
* 10bits åŸºäºæ—¶é—´æˆ³+logic-shard-idåœ¨redisé‡Œè‡ªå¢

# 4. å‚è€ƒæ–‡ç« 

1. [äº’è”ç½‘åˆ†å¸ƒå¼idç”Ÿæˆæ–¹æ³•|msupå¾®è¯¾å¹²è´§](http://mp.weixin.qq.com/s?__biz=MzAwNjE3ODQ4NQ==&mid=2650896366&idx=1&sn=5d5acdf323df2b6d581249b32031ccd7&scene=1&srcid=0618GuDjWjenr7TacVTFj6VU#rd)
2. [æœåŠ¡åŒ–æ¡†æ¶ï¼åˆ†å¸ƒå¼Unique IDçš„ç”Ÿæˆæ–¹æ³•ä¸€è§ˆ](http://calvin1978.blogcn.com/articles/uuid.html?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io)
3. [åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ Unique ID çš„ç”Ÿæˆæ–¹æ³•](https://www.google.co.jp/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&oq=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD+Unique+ID+%E7%9A%84%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95&aqs=chrome..69i57.291j0j1&sourceid=chrome&ie=UTF-8)


# è‰ç¨¿

1. 2å®ä¾‹ã€4åˆ†è¡¨
* aï¼š0*2*4*6
* bï¼š1*3*5*7

2. 4å®ä¾‹ã€4åˆ†è¡¨
* aï¼š0*4*8*12
* bï¼š1*5*9*13
* cï¼š2*6*10*14
* dï¼š3*7*11*15

æ‰©å±•æ–¹å¼ï¼š
* aä¸cåŒä¸»ã€ˆa cã€‰
* bä¸dåŒä¸»ã€ˆb dã€‰