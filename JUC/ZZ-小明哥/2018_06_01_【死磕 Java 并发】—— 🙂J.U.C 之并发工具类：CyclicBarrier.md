title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”- J.U.C ä¹‹å¹¶å‘å·¥å…·ç±»ï¼šCyclicBarrier
date: 2018-06-01
tag: 
categories: JUC
permalink: JUC/sike/CyclicBarrier
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2241
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484184&idx=1&sn=d221688af03cbab0bf7e719fa253a266&chksm=fa497ca9cd3ef5bf394189cc2432499b93eaaf92314ee5c4dd451b6ccf3aa20ab527d56bea8e#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2241 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

ä½œä¸ºã€Œå°æ˜å“¥ã€çš„å¿ å®è¯»è€…ï¼Œã€Œè€è‰¿è‰¿ã€ç•¥ä½œä¿®æ”¹ï¼Œè®°å½•åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒçš„èµ„æ–™ã€‚

- [1. ç®€ä»‹](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
- [2. å®ç°åˆ†æ](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.1 await](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.2 await](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.3 dowait](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.4 Generation](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.5 breakBarrier](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.6 nextGeneration](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.7 reset](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.8 getNumberWaiting](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
  - [2.9 isBroken](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
- [3. åº”ç”¨åœºæ™¯](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
- [4. åº”ç”¨ç¤ºä¾‹](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
- [å‚è€ƒèµ„æ–™](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/CyclicBarrier/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> æ­¤ç¯‡åšå®¢æ‰€æœ‰æºç å‡æ¥è‡ªJDK 1.8

# 1. ç®€ä»‹

CyclicBarrier ï¼Œä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ï¼Œåœ¨ AP Iä¸­æ˜¯è¿™ä¹ˆä»‹ç»çš„ï¼š

å®ƒå…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æŸä¸ª**å…¬å…±å±éšœç‚¹** (Common Barrier Point)ã€‚åœ¨æ¶‰åŠä¸€ç»„å›ºå®šå¤§å°çš„çº¿ç¨‹çš„ç¨‹åºä¸­ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»ä¸æ—¶åœ°äº’ç›¸ç­‰å¾…ï¼Œæ­¤æ—¶ CyclicBarrier å¾ˆæœ‰ç”¨ã€‚å› ä¸ºè¯¥ Barrier åœ¨é‡Šæ”¾ç­‰å¾…çº¿ç¨‹åå¯ä»¥é‡ç”¨ï¼Œæ‰€ä»¥ç§°å®ƒä¸º**å¾ªç¯( Cyclic ) çš„ å±éšœ( Barrier )** ã€‚

é€šä¿—ç‚¹è®²å°±æ˜¯ï¼šè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœæ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚

# 2. å®ç°åˆ†æ

`java.util.concurrent.CyclicBarrier` çš„ç»“æ„å¦‚ä¸‹ï¼š

![CyclicBarrier ç»“æ„å›¾](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120817001.png)

é€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° CyclicBarrier çš„å†…éƒ¨æ˜¯ä½¿ç”¨é‡å…¥é” ReentrantLock å’Œ Condition ã€‚

å®ƒæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š

* `CyclicBarrier(int parties)`ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ CyclicBarrierï¼Œå®ƒå°†åœ¨ç»™å®šæ•°é‡çš„å‚ä¸è€…ï¼ˆçº¿ç¨‹ï¼‰å¤„äºç­‰å¾…çŠ¶æ€æ—¶å¯åŠ¨ï¼Œä½†å®ƒä¸ä¼šåœ¨å¯åŠ¨ barrier æ—¶æ‰§è¡Œé¢„å®šä¹‰çš„æ“ä½œã€‚
* `CyclicBarrier(int parties, Runnable barrierAction)` ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ CyclicBarrierï¼Œå®ƒå°†åœ¨ç»™å®šæ•°é‡çš„å‚ä¸è€…ï¼ˆçº¿ç¨‹ï¼‰å¤„äºç­‰å¾…çŠ¶æ€æ—¶å¯åŠ¨ï¼Œå¹¶åœ¨å¯åŠ¨ barrier æ—¶æ‰§è¡Œç»™å®šçš„å±éšœæ“ä½œï¼Œè¯¥æ“ä½œç”±æœ€åä¸€ä¸ªè¿›å…¥ barrier çš„çº¿ç¨‹æ‰§è¡Œã€‚
* ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    public CyclicBarrier(int parties, Runnable barrierAction) {
        if (parties <= 0) throw new IllegalArgumentException();
        this.parties = parties;
        this.count = parties;
        this.barrierCommand = barrierAction;
    }
    
    public CyclicBarrier(int parties) {
        this(parties, null);
    }
    ```
    * `parties` å˜é‡ï¼Œè¡¨ç¤ºæ‹¦æˆªçº¿ç¨‹çš„**æ€»**æ•°é‡ã€‚   
    * `count` å˜é‡ï¼Œè¡¨ç¤ºæ‹¦æˆªçº¿ç¨‹çš„**å‰©ä½™éœ€è¦**æ•°é‡ã€‚ 
    * `barrierAction` å˜é‡ï¼Œä¸º CyclicBarrier æ¥æ”¶çš„ Runnable å‘½ä»¤ï¼Œç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œä¼˜å…ˆæ‰§è¡Œ `barrierAction` ï¼Œç”¨äºå¤„ç†æ›´åŠ å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ã€‚
    * `generation` å˜é‡ï¼Œè¡¨ç¤º CyclicBarrier çš„æ›´æ–°æ¢ä»£ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.4 Generationã€](#) ã€‚

## 2.1 await

åœ¨ CyclicBarrier ä¸­æœ€é‡è¦çš„æ–¹æ³•è«è¿‡äº `#await()` æ–¹æ³•ï¼Œåœ¨æ‰€æœ‰å‚ä¸è€…éƒ½å·²ç»åœ¨æ­¤ barrier ä¸Šè°ƒç”¨ await æ–¹æ³•ä¹‹å‰ï¼Œå°†ä¸€ç›´ç­‰å¾…ã€‚ä»£ç å¦‚ä¸‹ï¼š

> æˆ–è€…è¯´ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨ `#await()` æ–¹æ³•ï¼Œå‘Šè¯‰ CyclicBarrier æˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚å½“æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾äº†å±éšœï¼Œç»“æŸé˜»å¡ï¼Œæ‰€æœ‰çº¿ç¨‹å¯ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ã€‚

```Java
public int await() throws InterruptedException, BrokenBarrierException {
    try {
        return dowait(false, 0L);//ä¸è¶…æ—¶ç­‰å¾…
    } catch (TimeoutException toe) {
        throw new Error(toe); // cannot happen
    }
}
```

* å†…éƒ¨è°ƒç”¨ `#dowait(boolean timed, long nanos)` æ–¹æ³•ï¼Œæ‰§è¡Œé˜»å¡ç­‰å¾…( `timed=true` )ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.3 dowaitã€](#) ã€‚
* ç†è®ºæ¥è¯´ï¼Œä¸ä¼šå‡ºç° TimeoutException å¼‚å¸¸ï¼Œæ‰€ä»¥åœ¨å‘ç”Ÿæ—¶ï¼Œç›´æ¥æŠ›å‡º Error é”™è¯¯ã€‚
* è¿”å›å€¼ä¸ºè¿›å…¥å±éšœæ—¶ï¼Œå‰©ä½™æ‹¦æˆªçº¿ç¨‹çš„**å‰©ä½™éœ€è¦**æ•°é‡ã€‚è‹±æ–‡æ³¨é‡Šå¦‚ä¸‹ï¼š

    > the arrival index of the current thread, where index {@code getParties() - 1} indicates the first to arrive and zero indicates the last to arrive

## 2.2 await

`#await(long timeout, TimeUnit unit)` æ–¹æ³•ï¼Œåœ¨ `#await()` çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ç­‰å¾…è¶…æ—¶çš„ç‰¹æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public int await(long timeout, TimeUnit unit)
    throws InterruptedException,
           BrokenBarrierException,
           TimeoutException {
    return dowait(true, unit.toNanos(timeout));
}
```

* å†…éƒ¨è°ƒç”¨ `#dowait(boolean timed, long nanos)` æ–¹æ³•ï¼Œæ‰§è¡Œé˜»å¡ç­‰å¾…( `timed=true` )ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.3 dowaitã€](#) ã€‚

## 2.3 dowait

`#dowait(boolean timed, long nanos)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
private int dowait(boolean timed, long nanos)
        throws InterruptedException, BrokenBarrierException,
        TimeoutException {
    //è·å–é”
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        //åˆ†ä»£
        final Generation g = generation;

        //å½“å‰generationâ€œå·²æŸåâ€ï¼ŒæŠ›å‡ºBrokenBarrierExceptionå¼‚å¸¸
        //æŠ›å‡ºè¯¥å¼‚å¸¸ä¸€èˆ¬éƒ½æ˜¯æŸä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æŸä¸ªå¤„äºâ€œæ–­å¼€â€çŠ¶æ€çš„CyclicBarrie
        if (g.broken)
            //å½“æŸä¸ªçº¿ç¨‹è¯•å›¾ç­‰å¾…å¤„äºæ–­å¼€çŠ¶æ€çš„ barrier æ—¶ï¼Œæˆ–è€… barrier è¿›å…¥æ–­å¼€çŠ¶æ€è€Œçº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€æ—¶ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸
            throw new BrokenBarrierException();

        //å¦‚æœçº¿ç¨‹ä¸­æ–­ï¼Œç»ˆæ­¢CyclicBarrier
        if (Thread.interrupted()) {
            breakBarrier();
            throw new InterruptedException();
        }

        //è¿›æ¥ä¸€ä¸ªçº¿ç¨‹ count - 1
        int index = --count;
        //count == 0 è¡¨ç¤ºæ‰€æœ‰çº¿ç¨‹å‡å·²åˆ°ä½ï¼Œè§¦å‘Runnableä»»åŠ¡
        if (index == 0) {  // tripped
            boolean ranAction = false;
            try {
                final Runnable command = barrierCommand;
                //è§¦å‘ä»»åŠ¡
                if (command != null)
                    command.run();
                ranAction = true;
                //å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå¹¶æ›´æ–°generation
                nextGeneration();
                return 0;
            } finally {
                if (!ranAction) // æœªæ‰§è¡Œï¼Œè¯´æ˜ barrierCommand æ‰§è¡ŒæŠ¥é”™ï¼Œæˆ–è€…çº¿ç¨‹æ‰“æ–­ç­‰ç­‰æƒ…å†µã€‚
                    breakBarrier();
            }
        }

        for (;;) {
            try {
                //å¦‚æœä¸æ˜¯è¶…æ—¶ç­‰å¾…ï¼Œåˆ™è°ƒç”¨Condition.await()æ–¹æ³•ç­‰å¾…
                if (!timed)
                    trip.await();
                else if (nanos > 0L)
                    //è¶…æ—¶ç­‰å¾…ï¼Œè°ƒç”¨Condition.awaitNanos()æ–¹æ³•ç­‰å¾…
                    nanos = trip.awaitNanos(nanos);
            } catch (InterruptedException ie) {
                if (g == generation && ! g.broken) {
                    breakBarrier();
                    throw ie;
                } else {
                    // We're about to finish waiting even if we had not
                    // been interrupted, so this interrupt is deemed to
                    // "belong" to subsequent execution.
                    Thread.currentThread().interrupt();
                }
            }

            if (g.broken)
                throw new BrokenBarrierException();

            //generationå·²ç»æ›´æ–°ï¼Œè¿”å›index
            if (g != generation)
                return index;

            //â€œè¶…æ—¶ç­‰å¾…â€ï¼Œå¹¶ä¸”æ—¶é—´å·²åˆ°,ç»ˆæ­¢CyclicBarrierï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸
            if (timed && nanos <= 0L) {
                breakBarrier();
                throw new TimeoutException();
            }
        }
    } finally {
        //é‡Šæ”¾é”
        lock.unlock();
    }
}
```

å¦‚æœè¯¥çº¿ç¨‹ä¸æ˜¯åˆ°è¾¾çš„æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ™ä»–ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œé™¤éå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š

1. æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾ï¼Œå³ `index == 0` ã€‚
2. è¶…å‡ºäº†æŒ‡å®šæ—¶é—´ï¼ˆè¶…æ—¶ç­‰å¾…ï¼‰ã€‚
3. å…¶ä»–çš„æŸä¸ªçº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚
4. å…¶ä»–çš„æŸä¸ªçº¿ç¨‹ä¸­æ–­å¦ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚
5. å…¶ä»–çš„æŸä¸ªçº¿ç¨‹åœ¨ç­‰å¾… barrier è¶…æ—¶ã€‚
6. å…¶ä»–çš„æŸä¸ªçº¿ç¨‹åœ¨æ­¤ barrier è°ƒç”¨ `#reset()` æ–¹æ³•ã€‚`#reset()` æ–¹æ³•ï¼Œç”¨äºå°†å±éšœé‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚

åœ¨ `#dowait(boolean timed, long nanos)`  æ–¹æ³•çš„æºä»£ç ä¸­ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥çœ‹åˆ°æŠ›å‡º **BrokenBarrierException** å¼‚å¸¸ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™æŠ›å‡ºå¼‚å¸¸å‘¢ï¼Ÿä¾‹å¦‚ï¼š

* å¦‚æœä¸€ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€æ—¶ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è°ƒç”¨ `#reset()` æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.7 resetã€](#) ã€‚
* è°ƒç”¨çš„ barrier åŸæœ¬å°±æ˜¯è¢«æŸåçš„ï¼Œåˆ™æŠ›å‡º BrokenBarrierException å¼‚å¸¸ã€‚
* ä»»ä½•çº¿ç¨‹åœ¨ç­‰å¾…æ—¶è¢«ä¸­æ–­äº†ï¼Œåˆ™å…¶ä»–æ‰€æœ‰çº¿ç¨‹éƒ½å°†æŠ›å‡º BrokenBarrierException å¼‚å¸¸ï¼Œå¹¶å°† barrier ç½®äº**æŸå**çŠ¶æ€ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.6 breakBarrierã€](#) ã€‚

## 2.4 Generation

Generation æ˜¯ CyclicBarrier å†…éƒ¨é™æ€ç±»ï¼Œæè¿°äº† CyclicBarrier çš„æ›´æ–°æ¢ä»£ã€‚**åœ¨CyclicBarrierä¸­ï¼ŒåŒä¸€æ‰¹çº¿ç¨‹å±äºåŒä¸€ä»£**ã€‚å½“æœ‰ `parties` ä¸ªçº¿ç¨‹å…¨éƒ¨åˆ°è¾¾ barrier æ—¶ï¼Œ`generation` å°±ä¼šè¢«æ›´æ–°æ¢ä»£ã€‚å…¶ä¸­ `broken` å±æ€§ï¼Œæ ‡è¯†è¯¥å½“å‰ CyclicBarrier æ˜¯å¦å·²ç»å¤„äºä¸­æ–­çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
private static class Generation {
    boolean broken = false;
}
```

* é»˜è®¤ barrier æ˜¯æ²¡æœ‰æŸåçš„ã€‚

## 2.5 breakBarrier

å½“ barrier æŸåäº†ï¼Œæˆ–è€…æœ‰ä¸€ä¸ªçº¿ç¨‹ä¸­æ–­äº†ï¼Œåˆ™é€šè¿‡ `#breakBarrier()` æ–¹æ³•ï¼Œæ¥ç»ˆæ­¢æ‰€æœ‰çš„çº¿ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
private void breakBarrier() {
    generation.broken = true;
    count = parties;
    trip.signalAll();
}
```

* åœ¨ `breakBarrier()` æ–¹æ³•ä¸­ï¼Œä¸­é™¤äº†å°† `broken`è®¾ç½®ä¸º true ï¼Œè¿˜ä¼šè°ƒç”¨ `#signalAll()` æ–¹æ³•ï¼Œå°†åœ¨ CyclicBarrier å¤„äº**ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹**å…¨éƒ¨å”¤é†’ã€‚

## 2.6 nextGeneration

å½“æ‰€æœ‰çº¿ç¨‹éƒ½å·²ç»åˆ°è¾¾ barrier å¤„ï¼ˆ`index == 0`ï¼‰ï¼Œåˆ™ä¼šé€šè¿‡ `nextGeneration()` æ–¹æ³•ï¼Œè¿›è¡Œæ›´æ–°æ¢ä»£æ“ä½œã€‚åœ¨è¿™ä¸ªæ­¥éª¤ä¸­ï¼Œåšäº†ä¸‰ä»¶äº‹ï¼š

1. å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚
2. é‡ç½® `count`  ã€‚
3. é‡ç½® `generation` ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```Java
private void nextGeneration() {
    trip.signalAll();
    count = parties;
    generation = new Generation();
}
```

## 2.7 reset

`#reset()` æ–¹æ³•ï¼Œé‡ç½® barrier åˆ°åˆå§‹åŒ–çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public void reset() {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        breakBarrier();   // break the current generation
        nextGeneration(); // start a new generation
    } finally {
        lock.unlock();
    }
}
```

* é€šè¿‡ç»„åˆ `#breakBarrier()` å’Œ `#nextGeneration()` æ–¹æ³•æ¥å®ç°ã€‚

## 2.8 getNumberWaiting

`#getNumberWaiting()` æ–¹æ³•ï¼Œè·å¾—ç­‰å¾…çš„çº¿ç¨‹æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public int getNumberWaiting() {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        return parties - count;
    } finally {
        lock.unlock();
    }
}
```

## 2.9 isBroken

`#isBroken()` æ–¹æ³•ï¼Œåˆ¤æ–­ CyclicBarrier æ˜¯å¦å¤„äºä¸­æ–­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public boolean isBroken() {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        return generation.broken;
    } finally {
        lock.unlock();
    }
}
```

# 3. åº”ç”¨åœºæ™¯

CyclicBarrier é€‚ç”¨äºå¤šçº¿ç¨‹ç»“æœåˆå¹¶çš„æ“ä½œï¼Œç”¨äºå¤šçº¿ç¨‹è®¡ç®—æ•°æ®ï¼Œæœ€ååˆå¹¶è®¡ç®—ç»“æœçš„åº”ç”¨åœºæ™¯ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿè®¡å¤šä¸ª Excel ä¸­çš„æ•°æ®ï¼Œç„¶åç­‰åˆ°ä¸€ä¸ªæ€»ç»“æœã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹å¤„ç†æ¯ä¸€ä¸ª Excel ï¼Œæ‰§è¡Œå®Œæˆåå¾—åˆ°ç›¸åº”çš„ç»“æœï¼Œæœ€åé€šè¿‡ `barrierAction` æ¥è®¡ç®—è¿™äº›çº¿ç¨‹çš„è®¡ç®—ç»“æœï¼Œå¾—åˆ°æ‰€æœ‰Excelçš„æ€»å’Œã€‚

# 4. åº”ç”¨ç¤ºä¾‹

æ¯”å¦‚æˆ‘ä»¬å¼€ä¼šåªæœ‰ç­‰æ‰€æœ‰çš„äººåˆ°é½äº†æ‰ä¼šå¼€ä¼šï¼Œå¦‚ä¸‹ï¼š

```Java
public class CyclicBarrierTest {

    private static CyclicBarrier cyclicBarrier;

    static class CyclicBarrierThread extends Thread{
        public void run() {
            System.out.println(Thread.currentThread().getName() + "åˆ°äº†");
            //ç­‰å¾…
            try {
                cyclicBarrier.await();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public static void main(String[] args){
        cyclicBarrier = new CyclicBarrier(5, new Runnable() {
            @Override
            public void run() {
                System.out.println("äººåˆ°é½äº†ï¼Œå¼€ä¼šå§....");
            }
        });

        for(int i = 0 ; i < 5 ; i++){
            new CyclicBarrierThread().start();
        }
    }
    
}
```

è¿è¡Œç»“æœï¼š

[![201702110001_2](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120817002.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120817002.png)

# å‚è€ƒèµ„æ–™

1. æ–¹è…¾é£ï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ [ã€Œ8.2 åŒæ­¥å±éšœ CyclicBarrierã€](#) ç« èŠ‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

