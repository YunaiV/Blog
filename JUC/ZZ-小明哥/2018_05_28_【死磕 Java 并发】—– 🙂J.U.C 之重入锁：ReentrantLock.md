title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹é‡å…¥é”ï¼šReentrantLock
date: 2018-05-28
tag: 
categories: JUC
permalink: JUC/sike/ReentrantLock
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2210
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484011&idx=1&sn=bc1e9a4af9175b6df202fa8b1ffd5589&chksm=fa497ddacd3ef4cca17b8c0f16adf8139b8b3a55c03c17b1da30b0260ce008f40dde769b33c6#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2210 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

ä½œä¸ºã€Œå°æ˜å“¥ã€çš„å¿ å®è¯»è€…ï¼Œã€Œè€è‰¿è‰¿ã€ç•¥ä½œä¿®æ”¹ï¼Œè®°å½•åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒçš„èµ„æ–™ã€‚

- [1. ç®€ä»‹](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
- [2. Sync æŠ½è±¡ç±»](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [2.1 lock](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [2.2 nonfairTryAcquire](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [2.3 tryRelease](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [2.4 å…¶ä»–å®ç°æ–¹æ³•](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
- [3. Sync å®ç°ç±»](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [3.1 NonfairSync](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [3.2 FairSync](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
- [3. Lock æ¥å£](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
- [4. ReentrantLock](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.1 æ„é€ æ–¹æ³•](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.2 lock](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.3 lockInterruptibly](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.4 tryLock](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.5 tryLock](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.6 unlock](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.7 newCondition](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
  - [4.8 å…¶ä»–å®ç°æ–¹æ³•](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
- [5. ReentrantLock ä¸ synchronized çš„åŒºåˆ«](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
- [å‚è€ƒèµ„æ–™](http://www.iocoder.cn/JUC/sike/ReentrantLock/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/ReentrantLock/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> æ­¤ç¯‡åšå®¢æ‰€æœ‰æºç å‡æ¥è‡ªJDK 1.8

# 1. ç®€ä»‹

ReentrantLockï¼Œå¯é‡å…¥é”ï¼Œæ˜¯ä¸€ç§é€’å½’æ— é˜»å¡çš„åŒæ­¥æœºåˆ¶ã€‚å®ƒå¯ä»¥ç­‰åŒäº `synchronized` çš„ä½¿ç”¨ï¼Œä½†æ˜¯ ReentrantLock æä¾›äº†æ¯” `synchronized` æ›´å¼ºå¤§ã€çµæ´»çš„é”æœºåˆ¶ï¼Œå¯ä»¥å‡å°‘æ­»é”å‘ç”Ÿçš„æ¦‚ç‡ã€‚

API ä»‹ç»å¦‚ä¸‹ï¼š

> ä¸€ä¸ªå¯é‡å…¥çš„äº’æ–¥é”å®š Lockï¼Œå®ƒå…·æœ‰ä¸ä½¿ç”¨ `synchronized` æ–¹æ³•å’Œè¯­å¥æ‰€è®¿é—®çš„éšå¼ç›‘è§†å™¨é”å®šç›¸åŒçš„ä¸€äº›åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ã€‚
> 
> ReentrantLock å°†ç”±æœ€è¿‘æˆåŠŸè·å¾—é”å®šï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰é‡Šæ”¾è¯¥é”å®šçš„çº¿ç¨‹æ‰€æ‹¥æœ‰ã€‚å½“é”å®šæ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰€æ‹¥æœ‰æ—¶ï¼Œè°ƒç”¨ lock çš„çº¿ç¨‹å°†æˆåŠŸè·å–è¯¥é”å®šå¹¶è¿”å›ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰è¯¥é”å®šï¼Œæ­¤æ–¹æ³•å°†ç«‹å³è¿”å›ã€‚å¯ä»¥ä½¿ç”¨ `#isHeldByCurrentThread()` å’Œ `#getHoldCount()` æ–¹æ³•æ¥æ£€æŸ¥æ­¤æƒ…å†µæ˜¯å¦å‘ç”Ÿã€‚

ReentrantLock è¿˜æä¾›äº†**å…¬å¹³é”**å’Œ**éå…¬å¹³é”**çš„é€‰æ‹©ï¼Œé€šè¿‡æ„é€ æ–¹æ³•æ¥å—ä¸€ä¸ªå¯é€‰çš„ `fair` å‚æ•°ï¼ˆé»˜è®¤éå…¬å¹³é”ï¼‰ï¼šå½“è®¾ç½®ä¸º true æ—¶ï¼Œè¡¨ç¤ºå…¬å¹³é”ï¼›å¦åˆ™ä¸ºéå…¬å¹³é”ã€‚

å…¬å¹³é”ä¸éå…¬å¹³é”çš„åŒºåˆ«åœ¨äºï¼Œå…¬å¹³é”çš„é”è·å–æ˜¯æœ‰é¡ºåºçš„ã€‚ä½†æ˜¯å…¬å¹³é”çš„æ•ˆç‡å¾€å¾€æ²¡æœ‰éå…¬å¹³é”çš„æ•ˆç‡é«˜ï¼Œåœ¨è®¸å¤šçº¿ç¨‹è®¿é—®çš„æƒ…å†µä¸‹ï¼Œå…¬å¹³é”è¡¨ç°å‡ºè¾ƒä½çš„ååé‡ã€‚

ReentrantLock æ•´ä½“ç»“æ„å¦‚ä¸‹å›¾ï¼š

![201702010001](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120813001.png)

* ReentrantLock å®ç° Lock  æ¥å£ï¼ŒåŸºäºå†…éƒ¨çš„ Sync å®ç°ã€‚
* Sync å®ç° AQS ï¼Œæä¾›äº† FairSync å’Œ NonFairSync ä¸¤ç§å®ç°ã€‚

# 2. Sync æŠ½è±¡ç±»

Sync æ˜¯ ReentrantLock çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° AbstractQueuedSynchronizer æŠ½è±¡ç±»ï¼ŒåŒæ­¥å™¨æŠ½è±¡ç±»ã€‚å®ƒä½¿ç”¨ AQS çš„ `state` å­—æ®µï¼Œæ¥è¡¨ç¤ºå½“å‰é”çš„æŒæœ‰æ•°é‡ï¼Œä»è€Œå®ç°**å¯é‡å…¥**çš„ç‰¹æ€§ã€‚

## 2.1 lock

```Java
/**
 * Performs {@link Lock#lock}. The main reason for subclassing
 * is to allow fast path for nonfair version.
 */
abstract void lock();
```

* æ‰§è¡Œé”ã€‚æŠ½è±¡äº†è¯¥æ–¹æ³•çš„åŸå› æ˜¯ï¼Œå…è®¸å­ç±»å®ç°å¿«é€Ÿè·å¾—**éå…¬å¹³é”**çš„é€»è¾‘ã€‚

## 2.2 nonfairTryAcquire

`#nonfairTryAcquire(int acquires)` æ–¹æ³•ï¼Œ**éå…¬å¹³é”**çš„æ–¹å¼è·å¾—é”ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
final boolean nonfairTryAcquire(int acquires) {
    //å½“å‰çº¿ç¨‹
    final Thread current = Thread.currentThread();
    //è·å–åŒæ­¥çŠ¶æ€
    int c = getState();
    //state == 0,è¡¨ç¤ºæ²¡æœ‰è¯¥é”å¤„äºç©ºé—²çŠ¶æ€
    if (c == 0) {
        //è·å–é”æˆåŠŸï¼Œè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹æ‰€æœ‰
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    //çº¿ç¨‹é‡å…¥
    //åˆ¤æ–­é”æŒæœ‰çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

* è¯¥æ–¹æ³•ä¸»è¦é€»è¾‘ï¼šé¦–å…ˆåˆ¤æ–­åŒæ­¥çŠ¶æ€ `state == 0` ?
    * å¦‚æœ**æ˜¯**ï¼Œè¡¨ç¤ºè¯¥é”è¿˜æ²¡æœ‰è¢«çº¿ç¨‹æŒæœ‰ï¼Œç›´æ¥é€šè¿‡CASè·å–åŒæ­¥çŠ¶æ€ã€‚
        * å¦‚æœæˆåŠŸï¼Œè¿”å› true ã€‚
        * å¦åˆ™ï¼Œè¿”å› false ã€‚
    * å¦‚æœ**ä¸æ˜¯**ï¼Œåˆ™åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸º**è·å–é”çš„çº¿ç¨‹**ï¼Ÿ
        * å¦‚æœæ˜¯ï¼Œåˆ™è·å–é”ï¼ŒæˆåŠŸè¿”å› true ã€‚æˆåŠŸè·å–é”çš„çº¿ç¨‹ï¼Œå†æ¬¡è·å–é”ï¼Œè¿™æ˜¯å¢åŠ äº†åŒæ­¥çŠ¶æ€ `state` ã€‚é€šè¿‡è¿™é‡Œçš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢æåˆ°çš„ â€œå®ƒä½¿ç”¨ AQS çš„ `state` å­—æ®µï¼Œæ¥è¡¨ç¤ºå½“å‰é”çš„æŒæœ‰æ•°é‡ï¼Œä»è€Œå®ç°å¯é‡å…¥çš„ç‰¹æ€§â€ã€‚
        * å¦åˆ™ï¼Œè¿”å› false ã€‚
* ç†è®ºæ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥åœ¨å­ç±» **FairSync** ä¸­å®ç°ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¼šåœ¨è¿™é‡Œå‘¢ï¼Ÿåœ¨ä¸‹æ–‡çš„ `ReentrantLock.tryLock()` ä¸­ï¼Œè¯¦ç»†è§£æã€‚

## 2.3 tryRelease

`#tryRelease(int releases)` **å®ç°**æ–¹æ³•ï¼Œé‡Šæ”¾é”ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
protected final boolean tryRelease(int releases) {
    // å‡æ‰releases
    int c = getState() - releases;
    // å¦‚æœé‡Šæ”¾çš„ä¸æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ï¼ŒæŠ›å‡ºå¼‚å¸¸
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    boolean free = false;
    // state == 0 è¡¨ç¤ºå·²ç»é‡Šæ”¾å®Œå…¨äº†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è·å–åŒæ­¥çŠ¶æ€äº†
    if (c == 0) {
        free = true;
        setExclusiveOwnerThread(null);
    }
    setState(c);
    return free;
}
```

* é€šè¿‡åˆ¤æ–­åˆ¤æ–­æ˜¯å¦ä¸ºè·å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œä¿è¯è¯¥æ–¹æ³•çº¿ç¨‹å®‰å…¨ã€‚
* åªæœ‰å½“åŒæ­¥çŠ¶æ€å½»åº•é‡Šæ”¾åï¼Œè¯¥æ–¹æ³•æ‰ä¼šè¿”å› true ã€‚å½“ `state == 0` æ—¶ï¼Œåˆ™å°†é”æŒæœ‰çº¿ç¨‹è®¾ç½®ä¸º null ï¼Œ`free= true`ï¼Œè¡¨ç¤ºé‡Šæ”¾æˆåŠŸã€‚

## 2.4 å…¶ä»–å®ç°æ–¹æ³•

å…¶ä»–å®ç°æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ã€‚

```Java
// æ˜¯å¦å½“å‰çº¿ç¨‹ç‹¬å 
@Override
protected final boolean isHeldExclusively() {
    // While we must in general read state before owner,
    // we don't need to do so to check if current thread is owner
    return getExclusiveOwnerThread() == Thread.currentThread();
}

// æ–°ç”Ÿæˆæ¡ä»¶
final ConditionObject newCondition() {
    return new ConditionObject();
}

// Methods relayed from outer class

// è·å¾—å ç”¨åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹
final Thread getOwner() {
    return getState() == 0 ? null : getExclusiveOwnerThread();
}

// è·å¾—å½“å‰çº¿ç¨‹æŒæœ‰é”çš„æ•°é‡
final int getHoldCount() {
    return isHeldExclusively() ? getState() : 0;
}

// æ˜¯å¦è¢«é”å®š
final boolean isLocked() {
    return getState() != 0;
}

/**
 * Reconstitutes the instance from a stream (that is, deserializes it).
 * è‡ªå®šä¹‰ååºåˆ—åŒ–é€»è¾‘
 */
private void readObject(java.io.ObjectInputStream s)
    throws java.io.IOException, ClassNotFoundException {
    s.defaultReadObject();
    setState(0); // reset to unlocked state
}
```

* ä»è¿™äº›æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒReentrantLock æ˜¯**ç‹¬å **è·å–åŒæ­¥çŠ¶æ€çš„æ¨¡å¼ã€‚

# 3. Sync å®ç°ç±»

## 3.1 NonfairSync

NonfairSync æ˜¯ ReentrantLock çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° Sync æŠ½è±¡ç±»ï¼Œ**é**å…¬å¹³é”å®ç°ç±»ã€‚

### 3.1.1 lock

`#lock()` **å®ç°**æ–¹æ³•ï¼Œé¦–å…ˆåŸºäº AQS `state` è¿›è¡Œ **CAS** æ“ä½œï¼Œå°† `0 => 1` ã€‚è‹¥æˆåŠŸï¼Œåˆ™è·å–é”æˆåŠŸã€‚è‹¥å¤±è´¥ï¼Œæ‰§è¡Œ AQS çš„**æ­£å¸¸**çš„åŒæ­¥çŠ¶æ€è·å–é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
final void lock() {
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}
```

* ä¼˜å…ˆåŸºäº AQS `state` è¿›è¡Œ **CAS** æ“ä½œï¼Œå·²ç»èƒ½ä½“ç°å‡º**éå…¬å¹³é”**çš„ç‰¹ç‚¹ã€‚å› ä¸ºï¼Œæ­¤æ—¶æœ‰å¯èƒ½æœ‰ N + 1 ä¸ªçº¿ç¨‹æ­£åœ¨è·å¾—é”ï¼Œå…¶ä¸­ 1 ä¸ªçº¿ç¨‹å·²ç»è·å¾—åˆ°é”ï¼Œé‡Šæ”¾çš„ç¬é—´ï¼Œæ°å¥½è¢«**æ–°**çš„çº¿ç¨‹æŠ¢å¤ºåˆ°ï¼Œè€Œä¸æ˜¯æ’é˜Ÿçš„ N ä¸ªçº¿ç¨‹ã€‚

### 3.1.2 tryAcquire

`#tryAcquire(int acquires)` **å®ç°**æ–¹æ³•ï¼Œ**éå…¬å¹³**çš„æ–¹å¼ï¼Œè·å¾—åŒæ­¥çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
protected final boolean tryAcquire(int acquires) {
    return nonfairTryAcquire(acquires);
}
```

* ç›´æ¥è°ƒç”¨ `#nonfairTryAcquire(int acquires)` æ–¹æ³•ï¼Œ**éå…¬å¹³é”**çš„æ–¹å¼è·å¾—é”ã€‚

## 3.2 FairSync

FairSync æ˜¯ ReentrantLock çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° Sync æŠ½è±¡ç±»ï¼Œå…¬å¹³é”å®ç°ç±»ã€‚

### 3.2.1 lock

`#lock()` **å®ç°**æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
final void lock() {
    acquire(1);
}
```

* ç›´æ¥æ‰§è¡Œ AQS çš„**æ­£å¸¸**çš„åŒæ­¥çŠ¶æ€è·å–é€»è¾‘ã€‚

### 3.2.2 tryAcquire

`#tryAcquire(int acquires)` **å®ç°**æ–¹æ³•ï¼Œ**å…¬å¹³**çš„æ–¹å¼ï¼Œè·å¾—åŒæ­¥çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
protected final boolean tryAcquire(int acquires) {
    final Thread current = Thread.currentThread();
    int c = getState();
    if (c == 0) {
        if (!hasQueuedPredecessors() && // <1>
                compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0)
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

æ¯”è¾ƒéå…¬å¹³é”å’Œå…¬å¹³é”è·å–åŒæ­¥çŠ¶æ€çš„è¿‡ç¨‹ï¼Œä¼šå‘ç°ä¸¤è€…**å”¯ä¸€çš„åŒºåˆ«**å°±åœ¨äºï¼Œå…¬å¹³é”åœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶å¤šäº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶ `<1>` å¤„çš„ `#hasQueuedPredecessors()` æ–¹æ³•ï¼Œæ˜¯å¦æœ‰**å‰åº**èŠ‚ç‚¹ï¼Œå³è‡ªå·±ä¸æ˜¯é¦–ä¸ª**ç­‰å¾…**è·å–åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
// AbstractQueuedSynchronizer.java
public final boolean hasQueuedPredecessors() {
    Node t = tail;  //å°¾èŠ‚ç‚¹
    Node h = head;  //å¤´èŠ‚ç‚¹
    Node s;

    //å¤´èŠ‚ç‚¹ != å°¾èŠ‚ç‚¹
    //åŒæ­¥é˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºnull
    //å½“å‰çº¿ç¨‹æ˜¯åŒæ­¥é˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    return h != t &&
            ((s = h.next) == null || s.thread != Thread.currentThread());
}
```

* è¯¥æ–¹æ³•ä¸»è¦åšä¸€ä»¶äº‹æƒ…ï¼šä¸»è¦æ˜¯åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä½äº CLH åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªã€‚å¦‚æœæ˜¯åˆ™è¿”å› true ï¼Œå¦åˆ™è¿”å› false ã€‚

# 3. Lock æ¥å£

`java.util.concurrent.locks.Lock` æ¥å£ï¼Œå®šä¹‰æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
void lock();
void lockInterruptibly() throws InterruptedException;
boolean tryLock();
boolean tryLock(long time, TimeUnit unit) throws InterruptedException;

void unlock();

Condition newCondition();
```

* æ¯ä¸ªæ–¹æ³•è§£é‡Šå¦‚ä¸‹å›¾ï¼š

    > FROM ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ [ã€Œ5.1 Lock æ¥å£ã€](#) ç« èŠ‚ã€‚
    > 
    > ![æ–¹æ³•è§£é‡Š](http://www.iocoder.cn/images/JUC/Lock-01.png)

# 4. ReentrantLock

`java.util.concurrent.locks.ReentrantLock` ï¼Œå®ç° Lock æ¥å£ï¼Œé‡å…¥é”ã€‚

ReentrantLock çš„å®ç°æ–¹æ³•ï¼ŒåŸºæœ¬æ˜¯å¯¹  Sync çš„è°ƒç”¨ã€‚

## 4.1 æ„é€ æ–¹æ³•

```Java
public ReentrantLock() {
    sync = new NonfairSync();
}

public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

* åŸºäº `fair` å‚æ•°ï¼Œåˆ›å»º FairSync è¿˜æ˜¯ NonfairSync å¯¹è±¡ã€‚

## 4.2 lock

```Java
@Override
public void lock() {
    sync.lock();
}
```

## 4.3 lockInterruptibly

```Java
@Override
public void lockInterruptibly() throws InterruptedException {
    sync.acquireInterruptibly(1);
}
```

## 4.4 tryLock

```Java
/**
 * Acquires the lock only if it is not held by another thread at the time
 * of invocation.
 *
 * <p>Acquires the lock if it is not held by another thread and
 * returns immediately with the value {@code true}, setting the
 * lock hold count to one. Even when this lock has been set to use a
 * fair ordering policy, a call to {@code tryLock()} <em>will</em>
 * immediately acquire the lock if it is available, whether or not
 * other threads are currently waiting for the lock.
 * This &quot;barging&quot; behavior can be useful in certain
 * circumstances, even though it breaks fairness. If you want to honor
 * the fairness setting for this lock, then use
 * {@link #tryLock(long, TimeUnit) tryLock(0, TimeUnit.SECONDS) }
 * which is almost equivalent (it also detects interruption).
 *
 * <p>If the current thread already holds this lock then the hold
 * count is incremented by one and the method returns {@code true}.
 *
 * <p>If the lock is held by another thread then this method will return
 * immediately with the value {@code false}.
 *
 * @return {@code true} if the lock was free and was acquired by the
 *         current thread, or the lock was already held by the current
 *         thread; and {@code false} otherwise
 */
@Override
public boolean tryLock() {
    return sync.nonfairTryAcquire(1);
}
```

* è¯¦ç»†çš„è¯´æ˜ï¼Œèƒ–å‹å¯ä»¥çœ‹ä¸Šé¢çš„è‹±æ–‡æ³¨é‡Šã€‚
* è€è‰¿è‰¿çš„ç®€å•ç†è§£æ˜¯ï¼š
    * `#tryLock()` **å®ç°**æ–¹æ³•ï¼Œåœ¨å®ç°æ—¶ï¼Œå¸Œæœ›èƒ½**å¿«é€Ÿçš„**è·å¾—æ˜¯å¦èƒ½å¤Ÿè·å¾—åˆ°é”ï¼Œå› æ­¤å³ä½¿åœ¨è®¾ç½®ä¸º `fair = true` ( ä½¿ç”¨å…¬å¹³é” )ï¼Œä¾ç„¶è°ƒç”¨ `Sync#nonfairTryAcquire(int acquires)` æ–¹æ³•ã€‚
    * å¦‚æœ**çœŸçš„**å¸Œæœ› `#tryLock()` è¿˜æ˜¯æŒ‰ç…§æ˜¯å¦å…¬å¹³é”çš„æ–¹å¼æ¥ï¼Œå¯ä»¥è°ƒç”¨ `#tryLock(0, TimeUnit)` æ–¹æ³•æ¥å®ç°ã€‚

## 4.5 tryLock

```Java
@Override
public boolean tryLock(long timeout, TimeUnit unit)
        throws InterruptedException {
    return sync.tryAcquireNanos(1, unit.toNanos(timeout));
}
```

## 4.6 unlock

```Java
@Override
public void unlock() {
    sync.release(1);
}
```

## 4.7 newCondition

```Java
@Override
public Condition newCondition() {
    return sync.newCondition();
}
```

## 4.8 å…¶ä»–å®ç°æ–¹æ³•

å…¶ä»–å®ç°æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ã€‚

```Java
public int getHoldCount() {
    return sync.getHoldCount();
}
public boolean isHeldByCurrentThread() {
    return sync.isHeldExclusively();
}
public boolean isLocked() {
    return sync.isLocked();
}


public final boolean isFair() {
    return sync instanceof FairSync;
}

protected Thread getOwner() {
    return sync.getOwner();
}
public final boolean hasQueuedThreads() {
    return sync.hasQueuedThreads();
}
public final boolean hasQueuedThread(Thread thread) {
    return sync.isQueued(thread);
}
public final int getQueueLength() {
    return sync.getQueueLength();
}
protected Collection<Thread> getQueuedThreads() {
    return sync.getQueuedThreads();
}

public boolean hasWaiters(Condition condition) {
    if (condition == null)
        throw new NullPointerException();
    if (!(condition instanceof AbstractQueuedSynchronizer.ConditionObject))
        throw new IllegalArgumentException("not owner");
    return sync.hasWaiters((AbstractQueuedSynchronizer.ConditionObject)condition);
}
public int getWaitQueueLength(Condition condition) {
    if (condition == null)
        throw new NullPointerException();
    if (!(condition instanceof AbstractQueuedSynchronizer.ConditionObject))
        throw new IllegalArgumentException("not owner");
    return sync.getWaitQueueLength((AbstractQueuedSynchronizer.ConditionObject)condition);
}
protected Collection<Thread> getWaitingThreads(Condition condition) {
    if (condition == null)
        throw new NullPointerException();
    if (!(condition instanceof AbstractQueuedSynchronizer.ConditionObject))
        throw new IllegalArgumentException("not owner");
    return sync.getWaitingThreads((AbstractQueuedSynchronizer.ConditionObject)condition);
}
```

# 5. ReentrantLock ä¸ synchronized çš„åŒºåˆ«

å‰é¢æåˆ° ReentrantLock æä¾›äº†æ¯” `synchronized` æ›´åŠ çµæ´»å’Œå¼ºå¤§çš„é”æœºåˆ¶ï¼Œé‚£ä¹ˆå®ƒçš„çµæ´»å’Œå¼ºå¤§ä¹‹å¤„åœ¨å“ªé‡Œå‘¢ï¼Ÿä»–ä»¬ä¹‹é—´åˆæœ‰ä»€ä¹ˆç›¸å¼‚ä¹‹å¤„å‘¢ï¼Ÿ

é¦–å…ˆä»–ä»¬è‚¯å®šå…·æœ‰ç›¸åŒçš„åŠŸèƒ½å’Œå†…å­˜è¯­ä¹‰ã€‚

1. ä¸ `synchronized` ç›¸æ¯”ï¼ŒReentrantLockæä¾›äº†æ›´å¤šï¼Œæ›´åŠ å…¨é¢çš„åŠŸèƒ½ï¼Œå…·å¤‡æ›´å¼ºçš„æ‰©å±•æ€§ã€‚ä¾‹å¦‚ï¼šæ—¶é—´é”ç­‰å€™ï¼Œå¯ä¸­æ–­é”ç­‰å€™ï¼Œé”æŠ•ç¥¨ã€‚
2. ReentrantLock è¿˜æä¾›äº†æ¡ä»¶ Condition ï¼Œå¯¹çº¿ç¨‹çš„ç­‰å¾…ã€å”¤é†’æ“ä½œæ›´åŠ è¯¦ç»†å’Œçµæ´»ï¼Œæ‰€ä»¥åœ¨å¤šä¸ªæ¡ä»¶å˜é‡å’Œé«˜åº¦ç«äº‰é”çš„åœ°æ–¹ï¼ŒReentrantLock æ›´åŠ é€‚åˆï¼ˆä»¥åä¼šé˜è¿°Conditionï¼‰ã€‚
3. ReentrantLock æä¾›äº†å¯è½®è¯¢çš„é”è¯·æ±‚ã€‚å®ƒä¼šå°è¯•ç€å»è·å–é”ï¼Œå¦‚æœæˆåŠŸåˆ™ç»§ç»­ï¼Œå¦åˆ™å¯ä»¥ç­‰åˆ°ä¸‹æ¬¡è¿è¡Œæ—¶å¤„ç†ï¼Œè€Œ `synchronized` åˆ™ä¸€æ—¦è¿›å…¥é”è¯·æ±‚è¦ä¹ˆæˆåŠŸè¦ä¹ˆé˜»å¡ï¼Œæ‰€ä»¥ç›¸æ¯” `synchronized` è€Œè¨€ï¼ŒReentrantLockä¼šä¸å®¹æ˜“äº§ç”Ÿæ­»é”äº›ã€‚
4. ReentrantLock æ”¯æŒæ›´åŠ çµæ´»çš„åŒæ­¥ä»£ç å—ï¼Œä½†æ˜¯ä½¿ç”¨ `synchronized` æ—¶ï¼Œåªèƒ½åœ¨åŒä¸€ä¸ª `synchronized` å—ç»“æ„ä¸­è·å–å’Œé‡Šæ”¾ã€‚æ³¨æ„ï¼ŒReentrantLock çš„é”é‡Šæ”¾ä¸€å®šè¦åœ¨ `finally` ä¸­å¤„ç†ï¼Œå¦åˆ™å¯èƒ½ä¼šäº§ç”Ÿä¸¥é‡çš„åæœã€‚
5. ReentrantLock æ”¯æŒä¸­æ–­å¤„ç†ï¼Œä¸”æ€§èƒ½è¾ƒ `synchronized` ä¼šå¥½äº›ã€‚

# å‚è€ƒèµ„æ–™

1. Doug Leaï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹
2. æ–¹è…¾é£ï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ [ã€Œ5.1 Lock æ¥å£ã€](#) å’Œ [ã€Œ5.3 é‡å…¥é”ã€](#) ç« èŠ‚
3. [ã€Šã€JUCã€‘JDK 1.8 æºç åˆ†æä¹‹ ReentrantLockï¼ˆä¸‰ï¼‰ã€‹](http://www.cnblogs.com/leesf456/p/5383609.html)

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

