title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹ ConcurrentHashMap çº¢é»‘æ ‘è½¬æ¢åˆ†æ
date: 2018-06-06
tag: 
categories: JUC
permalink: JUC/sike/ConcurrentHashMap-red-black-tree
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2329
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2329 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åœ¨[ã€æ­»ç£•Javaå¹¶å‘ã€‘â€”â€“J.U.Cä¹‹Javaå¹¶å‘å®¹å™¨ï¼šConcurrentHashMap](file:///G:/weizhi/myKnowledge/temp/88a476a9-c65e-4779-9c79-f129452a106c/128/)ä¸€æ–‡ä¸­è¯¦ç»†é˜è¿°äº†ConcurrentHashMapçš„å®ç°è¿‡ç¨‹ï¼Œå…¶ä¸­æœ‰æåˆ°åœ¨putæ“ä½œæ—¶ï¼Œå¦‚æœå‘ç°é“¾è¡¨ç»“æ„ä¸­çš„å…ƒç´ è¶…è¿‡äº†TREEIFY_THRESHOLDï¼ˆé»˜è®¤ä¸º8ï¼‰ï¼Œåˆ™ä¼šæŠŠé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œå·²ä¾¿äºæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
if (binCount >= TREEIFY_THRESHOLD)
    treeifyBin(tab, i);
```

ä¸‹é¢åšä¸»å°†è¯¦ç»†åˆ†ææ•´ä¸ªè¿‡ç¨‹ï¼Œå¹¶ç”¨ä¸€ä¸ªé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹ä¸ºæ¡ˆä¾‹æ¥åˆ†æã€‚åšæ–‡ä»å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•è¿›è¡Œåˆ†æé˜è¿°ï¼š

1. çº¢é»‘æ ‘
2. ConcurrentHashMapé“¾è¡¨è½¬çº¢é»‘æ ‘æºç åˆ†æ
3. é“¾è¡¨è½¬çº¢é»‘æ ‘æ¡ˆä¾‹

#### çº¢é»‘æ ‘

å…ˆçœ‹çº¢é»‘æ ‘çš„åŸºæœ¬æ¦‚å¿µï¼šçº¢é»‘æ ‘æ˜¯ä¸€è¯¾ç‰¹æ®Šçš„å¹³è¡¡äºŒå‰æ ‘ï¼Œä¸»è¦ç”¨å®ƒå­˜å‚¨æœ‰åºçš„æ•°æ®ï¼Œæä¾›é«˜æ•ˆçš„æ•°æ®æ£€ç´¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(lgn)ã€‚çº¢é»‘æ ‘æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæ ‡è¯†ä½è¡¨ç¤ºé¢œè‰²ï¼Œçº¢è‰²æˆ–é»‘è‰²ï¼Œå…·å¤‡äº”ç§ç‰¹æ€§ï¼š

1. æ¯ä¸ªèŠ‚ç‚¹éçº¢å³é»‘
2. æ ¹èŠ‚ç‚¹ä¸ºé»‘è‰²
3. æ¯ä¸ªå¶å­èŠ‚ç‚¹ä¸ºé»‘è‰²ã€‚å¶å­èŠ‚ç‚¹ä¸ºNILèŠ‚ç‚¹ï¼Œå³ç©ºèŠ‚ç‚¹
4. å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œé‚£ä¹ˆå®ƒçš„å­èŠ‚ç‚¹ä¸€å®šæ˜¯é»‘è‰²
5. ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„å­å­™èŠ‚ç‚¹çš„æ‰€æœ‰è·¯å¾„åŒ…å«ç›¸åŒä¸ªæ•°çš„é»‘è‰²èŠ‚ç‚¹

**è¯·ç‰¢è®°è¿™äº”ä¸ªç‰¹æ€§ï¼Œå®ƒåœ¨ç»´æŠ¤çº¢é»‘æ ‘æ—¶é€‰çš„æ ¼å¤–é‡è¦**

çº¢é»‘æ ‘ç»“æ„å›¾å¦‚ä¸‹ï¼š

[![201705040001_2[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822001.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822001.png)

å¯¹äºçº¢é»‘æ ‘è€Œè¨€ï¼Œå®ƒä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªæ­¥éª¤ï¼šå·¦æ—‹ã€å³æ—‹ã€ç€è‰²ã€‚æ‰€æœ‰ä¸ç¬¦åˆä¸Šé¢äº”ä¸ªç‰¹æ€§çš„â€œçº¢é»‘æ ‘â€éƒ½å¯ä»¥é€šè¿‡è¿™ä¸‰ä¸ªæ­¥éª¤è°ƒæ•´ä¸ºæ­£è§„çš„çº¢é»‘æ ‘ã€‚

##### æ—‹è½¬

å½“å¯¹çº¢é»‘æ ‘è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œæ—¶å¯èƒ½ä¼šç ´åçº¢é»‘æ ‘çš„ç‰¹æ€§ã€‚ä¸ºäº†ç»§ç»­ä¿æŒçº¢é»‘æ ‘çš„æ€§è´¨ï¼Œåˆ™éœ€è¦é€šè¿‡å¯¹çº¢é»‘æ ‘è¿›è¡Œæ—‹è½¬å’Œé‡æ–°ç€è‰²å¤„ç†ï¼Œå…¶ä¸­æ—‹è½¬åŒ…æ‹¬å·¦æ—‹ã€å³æ—‹ã€‚

**å·¦æ—‹**
å·¦æ—‹ç¤ºæ„å›¾å¦‚ä¸‹ï¼š
[![201705040002[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822002.gif)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822002.gif)
å·¦æ—‹å¤„ç†è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå°†Eçš„å³å­©å­Sè°ƒæ•´ä¸ºEçš„çˆ¶èŠ‚ç‚¹ã€SèŠ‚ç‚¹çš„å·¦å­©å­ä½œä¸ºè°ƒæ•´åEèŠ‚ç‚¹çš„å³å­©å­ã€‚

**å³æ—‹**
[![201705040003[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822003.gif)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822003.gif)

##### çº¢é»‘æ ‘æ’å…¥èŠ‚ç‚¹

ç”±äºé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘åªæœ‰æ·»åŠ æ“ä½œï¼ŒåŠ ä¸Šç¯‡å¹…æœ‰é™æ‰€ä»¥è¿™é‡Œå°±åªä»‹ç»çº¢é»‘æ ‘çš„æ’å…¥æ“ä½œï¼Œå…³äºçº¢é»‘æ ‘çš„è¯¦ç»†æƒ…å†µï¼Œçƒ¦è¯·å„ä½Googleã€‚

åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ä¸‹é¢ä¸€é¢—ç®€å•çš„æ ‘ä¸ºæ¡ˆä¾‹ï¼Œæ ¹èŠ‚ç‚¹Gã€æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹Pã€Uï¼Œæˆ‘ä»¬æ–°å¢çš„èŠ‚ç‚¹ä¸ºN

[![201705040004[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822004.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822004.png)

çº¢é»‘æ ‘é»˜è®¤æ’å…¥çš„èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œå› ä¸ºå¦‚æœä¸ºé»‘è‰²ï¼Œåˆ™ä¸€å®šä¼šç ´åçº¢é»‘æ ‘çš„è§„åˆ™5ï¼ˆä»ä¸€ä¸ªèŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹çš„å­å­™èŠ‚ç‚¹çš„æ‰€æœ‰è·¯å¾„åŒ…å«ç›¸åŒä¸ªæ•°çš„é»‘è‰²èŠ‚ç‚¹ï¼‰ã€‚å°½ç®¡é»˜è®¤çš„èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œæ’å…¥ä¹‹åä¹Ÿä¼šå¯¼è‡´çº¢é»‘æ ‘å¤±è¡¡ã€‚çº¢é»‘æ ‘æ’å…¥æ“ä½œå¯¼è‡´å…¶å¤±è¡¡çš„ä¸»è¦åŸå› åœ¨äºæ’å…¥çš„å½“å‰èŠ‚ç‚¹ä¸å…¶çˆ¶èŠ‚ç‚¹çš„é¢œè‰²å†²çªå¯¼è‡´ï¼ˆçº¢çº¢ï¼Œè¿èƒŒè§„åˆ™4ï¼šå¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œé‚£ä¹ˆå®ƒçš„å­èŠ‚ç‚¹ä¸€å®šæ˜¯é»‘è‰²ï¼‰ã€‚
[![201705040005[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822005.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822005.png)
è¦è§£å†³è¿™ç±»å†²çªå°±é ä¸Šé¢ä¸‰ä¸ªæ“ä½œï¼šå·¦æ—‹ã€å³æ—‹ã€é‡æ–°ç€è‰²ã€‚ç”±äºæ˜¯çº¢çº¢å†²çªï¼Œé‚£ä¹ˆå…¶ç¥–çˆ¶èŠ‚ç‚¹ä¸€å®šå­˜åœ¨ä¸”ä¸ºé»‘è‰²ï¼Œä½†æ˜¯å”çˆ¶èŠ‚ç‚¹Ué¢œè‰²ä¸ç¡®å®šï¼Œæ ¹æ®å”çˆ¶èŠ‚ç‚¹çš„é¢œè‰²åˆ™å¯ä»¥åšç›¸åº”çš„è°ƒæ•´ã€‚

**1 å”çˆ¶UèŠ‚ç‚¹æ˜¯çº¢è‰²**

å¦‚æœå”çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œé‚£ä¹ˆå¤„ç†è¿‡ç¨‹åˆ™å˜å¾—æ¯”è¾ƒç®€å•äº†ï¼šæ›´æ¢Gä¸Pã€UèŠ‚ç‚¹çš„é¢œè‰²ï¼Œä¸‹å›¾ï¼ˆä¸€ï¼‰ã€‚
[![201705040006_2[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822006.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822006.png)

å½“ç„¶è¿™æ ·å˜è‰²å¯èƒ½ä¼šå¯¼è‡´å¦å¤–ä¸€ä¸ªé—®é¢˜äº†ï¼Œå°±æ˜¯çˆ¶èŠ‚ç‚¹Gä¸å…¶çˆ¶èŠ‚ç‚¹GGé¢œè‰²å†²çªï¼ˆä¸Šå›¾äºŒï¼‰ï¼Œé‚£ä¹ˆè¿™é‡Œéœ€è¦å°†GèŠ‚ç‚¹å½“åšæ–°å¢èŠ‚ç‚¹è¿›è¡Œé€’å½’å¤„ç†ã€‚

**2 å”çˆ¶UèŠ‚ç‚¹ä¸ºé»‘å”**

å¦‚æœå½“å‰èŠ‚ç‚¹çš„å”çˆ¶èŠ‚ç‚¹Uä¸ºé»‘è‰²ï¼Œåˆ™éœ€è¦æ ¹æ®å½“å‰èŠ‚ç‚¹Nä¸å…¶çˆ¶èŠ‚ç‚¹Pçš„ä½ç½®å†³å®šï¼Œåˆ†ä¸ºå››ç§æƒ…å†µï¼š

1. Næ˜¯Pçš„å³å­èŠ‚ç‚¹ã€Pæ˜¯Gçš„å³å­èŠ‚ç‚¹
2. Næ˜¯Pçš„å·¦å­èŠ‚ç‚¹ï¼ŒPæ˜¯Gçš„å·¦å­èŠ‚ç‚¹
3. Næ˜¯Pçš„å·¦å­èŠ‚ç‚¹ï¼ŒPæ˜¯Gçš„å³å­èŠ‚ç‚¹
4. Næ˜¯Pçš„å³å­èŠ‚ç‚¹ï¼ŒPæ˜¯Gçš„å·¦å­èŠ‚ç‚¹

æƒ…å†µ1ã€2ç§°ä¹‹ä¸ºå¤–ä¾§æ’å…¥ã€æƒ…å†µ3ã€4æ˜¯å†…ä¾§æ’å…¥ï¼Œä¹‹æ‰€ä»¥è¿™æ ·åŒºåˆ†æ˜¯å› ä¸ºä»–ä»¬çš„å¤„ç†æ–¹å¼æ˜¯ç›¸å¯¹çš„ã€‚

**2.1 å¤–ä¾§æ’å…¥**

ä»¥Næ˜¯Pçš„å³å­èŠ‚ç‚¹ã€Pæ˜¯Gçš„å³å­èŠ‚ç‚¹ä¸ºä¾‹ï¼Œè¿™ç§æƒ…å†µçš„å¤„ç†æ–¹å¼ä¸ºï¼šä»¥Pä¸ºæ”¯ç‚¹è¿›è¡Œå·¦æ—‹ï¼Œç„¶åäº¤æ¢På’ŒGçš„é¢œè‰²ï¼ˆPè®¾ç½®ä¸ºé»‘è‰²ï¼ŒGè®¾ç½®ä¸ºçº¢è‰²ï¼‰ï¼Œå¦‚ä¸‹ï¼š
[![201705040007_2[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822007.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822007.png)

å·¦å¤–ä¾§çš„æƒ…å†µï¼ˆNæ˜¯Pçš„å·¦å­èŠ‚ç‚¹ï¼ŒPæ˜¯Gçš„å·¦å­èŠ‚ç‚¹ï¼‰å’Œä¸Šé¢çš„å¤„ç†æ–¹å¼ä¸€æ ·ï¼Œå…ˆå³æ—‹ï¼Œç„¶åé‡æ–°ç€è‰²ã€‚

**2.2 å†…ä¾§æ’å…¥**

ä»¥Næ˜¯Pçš„å·¦å­èŠ‚ç‚¹ï¼ŒPæ˜¯Gçš„å³å­èŠ‚ç‚¹æƒ…å†µä¸ºä¾‹ã€‚å†…ä¾§æ’å…¥çš„æƒ…å†µç¨å¾®å¤æ‚äº›ï¼Œç»è¿‡ä¸€æ¬¡æ—‹è½¬ã€ç€è‰²æ˜¯æ— æ³•è°ƒæ•´ä¸ºçº¢é»‘æ ‘çš„ï¼Œå¤„ç†æ–¹æ³•å¦‚ä¸‹ï¼šå…ˆè¿›è¡Œä¸€æ¬¡å³æ—‹ï¼Œå†è¿›è¡Œä¸€æ¬¡å·¦æ—‹ï¼Œç„¶åé‡æ–°ç€è‰²ï¼Œå³å¯å®Œæˆè°ƒæ•´ã€‚æ³¨æ„è¿™é‡Œä¸¤æ¬¡å³æ—‹éƒ½æ˜¯ä»¥æ–°å¢èŠ‚ç‚¹Nä¸ºæ”¯ç‚¹ä¸æ˜¯Pã€‚è¿™é‡Œå°†NèŠ‚ç‚¹çš„ä¸¤ä¸ªNILèŠ‚ç‚¹å‘½åä¸ºXã€Lã€‚å¦‚ä¸‹ï¼š

[![201705040008[4\]](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822008.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822008.png)

è‡³äºå·¦å†…ä¾§åˆ™å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼šå…ˆè¿›è¡Œå³æ—‹ï¼Œç„¶åå·¦æ—‹ï¼Œæœ€åç€è‰²ã€‚

##### ConcurrentHashMap çš„treeifyBinè¿‡ç¨‹

ConcurrentHashMapçš„é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªçº¢é»‘æ ‘å¢åŠ èŠ‚ç‚¹çš„è¿‡ç¨‹ã€‚åœ¨putè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç°é“¾è¡¨ç»“æ„ä¸­çš„å…ƒç´ è¶…è¿‡äº†TREEIFY_THRESHOLDï¼ˆé»˜è®¤ä¸º8ï¼‰ï¼Œåˆ™ä¼šæŠŠé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼š

```Java
if (binCount >= TREEIFY_THRESHOLD)
    treeifyBin(tab, i);
```

treeifyBinä¸»è¦çš„åŠŸèƒ½å°±æ˜¯æŠŠé“¾è¡¨æ‰€æœ‰çš„èŠ‚ç‚¹Nodeè½¬æ¢ä¸ºTreeNodeèŠ‚ç‚¹ï¼Œå¦‚ä¸‹ï¼š

```Java
    private final void treeifyBin(Node<K,V>[] tab, int index) {
        Node<K,V> b; int n, sc;
        if (tab != null) {
            if ((n = tab.length) < MIN_TREEIFY_CAPACITY)
                tryPresize(n << 1);
            else if ((b = tabAt(tab, index)) != null && b.hash >= 0) {
                synchronized (b) {
                    if (tabAt(tab, index) == b) {
                        TreeNode<K,V> hd = null, tl = null;
                        for (Node<K,V> e = b; e != null; e = e.next) {
                            TreeNode<K,V> p =
                                new TreeNode<K,V>(e.hash, e.key, e.val,
                                                  null, null);
                            if ((p.prev = tl) == null)
                                hd = p;
                            else
                                tl.next = p;
                            tl = p;
                        }
                        setTabAt(tab, index, new TreeBin<K,V>(hd));
                    }
                }
            }
        }
    }
```

å…ˆåˆ¤æ–­å½“å‰Nodeçš„æ•°ç»„é•¿åº¦æ˜¯å¦å°äºMIN_TREEIFY_CAPACITYï¼ˆ64ï¼‰ï¼Œå¦‚æœå°äºåˆ™è°ƒç”¨tryPresizeæ‰©å®¹å¤„ç†ä»¥ç¼“è§£å•ä¸ªé“¾è¡¨å…ƒç´ è¿‡å¤§çš„æ€§èƒ½é—®é¢˜ã€‚å¦åˆ™åˆ™å°†NodeèŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢ä¸ºTreeNodeçš„èŠ‚ç‚¹é“¾è¡¨ï¼Œæ„å»ºå®Œæˆä¹‹åè°ƒç”¨setTabAt()æ„å»ºçº¢é»‘æ ‘ã€‚TreeNodeç»§æ‰¿Nodeï¼Œå¦‚ä¸‹ï¼š

```Java
    static final class TreeNode<K,V> extends Node<K,V> {
        TreeNode<K,V> parent;  // red-black tree links
        TreeNode<K,V> left;
        TreeNode<K,V> right;
        TreeNode<K,V> prev;    // needed to unlink next upon deletion
        boolean red;

        TreeNode(int hash, K key, V val, Node<K,V> next,
                 TreeNode<K,V> parent) {
            super(hash, key, val, next);
            this.parent = parent;
        }
		......
	}
```

æˆ‘ä»¬ä»¥ä¸‹é¢ä¸€ä¸ªé“¾è¡¨ä½œä¸ºæ¡ˆä¾‹ï¼Œç»“åˆæºä»£ç æ¥åˆ†æConcurrentHashMapåˆ›å»ºçº¢é»‘æ ‘çš„è¿‡ç¨‹ï¼š

[![201705040009_2](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822009.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120822009.png)

**12**

12ä½œä¸ºè·ŸèŠ‚ç‚¹ï¼Œç›´æ¥ä¸ºå°†çº¢ç¼–ç¨‹é»‘å³å¯ï¼Œå¯¹åº”æºç ï¼š

```Java
                next = (TreeNode<K,V>)x.next;
                x.left = x.right = null;
                if (r == null) {
                    x.parent = null;
                    x.red = false;
                    r = x;
                }
```

[![201705040010](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220010.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220010.png)
(**ã€æ³¨ã€‘ï¼šä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œçœç•¥NILèŠ‚ç‚¹ï¼Œåé¢ä¹Ÿä¸€æ ·**)

**1**

æ­¤æ—¶æ ¹èŠ‚ç‚¹rootä¸ä¸ºç©ºï¼Œåˆ™æ’å…¥èŠ‚ç‚¹æ—¶éœ€è¦æ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œæºç å¦‚ä¸‹ï¼š

```Java
                    K k = x.key;
                    int h = x.hash;
                    Class<?> kc = null;
                    for (TreeNode<K,V> p = r;;) {
                        int dir, ph;
                        K pk = p.key;
                        if ((ph = p.hash) > h)
                            dir = -1;
                        else if (ph < h)
                            dir = 1;
                        else if ((kc == null &&
                                  (kc = comparableClassFor(k)) == null) ||
                                 (dir = compareComparables(kc, k, pk)) == 0)
                            dir = tieBreakOrder(k, pk);
                            TreeNode<K,V> xp = p;
                        if ((p = (dir <= 0) ? p.left : p.right) == null) {
                            x.parent = xp;
                            if (dir <= 0)
                                xp.left = x;
                            else
                                xp.right = x;
                            r = balanceInsertion(r, x);
                            break;
                        }
                    }
```

ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°èµ·å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š

1. è®¡ç®—èŠ‚ç‚¹çš„hashå€¼ pã€‚dir è¡¨ç¤ºä¸ºå¾€å·¦ç§»è¿˜æ˜¯å¾€å³ç§»ã€‚x è¡¨ç¤ºè¦æ’å…¥çš„èŠ‚ç‚¹ï¼Œp è¡¨ç¤ºå¸¦æ¯”è¾ƒçš„èŠ‚ç‚¹ã€‚

2. ä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œè®¡ç®—æ¯”è¾ƒèŠ‚ç‚¹pçš„çš„hashå€¼ ph ï¼Œè‹¥ph > h ,åˆ™dir = -1 ,è¡¨ç¤ºå·¦ç§»ï¼Œå–p = p.leftã€‚è‹¥p == nullåˆ™æ’å…¥ï¼Œè‹¥ p != nullï¼Œåˆ™ç»§ç»­æ¯”è¾ƒï¼Œç›´åˆ°ç›´åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼Œæœ€åè°ƒç”¨balanceInsertion()æ–¹æ³•è°ƒæ•´çº¢é»‘æ ‘ç»“æ„ã€‚ph < hï¼Œå³ç§»ã€‚

3. å¦‚æœph = hï¼Œåˆ™è¡¨ç¤ºèŠ‚ç‚¹â€œå†²çªâ€ï¼ˆå’ŒHashMapå†²çªä¸€è‡´ï¼‰ï¼Œé‚£æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿé¦–å…ˆè°ƒç”¨comparableClassFor()æ–¹æ³•åˆ¤æ–­èŠ‚ç‚¹çš„keyæ˜¯å¦å®ç°äº†Comparableæ¥å£ï¼Œå¦‚æœkc ï¼= null ï¼Œåˆ™é€šè¿‡compareComparables()æ–¹æ³•é€šè¿‡compareTo()æ¯”è¾ƒå¸¦ä¸‹ï¼Œå¦‚æœè¿˜æ˜¯è¿”å› 0ï¼Œå³dir == 0ï¼Œåˆ™è°ƒç”¨tieBreakOrder()æ–¹æ³•æ¥æ¯”è¾ƒäº†ã€‚tieBreakOrderå¦‚ä¸‹ï¼š

   ```Java
           static int tieBreakOrder(Object a, Object b) {
               int d;
               if (a == null || b == null ||
                   (d = a.getClass().getName().
                    compareTo(b.getClass().getName())) == 0)
                   d = (System.identityHashCode(a) <= System.identityHashCode(b) ?
                        -1 : 1);
               return d;
           }
   ```

tieBreakOrder()æ–¹æ³•æœ€ç»ˆè¿˜æ˜¯é€šè¿‡è°ƒç”¨System.identityHashCode()æ–¹æ³•æ¥æ¯”è¾ƒã€‚

ç¡®å®šæ’å…¥ä½ç½®åï¼Œæ’å…¥ï¼Œç”±äºæ’å…¥çš„èŠ‚ç‚¹æœ‰å¯èƒ½ä¼šæ‰“ç ´çº¢é»‘æ ‘çš„ç»“æ„ï¼Œæ‰€ä»¥æ’å…¥åè°ƒç”¨balanceInsertion()æ–¹æ³•æ¥è°ƒæ•´çº¢é»‘æ ‘ç»“æ„ã€‚

```Java
    static <K,V> TreeNode<K,V> balanceInsertion(TreeNode<K,V> root,
                                                TreeNode<K,V> x) {
        x.red = true;       // æ‰€æœ‰èŠ‚ç‚¹é»˜è®¤æ’å…¥ä¸ºçº¢
        for (TreeNode<K,V> xp, xpp, xppl, xppr;;) {

            // x.parent == nullï¼Œä¸ºè·ŸèŠ‚ç‚¹ï¼Œç½®é»‘å³å¯
            if ((xp = x.parent) == null) {
                x.red = false;
                return x;
            }
            // x çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼Œæˆ–è€…x çš„ç¥–çˆ¶èŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥æ’å…¥è¿”å›
            else if (!xp.red || (xpp = xp.parent) == null)
                return root;

            /*
             * x çš„ çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²
             * ---------------------
             * x çš„ çˆ¶èŠ‚ç‚¹ ä¸º å…¶ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹
             */
            if (xp == (xppl = xpp.left)) {
                /*
                 * xçš„å”çˆ¶èŠ‚ç‚¹å­˜åœ¨ï¼Œä¸”ä¸ºçº¢è‰²ï¼Œé¢œè‰²äº¤æ¢å³å¯
                 * xçš„çˆ¶èŠ‚ç‚¹ã€å”çˆ¶èŠ‚ç‚¹å˜ä¸ºé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹å˜ä¸ºçº¢è‰²
                 */
                if ((xppr = xpp.right) != null && xppr.red) {
                    xppr.red = false;
                    xp.red = false;
                    xpp.red = true;
                    x = xpp;
                }
                else {
                    /*
                     * x ä¸º å…¶çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œåˆ™ä¸ºå†…ä¾§æ’å…¥
                     * åˆ™å…ˆå·¦æ—‹ï¼Œç„¶åå³æ—‹
                     */
                    if (x == xp.right) {
                        // å·¦æ—‹
                        root = rotateLeft(root, x = xp);
                        // å·¦æ—‹ä¹‹åxåˆ™ä¼šå˜æˆxpçš„çˆ¶èŠ‚ç‚¹
                        xpp = (xp = x.parent) == null ? null : xp.parent;
                    }

                    /**
                     * è¿™é‡Œæœ‰ä¸¤éƒ¨åˆ†ã€‚
                     * ç¬¬ä¸€éƒ¨åˆ†ï¼šx åŸæœ¬å°±æ˜¯å…¶çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œåˆ™ä¸ºå¤–ä¾§æ’å…¥ï¼Œå³æ—‹å³å¯
                     * ç¬¬äºŒéƒ¨åˆ†ï¼šå†…ä¾§æ’å…¥åï¼Œå…ˆè¿›è¡Œå·¦æ—‹ï¼Œç„¶åå³æ—‹
                     */
                    if (xp != null) {
                        xp.red = false;
                        if (xpp != null) {
                            xpp.red = true;
                            root = rotateRight(root, xpp);
                        }
                    }
                }
            }

            /**
             * ä¸ä¸Šç›¸å¯¹åº”
             */
            else {
                if (xppl != null && xppl.red) {
                    xppl.red = false;
                    xp.red = false;
                    xpp.red = true;
                    x = xpp;
                }
                else {
                    if (x == xp.left) {
                        root = rotateRight(root, x = xp);
                        xpp = (xp = x.parent) == null ? null : xp.parent;
                    }
                    if (xp != null) {
                        xp.red = false;
                        if (xpp != null) {
                            xpp.red = true;
                            root = rotateLeft(root, xpp);
                        }
                    }
                }
            }
        }
    }
```

å›åˆ°èŠ‚ç‚¹1ï¼Œå…¶çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼Œå³ï¼š

```Java
            else if (!xp.red || (xpp = xp.parent) == null)
                return root;
```

ç›´æ¥æ’å…¥ï¼š
[![201705040011_3](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220011.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220011.png)

**9**

9ä½œä¸º1çš„å³å­èŠ‚ç‚¹æ’å…¥ï¼Œä½†æ˜¯å­˜åœ¨çº¢çº¢å†²çªï¼Œæ­¤æ—¶9çš„å¹¶æ²¡æœ‰å”çˆ¶èŠ‚ç‚¹ã€‚9çš„çˆ¶èŠ‚ç‚¹1ä¸º12çš„å·¦å­èŠ‚ç‚¹ï¼Œ9ä¸ºå…¶çˆ¶èŠ‚ç‚¹1çš„å³å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¤„ç†é€»è¾‘æ˜¯å…ˆå·¦æ—‹ï¼Œç„¶åå³æ—‹ï¼Œå¯¹åº”ä»£ç å¦‚ä¸‹ï¼š

```Java
                        if (x == xp.right) {
                            root = rotateLeft(root, x = xp);
                            xpp = (xp = x.parent) == null ? null : xp.parent;
                        }
                        if (xp != null) {
                            xp.red = false;
                            if (xpp != null) {
                                xpp.red = true;
                                root = rotateRight(root, xpp);
                            }
                        }
```

å›¾ä¾‹å˜åŒ–å¦‚ä¸‹ï¼š

[![201705040012](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220012.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220012.png)

**2**

èŠ‚ç‚¹2 ä½œä¸º1 çš„å³å­èŠ‚ç‚¹æ’å…¥ï¼Œçº¢çº¢å†²çªï¼Œåˆ‡å…¶å”çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œç›´æ¥å˜è‰²å³å¯ï¼Œï¼š

```Java
                    if ((xppr = xpp.right) != null && xppr.red) {
                        xppr.red = false;
                        xp.red = false;
                        xpp.red = true;
                        x = xpp;
                    }
```

å¯¹åº”å›¾ä¾‹ä¸ºï¼š

[![201705040013_4](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220013.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220013.png)

**0**

èŠ‚ç‚¹0ä½œä¸º1çš„å·¦å­èŠ‚ç‚¹æ’å…¥ï¼Œç”±äºå…¶çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼Œä¸ä¼šæ’å…¥åä¸ä¼šæ‰“ç ´çº¢é»‘æ ‘ç»“æ„ï¼Œç›´æ¥æ’å…¥å³å¯ï¼š

[![201705040014](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220014.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220014.png)

**11**

èŠ‚ç‚¹11ä½œä¸º12çš„å·¦å­èŠ‚ç‚¹ï¼Œå…¶çˆ¶èŠ‚ç‚¹12ä¸ºé»‘è‰²ï¼Œå’Œ0ä¸€æ ·é“ç†ï¼Œç›´æ¥æ’å…¥ï¼š

[![201705040015](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220015.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220015.png)

**7**

èŠ‚ç‚¹7ä½œä¸º2å³å­èŠ‚ç‚¹æ’å…¥ï¼Œçº¢çº¢å†²çªï¼Œå…¶å”çˆ¶èŠ‚ç‚¹0ä¸ºçº¢è‰²ï¼Œå˜è‰²å³å¯ï¼š

[![201705040016](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220016.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220016.png)

**19**

èŠ‚ç‚¹19ä½œä¸ºèŠ‚ç‚¹12çš„å³å­èŠ‚ç‚¹ï¼Œç›´æ¥æ’å…¥ï¼š

[![201705040017_2](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220017.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220017.png)

è‡³æ­¤ï¼Œæ•´ä¸ªè¿‡ç¨‹å·²ç»å®Œæˆäº†ï¼Œæœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š
[![201705040018](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220018.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208220018.png)

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)