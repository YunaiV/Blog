title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹å¹¶å‘å·¥å…·ç±»ï¼šCountDownLatch
date: 2018-06-02
tag: 
categories: JUC
permalink: JUC/sike/CountDownLatch
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2253
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484300&idx=1&sn=fcdadc7aeebfd397731820a50bbf1374&chksm=fa497c3dcd3ef52b9645f2912e2674c03944d36a1e5638e42da7a30b928d85a51746682b1df7#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2253 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

ä½œä¸ºã€Œå°æ˜å“¥ã€çš„å¿ å®è¯»è€…ï¼Œã€Œè€è‰¿è‰¿ã€ç•¥ä½œä¿®æ”¹ï¼Œè®°å½•åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒçš„èµ„æ–™ã€‚

- [1. ç®€ä»‹](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
- [2. å®ç°åˆ†æ](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
  - [2.1 Sync](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
  - [2.2 await](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
  - [2.3 await](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
  - [2.4 countDown](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
  - [2.5 getCount](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
- [3. æ€»ç»“](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
- [4. åº”ç”¨ç¤ºä¾‹](http://www.iocoder.cn/JUC/sike/CountDownLatch/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/CountDownLatch/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> æ­¤ç¯‡åšå®¢æ‰€æœ‰æºç å‡æ¥è‡ª JDK 1.8

# 1. ç®€ä»‹

åœ¨ä¸Šç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† Java å››å¤§å¹¶å‘å·¥å…·ä¹‹ä¸€çš„ CyclicBarrier ï¼Œä»Šå¤©è¦ä»‹ç»çš„CountDownLatch ä¸ CyclicBarrier æœ‰ç‚¹å„¿**ç›¸ä¼¼**ã€‚

CyclicBarrier æ‰€æè¿°çš„æ˜¯â€œå…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æŸä¸ªå…¬å…±å±éšœç‚¹ï¼Œæ‰ä¼šè¿›è¡Œåç»­ä»»åŠ¡"ï¼Œè€Œ CountDownLatch æ‰€æè¿°çš„æ˜¯â€œåœ¨å®Œæˆä¸€ç»„æ­£åœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œä¹‹å‰ï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…â€ã€‚åœ¨APIä¸­æ˜¯è¿™æ ·æè¿°çš„ï¼š

> ç”¨ç»™å®šçš„è®¡æ•°åˆå§‹åŒ– CountDownLatchã€‚ç”±äºè°ƒç”¨äº† `#countDown()` æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨å½“å‰è®¡æ•°åˆ°è¾¾é›¶ä¹‹å‰ï¼Œ`#await()` æ–¹æ³•ä¼šä¸€ç›´å—é˜»å¡ã€‚ä¹‹åï¼Œä¼šé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œ`#await()` çš„æ‰€æœ‰åç»­è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ã€‚è¿™ç§ç°è±¡åªå‡ºç°ä¸€æ¬¡â€”â€”è®¡æ•°æ— æ³•è¢«é‡ç½®ã€‚å¦‚æœéœ€è¦é‡ç½®è®¡æ•°ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ CyclicBarrier ã€‚

![2017021200001](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120818001.png)

CountDownLatch æ˜¯é€šè¿‡ä¸€ä¸ªè®¡æ•°å™¨æ¥å®ç°çš„ï¼Œå½“æˆ‘ä»¬åœ¨ `new` ä¸€ä¸ª CountDownLatch å¯¹è±¡çš„æ—¶å€™ï¼Œéœ€è¦å¸¦å…¥è¯¥è®¡æ•°å™¨å€¼ï¼Œè¯¥å€¼å°±è¡¨ç¤ºäº†çº¿ç¨‹çš„æ•°é‡ã€‚

* æ¯å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆè‡ªå·±çš„ä»»åŠ¡åï¼Œè®¡æ•°å™¨çš„å€¼å°±ä¼šå‡ 1 ã€‚
* å½“è®¡æ•°å™¨çš„å€¼å˜ä¸º0æ—¶ï¼Œå°±è¡¨ç¤ºæ‰€æœ‰çš„çº¿ç¨‹å‡å·²ç»å®Œæˆäº†ä»»åŠ¡ï¼Œç„¶åå°±å¯ä»¥æ¢å¤ç­‰å¾…çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œäº†ã€‚

è™½ç„¶ï¼ŒCountDownLatch ä¸ CyclicBarrier æœ‰é‚£ä¹ˆç‚¹ç›¸ä¼¼ï¼Œä½†æ˜¯ä»–ä»¬è¿˜æ˜¯å­˜åœ¨ä¸€äº›**åŒºåˆ«**çš„ï¼š

1. CountDownLatch çš„ä½œç”¨æ˜¯å…è®¸ 1 æˆ– N ä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ‰§è¡Œï¼›è€Œ CyclicBarrier åˆ™æ˜¯å…è®¸ N ä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…ã€‚
2. CountDownLatch çš„è®¡æ•°å™¨æ— æ³•è¢«é‡ç½®ï¼›CyclicBarrier çš„è®¡æ•°å™¨å¯ä»¥è¢«é‡ç½®åä½¿ç”¨ï¼Œå› æ­¤å®ƒè¢«ç§°ä¸ºæ˜¯å¾ªç¯çš„ barrier ã€‚

# 2. å®ç°åˆ†æ

`java.util.concurrent.CountDownLatch` ç»“æ„å¦‚ä¸‹å›¾ï¼š

![CountDownLatch ç»“æ„](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120818002.png)

é€šè¿‡ä¸Šé¢çš„ç»“æ„å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒCountDownLatch å†…éƒ¨ä¾èµ– Sync å®ç°ï¼Œè€Œ Sync ç»§æ‰¿ AQS ã€‚

CountDownLatch ä»…æä¾›äº†ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
public CountDownLatch(int count) {
    if (count < 0) throw new IllegalArgumentException("count < 0");
    this.sync = new Sync(count);
}
```

* æ„é€ ä¸€ä¸ªç”¨ç»™å®šè®¡æ•°åˆå§‹åŒ–çš„ CountDownLatch ã€‚


## 2.1 Sync

`sync` å˜é‡ï¼Œä¸º CountDownLatch çš„ä¸€ä¸ªå†…éƒ¨ç±» Sync ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```Java
 private static final class Sync extends AbstractQueuedSynchronizer {
        
        private static final long serialVersionUID = 4982264981922014374L;

        Sync(int count) {
            setState(count);
        }

        // è·å–åŒæ­¥çŠ¶æ€
        int getCount() {
            return getState();
        }

        // è·å–åŒæ­¥çŠ¶æ€
        @Override
        protected int tryAcquireShared(int acquires) {
            return (getState() == 0) ? 1 : -1;
        }

        // é‡Šæ”¾åŒæ­¥çŠ¶æ€
        @Override
        protected boolean tryReleaseShared(int releases) {
            for (;;) {
                int c = getState();
                if (c == 0)
                    return false;
                int nextc = c-1;
                if (compareAndSetState(c, nextc))
                    return nextc == 0;
            }
        }
    }
    
}
```

* é€šè¿‡è¿™ä¸ªå†…éƒ¨ç±» Sync å®ç°ç±»ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œ CountDownLatch æ˜¯é‡‡ç”¨**å…±äº«é”**æ¥å®ç°çš„ã€‚
* `#tryAcquireShared(int acquires)` å’Œ `#tryReleaseShared(int releases)` æ–¹æ³•ï¼Œç»“åˆä¸‹æ–‡ä¸€èµ·ç†è§£ã€‚

## 2.2 await

CountDownLatch æä¾› `#await()` æ–¹æ³•ï¼Œæ¥ä½¿å½“å‰çº¿ç¨‹åœ¨é”å­˜å™¨å€’è®¡æ•°è‡³é›¶ä¹‹å‰ä¸€ç›´ç­‰å¾…ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```Java
public void await() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}
```

* è¯¥æ–¹æ³•å†…éƒ¨ä½¿ç”¨ AQS çš„ `#acquireSharedInterruptibly(int arg)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // AQS.java
    public final void acquireSharedInterruptibly(int arg)
            throws InterruptedException {
        if (Thread.interrupted())
            throw new InterruptedException();
        if (tryAcquireShared(arg) < 0)
            doAcquireSharedInterruptibly(arg);
    }
    ```

    * åœ¨å†…éƒ¨ç±» Sync ä¸­é‡å†™äº† `#tryAcquireShared(int arg)`æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

        ```Java
        // Sync.java
        @Override
        protected int tryAcquireShared(int acquires) {
            return (getState() == 0) ? 1 : -1;
        }
        ```

        * `getState()` æ–¹æ³•ï¼Œè·å–åŒæ­¥çŠ¶æ€ï¼Œå…¶å€¼ç­‰äºè®¡æ•°å™¨çš„å€¼ã€‚ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœè®¡æ•°å™¨å€¼**ä¸ç­‰äº** 0ï¼Œåˆ™ä¼šè°ƒç”¨ `#doAcquireSharedInterruptibly(int arg)` æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸ºä¸€ä¸ªè‡ªæ—‹æ–¹æ³•ä¼šå°è¯•ä¸€ç›´å»è·å–åŒæ­¥çŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ï¼š

            ```Java
            // AQS.java
            private void doAcquireSharedInterruptibly(int arg)
                    throws InterruptedException {
                final Node node = addWaiter(Node.SHARED);
                boolean failed = true;
                try {
                    for (;;) {
                        final Node p = node.predecessor();
                        if (p == head) {
                            /**
                             * å¯¹äºCountDownLatchè€Œè¨€ï¼Œå¦‚æœè®¡æ•°å™¨å€¼ä¸ç­‰äº0ï¼Œé‚£ä¹ˆr ä¼šä¸€ç›´å°äº0
                             */
                            int r = tryAcquireShared(arg);
                            if (r >= 0) {
                                setHeadAndPropagate(node, r);
                                p.next = null; // help GC
                                failed = false;
                                return;
                            }
                        }
                        //ç­‰å¾…
                        if (shouldParkAfterFailedAcquire(p, node) &&
                                parkAndCheckInterrupt())
                            throw new InterruptedException();
                    }
                } finally {
                    if (failed)
                        cancelAcquire(node);
                }
            }
            ```
            * x

## 2.3 await

CountDownLatch æä¾› `#await(long timeout, TimeUnit unit)` æ–¹æ³•ï¼Œæ¥ä½¿å½“å‰çº¿ç¨‹åœ¨é”å­˜å™¨å€’è®¡æ•°è‡³é›¶ä¹‹å‰ä¸€ç›´ç­‰å¾…ï¼Œé™¤éçº¿ç¨‹è¢«ä¸­æ–­ï¼Œ**æˆ–è€…ç­‰å¾…è¶…æ—¶**ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```Java
public boolean await(long timeout, TimeUnit unit)
    throws InterruptedException {
    return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout));
}
```

* è°ƒç”¨ AQS çš„ `tryAcquireSharedNanos(int acquires, long nanosTimeout)` æ–¹æ³•ï¼Œé€»è¾‘å’Œ [ã€Œ2.2 awaitã€](#) ç±»ä¼¼ã€‚

## 2.4 countDown

CountDownLatch æä¾› `#countDown()` æ–¹æ³•ï¼Œé€’å‡é”å­˜å™¨çš„è®¡æ•°ã€‚å¦‚æœè®¡æ•°åˆ°è¾¾é›¶ï¼Œåˆ™å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚

```Java
public void countDown() {
    sync.releaseShared(1);
}
```

* å†…éƒ¨è°ƒç”¨ AQS çš„ `#releaseShared(int arg)` æ–¹æ³•ï¼Œæ¥é‡Šæ”¾å…±äº«é”åŒæ­¥çŠ¶æ€ï¼š

    ```Java
    // AQS.java
    public final boolean releaseShared(int arg) {
        if (tryReleaseShared(arg)) {
            doReleaseShared();
            return true;
        }
        return false;
    }
    ```

    * `#tryReleaseShared(int arg)` æ–¹æ³•ï¼Œè¢« CountDownLatch çš„å†…éƒ¨ç±» Sync é‡å†™ï¼Œä»£ç å¦‚ä¸‹ï¼š

        ```Java
        // Sync.java
        @Overrride
        protected boolean tryReleaseShared(int releases) {
            for (;;) {
                //è·å–é”çŠ¶æ€
                int c = getState();
                //c == 0 ç›´æ¥è¿”å›ï¼Œé‡Šæ”¾é”æˆåŠŸ
                if (c == 0)
                    return false;
                //è®¡ç®—æ–°â€œé”è®¡æ•°å™¨â€
                int nextc = c-1;
                //æ›´æ–°é”çŠ¶æ€ï¼ˆè®¡æ•°å™¨ï¼‰
                if (compareAndSetState(c, nextc))
                    return nextc == 0;
            }
        }
        ```
        * x

## 2.5 getCount

```Java
public long getCount() {
    return sync.getCount();
}
```

# 3. æ€»ç»“

CountDownLatch **å†…éƒ¨é€šè¿‡å…±äº«é”å®ç°**ã€‚

* åœ¨åˆ›å»º CountDownLatch å®ä¾‹æ—¶ï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ªintå‹çš„å‚æ•°ï¼š`count`ï¼Œè¯¥å‚æ•°ä¸ºè®¡æ•°å™¨çš„åˆå§‹å€¼ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºè¯¥å…±äº«é”å¯ä»¥è·å–çš„æ€»æ¬¡æ•°ã€‚
* å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ `#await()` æ–¹æ³•ï¼Œç¨‹åºé¦–å…ˆåˆ¤æ–­ `count` çš„å€¼æ˜¯å¦ä¸º 0 ï¼Œå¦‚æœä¸ä¸º 0 çš„è¯ï¼Œåˆ™ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°ä¸º 0 ä¸ºæ­¢ã€‚
* å½“å…¶ä»–çº¿ç¨‹è°ƒç”¨ `#countDown()` æ–¹æ³•æ—¶ï¼Œåˆ™æ‰§è¡Œé‡Šæ”¾å…±äº«é”çŠ¶æ€ï¼Œä½¿ `count` å€¼ - 1ã€‚
* å½“åœ¨åˆ›å»º CountDownLatch æ—¶åˆå§‹åŒ–çš„ `count` å‚æ•°ï¼Œå¿…é¡»è¦æœ‰ `count` çº¿ç¨‹è°ƒç”¨`#countDown()` æ–¹æ³•ï¼Œæ‰ä¼šä½¿è®¡æ•°å™¨ `count` ç­‰äº 0 ï¼Œé”æ‰ä¼šé‡Šæ”¾ï¼Œå‰é¢ç­‰å¾…çš„çº¿ç¨‹æ‰ä¼šç»§ç»­è¿è¡Œã€‚
* æ³¨æ„ CountDownLatch **ä¸èƒ½å›æ»šé‡ç½®**ã€‚

# 4. åº”ç”¨ç¤ºä¾‹

ç¤ºä¾‹ä»ç„¶ä½¿ç”¨å¼€ä¼šæ¡ˆä¾‹ã€‚è€æ¿è¿›å…¥ä¼šè®®å®¤ç­‰å¾… 5 ä¸ªäººå…¨éƒ¨åˆ°è¾¾ä¼šè®®å®¤æ‰ä¼šå¼€ä¼šã€‚æ‰€ä»¥è¿™é‡Œæœ‰ä¸¤ç§çº¿ç¨‹ï¼šè€æ¿ç­‰å¾…å¼€ä¼šçº¿ç¨‹ã€å‘˜å·¥åˆ°è¾¾ä¼šè®®å®¤çº¿ç¨‹ï¼š

```Java
public class CountDownLatchTest {

    private static CountDownLatch countDownLatch = new CountDownLatch(5);

    /**
     * Bossçº¿ç¨‹ï¼Œç­‰å¾…å‘˜å·¥åˆ°è¾¾å¼€ä¼š
     */
    static class BossThread extends Thread{
        @Override
        public void run() {
            System.out.println("Bossåœ¨ä¼šè®®å®¤ç­‰å¾…ï¼Œæ€»å…±æœ‰" + countDownLatch.getCount() + "ä¸ªäººå¼€ä¼š...");
            try {
                //Bossç­‰å¾…
                countDownLatch.await();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            System.out.println("æ‰€æœ‰äººéƒ½å·²ç»åˆ°é½äº†ï¼Œå¼€ä¼šå§...");
        }
    }

    // å‘˜å·¥åˆ°è¾¾ä¼šè®®å®¤çº¿ç¨‹
    static class EmpleoyeeThread  extends Thread{
        @Override
        public void run() {
            System.out.println(Thread.currentThread().getName() + "ï¼Œåˆ°è¾¾ä¼šè®®å®¤....");
            //å‘˜å·¥åˆ°è¾¾ä¼šè®®å®¤ count - 1
            countDownLatch.countDown();
        }
    }

    public static void main(String[] args){
        //Bossçº¿ç¨‹å¯åŠ¨
        new BossThread().start();

        for(int i = 0 ; i < countDownLatch.getCount() ; i++){
            new EmpleoyeeThread().start();
        }
    }
}
```

è¿è¡Œç»“æœï¼š

[![2017021200002](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120818003.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120818003.png)

# å‚è€ƒèµ„æ–™

1. æ–¹è…¾é£ï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ [ã€Œ8.1 ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆçš„ CountDownLatchã€](#) ç« èŠ‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

