title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹çº¿ç¨‹æ± ï¼šThreadPoolExecutor
date: 2018-06-18
tag: 
categories: JUC
permalink: JUC/sike/ThreadPoolExecutor
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2448
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2448 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [å†…éƒ¨çŠ¶æ€](http://www.iocoder.cn/JUC/sike/ThreadPoolExecutor/)
  - [åˆ›å»ºçº¿ç¨‹æ± ](http://www.iocoder.cn/JUC/sike/ThreadPoolExecutor/)
  - [çº¿ç¨‹æ± ](http://www.iocoder.cn/JUC/sike/ThreadPoolExecutor/)
  - [ä»»åŠ¡æäº¤](http://www.iocoder.cn/JUC/sike/ThreadPoolExecutor/)
  - [çº¿ç¨‹ç»ˆæ­¢](http://www.iocoder.cn/JUC/sike/ThreadPoolExecutor/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä½œä¸ºExecutoræ¡†æ¶ä¸­æœ€æ ¸å¿ƒçš„ç±»ï¼ŒThreadPoolExecutorä»£è¡¨ç€é¼é¼å¤§åçš„çº¿ç¨‹æ± ï¼Œå®ƒç»™äº†æˆ‘ä»¬è¶³å¤Ÿçš„ç†ç”±æ¥å¼„æ¸…æ¥šå®ƒã€‚

ä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡æºç æ¥ä¸€æ­¥ä¸€æ­¥å¼„æ¸…æ¥šå®ƒã€‚

## å†…éƒ¨çŠ¶æ€

çº¿ç¨‹æœ‰äº”ç§çŠ¶æ€ï¼šæ–°å»ºï¼Œå°±ç»ªï¼Œè¿è¡Œï¼Œé˜»å¡ï¼Œæ­»äº¡ï¼Œçº¿ç¨‹æ± åŒæ ·æœ‰äº”ç§çŠ¶æ€ï¼šRunning, SHUTDOWN, STOP, TIDYING, TERMINATEDã€‚

```Java
    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
    private static final int COUNT_BITS = Integer.SIZE - 3;
    private static final int CAPACITY   = (1 << COUNT_BITS) - 1;

    // runState is stored in the high-order bits
    private static final int RUNNING    = -1 << COUNT_BITS;
    private static final int SHUTDOWN   =  0 << COUNT_BITS;
    private static final int STOP       =  1 << COUNT_BITS;
    private static final int TIDYING    =  2 << COUNT_BITS;
    private static final int TERMINATED =  3 << COUNT_BITS;

    // Packing and unpacking ctl
    private static int runStateOf(int c)     { return c & ~CAPACITY; }
    private static int workerCountOf(int c)  { return c & CAPACITY; }
    private static int ctlOf(int rs, int wc) { return rs | wc; }
```

å˜é‡**ctl**å®šä¹‰ä¸ºAtomicInteger ï¼Œå…¶åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œè®°å½•äº†â€œçº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ•°é‡â€å’Œâ€œçº¿ç¨‹æ± çš„çŠ¶æ€â€ä¸¤ä¸ªä¿¡æ¯ã€‚å…±32ä½ï¼Œå…¶ä¸­é«˜3ä½è¡¨ç¤º"çº¿ç¨‹æ± çŠ¶æ€"ï¼Œä½29ä½è¡¨ç¤º"çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ•°é‡"ã€‚

```Java
RUNNING            -- å¯¹åº”çš„é«˜3ä½å€¼æ˜¯111ã€‚
SHUTDOWN       -- å¯¹åº”çš„é«˜3ä½å€¼æ˜¯000ã€‚
STOP                   -- å¯¹åº”çš„é«˜3ä½å€¼æ˜¯001ã€‚
TIDYING              -- å¯¹åº”çš„é«˜3ä½å€¼æ˜¯010ã€‚
TERMINATED     -- å¯¹åº”çš„é«˜3ä½å€¼æ˜¯011ã€‚
```

**RUNNING**ï¼šå¤„äºRUNNINGçŠ¶æ€çš„çº¿ç¨‹æ± èƒ½å¤Ÿæ¥å—æ–°ä»»åŠ¡ï¼Œä»¥åŠå¯¹æ–°æ·»åŠ çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚

**SHUTDOWN**ï¼šå¤„äºSHUTDOWNçŠ¶æ€çš„çº¿ç¨‹æ± ä¸å¯ä»¥æ¥å—æ–°ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥å¯¹å·²æ·»åŠ çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚

**STOP**ï¼šå¤„äºSTOPçŠ¶æ€çš„çº¿ç¨‹æ± ä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚

**TIDYING**ï¼šå½“æ‰€æœ‰çš„ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œctlè®°å½•çš„"ä»»åŠ¡æ•°é‡"ä¸º0ï¼Œçº¿ç¨‹æ± ä¼šå˜ä¸ºTIDYINGçŠ¶æ€ã€‚å½“çº¿ç¨‹æ± å˜ä¸ºTIDYINGçŠ¶æ€æ—¶ï¼Œä¼šæ‰§è¡Œé’©å­å‡½æ•°terminated()ã€‚terminated()åœ¨ThreadPoolExecutorç±»ä¸­æ˜¯ç©ºçš„ï¼Œè‹¥ç”¨æˆ·æƒ³åœ¨çº¿ç¨‹æ± å˜ä¸ºTIDYINGæ—¶ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼›å¯ä»¥é€šè¿‡é‡è½½terminated()å‡½æ•°æ¥å®ç°ã€‚

**TERMINATED**ï¼šçº¿ç¨‹æ± å½»åº•ç»ˆæ­¢çš„çŠ¶æ€ã€‚

å„ä¸ªçŠ¶æ€çš„è½¬æ¢å¦‚ä¸‹ï¼š

![çº¿ç¨‹æ± çŠ¶æ€è½¬æ¢](http://static.iocoder.cn/csdn/20171007215630217?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hlbnNzeQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

## åˆ›å»ºçº¿ç¨‹æ± 

æˆ‘ä»¬å¯ä»¥é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼š

```Java
    public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue<Runnable> workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler) {
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```

å…±æœ‰ä¸ƒä¸ªå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š

**corePoolSize**

çº¿ç¨‹æ± ä¸­æ ¸å¿ƒçº¿ç¨‹çš„æ•°é‡ã€‚å½“æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹æ•°ç­‰äºcorePoolSizeã€‚å¦‚æœè°ƒç”¨äº†çº¿ç¨‹æ± çš„prestartAllCoreThreads()æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰åŸºæœ¬çº¿ç¨‹ã€‚

**maximumPoolSize**

çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œå¦‚æœè¿˜æœ‰ä»»åŠ¡æäº¤ï¼Œå¦‚æœå½“å‰çš„çº¿ç¨‹æ•°å°äºmaximumPoolSizeï¼Œåˆ™ä¼šæ–°å»ºçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œè¯¥å‚æ•°ä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆæ•ˆæœäº†ã€‚

**keepAliveTime**

çº¿ç¨‹ç©ºé—²çš„æ—¶é—´ã€‚çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æ˜¯éœ€è¦ä»£ä»·çš„ã€‚çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ç»§ç»­å­˜æ´»ä¸€æ®µæ—¶é—´ï¼škeepAliveTimeã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‚æ•°åªæœ‰åœ¨çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶æ‰ä¼šç”Ÿæ•ˆã€‚

**unit**

keepAliveTimeçš„å•ä½ã€‚TimeUnit

**workQueue**

ç”¨æ¥ä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…çš„ä»»åŠ¡å¿…é¡»å®ç°Runnableæ¥å£ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©å¦‚ä¸‹å‡ ç§ï¼š

- ArrayBlockingQueueï¼šåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒFIFOã€‚[ã€æ­»ç£•Javaå¹¶å‘ã€‘----J.U.Cä¹‹é˜»å¡é˜Ÿåˆ—ï¼šArrayBlockingQueue](http://cmsblogs.com/?p=2381)
- LinkedBlockingQueueï¼šåŸºäºé“¾è¡¨ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒFIFOã€‚
- SynchronousQueueï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œéƒ½å¿…é¡»ç­‰å¾…ä¸€ä¸ªç§»å‡ºæ“ä½œï¼Œåä¹‹äº¦ç„¶ã€‚[ã€æ­»ç£•Javaå¹¶å‘ã€‘----J.U.Cä¹‹é˜»å¡é˜Ÿåˆ—ï¼šSynchronousQueue](http://cmsblogs.com/?p=2418)
- PriorityBlockingQueueï¼šå…·æœ‰ä¼˜å…ˆç•Œåˆ«çš„é˜»å¡é˜Ÿåˆ—ã€‚[ã€æ­»ç£•Javaå¹¶å‘ã€‘----J.U.Cä¹‹é˜»å¡é˜Ÿåˆ—ï¼šPriorityBlockingQueue](http://cmsblogs.com/?p=2407)

**threadFactory**

ç”¨äºè®¾ç½®åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ã€‚è¯¥å¯¹è±¡å¯ä»¥é€šè¿‡Executors.defaultThreadFactory()ï¼Œå¦‚ä¸‹ï¼š

```Java
    public static ThreadFactory defaultThreadFactory() {
        return new DefaultThreadFactory();
    }
```

è¿”å›çš„æ˜¯DefaultThreadFactoryå¯¹è±¡ï¼Œæºç å¦‚ä¸‹ï¼š

```Java
    static class DefaultThreadFactory implements ThreadFactory {
        private static final AtomicInteger poolNumber = new AtomicInteger(1);
        private final ThreadGroup group;
        private final AtomicInteger threadNumber = new AtomicInteger(1);
        private final String namePrefix;

        DefaultThreadFactory() {
            SecurityManager s = System.getSecurityManager();
            group = (s != null) ? s.getThreadGroup() :
                                  Thread.currentThread().getThreadGroup();
            namePrefix = "pool-" +
                          poolNumber.getAndIncrement() +
                         "-thread-";
        }

        public Thread newThread(Runnable r) {
            Thread t = new Thread(group, r,
                                  namePrefix + threadNumber.getAndIncrement(),
                                  0);
            if (t.isDaemon())
                t.setDaemon(false);
            if (t.getPriority() != Thread.NORM_PRIORITY)
                t.setPriority(Thread.NORM_PRIORITY);
            return t;
        }
    }
```

ThreadFactoryçš„å·¦å³å°±æ˜¯æä¾›åˆ›å»ºçº¿ç¨‹çš„åŠŸèƒ½çš„çº¿ç¨‹å·¥å‚ã€‚ä»–æ˜¯é€šè¿‡newThread()æ–¹æ³•æä¾›åˆ›å»ºçº¿ç¨‹çš„åŠŸèƒ½ï¼ŒnewThread()æ–¹æ³•åˆ›å»ºçš„çº¿ç¨‹éƒ½æ˜¯â€œéå®ˆæŠ¤çº¿ç¨‹â€è€Œä¸”â€œçº¿ç¨‹ä¼˜å…ˆçº§éƒ½æ˜¯Thread.NORM_PRIORITYâ€ã€‚

**handler**

RejectedExecutionHandlerï¼Œçº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥ã€‚æ‰€è°“æ‹’ç»ç­–ç•¥ï¼Œæ˜¯æŒ‡å°†ä»»åŠ¡æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­æ—¶ï¼Œçº¿ç¨‹æ± æ‹’ç»è¯¥ä»»åŠ¡æ‰€é‡‡å–çš„ç›¸åº”ç­–ç•¥ã€‚å½“å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡æ—¶ï¼Œå¦‚æœæ­¤æ—¶çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å·²ç»é¥±å’Œäº†ï¼Œè€Œä¸”é˜»å¡é˜Ÿåˆ—ä¹Ÿå·²ç»æ»¡äº†ï¼Œåˆ™çº¿ç¨‹æ± ä¼šé€‰æ‹©ä¸€ç§æ‹’ç»ç­–ç•¥æ¥å¤„ç†è¯¥ä»»åŠ¡ã€‚

çº¿ç¨‹æ± æä¾›äº†å››ç§æ‹’ç»ç­–ç•¥ï¼š

1. AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼›
2. CallerRunsPolicyï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›
3. DiscardOldestPolicyï¼šä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼›
4. DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼›
   å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„æ‹’ç»ç­–ç•¥ï¼Œä¾‹å¦‚è®°å½•æ—¥å¿—ç­‰ç­‰ï¼Œå®ç°RejectedExecutionHandleræ¥å£å³å¯ã€‚

## çº¿ç¨‹æ± 

Executoræ¡†æ¶æä¾›äº†ä¸‰ç§çº¿ç¨‹æ± ï¼Œä»–ä»¬éƒ½å¯ä»¥é€šè¿‡å·¥å…·ç±»Executorsæ¥åˆ›å»ºã€‚

**FixedThreadPool**

FixedThreadPoolï¼Œå¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```Java
    public static ExecutorService newFixedThreadPool(int nThreads) {
        return new ThreadPoolExecutor(nThreads, nThreads,
                                      0L, TimeUnit.MILLISECONDS,
                                      new LinkedBlockingQueue<Runnable>());
    }
```

corePoolSize å’Œ maximumPoolSizeéƒ½è®¾ç½®ä¸ºåˆ›å»ºFixedThreadPoolæ—¶æŒ‡å®šçš„å‚æ•°nThreadsï¼Œæ„å‘³ç€å½“çº¿ç¨‹æ± æ»¡æ—¶ä¸”é˜»å¡é˜Ÿåˆ—ä¹Ÿå·²ç»æ»¡æ—¶ï¼Œå¦‚æœç»§ç»­æäº¤ä»»åŠ¡ï¼Œåˆ™ä¼šç›´æ¥èµ°æ‹’ç»ç­–ç•¥ï¼Œè¯¥çº¿ç¨‹æ± ä¸ä¼šå†æ–°å»ºçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç›´æ¥èµ°æ‹’ç»ç­–ç•¥ã€‚FixedThreadPoolä½¿ç”¨çš„æ˜¯é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼Œå³AbortPolicyï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚

keepAliveTimeè®¾ç½®ä¸º0Lï¼Œè¡¨ç¤ºç©ºé—²çš„çº¿ç¨‹ä¼šç«‹åˆ»ç»ˆæ­¢ã€‚

workQueueåˆ™æ˜¯ä½¿ç”¨LinkedBlockingQueueï¼Œä½†æ˜¯æ²¡æœ‰è®¾ç½®èŒƒå›´ï¼Œé‚£ä¹ˆåˆ™æ˜¯æœ€å¤§å€¼ï¼ˆInteger.MAX_VALUEï¼‰ï¼Œè¿™åŸºæœ¬å°±ç›¸å½“äºä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—äº†ã€‚ä½¿ç”¨è¯¥â€œæ— ç•Œé˜Ÿåˆ—â€åˆ™ä¼šå¸¦æ¥å“ªäº›å½±å“å‘¢ï¼Ÿå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ç­‰äºcorePoolSize æ—¶ï¼Œå¦‚æœç»§ç»­æäº¤ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ä¼šè¢«æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—workQueueä¸­ï¼Œå½“é˜»å¡é˜Ÿåˆ—ä¹Ÿæ»¡äº†ä¹‹åï¼Œåˆ™çº¿ç¨‹æ± ä¼šæ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ç›´åˆ°maximumPoolSizeã€‚ç”±äºFixedThreadPoolä½¿ç”¨çš„æ˜¯â€œæ— ç•Œé˜Ÿåˆ—â€LinkedBlockingQueueï¼Œé‚£ä¹ˆmaximumPoolSizeå‚æ•°æ— æ•ˆï¼ŒåŒæ—¶æŒ‡å®šçš„æ‹’ç»ç­–ç•¥AbortPolicyä¹Ÿå°†æ— æ•ˆã€‚è€Œä¸”è¯¥çº¿ç¨‹æ± ä¹Ÿä¸ä¼šæ‹’ç»æäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœå®¢æˆ·ç«¯æäº¤ä»»åŠ¡çš„é€Ÿåº¦å¿«äºä»»åŠ¡çš„æ‰§è¡Œï¼Œé‚£ä¹ˆkeepAliveTimeä¹Ÿæ˜¯ä¸€ä¸ªæ— æ•ˆå‚æ•°ã€‚

å…¶è¿è¡Œå›¾å¦‚ä¸‹ï¼ˆå‚è€ƒã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ï¼‰ï¼š

![FixedThreadPool](http://static.iocoder.cn/csdn/20171007215932303?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hlbnNzeQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)**SingleThreadExecutor**

SingleThreadExecutoræ˜¯ä½¿ç”¨å•ä¸ªworkerçº¿ç¨‹çš„Executorï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```Java
    public static ExecutorService newSingleThreadExecutor() {
        return new FinalizableDelegatedExecutorService
            (new ThreadPoolExecutor(1, 1,
                                    0L, TimeUnit.MILLISECONDS,
                                    new LinkedBlockingQueue<Runnable>()));
    }
```

ä½œä¸ºå•ä¸€workerçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼ŒSingleThreadExecutoræŠŠcorePoolå’ŒmaximumPoolSizeå‡è¢«è®¾ç½®ä¸º1ï¼Œå’ŒFixedThreadPoolä¸€æ ·ä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueue,æ‰€ä»¥å¸¦æ¥çš„å½±å“å’ŒFixedThreadPoolä¸€æ ·ã€‚

![SingleThreadExecutor](http://static.iocoder.cn/csdn/20171007220046613?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hlbnNzeQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)**CachedThreadPool**

CachedThreadPoolæ˜¯ä¸€ä¸ªä¼šæ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ±  ï¼Œä»–å®šä¹‰å¦‚ä¸‹ï¼š

```Java
    public static ExecutorService newCachedThreadPool() {
        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                      60L, TimeUnit.SECONDS,
                                      new SynchronousQueue<Runnable>());
    }
```

CachedThreadPoolçš„corePoolä¸º0ï¼ŒmaximumPoolSizeä¸ºInteger.MAX_VALUEï¼Œè¿™å°±æ„å‘³ç€æ‰€æœ‰çš„ä»»åŠ¡ä¸€æäº¤å°±ä¼šåŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‚keepAliveTimeè¿™æ˜¯ä¸º60Lï¼Œunitè®¾ç½®ä¸ºTimeUnit.SECONDSï¼Œæ„å‘³ç€ç©ºé—²çº¿ç¨‹ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€é•¿æ—¶é—´ä¸º60ç§’ï¼Œç©ºé—²çº¿ç¨‹è¶…è¿‡60ç§’åå°†ä¼šè¢«ç»ˆæ­¢ã€‚é˜»å¡é˜Ÿåˆ—é‡‡ç”¨çš„SynchronousQueueï¼Œè€Œæˆ‘ä»¬åœ¨[ã€æ­»ç£•Javaå¹¶å‘ã€‘----J.U.Cä¹‹é˜»å¡é˜Ÿåˆ—ï¼šSynchronousQueue](http://cmsblogs.com/?p=2418)ä¸­äº†è§£åˆ°SynchronousQueueæ˜¯ä¸€ä¸ªæ²¡æœ‰å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼ŒåŠ ä¸ŠcorePool = 0 ï¼ŒmaximumPoolSize = Integer.MAX_VALUEï¼Œè¿™æ ·å°±ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸»çº¿ç¨‹æäº¤ä»»åŠ¡çš„é€Ÿåº¦è¿œè¿œå¤§äºCachedThreadPoolçš„å¤„ç†é€Ÿåº¦ï¼Œåˆ™CachedThreadPoolä¼šä¸æ–­åœ°åˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œè¿™æ ·æœ‰å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿè€—å°½CPUå’Œå†…å­˜èµ„æºï¼Œæ‰€ä»¥åœ¨**ä½¿ç”¨è¯¥çº¿ç¨‹æ± æ˜¯ï¼Œä¸€å®šè¦æ³¨æ„æ§åˆ¶å¹¶å‘çš„ä»»åŠ¡æ•°ï¼Œå¦åˆ™åˆ›å»ºå¤§é‡çš„çº¿ç¨‹å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜**ã€‚

![CachedThreadPool](http://static.iocoder.cn/csdn/20171007220114901?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hlbnNzeQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

## ä»»åŠ¡æäº¤

çº¿ç¨‹æ± æ ¹æ®ä¸šåŠ¡ä¸åŒçš„éœ€æ±‚æä¾›äº†ä¸¤ç§æ–¹å¼æäº¤ä»»åŠ¡ï¼šExecutor.execute()ã€ExecutorService.submit()ã€‚å…¶ä¸­ExecutorService.submit()å¯ä»¥è·å–è¯¥ä»»åŠ¡æ‰§è¡Œçš„Futureã€‚
æˆ‘ä»¬ä»¥Executor.execute()ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹çº¿ç¨‹æ± çš„ä»»åŠ¡æäº¤ç»å†äº†é‚£äº›è¿‡ç¨‹ã€‚

å®šä¹‰ï¼š

```Java
public interface Executor {

    void execute(Runnable command);
}
```

ThreadPoolExecutoræä¾›å®ç°ï¼š

```Java
    public void execute(Runnable command) {
        if (command == null)
            throw new NullPointerException();
        int c = ctl.get();
        if (workerCountOf(c) < corePoolSize) {
            if (addWorker(command, true))
                return;
            c = ctl.get();
        }
        if (isRunning(c) && workQueue.offer(command)) {
            int recheck = ctl.get();
            if (! isRunning(recheck) && remove(command))
                reject(command);
            else if (workerCountOf(recheck) == 0)
                addWorker(null, false);
        }
        else if (!addWorker(command, false))
            reject(command);
    }
```

æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. å¦‚æœçº¿ç¨‹æ± å½“å‰çº¿ç¨‹æ•°å°äºcorePoolSizeï¼Œåˆ™è°ƒç”¨addWorkeråˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥æ‰§è¡Œæ­¥éª¤2ã€‚
2. å¦‚æœçº¿ç¨‹æ± å¤„äºRUNNINGçŠ¶æ€ï¼Œåˆ™å°è¯•åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¦‚æœåŠ å…¥é˜»å¡é˜Ÿåˆ—æˆåŠŸï¼Œåˆ™å°è¯•è¿›è¡ŒDouble Checkï¼Œå¦‚æœåŠ å…¥å¤±è´¥ï¼Œåˆ™æ‰§è¡Œæ­¥éª¤3ã€‚
3. å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯RUNNINGçŠ¶æ€æˆ–è€…åŠ å…¥é˜»å¡é˜Ÿåˆ—å¤±è´¥ï¼Œåˆ™å°è¯•åˆ›å»ºæ–°çº¿ç¨‹ç›´åˆ°maxPoolSizeï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è°ƒç”¨reject()æ–¹æ³•è¿è¡Œç›¸åº”çš„æ‹’ç»ç­–ç•¥ã€‚

åœ¨æ­¥éª¤2ä¸­å¦‚æœåŠ å…¥é˜»å¡é˜Ÿåˆ—æˆåŠŸäº†ï¼Œåˆ™ä¼šè¿›è¡Œä¸€ä¸ªDouble Checkçš„è¿‡ç¨‹ã€‚Double Checkè¿‡ç¨‹çš„ä¸»è¦ç›®çš„æ˜¯åˆ¤æ–­åŠ å…¥åˆ°é˜»å¡é˜Ÿé‡Œä¸­çš„çº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«æ‰§è¡Œã€‚å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯RUNNINGçŠ¶æ€ï¼Œåˆ™è°ƒç”¨remove()æ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥ä»»åŠ¡ï¼Œç„¶åè°ƒç”¨reject()æ–¹æ³•å¤„ç†ä»»åŠ¡ã€‚å¦åˆ™éœ€è¦ç¡®ä¿è¿˜æœ‰çº¿ç¨‹æ‰§è¡Œã€‚

**addWorker**
å½“çº¿ç¨‹ä¸­çš„å½“å‰çº¿ç¨‹æ•°å°äºcorePoolSizeï¼Œåˆ™è°ƒç”¨addWorker()åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå½“å‰çº¿ç¨‹æ•°åˆ™æ˜¯æ ¹æ®**ctl**å˜é‡æ¥è·å–çš„ï¼Œè°ƒç”¨workerCountOf(ctl)è·å–ä½29ä½å³å¯ï¼š

```Java
    private static int workerCountOf(int c)  { return c & CAPACITY; }
```

addWorker(Runnable firstTask, boolean core)æ–¹æ³•ç”¨äºåˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œæºç å¦‚ä¸‹ï¼š

```Java
    private boolean addWorker(Runnable firstTask, boolean core) {
        retry:
        for (;;) {
            int c = ctl.get();

            // è·å–å½“å‰çº¿ç¨‹çŠ¶æ€
            int rs = runStateOf(c);


            if (rs >= SHUTDOWN &&
                    ! (rs == SHUTDOWN &&
                            firstTask == null &&
                            ! workQueue.isEmpty()))
                return false;

            // å†…å±‚å¾ªç¯ï¼Œworker + 1
            for (;;) {
                // çº¿ç¨‹æ•°é‡
                int wc = workerCountOf(c);
                // å¦‚æœå½“å‰çº¿ç¨‹æ•°å¤§äºçº¿ç¨‹æœ€å¤§ä¸Šé™CAPACITY  return false
                // è‹¥core == trueï¼Œåˆ™ä¸corePoolSize æ¯”è¾ƒï¼Œå¦åˆ™ä¸maximumPoolSize ï¼Œå¤§äº return false
                if (wc >= CAPACITY ||
                        wc >= (core ? corePoolSize : maximumPoolSize))
                    return false;
                // worker + 1,æˆåŠŸè·³å‡ºretryå¾ªç¯
                if (compareAndIncrementWorkerCount(c))
                    break retry;

                // CAS add worker å¤±è´¥ï¼Œå†æ¬¡è¯»å–ctl
                c = ctl.get();

                // å¦‚æœçŠ¶æ€ä¸ç­‰äºä¹‹å‰è·å–çš„stateï¼Œè·³å‡ºå†…å±‚å¾ªç¯ï¼Œç»§ç»­å»å¤–å±‚å¾ªç¯åˆ¤æ–­
                if (runStateOf(c) != rs)
                    continue retry;
            }
        }

        boolean workerStarted = false;
        boolean workerAdded = false;
        Worker w = null;
        try {

            // æ–°å»ºçº¿ç¨‹ï¼šWorker
            w = new Worker(firstTask);
            // å½“å‰çº¿ç¨‹
            final Thread t = w.thread;
            if (t != null) {
                // è·å–ä¸»é”ï¼šmainLock
                final ReentrantLock mainLock = this.mainLock;
                mainLock.lock();
                try {

                    // çº¿ç¨‹çŠ¶æ€
                    int rs = runStateOf(ctl.get());

                    // rs < SHUTDOWN ==> çº¿ç¨‹å¤„äºRUNNINGçŠ¶æ€
                    // æˆ–è€…çº¿ç¨‹å¤„äºSHUTDOWNçŠ¶æ€ï¼Œä¸”firstTask == nullï¼ˆå¯èƒ½æ˜¯workQueueä¸­ä»æœ‰æœªæ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ï¼Œåˆ›å»ºæ²¡æœ‰åˆå§‹ä»»åŠ¡çš„workerçº¿ç¨‹æ‰§è¡Œï¼‰
                    if (rs < SHUTDOWN ||
                            (rs == SHUTDOWN && firstTask == null)) {

                        // å½“å‰çº¿ç¨‹å·²ç»å¯åŠ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸
                        if (t.isAlive()) // precheck that t is startable
                            throw new IllegalThreadStateException();

                        // workersæ˜¯ä¸€ä¸ªHashSet<Worker>
                        workers.add(w);

                        // è®¾ç½®æœ€å¤§çš„æ± å¤§å°largestPoolSizeï¼ŒworkerAddedè®¾ç½®ä¸ºtrue
                        int s = workers.size();
                        if (s > largestPoolSize)
                            largestPoolSize = s;
                        workerAdded = true;
                    }
                } finally {
                    // é‡Šæ”¾é”
                    mainLock.unlock();
                }
                // å¯åŠ¨çº¿ç¨‹
                if (workerAdded) {
                    t.start();
                    workerStarted = true;
                }
            }
        } finally {

            // çº¿ç¨‹å¯åŠ¨å¤±è´¥
            if (! workerStarted)
                addWorkerFailed(w);
        }
        return workerStarted;
    }
```

1. åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å¯ä»¥æ·»åŠ ä»»åŠ¡ï¼Œå¦‚æœå¯ä»¥åˆ™è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå¦åˆ™return falseï¼›
   1. rs >= SHUTDOWN ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹å¤„äºSHUTDOWN ï¼ŒSTOPã€TIDYINGã€TERMINATEDçŠ¶æ€
   2. rs == SHUTDOWN , firstTask != nullæ—¶ä¸å…è®¸æ·»åŠ çº¿ç¨‹ï¼Œå› ä¸ºçº¿ç¨‹å¤„äºSHUTDOWN çŠ¶æ€ï¼Œä¸å…è®¸æ·»åŠ ä»»åŠ¡
   3. rs == SHUTDOWN , firstTask == nullï¼Œä½†workQueue.isEmpty() == trueï¼Œä¸å…è®¸æ·»åŠ çº¿ç¨‹ï¼Œå› ä¸ºfirstTask == nullæ˜¯ä¸ºäº†æ·»åŠ ä¸€ä¸ªæ²¡æœ‰ä»»åŠ¡çš„çº¿ç¨‹ç„¶åå†ä»workQueueä¸­è·å–ä»»åŠ¡çš„ï¼Œå¦‚æœworkQueue == nullï¼Œåˆ™è¯´æ˜æ·»åŠ çš„ä»»åŠ¡æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚
2. å†…åµŒå¾ªç¯ï¼Œé€šè¿‡CAS worker + 1
3. è·å–ä¸»é”mailLockï¼Œå¦‚æœçº¿ç¨‹æ± å¤„äºRUNNINGçŠ¶æ€è·å–å¤„äºSHUTDOWNçŠ¶æ€ä¸” firstTask == nullï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°workers Queueä¸­ï¼Œç„¶åé‡Šæ”¾ä¸»é”mainLockï¼Œç„¶åå¯åŠ¨çº¿ç¨‹ï¼Œç„¶åreturn trueï¼Œå¦‚æœä¸­é€”å¤±è´¥å¯¼è‡´workerStarted= falseï¼Œåˆ™è°ƒç”¨addWorkerFailed()æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

åœ¨è¿™é‡Œéœ€è¦å¥½å¥½ç†è®ºaddWorkerä¸­çš„å‚æ•°ï¼Œåœ¨execute()æ–¹æ³•ä¸­ï¼Œæœ‰ä¸‰å¤„è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼š
ç¬¬ä¸€æ¬¡ï¼šworkerCountOf(c) < corePoolSize ==> addWorker(command, true)ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå½“ç„¶çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡å°äº corePoolSize ï¼Œåˆ™æ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡å³å¯ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹core == trueï¼Œå†…éƒ¨ä¸corePoolSizeæ¯”è¾ƒå³å¯ã€‚
ç¬¬äºŒæ¬¡ï¼šåŠ å…¥é˜»å¡é˜Ÿåˆ—è¿›è¡ŒDouble Checkæ—¶ï¼Œelse if (workerCountOf(recheck) == 0) ==>addWorker(null, false)ã€‚å¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹==0ï¼ŒæŒ‰ç…§é“ç†åº”è¯¥è¯¥ä»»åŠ¡åº”è¯¥æ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯ç”±äºå·²ç»è¯¥ä»»åŠ¡å·²ç»æ·»åŠ åˆ°äº†é˜»å¡é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±åœ¨çº¿ç¨‹æ± ä¸­æ–°å»ºä¸€ä¸ªç©ºçº¿ç¨‹ï¼Œç„¶åä»é˜»å¡é˜Ÿåˆ—ä¸­å–çº¿ç¨‹å³å¯ã€‚
ç¬¬ä¸‰æ¬¡ï¼šçº¿ç¨‹æ± ä¸æ˜¯RUNNINGçŠ¶æ€æˆ–è€…åŠ å…¥é˜»å¡é˜Ÿåˆ—å¤±è´¥ï¼šelse if (!addWorker(command, false))ï¼Œè¿™é‡Œcore == faseï¼Œåˆ™æ„å‘³ç€æ˜¯ä¸maximumPoolSizeæ¯”è¾ƒã€‚

åœ¨æ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå°†è®²RunnableåŒ…è£…æˆä¸€ä¸ªWorkerï¼ŒWokerä¸ºThreadPoolExecutorçš„å†…éƒ¨ç±»

**Wokerå†…éƒ¨ç±»**

Wokerçš„æºç å¦‚ä¸‹ï¼š

```Java
    private final class Worker extends AbstractQueuedSynchronizer
            implements Runnable {
        private static final long serialVersionUID = 6138294804551838833L;

        // task çš„thread
        final Thread thread;

        // è¿è¡Œçš„ä»»åŠ¡task
        Runnable firstTask;

        volatile long completedTasks;

        Worker(Runnable firstTask) {

            //è®¾ç½®AQSçš„åŒæ­¥çŠ¶æ€private volatile int stateï¼Œæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¤§äº0ä»£è¡¨é”å·²ç»è¢«è·å–
            setState(-1);
            this.firstTask = firstTask;

            // åˆ©ç”¨ThreadFactoryå’Œ Workerè¿™ä¸ªRunnableåˆ›å»ºçš„çº¿ç¨‹å¯¹è±¡
            this.thread = getThreadFactory().newThread(this);
        }

        // ä»»åŠ¡æ‰§è¡Œ
        public void run() {
            runWorker(this);
        }

    }
```

ä»Workerçš„æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Wokerç»§æ‰¿AQSï¼Œå®ç°Runnableæ¥å£ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸ºWorkeræ—¢æ˜¯ä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°è·å–é”é‡Šæ”¾é”çš„æ•ˆæœã€‚è¿™é‡Œç»§æ‰¿AQSä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿çº¿ç¨‹çš„ä¸­æ–­å¤„ç†ã€‚è¿™é‡Œæ³¨æ„ä¸¤ä¸ªåœ°æ–¹ï¼šæ„é€ å‡½æ•°ã€run()ã€‚æ„é€ å‡½æ•°ä¸»è¦æ˜¯åšä¸‰ä»¶äº‹ï¼š1.è®¾ç½®åŒæ­¥çŠ¶æ€stateä¸º-1ï¼ŒåŒæ­¥çŠ¶æ€å¤§äº0è¡¨ç¤ºå°±å·²ç»è·å–äº†é”ï¼Œ2.è®¾ç½®å°†å½“å‰ä»»åŠ¡taskè®¾ç½®ä¸ºfirstTaskï¼Œ3.åˆ©ç”¨Workeræœ¬èº«å¯¹è±¡thiså’ŒThreadFactoryåˆ›å»ºçº¿ç¨‹å¯¹è±¡ã€‚

å½“çº¿ç¨‹threadå¯åŠ¨ï¼ˆè°ƒç”¨start()æ–¹æ³•ï¼‰æ—¶ï¼Œå…¶å®å°±æ˜¯æ‰§è¡ŒWorkerçš„run()æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨runWorker()ã€‚

**runWorker**

```Java
    final void runWorker(Worker w) {

        // å½“å‰çº¿ç¨‹
        Thread wt = Thread.currentThread();

        // è¦æ‰§è¡Œçš„ä»»åŠ¡
        Runnable task = w.firstTask;

        w.firstTask = null;

        // é‡Šæ”¾é”ï¼Œè¿è¡Œä¸­æ–­
        w.unlock(); // allow interrupts
        boolean completedAbruptly = true;
        try {
            while (task != null || (task = getTask()) != null) {
                // worker è·å–é”
                w.lock();

                // ç¡®ä¿åªæœ‰å½“çº¿ç¨‹æ˜¯stopingæ—¶ï¼Œæ‰ä¼šè¢«è®¾ç½®ä¸ºä¸­æ–­ï¼Œå¦åˆ™æ¸…æ¥šä¸­æ–­æ ‡ç¤º
                // å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ >= STOP ,ä¸”å½“å‰çº¿ç¨‹æ²¡æœ‰è®¾ç½®ä¸­æ–­çŠ¶æ€ï¼Œåˆ™wt.interrupt()
                // å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ < STOPï¼Œä½†æ˜¯çº¿ç¨‹å·²ç»ä¸­æ–­äº†ï¼Œå†æ¬¡åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ >= STOPï¼Œå¦‚æœæ˜¯ wt.interrupt()
                if ((runStateAtLeast(ctl.get(), STOP) ||
                        (Thread.interrupted() &&
                                runStateAtLeast(ctl.get(), STOP))) &&
                        !wt.isInterrupted())
                    wt.interrupt();
                try {
                    // è‡ªå®šä¹‰æ–¹æ³•
                    beforeExecute(wt, task);
                    Throwable thrown = null;
                    try {
                        // æ‰§è¡Œä»»åŠ¡
                        task.run();
                    } catch (RuntimeException x) {
                        thrown = x; throw x;
                    } catch (Error x) {
                        thrown = x; throw x;
                    } catch (Throwable x) {
                        thrown = x; throw new Error(x);
                    } finally {
                        afterExecute(task, thrown);
                    }
                } finally {
                    task = null;
                    // å®Œæˆä»»åŠ¡æ•° + 1
                    w.completedTasks++;
                    // é‡Šæ”¾é”
                    w.unlock();
                }
            }
            completedAbruptly = false;
        } finally {
            processWorkerExit(w, completedAbruptly);
        }
    }
```

è¿è¡Œæµç¨‹

1. æ ¹æ®workerè·å–è¦æ‰§è¡Œçš„ä»»åŠ¡taskï¼Œç„¶åè°ƒç”¨unlock()æ–¹æ³•é‡Šæ”¾é”ï¼Œè¿™é‡Œé‡Šæ”¾é”çš„ä¸»è¦ç›®çš„åœ¨äºä¸­æ–­ï¼Œå› ä¸ºåœ¨new Workeræ—¶ï¼Œè®¾ç½®çš„stateä¸º-1ï¼Œè°ƒç”¨unlock()æ–¹æ³•å¯ä»¥å°†stateè®¾ç½®ä¸º0ï¼Œè¿™é‡Œä¸»è¦åŸå› å°±åœ¨äºinterruptWorkers()æ–¹æ³•åªæœ‰åœ¨state >= 0æ—¶æ‰ä¼šæ‰§è¡Œï¼›
2. é€šè¿‡getTask()è·å–æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè°ƒç”¨task.run()æ‰§è¡Œï¼Œå½“ç„¶åœ¨æ‰§è¡Œä¹‹å‰ä¼šè°ƒç”¨worker.lock()ä¸Šé”ï¼Œæ‰§è¡Œä¹‹åè°ƒç”¨worker.unlock()æ”¾é”ï¼›
3. åœ¨ä»»åŠ¡æ‰§è¡Œå‰åï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯è‡ªå®šä¹‰beforeExecute() å’Œ afterExecute()æ–¹æ³•ï¼Œåˆ™ä¸¤ä¸ªæ–¹æ³•åœ¨ThreadPoolExecutorä¸­æ˜¯ç©ºå®ç°ï¼›
4. å¦‚æœçº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œåˆ™ä¼šè°ƒç”¨getTask()æ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–æ–°ä»»åŠ¡ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ ¹æ®æ˜¯å¦è¶…æ—¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡ï¼›
5. task == nullæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼ˆbeforeExecute()ã€task.run()ã€afterExecute()å‡æœ‰å¯èƒ½ï¼‰å¯¼è‡´workerçº¿ç¨‹ç»ˆæ­¢ï¼Œåˆ™è°ƒç”¨processWorkerExit()æ–¹æ³•å¤„ç†workeré€€å‡ºæµç¨‹ã€‚

**getTask()**

```Java
    private Runnable getTask() {
        boolean timedOut = false; // Did the last poll() time out?

        for (;;) {

            // çº¿ç¨‹æ± çŠ¶æ€
            int c = ctl.get();
            int rs = runStateOf(c);

            // çº¿ç¨‹æ± ä¸­çŠ¶æ€ >= STOP æˆ–è€… çº¿ç¨‹æ± çŠ¶æ€ == SHUTDOWNä¸”é˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™worker - 1ï¼Œreturn null
            if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {
                decrementWorkerCount();
                return null;
            }

            int wc = workerCountOf(c);

            // åˆ¤æ–­æ˜¯å¦éœ€è¦è¶…æ—¶æ§åˆ¶
            boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;

            if ((wc > maximumPoolSize || (timed && timedOut)) && (wc > 1 || workQueue.isEmpty())) {
                if (compareAndDecrementWorkerCount(c))
                    return null;
                continue;
            }

            try {

                // ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–task
                // å¦‚æœéœ€è¦è¶…æ—¶æ§åˆ¶ï¼Œåˆ™è°ƒç”¨poll()ï¼Œå¦åˆ™è°ƒç”¨take()
                Runnable r = timed ?
                        workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                        workQueue.take();
                if (r != null)
                    return r;
                timedOut = true;
            } catch (InterruptedException retry) {
                timedOut = false;
            }
        }
    }
```

timed == trueï¼Œè°ƒç”¨poll()æ–¹æ³•ï¼Œå¦‚æœåœ¨keepAliveTimeæ—¶é—´å†…è¿˜æ²¡æœ‰è·å–taskçš„è¯ï¼Œåˆ™è¿”å›nullï¼Œç»§ç»­å¾ªç¯ã€‚timed == falseï¼Œåˆ™è°ƒç”¨take()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œæ²¡æœ‰ä»»åŠ¡æ—¶ä¼šä¸€ç›´é˜»å¡æŒ‚èµ·ï¼Œç›´åˆ°æœ‰ä»»åŠ¡åŠ å…¥æ—¶å¯¹è¯¥çº¿ç¨‹å”¤é†’ï¼Œè¿”å›ä»»åŠ¡ã€‚

åœ¨runWorker()æ–¹æ³•ä¸­ï¼Œæ— è®ºæœ€ç»ˆç»“æœå¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡ŒprocessWorkerExit()æ–¹æ³•å¯¹workerè¿›è¡Œé€€å‡ºå¤„ç†ã€‚

**processWorkerExit()**

```Java
    private void processWorkerExit(Worker w, boolean completedAbruptly) {

        // trueï¼šç”¨æˆ·çº¿ç¨‹è¿è¡Œå¼‚å¸¸,éœ€è¦æ‰£å‡
        // falseï¼šgetTaskæ–¹æ³•ä¸­æ‰£å‡çº¿ç¨‹æ•°é‡
        if (completedAbruptly)
            decrementWorkerCount();

        // è·å–ä¸»é”
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            completedTaskCount += w.completedTasks;
            // ä»HashSetä¸­ç§»å‡ºworker
            workers.remove(w);
        } finally {
            mainLock.unlock();
        }

        // æœ‰workerçº¿ç¨‹ç§»é™¤ï¼Œå¯èƒ½æ˜¯æœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡ºéœ€è¦å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± 
        tryTerminate();

        int c = ctl.get();
        // å¦‚æœçº¿ç¨‹ä¸ºrunningæˆ–shutdownçŠ¶æ€ï¼Œå³tryTerminate()æ²¡æœ‰æˆåŠŸç»ˆæ­¢çº¿ç¨‹æ± ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æœ‰å¿…è¦ä¸€ä¸ªworker
        if (runStateLessThan(c, STOP)) {
            // æ­£å¸¸é€€å‡ºï¼Œè®¡ç®—minï¼šéœ€è¦ç»´æŠ¤çš„æœ€å°çº¿ç¨‹æ•°é‡
            if (!completedAbruptly) {
                // allowCoreThreadTimeOut é»˜è®¤falseï¼šæ˜¯å¦éœ€è¦ç»´æŒæ ¸å¿ƒçº¿ç¨‹çš„æ•°é‡
                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;
                // å¦‚æœmin ==0 æˆ–è€…workerQueueä¸ºç©ºï¼Œmin = 1
                if (min == 0 && ! workQueue.isEmpty())
                    min = 1;

                // å¦‚æœçº¿ç¨‹æ•°é‡å¤§äºæœ€å°‘æ•°é‡minï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦æ–°å¢çº¿ç¨‹
                if (workerCountOf(c) >= min)
                    return; // replacement not needed
            }
            // æ·»åŠ ä¸€ä¸ªæ²¡æœ‰firstTaskçš„worker
            addWorker(null, false);
        }
    }
```

é¦–å…ˆcompletedAbruptlyçš„å€¼æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹çº¿ç¨‹æ•°-1å¤„ç†ï¼Œå¦‚æœcompletedAbruptly == trueï¼Œè¯´æ˜åœ¨ä»»åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆéœ€è¦è¿›è¡Œå‡1å¤„ç†ï¼Œå¦åˆ™ä¸éœ€è¦ï¼Œå› ä¸ºå‡1å¤„ç†åœ¨getTask()æ–¹æ³•ä¸­å¤„ç†äº†ã€‚ç„¶åä»HashSetä¸­ç§»å‡ºè¯¥workerï¼Œè¿‡ç¨‹éœ€è¦è·å–mainlockã€‚ç„¶åè°ƒç”¨tryTerminate()æ–¹æ³•å¤„ç†ï¼Œè¯¥æ–¹æ³•æ˜¯å¯¹æœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡ºåšç»ˆæ­¢çº¿ç¨‹æ± åŠ¨ä½œã€‚å¦‚æœçº¿ç¨‹æ± æ²¡æœ‰ç»ˆæ­¢ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± éœ€è¦ä¿æŒä¸€å®šæ•°é‡çš„çº¿ç¨‹ï¼Œåˆ™é€šè¿‡addWorker(null,false)æ–°å¢ä¸€ä¸ªç©ºçš„çº¿ç¨‹ã€‚

**addWorkerFailed()**

åœ¨addWorker()æ–¹æ³•ä¸­ï¼Œå¦‚æœçº¿ç¨‹t==nullï¼Œæˆ–è€…åœ¨addè¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œä¼šå¯¼è‡´workerStarted == falseï¼Œé‚£ä¹ˆåœ¨æœ€åä¼šè°ƒç”¨addWorkerFailed()æ–¹æ³•ï¼š

```Java
    private void addWorkerFailed(Worker w) {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            // ä»HashSetä¸­ç§»é™¤è¯¥worker
            if (w != null)
                workers.remove(w);

            // çº¿ç¨‹æ•° - 1
            decrementWorkerCount();
            // å°è¯•ç»ˆæ­¢çº¿ç¨‹
            tryTerminate();
        } finally {
            mainLock.unlock();
        }
    }
```

æ•´ä¸ªé€»è¾‘æ˜¾å¾—æ¯”è¾ƒç®€å•ã€‚

**tryTerminate()**

å½“çº¿ç¨‹æ± æ¶‰åŠåˆ°è¦ç§»é™¤workeræ—¶å€™éƒ½ä¼šè°ƒç”¨tryTerminate()ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨äºåˆ¤æ–­çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦å·²ç»å…¨éƒ¨ç§»é™¤äº†ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™å…³é—­çº¿ç¨‹æ± ã€‚

```Java
    final void tryTerminate() {
        for (;;) {
            int c = ctl.get();
            // çº¿ç¨‹æ± å¤„äºRunningçŠ¶æ€
            // çº¿ç¨‹æ± å·²ç»ç»ˆæ­¢äº†
            // çº¿ç¨‹æ± å¤„äºShutDownçŠ¶æ€ï¼Œä½†æ˜¯é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©º
            if (isRunning(c) ||
                    runStateAtLeast(c, TIDYING) ||
                    (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))
                return;

            // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå°±æ„å‘³ç€çº¿ç¨‹æ± è¦ä¹ˆå¤„äºSTOPçŠ¶æ€ï¼Œè¦ä¹ˆå¤„äºSHUTDOWNä¸”é˜»å¡é˜Ÿåˆ—ä¸ºç©º
            // è¿™æ—¶å¦‚æœçº¿ç¨‹æ± ä¸­è¿˜å­˜åœ¨çº¿ç¨‹ï¼Œåˆ™ä¼šå°è¯•ä¸­æ–­çº¿ç¨‹
            if (workerCountOf(c) != 0) {
                // /çº¿ç¨‹æ± è¿˜æœ‰çº¿ç¨‹ï¼Œä½†æ˜¯é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡äº†ï¼Œéœ€è¦ä¸­æ–­å”¤é†’ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹
                // ï¼ˆrunwokerçš„æ—¶å€™é¦–å…ˆå°±é€šè¿‡w.unlockè®¾ç½®çº¿ç¨‹å¯ä¸­æ–­ï¼ŒgetTaskæœ€åé¢çš„catchå¤„ç†ä¸­æ–­ï¼‰
                interruptIdleWorkers(ONLY_ONE);
                return;
            }

            final ReentrantLock mainLock = this.mainLock;
            mainLock.lock();
            try {
                // å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± 
                if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {
                    try {
                        terminated();
                    } finally {
                        // çº¿ç¨‹æ± çŠ¶æ€è½¬ä¸ºTERMINATED
                        ctl.set(ctlOf(TERMINATED, 0));
                        termination.signalAll();
                    }
                    return;
                }
            } finally {
                mainLock.unlock();
            }
        }
    }
```

åœ¨å…³é—­çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœçº¿ç¨‹æ± å¤„äºSTOPçŠ¶æ€æˆ–è€…å¤„äºSHUDOWNçŠ¶æ€ä¸”é˜»å¡é˜Ÿåˆ—ä¸ºnullï¼Œåˆ™çº¿ç¨‹æ± ä¼šè°ƒç”¨interruptIdleWorkers()æ–¹æ³•ä¸­æ–­æ‰€æœ‰çº¿ç¨‹ï¼Œæ³¨æ„ONLY_ONE== trueï¼Œè¡¨ç¤ºä»…ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ã€‚

**interruptIdleWorkers**

```Java
    private void interruptIdleWorkers(boolean onlyOne) {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            for (Worker w : workers) {
                Thread t = w.thread;
                if (!t.isInterrupted() && w.tryLock()) {
                    try {
                        t.interrupt();
                    } catch (SecurityException ignore) {
                    } finally {
                        w.unlock();
                    }
                }
                if (onlyOne)
                    break;
            }
        } finally {
            mainLock.unlock();
        }
    }
```

onlyOne==trueä»…ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦åˆ™ç»ˆæ­¢æ‰€æœ‰çº¿ç¨‹ã€‚

## çº¿ç¨‹ç»ˆæ­¢

çº¿ç¨‹æ± ThreadPoolExecutoræä¾›äº†shutdown()å’ŒshutDownNow()ç”¨äºå…³é—­çº¿ç¨‹æ± ã€‚

shutdown()ï¼šæŒ‰è¿‡å»æ‰§è¡Œå·²æäº¤ä»»åŠ¡çš„é¡ºåºå‘èµ·ä¸€ä¸ªæœ‰åºçš„å…³é—­ï¼Œä½†æ˜¯ä¸æ¥å—æ–°ä»»åŠ¡ã€‚

shutdownNow() :å°è¯•åœæ­¢æ‰€æœ‰çš„æ´»åŠ¨æ‰§è¡Œä»»åŠ¡ã€æš‚åœç­‰å¾…ä»»åŠ¡çš„å¤„ç†ï¼Œå¹¶è¿”å›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚

**shutdown**

```Java
    public void shutdown() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            checkShutdownAccess();
            // æ¨è¿›çº¿ç¨‹çŠ¶æ€
            advanceRunState(SHUTDOWN);
            // ä¸­æ–­ç©ºé—²çš„çº¿ç¨‹
            interruptIdleWorkers();
            // äº¤ç»™å­ç±»å®ç°
            onShutdown();
        } finally {
            mainLock.unlock();
        }
        tryTerminate();
    }
```

**shutdownNow**

```Java
    public List<Runnable> shutdownNow() {
        List<Runnable> tasks;
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            checkShutdownAccess();
            advanceRunState(STOP);
            // ä¸­æ–­æ‰€æœ‰çº¿ç¨‹
            interruptWorkers();
            // è¿”å›ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨
            tasks = drainQueue();
        } finally {
            mainLock.unlock();
        }
        tryTerminate();
        return tasks;
    }
```

ä¸shutdownä¸åŒï¼ŒshutdownNowä¼šè°ƒç”¨interruptWorkers()æ–¹æ³•ä¸­æ–­æ‰€æœ‰çº¿ç¨‹ã€‚

```Java
    private void interruptWorkers() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            for (Worker w : workers)
                w.interruptIfStarted();
        } finally {
            mainLock.unlock();
        }
    }
```

åŒæ—¶ä¼šè°ƒç”¨drainQueue()æ–¹æ³•è¿”å›ç­‰å¾…æ‰§è¡Œåˆ°ä»»åŠ¡åˆ—è¡¨ã€‚

```Java
    private List<Runnable> drainQueue() {
        BlockingQueue<Runnable> q = workQueue;
        ArrayList<Runnable> taskList = new ArrayList<Runnable>();
        q.drainTo(taskList);
        if (!q.isEmpty()) {
            for (Runnable r : q.toArray(new Runnable[0])) {
                if (q.remove(r))
                    taskList.add(r);
            }
        }
        return taskList;
    }
```

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)