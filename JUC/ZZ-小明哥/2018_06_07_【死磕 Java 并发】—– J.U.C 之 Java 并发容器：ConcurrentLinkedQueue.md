title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹ Java å¹¶å‘å®¹å™¨ï¼šConcurrentLinkedQueue
date: 2018-06-07
tag: 
categories: JUC
permalink: JUC/sike/ConcurrentLinkedQueue
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2353
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247485589&idx=2&sn=9cdd64a7ceabfbb3400df32c2091dcff&chksm=fa497724cd3efe320b390312f38d18415bf5b6faa483ad505d3ac61c39db79dbf0a8206d21f8&token=1977883259&lang=zh_CN#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2353 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [ConcurrentLinkedQueueæºç åˆ†æ](http://www.iocoder.cn/JUC/sike/ConcurrentLinkedQueue/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

è¦å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—æœ‰ä¸¤ç§æ–¹å¼ï¼šé˜»å¡å’Œéé˜»å¡ã€‚é˜»å¡é˜Ÿåˆ—æ— éå°±æ˜¯é”çš„åº”ç”¨ï¼Œè€Œéé˜»å¡åˆ™æ˜¯CASç®—æ³•çš„åº”ç”¨ã€‚ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹ä¸€ä¸ªéé˜»å¡ç®—æ³•çš„ç ”ç©¶ï¼šCoucurrentLinkedQueueã€‚

ConcurrentLinkedQueueæ˜¯ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— è¾¹ç•Œçš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œå®ƒé‡‡ç”¨FIFOåŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚é‡‡ç”¨â€œwait-freeâ€ç®—æ³•ï¼ˆå³CASç®—æ³•ï¼‰æ¥å®ç°çš„ã€‚

CoucurrentLinkedQueueè§„å®šäº†å¦‚ä¸‹å‡ ä¸ªä¸å˜æ€§ï¼š

1. åœ¨å…¥é˜Ÿçš„æœ€åä¸€ä¸ªå…ƒç´ çš„nextä¸ºnull
2. é˜Ÿåˆ—ä¸­æ‰€æœ‰æœªåˆ é™¤çš„èŠ‚ç‚¹çš„iteméƒ½ä¸èƒ½ä¸ºnullä¸”éƒ½èƒ½ä»headèŠ‚ç‚¹éå†åˆ°
3. å¯¹äºè¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œä¸æ˜¯ç›´æ¥å°†å…¶è®¾ç½®ä¸ºnullï¼Œè€Œæ˜¯å…ˆå°†å…¶itemåŸŸè®¾ç½®ä¸ºnullï¼ˆè¿­ä»£å™¨ä¼šè·³è¿‡itemä¸ºnullçš„èŠ‚ç‚¹ï¼‰
4. å…è®¸headå’Œtailæ›´æ–°æ»åã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ„æ€å°±è¯´æ˜¯headã€tailä¸æ€»æ˜¯æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ å’Œæœ€åä¸€ä¸ªå…ƒç´ ï¼ˆåé¢é˜è¿°ï¼‰ã€‚

headçš„ä¸å˜æ€§å’Œå¯å˜æ€§ï¼š

- ä¸å˜æ€§
  1. æ‰€æœ‰æœªåˆ é™¤çš„èŠ‚ç‚¹éƒ½å¯ä»¥é€šè¿‡headèŠ‚ç‚¹éå†åˆ°
  2. headä¸èƒ½ä¸ºnull
  3. headèŠ‚ç‚¹çš„nextä¸èƒ½æŒ‡å‘è‡ªèº«
- å¯å˜æ€§
  1. headçš„itemå¯èƒ½ä¸ºnullï¼Œä¹Ÿå¯èƒ½ä¸ä¸ºnull
  2.å…è®¸tailæ»åheadï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨succc()æ–¹æ³•ï¼Œä»headä¸å¯è¾¾tail

tailçš„ä¸å˜æ€§å’Œå¯å˜æ€§

- ä¸å˜æ€§
  1. tailä¸èƒ½ä¸ºnull
- å¯å˜æ€§
  1. tailçš„itemå¯èƒ½ä¸ºnullï¼Œä¹Ÿå¯èƒ½ä¸ä¸ºnull
  2. tailèŠ‚ç‚¹çš„nextåŸŸå¯ä»¥æŒ‡å‘è‡ªèº«
     3.å…è®¸tailæ»åheadï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨succc()æ–¹æ³•ï¼Œä»headä¸å¯è¾¾tail

è¿™äº›ç‰¹æ€§æ˜¯å¦å·²ç»æ™•äº†ï¼Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¢çš„æºç åˆ†æå°±å¯ä»¥ç†è§£è¿™äº›ç‰¹æ€§äº†ã€‚

## ConcurrentLinkedQueueæºç åˆ†æ

CoucurrentLinkedQueueçš„ç»“æ„ç”±headèŠ‚ç‚¹å’ŒtailèŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”±èŠ‚ç‚¹å…ƒç´ itemå’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„nextå¼•ç”¨ç»„æˆï¼Œè€ŒèŠ‚ç‚¹ä¸èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»å°±æ˜¯é€šè¿‡è¯¥nextå…³è”èµ·æ¥çš„ï¼Œä»è€Œç»„æˆä¸€å¼ é“¾è¡¨çš„é˜Ÿåˆ—ã€‚èŠ‚ç‚¹Nodeä¸ºConcurrentLinkedQueueçš„å†…éƒ¨ç±»ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```Java
  private static class Node<E> {
        /** èŠ‚ç‚¹å…ƒç´ åŸŸ */
        volatile E item;
        volatile Node<E> next;

        //åˆå§‹åŒ–,è·å¾—item å’Œ next çš„åç§»é‡,ä¸ºåæœŸçš„CASåšå‡†å¤‡

        Node(E item) {
            UNSAFE.putObject(this, itemOffset, item);
        }

        boolean casItem(E cmp, E val) {
            return UNSAFE.compareAndSwapObject(this, itemOffset, cmp, val);
        }

        void lazySetNext(Node<E> val) {
            UNSAFE.putOrderedObject(this, nextOffset, val);
        }

        boolean casNext(Node<E> cmp, Node<E> val) {
            return UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val);
        }

        // Unsafe mechanics

        private static final sun.misc.Unsafe UNSAFE;
        /** åç§»é‡ */
        private static final long itemOffset;
        /** ä¸‹ä¸€ä¸ªå…ƒç´ çš„åç§»é‡ */

       private static final long nextOffset;

        static {
            try {
                UNSAFE = sun.misc.Unsafe.getUnsafe();
                Class<?> k = Node.class;
                itemOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("item"));
                nextOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("next"));
            } catch (Exception e) {
                throw new Error(e);
            }
        }
    }
```

### å…¥åˆ—

å…¥åˆ—ï¼Œæˆ‘ä»¬è®¤ä¸ºæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„è¿‡ç¨‹ï¼štailèŠ‚ç‚¹çš„nextæ‰§è¡Œæ–°èŠ‚ç‚¹ï¼Œç„¶åæ›´æ–°tailä¸ºæ–°èŠ‚ç‚¹å³å¯ã€‚ä»å•çº¿ç¨‹è§’åº¦æˆ‘ä»¬è¿™ä¹ˆç†è§£åº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¤šçº¿ç¨‹å‘¢ï¼Ÿå¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ’å…¥åŠ¨ä½œï¼Œé‚£ä¹ˆå®ƒå¿…é¡»å…ˆè·å–å°¾èŠ‚ç‚¹ï¼Œç„¶åè®¾ç½®å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œä½†æ˜¯å¦‚æœå·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹åˆšåˆšå¥½å®Œæˆäº†æ’å…¥ï¼Œé‚£ä¹ˆå°¾èŠ‚ç‚¹æ˜¯ä¸æ˜¯å‘ç”Ÿäº†å˜åŒ–ï¼Ÿå¯¹äºè¿™ç§æƒ…å†µConcurrentLinkedQueueæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹æºç ï¼š

offer(E e)ï¼šå°†æŒ‡å®šå…ƒç´ æ’å…¥éƒ½é˜Ÿåˆ—å°¾éƒ¨ï¼š

```Java
public boolean offer(E e) {
        //æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦ä¸ºnull
        checkNotNull(e);
        // åˆ›å»ºæ–°èŠ‚ç‚¹
        final Node<E> newNode = new Node<E>(e);

        //æ­»å¾ªç¯ ç›´åˆ°æˆåŠŸä¸ºæ­¢
        for (Node<E> t = tail, p = t;;) {
            Node<E> q = p.next;
            // q == null è¡¨ç¤º på·²ç»æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œå°è¯•åŠ å…¥åˆ°é˜Ÿåˆ—å°¾
            // å¦‚æœæ’å…¥å¤±è´¥ï¼Œåˆ™è¡¨ç¤ºå…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†pçš„æŒ‡å‘
            if (q == null) {                                // --- 1
                // casNextï¼štèŠ‚ç‚¹çš„nextæŒ‡å‘å½“å‰èŠ‚ç‚¹
                // casTailï¼šè®¾ç½®tail å°¾èŠ‚ç‚¹
                if (p.casNext(null, newNode)) {             // --- 2
                    // node åŠ å…¥èŠ‚ç‚¹åä¼šå¯¼è‡´tailè·ç¦»æœ€åä¸€ä¸ªèŠ‚ç‚¹ç›¸å·®å¤§äºä¸€ä¸ªï¼Œéœ€è¦æ›´æ–°tail
                    if (p != t)                             // --- 3
                        casTail(t, newNode);                    // --- 4
                    return true;
                }
            }
            // p == q ç­‰äºè‡ªèº«
            else if (p == q)                                // --- 5
                // p == q ä»£è¡¨ç€è¯¥èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤äº†
                // ç”±äºå¤šçº¿ç¨‹çš„åŸå› ï¼Œæˆ‘ä»¬offer()çš„æ—¶å€™ä¹Ÿä¼špoll()ï¼Œå¦‚æœoffer()çš„æ—¶å€™æ­£å¥½è¯¥èŠ‚ç‚¹å·²ç»poll()äº†
                // é‚£ä¹ˆåœ¨poll()æ–¹æ³•ä¸­çš„updateHead()æ–¹æ³•ä¼šå°†headæŒ‡å‘å½“å‰çš„qï¼Œè€ŒæŠŠp.nextæŒ‡å‘è‡ªå·±ï¼Œå³ï¼šp.next == p
                // è¿™æ ·å°±ä¼šå¯¼è‡´tailèŠ‚ç‚¹æ»åheadï¼ˆtailä½äºheadçš„å‰é¢ï¼‰ï¼Œåˆ™éœ€è¦é‡æ–°è®¾ç½®p
                p = (t != (t = tail)) ? t : head;           // --- 6
            // tailå¹¶æ²¡æœ‰æŒ‡å‘å°¾èŠ‚ç‚¹
            else
                // tailå·²ç»ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†pæŒ‡å‘æœ€åä¸€ä¸ªèŠ‚ç‚¹
                p = (p != t && t != (t = tail)) ? t : q;    // --- 7
        }
    }
```

å…‰çœ‹æºç è¿˜æ˜¯æœ‰ç‚¹å„¿è¿·ç³Šçš„ï¼Œæ’å…¥èŠ‚ç‚¹ä¸€æ¬¡åˆ†æå°±ä¼šæ˜æœ—å¾ˆå¤šã€‚

**åˆå§‹åŒ–**

ConcurrentLinkedQueueåˆå§‹åŒ–æ—¶headã€tailå­˜å‚¨çš„å…ƒç´ éƒ½ä¸ºnullï¼Œä¸”headç­‰äºtailï¼š

[![201703160001](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823001.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823001.png)

**æ·»åŠ å…ƒç´ A**

æŒ‰ç…§ç¨‹åºåˆ†æï¼šç¬¬ä¸€æ¬¡æ’å…¥å…ƒç´ Aï¼Œhead = tail = dummyNodeï¼Œæ‰€æœ‰q = p.next = nullï¼Œç›´æ¥èµ°æ­¥éª¤2ï¼šp.casNext(null, newNode)ï¼Œç”±äº p == tæˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œæ­¥éª¤3ï¼šcasTail(t, newNode)ï¼Œç›´æ¥returnã€‚æ’å…¥AèŠ‚ç‚¹åå¦‚ä¸‹ï¼š

[![201703160002](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823002.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823002.png)

**æ·»åŠ å…ƒç´ B**

q = p.next = A ,p = tail = dummyNodeï¼Œæ‰€ä»¥ç›´æ¥è·³åˆ°æ­¥éª¤7ï¼šp = (p != t && t != (t = tail)) ? t : q;ã€‚æ­¤æ—¶p = qï¼Œç„¶åè¿›è¡Œç¬¬äºŒæ¬¡å¾ªç¯ q = p.next = nullï¼Œæ­¥éª¤2ï¼šp == nullæˆç«‹ï¼Œå°†è¯¥èŠ‚ç‚¹æ’å…¥ï¼Œå› ä¸ºp = qï¼Œt = tailï¼Œæ‰€ä»¥æ­¥éª¤3ï¼šp != t æˆç«‹ï¼Œæ‰§è¡Œæ­¥éª¤4ï¼šcasTail(t, newNode)ï¼Œç„¶åreturnã€‚å¦‚ä¸‹ï¼š
[![201703160003](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823003.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823003.png)

**æ·»åŠ èŠ‚ç‚¹C**

æ­¤æ—¶t = tail ,p = tï¼Œq = p.next = nullï¼Œå’Œæ’å…¥å…ƒç´ Aæ— å¼‚ï¼Œå¦‚ä¸‹ï¼š
[![201703160004](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823004.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823004.png)

è¿™é‡Œæ•´ä¸ªoffer()è¿‡ç¨‹å·²ç»åˆ†æå®Œæˆäº†ï¼Œå¯èƒ½p == q æœ‰ç‚¹å„¿éš¾ç†è§£ï¼Œp ä¸æ˜¯ç­‰äºq.nextä¹ˆï¼Œæ€ä¹ˆä¼šæœ‰p == qå‘¢ï¼Ÿè¿™ä¸ªç–‘é—®æˆ‘ä»¬åœ¨å‡ºåˆ—poll()ä¸­åˆ†æ

### å‡ºåˆ—

ConcurrentLinkedQueueæä¾›äº†poll()æ–¹æ³•è¿›è¡Œå‡ºåˆ—æ“ä½œã€‚å…¥åˆ—ä¸»è¦æ˜¯æ¶‰åŠåˆ°tailï¼Œå‡ºåˆ—åˆ™æ¶‰åŠåˆ°headã€‚æˆ‘ä»¬å…ˆçœ‹æºç ï¼š

```Java
public E poll() {
        // å¦‚æœå‡ºç°pè¢«åˆ é™¤çš„æƒ…å†µéœ€è¦ä»headé‡æ–°å¼€å§‹
        restartFromHead:        // è¿™æ˜¯ä»€ä¹ˆè¯­æ³•ï¼ŸçœŸå¿ƒæ²¡æœ‰è§è¿‡
        for (;;) {
            for (Node<E> h = head, p = h, q;;) {

                // èŠ‚ç‚¹ item
                E item = p.item;

                // item ä¸ä¸ºnullï¼Œåˆ™å°†item è®¾ç½®ä¸ºnull
                if (item != null && p.casItem(item, null)) {                    // --- 1
                    // p != head åˆ™æ›´æ–°head
                    if (p != h)                                                 // --- 2
                        // p.next != nullï¼Œåˆ™å°†headæ›´æ–°ä¸ºp.next ,å¦åˆ™æ›´æ–°ä¸ºp
                        updateHead(h, ((q = p.next) != null) ? q : p);          // --- 3
                    return item;
                }
                // p.next == null é˜Ÿåˆ—ä¸ºç©º
                else if ((q = p.next) == null) {                                // --- 4
                    updateHead(h, p);
                    return null;
                }
                // å½“ä¸€ä¸ªçº¿ç¨‹åœ¨pollçš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»æŠŠå½“å‰çš„pä»é˜Ÿåˆ—ä¸­åˆ é™¤â€”â€”å°†p.next = pï¼Œpå·²ç»è¢«ç§»é™¤ä¸èƒ½ç»§ç»­ï¼Œéœ€è¦é‡æ–°å¼€å§‹
                else if (p == q)                                                // --- 5
                    continue restartFromHead;
                else
                    p = q;                                                      // --- 6
            }
        }
    }
```

è¿™ä¸ªç›¸å¯¹äºoffer()æ–¹æ³•è€Œè¨€ä¼šç®€å•äº›ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•ï¼šupdateHead()ï¼Œè¯¥æ–¹æ³•ç”¨äºCASæ›´æ–°headèŠ‚ç‚¹ï¼Œå¦‚ä¸‹ï¼š

```Java
    final void updateHead(Node<E> h, Node<E> p) {
        if (h != p && casHead(h, p))
            h.lazySetNext(h);
    }
```

æˆ‘ä»¬å…ˆå°†ä¸Šé¢offer()çš„é“¾è¡¨poll()æ‰ï¼Œæ·»åŠ Aã€Bã€CèŠ‚ç‚¹ç»“æ„å¦‚ä¸‹ï¼š

[![201703160004_2](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823004.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823004.png)

**poll A**

head = dumyï¼Œp = headï¼Œ item = p.item = nullï¼Œæ­¥éª¤1ä¸æˆç«‹ï¼Œæ­¥éª¤4ï¼š(q = p.next) == nullä¸æˆç«‹ï¼Œp.next = Aï¼Œè·³åˆ°æ­¥éª¤6ï¼Œä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œæ­¤æ—¶p = Aï¼Œæ‰€ä»¥æ­¥éª¤1 item != nullï¼Œè¿›è¡Œp.casItem(item, null)æˆåŠŸï¼Œæ­¤æ—¶p == A != hï¼Œæ‰€ä»¥æ‰§è¡Œæ­¥éª¤3ï¼šupdateHead(h, ((q = p.next) != null) ? q : p)ï¼Œq = p.next = B != nullï¼Œåˆ™å°†head CASæ›´æ–°æˆBï¼Œå¦‚ä¸‹ï¼š

[![201703160005](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823005.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823005.png)

**poll B**

head = B ï¼Œ p = head = Bï¼Œitem = p.item = Bï¼Œæ­¥éª¤æˆç«‹ï¼Œæ­¥éª¤2ï¼šp != h ä¸æˆç«‹ï¼Œç›´æ¥returnï¼Œå¦‚ä¸‹ï¼š

[![201703160006](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823006.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823006.png)

**poll C**

head = dumy ï¼Œp = head = dumyï¼Œtiem = p.item = nullï¼Œæ­¥éª¤1ä¸æˆç«‹ï¼Œè·³åˆ°æ­¥éª¤4ï¼š(q = p.next) == nullï¼Œä¸æˆç«‹ï¼Œç„¶åè·³åˆ°æ­¥éª¤6ï¼Œæ­¤æ—¶ï¼Œp = q = Cï¼Œitem = C(item)ï¼Œæ­¥éª¤1æˆç«‹ï¼Œæ‰€ä»¥è®²Cï¼ˆitemï¼‰è®¾ç½®ä¸ºnullï¼Œæ­¥éª¤2ï¼šp != hæˆç«‹ï¼Œæ‰§è¡Œæ­¥éª¤3ï¼šupdateHead(h, ((q = p.next) != null) ? q : p)ï¼Œå¦‚ä¸‹ï¼š

[![201703160007](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823007.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823007.png)

çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯ä¸€ç›®äº†ç„¶äº†ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å†æ¥åˆ†æoffer()çš„æ­¥éª¤5ï¼š

```Java
else if(p == q){
	p = (t != (t = tail))? t : head;
}
```

ConcurrentLinkedQueueä¸­è§„å®šï¼Œp == qè¡¨æ˜ï¼Œè¯¥èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤äº†ï¼Œä¹Ÿå°±è¯´tailæ»åäºheadï¼Œheadæ— æ³•é€šè¿‡succ()æ–¹æ³•éå†åˆ°tailï¼Œæ€ä¹ˆåšï¼Ÿ (t != (t = tail))? t : head;ï¼ˆè¿™æ®µä»£ç çš„å¯è¯»æ€§å®åœ¨æ˜¯å¤ªå·®äº†ï¼ŒçœŸä»–å¦ˆéš¾ç†è§£ï¼šä¸çŸ¥é“æ˜¯å¦å¯ä»¥ç†è§£ä¸ºt != tail ? tail : headï¼‰è¿™æ®µä»£ç ä¸»è¦æ˜¯æ¥åˆ¤è¯»tailèŠ‚ç‚¹æ˜¯å¦å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œå¦‚æœå‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ™è¯´æ˜tailå·²ç»é‡æ–°å®šä½äº†ï¼Œåªéœ€è¦é‡æ–°æ‰¾åˆ°tailå³å¯ï¼Œå¦åˆ™å°±åªèƒ½æŒ‡å‘headäº†ã€‚

å°±ä¸Šé¢é‚£ä¸ªæˆ‘ä»¬å†æ¬¡æ’å…¥ä¸€ä¸ªå…ƒç´ Dã€‚åˆ™p = headï¼Œq = p.next = nullï¼Œæ‰§è¡Œæ­¥éª¤1ï¼š q = nullä¸” p != t ï¼Œæ‰€ä»¥æ‰§è¡Œæ­¥éª¤4:ï¼Œå¦‚ä¸‹ï¼š

[![201703160008_2](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823008.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823008.png)

å†æ’å…¥å…ƒç´ Eï¼Œq = p.next = nullï¼Œp == tï¼Œæ‰€ä»¥æ’å…¥Eåå¦‚ä¸‹ï¼š

[![201703160009_2](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823009.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120823009.png)

åˆ°è¿™é‡ŒConcurrentLinkedQueueçš„æ•´ä¸ªå…¥åˆ—ã€å‡ºåˆ—éƒ½å·²ç»åˆ†æå®Œæ¯•äº†ï¼Œå¯¹äºConcurrentLinkedQueue LZçœŸå¿ƒæ„Ÿè§‰éš¾çœ‹æ‡‚ï¼Œçœ‹æ‡‚ä¹‹åä¹Ÿæ„Ÿå¹è®¾è®¡å¾—å¤ªç²¾å¦™äº†ï¼Œåˆ©ç”¨CASæ¥å®Œæˆæ•°æ®æ“ä½œï¼ŒåŒæ—¶å…è®¸é˜Ÿåˆ—çš„ä¸ä¸€è‡´æ€§ï¼Œè¿™ç§å¼±ä¸€è‡´æ€§ç¡®å®æ˜¯éå¸¸å¼ºå¤§ã€‚å†æ¬¡æ„Ÿå¹Doug Leaçš„å¤©æ‰ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)