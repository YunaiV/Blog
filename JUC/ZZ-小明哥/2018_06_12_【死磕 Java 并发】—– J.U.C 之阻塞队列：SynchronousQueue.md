title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹é˜»å¡é˜Ÿåˆ—ï¼šSynchronousQueue
date: 2018-06-12
tag: 
categories: JUC
permalink: JUC/sike/SynchronousQueue
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2418
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2418 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [SynchronousQueue](http://www.iocoder.cn/JUC/sike/SynchronousQueue/)
  - [TransferQueue](http://www.iocoder.cn/JUC/sike/SynchronousQueue/)
  - [TransferStack](http://www.iocoder.cn/JUC/sike/SynchronousQueue/)
  - [å…¬å¹³æ¨¡å¼](http://www.iocoder.cn/JUC/sike/SynchronousQueue/)
  - [éå…¬å¹³æ¨¡å¼](http://www.iocoder.cn/JUC/sike/SynchronousQueue/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ã€æ³¨ã€‘ï¼šSynchronousQueueå®ç°ç®—æ³•çœ‹çš„æ™•ä¹ä¹çš„ï¼Œå†™äº†å¥½ä¹…æ‰å†™å®Œï¼Œå¦‚æœå½“ä¸­æœ‰ä»€ä¹ˆé”™è¯¯ä¹‹å¤„ï¼Œå¿˜å„ä½æŒ‡æ­£

ä½œä¸ºBlockingQueueä¸­çš„ä¸€å‘˜ï¼ŒSynchronousQueueä¸å…¶ä»–BlockingQueueæœ‰ç€ä¸åŒç‰¹æ€§ï¼š

1. SynchronousQueueæ²¡æœ‰å®¹é‡ã€‚ä¸å…¶ä»–BlockingQueueä¸åŒï¼ŒSynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„BlockingQueueã€‚æ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»è¦ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ï¼Œåä¹‹äº¦ç„¶ã€‚
2. å› ä¸ºæ²¡æœ‰å®¹é‡ï¼Œæ‰€ä»¥å¯¹åº” peek, contains, clear, isEmpty ... ç­‰æ–¹æ³•å…¶å®æ˜¯æ— æ•ˆçš„ã€‚ä¾‹å¦‚clearæ˜¯ä¸æ‰§è¡Œä»»ä½•æ“ä½œçš„ï¼Œcontainså§‹ç»ˆè¿”å›false,peekå§‹ç»ˆè¿”å›nullã€‚
3. SynchronousQueueåˆ†ä¸ºå…¬å¹³å’Œéå…¬å¹³ï¼Œé»˜è®¤æƒ…å†µä¸‹é‡‡ç”¨éå…¬å¹³æ€§è®¿é—®ç­–ç•¥ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ¥è®¾ç½®ä¸ºå…¬å¹³æ€§è®¿é—®ç­–ç•¥ï¼ˆä¸ºtrueå³å¯ï¼‰ã€‚
4. è‹¥ä½¿ç”¨ TransferQueue, åˆ™é˜Ÿåˆ—ä¸­æ°¸è¿œä¼šå­˜åœ¨ä¸€ä¸ª dummy nodeï¼ˆè¿™ç‚¹åé¢è¯¦ç»†é˜è¿°ï¼‰ã€‚

SynchronousQueueéå¸¸é€‚åˆåšäº¤æ¢å·¥ä½œï¼Œç”Ÿäº§è€…çš„çº¿ç¨‹å’Œæ¶ˆè´¹è€…çš„çº¿ç¨‹åŒæ­¥ä»¥ä¼ é€’æŸäº›ä¿¡æ¯ã€äº‹ä»¶æˆ–è€…ä»»åŠ¡ã€‚

# SynchronousQueue

ä¸å…¶ä»–BlockingQueueä¸€æ ·ï¼ŒSynchronousQueueåŒæ ·ç»§æ‰¿AbstractQueueå’Œå®ç°BlockingQueueæ¥å£ï¼š

```Java
public class SynchronousQueue<E> extends AbstractQueue<E>
    implements BlockingQueue<E>, java.io.Serializable
```

SynchronousQueueæä¾›äº†ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š

```Java
    public SynchronousQueue() {
        this(false);
    }

    public SynchronousQueue(boolean fair) {
        // é€šè¿‡ fair å€¼æ¥å†³å®šå…¬å¹³æ€§å’Œéå…¬å¹³æ€§
        // å…¬å¹³æ€§ä½¿ç”¨TransferQueueï¼Œéå…¬å¹³æ€§é‡‡ç”¨TransferStack
        transferer = fair ? new TransferQueue<E>() : new TransferStack<E>();
    }
```

TransferQueueã€TransferStackç»§æ‰¿Transfererï¼ŒTransfererä¸ºSynchronousQueueçš„å†…éƒ¨ç±»ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ–¹æ³•transfer()ï¼Œè¯¥æ–¹æ³•å®šä¹‰äº†è½¬ç§»æ•°æ®çš„è§„èŒƒï¼Œå¦‚ä¸‹ï¼š

```Java
    abstract static class Transferer<E> {
        abstract E transfer(E e, boolean timed, long nanos);
    }
```

transfer()æ–¹æ³•ä¸»è¦ç”¨æ¥å®Œæˆè½¬ç§»æ•°æ®çš„ï¼Œå¦‚æœe != nullï¼Œç›¸å½“äºå°†ä¸€ä¸ªæ•°æ®äº¤ç»™æ¶ˆè´¹è€…ï¼Œå¦‚æœe == nullï¼Œåˆ™ç›¸å½“äºä»ä¸€ä¸ªç”Ÿäº§è€…æ¥æ”¶ä¸€ä¸ªæ¶ˆè´¹è€…äº¤å‡ºçš„æ•°æ®ã€‚

SynchronousQueueé‡‡ç”¨é˜Ÿåˆ—TransferQueueæ¥å®ç°å…¬å¹³æ€§ç­–ç•¥ï¼Œé‡‡ç”¨å †æ ˆTransferStackæ¥å®ç°éå…¬å¹³æ€§ç­–ç•¥ï¼Œä»–ä»¬ä¸¤ç§éƒ½æ˜¯é€šè¿‡é“¾è¡¨å®ç°çš„ï¼Œå…¶èŠ‚ç‚¹åˆ†åˆ«ä¸ºQNodeï¼ŒSNodeã€‚TransferQueueå’ŒTransferStackåœ¨SynchronousQueueä¸­æ‰®æ¼”ç€éå¸¸é‡è¦çš„ä½œç”¨ï¼ŒSynchronousQueueçš„putã€takeæ“ä½œéƒ½æ˜¯å§”æ‰˜è¿™ä¸¤ä¸ªç±»æ¥å®ç°çš„ã€‚

## TransferQueue

TransferQueueæ˜¯å®ç°å…¬å¹³æ€§ç­–ç•¥çš„æ ¸å¿ƒç±»ï¼Œå…¶èŠ‚ç‚¹ä¸ºQNodeï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```Java
    static final class TransferQueue<E> extends Transferer<E> {
        /** å¤´èŠ‚ç‚¹ */
        transient volatile QNode head;
        /** å°¾èŠ‚ç‚¹ */
        transient volatile QNode tail;
        // æŒ‡å‘ä¸€ä¸ªå–æ¶ˆçš„ç»“ç‚¹
        //å½“ä¸€ä¸ªèŠ‚ç‚¹ä¸­æœ€åä¸€ä¸ªæ’å…¥æ—¶ï¼Œå®ƒè¢«å–æ¶ˆäº†ä½†æ˜¯å¯èƒ½è¿˜æ²¡æœ‰ç¦»å¼€é˜Ÿåˆ—
        transient volatile QNode cleanMe;

        /**
         * çœç•¥å¾ˆå¤šä»£ç O(âˆ©_âˆ©)O
         */
    }
```

åœ¨TransferQueueä¸­é™¤äº†å¤´ã€å°¾èŠ‚ç‚¹å¤–è¿˜å­˜åœ¨ä¸€ä¸ªcleanMeèŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸»è¦ç”¨äºæ ‡è®°ï¼Œå½“åˆ é™¤çš„èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹æ—¶åˆ™éœ€è¦ä½¿ç”¨è¯¥èŠ‚ç‚¹ã€‚

åŒæ—¶ï¼Œå¯¹äºTransferQueueéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¶é˜Ÿåˆ—æ°¸è¿œéƒ½å­˜åœ¨ä¸€ä¸ªdummy nodeï¼Œåœ¨æ„é€ æ—¶åˆ›å»ºï¼š

```Java
        TransferQueue() {
            QNode h = new QNode(null, false); // initialize to dummy node.
            head = h;
            tail = h;
        }
```

åœ¨TransferQueueä¸­å®šä¹‰äº†QNodeç±»æ¥è¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼ŒQNodeèŠ‚ç‚¹å®šä¹‰å¦‚ä¸‹ï¼š

```Java
    static final class QNode {
        // next åŸŸ
        volatile QNode next;
        // itemæ•°æ®é¡¹
        volatile Object item;
        //  ç­‰å¾…çº¿ç¨‹ï¼Œç”¨äºpark/unpark
        volatile Thread waiter;       // to control park/unpark
        //æ¨¡å¼ï¼Œè¡¨ç¤ºå½“å‰æ˜¯æ•°æ®è¿˜æ˜¯è¯·æ±‚ï¼Œåªæœ‰å½“åŒ¹é…çš„æ¨¡å¼ç›¸åŒ¹é…æ—¶æ‰ä¼šäº¤æ¢
        final boolean isData;

        QNode(Object item, boolean isData) {
            this.item = item;
            this.isData = isData;
        }

        /**
         * CAS nextåŸŸï¼Œåœ¨TransferQueueä¸­ç”¨äºå‘nextæ¨è¿›
         */
        boolean casNext(QNode cmp, QNode val) {
            return next == cmp &&
                    UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val);
        }

        /**
         * CAS itmeæ•°æ®é¡¹
         */
        boolean casItem(Object cmp, Object val) {
            return item == cmp &&
                    UNSAFE.compareAndSwapObject(this, itemOffset, cmp, val);
        }

        /**
         *  å–æ¶ˆæœ¬ç»“ç‚¹ï¼Œå°†itemåŸŸè®¾ç½®ä¸ºè‡ªèº«
         */
        void tryCancel(Object cmp) {
            UNSAFE.compareAndSwapObject(this, itemOffset, cmp, this);
        }

        /**
         * æ˜¯å¦è¢«å–æ¶ˆ
         * ä¸tryCancelç›¸ç…§åº”åªéœ€è¦åˆ¤æ–­itemé‡Šæ”¾ç­‰äºè‡ªèº«å³å¯
         */
        boolean isCancelled() {
            return item == this;
        }


        boolean isOffList() {
            return next == this;
        }

        private static final sun.misc.Unsafe UNSAFE;
        private static final long itemOffset;
        private static final long nextOffset;

        static {
            try {
                UNSAFE = sun.misc.Unsafe.getUnsafe();
                Class<?> k = QNode.class;
                itemOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("item"));
                nextOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("next"));
            } catch (Exception e) {
                throw new Error(e);
            }
        }
    }
```

ä¸Šé¢ä»£ç æ²¡å•¥å¥½çœ‹çš„ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯isDataï¼Œè¯¥å±æ€§åœ¨è¿›è¡Œæ•°æ®äº¤æ¢èµ·åˆ°å…³é”®æ€§ä½œç”¨ï¼Œä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œæ•°æ®äº¤æ¢çš„æ—¶å€™ï¼Œå¿…é¡»è¦ä¸¤è€…çš„æ¨¡å¼ä¿æŒä¸€è‡´ã€‚

## TransferStack

TransferStackç”¨äºå®ç°éå…¬å¹³æ€§ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```Java
    static final class TransferStack<E> extends Transferer<E> {

        static final int REQUEST    = 0;

        static final int DATA       = 1;

        static final int FULFILLING = 2;

        volatile SNode head;

        /**
         * çœç•¥ä¸€å †ä»£ç   O(âˆ©_âˆ©)O~
         */

    }
```

TransferStackä¸­å®šä¹‰äº†ä¸‰ä¸ªçŠ¶æ€ï¼šREQUESTè¡¨ç¤ºæ¶ˆè´¹æ•°æ®çš„æ¶ˆè´¹è€…ï¼ŒDATAè¡¨ç¤ºç”Ÿäº§æ•°æ®çš„ç”Ÿäº§è€…ï¼ŒFULFILLINGï¼Œè¡¨ç¤ºåŒ¹é…å¦ä¸€ä¸ªç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ã€‚ä»»ä½•çº¿ç¨‹å¯¹TransferStackçš„æ“ä½œéƒ½å±äºä¸Šè¿°3ç§çŠ¶æ€ä¸­çš„ä¸€ç§ï¼ˆå¯¹åº”ç€SNodeèŠ‚ç‚¹çš„modeï¼‰ã€‚åŒæ—¶è¿˜åŒ…å«ä¸€ä¸ªheadåŸŸï¼Œè¡¨ç¤ºå¤´ç»“ç‚¹ã€‚

å†…éƒ¨èŠ‚ç‚¹SNodeå®šä¹‰å¦‚ä¸‹ï¼š

```Java
    static final class SNode {
        // next åŸŸ
        volatile SNode next;
        // ç›¸åŒ¹é…çš„èŠ‚ç‚¹
        volatile SNode match;
        // ç­‰å¾…çš„çº¿ç¨‹
        volatile Thread waiter;
        // item åŸŸ
        Object item;                // data; or null for REQUESTs

        // æ¨¡å‹
        int mode;

        /**
         * itemåŸŸå’ŒmodeåŸŸä¸éœ€è¦ä½¿ç”¨volatileä¿®é¥°ï¼Œå› ä¸ºå®ƒä»¬åœ¨volatile/atomicæ“ä½œä¹‹å‰å†™ï¼Œä¹‹åè¯»
         */

        SNode(Object item) {
            this.item = item;
        }

        boolean casNext(SNode cmp, SNode val) {
            return cmp == next &&
                    UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val);
        }

        /**
         * å°†sç»“ç‚¹ä¸æœ¬ç»“ç‚¹è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸï¼Œåˆ™unparkç­‰å¾…çº¿ç¨‹
         */
        boolean tryMatch(SNode s) {
            if (match == null &&
                    UNSAFE.compareAndSwapObject(this, matchOffset, null, s)) {
                Thread w = waiter;
                if (w != null) {    // waiters need at most one unpark
                    waiter = null;
                    LockSupport.unpark(w);
                }
                return true;
            }
            return match == s;
        }

        void tryCancel() {
            UNSAFE.compareAndSwapObject(this, matchOffset, null, this);
        }

        boolean isCancelled() {
            return match == this;
        }

        // Unsafe mechanics
        private static final sun.misc.Unsafe UNSAFE;
        private static final long matchOffset;
        private static final long nextOffset;

        static {
            try {
                UNSAFE = sun.misc.Unsafe.getUnsafe();
                Class<?> k = SNode.class;
                matchOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("match"));
                nextOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("next"));
            } catch (Exception e) {
                throw new Error(e);
            }
        }
    }
```

ä¸Šé¢ç®€å•ä»‹ç»äº†TransferQueueã€TransferStackï¼Œç”±äºSynchronousQueueçš„putã€takeæ“ä½œéƒ½æ˜¯è°ƒç”¨Transferçš„transfer()æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯ä¼ é€’çš„å‚æ•°ä¸åŒè€Œå·²ï¼Œputä¼ é€’çš„æ˜¯eå‚æ•°ï¼Œæ‰€ä»¥æ¨¡å¼ä¸ºæ•°æ®ï¼ˆå…¬å¹³isData = trueï¼Œéå…¬å¹³mode= DATAï¼‰ï¼Œè€Œtakeæ“ä½œä¼ é€’çš„æ˜¯nullï¼Œæ‰€ä»¥æ¨¡å¼ä¸ºè¯·æ±‚ï¼ˆå…¬å¹³isData = falseï¼Œéå…¬å¹³mode = REQUESTï¼‰ï¼Œå¦‚ä¸‹ï¼š

```Java
    // putæ“ä½œ
    public void put(E e) throws InterruptedException {
        if (e == null) throw new NullPointerException();
        if (transferer.transfer(e, false, 0) == null) {
            Thread.interrupted();
            throw new InterruptedException();
        }
    }

    // takeæ“ä½œ
    public E take() throws InterruptedException {
        E e = transferer.transfer(null, false, 0);
        if (e != null)
            return e;
        Thread.interrupted();
        throw new InterruptedException();
    }
```

## å…¬å¹³æ¨¡å¼

å…¬å¹³æ€§è°ƒç”¨TransferQueueçš„transferæ–¹æ³•ï¼š

```Java
    E transfer(E e, boolean timed, long nanos) {
        QNode s = null;
        // å½“å‰èŠ‚ç‚¹æ¨¡å¼
        boolean isData = (e != null);

        for (;;) {
            QNode t = tail;
            QNode h = head;
            // å¤´ã€å°¾èŠ‚ç‚¹ ä¸ºnullï¼Œæ²¡æœ‰åˆå§‹åŒ–
            if (t == null || h == null)
                continue;

            // å¤´å°¾èŠ‚ç‚¹ç›¸ç­‰ï¼ˆé˜Ÿåˆ—ä¸ºnullï¼‰ æˆ–è€…å½“å‰èŠ‚ç‚¹å’Œé˜Ÿåˆ—èŠ‚ç‚¹æ¨¡å¼ä¸€æ ·
            if (h == t || t.isData == isData) {
                // tn = t.next
                QNode tn = t.next;
                // t != tailè¡¨ç¤ºå·²æœ‰å…¶ä»–çº¿ç¨‹æ“ä½œäº†ï¼Œä¿®æ”¹äº†tailï¼Œé‡æ–°å†æ¥
                if (t != tail)
                    continue;
                // tn != nullï¼Œè¡¨ç¤ºå·²ç»æœ‰å…¶ä»–çº¿ç¨‹æ·»åŠ äº†èŠ‚ç‚¹ï¼Œtn æ¨è¿›ï¼Œé‡æ–°å¤„ç†
                if (tn != null) {
                    // å½“å‰çº¿ç¨‹å¸®å¿™æ¨è¿›å°¾èŠ‚ç‚¹ï¼Œå°±æ˜¯å°è¯•å°†tnè®¾ç½®ä¸ºå°¾èŠ‚ç‚¹
                    advanceTail(t, tn);
                    continue;
                }
                //  è°ƒç”¨çš„æ–¹æ³•çš„ wait ç±»å‹çš„, å¹¶ä¸” è¶…æ—¶äº†, ç›´æ¥è¿”å› null
                // timed åœ¨takeæ“ä½œé˜è¿°
                if (timed && nanos <= 0)
                    return null;

                // s == nullï¼Œæ„å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹Node
                if (s == null)
                    s = new QNode(e, isData);

                // å°†æ–°å»ºçš„èŠ‚ç‚¹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸æˆåŠŸï¼Œç»§ç»­å¤„ç†
                if (!t.casNext(null, s))
                    continue;

                // æ›¿æ¢å°¾èŠ‚ç‚¹
                advanceTail(t, s);

                // è°ƒç”¨awaitFulfill, è‹¥èŠ‚ç‚¹æ˜¯ head.next, åˆ™è¿›è¡Œè‡ªæ—‹
                // è‹¥ä¸æ˜¯çš„è¯, ç›´æ¥ block, ç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹ ä¸ä¹‹åŒ¹é…, æˆ–å®ƒè‡ªå·±è¿›è¡Œçº¿ç¨‹çš„ä¸­æ–­
                Object x = awaitFulfill(s, e, timed, nanos);

                // è‹¥è¿”å›çš„x == sè¡¨ç¤ºï¼Œå½“å‰çº¿ç¨‹å·²ç»è¶…æ—¶æˆ–è€…ä¸­æ–­ï¼Œä¸ç„¶çš„è¯s == nullæˆ–è€…æ˜¯åŒ¹é…çš„èŠ‚ç‚¹
                if (x == s) {
                    // æ¸…ç†èŠ‚ç‚¹S
                    clean(t, s);
                    return null;
                }

                // isOffListï¼šç”¨äºåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»ä»é˜Ÿåˆ—ä¸­ç¦»å¼€äº†
                if (!s.isOffList()) {
                    // å°è¯•å°†SèŠ‚ç‚¹è®¾ç½®ä¸ºheadï¼Œç§»å‡ºt
                    advanceHead(t, s);
                    if (x != null)
                        s.item = s;
                    // é‡Šæ”¾çº¿ç¨‹ ref
                    s.waiter = null;
                }

                // è¿”å›
                return (x != null) ? (E)x : e;

            }

            // è¿™é‡Œæ˜¯ä»head.nextå¼€å§‹ï¼Œå› ä¸ºTransferQueueæ€»æ˜¯ä¼šå­˜åœ¨ä¸€ä¸ªdummy nodeèŠ‚ç‚¹
            else {
                // èŠ‚ç‚¹
                QNode m = h.next;

                // ä¸ä¸€è‡´è¯»ï¼Œé‡æ–°å¼€å§‹
                // æœ‰å…¶ä»–çº¿ç¨‹æ›´æ”¹äº†çº¿ç¨‹ç»“æ„
                if (t != tail || m == null || h != head)
                    continue;

                /**
                 * ç”Ÿäº§è€…producerå’Œæ¶ˆè´¹è€…consumeråŒ¹é…æ“ä½œ
                 */
                Object x = m.item;
                // isData == (x != null)ï¼šåˆ¤æ–­isDataä¸xçš„æ¨¡å¼æ˜¯å¦ç›¸åŒï¼Œç›¸åŒè¡¨ç¤ºå·²ç»åŒ¹é…äº†
                // x == m ï¼šmèŠ‚ç‚¹è¢«å–æ¶ˆäº†
                // !m.casItem(x, e)ï¼šå¦‚æœå°è¯•å°†æ•°æ®eè®¾ç½®åˆ°mä¸Šå¤±è´¥
                if (isData == (x != null) ||  x  == m || !m.casItem(x, e)) {
                    // å°†mè®¾ç½®ä¸ºå¤´ç»“ç‚¹ï¼Œhå‡ºåˆ—ï¼Œç„¶åé‡è¯•
                    advanceHead(h, m);
                    continue;
                }

                // æˆåŠŸåŒ¹é…äº†ï¼Œmè®¾ç½®ä¸ºå¤´ç»“ç‚¹hå‡ºåˆ—ï¼Œå‘å‰æ¨è¿›
                advanceHead(h, m);
                // å”¤é†’mä¸Šçš„ç­‰å¾…çº¿ç¨‹
                LockSupport.unpark(m.waiter);
                return (x != null) ? (E)x : e;
            }
        }
    }
```

æ•´ä¸ªtransferçš„ç®—æ³•å¦‚ä¸‹ï¼š

1. å¦‚æœé˜Ÿåˆ—ä¸ºnullæˆ–è€…å°¾èŠ‚ç‚¹æ¨¡å¼ä¸å½“å‰èŠ‚ç‚¹æ¨¡å¼ä¸€è‡´ï¼Œåˆ™å°è¯•å°†èŠ‚ç‚¹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ˆé‡‡ç”¨è‡ªæ—‹çš„æ–¹å¼ï¼‰ï¼Œç›´åˆ°è¢«åŒ¹é…æˆ–ã€è¶…æ—¶æˆ–è€…å–æ¶ˆã€‚åŒ¹é…æˆåŠŸçš„è¯è¦ä¹ˆè¿”å›nullï¼ˆproducerè¿”å›çš„ï¼‰è¦ä¹ˆè¿”å›çœŸæ­£ä¼ é€’çš„å€¼ï¼ˆconsumerè¿”å›çš„ï¼‰ï¼Œå¦‚æœè¿”å›çš„æ˜¯nodeèŠ‚ç‚¹æœ¬èº«åˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è¶…æ—¶æˆ–è€…å–æ¶ˆäº†ã€‚
2. å¦‚æœé˜Ÿåˆ—ä¸ä¸ºnullï¼Œä¸”é˜Ÿåˆ—çš„èŠ‚ç‚¹æ˜¯å½“å‰èŠ‚ç‚¹åŒ¹é…çš„èŠ‚ç‚¹ï¼Œåˆ™è¿›è¡Œæ•°æ®çš„ä¼ é€’åŒ¹é…å¹¶è¿”å›åŒ¹é…èŠ‚ç‚¹çš„æ•°æ®
3. åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½ä¼šæ£€æµ‹å¹¶å¸®åŠ©å…¶ä»–çº¿ç¨‹æ¨è¿›

å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒèŠ‚ç‚¹å…¥åˆ—ç„¶åé€šè¿‡è°ƒç”¨awaitFulfill()æ–¹æ³•è‡ªæ—‹ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨äºè‡ªæ—‹/é˜»å¡èŠ‚ç‚¹ï¼Œç›´åˆ°èŠ‚ç‚¹è¢«åŒ¹é…è¿”å›æˆ–è€…å–æ¶ˆã€ä¸­æ–­ã€‚

```Java
    Object awaitFulfill(QNode s, E e, boolean timed, long nanos) {

        // è¶…æ—¶æ§åˆ¶
        final long deadline = timed ? System.nanoTime() + nanos : 0L;
        Thread w = Thread.currentThread();
        // è‡ªæ—‹æ¬¡æ•°
        // å¦‚æœèŠ‚ç‚¹Nodeæ°å¥½æ˜¯headèŠ‚ç‚¹ï¼Œåˆ™è‡ªæ—‹ä¸€æ®µæ—¶é—´ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†æ•ˆç‡é—®é¢˜ï¼Œå¦‚æœé‡Œé¢é˜»å¡ï¼Œä¼šå­˜åœ¨å”¤é†’ã€çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„é—®é¢˜
        // å¦‚æœç”Ÿäº§è€…ã€æ¶ˆè´¹è€…è€…é‡Œé¢åˆ°æ¥çš„è¯ï¼Œå°±é¿å…äº†è¿™ä¸ªé˜»å¡çš„è¿‡ç¨‹
        int spins = ((head.next == s) ?
                (timed ? maxTimedSpins : maxUntimedSpins) : 0);
        // è‡ªæ—‹
        for (;;) {
            // çº¿ç¨‹ä¸­æ–­äº†ï¼Œå‰”é™¤å½“å‰èŠ‚ç‚¹
            if (w.isInterrupted())
                s.tryCancel(e);

            // å¦‚æœçº¿ç¨‹è¿›è¡Œäº†é˜»å¡ -> å”¤é†’æˆ–è€…ä¸­æ–­äº†ï¼Œé‚£ä¹ˆx != e è‚¯å®šæˆç«‹ï¼Œç›´æ¥è¿”å›å½“å‰èŠ‚ç‚¹å³å¯
            Object x = s.item;
            if (x != e)
                return x;
            // è¶…æ—¶åˆ¤æ–­
            if (timed) {
                nanos = deadline - System.nanoTime();
                // å¦‚æœè¶…æ—¶äº†ï¼Œå–æ¶ˆèŠ‚ç‚¹,continueï¼Œåœ¨if(x != e)è‚¯å®šä¼šæˆç«‹ï¼Œç›´æ¥è¿”å›x
                if (nanos <= 0L) {
                    s.tryCancel(e);
                    continue;
                }
            }

            // è‡ªæ—‹- 1
            if (spins > 0)
                --spins;

            // ç­‰å¾…çº¿ç¨‹
            else if (s.waiter == null)
                s.waiter = w;

            // è¿›è¡Œæ²¡æœ‰è¶…æ—¶çš„ park
            else if (!timed)
                LockSupport.park(this);

            // è‡ªæ—‹æ¬¡æ•°è¿‡äº†, ç›´æ¥ + timeout æ–¹å¼ park
            else if (nanos > spinForTimeoutThreshold)
                LockSupport.parkNanos(this, nanos);
        }
    }
```

åœ¨è‡ªæ—‹/é˜»å¡è¿‡ç¨‹ä¸­åšäº†ä¸€ç‚¹ä¼˜åŒ–ï¼Œå°±æ˜¯åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºå¯¹å¤´å…ƒç´ ï¼Œå¦‚æœæ˜¯çš„åˆ™å…ˆè‡ªæ—‹ï¼Œå¦‚æœè‡ªæ—‹æ¬¡æ•°è¿‡äº†ï¼Œåˆ™æ‰é˜»å¡ï¼Œè¿™æ ·åšçš„ä¸»è¦ç›®çš„å°±åœ¨å¦‚æœç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ç«‹é©¬æ¥åŒ¹é…äº†åˆ™ä¸éœ€è¦é˜»å¡ï¼Œå› ä¸ºé˜»å¡ã€å”¤é†’ä¼šæ¶ˆè€—èµ„æºã€‚åœ¨æ•´ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ä¸­ä¼šä¸æ–­åˆ¤æ–­æ˜¯å¦è¶…æ—¶æˆ–è€…ä¸­æ–­äº†ï¼Œå¦‚æœä¸­æ–­æˆ–è€…è¶…æ—¶äº†åˆ™è°ƒç”¨tryCancel()å–æ¶ˆè¯¥èŠ‚ç‚¹ã€‚

**tryCancel**

```Java
            void tryCancel(Object cmp) {
                UNSAFE.compareAndSwapObject(this, itemOffset, cmp, this);
            }
```

å–æ¶ˆè¿‡ç¨‹å°±æ˜¯å°†èŠ‚ç‚¹çš„itemè®¾ç½®ä¸ºè‡ªèº«ï¼ˆitemOffsetæ˜¯itemçš„åç§»é‡ï¼‰ã€‚æ‰€ä»¥åœ¨è°ƒç”¨awaitFulfill()æ–¹æ³•æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«å–æ¶ˆã€ä¸­æ–­ã€è¶…æ—¶äº†é‚£ä¹ˆè¿”å›çš„å€¼è‚¯å®šæ—¶Sï¼Œå¦åˆ™è¿”å›çš„åˆ™æ˜¯åŒ¹é…çš„èŠ‚ç‚¹ã€‚å¦‚æœè¿”å›å€¼æ˜¯èŠ‚ç‚¹Sï¼Œé‚£ä¹ˆif(x == s)å¿…å®šæˆç«‹ï¼Œå¦‚ä¸‹ï¼š

```Java
                    Object x = awaitFulfill(s, e, timed, nanos);
                    if (x == s) {                   // wait was cancelled
                        clean(t, s);
                        return null;
                    }
```

å¦‚æœè¿”å›çš„x == sæˆç«‹ï¼Œåˆ™è°ƒç”¨clean()æ–¹æ³•æ¸…ç†èŠ‚ç‚¹Sï¼š

```Java
    void clean(QNode pred, QNode s) {
        //
        s.waiter = null;

        while (pred.next == s) {
            QNode h = head;
            QNode hn = h.next;
            // hnèŠ‚ç‚¹è¢«å–æ¶ˆäº†ï¼Œå‘å‰æ¨è¿›
            if (hn != null && hn.isCancelled()) {
                advanceHead(h, hn);
                continue;
            }

            // é˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥return null
            QNode t = tail;
            if (t == h)
                return;

            QNode tn = t.next;
            // ä¸ä¸€è‡´ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ”¹å˜äº†tailèŠ‚ç‚¹ï¼Œé‡æ–°å¼€å§‹
            if (t != tail)
                continue;

            // tn != null æ¨è¿›tailèŠ‚ç‚¹ï¼Œé‡æ–°å¼€å§‹
            if (tn != null) {
                advanceTail(t, tn);
                continue;
            }

            // s ä¸æ˜¯å°¾èŠ‚ç‚¹ ç§»å‡º
            if (s != t) {
                QNode sn = s.next;
                // å¦‚æœså·²ç»è¢«ç§»é™¤é€€å‡ºå¾ªç¯ï¼Œå¦åˆ™å°è¯•æ–­å¼€s
                if (sn == s || pred.casNext(s, sn))
                    return;
            }

            // sæ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™æœ‰å¯èƒ½ä¼šæœ‰å…¶ä»–çº¿ç¨‹åœ¨æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œåˆ™cleanMeå‡ºåœº
            QNode dp = cleanMe;
            // å¦‚æœdpä¸ä¸ºnullï¼Œè¯´æ˜æ˜¯å‰ä¸€ä¸ªè¢«å–æ¶ˆèŠ‚ç‚¹ï¼Œå°†å…¶ç§»é™¤
            if (dp != null) {
                QNode d = dp.next;
                QNode dn;
                if (d == null ||               // èŠ‚ç‚¹då·²ç»åˆ é™¤
                        d == dp ||                 // åŸæ¥çš„èŠ‚ç‚¹ cleanMe å·²ç»é€šè¿‡ advanceHead è¿›è¡Œåˆ é™¤
                        !d.isCancelled() ||        // åŸæ¥çš„èŠ‚ç‚¹ så·²ç»åˆ é™¤
                        (d != t &&                 // d ä¸æ˜¯tailèŠ‚ç‚¹
                                (dn = d.next) != null &&  //
                                dn != d &&                //   that is on list
                                dp.casNext(d, dn)))       // d unspliced
                    // æ¸…é™¤ cleanMe èŠ‚ç‚¹, è¿™é‡Œçš„ dp == pred è‹¥æˆç«‹, è¯´æ˜æ¸…é™¤èŠ‚ç‚¹sï¼ŒæˆåŠŸ, ç›´æ¥return, ä¸ç„¶çš„è¯è¦å†æ¬¡å¾ªç¯
                    casCleanMe(dp, null);
                if (dp == pred)
                    return;
            } else if (casCleanMe(null, pred))  // åŸæ¥çš„ cleanMe æ˜¯ null, åˆ™å°† pred æ ‡è®°ä¸º cleamMe ä¸ºä¸‹æ¬¡ æ¸…é™¤ s èŠ‚ç‚¹åšæ ‡è¯†
                return;
        }
    }
```

è¿™ä¸ªclean()æ–¹æ³•æ„Ÿè§‰æœ‰ç‚¹å„¿éš¾åº¦ï¼Œæˆ‘ä¹Ÿçœ‹å¾—ä¸æ˜¯å¾ˆæ‡‚ã€‚è¿™é‡Œæ˜¯å¼•ç”¨<http://www.jianshu.com/p/95cb570c8187>

1. åˆ é™¤çš„èŠ‚ç‚¹ä¸æ˜¯queueå°¾èŠ‚ç‚¹, è¿™æ—¶ ç›´æ¥ pred.casNext(s, s.next) æ–¹å¼æ¥è¿›è¡Œåˆ é™¤(å’ŒConcurrentLikedQueueä¸­å·®ä¸å¤š)
2. åˆ é™¤çš„èŠ‚ç‚¹æ˜¯é˜Ÿå°¾èŠ‚ç‚¹
   - æ­¤æ—¶ cleanMe == null, åˆ™ å‰ç»§èŠ‚ç‚¹predæ ‡è®°ä¸º cleanMe, ä¸ºä¸‹æ¬¡åˆ é™¤åšå‡†å¤‡
   - æ­¤æ—¶ cleanMe != null, å…ˆåˆ é™¤ä¸Šæ¬¡éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹, ç„¶åå°† cleanMeè‡³null, è®©åå†å°† pred èµ‹å€¼ç»™ cleanMe

## éå…¬å¹³æ¨¡å¼

éå…¬å¹³æ¨¡å¼transferæ–¹æ³•å¦‚ä¸‹ï¼š

```Java
    E transfer(E e, boolean timed, long nanos) {
        SNode s = null; // constructed/reused as needed
        int mode = (e == null) ? REQUEST : DATA;

        for (;;) {
            SNode h = head;
            // æ ˆä¸ºç©ºæˆ–è€…å½“å‰èŠ‚ç‚¹æ¨¡å¼ä¸å¤´èŠ‚ç‚¹æ¨¡å¼ä¸€æ ·ï¼Œå°†èŠ‚ç‚¹å‹å…¥æ ˆå†…ï¼Œç­‰å¾…åŒ¹é…
            if (h == null || h.mode == mode) {
                // è¶…æ—¶
                if (timed && nanos <= 0) {
                    // èŠ‚ç‚¹è¢«å–æ¶ˆäº†ï¼Œå‘å‰æ¨è¿›
                    if (h != null && h.isCancelled())
                        //  é‡æ–°è®¾ç½®å¤´ç»“ç‚¹ï¼ˆå¼¹å‡ºä¹‹å‰çš„å¤´ç»“ç‚¹ï¼‰
                        casHead(h, h.next);
                    else
                        return null;
                }
                // ä¸è¶…æ—¶
                // ç”Ÿæˆä¸€ä¸ªSNodeèŠ‚ç‚¹ï¼Œå¹¶å°è¯•æ›¿æ¢æ‰å¤´èŠ‚ç‚¹head (head -> s)
                else if (casHead(h, s = snode(s, e, h, mode))) {
                    // è‡ªæ—‹ï¼Œç­‰å¾…çº¿ç¨‹åŒ¹é…
                    SNode m = awaitFulfill(s, timed, nanos);
                    // è¿”å›çš„m == s è¡¨ç¤ºè¯¥èŠ‚ç‚¹è¢«å–æ¶ˆäº†æˆ–è€…è¶…æ—¶ã€ä¸­æ–­äº†
                    if (m == s) {
                        // æ¸…ç†èŠ‚ç‚¹Sï¼Œreturn null
                        clean(s);
                        return null;
                    }

                    // å› ä¸ºé€šè¿‡å‰é¢ä¸€æ­¥å°†Sæ›¿æ¢æˆäº†headï¼Œå¦‚æœh.next == s ï¼Œåˆ™è¡¨ç¤ºæœ‰å…¶ä»–èŠ‚ç‚¹æ’å…¥åˆ°Så‰é¢äº†,å˜æˆäº†head
                    // ä¸”è¯¥èŠ‚ç‚¹å°±æ˜¯ä¸èŠ‚ç‚¹SåŒ¹é…çš„èŠ‚ç‚¹
                    if ((h = head) != null && h.next == s)
                        // å°†s.nextèŠ‚ç‚¹è®¾ç½®ä¸ºheadï¼Œç›¸å½“äºå–æ¶ˆèŠ‚ç‚¹hã€s
                        casHead(h, s.next);

                    // å¦‚æœæ˜¯è¯·æ±‚åˆ™è¿”å›åŒ¹é…çš„åŸŸï¼Œå¦åˆ™è¿”å›èŠ‚ç‚¹Sçš„åŸŸ
                    return (E) ((mode == REQUEST) ? m.item : s.item);
                }
            }

            // å¦‚æœæ ˆä¸ä¸ºnullï¼Œä¸”ä¸¤è€…æ¨¡å¼ä¸åŒ¹é…ï¼ˆh != null && h.mode != modeï¼‰
            // è¯´æ˜ä»–ä»¬æ˜¯ä¸€é˜Ÿå¯¹ç­‰åŒ¹é…çš„èŠ‚ç‚¹ï¼Œå°è¯•ç”¨å½“å‰èŠ‚ç‚¹sæ¥æ»¡è¶³hèŠ‚ç‚¹
            else if (!isFulfilling(h.mode)) {
                // head èŠ‚ç‚¹å·²ç»å–æ¶ˆäº†ï¼Œå‘å‰æ¨è¿›
                if (h.isCancelled())
                    casHead(h, h.next);

                // å°è¯•å°†å½“å‰èŠ‚ç‚¹æ‰“ä¸Š"æ­£åœ¨åŒ¹é…"çš„æ ‡è®°ï¼Œå¹¶è®¾ç½®ä¸ºhead
                else if (casHead(h, s=snode(s, e, h, FULFILLING|mode))) {
                    // å¾ªç¯loop
                    for (;;) {
                        // sä¸ºå½“å‰èŠ‚ç‚¹ï¼Œmæ˜¯sçš„nextèŠ‚ç‚¹ï¼Œ
                        // mèŠ‚ç‚¹æ˜¯sèŠ‚ç‚¹çš„åŒ¹é…èŠ‚ç‚¹
                        SNode m = s.next;
                        // m == nullï¼Œå…¶ä»–èŠ‚ç‚¹æŠŠmèŠ‚ç‚¹åŒ¹é…èµ°äº†
                        if (m == null) {
                            // å°†så¼¹å‡º
                            casHead(s, null);
                            // å°†sç½®ç©ºï¼Œä¸‹è½®å¾ªç¯çš„æ—¶å€™è¿˜ä¼šæ–°å»º
                            s = null;
                            // é€€å‡ºè¯¥å¾ªç¯ï¼Œç»§ç»­ä¸»å¾ªç¯
                            break;
                        }
                        // è·å–mçš„nextèŠ‚ç‚¹
                        SNode mn = m.next;
                        // å°è¯•åŒ¹é…
                        if (m.tryMatch(s)) {
                            // åŒ¹é…æˆåŠŸï¼Œå°†s ã€ må¼¹å‡º
                            casHead(s, mn);     // pop both s and m
                            return (E) ((mode == REQUEST) ? m.item : s.item);
                        } else
                            // å¦‚æœæ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å·²ç»åŒ¹é…äº†ï¼ŒæŠŠmç§»å‡º
                            s.casNext(m, mn);
                    }
                }
            }
            // åˆ°è¿™æœ€åä¸€æ­¥è¯´æ˜èŠ‚ç‚¹æ­£åœ¨åŒ¹é…é˜¶æ®µ
            else {
                // head çš„nextçš„èŠ‚ç‚¹ï¼Œæ˜¯æ­£åœ¨åŒ¹é…çš„èŠ‚ç‚¹ï¼Œm å’Œ hé…å¯¹
                SNode m = h.next;

                // m == null å…¶ä»–çº¿ç¨‹æŠŠmèŠ‚ç‚¹æŠ¢èµ°äº†ï¼Œå¼¹å‡ºhèŠ‚ç‚¹
                if (m == null)
                    casHead(h, null);
                else {
                    SNode mn = m.next;
                    if (m.tryMatch(h))
                        casHead(h, mn);
                    else
                        h.casNext(m, mn);
                }
            }
        }
    }
```

æ•´ä¸ªå¤„ç†è¿‡ç¨‹åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼Œå…·ä½“å¦‚ä¸‹ï¼š

1. å¦‚æœå½“å‰æ ˆä¸ºç©ºè·å–èŠ‚ç‚¹æ¨¡å¼ä¸æ ˆé¡¶æ¨¡å¼ä¸€æ ·ï¼Œåˆ™å°è¯•å°†èŠ‚ç‚¹åŠ å…¥æ ˆå†…ï¼ŒåŒæ—¶é€šè¿‡è‡ªæ—‹æ–¹å¼ç­‰å¾…èŠ‚ç‚¹åŒ¹é…ï¼Œæœ€åè¿”å›åŒ¹é…çš„èŠ‚ç‚¹æˆ–è€…nullï¼ˆè¢«å–æ¶ˆï¼‰
2. å¦‚æœæ ˆä¸ä¸ºç©ºä¸”èŠ‚ç‚¹çš„æ¨¡å¼ä¸é¦–èŠ‚ç‚¹æ¨¡å¼åŒ¹é…ï¼Œåˆ™å°è¯•å°†è¯¥èŠ‚ç‚¹æ‰“ä¸ŠFULFILLINGæ ‡è®°ï¼Œç„¶ååŠ å…¥æ ˆä¸­ï¼Œä¸ç›¸åº”çš„èŠ‚ç‚¹åŒ¹é…ï¼ŒæˆåŠŸåå°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹å¼¹å‡ºæ ˆå¹¶è¿”å›åŒ¹é…èŠ‚ç‚¹çš„æ•°æ®
3. å¦‚æœæœ‰èŠ‚ç‚¹åœ¨åŒ¹é…ï¼Œé‚£ä¹ˆå¸®åŠ©è¿™ä¸ªèŠ‚ç‚¹å®ŒæˆåŒ¹é…å’Œå‡ºæ ˆæ“ä½œï¼Œç„¶ååœ¨ä¸»å¾ªç¯ä¸­ç»§ç»­æ‰§è¡Œ

å½“èŠ‚ç‚¹åŠ å…¥æ ˆå†…åï¼Œé€šè¿‡è°ƒç”¨awaitFulfill()æ–¹æ³•è‡ªæ—‹ç­‰å¾…èŠ‚ç‚¹åŒ¹é…ï¼š

```Java
    SNode awaitFulfill(SNode s, boolean timed, long nanos) {
        // è¶…æ—¶
        final long deadline = timed ? System.nanoTime() + nanos : 0L;
        // å½“å‰çº¿ç¨‹
        Thread w = Thread.currentThread();

        // è‡ªæ—‹æ¬¡æ•°
        // shouldSpin ç”¨äºæ£€æµ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦éœ€è¦è‡ªæ—‹
        // å¦‚æœæ ˆä¸ºç©ºã€è¯¥èŠ‚ç‚¹æ˜¯é¦–èŠ‚ç‚¹æˆ–è€…è¯¥èŠ‚ç‚¹æ˜¯åŒ¹é…èŠ‚ç‚¹ï¼Œåˆ™å…ˆé‡‡ç”¨è‡ªæ—‹ï¼Œå¦åˆ™é˜»å¡
        int spins = (shouldSpin(s) ?
                (timed ? maxTimedSpins : maxUntimedSpins) : 0);
        for (;;) {
            // çº¿ç¨‹ä¸­æ–­äº†ï¼Œå–æ¶ˆè¯¥èŠ‚ç‚¹
            if (w.isInterrupted())
                s.tryCancel();

            // åŒ¹é…èŠ‚ç‚¹
            SNode m = s.match;

            // å¦‚æœåŒ¹é…èŠ‚ç‚¹mä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºåŒ¹é…æˆåŠŸï¼Œç›´æ¥è¿”å›
            if (m != null)
                return m;
            // è¶…æ—¶
            if (timed) {
                nanos = deadline - System.nanoTime();
                // èŠ‚ç‚¹è¶…æ—¶ï¼Œå–æ¶ˆ
                if (nanos <= 0L) {
                    s.tryCancel();
                    continue;
                }
            }

            // è‡ªæ—‹;æ¯æ¬¡è‡ªæ—‹çš„æ—¶å€™éƒ½éœ€è¦æ£€æŸ¥è‡ªèº«æ˜¯å¦æ»¡è¶³è‡ªæ—‹æ¡ä»¶ï¼Œæ»¡è¶³å°± - 1ï¼Œå¦åˆ™ä¸º0
            if (spins > 0)
                spins = shouldSpin(s) ? (spins-1) : 0;

            // ç¬¬ä¸€æ¬¡é˜»å¡æ—¶ï¼Œä¼šå°†å½“å‰çº¿ç¨‹è®¾ç½®åˆ°sä¸Š
            else if (s.waiter == null)
                s.waiter = w;

            // é˜»å¡ å½“å‰çº¿ç¨‹
            else if (!timed)
                LockSupport.park(this);
            // è¶…æ—¶
            else if (nanos > spinForTimeoutThreshold)
                LockSupport.parkNanos(this, nanos);
        }
    }
```

awaitFulfill()æ–¹æ³•ä¼šä¸€ç›´è‡ªæ—‹/é˜»å¡ç›´åˆ°åŒ¹é…èŠ‚ç‚¹ã€‚åœ¨SèŠ‚ç‚¹é˜»å¡ä¹‹å‰ä¼šå…ˆè°ƒç”¨shouldSpin()æ–¹æ³•åˆ¤æ–­æ˜¯å¦é‡‡ç”¨è‡ªæ—‹æ–¹å¼ï¼Œä¸ºçš„å°±æ˜¯å¦‚æœæœ‰ç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…é©¬ä¸Šåˆ°æ¥ï¼Œå°±ä¸éœ€è¦é˜»å¡äº†ï¼Œåœ¨å¤šæ ¸æ¡ä»¶ä¸‹è¿™ç§ä¼˜åŒ–æ˜¯æœ‰å¿…è¦çš„ã€‚åŒæ—¶åœ¨è°ƒç”¨park()é˜»å¡ä¹‹å‰ä¼šå°†å½“å‰çº¿ç¨‹è®¾ç½®åˆ°SèŠ‚ç‚¹çš„waiterä¸Šã€‚åŒ¹é…æˆåŠŸï¼Œè¿”å›åŒ¹é…èŠ‚ç‚¹mã€‚

shouldSpin()æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
        boolean shouldSpin(SNode s) {
            SNode h = head;
            return (h == s || h == null || isFulfilling(h.mode));
        }
```

åŒæ—¶åœ¨é˜»å¡è¿‡ç¨‹ä¸­ä¼šä¸€ç›´æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦ä¸­æ–­äº†ï¼Œå¦‚æœä¸­æ–­äº†ï¼Œåˆ™è°ƒç”¨tryCancel()æ–¹æ³•å–æ¶ˆè¯¥èŠ‚ç‚¹ï¼Œå–æ¶ˆè¿‡ç¨‹å°±æ˜¯å°†å½“å‰èŠ‚ç‚¹çš„mathè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ã€‚æ‰€ä»¥å¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼Œé‚£ä¹ˆåœ¨è¿”å›mæ—¶ä¸€å®šæ˜¯SèŠ‚ç‚¹è‡ªèº«ã€‚

```Java
            void tryCancel() {
                UNSAFE.compareAndSwapObject(this, matchOffset, null, this);
            }
```

awaitFullfill()æ–¹æ³•å¦‚æœè¿”å›çš„m == sï¼Œåˆ™è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»ä¸­æ–­å–æ¶ˆäº†ï¼Œåˆ™éœ€è¦è°ƒç”¨clean()æ–¹æ³•ï¼Œæ¸…ç†èŠ‚ç‚¹Sï¼š

```Java
    void clean(SNode s) {

        // æ¸…ç†itemåŸŸ
        s.item = null;
        // æ¸…ç†waiteråŸŸ
        s.waiter = null;

        // pastèŠ‚ç‚¹
        SNode past = s.next;
        if (past != null && past.isCancelled())
            past = past.next;

        // ä»æ ˆé¡¶headèŠ‚ç‚¹ï¼Œå–æ¶ˆä»æ ˆé¡¶headåˆ°pastèŠ‚ç‚¹ä¹‹é—´æ‰€æœ‰å·²ç»å–æ¶ˆçš„èŠ‚ç‚¹
        // æ³¨æ„ï¼šè¿™é‡Œå¦‚æœé‡åˆ°ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å–æ¶ˆï¼Œåˆ™ä¼šé€€å‡ºwhile
        SNode p;
        while ((p = head) != null && p != past && p.isCancelled())
            casHead(p, p.next);     // å¦‚æœpèŠ‚ç‚¹å·²ç»å–æ¶ˆäº†ï¼Œåˆ™å‰”é™¤è¯¥èŠ‚ç‚¹

        // å¦‚æœç»å†ä¸Šé¢while pèŠ‚ç‚¹è¿˜æ²¡æœ‰å–æ¶ˆï¼Œåˆ™å†æ¬¡å¾ªç¯å–æ¶ˆæ‰æ‰€æœ‰p åˆ°pastä¹‹é—´çš„å–æ¶ˆèŠ‚ç‚¹
        while (p != null && p != past) {
            SNode n = p.next;
            if (n != null && n.isCancelled())
                p.casNext(n, n.next);
            else
                p = n;
        }
    }
```

clean()æ–¹æ³•å°±æ˜¯å°†headèŠ‚ç‚¹åˆ°SèŠ‚ç‚¹ä¹‹é—´æ‰€æœ‰å·²ç»å–æ¶ˆçš„èŠ‚ç‚¹å…¨éƒ¨ç§»å‡ºã€‚ã€ä¸æ¸…æ¥šä¸ºä½•è¦ç”¨ä¸¤ä¸ªwhileï¼Œä¸€ä¸ªä¸è¡Œä¹ˆã€‘

### å®ä¾‹åˆ†æ

æˆ‘ä»¬åœ¨ç»“åˆä¸€ä¸ªå®ä¾‹å¯¹ä¸Šé¢ä»£ç è¿›è¡Œåˆ†æï¼Œè¿™æ ·å°±ä¼šæ›´å¥½ç†è§£äº†

**ä¸ªäººæ„Ÿè§‰SynchronousQueueå®ç°å¥½å¤æ‚ï¼ˆå¯èƒ½æ˜¯è‡ªå·±æ™ºå•†ä¸å¤Ÿå§~~~~(>_<)~~~~ï¼‰ï¼Œæºç çœ‹äº†å¥½ä¹…ï¼Œè¿™ç¯‡åšå®¢å†™äº†å°†è¿‘ä¸€ä¸ªæ˜ŸæœŸï¼Œå¦‚æœæœ‰ä»€ä¹ˆé”™è¯¯ä¹‹å¤„ï¼Œçƒ¦è¯·å„ä½æŒ‡æ­£ï¼ï¼**

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)