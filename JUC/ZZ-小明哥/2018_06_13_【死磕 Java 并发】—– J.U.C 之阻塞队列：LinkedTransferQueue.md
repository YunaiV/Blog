title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹é˜»å¡é˜Ÿåˆ—ï¼šLinkedTransferQueue
date: 2018-06-13
tag:
categories: JUC
permalink: JUC/sike/LinkedTransferQueue
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2433
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2433 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [LinkedTransferQueue](http://www.iocoder.cn//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

å‰é¢æåˆ°çš„å„ç§BlockingQueueå¯¹è¯»æˆ–è€…å†™éƒ½æ˜¯é”ä¸Šæ•´ä¸ªé˜Ÿåˆ—ï¼Œåœ¨å¹¶å‘é‡å¤§çš„æ—¶å€™ï¼Œå„ç§é”æ˜¯æ¯”è¾ƒè€—èµ„æºå’Œè€—æ—¶é—´çš„ï¼Œè€Œå‰é¢çš„SynchronousQueueè™½ç„¶ä¸ä¼šé”ä½æ•´ä¸ªé˜Ÿåˆ—ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªæ²¡æœ‰å®¹é‡çš„â€œé˜Ÿåˆ—â€ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰è¿™æ ·ä¸€ç§é˜Ÿåˆ—ï¼Œå®ƒå³å¯ä»¥åƒå…¶ä»–çš„BlockingQueueä¸€æ ·æœ‰å®¹é‡åˆå¯ä»¥åƒSynchronousQueueä¸€æ ·ä¸ä¼šé”ä½æ•´ä¸ªé˜Ÿåˆ—å‘¢ï¼Ÿæœ‰ï¼ç­”æ¡ˆå°±æ˜¯LinkedTransferQueueã€‚

LinkedTransferQueueæ˜¯åŸºäºé“¾è¡¨çš„FIFOæ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œå®ƒå‡ºç°åœ¨JDK7ä¸­ã€‚Doug Lea å¤§ç¥è¯´**LinkedTransferQueueæ˜¯ä¸€ä¸ªèªæ˜çš„é˜Ÿåˆ—**ã€‚å®ƒæ˜¯[ConcurrentLinkedQueue](http://cmsblogs.com/?p=2353)ã€[SynchronousQueue](http://cmsblogs.com/?p=2418) (å…¬å¹³æ¨¡å¼ä¸‹)ã€æ— ç•Œçš„[LinkedBlockingQueues](http://cmsblogs.com/?p=2381)ç­‰çš„è¶…é›†ã€‚æ—¢ç„¶è¿™ä¹ˆç‰›é€¼ï¼Œé‚£åŠ¿å¿…è¦å¼„æ¸…æ¥šå…¶ä¸­çš„åŸç†äº†ã€‚

## LinkedTransferQueue

çœ‹æºç ä¹‹å‰æˆ‘ä»¬å…ˆç¨å¾®äº†è§£ä¸‹å®ƒçš„åŸç†ï¼Œè¿™æ ·çœ‹æºç å°±ä¼šæœ‰è¿¹å¯å¾ªäº†ã€‚

LinkedTransferQueueé‡‡ç”¨ä¸€ç§**é¢„å æ¨¡å¼**ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæœ‰å°±ç›´æ¥æ‹¿èµ°ï¼Œæ²¡æœ‰å°±å ç€è¿™ä¸ªä½ç½®ç›´åˆ°æ‹¿åˆ°æˆ–è€…è¶…æ—¶æˆ–è€…ä¸­æ–­ã€‚å³æ¶ˆè´¹è€…çº¿ç¨‹åˆ°é˜Ÿåˆ—ä¸­å–å…ƒç´ æ—¶ï¼Œå¦‚æœå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šç”Ÿæˆä¸€ä¸ªnullèŠ‚ç‚¹ï¼Œç„¶åparkä½ç­‰å¾…ç”Ÿäº§è€…ã€‚åé¢å¦‚æœç”Ÿäº§è€…çº¿ç¨‹å…¥é˜Ÿæ—¶å‘ç°æœ‰ä¸€ä¸ªnullå…ƒç´ èŠ‚ç‚¹ï¼Œè¿™æ—¶ç”Ÿäº§è€…å°±ä¸ä¼šå…¥åˆ—äº†ï¼Œç›´æ¥å°†å…ƒç´ å¡«å……åˆ°è¯¥èŠ‚ç‚¹ä¸Šï¼Œå”¤é†’è¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„æ¶ˆè´¹è€…çº¿ç¨‹æ‹¿ä¸œè¥¿èµ°äººã€‚æ˜¯ä¸æ˜¯æœ‰ç‚¹å„¿[SynchronousQueue](http://cmsblogs.com/?p=2418)çš„å‘³é“ï¼Ÿ

### ç»“æ„

LinkedTransferQueueä¸å…¶ä»–çš„BlockingQueueä¸€æ ·ï¼ŒåŒæ ·ç»§æ‰¿AbstractQueueç±»ï¼Œä½†æ˜¯å®ƒå®ç°äº†TransferQueueï¼ŒTransferQueueæ¥å£ç»§æ‰¿BlockingQueueï¼Œæ‰€ä»¥TransferQueueç®—æ˜¯å¯¹BlockingQueueä¸€ç§æ‰©å……ï¼Œè¯¥æ¥å£æä¾›äº†ä¸€æ•´å¥—çš„transferæ¥å£ï¼š

```Java
    public interface TransferQueue<E> extends BlockingQueue<E> {

        /**
         * è‹¥å½“å‰å­˜åœ¨ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼ˆä½¿ç”¨take()æˆ–è€…poll()å‡½æ•°ï¼‰ï¼Œä½¿ç”¨è¯¥æ–¹æ³•ä¼šå³åˆ»è½¬ç§»/ä¼ è¾“å¯¹è±¡å…ƒç´ eï¼›
         * è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›falseï¼Œå¹¶ä¸”ä¸è¿›å…¥é˜Ÿåˆ—ã€‚è¿™æ˜¯ä¸€ä¸ªä¸é˜»å¡çš„æ“ä½œ
         */
        boolean tryTransfer(E e);

        /**
         * è‹¥å½“å‰å­˜åœ¨ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå³ç«‹åˆ»ç§»äº¤ä¹‹ï¼›
         * å¦åˆ™ï¼Œä¼šæ’å…¥å½“å‰å…ƒç´ eåˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶ä¸”ç­‰å¾…è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œåˆ°æœ‰æ¶ˆè´¹è€…çº¿ç¨‹å–èµ°è¯¥å…ƒç´ 
         */
        void transfer(E e) throws InterruptedException;

        /**
         * è‹¥å½“å‰å­˜åœ¨ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä¼šç«‹å³ä¼ è¾“ç»™å®ƒ;å¦åˆ™å°†æ’å…¥å…ƒç´ eåˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶ä¸”ç­‰å¾…è¢«æ¶ˆè´¹è€…çº¿ç¨‹è·å–æ¶ˆè´¹æ‰ï¼›
         * è‹¥åœ¨æŒ‡å®šçš„æ—¶é—´å†…å…ƒç´ eæ— æ³•è¢«æ¶ˆè´¹è€…çº¿ç¨‹è·å–ï¼Œåˆ™è¿”å›falseï¼ŒåŒæ—¶è¯¥å…ƒç´ è¢«ç§»é™¤ã€‚
         */
        boolean tryTransfer(E e, long timeout, TimeUnit unit)
                throws InterruptedException;

        /**
         * åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ¶ˆè´¹è€…çº¿ç¨‹
         */
        boolean hasWaitingConsumer();

        /**
         * è·å–æ‰€æœ‰ç­‰å¾…è·å–å…ƒç´ çš„æ¶ˆè´¹çº¿ç¨‹æ•°é‡
         */
        int getWaitingConsumerCount();
    }
```

ç›¸å¯¹äºå…¶ä»–çš„BlockingQueueï¼ŒLinkedTransferQueueå°±å¤šäº†ä¸Šé¢å‡ ä¸ªæ–¹æ³•ã€‚è¿™å‡ ä¸ªæ–¹æ³•åœ¨LinkedTransferQueueä¸­èµ·åˆ°äº†æ ¸å¿ƒä½œç”¨ã€‚

LinkedTransferQueueå®šä¹‰çš„å˜é‡å¦‚ä¸‹ï¼š

```Java
    // åˆ¤æ–­æ˜¯å¦ä¸ºå¤šæ ¸
    private static final boolean MP =
            Runtime.getRuntime().availableProcessors() > 1;

    // è‡ªæ—‹æ¬¡æ•°
    private static final int FRONT_SPINS   = 1 << 7;

    // å‰é©±èŠ‚ç‚¹æ­£åœ¨å¤„ç†ï¼Œå½“å‰èŠ‚ç‚¹éœ€è¦è‡ªæ—‹çš„æ¬¡æ•°
    private static final int CHAINED_SPINS = FRONT_SPINS >>> 1;

    static final int SWEEP_THRESHOLD = 32;

    // å¤´èŠ‚ç‚¹
    transient volatile Node head;

    // å°¾èŠ‚ç‚¹
    private transient volatile Node tail;

    // åˆ é™¤èŠ‚ç‚¹å¤±è´¥çš„æ¬¡æ•°
    private transient volatile int sweepVotes;

    /*
     * è°ƒç”¨xfer()æ–¹æ³•æ—¶éœ€è¦ä¼ å…¥,åŒºåˆ†ä¸åŒå¤„ç†
     * xfer()æ–¹æ³•æ˜¯LinkedTransferQueueçš„æœ€æ ¸å¿ƒçš„æ–¹æ³•
     */
    private static final int NOW   = 0; // for untimed poll, tryTransfer
    private static final int ASYNC = 1; // for offer, put, add
    private static final int SYNC  = 2; // for transfer, take
    private static final int TIMED = 3; // for timed poll, tryTransfer
```

### NodeèŠ‚ç‚¹

NodeèŠ‚ç‚¹ç”±å››ä¸ªéƒ¨åˆ†æ„æˆï¼š

- isDataï¼šè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯å­˜æ”¾æ•°æ®è¿˜æ˜¯è·å–æ•°æ®
- itemï¼šå­˜æ”¾æ•°æ®ï¼ŒisDataä¸ºfalseæ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸ºnullï¼Œä¸ºtrueæ—¶ï¼ŒåŒ¹é…åï¼Œè¯¥èŠ‚ç‚¹ä¼šç½®ä¸ºnull
- nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
- waiterï¼šparkä½æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œçº¿ç¨‹å°±æ”¾åœ¨è¿™é‡Œ

ç»“æ„å¦‚ä¸‹ï¼š

![è¿™é‡Œå†™å›¾ç‰‡æè¿°](http://static.iocoder.cn/csdn/20170924210642971?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hlbnNzeQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
æºç å¦‚ä¸‹ï¼š

```Java
    static final class Node {
        // è¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯å­˜æ”¾æ•°æ®è¿˜æ˜¯è·å–æ•°æ®
        final boolean isData;
        // å­˜æ”¾æ•°æ®ï¼ŒisDataä¸ºfalseæ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸ºnullï¼Œä¸ºtrueæ—¶ï¼ŒåŒ¹é…åï¼Œè¯¥èŠ‚ç‚¹ä¼šç½®ä¸ºnull
        volatile Object item;
        //æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        volatile Node next;

        // parkä½æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œçº¿ç¨‹å°±æ”¾åœ¨è¿™é‡Œ
        volatile Thread waiter; // null until waiting

        /**
         * CAS NextåŸŸ
         */
        final boolean casNext(Node cmp, Node val) {
            return UNSAFE.compareAndSwapObject(this, nextOffset, cmp, val);
        }

        /**
         * CAS itmeåŸŸ
         */
        final boolean casItem(Object cmp, Object val) {
            return UNSAFE.compareAndSwapObject(this, itemOffset, cmp, val);
        }

        /**
         * æ„é€ å‡½æ•°
         */
        Node(Object item, boolean isData) {
            UNSAFE.putObject(this, itemOffset, item); // relaxed write
            this.isData = isData;
        }

        /**
         * å°†nextåŸŸæŒ‡å‘è‡ªèº«ï¼Œå…¶å®å°±æ˜¯å‰”é™¤èŠ‚ç‚¹
         */
        final void forgetNext() {
            UNSAFE.putObject(this, nextOffset, this);
        }

        /**
         *  åŒ¹é…è¿‡æˆ–èŠ‚ç‚¹è¢«å–æ¶ˆçš„æ—¶å€™ä¼šè°ƒç”¨
         */
        final void forgetContents() {
            UNSAFE.putObject(this, itemOffset, this);
            UNSAFE.putObject(this, waiterOffset, null);
        }

        /**
         * æ ¡éªŒèŠ‚ç‚¹æ˜¯å¦åŒ¹é…è¿‡ï¼Œå¦‚æœåŒ¹é…åšå–æ¶ˆäº†ï¼Œitemåˆ™ä¼šå‘ç”Ÿå˜åŒ–
         */
        final boolean isMatched() {
            Object x = item;
            return (x == this) || ((x == null) == isData);
        }

        /**
         * æ˜¯å¦æ˜¯ä¸€ä¸ªæœªåŒ¹é…çš„è¯·æ±‚èŠ‚ç‚¹
         * å¦‚æœæ˜¯çš„è¯isDataåº”ä¸ºfalseï¼Œitem == nullï¼Œå› ä½å¦‚æœåŒ¹é…äº†ï¼Œitemåˆ™ä¼šæœ‰å€¼
         */
        final boolean isUnmatchedRequest() {
            return !isData && item == null;
        }

        /**
         * å¦‚ç»™å®šèŠ‚ç‚¹ç±»å‹ä¸èƒ½æŒ‚åœ¨å½“å‰èŠ‚ç‚¹åè¿”å›true
         */
        final boolean cannotPrecede(boolean haveData) {
            boolean d = isData;
            Object x;
            return d != haveData && (x = item) != this && (x != null) == d;
        }

        /**
         * åŒ¹é…ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹
         */
        final boolean tryMatchData() {
            // assert isData;
            Object x = item;
            if (x != null && x != this && casItem(x, null)) {
                LockSupport.unpark(waiter);
                return true;
            }
            return false;
        }

        private static final long serialVersionUID = -3375979862319811754L;

        // Unsafe mechanics
        private static final sun.misc.Unsafe UNSAFE;
        private static final long itemOffset;
        private static final long nextOffset;
        private static final long waiterOffset;
        static {
            try {
                UNSAFE = sun.misc.Unsafe.getUnsafe();
                Class<?> k = Node.class;
                itemOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("item"));
                nextOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("next"));
                waiterOffset = UNSAFE.objectFieldOffset
                        (k.getDeclaredField("waiter"));
            } catch (Exception e) {
                throw new Error(e);
            }
        }
    }
```

èŠ‚ç‚¹Nodeä¸ºLinkedTransferQueueçš„å†…éƒ¨ç±»ï¼Œå…¶å†…éƒ¨ç»“æ„å’Œå…¬å¹³æ–¹å¼çš„SynchronousQueueå·®ä¸å¤šï¼Œé‡Œé¢ä¹ŸåŒæ ·æä¾›äº†ä¸€äº›å¾ˆé‡è¦çš„æ–¹æ³•ã€‚

### putæ“ä½œ

LinkedTransferQueueæä¾›äº†addã€putã€offerä¸‰ç±»æ–¹æ³•ï¼Œç”¨äºå°†å…ƒç´ æ’å…¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚ä¸‹ï¼š

```Java
    public void put(E e) {
        xfer(e, true, ASYNC, 0);
    }

    public boolean offer(E e, long timeout, TimeUnit unit) {
        xfer(e, true, ASYNC, 0);
        return true;
    }

    public boolean offer(E e) {
        xfer(e, true, ASYNC, 0);
        return true;
    }

    public boolean add(E e) {
        xfer(e, true, ASYNC, 0);
        return true;
    }
```

ç”±äºLinkedTransferQueueæ˜¯æ— ç•Œçš„ï¼Œä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨xferæ–¹æ³•æ˜¯ä¼ å…¥çš„æ˜¯ASYNCï¼ŒåŒæ—¶ç›´æ¥è¿”å›true.

### takeæ“ä½œ

LinkedTransferQueueæä¾›äº†pollã€takeæ–¹æ³•ç”¨äºå‡ºåˆ—å…ƒç´ ï¼š

```Java
    public E take() throws InterruptedException {
        E e = xfer(null, false, SYNC, 0);
        if (e != null)
            return e;
        Thread.interrupted();
        throw new InterruptedException();
    }

    public E poll() {
        return xfer(null, false, NOW, 0);
    }

    public E poll(long timeout, TimeUnit unit) throws InterruptedException {
        E e = xfer(null, false, TIMED, unit.toNanos(timeout));
        if (e != null || !Thread.interrupted())
            return e;
        throw new InterruptedException();
    }
```

è¿™é‡Œå’Œputæ“ä½œæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œtake()æ–¹æ³•ä¼ å…¥çš„æ˜¯SYNCï¼Œé˜»å¡ã€‚poll()ä¼ å…¥çš„æ˜¯NOWï¼Œpoll(long timeout, TimeUnit unit)åˆ™æ˜¯ä¼ å…¥TIMEDã€‚

### tranferæ“ä½œ

å®ç°TransferQueueæ¥å£ï¼Œå°±è¦å®ç°å®ƒçš„æ–¹æ³•ï¼š

```Java
public boolean tryTransfer(E e, long timeout, TimeUnit unit)
    throws InterruptedException {
    if (xfer(e, true, TIMED, unit.toNanos(timeout)) == null)
        return true;
    if (!Thread.interrupted())
        return false;
    throw new InterruptedException();
}

public void transfer(E e) throws InterruptedException {
    if (xfer(e, true, SYNC, 0) != null) {
        Thread.interrupted(); // failure possible only due to interrupt
        throw new InterruptedException();
    }
}

public boolean tryTransfer(E e) {
    return xfer(e, true, NOW, 0) == null;
}
```

### xfer()

é€šè¿‡ä¸Šé¢å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç æˆ‘ä»¬æ¸…æ¥šå¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨xfer()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—å››ä¸ªå‚æ•°ï¼Œitemæˆ–è€…nullçš„Eï¼Œputæ“ä½œä¸ºtrueã€takeæ“ä½œä¸ºfalseçš„havaDataï¼Œhowï¼ˆæœ‰å››ä¸ªå€¼NOW, ASYNC, SYNC, or TIMEDï¼Œåˆ†åˆ«è¡¨ç¤ºä¸åŒçš„æ“ä½œï¼‰ï¼Œè¶…æ—¶nanosã€‚

```Java
    private E xfer(E e, boolean haveData, int how, long nanos) {

        // havaDataä¸ºtrueï¼Œä½†æ˜¯e == null æŠ›å‡ºç©ºæŒ‡é’ˆ
        if (haveData && (e == null))
            throw new NullPointerException();
        Node s = null;                        // the node to append, if needed

        retry:
        for (;;) {

            // ä»é¦–èŠ‚ç‚¹å¼€å§‹åŒ¹é…
            // p == null é˜Ÿåˆ—ä¸ºç©º
            for (Node h = head, p = h; p != null;) {

                // æ¨¡å‹ï¼Œrequest or data
                boolean isData = p.isData;
                // itemåŸŸ
                Object item = p.item;

                // æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰åŒ¹é…çš„èŠ‚ç‚¹
                // item != p ä¹Ÿå°±æ˜¯è‡ªèº«ï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰åŒ¹é…è¿‡
                // (item != null) == isDataï¼Œè¡¨ç¤ºæ¨¡å‹ç¬¦åˆ
                if (item != p && (item != null) == isData) {

                    // èŠ‚ç‚¹ç±»å‹å’Œå¾…å¤„ç†ç±»å‹ä¸€è‡´ï¼Œè¿™æ ·è‚¯å®šæ˜¯ä¸èƒ½åŒ¹é…çš„
                    if (isData == haveData)   // can't match
                        break;
                    // åŒ¹é…ï¼Œå°†EåŠ å…¥åˆ°itemåŸŸä¸­
                    // å¦‚æœp çš„itemä¸ºdataï¼Œé‚£ä¹ˆeä¸ºnull,å¦‚æœpçš„itemä¸ºnullï¼Œé‚£ä¹ˆeä¸ºdata
                    if (p.casItem(item, e)) { // match
                        //
                        for (Node q = p; q != h;) {
                            Node n = q.next;  // update by 2 unless singleton
                            if (head == h && casHead(h, n == null ? q : n)) {
                                h.forgetNext();
                                break;
                            }                 // advance and retry
                            if ((h = head)   == null ||
                                    (q = h.next) == null || !q.isMatched())
                                break;        // unless slack < 2
                        }

                        // åŒ¹é…åå”¤é†’pçš„waiterçº¿ç¨‹;reservationåˆ™å«äººæ”¶è´§ï¼Œdataåˆ™å«nullæ”¶è´§
                        LockSupport.unpark(p.waiter);
                        return LinkedTransferQueue.<E>cast(item);
                    }
                }
                // å¦‚æœå·²ç»åŒ¹é…äº†åˆ™å‘å‰æ¨è¿›
                Node n = p.next;
                // å¦‚æœpçš„nextæŒ‡å‘pæœ¬èº«ï¼Œè¯´æ˜pèŠ‚ç‚¹å·²ç»æœ‰å…¶ä»–çº¿ç¨‹å¤„ç†è¿‡äº†ï¼Œåªèƒ½ä»headé‡æ–°å¼€å§‹
                p = (p != n) ? n : (h = head); // Use head if p offlist
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç‚¹ï¼Œåˆ™è¿›è¡Œå¤„ç†
            // NOWä¸ºuntimed poll, tryTransferï¼Œä¸éœ€è¦å…¥é˜Ÿ
            if (how != NOW) {                 // No matches available
                // s == nullï¼Œæ–°å»ºä¸€ä¸ªèŠ‚ç‚¹
                if (s == null)
                    s = new Node(e, haveData);
                // å…¥é˜Ÿï¼Œè¿”å›å‰é©±èŠ‚ç‚¹
                Node pred = tryAppend(s, haveData);
                // è¿”å›çš„å‰é©±èŠ‚ç‚¹ä¸ºnullï¼Œé‚£å°±æ˜¯æœ‰raceï¼Œè¢«å…¶ä»–çš„æŠ¢äº†ï¼Œé‚£å°±continue æ•´ä¸ªfor
                if (pred == null)
                    continue retry;

                // ASYNCä¸éœ€è¦é˜»å¡ç­‰å¾…
                if (how != ASYNC)
                    return awaitMatch(s, pred, e, (how == TIMED), nanos);
            }
            return e;
        }
    }
```

æ•´ä¸ªç®—æ³•çš„æ ¸å¿ƒå°±æ˜¯å¯»æ‰¾åŒ¹é…èŠ‚ç‚¹æ‰¾åˆ°äº†å°±è¿”å›ï¼Œå¦åˆ™å°±å…¥é˜Ÿï¼ˆNOWç›´æ¥è¿”å›ï¼‰ï¼š

- matchedã€‚åˆ¤æ–­åŒ¹é…æ¡ä»¶ï¼ˆisDataä¸ä¸€æ ·ï¼Œæœ¬èº«æ²¡æœ‰åŒ¹é…ï¼‰ï¼ŒåŒ¹é…åå°±casItemï¼Œç„¶åunparkåŒ¹é…èŠ‚ç‚¹çš„waiterçº¿ç¨‹ï¼Œå¦‚æœæ˜¯reservationåˆ™å«äººæ”¶è´§ï¼Œdataåˆ™å«nullæ”¶è´§ã€‚
- unmatchedã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…èŠ‚ç‚¹ï¼Œåˆ™æ ¹æ®ä¼ å…¥çš„howæ¥å¤„ç†ï¼ŒNOWç›´æ¥è¿”å›ï¼Œå…¶ä½™ä¸‰ç§å…ˆå…¥å¯¹ï¼Œå…¥é˜Ÿåå¦‚æœæ˜¯ASYNCåˆ™è¿”å›ï¼ŒSYNCå’ŒTIMEDåˆ™ä¼šé˜»å¡ç­‰å¾…åŒ¹é…ã€‚

å…¶å®ç›¸å½“äºSynchronousQueueæ¥è¯´ï¼Œè¿™ä¸ªå¤„ç†é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚

å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…èŠ‚ç‚¹ï¼Œä¸”how != NOWä¼šå…¥é˜Ÿï¼Œå…¥é˜Ÿåˆ™æ˜¯è°ƒç”¨tryAppendæ–¹æ³•ï¼š

```Java
    private Node tryAppend(Node s, boolean haveData) {
        // ä»å°¾èŠ‚ç‚¹tailå¼€å§‹
        for (Node t = tail, p = t;;) {
            Node n, u;

            // é˜Ÿåˆ—ä¸ºç©ºåˆ™å°†èŠ‚ç‚¹Sè®¾ç½®ä¸ºhead
            if (p == null && (p = head) == null) {
                if (casHead(null, s))
                    return s;
            }

            // å¦‚æœä¸ºdata
            else if (p.cannotPrecede(haveData))
                return null;

            // ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹
            else if ((n = p.next) != null)
                p = p != t && t != (u = tail) ? (t = u) : (p != n) ? n : null;
            // CASå¤±è´¥ï¼Œä¸€èˆ¬æ¥è¯´å¤±è´¥çš„åŸå› åœ¨äºp.next != nullï¼Œå¯èƒ½æœ‰å…¶ä»–å¢åŠ äº†tailï¼Œå‘å‰æ¨è
            else if (!p.casNext(null, s))
                p = p.next;                   // re-read on CAS failure
            else {
                if (p != t) {                 // update if slack now >= 2
                    while ((tail != t || !casTail(t, s)) &&
                            (t = tail)   != null &&
                            (s = t.next) != null && // advance and retry
                            (s = s.next) != null && s != t);
                }
                return p;
            }
        }
    }
```

tryAppendæ–¹æ³•æ˜¯å°†SèŠ‚ç‚¹æ·»åŠ åˆ°tailä¸Šï¼Œç„¶åè¿”å›å…¶å‰é©±èŠ‚ç‚¹ã€‚å¥½å§ï¼Œæˆ‘æ‰¿è®¤è¿™æ®µä»£ç æˆ‘çœ‹çš„æœ‰ç‚¹å„¿æ™•ï¼ï¼ï¼

åŠ å…¥é˜Ÿåˆ—åï¼Œå¦‚æœhowè¿˜ä¸æ˜¯ASYNCåˆ™è°ƒç”¨awaitMatch()æ–¹æ³•é˜»å¡ç­‰å¾…ï¼š

```Java
    private E awaitMatch(Node s, Node pred, E e, boolean timed, long nanos) {
        // è¶…æ—¶æ§åˆ¶
        final long deadline = timed ? System.nanoTime() + nanos : 0L;

        // å½“å‰çº¿ç¨‹
        Thread w = Thread.currentThread();

        // è‡ªæ—‹æ¬¡æ•°
        int spins = -1; // initialized after first item and cancel checks

        // éšæœºæ•°
        ThreadLocalRandom randomYields = null; // bound if needed

        for (;;) {
            Object item = s.item;
            //åŒ¹é…äº†ï¼Œå¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹åŒ¹é…äº†çº¿ç¨‹
            if (item != e) {
                // æ’¤é”€è¯¥èŠ‚ç‚¹
                s.forgetContents();
                return LinkedTransferQueue.<E>cast(item);
            }

            // çº¿ç¨‹ä¸­æ–­æˆ–è€…è¶…æ—¶äº†ã€‚åˆ™è°ƒç”¨å°†sèŠ‚ç‚¹itemè®¾ç½®ä¸ºeï¼Œç­‰å¾…å–æ¶ˆ
            if ((w.isInterrupted() || (timed && nanos <= 0)) && s.casItem(e, s)) {        // cancel
                // æ–­å¼€èŠ‚ç‚¹
                unsplice(pred, s);
                return e;
            }

            // è‡ªæ—‹
            if (spins < 0) {
                // è®¡ç®—è‡ªæ—‹æ¬¡æ•°
                if ((spins = spinsFor(pred, s.isData)) > 0)
                    randomYields = ThreadLocalRandom.current();
            }

            // è‡ªæ—‹
            else if (spins > 0) {
                --spins;
                // ç”Ÿæˆçš„éšæœºæ•° == 0 ï¼Œåœæ­¢çº¿ç¨‹ï¼Ÿä¸æ˜¯å¾ˆæ˜ç™½....
                if (randomYields.nextInt(CHAINED_SPINS) == 0)
                    Thread.yield();
            }

            // å°†å½“å‰çº¿ç¨‹è®¾ç½®åˆ°èŠ‚ç‚¹çš„waiteråŸŸ
            // ä¸€å¼€å§‹s.waiter == null è‚¯å®šæ˜¯ä¼šæˆç«‹çš„ï¼Œ
            else if (s.waiter == null) {
                s.waiter = w;                 // request unpark then recheck
            }

            // è¶…æ—¶é˜»å¡
            else if (timed) {
                nanos = deadline - System.nanoTime();
                if (nanos > 0L)
                    LockSupport.parkNanos(this, nanos);
            }
            else {
                // ä¸æ˜¯è¶…æ—¶é˜»å¡
                LockSupport.park(this);
            }
        }
    }
```

æ•´ä¸ªawaitMatchè¿‡ç¨‹å’ŒSynchronousQueueçš„awaitFulfillæ²¡æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œä¸è¿‡åœ¨è‡ªæ—‹è¿‡ç¨‹ä¼šè°ƒç”¨Thread.yield();è¿™æ˜¯å¹²å˜›ï¼Ÿ

åœ¨awaitMatchè¿‡ç¨‹ä¸­ï¼Œå¦‚æœçº¿ç¨‹ä¸­æ–­äº†ï¼Œæˆ–è€…è¶…æ—¶äº†åˆ™ä¼šè°ƒç”¨unsplice()æ–¹æ³•å»é™¤è¯¥èŠ‚ç‚¹ï¼š

```Java
    final void unsplice(Node pred, Node s) {
        s.forgetContents(); // forget unneeded fields

        if (pred != null && pred != s && pred.next == s) {
            Node n = s.next;
            if (n == null ||
                    (n != s && pred.casNext(s, n) && pred.isMatched())) {

                for (;;) {               // check if at, or could be, head
                    Node h = head;
                    if (h == pred || h == s || h == null)
                        return;          // at head or list empty
                    if (!h.isMatched())
                        break;
                    Node hn = h.next;
                    if (hn == null)
                        return;          // now empty
                    if (hn != h && casHead(h, hn))
                        h.forgetNext();  // advance head
                }
                if (pred.next != pred && s.next != s) { // recheck if offlist
                    for (;;) {           // sweep now if enough votes
                        int v = sweepVotes;
                        if (v < SWEEP_THRESHOLD) {
                            if (casSweepVotes(v, v + 1))
                                break;
                        }
                        else if (casSweepVotes(v, 0)) {
                            sweep();
                            break;
                        }
                    }
                }
            }
        }
    }
```

ä¸»ä½“æµç¨‹å·²ç»å®Œæˆï¼Œè¿™é‡Œæ€»ç»“ä¸‹ï¼š

1. æ— è®ºæ˜¯å…¥å¯¹ã€å‡ºå¯¹ï¼Œè¿˜æ˜¯äº¤æ¢ï¼Œæœ€ç»ˆéƒ½ä¼šè·‘åˆ°xfer(E e, boolean haveData, int how, long nanos)æ–¹æ³•ä¸­ï¼Œåªä¸è¿‡ä¼ å…¥çš„howä¸åŒè€Œå·²
2. å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™å°è¯•åœ¨é˜Ÿåˆ—ä¸­å¯»æ‰¾æ˜¯å¦å­˜åœ¨ä¸è¯¥èŠ‚ç‚¹ç›¸åŒ¹é…çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ‰¾åˆ°åˆ™å°†åŒ¹é…èŠ‚ç‚¹çš„itemè®¾ç½®eï¼Œç„¶åå”¤é†’åŒ¹é…èŠ‚ç‚¹çš„waiterçº¿ç¨‹ã€‚å¦‚æœæ˜¯reservationåˆ™å«äººæ”¶è´§ï¼Œdataåˆ™å«nullæ”¶è´§
3. å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç‚¹ä¸”how ï¼= NOWï¼Œåˆ™è°ƒç”¨tryAppend()æ–¹æ³•å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—çš„tailï¼Œç„¶åè¿”å›å…¶å‰é©±èŠ‚ç‚¹
4. å¦‚æœèŠ‚ç‚¹çš„how != NOW && how != ASYNCï¼Œåˆ™è°ƒç”¨awaitMatch()æ–¹æ³•é˜»å¡ç­‰å¾…ï¼Œåœ¨é˜»å¡ç­‰å¾…è¿‡ç¨‹ä¸­å’ŒSynchronousQuqueçš„awaitFulfill()é€»è¾‘å·®ä¸å¤šï¼Œéƒ½æ˜¯å…ˆè‡ªæ—‹ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªæ—‹ï¼Œå¦‚æœä¸­æ–­æˆ–è€…è¶…æ—¶äº†åˆ™å°†è¯¥èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»å‡º

### å®ä¾‹

è¿™æ®µæ‘˜è‡ª[JAVA 1.7å¹¶å‘ä¹‹LinkedTransferQueueåŸç†ç†è§£](http://www.cnblogs.com/rockman12352/p/3790245.html)ã€‚æ„Ÿè§‰çœ‹å®Œä¸Šé¢çš„æºç åï¼Œåœ¨ç»“åˆè¿™ä¸ªä¾‹å­ä¼šæœ‰æ›´å¥½çš„äº†è§£ï¼ŒæŒæ¡ã€‚

1ï¼šHead->Data Input->Data
Match: æ ¹æ®ä»–ä»¬çš„å±æ€§ å‘ç° cannot match ï¼Œå› ä¸ºæ˜¯åŒç±»çš„
å¤„ç†èŠ‚ç‚¹: æ‰€ä»¥æŠŠæ–°çš„dataæ”¾åœ¨åŸæ¥çš„dataåé¢ï¼Œç„¶åheadå¾€åç§»ä¸€ä½ï¼ŒReservationåŒç†
HEAD=DATA->DATA

2ï¼šHead->Data Input->Reservation ï¼ˆå–æ•°æ®ï¼‰
Match: æˆåŠŸmatchï¼Œå°±æŠŠDataçš„itemå˜ä¸ºreservationçš„å€¼ï¼ˆnull,æœ‰ä¸»äº†ï¼‰ï¼Œå¹¶ä¸”è¿”å›æ•°æ®ã€‚
å¤„ç†èŠ‚ç‚¹ï¼š æ²¡åŠ¨ï¼Œheadè¿˜åœ¨åŸåœ°
HEAD=DATAï¼ˆç”¨è¿‡ï¼‰

3ï¼šHead->Reservation Input->Dataï¼ˆæ”¾æ•°æ®ï¼‰
Match: æˆåŠŸmatchï¼Œå°±æŠŠReservationçš„itemå˜ä¸ºDataçš„å€¼ï¼ˆæœ‰ä¸»äº†ï¼‰ï¼Œå¹¶ä¸”å«waiteræ¥å–
å¤„ç†èŠ‚ç‚¹ï¼š æ²¡åŠ¨
HEAD=RESERVATION(ç”¨è¿‡)

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)