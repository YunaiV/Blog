title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹ Java å¹¶å‘å®¹å™¨ï¼šConcurrentSkipListMap
date: 2018-06-08
tag: 
categories: JUC
permalink: JUC/sike/ConcurrentSkipListMap
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2371
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2371 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [SkipList](http://www.iocoder.cn/JUC/sike/ConcurrentSkipListMap/)
  - [ConcurrentSkipListMap](http://www.iocoder.cn/JUC/sike/ConcurrentSkipListMap/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åœ¨Javaä¸–ç•Œé‡Œçœ‹åˆ°äº†ä¸¤ç§å®ç°key-valueçš„æ•°æ®ç»“æ„ï¼šHashã€TreeMapï¼Œè¿™ä¸¤ç§æ•°æ®ç»“æ„å„è‡ªéƒ½æœ‰ç€ä¼˜ç¼ºç‚¹ã€‚

1. Hashè¡¨ï¼šæ’å…¥ã€æŸ¥æ‰¾æœ€å¿«ï¼Œä¸ºO(1)ï¼›å¦‚ä½¿ç”¨é“¾è¡¨å®ç°åˆ™å¯å®ç°æ— é”ï¼›æ•°æ®æœ‰åºåŒ–éœ€è¦æ˜¾å¼çš„æ’åºæ“ä½œã€‚
2. çº¢é»‘æ ‘ï¼šæ’å…¥ã€æŸ¥æ‰¾ä¸ºO(logn)ï¼Œä½†å¸¸æ•°é¡¹è¾ƒå°ï¼›æ— é”å®ç°çš„å¤æ‚æ€§å¾ˆé«˜ï¼Œä¸€èˆ¬éœ€è¦åŠ é”ï¼›æ•°æ®å¤©ç„¶æœ‰åºã€‚

ç„¶è€Œï¼Œè¿™æ¬¡ä»‹ç»ç¬¬ä¸‰ç§å®ç°key-valueçš„æ•°æ®ç»“æ„ï¼šSkipListã€‚SkipListæœ‰ç€ä¸ä½äºçº¢é»‘æ ‘çš„æ•ˆç‡ï¼Œä½†æ˜¯å…¶åŸç†å’Œå®ç°çš„å¤æ‚åº¦è¦æ¯”çº¢é»‘æ ‘ç®€å•å¤šäº†ã€‚

## SkipList

ä»€ä¹ˆæ˜¯SkipListï¼ŸSkip List ï¼Œç§°ä¹‹ä¸ºè·³è¡¨ï¼Œå®ƒæ˜¯ä¸€ç§å¯ä»¥æ›¿ä»£å¹³è¡¡æ ‘çš„æ•°æ®ç»“æ„ï¼Œå…¶æ•°æ®å…ƒç´ é»˜è®¤æŒ‰ç…§keyå€¼å‡åºï¼Œå¤©ç„¶æœ‰åºã€‚Skip listè®©å·²æ’åºçš„æ•°æ®åˆ†å¸ƒåœ¨å¤šå±‚é“¾è¡¨ä¸­ï¼Œä»¥0-1éšæœºæ•°å†³å®šä¸€ä¸ªæ•°æ®çš„å‘ä¸Šæ”€å‡ä¸å¦ï¼Œé€šè¿‡â€œç©ºé—´æ¥æ¢å–æ—¶é—´â€çš„ä¸€ä¸ªç®—æ³•ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­å¢åŠ äº†å‘å‰çš„æŒ‡é’ˆï¼Œåœ¨æ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾æ—¶å¯ä»¥å¿½ç•¥ä¸€äº›ä¸å¯èƒ½æ¶‰åŠåˆ°çš„ç»“ç‚¹ï¼Œä»è€Œæé«˜äº†æ•ˆç‡ã€‚

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„é“¾è¡¨ï¼Œå¦‚ä¸‹ï¼š

[![1499585893174201707090001](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824001.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824001.png)

å¦‚æœæˆ‘ä»¬éœ€è¦æŸ¥è¯¢9ã€21ã€30ï¼Œåˆ™éœ€è¦æ¯”è¾ƒæ¬¡æ•°ä¸º3 + 6 + 8 = 17 æ¬¡ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¼˜åŒ–æ–¹æ¡ˆå‘¢ï¼Ÿæœ‰ï¼æˆ‘ä»¬å°†è¯¥é“¾è¡¨ä¸­çš„æŸäº›å…ƒç´ æç‚¼å‡ºæ¥ä½œä¸ºä¸€ä¸ªæ¯”è¾ƒâ€œç´¢å¼•â€ï¼Œå¦‚ä¸‹ï¼š

[![1499586063109201707090002](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824002.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824002.png)

æˆ‘ä»¬å…ˆä¸è¿™äº›ç´¢å¼•è¿›è¡Œæ¯”è¾ƒæ¥å†³å®šä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯å¾€å³è¿˜æ˜¯ä¸‹èµ°ï¼Œç”±äºå­˜åœ¨â€œç´¢å¼•â€çš„ç¼˜æ•…ï¼Œå¯¼è‡´åœ¨æ£€ç´¢çš„æ—¶å€™ä¼šå¤§å¤§å‡å°‘æ¯”è¾ƒçš„æ¬¡æ•°ã€‚å½“ç„¶å…ƒç´ ä¸æ˜¯å¾ˆå¤šï¼Œå¾ˆéš¾ä½“ç°å‡ºä¼˜åŠ¿ï¼Œå½“å…ƒç´ è¶³å¤Ÿå¤šçš„æ—¶å€™ï¼Œè¿™ç§ç´¢å¼•ç»“æ„å°±ä¼šå¤§æ˜¾èº«æ‰‹ã€‚

### SkipListçš„ç‰¹æ€§

SkipListå…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š

1. ç”±å¾ˆå¤šå±‚ç»“æ„ç»„æˆï¼Œlevelæ˜¯é€šè¿‡ä¸€å®šçš„æ¦‚ç‡éšæœºäº§ç”Ÿçš„
2. æ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ï¼Œé»˜è®¤æ˜¯å‡åºï¼Œä¹Ÿå¯ä»¥æ ¹æ®åˆ›å»ºæ˜ å°„æ—¶æ‰€æä¾›çš„Comparatorè¿›è¡Œæ’åºï¼Œå…·ä½“å–å†³äºä½¿ç”¨çš„æ„é€ æ–¹æ³•
3. æœ€åº•å±‚(Level 1)çš„é“¾è¡¨åŒ…å«æ‰€æœ‰å…ƒç´ 
4. å¦‚æœä¸€ä¸ªå…ƒç´ å‡ºç°åœ¨Level i çš„é“¾è¡¨ä¸­ï¼Œåˆ™å®ƒåœ¨Level i ä¹‹ä¸‹çš„é“¾è¡¨ä¹Ÿéƒ½ä¼šå‡ºç°
5. æ¯ä¸ªèŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡å‘åŒä¸€é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œä¸€ä¸ªæŒ‡å‘ä¸‹é¢ä¸€å±‚çš„å…ƒç´ 

æˆ‘ä»¬å°†ä¸Šå›¾å†åšä¸€äº›æ‰©å±•å°±å¯ä»¥å˜æˆä¸€ä¸ªå…¸å‹çš„SkipListç»“æ„äº†

[![1499590828559201707090003](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824003.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824003.png)

### SkipListçš„æŸ¥æ‰¾

SkipListdçš„æŸ¥æ‰¾ç®—æ³•è¾ƒä¸ºç®€å•ï¼Œå¯¹äºä¸Šé¢æˆ‘ä»¬æˆ‘ä»¬è¦æŸ¥æ‰¾å…ƒç´ 21ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. æ¯”è¾ƒ3ï¼Œå¤§äºï¼Œå¾€åæ‰¾ï¼ˆ9ï¼‰ï¼Œ
2. æ¯”9å¤§ï¼Œç»§ç»­å¾€åæ‰¾ï¼ˆ25ï¼‰ï¼Œä½†æ˜¯æ¯”25å°ï¼Œåˆ™ä»9çš„ä¸‹ä¸€å±‚å¼€å§‹æ‰¾ï¼ˆ16ï¼‰
3. 16çš„åé¢èŠ‚ç‚¹ä¾ç„¶ä¸º25ï¼Œåˆ™ç»§ç»­ä»16çš„ä¸‹ä¸€å±‚æ‰¾
4. æ‰¾åˆ°21

å¦‚å›¾

[![201707090004](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824004.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824004.png)

çº¢è‰²è™šçº¿ä»£è¡¨è·¯å¾„ã€‚

### SkipListçš„æ’å…¥

SkipListçš„æ’å…¥æ“ä½œä¸»è¦åŒ…æ‹¬ï¼š

1. æŸ¥æ‰¾åˆé€‚çš„ä½ç½®ã€‚è¿™é‡Œéœ€è¦æ˜ç¡®ä¸€ç‚¹å°±æ˜¯åœ¨ç¡®è®¤æ–°èŠ‚ç‚¹è¦å æ®çš„å±‚æ¬¡Kæ—¶ï¼Œé‡‡ç”¨ä¸¢ç¡¬å¸çš„æ–¹å¼ï¼Œå®Œå…¨éšæœºã€‚å¦‚æœå æ®çš„å±‚æ¬¡Kå¤§äºé“¾è¡¨çš„å±‚æ¬¡ï¼Œåˆ™é‡æ–°ç”³è¯·æ–°çš„å±‚ï¼Œå¦åˆ™æ’å…¥æŒ‡å®šå±‚æ¬¡
2. ç”³è¯·æ–°çš„èŠ‚ç‚¹
3. è°ƒæ•´æŒ‡é’ˆ

å‡å®šæˆ‘ä»¬è¦æ’å…¥çš„å…ƒç´ ä¸º23ï¼Œç»è¿‡æŸ¥æ‰¾å¯ä»¥ç¡®è®¤å¥¹æ˜¯ä½äº25åï¼Œ9ã€16ã€21å‰ã€‚å½“ç„¶éœ€è¦è€ƒè™‘ç”³è¯·çš„å±‚æ¬¡Kã€‚

**å¦‚æœå±‚æ¬¡K > 3**

éœ€è¦ç”³è¯·æ–°å±‚æ¬¡ï¼ˆLevel 4ï¼‰

[![201707090005](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824005.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824005.png)

**å¦‚æœå±‚æ¬¡ K = 2**

ç›´æ¥åœ¨Level 2 å±‚æ’å…¥å³å¯

[![201707090006](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824006.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824006.png)

è¿™é‡Œä¼šæ¶‰åŠåˆ°ä»¥ä¸ªç®—æ³•ï¼šé€šè¿‡ä¸¢ç¡¬å¸å†³å®šå±‚æ¬¡Kï¼Œè¯¥ç®—æ³•æˆ‘ä»¬é€šè¿‡åé¢ConcurrentSkipListMapæºç æ¥åˆ†æã€‚è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯ï¼Œåœ¨Kå±‚æ’å…¥å…ƒç´ åï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰å°äºKå±‚çš„å±‚æ¬¡éƒ½åº”è¯¥å‡ºç°æ–°èŠ‚ç‚¹ã€‚

### SkipListçš„åˆ é™¤

åˆ é™¤èŠ‚ç‚¹å’Œæ’å…¥èŠ‚ç‚¹æ€è·¯åŸºæœ¬ä¸€è‡´ï¼šæ‰¾åˆ°èŠ‚ç‚¹ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼Œè°ƒæ•´æŒ‡é’ˆã€‚

æ¯”å¦‚åˆ é™¤èŠ‚ç‚¹9ï¼Œå¦‚ä¸‹ï¼š

[![201707090007](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824007.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824007.png)

## ConcurrentSkipListMap

é€šè¿‡ä¸Šé¢æˆ‘ä»¬çŸ¥é“SkipListé‡‡ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç®—æ³•ï¼Œå…¶æ’å…¥å’ŒæŸ¥æ‰¾çš„æ•ˆç‡O(logn)ï¼Œå…¶æ•ˆç‡ä¸ä½äºçº¢é»‘æ ‘ï¼Œä½†æ˜¯å…¶åŸç†å’Œå®ç°çš„å¤æ‚åº¦è¦æ¯”çº¢é»‘æ ‘ç®€å•å¤šäº†ã€‚ä¸€èˆ¬æ¥è¯´ä¼šæ“ä½œé“¾è¡¨Listï¼Œå°±ä¼šå¯¹SkipListæ¯«æ— å‹åŠ›ã€‚

ConcurrentSkipListMapå…¶å†…éƒ¨é‡‡ç”¨SkipLisæ•°æ®ç»“æ„å®ç°ã€‚ä¸ºäº†å®ç°SkipListï¼ŒConcurrentSkipListMapæä¾›äº†ä¸‰ä¸ªå†…éƒ¨ç±»æ¥æ„å»ºè¿™æ ·çš„é“¾è¡¨ç»“æ„ï¼šNodeã€Indexã€HeadIndexã€‚å…¶ä¸­Nodeè¡¨ç¤ºæœ€åº•å±‚çš„å•é“¾è¡¨æœ‰åºèŠ‚ç‚¹ã€Indexè¡¨ç¤ºä¸ºåŸºäºNodeçš„ç´¢å¼•å±‚ï¼ŒHeadIndexç”¨æ¥ç»´æŠ¤ç´¢å¼•å±‚æ¬¡ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è¯´ConcurrentSkipListMapæ˜¯é€šè¿‡HeadIndexç»´æŠ¤ç´¢å¼•å±‚æ¬¡ï¼Œé€šè¿‡Indexä»æœ€ä¸Šå±‚å¼€å§‹å¾€ä¸‹å±‚æŸ¥æ‰¾ï¼Œä¸€æ­¥ä¸€æ­¥ç¼©å°æŸ¥è¯¢èŒƒå›´ï¼Œæœ€ååˆ°è¾¾æœ€åº•å±‚Nodeæ—¶ï¼Œå°±åªéœ€è¦æ¯”è¾ƒå¾ˆå°ä¸€éƒ¨åˆ†æ•°æ®äº†ã€‚åœ¨JDKä¸­çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š

[![201707090008](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824008.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120824008.png)

** Node **

```Java
    static final class Node<K,V> {
        final K key;
        volatile Object value;
        volatile ConcurrentSkipListMap.Node<K, V> next;

        /** çœç•¥äº›è®¸ä»£ç  */
    }
```

Nodeçš„ç»“æ„å’Œä¸€èˆ¬çš„å•é“¾è¡¨æ¯«æ— åŒºåˆ«ï¼Œkey-valueå’Œä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„nextã€‚

**Index**

```Java
    static class Index<K,V> {
        final ConcurrentSkipListMap.Node<K,V> node;
        final ConcurrentSkipListMap.Index<K,V> down;
        volatile ConcurrentSkipListMap.Index<K,V> right;

        /** çœç•¥äº›è®¸ä»£ç  */
    }
```

Indexæä¾›äº†ä¸€ä¸ªåŸºäºNodeèŠ‚ç‚¹çš„ç´¢å¼•Nodeï¼Œä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªIndexçš„rightï¼Œä¸€ä¸ªæŒ‡å‘ä¸‹å±‚çš„downèŠ‚ç‚¹ã€‚

**HeadIndex**

```Java
    static final class HeadIndex<K,V> extends Index<K,V> {
        final int level;  //ç´¢å¼•å±‚ï¼Œä»1å¼€å§‹ï¼ŒNodeå•é“¾è¡¨å±‚ä¸º0
        HeadIndex(Node<K,V> node, Index<K,V> down, Index<K,V> right, int level) {
            super(node, down, right);
            this.level = level;
        }
    }
```

HeadIndexå†…éƒ¨å°±ä¸€ä¸ªlevelæ¥å®šä¹‰å±‚çº§ã€‚

ConcurrentSkipListMapæä¾›äº†å››ä¸ªæ„é€ å‡½æ•°ï¼Œæ¯ä¸ªæ„é€ å‡½æ•°éƒ½ä¼šè°ƒç”¨initialize()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚

```Java
    final void initialize() {
        keySet = null;
        entrySet = null;
        values = null;
        descendingMap = null;
        randomSeed = seedGenerator.nextInt() | 0x0100; // ensure nonzero
        head = new ConcurrentSkipListMap.HeadIndex<K,V>(new ConcurrentSkipListMap.Node<K,V>(null, BASE_HEADER, null),
                null, null, 1);
    }
```

æ³¨æ„ï¼Œinitialize()æ–¹æ³•ä¸ä»…ä»…åªåœ¨æ„é€ å‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œå¦‚cloneï¼Œclearã€readObjectæ—¶éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ­¥éª¤ã€‚è¿™é‡Œéœ€è¦æ³¨æ„randomSeedçš„åˆå§‹åŒ–ã€‚

```Java
 private transient int randomSeed;
 randomSeed = seedGenerator.nextInt() | 0x0100; // ensure nonzero
```

randomSeedä¸€ä¸ªç®€å•çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆåœ¨åé¢ä»‹ç»ï¼‰ã€‚

### putæ“ä½œ

CoucurrentSkipListMapæä¾›äº†put()æ–¹æ³•ç”¨äºå°†æŒ‡å®šå€¼ä¸æ­¤æ˜ å°„ä¸­çš„æŒ‡å®šé”®å…³è”ã€‚æºç å¦‚ä¸‹ï¼š

```Java
    public V put(K key, V value) {
        if (value == null)
            throw new NullPointerException();
        return doPut(key, value, false);
    }
```

é¦–å…ˆåˆ¤æ–­valueå¦‚æœä¸ºnullï¼Œåˆ™æŠ›å‡ºNullPointerExceptionï¼Œå¦åˆ™è°ƒç”¨doPutæ–¹æ³•ï¼Œå…¶å®å¦‚æœå„ä½çœ‹è¿‡JDKçš„æºç çš„è¯ï¼Œåº”è¯¥å¯¹è¿™æ ·çš„æ“ä½œå¾ˆç†Ÿæ‚‰äº†ï¼ŒJDKæºç é‡Œé¢å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å…ˆåšä¸€äº›å¿…è¦æ€§çš„éªŒè¯åï¼Œç„¶åé€šè¿‡è°ƒç”¨do**()æ–¹æ³•è¿›è¡ŒçœŸæ­£çš„æ“ä½œã€‚

doPut()æ–¹æ³•å†…å®¹è¾ƒå¤šï¼Œæˆ‘ä»¬åˆ†æ­¥åˆ†æã€‚

```Java
    private V doPut(K key, V value, boolean onlyIfAbsent) {
        Node<K,V> z;             // added node
        if (key == null)
            throw new NullPointerException();
        // æ¯”è¾ƒå™¨
        Comparator<? super K> cmp = comparator;
        outer: for (;;) {
            for (Node<K, V> b = findPredecessor(key, cmp), n = b.next; ; ) {

            /** çœç•¥ä»£ç  */
```

doPut()æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œé™¤äº†key,valueå¤–è¿˜æœ‰ä¸€ä¸ªbooleanç±»å‹çš„onlyIfAbsentï¼Œè¯¥å‚æ•°ä½œç”¨ä¸å¦‚æœå­˜åœ¨å½“å‰keyæ—¶ï¼Œè¯¥åšä½•åŠ¨ä½œã€‚å½“onlyIfAbsentä¸ºfalseæ—¶ï¼Œæ›¿æ¢valueï¼Œä¸ºtrueæ—¶ï¼Œåˆ™è¿”å›è¯¥valueã€‚ç”¨ä»£ç è§£é‡Šä¸ºï¼š

```Java
   if (!map.containsKey(key))
      return map.put(key, value);
  else
       return map.get(key);
```

é¦–å…ˆåˆ¤æ–­keyæ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ºnullï¼Œåˆ™æŠ›å‡ºNullPointerExceptionï¼Œä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤ConcurrentSkipListæ˜¯ä¸æ”¯æŒkeyæˆ–è€…valueä¸ºnullçš„ã€‚ç„¶åè°ƒç”¨findPredecessor()æ–¹æ³•ï¼Œä¼ å…¥keyæ¥ç¡®è®¤ä½ç½®ã€‚findPredecessor()æ–¹æ³•å…¶å®å°±æ˜¯ç¡®è®¤keyè¦æ’å…¥çš„ä½ç½®ã€‚

```Java
   private Node<K,V> findPredecessor(Object key, Comparator<? super K> cmp) {
        if (key == null)
            throw new NullPointerException(); // don't postpone errors
        for (;;) {
            // ä»headèŠ‚ç‚¹å¼€å§‹ï¼Œheadæ˜¯levelæœ€é«˜çº§åˆ«çš„headIndex
            for (Index<K,V> q = head, r = q.right, d;;) {

                // r != nullï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å³è¾¹è¿˜æœ‰èŠ‚ç‚¹ï¼Œéœ€è¦æ¯”è¾ƒ
                if (r != null) {
                    Node<K,V> n = r.node;
                    K k = n.key;
                    // value == nullï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤äº†
                    // é€šè¿‡unlink()æ–¹æ³•è¿‡æ»¤æ‰è¯¥èŠ‚ç‚¹
                    if (n.value == null) {
                        //åˆ æ‰rèŠ‚ç‚¹
                        if (!q.unlink(r))
                            break;           // restart
                        r = q.right;         // reread r
                        continue;
                    }

                    // value != nullï¼ŒèŠ‚ç‚¹å­˜åœ¨
                    // å¦‚æœkey å¤§äºrèŠ‚ç‚¹çš„key åˆ™å¾€å‰è¿›ä¸€æ­¥
                    if (cpr(cmp, key, k) > 0) {
                        q = r;
                        r = r.right;
                        continue;
                    }
                }

                // åˆ°è¾¾æœ€å³è¾¹ï¼Œå¦‚æœdowm == nullï¼Œè¡¨ç¤ºæŒ‡é’ˆå·²ç»è¾¾åˆ°æœ€ä¸‹å±‚äº†ï¼Œç›´æ¥è¿”å›è¯¥èŠ‚ç‚¹
                if ((d = q.down) == null)
                    return q.node;
                q = d;
                r = d.right;
            }
        }
    }
```

findPredecessor()æ–¹æ³•æ„æ€éå¸¸æ˜ç¡®ï¼šå¯»æ‰¾å‰è¾ˆã€‚ä»æœ€é«˜å±‚çš„headIndexå¼€å§‹å‘å³ä¸€æ­¥ä¸€æ­¥æ¯”è¾ƒï¼Œç›´åˆ°rightä¸ºnullæˆ–è€…å³è¾¹èŠ‚ç‚¹çš„Nodeçš„keyå¤§äºå½“å‰keyä¸ºæ­¢ï¼Œç„¶åå†å‘ä¸‹å¯»æ‰¾ï¼Œä¾æ¬¡é‡å¤è¯¥è¿‡ç¨‹ï¼Œç›´åˆ°downä¸ºnullä¸ºæ­¢ï¼Œå³æ‰¾åˆ°äº†å‰è¾ˆï¼Œçœ‹è¿”å›çš„ç»“æœæ³¨æ„æ˜¯Nodeï¼Œä¸æ˜¯Itemï¼Œæ‰€ä»¥æ’å…¥çš„ä½ç½®åº”è¯¥æ˜¯æœ€åº•å±‚çš„Nodeé“¾è¡¨ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ConcurrentSkipListMapèµ‹äºˆäº†è¯¥æ–¹æ³•ä¸€ä¸ªå…¶ä»–çš„åŠŸèƒ½ï¼Œå°±æ˜¯é€šè¿‡åˆ¤æ–­èŠ‚ç‚¹çš„valueæ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ºnullï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤äº†ï¼Œé€šè¿‡è°ƒç”¨unlink()æ–¹æ³•åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚

```Java
        final boolean unlink(Index<K,V> succ) {
            return node.value != null && casRight(succ, succ.right);
        }
```

åˆ é™¤èŠ‚ç‚¹è¿‡ç¨‹éå¸¸ç®€å•ï¼Œæ›´æ”¹ä¸‹rightæŒ‡é’ˆå³å¯ã€‚

é€šè¿‡findPredecessor()æ‰¾åˆ°å‰è¾ˆèŠ‚ç‚¹åï¼Œåšä»€ä¹ˆå‘¢ï¼Ÿçœ‹ä¸‹é¢ï¼š

```Java
 for (Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {
        // å‰è¾ˆèŠ‚ç‚¹çš„next != null
        if (n != null) {
            Object v; int c;
            Node<K,V> f = n.next;

            // ä¸ä¸€è‡´è¯»ï¼Œä¸»è¦åŸå› æ˜¯å¹¶å‘ï¼Œæœ‰èŠ‚ç‚¹æ·è¶³å…ˆç™»
            if (n != b.next)               // inconsistent read
                break;

            // n.value == nullï¼Œè¯¥èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤äº†
            if ((v = n.value) == null) {   // n is deleted
                n.helpDelete(b, f);
                break;
            }

            // å‰è¾ˆèŠ‚ç‚¹bå·²ç»è¢«åˆ é™¤
            if (b.value == null || v == n) // b is deleted
                break;

            // èŠ‚ç‚¹å¤§äºï¼Œå¾€å‰ç§»
            if ((c = cpr(cmp, key, n.key)) > 0) {
                b = n;
                n = f;
                continue;
            }

            // c == 0 è¡¨ç¤ºï¼Œæ‰¾åˆ°ä¸€ä¸ªkeyç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œæ ¹æ®onlyIfAbsentå‚æ•°æ¥åšåˆ¤æ–­
            // onlyIfAbsent ==falseï¼Œåˆ™é€šè¿‡casValueï¼Œæ›¿æ¢value
            // onlyIfAbsent == trueï¼Œè¿”å›è¯¥value
            if (c == 0) {
                if (onlyIfAbsent || n.casValue(v, value)) {
                    @SuppressWarnings("unchecked") V vv = (V)v;
                    return vv;
                }
                break; // restart if lost race to replace value
            }
            // else c < 0; fall through
        }

        // å°†key-valueåŒ…è£…æˆä¸€ä¸ªnodeï¼Œæ’å…¥
        z = new Node<K,V>(key, value, n);
        if (!b.casNext(n, z))
            break;         // restart if lost race to append to b
        break outer;
    }
```

æ‰¾åˆ°åˆé€‚çš„ä½ç½®åï¼Œå°±æ˜¯åœ¨è¯¥ä½ç½®æ’å…¥èŠ‚ç‚¹å’¯ã€‚æ’å…¥èŠ‚ç‚¹çš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†key-valueåŒ…è£…æˆä¸€ä¸ªNodeï¼Œç„¶åé€šè¿‡casNext()æ–¹æ³•åŠ å…¥åˆ°é“¾è¡¨å½“ä¸­ã€‚å½“ç„¶æ˜¯æ’å…¥ä¹‹å‰éœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„æ ¡éªŒå·¥ä½œã€‚

åœ¨æœ€ä¸‹å±‚æ’å…¥èŠ‚ç‚¹åï¼Œä¸‹ä¸€æ­¥å·¥ä½œæ˜¯ä»€ä¹ˆï¼Ÿæ–°å»ºç´¢å¼•ã€‚å‰é¢åšä¸»æè¿‡ï¼Œåœ¨æ’å…¥èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¼šæ ¹æ®é‡‡ç”¨æŠ›ç¡¬å¸çš„æ–¹å¼æ¥å†³å®šæ–°èŠ‚ç‚¹æ‰€æ’å…¥çš„å±‚æ¬¡ï¼Œç”±äºå­˜åœ¨å¹¶å‘çš„å¯èƒ½ï¼ŒConcurrentSkipListMapé‡‡ç”¨ThreadLocalRandomæ¥ç”Ÿæˆéšæœºæ•°ã€‚å¦‚ä¸‹ï¼š

```Java
int rnd = ThreadLocalRandom.nextSecondarySeed();
```

æŠ›ç¡¬å¸å†³å®šå±‚æ¬¡çš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡æŠ›ç¡¬å¸å¦‚æœç¡¬å¸ä¸ºæ­£é¢åˆ™å±‚æ¬¡level + 1 ï¼Œå¦åˆ™åœæ­¢ï¼Œå¦‚ä¸‹ï¼š

```Java
            // æŠ›ç¡¬å¸å†³å®šå±‚æ¬¡
            while (((rnd >>>= 1) & 1) != 0)
                ++level;
```

åœ¨é˜è¿°SkipListæ’å…¥èŠ‚ç‚¹çš„æ—¶å€™è¯´æ˜äº†ï¼Œå†³å®šçš„å±‚æ¬¡levelä¼šåˆ†ä¸ºä¸¤ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œä¸€æ˜¯å¦‚æœå±‚æ¬¡levelå¤§äºæœ€å¤§çš„å±‚æ¬¡è¯åˆ™éœ€è¦æ–°å¢ä¸€å±‚ï¼Œå¦åˆ™å°±åœ¨ç›¸åº”å±‚æ¬¡ä»¥åŠå°äºè¯¥levelçš„å±‚æ¬¡è¿›è¡ŒèŠ‚ç‚¹æ–°å¢å¤„ç†ã€‚

**level <= headIndex.level**

```Java
            // å¦‚æœå†³å®šçš„å±‚æ¬¡levelæ¯”æœ€é«˜å±‚æ¬¡head.levelå°ï¼Œç›´æ¥ç”Ÿæˆæœ€é«˜å±‚æ¬¡çš„index
            // ç”±äºéœ€è¦ç¡®è®¤æ¯ä¸€å±‚æ¬¡çš„downï¼Œæ‰€ä»¥éœ€è¦ä»æœ€ä¸‹å±‚ä¾æ¬¡å¾€ä¸Šç”Ÿæˆ
            if (level <= (max = h.level)) {
                for (int i = 1; i <= level; ++i)
                    idx = new ConcurrentSkipListMap.Index<K,V>(z, idx, null);
            }
```



ä»åº•å±‚å¼€å§‹ï¼Œå°äºlevelçš„æ¯ä¸€å±‚éƒ½åˆå§‹åŒ–ä¸€ä¸ªindexï¼Œæ¯æ¬¡çš„nodeéƒ½æŒ‡å‘æ–°åŠ å…¥çš„nodeï¼ŒdownæŒ‡å‘ä¸‹ä¸€å±‚çš„itemï¼Œå³ä¾§nextå…¨éƒ¨ä¸ºnullã€‚æ•´ä¸ªå¤„ç†è¿‡ç¨‹éå¸¸ç®€å•ï¼šä¸ºå°äºlevelçš„æ¯ä¸€å±‚åˆå§‹åŒ–ä¸€ä¸ªindexï¼Œç„¶ååŠ å…¥åˆ°åŸæ¥çš„indexé“¾æ¡ä¸­å»ã€‚

**level > headIndex.level**

```Java
           // leve > head.level åˆ™æ–°å¢ä¸€å±‚
            else { // try to grow by one level
                // æ–°å¢ä¸€å±‚
                level = max + 1;

                // åˆå§‹åŒ– levelä¸ªitemèŠ‚ç‚¹
                @SuppressWarnings("unchecked")
                ConcurrentSkipListMap.Index<K,V>[] idxs =
                        (ConcurrentSkipListMap.Index<K,V>[])new ConcurrentSkipListMap.Index<?,?>[level+1];
                for (int i = 1; i <= level; ++i)
                    idxs[i] = idx = new ConcurrentSkipListMap.Index<K,V>(z, idx, null);

                //
                for (;;) {
                    h = head;
                    int oldLevel = h.level;
                    // å±‚æ¬¡æ‰©å¤§äº†ï¼Œéœ€è¦é‡æ–°å¼€å§‹ï¼ˆæœ‰æ–°çº¿ç¨‹èŠ‚ç‚¹åŠ å…¥ï¼‰
                    if (level <= oldLevel) // lost race to add level
                        break;
                    // æ–°çš„å¤´ç»“ç‚¹HeadIndex
                    ConcurrentSkipListMap.HeadIndex<K,V> newh = h;
                    ConcurrentSkipListMap.Node<K,V> oldbase = h.node;
                    // ç”Ÿæˆæ–°çš„HeadIndexèŠ‚ç‚¹ï¼Œè¯¥HeadIndexæŒ‡å‘æ–°å¢å±‚æ¬¡
                    for (int j = oldLevel+1; j <= level; ++j)
                        newh = new ConcurrentSkipListMap.HeadIndex<K,V>(oldbase, newh, idxs[j], j);

                    // HeadIndex CASæ›¿æ¢
                    if (casHead(h, newh)) {
                        h = newh;
                        idx = idxs[level = oldLevel];
                        break;
                    }
                }
```

å½“æŠ›ç¡¬å¸å†³å®šçš„levelå¤§äºæœ€å¤§å±‚æ¬¡levelæ—¶ï¼Œéœ€è¦æ–°å¢ä¸€å±‚è¿›è¡Œå¤„ç†ã€‚å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š

1. åˆå§‹åŒ–ä¸€ä¸ªå¯¹åº”çš„indexæ•°ç»„ï¼Œå¤§å°ä¸ºlevel + 1ï¼Œç„¶åä¸ºæ¯ä¸ªå•ä½éƒ½åˆ›å»ºä¸€ä¸ªindexï¼Œä¸ªä¸­å‚æ•°ä¸ºï¼šNodeä¸ºæ–°å¢çš„Zï¼Œdownä¸ºä¸‹ä¸€å±‚indexï¼Œrightä¸ºnull
2. é€šè¿‡forå¾ªç¯æ¥è¿›è¡Œæ‰©å®¹æ“ä½œã€‚ä»æœ€é«˜å±‚è¿›è¡Œå¤„ç†ï¼Œæ–°å¢ä¸€ä¸ªHeadIndexï¼Œä¸ªä¸­å‚æ•°ï¼šèŠ‚ç‚¹Nodeï¼Œdownéƒ½ä¸ºæœ€é«˜å±‚çš„Nodeå’ŒHeadIndexï¼Œrightä¸ºåˆšåˆšåˆ›å»ºçš„å¯¹åº”å±‚æ¬¡çš„indexï¼Œlevelä¸ºç›¸å¯¹åº”çš„å±‚æ¬¡levelã€‚æœ€åé€šè¿‡CASæŠŠå½“å‰çš„headä¸æ–°åŠ å…¥å±‚çš„headè¿›è¡Œæ›¿æ¢ã€‚

é€šè¿‡ä¸Šé¢æ­¥éª¤æˆ‘ä»¬å‘ç°ï¼Œå°½ç®¡å·²ç»æ‰¾åˆ°äº†å‰è¾ˆèŠ‚ç‚¹ï¼Œä¹Ÿå°†nodeæ’å…¥äº†ï¼Œä¹Ÿç¡®å®šç¡®å®šäº†å±‚æ¬¡å¹¶ç”Ÿæˆäº†ç›¸åº”çš„Indexï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å°†è¿™äº›Indexæ’å…¥åˆ°ç›¸åº”çš„å±‚æ¬¡å½“ä¸­ï¼Œæ‰€ä»¥ä¸‹é¢çš„ä»£ç å°±æ˜¯å°†indexæ’å…¥åˆ°ç›¸å¯¹åº”çš„å±‚å½“ä¸­ã€‚

```Java
  // ä»æ’å…¥çš„å±‚æ¬¡levelå¼€å§‹
    splice: for (int insertionLevel = level;;) {
        int j = h.level;
        //  ä»headIndexå¼€å§‹
        for (ConcurrentSkipListMap.Index<K,V> q = h, r = q.right, t = idx;;) {
            if (q == null || t == null)
                break splice;

            // r != nullï¼›è¿™é‡Œæ˜¯æ‰¾åˆ°ç›¸åº”å±‚æ¬¡çš„æ’å…¥èŠ‚ç‚¹ä½ç½®ï¼Œæ³¨æ„è¿™é‡Œåªæ¨ªå‘æ‰¾
            if (r != null) {
                ConcurrentSkipListMap.Node<K,V> n = r.node;

                int c = cpr(cmp, key, n.key);

                // n.value == null ï¼Œè§£é™¤å…³ç³»ï¼Œrå³ç§»
                if (n.value == null) {
                    if (!q.unlink(r))
                        break;
                    r = q.right;
                    continue;
                }

                // key > n.key å³ç§»
                if (c > 0) {
                    q = r;
                    r = r.right;
                    continue;
                }
            }

            // ä¸Šé¢æ‰¾åˆ°èŠ‚ç‚¹è¦æ’å…¥çš„ä½ç½®ï¼Œè¿™é‡Œå°±æ’å…¥
            // å½“å‰å±‚æ˜¯æœ€é¡¶å±‚
            if (j == insertionLevel) {
                // å»ºç«‹è”ç³»
                if (!q.link(r, t))
                    break; // restart
                if (t.node.value == null) {
                    findNode(key);
                    break splice;
                }
                // æ ‡å¿—çš„æ’å…¥å±‚ -- ï¼Œå¦‚æœ== 0 ï¼Œè¡¨ç¤ºå·²ç»åˆ°åº•äº†ï¼Œæ’å…¥å®Œæ¯•ï¼Œé€€å‡ºå¾ªç¯
                if (--insertionLevel == 0)
                    break splice;
            }

            // ä¸Šé¢èŠ‚ç‚¹å·²ç»æ’å…¥å®Œæ¯•äº†ï¼Œæ’å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
            if (--j >= insertionLevel && j < level)
                t = t.down;
            q = q.down;
            r = q.right;
        }
    }
```

è¿™æ®µä»£ç åˆ†ä¸ºä¸¤éƒ¨åˆ†çœ‹ï¼Œä¸€éƒ¨åˆ†æ˜¯æ‰¾åˆ°ç›¸åº”å±‚æ¬¡çš„è¯¥èŠ‚ç‚¹æ’å…¥çš„ä½ç½®ï¼Œç¬¬äºŒéƒ¨åˆ†åœ¨è¯¥ä½ç½®æ’å…¥ï¼Œç„¶åä¸‹ç§»ã€‚

è‡³æ­¤ï¼ŒConcurrentSkipListMapçš„putæ“ä½œåˆ°æ­¤å°±ç»“æŸäº†ã€‚ä»£ç é‡æœ‰ç‚¹å„¿å¤šï¼Œè¿™é‡Œæ€»ç»“ä¸‹ï¼š

1. é¦–å…ˆé€šè¿‡findPredecessor()æ–¹æ³•æ‰¾åˆ°å‰è¾ˆèŠ‚ç‚¹Node
2. æ ¹æ®è¿”å›çš„å‰è¾ˆèŠ‚ç‚¹ä»¥åŠkey-valueï¼Œæ–°å»ºNodeèŠ‚ç‚¹ï¼ŒåŒæ—¶é€šè¿‡CASè®¾ç½®next
3. è®¾ç½®èŠ‚ç‚¹Nodeï¼Œå†è®¾ç½®ç´¢å¼•èŠ‚ç‚¹ã€‚é‡‡å–æŠ›ç¡¬å¸æ–¹å¼å†³å®šå±‚æ¬¡ï¼Œå¦‚æœæ‰€å†³å®šçš„å±‚æ¬¡å¤§äºç°å­˜çš„æœ€å¤§å±‚æ¬¡ï¼Œåˆ™æ–°å¢ä¸€å±‚ï¼Œç„¶åæ–°å»ºä¸€ä¸ªItemé“¾è¡¨ã€‚
4. æœ€åï¼Œå°†æ–°å»ºçš„Itemé“¾è¡¨æ’å…¥åˆ°SkipListç»“æ„ä¸­ã€‚

### getæ“ä½œ

ç›¸æ¯”äºputæ“ä½œ ï¼Œgetæ“ä½œä¼šç®€å•å¾ˆå¤šï¼Œå…¶è¿‡ç¨‹å…¶å®å°±åªç›¸å½“äºputæ“ä½œçš„ç¬¬ä¸€æ­¥ï¼š

```Java
  private V doGet(Object key) {
        if (key == null)
            throw new NullPointerException();
        Comparator<? super K> cmp = comparator;
        outer: for (;;) {
            for (ConcurrentSkipListMap.Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {
                Object v; int c;
                if (n == null)
                    break outer;
                ConcurrentSkipListMap.Node<K,V> f = n.next;
                if (n != b.next)                // inconsistent read
                    break;
                if ((v = n.value) == null) {    // n is deleted
                    n.helpDelete(b, f);
                    break;
                }
                if (b.value == null || v == n)  // b is deleted
                    break;
                if ((c = cpr(cmp, key, n.key)) == 0) {
                    @SuppressWarnings("unchecked") V vv = (V)v;
                    return vv;
                }
                if (c < 0)
                    break outer;
                b = n;
                n = f;
            }
        }
        return null;
    }
```

ä¸putæ“ä½œç¬¬ä¸€æ­¥ç›¸ä¼¼ï¼Œé¦–å…ˆè°ƒç”¨findPredecessor()æ–¹æ³•æ‰¾åˆ°å‰è¾ˆèŠ‚ç‚¹ï¼Œç„¶åé¡ºç€rightä¸€ç›´å¾€å³æ‰¾å³å¯ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åŒæ ·æ‰¿æ‹…äº†ä¸€ä¸ªåˆ é™¤valueä¸ºnullçš„èŠ‚ç‚¹çš„èŒè´£ã€‚

### removeæ“ä½œ

removeæ“ä½œä¸ºåˆ é™¤æŒ‡å®škeyèŠ‚ç‚¹ï¼Œå¦‚ä¸‹ï¼š

```Java
    public V remove(Object key) {
        return doRemove(key, null);
    }
```

ç›´æ¥è°ƒç”¨doRemove()æ–¹æ³•ï¼Œè¿™é‡Œremoveæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯keyï¼Œå¦å¤–ä¸€ä¸ªæ˜¯valueï¼Œæ‰€ä»¥doRemoveæ–¹æ³•å³æä¾›remove keyï¼Œä¹Ÿæä¾›åŒæ—¶æ»¡è¶³key-valueã€‚

```Java
 final V doRemove(Object key, Object value) {
        if (key == null)
            throw new NullPointerException();
        Comparator<? super K> cmp = comparator;
        outer: for (;;) {
            for (ConcurrentSkipListMap.Node<K,V> b = findPredecessor(key, cmp), n = b.next;;) {
                Object v; int c;
                if (n == null)
                    break outer;
                ConcurrentSkipListMap.Node<K,V> f = n.next;

                // ä¸ä¸€è‡´è¯»ï¼Œé‡æ–°å¼€å§‹
                if (n != b.next)                    // inconsistent read
                    break;

                // nèŠ‚ç‚¹å·²åˆ é™¤
                if ((v = n.value) == null) {        // n is deleted
                    n.helpDelete(b, f);
                    break;
                }

                // bèŠ‚ç‚¹å·²åˆ é™¤
                if (b.value == null || v == n)      // b is deleted
                    break;

                if ((c = cpr(cmp, key, n.key)) < 0)
                    break outer;

                // å³ç§»
                if (c > 0) {
                    b = n;
                    n = f;
                    continue;
                }

                /*
                 * æ‰¾åˆ°èŠ‚ç‚¹
                 */

                // value != null è¡¨ç¤ºéœ€è¦åŒæ—¶æ ¡éªŒkey-valueå€¼
                if (value != null && !value.equals(v))
                    break outer;

                // CASæ›¿æ¢value
                if (!n.casValue(v, null))
                    break;
                if (!n.appendMarker(f) || !b.casNext(n, f))
                    findNode(key);                  // retry via findNode
                else {
                    // æ¸…ç†èŠ‚ç‚¹
                    findPredecessor(key, cmp);      // clean index

                    // head.right == nullè¡¨ç¤ºè¯¥å±‚å·²ç»æ²¡æœ‰èŠ‚ç‚¹ï¼Œåˆ æ‰è¯¥å±‚
                    if (head.right == null)
                        tryReduceLevel();
                }
                @SuppressWarnings("unchecked") V vv = (V)v;
                return vv;
            }
        }
        return null;
    }
```

è°ƒç”¨findPredecessor()æ–¹æ³•æ‰¾åˆ°å‰è¾ˆèŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡å³ç§»ï¼Œç„¶åæ¯”è¾ƒï¼Œæ‰¾åˆ°ååˆ©ç”¨CASæŠŠvalueæ›¿æ¢ä¸ºnullï¼Œç„¶ååˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯ä¸æ˜¯è¿™å±‚å”¯ä¸€çš„indexï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè°ƒç”¨tryReduceLevel()æ–¹æ³•æŠŠè¿™å±‚å¹²æ‰ï¼Œå®Œæˆåˆ é™¤ã€‚

å…¶å®ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œremoveæ–¹æ³•ä»…ä»…æ˜¯æŠŠNodeçš„valueè®¾ç½®nullï¼Œå¹¶æ²¡æœ‰çœŸæ­£åˆ é™¤è¯¥èŠ‚ç‚¹Nodeï¼Œå…¶å®ä»ä¸Šé¢çš„putæ“ä½œã€getæ“ä½œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä»–ä»¬åœ¨å¯»æ‰¾èŠ‚ç‚¹çš„æ—¶å€™éƒ½ä¼šåˆ¤æ–­èŠ‚ç‚¹çš„valueæ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ºnullï¼Œåˆ™è°ƒç”¨unLink()æ–¹æ³•å–æ¶ˆå…³è”å…³ç³»ï¼Œå¦‚ä¸‹ï¼š

```Java
                    if (n.value == null) {
                        if (!q.unlink(r))
                            break;           // restart
                        r = q.right;         // reread r
                        continue;
                    }
```

### sizeæ“ä½œ

ConcurrentSkipListMapçš„size()æ“ä½œå’ŒConcurrentHashMapä¸åŒï¼Œå®ƒå¹¶æ²¡æœ‰ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡æ¥ç»Ÿè®¡å…ƒç´ çš„ä¸ªæ•°ï¼Œæ‰€ä»¥æ¯æ¬¡è°ƒç”¨è¯¥æ–¹æ³•çš„æ—¶å€™éƒ½éœ€è¦å»éå†ã€‚

```Java
    public int size() {
        long count = 0;
        for (Node<K,V> n = findFirst(); n != null; n = n.next) {
            if (n.getValidValue() != null)
                ++count;
        }
        return (count >= Integer.MAX_VALUE) ? Integer.MAX_VALUE : (int) count;
    }
```

è°ƒç”¨findFirst()æ–¹æ³•æ‰¾åˆ°ç¬¬ä¸€ä¸ªNodeï¼Œç„¶ååˆ©ç”¨nodeçš„nextå»ç»Ÿè®¡ã€‚æœ€åè¿”å›ç»Ÿè®¡æ•°æ®ï¼Œæœ€å¤šèƒ½è¿”å›Integer.MAX_VALUEã€‚æ³¨æ„è¿™é‡Œåœ¨çº¿ç¨‹å¹¶å‘ä¸‹æ˜¯å®‰å…¨çš„ã€‚

ConcurrentSkipListMapè¿‡ç¨‹å…¶å®ä¸å¤æ‚ï¼Œç›¸æ¯”äºConcurrentHashMapè€Œè¨€ï¼Œæ˜¯ç®€å•çš„ä¸èƒ½å†ç®€å•äº†ã€‚å¯¹è·³è¡¨SkipListç†Ÿæ‚‰çš„è¯ï¼ŒConcurrentSkipListMap åº”è¯¥æ˜¯ç›˜ä¸­é¤äº†ã€‚

**ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹å¾æœJavaå¹¶å‘çš„é˜»å¡é˜Ÿåˆ—**

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)