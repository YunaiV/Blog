title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹é˜»å¡é˜Ÿåˆ—ï¼šArrayBlockingQueue
date: 2018-06-09
tag: 
categories: JUC
permalink: JUC/sike/ArrayBlockingQueue
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2381
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2381 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. ç®€ä»‹](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
- [2. æ„é€ æ–¹æ³•](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
- [3. å…¥é˜Ÿ](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [3.1 add](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [3.2 offer](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [3.3 å¯è¶…æ—¶çš„ offer](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [3.4 put](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
- [4. å‡ºé˜Ÿ](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [4.1 poll](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [4.2 å¯è¶…æ—¶çš„ poll](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [4.3 take](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
  - [4.4 remove](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
- [5. è¡¥å……è¯´æ˜](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/ArrayBlockingQueue/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# 1. ç®€ä»‹

ArrayBlockingQueueï¼Œä¸€ä¸ªç”±**æ•°ç»„**å®ç°çš„**æœ‰ç•Œ**é˜»å¡é˜Ÿåˆ—ã€‚è¯¥é˜Ÿåˆ—é‡‡ç”¨ FIFO çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºæ·»åŠ çš„ã€‚

ArrayBlockingQueue ä¸º**æœ‰ç•Œä¸”å›ºå®š**ï¼Œå…¶å¤§å°åœ¨æ„é€ æ—¶ç”±æ„é€ å‡½æ•°æ¥å†³å®šï¼Œç¡®è®¤ä¹‹åå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚

ArrayBlockingQueue æ”¯æŒå¯¹ç­‰å¾…çš„ç”Ÿäº§è€…çº¿ç¨‹å’Œä½¿ç”¨è€…çº¿ç¨‹è¿›è¡Œæ’åºçš„å¯é€‰å…¬å¹³ç­–ç•¥ï¼Œä½†æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸ä¿è¯çº¿ç¨‹å…¬å¹³çš„è®¿é—®ï¼Œåœ¨æ„é€ æ—¶å¯ä»¥é€‰æ‹©å…¬å¹³ç­–ç•¥ï¼ˆ`fair = true`ï¼‰ã€‚å…¬å¹³æ€§é€šå¸¸ä¼šé™ä½ååé‡ï¼Œä½†æ˜¯å‡å°‘äº†å¯å˜æ€§å’Œé¿å…äº†â€œä¸å¹³è¡¡æ€§â€ã€‚

# 2. æ„é€ æ–¹æ³•

å…ˆçœ‹çœ‹ `java.util.concurrent.ArrayBlockingQueue` çš„æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
public class ArrayBlockingQueue<E> extends AbstractQueue<E> implements BlockingQueue<E>, Serializable {

    private static final long serialVersionUID = -817911632652898426L;
    
    final Object[] items;
    int takeIndex;
    int putIndex;
    int count;
    // é‡å…¥é”
    final ReentrantLock lock;
    // notEmpty condition
    private final Condition notEmpty;
    // notFull condition
    private final Condition notFull;
    transient ArrayBlockingQueue.Itrs itrs;
    
    public ArrayBlockingQueue(int capacity) {
        this(capacity, false);
    }
    
    public ArrayBlockingQueue(int capacity, boolean fair) {
        if (capacity <= 0)
            throw new IllegalArgumentException();
        this.items = new Object[capacity];
        lock = new ReentrantLock(fair);
        notEmpty = lock.newCondition();
        notFull =  lock.newCondition();
    }
    
}
```

* å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ° ArrayBlockingQueue ç»§æ‰¿ `java.util.AbstractQueue` ï¼Œå®ç° `java.util.concurrent.BlockingQueue` æ¥å£ã€‚çœ‹è¿‡ `java.util` åŒ…æºç çš„åŒå­¦åº”è¯¥éƒ½è®¤è¯†AbstractQueueï¼Œè¯¥ç±»åœ¨ `java.util.Queue`  æ¥å£ä¸­æ‰®æ¼”ç€éå¸¸é‡è¦çš„ä½œç”¨ï¼Œè¯¥ç±»æä¾›äº†å¯¹queue æ“ä½œçš„**éª¨å¹²**å®ç°ï¼ˆå…·ä½“å†…å®¹ç§»é©¾å…¶æºç ï¼‰ã€‚
* `java.util.concurrent.BlockingQueue` ç»§æ‰¿ `java.util.Queue` æ¥å£ï¼Œä¸ºé˜»å¡é˜Ÿåˆ—çš„**æ ¸å¿ƒæ¥å£**ï¼Œæä¾›äº†åœ¨**å¤šçº¿ç¨‹**ç¯å¢ƒä¸‹çš„å‡ºåˆ—ã€å…¥åˆ—æ“ä½œã€‚ä½œä¸ºä½¿ç”¨è€…ï¼Œåˆ™ä¸éœ€è¦å…³å¿ƒé˜Ÿåˆ—åœ¨ä»€ä¹ˆæ—¶å€™é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™å”¤é†’çº¿ç¨‹ï¼Œæ‰€æœ‰ä¸€åˆ‡å‡ç”± BlockingQueue æ¥å®Œæˆã€‚
* ArrayBlockingQueue å†…éƒ¨ä½¿ç”¨å¯é‡å…¥é” ReentrantLock + Condition æ¥å®Œæˆå¤šçº¿ç¨‹ç¯å¢ƒçš„å¹¶å‘æ“ä½œã€‚

    - `items` å˜é‡ï¼Œä¸€ä¸ªå®šé•¿æ•°ç»„ï¼Œç»´æŠ¤ ArrayBlockingQueue çš„å…ƒç´ ã€‚
        - `takeIndex` å˜é‡ï¼Œ`int` ï¼Œä¸º ArrayBlockingQueue é˜Ÿé¦–ä½ç½®ã€‚
        - `putIndex` å˜é‡ï¼Œ`int` ï¼ŒArrayBlockingQueue é˜Ÿå°¾ä½ç½®ã€‚
        - `count` å˜é‡ï¼Œå…ƒç´ ä¸ªæ•°ã€‚
    - `lock` å˜é‡ï¼ŒReentrantLock ï¼ŒArrayBlockingQueue å‡ºåˆ—å…¥åˆ—éƒ½å¿…é¡»è·å–è¯¥é”ï¼Œä¸¤ä¸ªæ­¥éª¤å…±ç”¨ä¸€ä¸ªé”ã€‚
        - `notEmpty` å˜é‡ï¼Œéç©ºï¼Œå³**å‡ºåˆ—**æ¡ä»¶ã€‚
        - `notFull` å˜é‡ï¼Œæœªæ»¡ï¼Œå³**å…¥åˆ—**æ¡ä»¶ã€‚

# 3. å…¥é˜Ÿ

ArrayBlockingQueue æä¾›äº†è¯¸å¤šæ–¹æ³•ï¼Œå¯ä»¥å°†å…ƒç´ åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨ã€‚

- `#add(E e)` æ–¹æ³•ï¼šå°†æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ˆå¦‚æœç«‹å³å¯è¡Œä¸”ä¸ä¼šè¶…è¿‡è¯¥é˜Ÿåˆ—çš„å®¹é‡ï¼‰ï¼Œåœ¨æˆåŠŸæ—¶è¿”å› true ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™æŠ›å‡º IllegalStateException å¼‚å¸¸ã€‚
- `#offer(E e)` æ–¹æ³•ï¼šå°†æŒ‡å®šçš„å…ƒç´ æ’å…¥åˆ°æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ˆå¦‚æœç«‹å³å¯è¡Œä¸”ä¸ä¼šè¶…è¿‡è¯¥é˜Ÿåˆ—çš„å®¹é‡ï¼‰ï¼Œåœ¨æˆåŠŸæ—¶è¿”å› true ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è¿”å› false ã€‚
- `#offer(E e, long timeout, TimeUnit unit)` æ–¹æ³•ï¼šå°†æŒ‡å®šçš„å…ƒç´ æ’å…¥æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¦‚æœè¯¥é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åœ¨åˆ°è¾¾æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ä¹‹å‰ç­‰å¾…å¯ç”¨çš„ç©ºé—´ã€‚
- `#put(E e)` æ–¹æ³•ï¼šå°†æŒ‡å®šçš„å…ƒç´ æ’å…¥æ­¤é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¦‚æœè¯¥é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ç­‰å¾…å¯ç”¨çš„ç©ºé—´ã€‚

## 3.1 add

```Java
// ArrayBlockingQueue.java
@Override
public boolean add(E e) {
    return super.add(e);
}

// AbstractQueue.java
public boolean add(E e) {
    if (offer(e))
        return true;
    else
        throw new IllegalStateException("Queue full");
}
```

* `#add(E e)`æ–¹æ³•ï¼Œè°ƒç”¨ `#offer(E e)` æ–¹æ³•ï¼Œå¦‚æœè¿”å›falseï¼Œåˆ™ç›´æ¥æŠ›å‡º IllegalStateException å¼‚å¸¸ã€‚

## 3.2 offer

```Java
@Override
public boolean offer(E e) {
    checkNotNull(e);
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        if (count == items.length)
            return false;
        else {
            enqueue(e);
            return true;
        }
    } finally {
        lock.unlock();
    }
}
```

* é¦–å…ˆï¼Œæ£€æŸ¥æ˜¯å¦ä¸º `null` ã€‚
* ç„¶åï¼Œè·å– Lock é”ã€‚è·å–é”æˆåŠŸåï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡åˆ™ï¼Œç›´æ¥è¿”å› false ã€‚
* æœ€åï¼Œè°ƒç”¨ `#enqueue(E e)` æ–¹æ³•ï¼Œ**å®ƒä¸ºå…¥åˆ—çš„æ ¸å¿ƒæ–¹æ³•**ï¼Œæ‰€æœ‰å…¥åˆ—çš„æ–¹æ³•æœ€ç»ˆéƒ½å°†è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåœ¨é˜Ÿåˆ—å°¾éƒ¨æ’å…¥å…ƒç´ ã€‚

### 3.2.1 enqueue

```Java
private void enqueue(E x) {
    // assert lock.getHoldCount() == 1;
    // assert items[putIndex] == null;
    // æ·»åŠ å…ƒç´ 
    final Object[] items = this.items;
    items[putIndex] = x;
    // åˆ°è¾¾é˜Ÿå°¾ï¼Œå›å½’é˜Ÿå¤´
    if (++putIndex == items.length)
        putIndex = 0;
    // æ€»æ•°+1
    count++;
    // é€šçŸ¥é˜»å¡åœ¨å‡ºåˆ—çš„çº¿ç¨‹
    notEmpty.signal();
}
```

* è¯¥æ–¹æ³•å°±æ˜¯åœ¨ `putIndex`ï¼ˆå¯¹å°¾ï¼‰ä½ç½®å¤„ï¼Œæ·»åŠ å…ƒç´ ï¼Œæœ€åè°ƒç”¨ `notEmpty` çš„ `#signal()` æ–¹æ³•ï¼Œ**é€šçŸ¥é˜»å¡åœ¨å‡ºåˆ—çš„çº¿ç¨‹**ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿›è¡Œå‡ºåˆ—æ“ä½œæ˜¯ä¼šé˜»å¡ï¼‰ã€‚

## 3.3 å¯è¶…æ—¶çš„ offer

```Java
public boolean offer(E e, long timeout, TimeUnit unit)
    throws InterruptedException {

    checkNotNull(e);
    long nanos = unit.toNanos(timeout);
    final ReentrantLock lock = this.lock;
    // è·å¾—é”
    lock.lockInterruptibly();
    try {
        // <1> è‹¥é˜Ÿåˆ—å·²æ»¡ï¼Œå¾ªç¯ç­‰å¾…è¢«é€šçŸ¥ï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦éç©º
        while (count == items.length) {
            // å¯ç­‰å¾…çš„æ—¶é—´å°äºç­‰äºé›¶ï¼Œç›´æ¥è¿”å›å¤±è´¥
            if (nanos <= 0)
                return false;
            // ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶
            nanos = notFull.awaitNanos(nanos); // è¿”å›çš„ä¸ºå‰©ä½™å¯ç­‰å¾…æ—¶é—´ï¼Œç›¸å½“äºæ¯æ¬¡ç­‰å¾…ï¼Œéƒ½ä¼šæ‰£é™¤ç›¸åº”å·²ç»ç­‰å¾…çš„æ—¶é—´ã€‚
        }
        // å…¥é˜Ÿ
        enqueue(e);
        return true;
    } finally {
        // è§£é”
        lock.unlock();
    }
}
```

* ç›¸æ¯” `#offer(E e)` æ–¹æ³•ï¼Œå¢åŠ äº† `<1>` å¤„ï¼š
    * è‹¥é˜Ÿåˆ—å·²æ»¡ï¼Œè°ƒç”¨ `notFull` çš„ `#awaitNanos(long nanos)` æ–¹æ³•ï¼Œç­‰å¾…è¢«é€šçŸ¥ï¼ˆå…ƒç´ å‡ºåˆ—æ—¶ï¼Œä¼šè°ƒç”¨ `notFull` çš„ `#signal()` æ–¹æ³•ï¼Œè¿›è¡Œé€šçŸ¥é˜»å¡ç­‰å¾…çš„å…¥åˆ—çº¿ç¨‹ï¼‰**æˆ–è€…è¶…æ—¶**ã€‚
    * è¢«é€šçŸ¥åï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦éç©ºã€‚è‹¥éç©ºï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¦åˆ™ç»§ç»­ç­‰å¾…è¢«é€šçŸ¥ã€‚

## 3.4 put

```Java
public void put(E e) throws InterruptedException {
    checkNotNull(e);
    final ReentrantLock lock = this.lock;
    // è·å¾—é”
    lock.lockInterruptibly();
    try {
        // <1> è‹¥é˜Ÿåˆ—å·²æ»¡ï¼Œå¾ªç¯ç­‰å¾…è¢«é€šçŸ¥ï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦éç©º
        while (count == items.length)
            notFull.await();
        // å…¥é˜Ÿ
        enqueue(e);
    } finally {
        // è§£é”
        lock.unlock();
    }
}
```

* ç›¸æ¯” `#offer(E e)` æ–¹æ³•ï¼Œå¢åŠ äº† `<1>` å¤„ï¼š
    * è‹¥é˜Ÿåˆ—å·²æ»¡ï¼Œè°ƒç”¨ `notFull` çš„ `#await()` æ–¹æ³•ï¼Œç­‰å¾…è¢«é€šçŸ¥ï¼ˆå…ƒç´ å‡ºåˆ—æ—¶ï¼Œä¼šè°ƒç”¨ `notFull` çš„ `#await()` æ–¹æ³•ï¼Œè¿›è¡Œé€šçŸ¥é˜»å¡ç­‰å¾…çš„å…¥åˆ—çº¿ç¨‹ï¼‰ã€‚
    * è¢«é€šçŸ¥åï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦éç©ºã€‚è‹¥éç©ºï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¦åˆ™ç»§ç»­ç­‰å¾…è¢«é€šçŸ¥ã€‚

# 4. å‡ºé˜Ÿ

ArrayBlockingQueue æä¾›çš„å‡ºé˜Ÿæ–¹æ³•å¦‚ä¸‹ï¼š

- `#poll()` æ–¹æ³•ï¼šè·å–å¹¶ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› `null` ã€‚
- `#poll(long timeout, TimeUnit unit) ` æ–¹æ³•ï¼šè·å–å¹¶ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œåœ¨æŒ‡å®šçš„ç­‰å¾…æ—¶é—´å‰ç­‰å¾…å¯ç”¨çš„å…ƒç´ ï¼ˆå¦‚æœæœ‰å¿…è¦ï¼‰ã€‚
- `#take()` æ–¹æ³•ï¼šè·å–å¹¶ç§»é™¤æ­¤é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œåœ¨å…ƒç´ å˜å¾—å¯ç”¨ä¹‹å‰ä¸€ç›´ç­‰å¾…ï¼ˆå¦‚æœæœ‰å¿…è¦ï¼‰ã€‚
- `#remove(Object o)` æ–¹æ³•ï¼šä»æ­¤é˜Ÿåˆ—ä¸­ç§»é™¤æŒ‡å®šå…ƒç´ çš„å•ä¸ªå®ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚

## 4.1 poll

```Java
public E poll() {
    // è·å¾—é”
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        // è·å¾—å¤´å…ƒç´ 
        return (count == 0) ? null : dequeue();
    } finally {
        // é‡Šæ”¾é”
        lock.unlock();
    }
}
```

* å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› `null`ï¼Œå¦åˆ™ï¼Œè°ƒç”¨ `#dequeue()` æ–¹æ³•ï¼Œè·å–åˆ—å¤´å…ƒç´ ã€‚

### 3.1.1 dequeue

```Java
 private E dequeue() {
    final Object[] items = this.items;
    // å»é™¤é˜Ÿé¦–å…ƒç´ 
    E x = (E) items[takeIndex];
    items[takeIndex] = null; // ç½®ç©º
    // åˆ°è¾¾é˜Ÿå°¾ï¼Œå›å½’é˜Ÿå¤´
    if (++takeIndex == items.length)
        takeIndex = 0;
    // æ€»æ•° - 1
    count--;
    // ç»´æŠ¤ä¸‹è¿­ä»£å™¨
    if (itrs != null)
        itrs.elementDequeued();
    // é€šçŸ¥é˜»å¡åœ¨å…¥åˆ—çš„çº¿ç¨‹
    notFull.signal();
    return x;
}
```

* è¯¥æ–¹æ³•ä¸»è¦æ˜¯ä»åˆ—å¤´ï¼ˆ`takeIndex` ä½ç½®ï¼‰å–å‡ºå…ƒç´ ï¼ŒåŒæ—¶å¦‚æœè¿­ä»£å™¨ `itrs` ä¸ä¸º `null` ï¼Œåˆ™éœ€è¦ç»´æŠ¤ä¸‹è¯¥è¿­ä»£å™¨ã€‚æœ€åï¼Œè°ƒç”¨ `notFull` çš„ `#signal()` æ–¹æ³•ï¼Œå”¤é†’é˜»å¡åœ¨å…¥åˆ—çº¿ç¨‹ã€‚

## 4.2 å¯è¶…æ—¶çš„ poll

```Java
public E poll(long timeout, TimeUnit unit) throws InterruptedException {
    long nanos = unit.toNanos(timeout);
    final ReentrantLock lock = this.lock;
    // è·å¾—é”
    lock.lockInterruptibly();
    try {
        // <1> è‹¥é˜Ÿåˆ—å·²ç©ºï¼Œå¾ªç¯ç­‰å¾…è¢«é€šçŸ¥ï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦éç©º
        while (count == 0) {
            // å¯ç­‰å¾…çš„æ—¶é—´å°äºç­‰äºé›¶ï¼Œç›´æ¥è¿”å› null
            if (nanos <= 0)
                return null;
            // ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶
            nanos = notEmpty.awaitNanos(nanos); // è¿”å›çš„ä¸ºå‰©ä½™å¯ç­‰å¾…æ—¶é—´ï¼Œç›¸å½“äºæ¯æ¬¡ç­‰å¾…ï¼Œéƒ½ä¼šæ‰£é™¤ç›¸åº”å·²ç»ç­‰å¾…çš„æ—¶é—´ã€‚
        }
        // å‡ºé˜Ÿ
        return dequeue();
    } finally {
        // è§£é”
        lock.unlock();
    }
}
```

* ç›¸æ¯” `#poll()` æ–¹æ³•ï¼Œå¢åŠ äº† `<1>` å¤„ï¼š
    * è‹¥é˜Ÿåˆ—å·²ç©ºï¼Œè°ƒç”¨ `notEmpty` çš„ `#awaitNanos(long nanos)` æ–¹æ³•ï¼Œç­‰å¾…è¢«é€šçŸ¥ï¼ˆå…ƒç´ å…¥åˆ—æ—¶ï¼Œä¼šè°ƒç”¨ `notEmpty` çš„ `#signal()` æ–¹æ³•ï¼Œè¿›è¡Œé€šçŸ¥é˜»å¡ç­‰å¾…çš„å‡ºåˆ—çº¿ç¨‹ï¼‰**æˆ–è€…è¶…æ—¶è¿”å› null**ã€‚
    * è¢«é€šçŸ¥åï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚è‹¥éç©ºï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¦åˆ™ç»§ç»­ç­‰å¾…è¢«é€šçŸ¥ã€‚

## 4.3 take

```Java
public E take() throws InterruptedException {
    final ReentrantLock lock = this.lock;
    // è·å¾—é”
    lock.lockInterruptibly();
    try {
        // <1> è‹¥é˜Ÿåˆ—å·²ç©ºï¼Œå¾ªç¯ç­‰å¾…è¢«é€šçŸ¥ï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦éç©º
        while (count == 0)
            notEmpty.await();
        // å‡ºåˆ—
        return dequeue();
    } finally {
        // è§£é”
        lock.unlock();
    }
}
```

* ç›¸æ¯” `#poll()` æ–¹æ³•ï¼Œå¢åŠ äº† `<1>` å¤„ï¼š
    * è‹¥é˜Ÿåˆ—å·²ç©ºï¼Œè°ƒç”¨ `notEmpty` çš„ `#await()` æ–¹æ³•ï¼Œç­‰å¾…è¢«é€šçŸ¥ï¼ˆå…ƒç´ å…¥åˆ—æ—¶ï¼Œä¼šè°ƒç”¨ `notEmpty` çš„ `#signal()` æ–¹æ³•ï¼Œè¿›è¡Œé€šçŸ¥é˜»å¡ç­‰å¾…çš„å‡ºåˆ—çº¿ç¨‹ï¼‰ã€‚
    * è¢«é€šçŸ¥åï¼Œå†æ¬¡æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚è‹¥éç©ºï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå¦åˆ™ç»§ç»­ç­‰å¾…è¢«é€šçŸ¥ã€‚

## 4.4 remove

```Java
public boolean remove(Object o) {
    if (o == null) return false;
    final Object[] items = this.items;
    // è·å¾—é”
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        if (count > 0) {
            final int putIndex = this.putIndex;
            int i = takeIndex;
            // å¾ªç¯å‘ä¸‹æŸ¥æ‰¾ï¼Œè‹¥åŒ¹é…ï¼Œåˆ™è¿›è¡Œç§»é™¤ã€‚
            do {
                if (o.equals(items[i])) {
                    removeAt(i);
                    return true;
                }
                if (++i == items.length)
                    i = 0;
            } while (i != putIndex);
        }
        return false;
    } finally {
        // é‡Šæ”¾é”
        lock.unlock();
    }
}
```

* è¯¦ç»†è§£æï¼Œè§ä»£ç æ³¨é‡Šã€‚
* `#removeAt(int removeIndex)` æ–¹æ³•ï¼Œç§»é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    void removeAt(final int removeIndex) {
        // assert lock.getHoldCount() == 1;
        // assert items[removeIndex] != null;
        // assert removeIndex >= 0 && removeIndex < items.length;
        final Object[] items = this.items;
        // ç§»é™¤çš„ä¸ºé˜Ÿå¤´ï¼Œç›´æ¥ç§»é™¤å³å¯
        if (removeIndex == takeIndex) {
            // removing front item; just advance
            items[takeIndex] = null;
            if (++takeIndex == items.length)
                takeIndex = 0;
            count--;
            if (itrs != null)
                itrs.elementDequeued();
        // ç§»é™¤éé˜Ÿå¤´ï¼Œç§»é™¤çš„åŒæ—¶ï¼Œéœ€è¦å‘å‰å¤åˆ¶ï¼Œå¡«è¡¥è¿™ä¸ªç©ºç¼ºã€‚
        } else {
            // an "interior" remove
    
            // slide over all others up through putIndex.
            final int putIndex = this.putIndex;
            for (int i = removeIndex;;) {
                int next = i + 1;
                if (next == items.length)
                    next = 0;
                if (next != putIndex) {
                    items[i] = items[next];
                    i = next;
                } else {
                    items[i] = null;
                    this.putIndex = i;
                    break;
                }
            }
            count--;
            if (itrs != null)
                itrs.removedAt(removeIndex);
        }
        // é€šçŸ¥
        notFull.signal();
    }
    ```

# 5. è¡¥å……è¯´æ˜

> è€è‰¿è‰¿ï¼šå› ä¸ºæœ¬æ–‡çš„é‡å¿ƒåœ¨ ArrayBlockingQueue çš„å…¥é˜Ÿå’Œå‡ºé˜Ÿï¼Œæ‰€ä»¥å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚è¿­ä»£å™¨ç­‰ç­‰ï¼Œå¹¶æœªè§£æã€‚æ‰€ä»¥ï¼Œèƒ–å‹ï¼Œä½ æ‡‚çš„ï¼Œè‡ªå·±ç ”ç©¶å“ˆã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

