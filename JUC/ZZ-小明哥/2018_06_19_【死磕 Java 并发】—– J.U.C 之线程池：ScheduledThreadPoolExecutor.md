title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹çº¿ç¨‹æ± ï¼šScheduledThreadPoolExecutor
date: 2018-06-19
tag: 
categories: JUC
permalink: JUC/sike/ScheduledThreadPoolExecutor
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2451
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2451 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [ScheduledThreadPoolExecutorè§£æ](http://www.iocoder.cn/JUC/sike/ScheduledThreadPoolExecutor/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åœ¨ä¸Šç¯‡åšå®¢[ã€æ­»ç£•Javaå¹¶å‘ã€‘-----J.U.Cä¹‹çº¿ç¨‹æ± ï¼šThreadPoolExecutor](http://cmsblogs.com/?p=2448)å·²ç»ä»‹ç»äº†çº¿ç¨‹æ± ä¸­æœ€æ ¸å¿ƒçš„ç±»**ThreadPoolExecutor**ï¼Œè¿™ç¯‡å°±æ¥çœ‹çœ‹å¦ä¸€ä¸ªæ ¸å¿ƒç±»**ScheduledThreadPoolExecutor**çš„å®ç°ã€‚

# ScheduledThreadPoolExecutorè§£æ

æˆ‘ä»¬çŸ¥é“Timerä¸TimerTaskè™½ç„¶å¯ä»¥å®ç°çº¿ç¨‹çš„å‘¨æœŸå’Œå»¶è¿Ÿè°ƒåº¦ï¼Œä½†æ˜¯Timerä¸TimerTaskå­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œæ‰€ä»¥å¯¹äºè¿™ç§å®šæœŸã€å‘¨æœŸæ‰§è¡Œä»»åŠ¡çš„è°ƒåº¦ç­–ç•¥ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯æ¨èScheduledThreadPoolExecutoræ¥å®ç°ã€‚ä¸‹é¢å°±æ·±å…¥åˆ†æScheduledThreadPoolExecutoræ˜¯å¦‚ä½•æ¥å®ç°çº¿ç¨‹çš„å‘¨æœŸã€å»¶è¿Ÿè°ƒåº¦çš„ã€‚

ScheduledThreadPoolExecutorï¼Œç»§æ‰¿ThreadPoolExecutorä¸”å®ç°äº†ScheduledExecutorServiceæ¥å£ï¼Œå®ƒå°±ç›¸å½“äºæä¾›äº†â€œå»¶è¿Ÿâ€å’Œâ€œå‘¨æœŸæ‰§è¡Œâ€åŠŸèƒ½çš„ThreadPoolExecutorã€‚åœ¨JDK APIä¸­æ˜¯è¿™æ ·å®šä¹‰å®ƒçš„ï¼šThreadPoolExecutorï¼Œå®ƒå¯å¦è¡Œå®‰æ’åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œå‘½ä»¤ï¼Œæˆ–è€…å®šæœŸæ‰§è¡Œå‘½ä»¤ã€‚éœ€è¦å¤šä¸ªè¾…åŠ©çº¿ç¨‹æ—¶ï¼Œæˆ–è€…è¦æ±‚ ThreadPoolExecutor å…·æœ‰é¢å¤–çš„çµæ´»æ€§æˆ–åŠŸèƒ½æ—¶ï¼Œæ­¤ç±»è¦ä¼˜äº Timerã€‚ ä¸€æ—¦å¯ç”¨å·²å»¶è¿Ÿçš„ä»»åŠ¡å°±æ‰§è¡Œå®ƒï¼Œä½†æ˜¯æœ‰å…³ä½•æ—¶å¯ç”¨ï¼Œå¯ç”¨åä½•æ—¶æ‰§è¡Œåˆ™æ²¡æœ‰ä»»ä½•å®æ—¶ä¿è¯ã€‚æŒ‰ç…§æäº¤çš„å…ˆè¿›å…ˆå‡º (FIFO) é¡ºåºæ¥å¯ç”¨é‚£äº›è¢«å®‰æ’åœ¨åŒä¸€æ‰§è¡Œæ—¶é—´çš„ä»»åŠ¡ã€‚

å®ƒæä¾›äº†å››ä¸ªæ„é€ æ–¹æ³•ï¼š

```Java
    public ScheduledThreadPoolExecutor(int corePoolSize) {
        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
                new DelayedWorkQueue());
    }

    public ScheduledThreadPoolExecutor(int corePoolSize,
                                       ThreadFactory threadFactory) {
        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
                new DelayedWorkQueue(), threadFactory);
    }

    public ScheduledThreadPoolExecutor(int corePoolSize,
                                       RejectedExecutionHandler handler) {
        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
                new DelayedWorkQueue(), handler);
    }


    public ScheduledThreadPoolExecutor(int corePoolSize,
                                       ThreadFactory threadFactory,
                                       RejectedExecutionHandler handler) {
        super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
                new DelayedWorkQueue(), threadFactory, handler);
    }
```

å½“ç„¶æˆ‘ä»¬ä¸€èˆ¬éƒ½ä¸ä¼šç›´æ¥é€šè¿‡å…¶æ„é€ å‡½æ•°æ¥ç”Ÿæˆä¸€ä¸ªScheduledThreadPoolExecutorå¯¹è±¡ï¼ˆä¾‹å¦‚new ScheduledThreadPoolExecutor(10)ä¹‹ç±»çš„ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡Executorsç±»ï¼ˆä¾‹å¦‚Executors.newScheduledThreadPool(int);ï¼‰

åœ¨ScheduledThreadPoolExecutorçš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å‘ç°å®ƒéƒ½æ˜¯åˆ©ç”¨ThreadLocalExecutoræ¥æ„é€ çš„ï¼Œå”¯ä¸€å˜åŠ¨çš„åœ°æ–¹å°±åœ¨äºå®ƒæ‰€ä½¿ç”¨çš„é˜»å¡é˜Ÿåˆ—å˜æˆäº†DelayedWorkQueueï¼Œè€Œä¸æ˜¯ThreadLocalhExecutorçš„LinkedBlockingQueueï¼ˆé€šè¿‡Executorsäº§ç”ŸThreadLocalhExecutorå¯¹è±¡ï¼‰ã€‚DelayedWorkQueueä¸ºScheduledThreadPoolExecutorä¸­çš„å†…éƒ¨ç±»ï¼Œå®ƒå…¶å®å’Œé˜»å¡é˜Ÿåˆ—DelayQueueæœ‰ç‚¹å„¿ç±»ä¼¼ã€‚DelayQueueæ˜¯å¯ä»¥æä¾›å»¶è¿Ÿçš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ƒåªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»ä¸­æå–å…ƒç´ ï¼Œå…¶åˆ—å¤´æ˜¯å»¶è¿ŸæœŸæ»¡åä¿å­˜æ—¶é—´æœ€é•¿çš„Delayedå…ƒç´ ã€‚å¦‚æœå»¶è¿Ÿéƒ½è¿˜æ²¡æœ‰æœŸæ»¡ï¼Œåˆ™é˜Ÿåˆ—æ²¡æœ‰å¤´éƒ¨ï¼Œå¹¶ä¸” poll å°†è¿”å› nullã€‚æœ‰å…³äºDelayQueueçš„æ›´å¤šä»‹ç»è¯·å‚è€ƒè¿™ç¯‡åšå®¢[ã€æ­»ç£•Javaå¹¶å‘ã€‘-----J.U.Cä¹‹é˜»å¡é˜Ÿåˆ—ï¼šDelayQueue](http://cmsblogs.com/?p=2413)ã€‚æ‰€ä»¥DelayedWorkQueueä¸­çš„ä»»åŠ¡å¿…ç„¶æ˜¯æŒ‰ç…§å»¶è¿Ÿæ—¶é—´ä»çŸ­åˆ°é•¿æ¥è¿›è¡Œæ’åºçš„ã€‚ä¸‹é¢æˆ‘ä»¬å†æ·±å…¥åˆ†æDelayedWorkQueueï¼Œè¿™é‡Œç•™ä¸€ä¸ªå¼•å­ã€‚

ScheduledThreadPoolExecutoræä¾›äº†å¦‚ä¸‹å››ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å››ä¸ªè°ƒåº¦å™¨ï¼š

1. schedule(Callable callable, long delay, TimeUnit unit) :åˆ›å»ºå¹¶æ‰§è¡Œåœ¨ç»™å®šå»¶è¿Ÿåå¯ç”¨çš„ ScheduledFutureã€‚
2. schedule(Runnable command, long delay, TimeUnit unit) :åˆ›å»ºå¹¶æ‰§è¡Œåœ¨ç»™å®šå»¶è¿Ÿåå¯ç”¨çš„ä¸€æ¬¡æ€§æ“ä½œã€‚
3. scheduleAtFixedRate(Runnable command, long initialDelay, long period, TimeUnit unit) :åˆ›å»ºå¹¶æ‰§è¡Œä¸€ä¸ªåœ¨ç»™å®šåˆå§‹å»¶è¿Ÿåé¦–æ¬¡å¯ç”¨çš„å®šæœŸæ“ä½œï¼Œåç»­æ“ä½œå…·æœ‰ç»™å®šçš„å‘¨æœŸï¼›ä¹Ÿå°±æ˜¯å°†åœ¨ initialDelay åå¼€å§‹æ‰§è¡Œï¼Œç„¶ååœ¨ initialDelay+period åæ‰§è¡Œï¼Œæ¥ç€åœ¨ initialDelay + 2 * period åæ‰§è¡Œï¼Œä¾æ­¤ç±»æ¨ã€‚
4. scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit) :åˆ›å»ºå¹¶æ‰§è¡Œä¸€ä¸ªåœ¨ç»™å®šåˆå§‹å»¶è¿Ÿåé¦–æ¬¡å¯ç”¨çš„å®šæœŸæ“ä½œï¼Œéšåï¼Œåœ¨æ¯ä¸€æ¬¡æ‰§è¡Œç»ˆæ­¢å’Œä¸‹ä¸€æ¬¡æ‰§è¡Œå¼€å§‹ä¹‹é—´éƒ½å­˜åœ¨ç»™å®šçš„å»¶è¿Ÿã€‚

ç¬¬ä¸€ã€äºŒä¸ªæ–¹æ³•å·®ä¸å¤šï¼Œéƒ½æ˜¯ä¸€æ¬¡æ€§æ“ä½œï¼Œåªä¸è¿‡å‚æ•°ä¸€ä¸ªæ˜¯Callableï¼Œä¸€ä¸ªæ˜¯Runnableã€‚ç¨å¾®åˆ†æä¸‹ç¬¬ä¸‰ï¼ˆscheduleAtFixedRateï¼‰ã€å››ä¸ªï¼ˆscheduleWithFixedDelayï¼‰æ–¹æ³•ï¼ŒåŠ å…¥initialDelay = 5ï¼Œperiod/delay = 3ï¼Œunitä¸ºç§’ã€‚å¦‚æœæ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯éƒ½è¿è¡Œéå¸¸è‰¯å¥½ä¸å­˜åœ¨å»¶è¿Ÿçš„é—®é¢˜ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ³•çº¿ç¨‹è¿è¡Œå‘¨æœŸæ˜¯5ã€8ã€11ã€14ã€17.......ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨å»¶è¿Ÿå‘¢ï¼Ÿæ¯”å¦‚ç¬¬ä¸‰ä¸ªçº¿ç¨‹ç”¨äº†5ç§’é’Ÿï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ³•çš„å¤„ç†ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼ˆscheduleAtFixedRateï¼‰æ˜¯å‘¨æœŸå›ºå®šï¼Œä¹Ÿå°±è¯´å®ƒæ˜¯ä¸ä¼šå—åˆ°è¿™ä¸ªå»¶è¿Ÿçš„å½±å“çš„ï¼Œæ¯ä¸ªçº¿ç¨‹çš„è°ƒåº¦å‘¨æœŸåœ¨åˆå§‹åŒ–æ—¶å°±å·²ç»ç»å¯¹äº†ï¼Œæ˜¯ä»€ä¹ˆæ—¶å€™è°ƒåº¦å°±æ˜¯ä»€ä¹ˆæ—¶å€™è°ƒåº¦ï¼Œå®ƒä¸ä¼šå› ä¸ºä¸Šä¸€ä¸ªçº¿ç¨‹çš„è°ƒåº¦å¤±æ•ˆå»¶è¿Ÿè€Œå—åˆ°å½±å“ã€‚ä½†æ˜¯ç¬¬å››ä¸ªæ–¹æ³•ï¼ˆscheduleWithFixedDelayï¼‰ï¼Œåˆ™ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯æ¯ä¸ªçº¿ç¨‹çš„è°ƒåº¦é—´éš”å›ºå®šï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸ç¬¬äºŒçº¿ç¨‹ä¹‹é—´é—´éš”delayï¼Œç¬¬äºŒä¸ªä¸ç¬¬ä¸‰ä¸ªé—´éš”delayï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœç¬¬äºŒçº¿ç¨‹æ¨è¿Ÿäº†é‚£ä¹ˆåé¢æ‰€æœ‰çš„çº¿ç¨‹è°ƒåº¦éƒ½ä¼šæ¨è¿Ÿï¼Œä¾‹å¦‚ï¼Œä¸Šé¢ç¬¬äºŒçº¿ç¨‹æ¨è¿Ÿäº†2ç§’ï¼Œé‚£ä¹ˆç¬¬ä¸‰ä¸ªå°±ä¸å†æ˜¯11ç§’æ‰§è¡Œäº†ï¼Œè€Œæ˜¯13ç§’æ‰§è¡Œã€‚

æŸ¥çœ‹ç€å››ä¸ªæ–¹æ³•çš„æºç ï¼Œä¼šå‘ç°å…¶å®ä»–ä»¬çš„å¤„ç†é€»è¾‘éƒ½å·®ä¸å¤šï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æŒ‘scheduleWithFixedDelayæ–¹æ³•æ¥åˆ†æï¼Œå¦‚ä¸‹ï¼š

```Java
    public ScheduledFuture<?> scheduleWithFixedDelay(Runnable command,
                                                     long initialDelay,
                                                     long delay,
                                                     TimeUnit unit) {
        if (command == null || unit == null)
            throw new NullPointerException();
        if (delay <= 0)
            throw new IllegalArgumentException();
        ScheduledFutureTask<Void> sft =
            new ScheduledFutureTask<Void>(command,
                                          null,
                                          triggerTime(initialDelay, unit),
                                          unit.toNanos(-delay));
        RunnableScheduledFuture<Void> t = decorateTask(command, sft);
        sft.outerTask = t;
        delayedExecute(t);
        return t;
    }
```

scheduleWithFixedDelayæ–¹æ³•å¤„ç†çš„é€»è¾‘å¦‚ä¸‹ï¼š

1. æ ¡éªŒï¼Œå¦‚æœå‚æ•°ä¸åˆæ³•åˆ™æŠ›å‡ºå¼‚å¸¸
2. æ„é€ ä¸€ä¸ªtaskï¼Œè¯¥taskä¸ºScheduledFutureTask
3. è°ƒç”¨delayedExecute()æ–¹æ³•åšåç»­ç›¸å…³å¤„ç†

è¿™æ®µä»£ç æ¶‰åŠä¸¤ä¸ªç±»ScheduledFutureTaskå’ŒRunnableScheduledFutureï¼Œå…¶ä¸­RunnableScheduledFutureä¸ç”¨å¤šè¯´ï¼Œä»–ç»§æ‰¿RunnableFutureå’ŒScheduledFutureä¸¤ä¸ªæ¥å£ï¼Œé™¤äº†å…·å¤‡RunnableFutureå’ŒScheduledFutureä¸¤ç±»ç‰¹æ€§å¤–ï¼Œå®ƒè¿˜å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•isPeriodic() ï¼Œè¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­æ‰§è¡Œçš„ä»»åŠ¡æ˜¯å¦ä¸ºå®šæœŸä»»åŠ¡ï¼Œå¦‚æœæ˜¯åˆ™è¿”å›trueã€‚è€ŒScheduledFutureTaskä½œä¸ºScheduledThreadPoolExecutorçš„å†…éƒ¨ç±»ï¼Œå®ƒæ‰®æ¼”ç€æå…¶é‡è¦çš„ä½œç”¨ï¼Œå› ä¸ºå®ƒçš„ä½œç”¨åˆ™æ˜¯è´Ÿè´£ScheduledThreadPoolExecutorä¸­ä»»åŠ¡çš„è°ƒåº¦ã€‚

ScheduledFutureTaskå†…éƒ¨ç»§æ‰¿FutureTaskï¼Œå®ç°RunnableScheduledFutureæ¥å£ï¼Œå®ƒå†…éƒ¨å®šä¹‰äº†ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„å˜é‡

```Java
        /** ä»»åŠ¡è¢«æ·»åŠ åˆ°ScheduledThreadPoolExecutorä¸­çš„åºå· */
        private final long sequenceNumber;

        /** ä»»åŠ¡è¦æ‰§è¡Œçš„å…·ä½“æ—¶é—´ */
        private long time;

        /**  ä»»åŠ¡çš„é—´éš”å‘¨æœŸ /
        private final long period;
```

è¿™ä¸‰ä¸ªå˜é‡ä¸ä»»åŠ¡çš„æ‰§è¡Œæœ‰ç€éå¸¸å¯†åˆ‡çš„å…³ç³»ï¼Œä»€ä¹ˆå…³ç³»ï¼Ÿå…ˆçœ‹ScheduledFutureTaskçš„å‡ ä¸ªæ„é€ å‡½æ•°å’Œæ ¸å¿ƒæ–¹æ³•ï¼š

```Java
        ScheduledFutureTask(Runnable r, V result, long ns) {
            super(r, result);
            this.time = ns;
            this.period = 0;
            this.sequenceNumber = sequencer.getAndIncrement();
        }

        ScheduledFutureTask(Runnable r, V result, long ns, long period) {
            super(r, result);
            this.time = ns;
            this.period = period;
            this.sequenceNumber = sequencer.getAndIncrement();
        }

        ScheduledFutureTask(Callable<V> callable, long ns) {
            super(callable);
            this.time = ns;
            this.period = 0;
            this.sequenceNumber = sequencer.getAndIncrement();
        }

        ScheduledFutureTask(Callable<V> callable, long ns) {
            super(callable);
            this.time = ns;
            this.period = 0;
            this.sequenceNumber = sequencer.getAndIncrement();
        }
```

ScheduledFutureTask æä¾›äº†å››ä¸ªæ„é€ æ–¹æ³•ï¼Œè¿™äº›æ„é€ æ–¹æ³•ä¸ä¸Šé¢ä¸‰ä¸ªå‚æ•°æ˜¯ä¸æ˜¯ä¸€ä¸€å¯¹åº”äº†ï¼Ÿè¿™äº›å‚æ•°æœ‰ä»€ä¹ˆç”¨ï¼Œå¦‚ä½•ç”¨ï¼Œåˆ™è¦çœ‹ScheduledFutureTaskåœ¨é‚£äº›æ–¹æ³•ä½¿ç”¨äº†è¯¥æ–¹æ³•ï¼Œåœ¨ScheduledFutureTaskä¸­æœ‰ä¸€ä¸ªcompareTo()æ–¹æ³•ï¼š

```Java
    public int compareTo(Delayed other) {
        if (other == this) // compare zero if same object
            return 0;
        if (other instanceof ScheduledFutureTask) {
            ScheduledFutureTask<?> x = (ScheduledFutureTask<?>)other;
            long diff = time - x.time;
            if (diff < 0)
                return -1;
            else if (diff > 0)
                return 1;
            else if (sequenceNumber < x.sequenceNumber)
                return -1;
            else
                return 1;
        }
        long diff = getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS);
        return (diff < 0) ? -1 : (diff > 0) ? 1 : 0;
    }
```

ç›¸ä¿¡å„ä½éƒ½çŸ¥é“è¯¥æ–¹æ³•æ˜¯å¹²å˜›ç”¨çš„ï¼Œæä¾›ä¸€ä¸ªæ’åºç®—æ³•ï¼Œè¯¥ç®—æ³•è§„åˆ™æ˜¯ï¼šé¦–å…ˆæŒ‰ç…§timeæ’åºï¼Œtimeå°çš„æ’åœ¨å‰é¢ï¼Œå¤§çš„æ’åœ¨åé¢ï¼Œå¦‚æœtimeç›¸åŒï¼Œåˆ™ä½¿ç”¨sequenceNumberæ’åºï¼Œå°çš„æ’åœ¨å‰é¢ï¼Œå¤§çš„æ’åœ¨åé¢ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªç±»é‡Œé¢æä¾›compareTo()æ–¹æ³•å‘¢ï¼Ÿåœ¨å‰é¢å°±ä»‹ç»è¿‡ScheduledThreadPoolExecutoråœ¨æ„é€ æ–¹æ³•ä¸­æä¾›çš„æ˜¯DelayedWorkQueue()é˜Ÿåˆ—ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ScheduledThreadPoolExecutoræ˜¯æŠŠä»»åŠ¡æ·»åŠ åˆ°DelayedWorkQueueä¸­çš„ï¼Œè€ŒDelayedWorkQueueåˆ™æ˜¯ç±»ä¼¼äºDelayQueueï¼Œå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªä»¥æ—¶é—´ä¸ºå…ˆåé¡ºåºçš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥compareTo()æ–¹æ³•ä½¿ç”¨ä¸DelayedWorkQueueé˜Ÿåˆ—å¯¹å…¶å…ƒç´ ScheduledThreadPoolExecutor taskè¿›è¡Œæ’åºçš„ç®—æ³•ã€‚

æ’åºå·²ç»è§£å†³äº†ï¼Œé‚£ä¹ˆScheduledThreadPoolExecutor æ˜¯å¦‚ä½•å¯¹taskä»»åŠ¡è¿›è¡Œè°ƒåº¦å’Œå»¶è¿Ÿçš„å‘¢ï¼Ÿä»»ä½•çº¿ç¨‹çš„æ‰§è¡Œï¼Œéƒ½æ˜¯é€šè¿‡run()æ–¹æ³•æ‰§è¡Œï¼ŒScheduledThreadPoolExecutor çš„run()æ–¹æ³•å¦‚ä¸‹ï¼š

```Java
        public void run() {
            boolean periodic = isPeriodic();
            if (!canRunInCurrentRunState(periodic))
                cancel(false);
            else if (!periodic)
                ScheduledFutureTask.super.run();
            else if (ScheduledFutureTask.super.runAndReset()) {
                setNextRunTime();
                reExecutePeriodic(outerTask);
            }
        }
```

1. è°ƒç”¨isPeriodic()è·å–è¯¥çº¿ç¨‹æ˜¯å¦ä¸ºå‘¨æœŸæ€§ä»»åŠ¡æ ‡å¿—ï¼Œç„¶åè°ƒç”¨canRunInCurrentRunState()æ–¹æ³•åˆ¤æ–­è¯¥çº¿ç¨‹æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œå¦‚æœä¸å¯ä»¥æ‰§è¡Œåˆ™è°ƒç”¨cancel()å–æ¶ˆä»»åŠ¡ã€‚
2. å¦‚æœå½“çº¿ç¨‹å·²ç»åˆ°è¾¾äº†æ‰§è¡Œç‚¹ï¼Œåˆ™è°ƒç”¨run()æ–¹æ³•æ‰§è¡Œtaskï¼Œè¯¥run()æ–¹æ³•æ˜¯åœ¨FutureTaskä¸­å®šä¹‰çš„ã€‚
3. å¦åˆ™è°ƒç”¨runAndReset()æ–¹æ³•è¿è¡Œå¹¶å……å€¼ï¼Œè°ƒç”¨setNextRunTime()æ–¹æ³•è®¡ç®—ä»»åŠ¡ä¸‹æ¬¡çš„æ‰§è¡Œæ—¶é—´ï¼Œé‡æ–°æŠŠä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œè®©è¯¥ä»»åŠ¡å¯ä»¥é‡å¤æ‰§è¡Œã€‚

**isPeriodic()**

è¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­æŒ‡å®šçš„ä»»åŠ¡æ˜¯å¦ä¸ºå®šæœŸä»»åŠ¡ã€‚

```Java
        public boolean isPeriodic() {
            return period != 0;
        }
```

canRunInCurrentRunState()åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å¯ä»¥å–æ¶ˆï¼Œcancel()å–æ¶ˆä»»åŠ¡ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œè€Œrun()æ‰§è¡Œä»»åŠ¡ï¼ŒrunAndReset()è¿è¡Œå¹¶é‡ç½®çŠ¶æ€ï¼Œç‰µæ¶‰æ¯”è¾ƒå¹¿ï¼Œæˆ‘ä»¬æ”¾åœ¨FutureTaskåé¢ä»‹ç»ã€‚æ‰€ä»¥é‡ç‚¹ä»‹ç»setNextRunTime()å’ŒreExecutePeriodic()è¿™ä¸¤ä¸ªæ¶‰åŠåˆ°å»¶è¿Ÿçš„æ–¹æ³•ã€‚

**setNextRunTime()**

setNextRunTime()æ–¹æ³•ç”¨äºé‡æ–°è®¡ç®—ä»»åŠ¡çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ã€‚å¦‚ä¸‹ï¼š

```Java
        private void setNextRunTime() {
            long p = period;
            if (p > 0)
                time += p;
            else
                time = triggerTime(-p);
        }
```

è¯¥æ–¹æ³•å®šä¹‰å¾ˆç®€å•ï¼Œp > 0 ,time += p ï¼Œå¦åˆ™è°ƒç”¨triggerTime()æ–¹æ³•é‡æ–°è®¡ç®—timeï¼š

```Java
    long triggerTime(long delay) {
        return now() +
            ((delay < (Long.MAX_VALUE >> 1)) ? delay : overflowFree(delay));
    }
```

**reExecutePeriodic**

```Java
    void reExecutePeriodic(RunnableScheduledFuture<?> task) {
        if (canRunInCurrentRunState(true)) {
            super.getQueue().add(task);
            if (!canRunInCurrentRunState(true) && remove(task))
                task.cancel(false);
            else
                ensurePrestart();
        }
    }
```

reExecutePeriodicé‡è¦çš„æ˜¯è°ƒç”¨super.getQueue().add(task);å°†ä»»åŠ¡taskåŠ å…¥çš„é˜Ÿåˆ—DelayedWorkQueueä¸­ã€‚ensurePrestart()åœ¨[ã€æ­»ç£•Javaå¹¶å‘ã€‘-----J.U.Cä¹‹çº¿ç¨‹æ± ï¼šThreadPoolExecutor](http://cmsblogs.com/?p=2448)å·²ç»åšäº†è¯¦ç»†ä»‹ç»ã€‚

åˆ°è¿™é‡ŒScheduledFutureTaskå·²ç»ä»‹ç»å®Œäº†ï¼ŒScheduledFutureTaskåœ¨ScheduledThreadPoolExecutoræ‰®æ¼”ä½œç”¨çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚å…¶å®ScheduledThreadPoolExecutorçš„å®ç°ä¸æ˜¯å¾ˆå¤æ‚ï¼Œå› ä¸ºæœ‰FutureTaskå’ŒThreadPoolExecutorçš„æ”¯æ’‘ï¼Œå…¶å®ç°å°±æ˜¾å¾—ä¸æ˜¯é‚£ä¹ˆéš¾äº†ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)