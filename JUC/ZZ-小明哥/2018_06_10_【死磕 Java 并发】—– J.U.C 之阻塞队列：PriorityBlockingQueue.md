title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹é˜»å¡é˜Ÿåˆ—ï¼šPriorityBlockingQueue
date: 2018-06-10
tag: 
categories: JUC
permalink: JUC/sike/PriorityBlockingQueue
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2407
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2407 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [äºŒå‰å †](http://www.iocoder.cn/JUC/sike/PriorityBlockingQueue/)
  - [PriorityBlockingQueue](http://www.iocoder.cn/JUC/sike/PriorityBlockingQueue/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

æˆ‘ä»¬çŸ¥é“çº¿ç¨‹Threadå¯ä»¥è°ƒç”¨setPriority(int newPriority)æ¥è®¾ç½®ä¼˜å…ˆçº§çš„ï¼Œçº¿ç¨‹ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œä¼˜å…ˆçº§ä½çš„åæ‰§è¡Œã€‚è€Œå‰é¢ä»‹ç»çš„ArrayBlockingQueueã€LinkedBlockingQueueéƒ½æ˜¯é‡‡ç”¨FIFOåŸåˆ™æ¥ç¡®å®šçº¿ç¨‹æ‰§è¡Œçš„å…ˆåé¡ºåºï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥æ”¯æŒä¼˜å…ˆçº§å‘¢ï¼Ÿ PriorityBlockingQueue ã€‚

PriorityBlockingQueueæ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡ç”¨è‡ªç„¶é¡ºåºå‡åºæ’åºï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ¥æŒ‡å®šComparatoræ¥å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚éœ€è¦æ³¨æ„çš„æ˜¯PriorityBlockingQueueä¸èƒ½ä¿è¯åŒä¼˜å…ˆçº§å…ƒç´ çš„é¡ºåºã€‚

## äºŒå‰å †

ç”±äºPriorityBlockingQueueåº•å±‚é‡‡ç”¨äºŒå‰å †æ¥å®ç°çš„ï¼Œæ‰€ä»¥æœ‰å¿…è¦å…ˆä»‹ç»ä¸‹äºŒå‰å †ã€‚

äºŒå‰å †æ˜¯ä¸€ç§ç‰¹æ®Šçš„å †ï¼Œå°±ç»“æ„æ€§è€Œè¨€å°±æ˜¯å®Œå…¨äºŒå‰æ ‘æˆ–è€…æ˜¯è¿‘ä¼¼å®Œå…¨äºŒå‰æ ‘ï¼Œæ»¡è¶³æ ‘ç»“æ„æ€§å’Œå †åºæ€§ã€‚æ ‘æœºæ„ç‰¹æ€§å°±æ˜¯å®Œå…¨äºŒå‰æ ‘åº”è¯¥æœ‰çš„ç»“æ„ï¼Œå †åºæ€§åˆ™æ˜¯ï¼šçˆ¶èŠ‚ç‚¹çš„é”®å€¼æ€»æ˜¯ä¿æŒå›ºå®šçš„åºå…³ç³»äºä»»ä½•ä¸€ä¸ªå­èŠ‚ç‚¹çš„é”®å€¼ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å­æ ‘å’Œå³å­æ ‘éƒ½æ˜¯ä¸€ä¸ªäºŒå‰å †ã€‚å®ƒæœ‰ä¸¤ç§è¡¨ç°å½¢å¼ï¼šæœ€å¤§å †ã€æœ€å°å †ã€‚

æœ€å¤§å †ï¼šçˆ¶èŠ‚ç‚¹çš„é”®å€¼æ€»æ˜¯å¤§äºæˆ–ç­‰äºä»»ä½•ä¸€ä¸ªå­èŠ‚ç‚¹çš„é”®å€¼ï¼ˆä¸‹å³å›¾ï¼‰

æœ€å°å †ï¼šçˆ¶èŠ‚ç‚¹çš„é”®å€¼æ€»æ˜¯å°äºæˆ–ç­‰äºä»»ä½•ä¸€ä¸ªå­èŠ‚ç‚¹çš„é”®å€¼ï¼ˆä¸‹èµ°å›¾ï¼‰

[![201703270001](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827001.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827001.png)

äºŒå‰å †ä¸€èˆ¬ç”¨æ•°ç»„è¡¨ç¤ºï¼Œå¦‚æœçˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹ä½ç½®åœ¨nå¤„ï¼Œé‚£ä¹ˆå…¶å·¦å­©å­èŠ‚ç‚¹ä¸ºï¼š2 * n + 1 ï¼Œå…¶å³å­©å­èŠ‚ç‚¹ä¸º2 * (n + 1)ï¼Œå…¶çˆ¶èŠ‚ç‚¹ä¸ºï¼ˆn - 1ï¼‰ / 2 å¤„ã€‚ä¸Šå·¦å›¾çš„æ•°ç»„è¡¨ç°å½¢å¼ä¸ºï¼š

[![201703270002_2](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827002.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827002.png)

äºŒå‰å †çš„åŸºæœ¬ç»“æ„äº†è§£äº†ï¼Œä¸‹é¢æ¥çœ‹çœ‹äºŒå‰å †çš„æ·»åŠ å’Œåˆ é™¤èŠ‚ç‚¹ã€‚äºŒå‰å †çš„æ·»åŠ å’Œåˆ é™¤ç›¸å¯¹äºäºŒå‰æ ‘æ¥è¯´ä¼šç®€å•å¾ˆå¤šã€‚

### æ·»åŠ å…ƒç´ 

é¦–å…ˆå°†è¦æ·»åŠ çš„å…ƒç´ Næ’æ·»åŠ åˆ°å †çš„æœ«å°¾ä½ç½®ï¼ˆåœ¨äºŒå‰å †ä¸­æˆ‘ä»¬ç§°ä¹‹ä¸ºç©ºç©´ï¼‰ã€‚å¦‚æœå…ƒç´ Næ”¾å…¥ç©ºç©´ä¸­è€Œä¸ç ´åå †çš„åºï¼ˆå…¶å€¼å¤§äºè·Ÿçˆ¶èŠ‚ç‚¹å€¼ï¼ˆæœ€å¤§å †æ˜¯å°äºçˆ¶èŠ‚ç‚¹ï¼‰ï¼‰ï¼Œé‚£ä¹ˆæ’å…¥å®Œæˆã€‚å¦åˆ™ï¼Œæˆ‘ä»¬åˆ™å°†è¯¥å…ƒç´ Nçš„èŠ‚ç‚¹ä¸å…¶çˆ¶èŠ‚ç‚¹è¿›è¡Œäº¤æ¢ï¼Œç„¶åä¸å…¶æ–°çˆ¶èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒç›´åˆ°å®ƒçš„çˆ¶èŠ‚ç‚¹ä¸åœ¨æ¯”å®ƒå°ï¼ˆæœ€å¤§å †æ˜¯å¤§ï¼‰æˆ–è€…åˆ°è¾¾æ ¹èŠ‚ç‚¹ã€‚

å‡å¦‚æœ‰å¦‚ä¸‹ä¸€ä¸ªäºŒå‰å †

[![201703270003_3](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827003.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827003.png)

è¿™æ˜¯ä¸€ä¸ªæœ€å°å †ï¼Œå…¶çˆ¶èŠ‚ç‚¹æ€»æ˜¯å°äºç­‰äºä»»ä¸€ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚ç°åœ¨æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå…ƒç´ 2ã€‚

ç¬¬ä¸€æ­¥ï¼šåœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªå…ƒç´ 2ï¼Œå¦‚ä¸‹ï¼š

ç¬¬äºŒæ­¥ï¼šå…ƒç´ 2æ¯”å…¶çˆ¶èŠ‚ç‚¹6å°ï¼Œè¿›è¡Œæ›¿æ¢ï¼Œå¦‚ä¸‹ï¼š

[![201703270005_3](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827005.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827005.png)
ç¬¬ä¸‰æ­¥ï¼šç»§ç»­ä¸å…¶çˆ¶èŠ‚ç‚¹5æ¯”è¾ƒï¼Œå°äºï¼Œæ›¿æ¢ï¼š

[![201703270006_3](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827006.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827006.png)

ç¬¬å››æ­¥ï¼šç»§ç»­æ¯”è¾ƒå…¶è·ŸèŠ‚ç‚¹1ï¼Œå‘ç°è·ŸèŠ‚ç‚¹æ¯”è‡ªå·±å°ï¼Œåˆ™å®Œæˆï¼Œåˆ°è¿™é‡Œå…ƒç´ 2æ’å…¥å®Œæ¯•ã€‚æ‰€ä»¥æ•´ä¸ªæ·»åŠ å…ƒç´ è¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼šåœ¨å…ƒç´ æœ«å°¾æ’å…¥å…ƒç´ ï¼Œç„¶åä¸æ–­æ¯”è¾ƒæ›¿æ¢ç›´åˆ°ä¸èƒ½ç§»åŠ¨ä¸ºæ­¢ã€‚

å¤æ‚åº¦ï¼šÎŸ(logn)

### åˆ é™¤å…ƒç´ 

åˆ é™¤å…ƒç´ ä¸å¢åŠ å…ƒç´ ä¸€æ ·ï¼Œéœ€è¦ç»´æŠ¤æ•´ä¸ªäºŒå‰å †çš„åºã€‚åˆ é™¤ä½ç½®1çš„å…ƒç´ ï¼ˆæ•°ç»„ä¸‹æ ‡0ï¼‰ï¼Œåˆ™æŠŠæœ€åä¸€ä¸ªå…ƒç´ ç©ºå‡ºæ¥ç§»åˆ°æœ€å‰è¾¹ï¼Œç„¶åå’Œå®ƒçš„ä¸¤ä¸ªå­èŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœä¸¤ä¸ªå­èŠ‚ç‚¹ä¸­è¾ƒå°çš„èŠ‚ç‚¹å°äºè¯¥èŠ‚ç‚¹ï¼Œå°±å°†ä»–ä»¬äº¤æ¢ï¼ŒçŸ¥é“ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½æ¯”è¯¥å…ƒç´ å¤§ä¸ºæ­¢ã€‚

å°±ä¸Šé¢äºŒå‰å †è€Œè¨€ï¼Œåˆ é™¤çš„å…ƒç´ ä¸ºå…ƒç´ 1ã€‚

ç¬¬ä¸€æ­¥ï¼šåˆ æ‰å…ƒç´ 1ï¼Œå…ƒç´ 6ç©ºå‡ºæ¥ï¼Œå¦‚ä¸‹ï¼š

ç¬¬äºŒæ­¥ï¼šä¸å…¶ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼ˆå…ƒç´ 2ã€å…ƒç´ 3ï¼‰æ¯”è¾ƒï¼Œéƒ½å°ï¼Œå°†å…¶ä¸­è¾ƒå°çš„å…ƒç´ ï¼ˆå…ƒç´ 2ï¼‰æ”¾å…¥åˆ°è¯¥ç©ºç©´ä¸­ï¼š

[![201703270008](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827008.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827008.png)
ç¬¬ä¸‰æ­¥ï¼šç»§ç»­æ¯”è¾ƒä¸¤ä¸ªå­èŠ‚ç‚¹ï¼ˆå…ƒç´ 5ã€å…ƒç´ 7ï¼‰ï¼Œè¿˜æ˜¯éƒ½å°ï¼Œåˆ™å°†è¾ƒå°çš„å…ƒç´ ï¼ˆå…ƒç´ 5ï¼‰æ”¾å…¥åˆ°è¯¥ç©ºç©´ä¸­ï¼š[![201703270004_4](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827004.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827004.png)[![201703270007_4](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827007.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827007.png)

ç¬¬å››æ­¥ï¼šæ¯”è¾ƒå…¶å­èŠ‚ç‚¹ï¼ˆå…ƒç´ 8ï¼‰ï¼Œæ¯”è¯¥èŠ‚ç‚¹å°ï¼Œåˆ™å…ƒç´ 6æ”¾å…¥è¯¥ç©ºç©´ä½ç½®ä¸ä¼šå½±å“äºŒå‰å †çš„æ ‘ç»“æ„ï¼Œæ”¾å…¥ï¼š

[![201703270010_3](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208270010.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/20181208270010.png)
åˆ°è¿™é‡Œæ•´ä¸ªåˆ é™¤æ“ä½œå°±å·²ç»å®Œæˆäº†ã€‚

äºŒå‰å †çš„æ·»åŠ ã€åˆ é™¤æ“ä½œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¾ˆå®¹æ˜“å°±ç†è§£äº†ã€‚ä¸‹é¢æˆ‘ä»¬å°±å‚è€ƒè¯¥å†…å®¹æ¥å¼€å¯PriorityBlockingQueueçš„æºä»£ç ç ”ç©¶ã€‚

## PriorityBlockingQueue

PriorityBlockingQueueç»§æ‰¿AbstractQueueï¼Œå®ç°BlockingQueueæ¥å£ã€‚

```Java
public class PriorityBlockingQueue<E> extends AbstractQueue<E>
    implements BlockingQueue<E>, java.io.Serializable
```

å®šä¹‰äº†ä¸€äº›å±æ€§

```Java
// é»˜è®¤å®¹é‡
    private static final int DEFAULT_INITIAL_CAPACITY = 11;

    // æœ€å¤§å®¹é‡
    private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;

    // äºŒå‰å †æ•°ç»„
    private transient Object[] queue;

    // é˜Ÿåˆ—å…ƒç´ çš„ä¸ªæ•°
    private transient int size;

    // æ¯”è¾ƒå™¨ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä¸ºè‡ªç„¶é¡ºåº
    private transient Comparator<? super E> comparator;

    // å†…éƒ¨é”
    private final ReentrantLock lock;

    private final Condition notEmpty;

    //
    private transient volatile int allocationSpinLock;

    // ä¼˜å…ˆé˜Ÿåˆ—ï¼šä¸»è¦ç”¨äºåºåˆ—åŒ–ï¼Œè¿™æ˜¯ä¸ºäº†å…¼å®¹ä¹‹å‰çš„ç‰ˆæœ¬ã€‚åªæœ‰åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ‰éç©º
    private PriorityQueue<E> q;
```

å†…éƒ¨ä»ç„¶é‡‡ç”¨å¯é‡å…¥é”ReentrantLockæ¥å®ç°åŒæ­¥æœºåˆ¶ï¼Œä½†æ˜¯è¿™é‡Œåªæœ‰ä¸€ä¸ªnotEmptyçš„Conditionï¼Œäº†è§£äº†ArrayBlockingQueueæˆ‘ä»¬çŸ¥é“å®ƒå®šä¹‰äº†ä¸¤ä¸ªConditionï¼Œä¹‹ç±»ä¸ºä½•åªæœ‰ä¸€ä¸ªå‘¢ï¼ŸåŸå› å°±åœ¨äºPriorityBlockingQueueæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼Œæ’å…¥æ€»æ˜¯ä¼šæˆåŠŸï¼Œé™¤éæ¶ˆè€—å°½äº†èµ„æºå¯¼è‡´æœåŠ¡å™¨æŒ‚ã€‚

### å…¥åˆ—

PriorityBlockingQueueæä¾›put()ã€add()ã€offer()æ–¹æ³•å‘é˜Ÿåˆ—ä¸­åŠ å…¥å…ƒç´ ã€‚æˆ‘ä»¬è¿™é‡Œä»put()å…¥æ‰‹ï¼šput(E e) ï¼šå°†æŒ‡å®šå…ƒç´ æ’å…¥æ­¤ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚

```Java
    public void put(E e) {
        offer(e); // never need to block
    }
```

PriorityBlockingQueueæ˜¯æ— ç•Œçš„ï¼Œæ‰€ä»¥ä¸å¯èƒ½ä¼šé˜»å¡ã€‚å†…éƒ¨è°ƒç”¨offer(E e)ï¼š

```Java
public boolean offer(E e) {
        // ä¸èƒ½ä¸ºnull
        if (e == null)
            throw new NullPointerException();
        // è·å–é”
        final ReentrantLock lock = this.lock;
        lock.lock();
        int n, cap;
        Object[] array;
        // æ‰©å®¹
        while ((n = size) >= (cap = (array = queue).length))
            tryGrow(array, cap);
        try {
            Comparator<? super E> cmp = comparator;
            // æ ¹æ®æ¯”è¾ƒå™¨æ˜¯å¦ä¸ºnullï¼Œåšä¸åŒçš„å¤„ç†
            if (cmp == null)
                siftUpComparable(n, e, array);
            else
                siftUpUsingComparator(n, e, array, cmp);
            size = n + 1;
            // å”¤é†’æ­£åœ¨ç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹
            notEmpty.signal();
        } finally {
            lock.unlock();
        }
        return true;
    }
```

**siftUpComparable**
å½“æ¯”è¾ƒå™¨comparatorä¸ºnullæ—¶ï¼Œé‡‡ç”¨è‡ªç„¶æ’åºï¼Œè°ƒç”¨siftUpComparableæ–¹æ³•ï¼š

```Java
private static <T> void siftUpComparable(int k, T x, Object[] array) {
        Comparable<? super T> key = (Comparable<? super T>) x;
        // â€œä¸Šå†’â€è¿‡ç¨‹
        while (k > 0) {
            // çˆ¶çº§èŠ‚ç‚¹ ï¼ˆn - ï¼‰ / 2
            int parent = (k - 1) >>> 1;
            Object e = array[parent];

            // key >= parent å®Œæˆï¼ˆæœ€å¤§å †ï¼‰
            if (key.compareTo((T) e) >= 0)
                break;
            // key < parant æ›¿æ¢
            array[k] = e;
            k = parent;
        }
        array[k] = key;
    }
```

è¿™æ®µä»£ç æ‰€è¡¨ç¤ºçš„æ„æ€ï¼šå°†å…ƒç´ Xæ’å…¥åˆ°æ•°ç»„ä¸­ï¼Œç„¶åè¿›è¡Œè°ƒæ•´ä»¥ä¿æŒäºŒå‰å †çš„ç‰¹æ€§ã€‚

**siftUpUsingComparator**
å½“æ¯”è¾ƒå™¨ä¸ä¸ºnullæ—¶ï¼Œé‡‡ç”¨æ‰€æŒ‡å®šçš„æ¯”è¾ƒå™¨ï¼Œè°ƒç”¨siftUpUsingComparatoræ–¹æ³•ï¼š

```Java
private static <T> void siftUpUsingComparator(int k, T x, Object[] array,
                                       Comparator<? super T> cmp) {
        while (k > 0) {
            int parent = (k - 1) >>> 1;
            Object e = array[parent];
            if (cmp.compare(x, (T) e) >= 0)
                break;
            array[k] = e;
            k = parent;
        }
        array[k] = x;
    }
```

**æ‰©å®¹ï¼štryGrow**

```Java
    private void tryGrow(Object[] array, int oldCap) {
        lock.unlock();      // æ‰©å®¹æ“ä½œä½¿ç”¨è‡ªæ—‹ï¼Œä¸éœ€è¦é”ä¸»é”ï¼Œé‡Šæ”¾
        Object[] newArray = null;
        // CAS å ç”¨
        if (allocationSpinLock == 0 && UNSAFE.compareAndSwapInt(this, allocationSpinLockOffset, 0, 1)) {
            try {

                // æ–°å®¹é‡  æœ€å°ç¿»å€
                int newCap = oldCap + ((oldCap < 64) ? (oldCap + 2) :  (oldCap >> 1));

                // è¶…è¿‡
                if (newCap - MAX_ARRAY_SIZE > 0) {    // possible overflow
                    int minCap = oldCap + 1;
                    if (minCap < 0 || minCap > MAX_ARRAY_SIZE)
                        throw new OutOfMemoryError();
                    newCap = MAX_ARRAY_SIZE;        // æœ€å¤§å®¹é‡
                }
                if (newCap > oldCap && queue == array)
                    newArray = new Object[newCap];
            } finally {
                allocationSpinLock = 0;     // æ‰©å®¹åallocationSpinLock = 0 ä»£è¡¨é‡Šæ”¾äº†è‡ªæ—‹é”
            }
        }
        // åˆ°è¿™é‡Œå¦‚æœæ˜¯æœ¬çº¿ç¨‹æ‰©å®¹newArrayè‚¯å®šæ˜¯ä¸ä¸ºnullï¼Œä¸ºnullå°±æ˜¯å…¶ä»–çº¿ç¨‹åœ¨å¤„ç†æ‰©å®¹ï¼Œé‚£å°±è®©ç»™åˆ«çš„çº¿ç¨‹å¤„ç†
        if (newArray == null)
            Thread.yield();
        // ä¸»é”è·å–é”
        lock.lock();
        // æ•°ç»„å¤åˆ¶
        if (newArray != null && queue == array) {
            queue = newArray;
            System.arraycopy(array, 0, newArray, 0, oldCap);
        }
    }
```

æ•´ä¸ªæ·»åŠ å…ƒç´ çš„è¿‡ç¨‹å’Œä¸Šé¢äºŒå‰å †ä¸€æ¨¡ä¸€æ ·ï¼šå…ˆå°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„æœ«å°¾ï¼Œç„¶åé‡‡ç”¨â€œä¸Šå†’â€çš„æ–¹å¼å°†è¯¥å…ƒç´ å°½é‡å¾€ä¸Šå†’ã€‚

### å‡ºåˆ—

PriorityBlockingQueueæä¾›poll()ã€remove()æ–¹æ³•æ¥æ‰§è¡Œå‡ºå¯¹æ“ä½œã€‚å‡ºå¯¹çš„æ°¸è¿œéƒ½æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼šarray[0]ã€‚

```Java
   public E poll() {
        final ReentrantLock lock = this.lock;
        lock.lock();
        try {
            return dequeue();
        } finally {
            lock.unlock();
        }
    }
```

å…ˆè·å–é”ï¼Œç„¶åè°ƒç”¨dequeue()æ–¹æ³•ï¼š

```Java
   private E dequeue() {
        // æ²¡æœ‰å…ƒç´  è¿”å›null
        int n = size - 1;
        if (n < 0)
            return null;
        else {
            Object[] array = queue;
            // å‡ºå¯¹å…ƒç´ 
            E result = (E) array[0];
            // æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆä¹Ÿå°±æ˜¯æ’å…¥åˆ°ç©ºç©´ä¸­çš„å…ƒç´ ï¼‰
            E x = (E) array[n];
            array[n] = null;
            // æ ¹æ®æ¯”è¾ƒå™¨é‡Šæ”¾ä¸ºnullï¼Œæ¥æ‰§è¡Œä¸åŒçš„å¤„ç†
            Comparator<? super E> cmp = comparator;
            if (cmp == null)
                siftDownComparable(0, x, array, n);
            else
                siftDownUsingComparator(0, x, array, n, cmp);
            size = n;
            return result;
        }
    }
```

**siftDownComparable**

å¦‚æœæ¯”è¾ƒå™¨ä¸ºnullï¼Œåˆ™è°ƒç”¨siftDownComparableæ¥è¿›è¡Œè‡ªç„¶æ’åºå¤„ç†ï¼š

```Java
  private static <T> void siftDownComparable(int k, T x, Object[] array,
                                               int n) {
        if (n > 0) {
            Comparable<? super T> key = (Comparable<? super T>)x;
            // æœ€åä¸€ä¸ªå¶å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä½ç½®
            int half = n >>> 1;
            while (k < half) {
                int child = (k << 1) + 1;       // å¾…è°ƒæ•´ä½ç½®å·¦èŠ‚ç‚¹ä½ç½®
                Object c = array[child];        //å·¦èŠ‚ç‚¹
                int right = child + 1;          //å³èŠ‚ç‚¹

                //å·¦å³èŠ‚ç‚¹æ¯”è¾ƒï¼Œå–è¾ƒå°çš„
                if (right < n &&
                        ((Comparable<? super T>) c).compareTo((T) array[right]) > 0)
                    c = array[child = right];

                //å¦‚æœå¾…è°ƒæ•´keyæœ€å°ï¼Œé‚£å°±é€€å‡ºï¼Œç›´æ¥èµ‹å€¼
                if (key.compareTo((T) c) <= 0)
                    break;
                //å¦‚æœkeyä¸æ˜¯æœ€å°ï¼Œé‚£å°±å–å·¦å³èŠ‚ç‚¹å°çš„é‚£ä¸ªæ”¾åˆ°è°ƒæ•´ä½ç½®ï¼Œç„¶åå°çš„é‚£ä¸ªèŠ‚ç‚¹ä½ç½®å¼€å§‹å†ç»§ç»­è°ƒæ•´
                array[k] = c;
                k = child;
            }
            array[k] = key;
        }
    }
```

å¤„ç†æ€è·¯å’ŒäºŒå‰å †åˆ é™¤èŠ‚ç‚¹çš„é€»è¾‘ä¸€æ ·ï¼šå°±ç¬¬ä¸€ä¸ªå…ƒç´ å®šä¹‰ä¸ºç©ºç©´ï¼Œç„¶åæŠŠæœ€åä¸€ä¸ªå…ƒç´ å–å‡ºæ¥ï¼Œå°è¯•æ’å…¥åˆ°ç©ºç©´ä½ç½®ï¼Œå¹¶ä¸ä¸¤ä¸ªå­èŠ‚ç‚¹å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ç¬¦åˆï¼Œåˆ™ä¸å…¶ä¸­è¾ƒå°çš„å­èŠ‚ç‚¹è¿›è¡Œæ›¿æ¢ï¼Œç„¶åç»§ç»­æ¯”è¾ƒè°ƒæ•´ã€‚

**siftDownUsingComparator**

å¦‚æœæŒ‡å®šäº†æ¯”è¾ƒå™¨ï¼Œåˆ™é‡‡ç”¨æ¯”è¾ƒå™¨æ¥è¿›è¡Œè°ƒæ•´ï¼š

```Java
    private static <T> void siftDownUsingComparator(int k, T x, Object[] array,
                                                    int n,
                                                    Comparator<? super T> cmp) {
        if (n > 0) {
            int half = n >>> 1;
            while (k < half) {
                int child = (k << 1) + 1;
                Object c = array[child];
                int right = child + 1;
                if (right < n && cmp.compare((T) c, (T) array[right]) > 0)
                    c = array[child = right];
                if (cmp.compare(x, (T) c) <= 0)
                    break;
                array[k] = c;
                k = child;
            }
            array[k] = x;
        }
    }
```

PriorityBlockingQueueé‡‡ç”¨äºŒå‰å †æ¥ç»´æŠ¤ï¼Œæ‰€ä»¥æ•´ä¸ªå¤„ç†è¿‡ç¨‹ä¸æ˜¯å¾ˆå¤æ‚ï¼Œæ·»åŠ æ“ä½œåˆ™æ˜¯ä¸æ–­â€œä¸Šå†’â€ï¼Œè€Œåˆ é™¤æ“ä½œåˆ™æ˜¯ä¸æ–­â€œä¸‹æ‰â€ã€‚æŒæ¡äºŒå‰å †å°±æŒæ¡äº†PriorityBlockingQueueï¼Œæ— è®ºæ€ä¹ˆå˜è¿˜æ˜¯ä¸ç¦»å…¶å®—ã€‚å¯¹äºPriorityBlockingQueueéœ€è¦æ³¨æ„çš„æ˜¯ä»–æ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥æ·»åŠ æ“ä½œæ˜¯ä¸ä¼šå¤±è´¥çš„ï¼Œé™¤éèµ„æºè€—å°½ã€‚
[![201703270009](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827009.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120827009.png)

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)