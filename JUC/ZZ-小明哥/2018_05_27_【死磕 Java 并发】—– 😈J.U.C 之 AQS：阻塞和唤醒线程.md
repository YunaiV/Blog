title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹ AQSï¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹
date: 2018-05-27
tag: 
categories: JUC
permalink: JUC/sike/aqs-3
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2205
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247483907&idx=1&sn=2a297b6a961368696ba7fe13e6f20007&chksm=fa497db2cd3ef4a493f523441346aab29a1f95658f49eabc744fbee56f76d1239eecd162ef66#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2205 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

ä½œä¸ºã€Œå°æ˜å“¥ã€çš„å¿ å®è¯»è€…ï¼Œã€Œè€è‰¿è‰¿ã€ç•¥ä½œä¿®æ”¹ï¼Œè®°å½•åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒçš„èµ„æ–™ã€‚

- [1. parkAndCheckInterrupt](http://www.iocoder.cn/JUC/sike/aqs-3/)
- [2. unparkSuccessor](http://www.iocoder.cn/JUC/sike/aqs-3/)
- [3. LockSupport](http://www.iocoder.cn/JUC/sike/aqs-3/)
  - [3.1 park](http://www.iocoder.cn/JUC/sike/aqs-3/)
  - [3.2  unpark](http://www.iocoder.cn/JUC/sike/aqs-3/)
  - [3.3 å®ç°åŸç†](http://www.iocoder.cn/JUC/sike/aqs-3/)
- [å‚è€ƒèµ„æ–™](http://www.iocoder.cn/JUC/sike/aqs-3/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/aqs-3/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> æ­¤ç¯‡åšå®¢æ‰€æœ‰æºç å‡æ¥è‡ªJDK 1.8

# 1. parkAndCheckInterrupt

åœ¨çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™åŠ å…¥ CLH åŒæ­¥é˜Ÿåˆ—ï¼Œé€šè¿‡é€šè¿‡è‡ªæ—‹çš„æ–¹å¼ä¸æ–­è·å–åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­ï¼Œåˆ™éœ€è¦åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦é˜»å¡ï¼Œå…¶ä¸»è¦æ–¹æ³•åœ¨`acquireQueued(int arg)` ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
// ... çœç•¥å‰é¢æ— å…³ä»£ç 

if (shouldParkAfterFailedAcquire(p, node) &&
                    parkAndCheckInterrupt())
                    interrupted = true;

// ... çœç•¥å‰é¢æ— å…³ä»£ç 
```

* é€šè¿‡è¿™æ®µä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯ç«‹é©¬è¿›è¡Œé˜»å¡ï¼Œéœ€è¦æ£€æŸ¥è¯¥çº¿ç¨‹çš„çŠ¶æ€ï¼Œæ£€æŸ¥çŠ¶æ€çš„æ–¹æ³•ä¸º `#shouldParkAfterFailedAcquire(Node pred, Node node)`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦é å‰é©±èŠ‚ç‚¹åˆ¤æ–­å½“å‰çº¿ç¨‹**æ˜¯å¦åº”è¯¥è¢«é˜»å¡**ã€‚è¯¦ç»†è§£æï¼Œåœ¨ [ã€Šã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹ AQSï¼šåŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾ã€‹](http://www.iocoder.cn/JUC/sike/aqs-2) çš„ [ã€Œ1.1.2 shouldParkAfterFailedAcquireã€ ](#)  å·²ç»è§£æã€‚

* å¦‚æœ `#shouldParkAfterFailedAcquire(Node pred, Node node)` æ–¹æ³•è¿”å› **true** ï¼Œåˆ™è°ƒç”¨`parkAndCheckInterrupt()` æ–¹æ³•ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    private final boolean parkAndCheckInterrupt() {
        LockSupport.park(this);
        return Thread.interrupted();
    }
    ```
    * å¼€å§‹ï¼Œè°ƒç”¨ `LockSupport#park(Object blocker)` æ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œæ­¤æ—¶å°±è¿›å…¥**é˜»å¡ç­‰å¾…**å”¤é†’çš„çŠ¶æ€ã€‚è¯¦ç»†çš„å®ç°ï¼Œåœ¨ [ã€Œ3. LockSupportã€ ](#) ä¸­ã€‚
    * ç„¶åï¼Œåœ¨çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œè°ƒç”¨ `Thread#interrupted()` æ–¹æ³•ï¼Œè¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œå¹¶æ¸…ç†æ‰“æ–­çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šï¼Œçº¿ç¨‹è¢«**å”¤é†’**æœ‰ä¸¤ç§æƒ…å†µï¼š
        * ç¬¬ä¸€ç§ï¼Œå½“å‰èŠ‚ç‚¹(çº¿ç¨‹)çš„**å‰åºèŠ‚ç‚¹**é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œå”¤é†’äº†è¯¥çº¿ç¨‹ã€‚è¯¦ç»†è§£æï¼Œè§   [ã€Œ2 unparkSuccessorã€ ](#) ã€‚
        * ç¬¬äºŒç§ï¼Œå½“å‰çº¿ç¨‹è¢«æ‰“æ–­å¯¼è‡´å”¤é†’ã€‚

# 2. unparkSuccessor

å½“çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œåˆ™éœ€è¦å”¤é†’è¯¥çº¿ç¨‹çš„åç»§èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h); // å”¤é†’åç»§èŠ‚ç‚¹
        return true;
    }
    return false;
}
```

* è°ƒç”¨ `unparkSuccessor(Node node)` æ–¹æ³•ï¼Œå”¤é†’**åç»§**èŠ‚ç‚¹ï¼š

    ```Java
    private void unparkSuccessor(Node node) {
        //å½“å‰èŠ‚ç‚¹çŠ¶æ€
        int ws = node.waitStatus;
        //å½“å‰çŠ¶æ€ < 0 åˆ™è®¾ç½®ä¸º 0
        if (ws < 0)
            compareAndSetWaitStatus(node, ws, 0);
    
        //å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
        Node s = node.next;
        //åç»§èŠ‚ç‚¹ä¸ºnullæˆ–è€…å…¶çŠ¶æ€ > 0 (è¶…æ—¶æˆ–è€…è¢«ä¸­æ–­äº†)
        if (s == null || s.waitStatus > 0) {
            s = null;
            //ä»tailèŠ‚ç‚¹æ¥æ‰¾å¯ç”¨èŠ‚ç‚¹
            for (Node t = tail; t != null && t != node; t = t.prev)
                if (t.waitStatus <= 0)
                    s = t;
        }
        //å”¤é†’åç»§èŠ‚ç‚¹
        if (s != null)
            LockSupport.unpark(s.thread);
    }
    ```

    * å¯èƒ½ä¼šå­˜åœ¨å½“å‰çº¿ç¨‹çš„**åç»§**èŠ‚ç‚¹ä¸º `null`ï¼Œä¾‹å¦‚ï¼šè¶…æ—¶ã€è¢«ä¸­æ–­çš„æƒ…å†µã€‚å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µäº†ï¼Œåˆ™éœ€è¦è·³è¿‡è¯¥èŠ‚ç‚¹ã€‚
        * ä½†æ˜¯ï¼Œä¸ºä½•æ˜¯ä» `tail` å°¾èŠ‚ç‚¹å¼€å§‹ï¼Œè€Œä¸æ˜¯ä» `node.next` å¼€å§‹å‘¢ï¼ŸåŸå› åœ¨äºï¼Œå–æ¶ˆçš„ `node.next.next` æŒ‡å‘çš„æ˜¯ `node.next` è‡ªå·±ã€‚å¦‚æœé¡ºåºéå†ä¸‹å»ï¼Œä¼šå¯¼è‡´**æ­»å¾ªç¯**ã€‚æ‰€ä»¥æ­¤æ—¶ï¼Œ**åªèƒ½**é‡‡ç”¨ `tail` å›æº¯çš„åŠæ³•ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª( ä¸æ˜¯**æœ€æ–°**æ‰¾åˆ°çš„ï¼Œè€Œæ˜¯**æœ€å‰åºçš„** )å¯ç”¨çš„çº¿ç¨‹ã€‚
        * å†ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆå–æ¶ˆçš„ `node.next.next` æŒ‡å‘çš„æ˜¯ `node.next` è‡ªå·±å‘¢ï¼Ÿåœ¨ `#cancelAcquire(Node node)` çš„æœ«å°¾ï¼Œ`node.next = node;` ä»£ç å—ï¼Œå–æ¶ˆçš„ `node` èŠ‚ç‚¹ï¼Œå°†å…¶ `next` æŒ‡å‘äº†è‡ªå·±ã€‚
 
    * æœ€åï¼Œè°ƒç”¨ `LockSupportçš„unpark(Thread thread)` æ–¹æ³•ï¼Œå”¤é†’è¯¥çº¿ç¨‹ã€‚è¯¦ç»†çš„å®ç°ï¼Œåœ¨ [ã€Œ3. LockSupportã€ ](#) ä¸­ã€‚

# 3. LockSupport

ä»ä¸Šé¢æˆ‘å¯ä»¥çœ‹åˆ°ï¼Œå½“éœ€è¦é˜»å¡æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼ŒAQS éƒ½æ˜¯ä½¿ç”¨ LockSupport è¿™ä¸ªå·¥å…·ç±»æ¥å®Œæˆçš„ã€‚

> LockSupport æ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚

æ¯ä¸ªä½¿ç”¨ LockSupport çš„çº¿ç¨‹éƒ½ä¼šä¸ä¸€ä¸ªè®¸å¯ä¸ä¹‹å…³è”ï¼š

* å¦‚æœè¯¥è®¸å¯å¯ç”¨ï¼Œå¹¶ä¸”å¯åœ¨è¿›ç¨‹ä¸­ä½¿ç”¨ï¼Œåˆ™è°ƒç”¨ `#park(...)` å°†ä¼šç«‹å³è¿”å›ï¼Œå¦åˆ™å¯èƒ½é˜»å¡ã€‚
* å¦‚æœè®¸å¯å°šä¸å¯ç”¨ï¼Œåˆ™å¯ä»¥è°ƒç”¨ `#unpark(...)` ä½¿å…¶å¯ç”¨ã€‚
* ä½†æ˜¯ï¼Œæ³¨æ„è®¸å¯**ä¸å¯é‡å…¥**ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½è°ƒç”¨ä¸€æ¬¡ `park(...)` æ–¹æ³•ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ã€‚

LockSupport å®šä¹‰äº†ä¸€ç³»åˆ—ä»¥ `park` å¼€å¤´çš„æ–¹æ³•æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œ`unpark(Thread thread)` æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æ–¹æ³•](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120812001.png)

* `park(Object blocker)` æ–¹æ³•çš„blockerå‚æ•°ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ ‡è¯†å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸»è¦ç”¨äº**é—®é¢˜æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§**ã€‚
* park æ–¹æ³•å’Œ `unpark(Thread thread)` æ–¹æ³•ï¼Œéƒ½æ˜¯**æˆå¯¹å‡ºç°**çš„ã€‚åŒæ—¶  `unpark(Thread thread)` æ–¹æ³•ï¼Œå¿…é¡»è¦åœ¨ park æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œã€‚å½“ç„¶ï¼Œå¹¶ä¸æ˜¯è¯´æ²¡æœ‰è°ƒç”¨ `unpark(Thread thread)` æ–¹æ³•çš„çº¿ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ï¼Œpark æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒæ˜¯å¸¦äº†æ—¶é—´æˆ³çš„ `#parkNanos(long nanos)` æ–¹æ³•ï¼šä¸ºäº†çº¿ç¨‹è°ƒåº¦ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œæœ€å¤šç­‰å¾…æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ï¼Œé™¤éè®¸å¯å¯ç”¨ã€‚

## 3.1 park

```Java
public static void park() {
    UNSAFE.park(false, 0L);
}
```

## 3.2  unpark

```Java
public static void unpark(Thread thread) {
    if (thread != null)
        UNSAFE.unpark(thread);
}
```

## 3.3 å®ç°åŸç†

ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå…¶å†…éƒ¨çš„å®ç°éƒ½æ˜¯é€šè¿‡ `sun.misc.Unsafe` æ¥å®ç°çš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```Java
// UNSAFE.java
public native void park(boolean var1, long var2);
public native void unpark(Object var1);
```

ä¸¤ä¸ªéƒ½æ˜¯ `native` æœ¬åœ°æ–¹æ³•ã€‚Unsafe æ˜¯ä¸€ä¸ªæ¯”è¾ƒå±é™©çš„ç±»ï¼Œä¸»è¦æ˜¯ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨çš„æ–¹æ³•é›†åˆã€‚å°½ç®¡è¿™ä¸ªç±»å’Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯å…¬å¼€çš„ï¼ˆä½¿ç”¨ `public` è¿›è¡Œä¿®é¥°ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªç±»çš„ä½¿ç”¨ä»ç„¶å—é™ï¼Œä½ æ— æ³•åœ¨è‡ªå·±çš„ Java ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨è¯¥ç±»ï¼Œå› ä¸ºåªæœ‰æˆä¿¡çš„ä»£ç æ‰èƒ½è·å¾—è¯¥ç±»çš„å®ä¾‹ã€‚

> è€è‰¿è‰¿ï¼šå› ä¸ºæœ¬å°èŠ‚å¯¹ LockSupport çš„åˆ†äº«ç•¥å¾®æœ‰ç‚¹ç®€ç•¥ï¼Œæ‰€ä»¥èƒ–å‹éœ€è¦è‡ªå·±çœ‹ä¸‹ `java.util.concurrent.locks.LockSupport` ï¼Œä¾‹å¦‚ `#park(Object blocker)` æ–¹æ³•çš„å®ç°ã€‚å½“ç„¶ï¼Œè¿™ä¸ªç±»æ€»ä½“æ¥è¯´å¾ˆç®€å•ï¼Œæ‰€ä»¥å³ä½¿æ²¡æœ‰è¯¦ç»†çš„æºç è§£æï¼Œèƒ–å‹ä¹Ÿèƒ½å¾ˆå®¹æ˜“çš„ç†è§£ã€‚

# å‚è€ƒèµ„æ–™

1. æ–¹è…¾é£ï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ [ã€Œ5.2 é˜Ÿåˆ—åŒæ­¥å™¨ã€](#) å’Œ [ã€Œ5.5 LockSupportã€](#) ç« èŠ‚ã€‚
2. [ã€ŠLockSupport çš„ park å’Œ unpark çš„åŸºæœ¬ä½¿ç”¨ï¼Œä»¥åŠå¯¹çº¿ç¨‹ä¸­æ–­çš„å“åº”æ€§ã€‹](https://blog.csdn.net/aitangyong/article/details/38373137?utm_source=tuicool&utm_medium=referral)

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

