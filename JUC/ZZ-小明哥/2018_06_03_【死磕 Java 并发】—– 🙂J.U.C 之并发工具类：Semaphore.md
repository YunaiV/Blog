title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹å¹¶å‘å·¥å…·ç±»ï¼šSemaphore
date: 2018-06-03
tag: 
categories: JUC
permalink: JUC/sike/Semaphore
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2263
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484323&idx=1&sn=cb2b572227a9004840abdfd26e7dd336&chksm=fa497c12cd3ef50447bf162d63d977747dd4478a75ccda46522c6903d386b5c69581670b495a#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2263 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

ä½œä¸ºã€Œå°æ˜å“¥ã€çš„å¿ å®è¯»è€…ï¼Œã€Œè€è‰¿è‰¿ã€ç•¥ä½œä¿®æ”¹ï¼Œè®°å½•åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒçš„èµ„æ–™ã€‚

- [1. ç®€ä»‹](http://www.iocoder.cn/JUC/sike/Semaphore/)
- [2. å®ç°åˆ†æ](http://www.iocoder.cn/JUC/sike/Semaphore/)
  - [2.1 ä¿¡å·é‡è·å–](http://www.iocoder.cn/JUC/sike/Semaphore/)
  - [2.2 ä¿¡å·é‡é‡Šæ”¾](http://www.iocoder.cn/JUC/sike/Semaphore/)
  - [2.3 å…¶ä»–æ–¹æ³•](http://www.iocoder.cn/JUC/sike/Semaphore/)
- [3. åº”ç”¨ç¤ºä¾‹](http://www.iocoder.cn/JUC/sike/Semaphore/)
- [å‚è€ƒèµ„æ–™](http://www.iocoder.cn/JUC/sike/Semaphore/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/Semaphore/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> æ­¤ç¯‡åšå®¢æ‰€æœ‰æºç å‡æ¥è‡ªJDK 1.8

# 1. ç®€ä»‹

ä¿¡å·é‡ Semaphore æ˜¯ä¸€ä¸ªæ§åˆ¶è®¿é—®å¤šä¸ªå…±äº«èµ„æºçš„è®¡æ•°å™¨ï¼Œå’Œ CountDownLatch ä¸€æ ·ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªâ€œ**å…±äº«é”**â€ã€‚

Semaphoreï¼Œåœ¨ API æ˜¯è¿™ä¹ˆä»‹ç»çš„ï¼š

> ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œä¿¡å·é‡ç»´æŠ¤äº†ä¸€ä¸ªè®¸å¯é›†ã€‚
> 
> * å¦‚æœ‰å¿…è¦ï¼Œåœ¨è®¸å¯å¯ç”¨å‰ä¼šé˜»å¡æ¯ä¸€ä¸ª acquireï¼Œç„¶åå†è·å–è¯¥è®¸å¯ã€‚
> * æ¯ä¸ª release æ·»åŠ ä¸€ä¸ªè®¸å¯ï¼Œä»è€Œå¯èƒ½é‡Šæ”¾ä¸€ä¸ªæ­£åœ¨é˜»å¡çš„è·å–è€…ã€‚
> 
> ä½†æ˜¯ï¼Œä¸ä½¿ç”¨å®é™…çš„è®¸å¯å¯¹è±¡ï¼ŒSemaphore åªå¯¹å¯ç”¨è®¸å¯çš„å·ç è¿›è¡Œè®¡æ•°ï¼Œå¹¶é‡‡å–ç›¸åº”çš„è¡ŒåŠ¨ã€‚

Semaphore é€šå¸¸ç”¨äºé™åˆ¶å¯ä»¥è®¿é—®æŸäº›èµ„æºï¼ˆç‰©ç†æˆ–é€»è¾‘çš„ï¼‰çš„çº¿ç¨‹æ•°ç›®ã€‚

ä¸‹é¢æˆ‘ä»¬å°±ä¸€ä¸ªåœè½¦åœºçš„ç®€å•ä¾‹å­æ¥é˜è¿° Semaphore ï¼š

* ä¸ºäº†ç®€å•èµ·è§æˆ‘ä»¬å‡è®¾åœè½¦åœºä»…æœ‰ 5 ä¸ªåœè½¦ä½ã€‚ä¸€å¼€å§‹åœè½¦åœºæ²¡æœ‰è½¦è¾†æ‰€æœ‰è½¦ä½å…¨éƒ¨ç©ºç€ï¼Œç„¶åå…ˆååˆ°æ¥ä¸‰è¾†è½¦ï¼Œåœè½¦åœºè½¦ä½å¤Ÿï¼Œå®‰æ’è¿›å»åœè½¦ï¼Œç„¶ååˆæ¥ä¸‰è¾†ï¼Œè¿™ä¸ªæ—¶å€™ç”±äºåªæœ‰ä¸¤ä¸ªåœè½¦ä½ï¼Œæ‰€æœ‰åªèƒ½åœä¸¤è¾†ï¼Œå…¶ä½™ä¸€è¾†å¿…é¡»åœ¨å¤–é¢å€™ç€ï¼Œç›´åˆ°åœè½¦åœºæœ‰ç©ºè½¦ä½ã€‚å½“ç„¶ï¼Œä»¥åæ¯æ¥ä¸€è¾†éƒ½éœ€è¦åœ¨å¤–é¢å€™ç€ã€‚å½“åœè½¦åœºæœ‰è½¦å¼€å‡ºå»ï¼Œé‡Œé¢æœ‰ç©ºä½äº†ï¼Œåˆ™å®‰æ’ä¸€è¾†è½¦è¿›å»ï¼ˆè‡³äºæ˜¯å“ªè¾†ï¼Œè¦çœ‹é€‰æ‹©çš„æœºåˆ¶æ˜¯å…¬å¹³è¿˜æ˜¯éå…¬å¹³ï¼‰ã€‚
* ä»ç¨‹åºè§’åº¦çœ‹ï¼Œåœè½¦åœºå°±ç›¸å½“äºä¿¡å·é‡ Semaphore ï¼Œå…¶ä¸­è®¸å¯æ•°ä¸º 5 ï¼Œè½¦è¾†å°±ç›¸å¯¹çº¿ç¨‹ã€‚å½“æ¥ä¸€è¾†è½¦æ—¶ï¼Œè®¸å¯æ•°å°±ä¼šå‡ 1 ã€‚å½“åœè½¦åœºæ²¡æœ‰è½¦ä½äº†ï¼ˆè®¸å¯æ•° == 0 ï¼‰ï¼Œå…¶ä»–æ¥çš„è½¦è¾†éœ€è¦åœ¨å¤–é¢ç­‰å€™ç€ã€‚å¦‚æœæœ‰ä¸€è¾†è½¦å¼€å‡ºåœè½¦åœºï¼Œè®¸å¯æ•° + 1ï¼Œç„¶åæ”¾è¿›æ¥ä¸€è¾†è½¦ã€‚
* ä¿¡å·é‡ Semaphore æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼ˆ `>=1` ï¼‰ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è®¿é—®æŸä¸ªå…±äº«èµ„æºæ—¶ï¼Œå®ƒå¿…é¡»è¦å…ˆè·å– Semaphoreã€‚å½“ Semaphore > 0 æ—¶ï¼Œè·å–è¯¥èµ„æºå¹¶ä½¿ Semaphore â€“ 1 ã€‚å¦‚æœS emaphore å€¼ = 0ï¼Œåˆ™è¡¨ç¤ºå…¨éƒ¨çš„å…±äº«èµ„æºå·²ç»è¢«å…¶ä»–çº¿ç¨‹å…¨éƒ¨å ç”¨ï¼Œçº¿ç¨‹å¿…é¡»è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾èµ„æºã€‚å½“çº¿ç¨‹é‡Šæ”¾èµ„æºæ—¶ï¼ŒSemaphore åˆ™ +1 ã€‚

# 2. å®ç°åˆ†æ

`java.util.concurrent.Semaphore` ç»“æ„å¦‚ä¸‹å›¾ï¼š

![Semaphore ç»“æ„](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120819001.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒSemaphore å†…éƒ¨åŒ…å«å…¬å¹³é”ï¼ˆFairSyncï¼‰å’Œéå…¬å¹³é”ï¼ˆNonfairSyncï¼‰ï¼Œç»§æ‰¿å†…éƒ¨ç±» Sync ï¼Œå…¶ä¸­ Sync ç»§æ‰¿ AQSï¼ˆå†ä¸€æ¬¡é˜è¿° AQS çš„é‡è¦æ€§ï¼‰ã€‚

Semaphore æä¾›äº†ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š

1. `Semaphore(int permits)` ï¼šåˆ›å»ºå…·æœ‰ç»™å®šçš„è®¸å¯æ•°å’Œ**éå…¬å¹³**çš„å…¬å¹³è®¾ç½®çš„ Semaphore ã€‚
2. `Semaphore(int permits, boolean fair)` ï¼šåˆ›å»ºå…·æœ‰ç»™å®šçš„è®¸å¯æ•°å’Œç»™å®šçš„å…¬å¹³è®¾ç½®çš„  Semaphore ã€‚

å®ç°å¦‚ä¸‹ï¼š

```Java
public Semaphore(int permits) {
    sync = new NonfairSync(permits);
}

public Semaphore(int permits, boolean fair) {
    sync = fair ? new FairSync(permits) : new NonfairSync(permits);
}
```

* Semaphore é»˜è®¤é€‰æ‹©**éå…¬å¹³é”**ã€‚
* å½“ä¿¡å·é‡ Semaphore = 1 æ—¶ï¼Œå®ƒå¯ä»¥å½“ä½œäº’æ–¥é”ä½¿ç”¨ã€‚å…¶ä¸­ 0ã€1 å°±ç›¸å½“äºå®ƒçš„çŠ¶æ€ï¼š1ï¼‰å½“ `=1` æ—¶è¡¨ç¤ºï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è·å–ï¼›2ï¼‰å½“ `=0` æ—¶ï¼Œæ’ä»–ï¼Œå³å…¶ä»–çº¿ç¨‹å¿…é¡»è¦ç­‰å¾…ã€‚
* ğŸ™‚ Semaphore çš„ä»£ç å®ç°ç»“æ„ï¼Œå’Œ ReentrantLock ç±»ä¼¼ã€‚

## 2.1 ä¿¡å·é‡è·å–

Semaphore æä¾›äº† `#acquire()` æ–¹æ³•ï¼Œæ¥è·å–ä¸€ä¸ªè®¸å¯ã€‚

```Java
public void acquire() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}
```

* å†…éƒ¨è°ƒç”¨ AQS çš„ `#acquireSharedInterruptibly(int arg)` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä»¥**å…±äº«æ¨¡å¼**è·å–åŒæ­¥çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    public final void acquireSharedInterruptibly(int arg)
            throws InterruptedException {
        if (Thread.interrupted())
            throw new InterruptedException();
        if (tryAcquireShared(arg) < 0)
            doAcquireSharedInterruptibly(arg);
    }
    ```

    * åœ¨ `#acquireSharedInterruptibly(int arg)` æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ `#tryAcquireShared(int arg)` æ–¹æ³•ã€‚è€Œ `#tryAcquireShared(int arg)` æ–¹æ³•ï¼Œç”±å­ç±»æ¥å®ç°ã€‚å¯¹äº Semaphore è€Œè¨€ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©éå…¬å¹³æ¨¡å¼ï¼Œåˆ™è°ƒç”¨ NonfairSync çš„`#tryAcquireShared(int arg)` æ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨ FairSync çš„ `#tryAcquireShared(int arg)` æ–¹æ³•ã€‚è‹¥ `#tryAcquireShared(int arg)` æ–¹æ³•è¿”å› `< 0` æ—¶ï¼Œåˆ™ä¼š**é˜»å¡**ç­‰å¾…ï¼Œä»è€Œå®ç° Semaphore ä¿¡å·é‡ä¸è¶³æ—¶çš„é˜»å¡ï¼Œä»£ç å¦‚ä¸‹ï¼š

        ```Java
        // AQS.java
        private void doAcquireSharedInterruptibly(int arg)
                throws InterruptedException {
            final Node node = addWaiter(Node.SHARED);
            boolean failed = true;
            try {
                for (;;) {
                    final Node p = node.predecessor();
                    if (p == head) {
                        int r = tryAcquireShared(arg);
                        if (r >= 0) {
                            setHeadAndPropagate(node, r);
                            p.next = null; // help GC
                            failed = false;
                            return;
                        }
                    }
                    /**
                     * å¯¹äº Semaphore è€Œè¨€ï¼Œå¦‚æœ tryAcquireShared è¿”å›å°äº 0 æ—¶ï¼Œåˆ™ä¼šé˜»å¡ç­‰å¾…ã€‚
                     */
                    if (shouldParkAfterFailedAcquire(p, node) &&
                            parkAndCheckInterrupt())
                        throw new InterruptedException();
                }
            } finally {
                if (failed)
                    cancelAcquire(node);
            }
        }
        ```
        * è€è‰¿è‰¿ï¼šå¦å¤–ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Semaphore åœ¨ä½¿ç”¨ AQS æ—¶ï¼Œ`state` ä»£è¡¨çš„æ˜¯ï¼Œå‰©ä½™å¯è·å–çš„è®¸å¯æ•°ï¼Œè€Œä¸æ˜¯å·²ç»ä½¿ç”¨çš„è®¸å¯æ•°ã€‚æˆ‘ä»¬å‡è®¾ `state` ä»£è¡¨çš„æ˜¯å·²ç»ä½¿ç”¨çš„è®¸å¯æ•°ï¼Œé‚£ä¹ˆ `#tryAcquireShared(int arg)` è¿”å›çš„ç»“æœ `= åŸå§‹è®¸å¯æ•° - state` ï¼Œè¿™ä¸ªæ“ä½œåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œä¼šå­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ã€‚æ‰€ä»¥ï¼Œ**`state` ä»£è¡¨çš„æ˜¯ï¼Œå‰©ä½™å¯è·å–çš„è®¸å¯æ•°ï¼Œè€Œä¸æ˜¯å·²ç»ä½¿ç”¨çš„è®¸å¯æ•°**ã€‚
    
    * **å…¬å¹³**æƒ…å†µçš„ FairSync çš„æ–¹æ³•å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

        ```Java
        // FairSync.java
        @Override
        protected int tryAcquireShared(int acquires) {
            for (;;) {
                //åˆ¤æ–­è¯¥çº¿ç¨‹æ˜¯å¦ä½äºCLHé˜Ÿåˆ—çš„åˆ—å¤´ï¼Œä»è€Œå®ç°å…¬å¹³é”
                if (hasQueuedPredecessors())
                    return -1;
                //è·å–å½“å‰çš„ä¿¡å·é‡è®¸å¯
                int available = getState();
        
                //è®¾ç½®â€œè·å¾—acquiresä¸ªä¿¡å·é‡è®¸å¯ä¹‹åï¼Œå‰©ä½™çš„ä¿¡å·é‡è®¸å¯æ•°â€
                int remaining = available - acquires;
        
                //CASè®¾ç½®ä¿¡å·é‡
                if (remaining < 0 ||
                        compareAndSetState(available, remaining))
                    return remaining;
            }
        }
        ```
        * é€šè¿‡ `#hasQueuedPredecessors()` æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥çº¿ç¨‹æ˜¯å¦ä½äº CLH é˜Ÿåˆ—çš„**åˆ—å¤´**ï¼Œä»è€Œå®ç°å…¬å¹³é”ã€‚

    * **éå…¬å¹³**æƒ…å†µçš„ NonfairSync çš„æ–¹æ³•å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

        ```Java
        // NonfairSync.java
        protected int tryAcquireShared(int acquires) {
            return nonfairTryAcquireShared(acquires);
        }
        
        // Sync.java
        final int nonfairTryAcquireShared(int acquires) {
            for (;;) {
                int available = getState();
                int remaining = available - acquires;
                if (remaining < 0 ||
                    compareAndSetState(available, remaining))
                    return remaining;
            }
        }
        ```
        * å¯¹äºéå…¬å¹³è€Œè¨€ï¼Œå› ä¸ºå®ƒ**ä¸éœ€è¦**åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä½äº CLH åŒæ­¥é˜Ÿåˆ—åˆ—å¤´ï¼Œæ‰€ä»¥ç›¸å¯¹è€Œè¨€ä¼šç®€å•äº›ã€‚

## 2.2 ä¿¡å·é‡é‡Šæ”¾

è·å–äº†è®¸å¯ï¼Œå½“ç”¨å®Œä¹‹åå°±éœ€è¦é‡Šæ”¾ï¼ŒSemaphore æä¾› `#release()` æ–¹æ³•ï¼Œæ¥é‡Šæ”¾è®¸å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public void release() {
    sync.releaseShared(1);
}
```

* å†…éƒ¨è°ƒç”¨ AQS çš„ `#releaseShared(int arg)` æ–¹æ³•ï¼Œé‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚

    ```Java
    // AQS.java
    public final boolean releaseShared(int arg) {
        if (tryReleaseShared(arg)) {
            doReleaseShared();
            return true;
        }
        return false;
    }
    ```

    * `releaseShared(int arg)` æ–¹æ³•ï¼Œä¼šè°ƒç”¨ Semaphore å†…éƒ¨ç±» Sync çš„ `#tryReleaseShared(int arg)` æ–¹æ³•ï¼Œé‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚

        ```Java
        // Sync.java
        protected final boolean tryReleaseShared(int releases) {
            for (;;) {
                int current = getState();
                //ä¿¡å·é‡çš„è®¸å¯æ•° = å½“å‰ä¿¡å·è®¸å¯æ•° + å¾…é‡Šæ”¾çš„ä¿¡å·è®¸å¯æ•°
                int next = current + releases;
                if (next < current) // overflow
                    throw new Error("Maximum permit count exceeded");
                //è®¾ç½®å¯è·å–çš„ä¿¡å·è®¸å¯æ•°ä¸ºnext
                if (compareAndSetState(current, next))
                    return true;
            }
        }
        ```
        * å¦‚è¯¥æ–¹æ³•è¿”å› **true** æ—¶ï¼Œä»£è¡¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œä»è€Œåœ¨ `#releaseShared(int args)` æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `#doReleaseShared()` æ–¹æ³•ï¼Œ**å¯å”¤é†’é˜»å¡ç­‰å¾… Semaphore çš„è®¸å¯çš„çº¿ç¨‹**ã€‚ 
        * å¯¹äºä¿¡å·é‡çš„è·å–é‡Šæ”¾è¯¦ç»†è¿‡ç¨‹ï¼Œè¯·å‚è€ƒå¦‚ä¸‹åšå®¢ï¼š
            * [ã€Šã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹ AQSï¼šåŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾ã€‹](http://www.iocoder.cn/JUC/sike/aqs-2)
            * [ã€Šã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹ AQSï¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹ã€‹](http://www.iocoder.cn/JUC/sike/aqs-3)

## 2.3 å…¶ä»–æ–¹æ³•

æœ¬æ–‡æœ‰éƒ¨åˆ†æ–¹æ³•å¹¶æœªè§£æï¼Œå› ä¸ºæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±ç ”ç©¶ã€‚

Semaphore ï¼š

* `#acquireUninterruptibly()`
* `#tryAcquire()`
* `#tryAcquire(long timeout, TimeUnit unit)`
* `#acquire(int permits)`
* `#acquireUninterruptibly(int permits)`
* `#tryAcquire(int permits)`
* `#tryAcquire(int permits, long timeout, TimeUnit unit)`
* `#availablePermits()`
* `#drainPermits()`
* `#reducePermits(int reduction)`
* `#isFair()`
* `#hasQueuedThreads()`
* `#getQueueLength()`
* `#getQueuedThreads()`

Sync ï¼š

* `#reducePermits(int reductions)`
* `#drainPermits()`

# 3. åº”ç”¨ç¤ºä¾‹

æˆ‘ä»¬å·²åœè½¦ä¸ºç¤ºä¾‹ï¼š

```Java
public class SemaphoreTest {

    static class Parking {
    
        //ä¿¡å·é‡
        private Semaphore semaphore;

        Parking(int count) {
            semaphore = new Semaphore(count);
        }

        public void park() {
            try {
                //è·å–ä¿¡å·é‡
                semaphore.acquire();
                long time = (long) (Math.random() * 10);
                System.out.println(Thread.currentThread().getName() + "è¿›å…¥åœè½¦åœºï¼Œåœè½¦" + time + "ç§’..." );
                Thread.sleep(time);
                System.out.println(Thread.currentThread().getName() + "å¼€å‡ºåœè½¦åœº...");
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                semaphore.release();
            }
        }
    }


    static class Car extends Thread {
        Parking parking ;

        Car(Parking parking){
            this.parking = parking;
        }

        @Override
        public void run() {
            parking.park();     //è¿›å…¥åœè½¦åœº
        }
    }

    public static void main(String[] args){
        Parking parking = new Parking(3);

        for(int i = 0 ; i < 5 ; i++){
            new Car(parking).start();
        }
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

[![201702170002](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120819002.png)](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120819002.png)

# å‚è€ƒèµ„æ–™

1. æ–¹è…¾é£ï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ [ã€Œ8.3 æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°çš„ Semaphoreã€](#) ç« èŠ‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

