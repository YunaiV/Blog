title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”- æ·±å…¥åˆ†æ CAS
date: 2018-05-31
tag: 
categories: JUC
permalink: JUC/sike/CAS
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2235
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484156&idx=1&sn=88f659cd13ab4064d760b4b5c60cbc63&chksm=fa497d4dcd3ef45b520d06ea75c219d67f7ba35129ca800d374cfa6f2d39ab1d2d9bf3379b30#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2235 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

ä½œä¸ºã€Œå°æ˜å“¥ã€çš„å¿ å®è¯»è€…ï¼Œã€Œè€è‰¿è‰¿ã€ç•¥ä½œä¿®æ”¹ï¼Œè®°å½•åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒçš„èµ„æ–™ã€‚

- [1. æ¦‚è¿°](http://www.iocoder.cn/JUC/sike/CAS/)
- [2. CASåˆ†æ](http://www.iocoder.cn/JUC/sike/CAS/)
  - [2.1 AtomicInteger](http://www.iocoder.cn/JUC/sike/CAS/)
  - [2.2 CPU åŸå­æ“ä½œ](http://www.iocoder.cn/JUC/sike/CAS/)
- [3. CASç¼ºé™·](http://www.iocoder.cn/JUC/sike/CAS/)
  - [3.1 å¾ªç¯æ—¶é—´å¤ªé•¿](http://www.iocoder.cn/JUC/sike/CAS/)
  - [3.2 åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡åŸå­æ“ä½œ](http://www.iocoder.cn/JUC/sike/CAS/)
  - [3.3 ABAé—®é¢˜](http://www.iocoder.cn/JUC/sike/CAS/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/CAS/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# 1. æ¦‚è¿°

CAS ï¼ŒCompare And Swap ï¼Œå³æ¯”è¾ƒå¹¶äº¤æ¢ã€‚Doug Lea å¤§ç¥åœ¨å®ç°åŒæ­¥ç»„ä»¶æ—¶ï¼Œå¤§é‡ä½¿ç”¨CAS æŠ€æœ¯ï¼Œé¬¼æ–§ç¥å·¥åœ°å®ç°äº†Java å¤šçº¿ç¨‹çš„å¹¶å‘æ“ä½œã€‚æ•´ä¸ª AQS åŒæ­¥ç»„ä»¶ã€Atomic åŸå­ç±»æ“ä½œç­‰ç­‰éƒ½æ˜¯åŸº CAS å®ç°çš„ï¼Œç”šè‡³ ConcurrentHashMap åœ¨ JDK 1.8 çš„ç‰ˆæœ¬ä¸­ï¼Œä¹Ÿè°ƒæ•´ä¸º CAS + `synchronized` ã€‚å¯ä»¥è¯´ï¼ŒCAS æ˜¯æ•´ä¸ª J.U.C çš„åŸºçŸ³ã€‚

![201703090001](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120816001.png)

# 2. CASåˆ†æ

åœ¨ CAS ä¸­æœ‰ä¸‰ä¸ªå‚æ•°ï¼šå†…å­˜å€¼ Vã€æ—§çš„é¢„æœŸå€¼ Aã€è¦æ›´æ–°çš„å€¼ B ï¼Œå½“ä¸”ä»…å½“å†…å­˜å€¼ V çš„å€¼ç­‰äºæ—§çš„é¢„æœŸå€¼ A æ—¶ï¼Œæ‰ä¼šå°†å†…å­˜å€¼Vçš„å€¼ä¿®æ”¹ä¸º B ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸å¹²ã€‚å…¶**ä¼ªä»£ç **å¦‚ä¸‹ï¼š

```Java
if (this.value == A) {
	this.value = B
	return true;
} else {
	return false;
}
```

J.U.C ä¸‹çš„ Atomic ç±»ï¼Œéƒ½æ˜¯é€šè¿‡ CAS æ¥å®ç°çš„ã€‚ä¸‹é¢å°±ä»¥ AtomicInteger ä¸ºä¾‹ï¼Œæ¥é˜è¿° CAS çš„å®ç°ã€‚å¦‚ä¸‹ï¼š

```Java
private static final Unsafe unsafe = Unsafe.getUnsafe();
private static final long valueOffset;

static {
    try {
        valueOffset = unsafe.objectFieldOffset
            (AtomicInteger.class.getDeclaredField("value"));
    } catch (Exception ex) { throw new Error(ex); }
}

private volatile int value;
```

* Unsafe æ˜¯ CAS çš„æ ¸å¿ƒç±»ï¼ŒJava æ— æ³•ç›´æ¥è®¿é—®åº•å±‚æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯é€šè¿‡æœ¬åœ° `native` æ–¹æ³•æ¥è®¿é—®ã€‚ä¸è¿‡å°½ç®¡å¦‚æ­¤ï¼ŒJVMè¿˜æ˜¯å¼€äº†ä¸€ä¸ªåé—¨ï¼šUnsafe ï¼Œ**å®ƒæä¾›äº†ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œ**ã€‚
* `valueOffset` ä¸ºå˜é‡å€¼åœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼ŒUnsafe å°±æ˜¯é€šè¿‡**åç§»åœ°å€**æ¥å¾—åˆ°æ•°æ®çš„åŸå€¼çš„ã€‚
* `value` å½“å‰å€¼ï¼Œä½¿ç”¨ `volatile` ä¿®é¥°ï¼Œä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çœ‹è§çš„æ˜¯åŒä¸€ä¸ªã€‚

## 2.1 AtomicInteger

æˆ‘ä»¬å°±ä»¥ AtomicInteger çš„ `#addAndGet()` æ–¹æ³•æ¥åšè¯´æ˜ï¼Œå…ˆçœ‹æºä»£ç ï¼š

```Java
// AtomicInteger.java
public final int addAndGet(int delta) {
    return unsafe.getAndAddInt(this, valueOffset, delta) + delta;
}

// Unsafe.java
public final int getAndAddInt(Object var1, long var2, int var4) {
    int var5;
    do {
        var5 = this.getIntVolatile(var1, var2);
    } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));

    return var5;
}
```

* å†…éƒ¨è°ƒç”¨ `unsafe` çš„ `#getAndAddInt(Object var1, long var2, int var4)`æ–¹æ³•ï¼Œåœ¨`#getAndAddInt(Object var1, long var2, int var4)` æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯çœ‹ `#compareAndSwapInt(Object var1, long var2, int var4, int var5)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```Java
    public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);
    ```

    * è¯¥æ–¹æ³•ä¸ºæœ¬åœ°æ–¹æ³•ï¼Œæœ‰å››ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä»£è¡¨ï¼šå¯¹è±¡ã€å¯¹è±¡çš„åœ°å€ã€é¢„æœŸå€¼ã€ä¿®æ”¹å€¼ï¼ˆæœ‰ä½ä¼™ä¼´å‘Šè¯‰æˆ‘ä»–é¢è¯•çš„æ—¶å€™å°±é—®åˆ°è¿™å››ä¸ªå˜é‡æ˜¯å•¥æ„æ€â€¦+_+ï¼‰ã€‚è¯¥æ–¹æ³•çš„å®ç°è¿™é‡Œå°±ä¸åšè¯¦ç»†ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„ä¼™ä¼´å¯ä»¥çœ‹çœ‹ OpenJDK çš„æºç ã€‚

## 2.2 CPU åŸå­æ“ä½œ

CAS å¯ä»¥ä¿è¯ä¸€æ¬¡çš„**è¯»-æ”¹-å†™**æ“ä½œæ˜¯åŸå­æ“ä½œï¼Œåœ¨å•å¤„ç†å™¨ä¸Šè¯¥æ“ä½œå®¹æ˜“å®ç°ï¼Œä½†æ˜¯åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°å°±æœ‰ç‚¹å„¿å¤æ‚äº†ã€‚CPU æä¾›äº†**ä¸¤ç§æ–¹æ³•**æ¥å®ç°å¤šå¤„ç†å™¨çš„åŸå­æ“ä½œï¼šæ€»çº¿åŠ é”æˆ–è€…ç¼“å­˜åŠ é”ã€‚

* **æ€»çº¿åŠ é”**ï¼šæ€»çº¿åŠ é”å°±æ˜¯å°±æ˜¯ä½¿ç”¨å¤„ç†å™¨æä¾›çš„ä¸€ä¸ª LOCK# ä¿¡å·ï¼Œå½“ä¸€ä¸ªå¤„ç†å™¨åœ¨æ€»çº¿ä¸Šè¾“å‡ºæ­¤ä¿¡å·æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨çš„è¯·æ±‚å°†è¢«é˜»å¡ä½ï¼Œé‚£ä¹ˆè¯¥å¤„ç†å™¨å¯ä»¥ç‹¬å ä½¿ç”¨å…±äº«å†…å­˜ã€‚ä½†æ˜¯è¿™ç§å¤„ç†æ–¹å¼æ˜¾å¾—æœ‰ç‚¹å„¿éœ¸é“ï¼Œä¸åšé“ï¼Œä»–æŠŠCPUå’Œå†…å­˜ä¹‹é—´çš„é€šä¿¡é”ä½äº†ï¼Œåœ¨é”å®šæœŸé—´ï¼Œå…¶ä»–å¤„ç†å™¨éƒ½ä¸èƒ½å…¶ä»–å†…å­˜åœ°å€çš„æ•°æ®ï¼Œå…¶å¼€é”€æœ‰ç‚¹å„¿å¤§ã€‚æ‰€ä»¥å°±æœ‰äº†ç¼“å­˜åŠ é”ã€‚
* **ç¼“å­˜åŠ é”**ï¼šå…¶å®é’ˆå¯¹äºä¸Šé¢é‚£ç§æƒ…å†µï¼Œæˆ‘ä»¬åªéœ€è¦ä¿è¯åœ¨åŒä¸€æ—¶åˆ»ï¼Œå¯¹æŸä¸ªå†…å­˜åœ°å€çš„æ“ä½œæ˜¯åŸå­æ€§çš„å³å¯ã€‚ç¼“å­˜åŠ é”ï¼Œå°±æ˜¯ç¼“å­˜åœ¨å†…å­˜åŒºåŸŸçš„æ•°æ®å¦‚æœåœ¨åŠ é”æœŸé—´ï¼Œå½“å®ƒæ‰§è¡Œé”æ“ä½œå†™å›å†…å­˜æ—¶ï¼Œå¤„ç†å™¨ä¸å†è¾“ å‡ºLOCK# ä¿¡å·ï¼Œè€Œæ˜¯ä¿®æ”¹å†…éƒ¨çš„å†…å­˜åœ°å€ï¼Œåˆ©ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥ä¿è¯åŸå­æ€§ã€‚ç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶å¯ä»¥ä¿è¯åŒä¸€ä¸ªå†…å­˜åŒºåŸŸçš„æ•°æ®ä»…èƒ½è¢«ä¸€ä¸ªå¤„ç†å™¨ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ CPU1 ä¿®æ”¹ç¼“å­˜è¡Œä¸­çš„ `i` æ—¶ä½¿ç”¨ç¼“å­˜é”å®šï¼Œé‚£ä¹ˆ CPU2 å°±ä¸èƒ½åŒæ—¶ç¼“å­˜äº† `i` çš„ç¼“å­˜è¡Œã€‚

# 3. CASç¼ºé™·

CAS è™½ç„¶é«˜æ•ˆåœ°è§£å†³äº†åŸå­æ“ä½œï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ä¸€äº›ç¼ºé™·çš„ï¼Œä¸»è¦è¡¨ç°åœ¨ä¸‰ä¸ªæ–¹é¢ï¼š

* å¾ªç¯æ—¶é—´å¤ªé•¿
* åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡åŸå­æ“ä½œ
* ABA é—®é¢˜

## 3.1 å¾ªç¯æ—¶é—´å¤ªé•¿

å¦‚æœCASä¸€ç›´ä¸æˆåŠŸå‘¢ï¼Ÿè¿™ç§æƒ…å†µç»å¯¹æœ‰å¯èƒ½å‘ç”Ÿï¼Œå¦‚æœè‡ªæ—‹ CAS é•¿æ—¶é—´åœ°ä¸æˆåŠŸï¼Œåˆ™ä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„å¼€é”€ã€‚åœ¨ J.U.C ä¸­ï¼Œæœ‰äº›åœ°æ–¹å°±é™åˆ¶äº† CAS è‡ªæ—‹çš„æ¬¡æ•°ï¼Œä¾‹å¦‚ï¼š BlockingQueue çš„ SynchronousQueue ã€‚

## 3.2 åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡åŸå­æ“ä½œ

çœ‹äº† CAS çš„å®ç°å°±çŸ¥é“è¿™åªèƒ½é’ˆå¯¹ä¸€ä¸ªå…±äº«å˜é‡ï¼Œå¦‚æœæ˜¯å¤šä¸ªå…±äº«å˜é‡å°±åªèƒ½ä½¿ç”¨é”äº†ï¼Œå½“ç„¶å¦‚æœä½ æœ‰åŠæ³•æŠŠå¤šä¸ªå˜é‡æ•´æˆä¸€ä¸ªå˜é‡ï¼Œåˆ©ç”¨ CAS ä¹Ÿä¸é”™ã€‚ä¾‹å¦‚è¯»å†™é”ä¸­ `state` çš„é«˜ä½ä½ã€‚

## 3.3 ABAé—®é¢˜

CAS éœ€è¦æ£€æŸ¥æ“ä½œå€¼æœ‰æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿæ”¹å˜åˆ™æ›´æ–°ã€‚ä½†æ˜¯å­˜åœ¨è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯ Aï¼Œå˜æˆäº† Bï¼Œç„¶ååˆå˜æˆäº† Aï¼Œé‚£ä¹ˆåœ¨ CAS æ£€æŸ¥çš„æ—¶å€™ä¼šå‘ç°æ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯å®è´¨ä¸Šå®ƒå·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ABAé—®é¢˜ã€‚å¯¹äº ABA é—®é¢˜å…¶è§£å†³æ–¹æ¡ˆæ˜¯åŠ ä¸Šç‰ˆæœ¬å·ï¼Œå³åœ¨æ¯ä¸ªå˜é‡éƒ½åŠ ä¸Šä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ”¹å˜æ—¶åŠ  1 ï¼Œå³ `A â€”> B â€”> A` ï¼Œå˜æˆ`1A â€”> 2B â€”> 3A` ã€‚

### 3.3.1 å½±å“

ç”¨ä¸€ä¸ªä¾‹å­æ¥é˜è¿° ABA é—®é¢˜æ‰€å¸¦æ¥çš„å½±å“ã€‚

1. æœ‰å¦‚ä¸‹é“¾è¡¨å¦‚ä¸‹å›¾ï¼š

    ![201703090002](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120816002.png)

2. å‡å¦‚æˆ‘ä»¬æƒ³è¦æŠŠ A æ›¿æ¢ä¸º B ï¼Œä¹Ÿå°±æ˜¯ `#compareAndSet(this, A, B)` ã€‚çº¿ç¨‹ 1 æ‰§è¡Œ A æ›¿æ¢ B æ“ä½œä¹‹å‰ï¼Œçº¿ç¨‹ 2 å…ˆæ‰§è¡Œå¦‚ä¸‹åŠ¨ä½œï¼ŒA ã€B å‡ºæ ˆï¼Œç„¶å Cã€A å…¥æ ˆï¼Œæœ€ç»ˆè¯¥é“¾è¡¨å¦‚ä¸‹ï¼š

    ![201703090003](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120816003.png)

3. å®Œæˆåï¼Œçº¿ç¨‹ 1 å‘ç°ä»ç„¶æ˜¯ A ï¼Œé‚£ä¹ˆ `#compareAndSet(this, A, B)` æˆåŠŸï¼Œä½†æ˜¯è¿™æ—¶ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ `B.next = null`ï¼Œå› æ­¤ `#compareAndSet(this, A, B)` åï¼Œä¼šå¯¼è‡´ C ä¸¢å¤±ï¼Œæ”¹æ ˆä»…æœ‰ä¸€ä¸ª B å…ƒç´ ï¼Œå¹³ç™½æ— æ•…æŠŠ C ç»™ä¸¢å¤±äº†ã€‚

### 3.3.2 è§£å†³æ–¹æ¡ˆ AtomicStampedReference

CAS çš„ ABA éšæ‚£é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆåˆ™æ˜¯ç‰ˆæœ¬å·ï¼ŒJava æä¾›äº† AtomicStampedReference æ¥è§£å†³ã€‚AtomicStampedReference é€šè¿‡åŒ…è£… `[E,Integer]` çš„å…ƒç»„ï¼Œæ¥å¯¹å¯¹è±¡**æ ‡è®°**ç‰ˆæœ¬æˆ³ `stamp` ï¼Œä»è€Œé¿å… ABA é—®é¢˜ã€‚å¯¹äºä¸Šé¢çš„æ¡ˆä¾‹ï¼Œåº”è¯¥çº¿ç¨‹ 1 ä¼šå¤±è´¥ã€‚

AtomicStampedReference çš„ `#compareAndSet(...)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
public boolean compareAndSet(V   expectedReference,
                             V   newReference,
                             int expectedStamp,
                             int newStamp) {
    Pair<V> current = pair;
    return
        expectedReference == current.reference &&
        expectedStamp == current.stamp &&
        ((newReference == current.reference &&
          newStamp == current.stamp) ||
         casPair(current, Pair.of(newReference, newStamp)));
}
```

* æœ‰å››ä¸ªæ–¹æ³•å‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼šé¢„æœŸå¼•ç”¨ã€æ›´æ–°åçš„å¼•ç”¨ã€é¢„æœŸæ ‡å¿—ã€æ›´æ–°åçš„æ ‡å¿—ã€‚æºç éƒ¨åˆ†å¾ˆå¥½ç†è§£ï¼š
    * 1ã€é¢„æœŸçš„å¼•ç”¨ == å½“å‰å¼•ç”¨
    * 2ã€é¢„æœŸçš„æ ‡è¯† == å½“å‰æ ‡è¯†
    * 3ã€å¦‚æœæ›´æ–°åçš„å¼•ç”¨å’Œæ ‡å¿—å’Œå½“å‰çš„å¼•ç”¨å’Œæ ‡å¿—ç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¿”å› true
    * 4ã€é€šè¿‡ `Pair#of(T reference, int stamp)` æ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ Pair å¯¹è±¡ï¼Œä¸å½“å‰ Pair **CAS** æ›¿æ¢ã€‚
* Pair ä¸º AtomicStampedReference çš„å†…éƒ¨ç±»ï¼Œä¸»è¦ç”¨äºè®°å½•å¼•ç”¨å’Œç‰ˆæœ¬æˆ³ä¿¡æ¯ï¼ˆæ ‡è¯†ï¼‰ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

    ```Java
    // AtomicStampedReference.java
    
    private static class Pair<T> {
        final T reference; // å¯¹è±¡å¼•ç”¨
        final int stamp; // ç‰ˆæœ¬æˆ³
        private Pair(T reference, int stamp) {
            this.reference = reference;
            this.stamp = stamp;
        }
        static <T> Pair<T> of(T reference, int stamp) {
            return new Pair<T>(reference, stamp);
        }
    }
    
    private volatile Pair<V> pair;
    ```

    * Pair è®°å½•äº†å¯¹è±¡çš„å¼•ç”¨å’Œç‰ˆæœ¬æˆ³ï¼Œç‰ˆæœ¬æˆ³ä¸º int å‹ï¼Œä¿æŒè‡ªå¢ã€‚åŒæ—¶ Pair æ˜¯ä¸€ä¸ªä¸å¯å˜å¯¹è±¡ï¼Œå…¶æ‰€æœ‰å±æ€§å…¨éƒ¨å®šä¹‰ä¸º final ã€‚
        * å¯¹å¤–æä¾›ä¸€ä¸ª `#of(T reference, int stamp)` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°å»ºçš„ Pair å¯¹è±¡ã€‚
    * `pair` å±æ€§ï¼Œå®šä¹‰ä¸º `volatile` ï¼Œä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¯è§æ€§ã€‚åœ¨AtomicStampedReference ä¸­ï¼Œå¤§å¤šæ–¹æ³•éƒ½æ˜¯é€šè¿‡è°ƒç”¨ Pair çš„ `#of(T reference, int stamp)` æ–¹æ³•ï¼Œæ¥äº§ç”Ÿä¸€ä¸ªæ–°çš„ Pair å¯¹è±¡ï¼Œç„¶åèµ‹å€¼ç»™å˜é‡ `pair` ã€‚å¦‚ `set(V newReference, int newStamp)`æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
    
        ```Java
        // AtomicStampedReference.java
        public void set(V newReference, int newStamp) {
            Pair<V> current = pair;
            if (newReference != current.reference || newStamp != current.stamp)
                this.pair = Pair.of(newReference, newStamp);
        }
        ```
        * x

### 3.3.3 å®é™…æ¡ˆä¾‹

ä¸‹é¢ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œå¯ä»¥çœ‹åˆ° AtomicStampedReference å’Œ AtomicIntegerçš„åŒºåˆ«ã€‚æˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ 1 è´Ÿè´£å°† `100 â€”> 110 â€”> 100`ï¼Œçº¿ç¨‹ 2 æ‰§è¡Œ `100 â€”>120` ï¼Œçœ‹ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ã€‚

```Java
public class Test {
    private static AtomicInteger atomicInteger = new AtomicInteger(100);
    private static AtomicStampedReference atomicStampedReference = new AtomicStampedReference(100,1);

    public static void main(String[] args) throws InterruptedException {

        // AtomicInteger
        Thread at1 = new Thread(new Runnable() {
            @Override
            public void run() {
                atomicInteger.compareAndSet(100,110);
                atomicInteger.compareAndSet(110,100);
            }
        });

        Thread at2 = new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    TimeUnit.SECONDS.sleep(2);      // at1,æ‰§è¡Œå®Œ
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("AtomicInteger:" + atomicInteger.compareAndSet(100,120));
            }
        });

        at1.start();
        at2.start();

        at1.join();
        at2.join();

        // AtomicStampedReference

        Thread tsf1 = new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    //è®© tsf2å…ˆè·å–stampï¼Œå¯¼è‡´é¢„æœŸæ—¶é—´æˆ³ä¸ä¸€è‡´
                    TimeUnit.SECONDS.sleep(2);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                // é¢„æœŸå¼•ç”¨ï¼š100ï¼Œæ›´æ–°åçš„å¼•ç”¨ï¼š110ï¼Œé¢„æœŸæ ‡è¯†getStamp() æ›´æ–°åçš„æ ‡è¯†getStamp() + 1
                atomicStampedReference.compareAndSet(100,110,atomicStampedReference.getStamp(),atomicStampedReference.getStamp() + 1);
                atomicStampedReference.compareAndSet(110,100,atomicStampedReference.getStamp(),atomicStampedReference.getStamp() + 1);
            }
        });

        Thread tsf2 = new Thread(new Runnable() {
            @Override
            public void run() {
                int stamp = atomicStampedReference.getStamp();

                try {
                    TimeUnit.SECONDS.sleep(2);      //çº¿ç¨‹tsf1æ‰§è¡Œå®Œ
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("AtomicStampedReference:" +atomicStampedReference.compareAndSet(100,120,stamp,stamp + 1));
            }
        });

        tsf1.start();
        tsf2.start();
    }

}
```

* è¿è¡Œç»“æœï¼š

    ![è¿è¡Œç»“æœ](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120816004.png)

è¿è¡Œç»“æœå……åˆ†å±•ç¤ºäº† AtomicInteger å¯¼è‡´çš„ ABA é—®é¢˜ï¼Œå’Œä½¿ç”¨ AtomicStampedReference è§£å†³ ABA é—®é¢˜ã€‚

# å‚è€ƒèµ„æ–™

1. æ–¹è…¾é£ï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹çš„ [ã€Œ7. Java ä¸­çš„ 13 ä¸ªåŸå­æ“ä½œç±»ã€](#) ç« èŠ‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

