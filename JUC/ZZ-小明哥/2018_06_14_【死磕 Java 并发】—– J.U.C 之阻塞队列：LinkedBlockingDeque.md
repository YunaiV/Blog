title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ J.U.C ä¹‹é˜»å¡é˜Ÿåˆ—ï¼šLinkedBlockingDeque
date: 2018-06-14
tag: 
categories: JUC
permalink: JUC/sike/LinkedBlockingDeque
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2437
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2437 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [LinkedBlockingDeque](http://www.iocoder.cn/JUC/sike/LinkedBlockingDeque/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

å‰é¢çš„BlockingQueueéƒ½æ˜¯å•å‘çš„FIFOé˜Ÿåˆ—ï¼Œè€ŒLinkedBlockingDequeåˆ™æ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ï¼ŒåŒå‘é˜Ÿåˆ—å°±æ„å‘³ç€å¯ä»¥ä»å¯¹å¤´ã€å¯¹å°¾ä¸¤ç«¯æ’å…¥å’Œç§»é™¤å…ƒç´ ï¼ŒåŒæ ·æ„å‘³ç€LinkedBlockingDequeæ”¯æŒFIFOã€FILOä¸¤ç§æ“ä½œæ–¹å¼ã€‚

LinkedBlockingDequeæ˜¯å¯é€‰å®¹é‡çš„ï¼Œåœ¨åˆå§‹åŒ–æ—¶å¯ä»¥è®¾ç½®å®¹é‡é˜²æ­¢å…¶è¿‡åº¦è†¨èƒ€ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œé»˜è®¤å®¹é‡å¤§å°ä¸ºInteger.MAX_VALUEã€‚

## LinkedBlockingDeque

LinkedBlockingDeque ç»§æ‰¿AbstractQueueï¼Œå®ç°æ¥å£BlockingDequeï¼Œè€ŒBlockingDequeåˆç»§æ‰¿æ¥å£BlockingQueueï¼ŒBlockingDequeæ˜¯æ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„ Queueï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯ï¼šè·å–å…ƒç´ æ—¶ç­‰å¾…åŒç«¯é˜Ÿåˆ—å˜ä¸ºéç©ºï¼›å­˜å‚¨å…ƒç´ æ—¶ç­‰å¾…åŒç«¯é˜Ÿåˆ—ä¸­çš„ç©ºé—´å˜å¾—å¯ç”¨ã€‚è¿™ä¸¤ç±»æ“ä½œå°±ä¸ºLinkedBlockingDeque çš„åŒå‘æ“ä½œQueueæä¾›äº†å¯èƒ½ã€‚BlockingDequeæ¥å£æä¾›äº†ä¸€ç³»åˆ—çš„ä»¥Firstå’ŒLastç»“å°¾çš„æ–¹æ³•ï¼Œå¦‚addFirstã€addLastã€peekFirstã€peekLastã€‚

```Java
public class LinkedBlockingDeque<E>
    extends AbstractQueue<E>
    implements BlockingDeque<E>, java.io.Serializable {

    // åŒå‘é“¾è¡¨çš„è¡¨å¤´
    transient Node<E> first;

    // åŒå‘é“¾è¡¨çš„è¡¨å°¾
    transient Node<E> last;

    // å¤§å°ï¼ŒåŒå‘é“¾è¡¨ä¸­å½“å‰èŠ‚ç‚¹ä¸ªæ•°
    private transient int count;

    // å®¹é‡ï¼Œåœ¨åˆ›å»ºLinkedBlockingDequeæ—¶æŒ‡å®šçš„
    private final int capacity;

    final ReentrantLock lock = new ReentrantLock();

    private final Condition notEmpty = lock.newCondition();

    private final Condition notFull = lock.newCondition();

}
```

é€šè¿‡ä¸Šé¢çš„Lockå¯ä»¥çœ‹å‡ºï¼ŒLinkedBlockingDequeåº•å±‚å®ç°æœºåˆ¶ä¸LinkedBlockingQueueä¸€æ ·ï¼Œä¾ç„¶æ˜¯é€šè¿‡äº’æ–¥é”ReentrantLock æ¥å®ç°ï¼ŒnotEmpty ã€notFull ä¸¤ä¸ªConditionåšåè°ƒç”Ÿäº§è€…ã€æ¶ˆè´¹è€…é—®é¢˜ã€‚

ä¸å…¶ä»–BlockingQueueä¸€æ ·ï¼ŒèŠ‚ç‚¹è¿˜æ˜¯ä½¿ç”¨å†…éƒ¨ç±»Nodeï¼š

```Java
    static final class Node<E> {
        E item;

        Node<E> prev;

        Node<E> next;

        Node(E x) {
            item = x;
        }
    }
```

åŒå‘å˜›ï¼ŒèŠ‚ç‚¹è‚¯å®šå¾—è¦æœ‰å‰é©±prevã€åç»§nextå’¯ã€‚

### åŸºç¡€æ–¹æ³•

LinkedBlockingDeque çš„addã€putã€offerã€takeã€peekã€pollç³»åˆ—æ–¹æ³•éƒ½æ˜¯é€šè¿‡è°ƒç”¨XXXFirstï¼ŒXXXLastæ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œå°±ä»…ä»¥putFirstã€putLastã€pollFirstã€pollLaståˆ†æä¸‹ã€‚

**putFirst**

putFirst(E e) :å°†æŒ‡å®šçš„å…ƒç´ æ’å…¥æ­¤åŒç«¯é˜Ÿåˆ—çš„å¼€å¤´ï¼Œå¿…è¦æ—¶å°†ä¸€ç›´ç­‰å¾…å¯ç”¨ç©ºé—´ã€‚

```Java
    public void putFirst(E e) throws InterruptedException {
        // check null
        if (e == null) throw new NullPointerException();
        Node<E> node = new Node<E>(e);
        // è·å–é”
        final ReentrantLock lock = this.lock;
        lock.lock();
        try {
            while (!linkFirst(node))
                // åœ¨notFullæ¡ä»¶ä¸Šç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–ä¸­æ–­
                notFull.await();
        } finally {
            // é‡Šæ”¾é”
            lock.unlock();
        }
    }
```

å…ˆè·å–é”ï¼Œç„¶åè°ƒç”¨linkFirstæ–¹æ³•å…¥åˆ—ï¼Œæœ€åé‡Šæ”¾é”ã€‚å¦‚æœé˜Ÿåˆ—æ˜¯æ»¡çš„åˆ™åœ¨notFullä¸Šé¢ç­‰å¾…ã€‚linkFirstè®¾ç½®Nodeä¸ºå¯¹å¤´ï¼š

```Java
    private boolean linkFirst(Node<E> node) {
        // è¶…å‡ºå®¹é‡
        if (count >= capacity)
            return false;

        // é¦–èŠ‚ç‚¹
        Node<E> f = first;
        // æ–°èŠ‚ç‚¹çš„nextæŒ‡å‘åŸfirst
        node.next = f;
        // è®¾ç½®nodeä¸ºæ–°çš„first
        first = node;

        // æ²¡æœ‰å°¾èŠ‚ç‚¹ï¼Œè®¾ç½®nodeä¸ºå°¾èŠ‚ç‚¹
        if (last == null)
            last = node;
        // æœ‰å°¾èŠ‚ç‚¹ï¼Œé‚£å°±å°†ä¹‹å‰firstçš„preæŒ‡å‘æ–°å¢node
        else
            f.prev = node;
        ++count;
        // å”¤é†’notEmpty
        notEmpty.signal();
        return true;
    }
```

linkFirstä¸»è¦æ˜¯è®¾ç½®nodeèŠ‚ç‚¹é˜Ÿåˆ—çš„åˆ—å¤´èŠ‚ç‚¹ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†è¿”å›falseã€‚æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚

**putLast**

putLast(E e) :å°†æŒ‡å®šçš„å…ƒç´ æ’å…¥æ­¤åŒç«¯é˜Ÿåˆ—çš„æœ«å°¾ï¼Œå¿…è¦æ—¶å°†ä¸€ç›´ç­‰å¾…å¯ç”¨ç©ºé—´ã€‚

```Java
    public void putLast(E e) throws InterruptedException {
        if (e == null) throw new NullPointerException();
        Node<E> node = new Node<E>(e);
        final ReentrantLock lock = this.lock;
        lock.lock();
        try {
            while (!linkLast(node))
                notFull.await();
        } finally {
            lock.unlock();
        }
    }
```

è°ƒç”¨linkLastå°†èŠ‚ç‚¹Nodeé“¾æ¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼š

```Java
    private boolean linkLast(Node<E> node) {
        if (count >= capacity)
            return false;
        // å°¾èŠ‚ç‚¹
        Node<E> l = last;

        // å°†Nodeçš„å‰é©±æŒ‡å‘åŸæœ¬çš„last
        node.prev = l;

        // å°†nodeè®¾ç½®ä¸ºlast
        last = node;
        // é¦–èŠ‚ç‚¹ä¸ºnullï¼Œåˆ™è®¾ç½®nodeä¸ºfirst
        if (first == null)
            first = node;
        else
        //énullï¼Œè¯´æ˜ä¹‹å‰çš„lastæœ‰å€¼ï¼Œå°±å°†ä¹‹å‰çš„lastçš„nextæŒ‡å‘node
            l.next = node;
        ++count;
        notEmpty.signal();
        return true;
    }
```

**pollFirst**

pollFirst()ï¼šè·å–å¹¶ç§»é™¤æ­¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼›å¦‚æœæ­¤åŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› nullã€‚

```Java
    public E pollFirst() {
        final ReentrantLock lock = this.lock;
        lock.lock();
        try {
            return unlinkFirst();
        } finally {
            lock.unlock();
        }
    }
```

è°ƒç”¨unlinkFirstç§»é™¤é˜Ÿåˆ—é¦–å…ƒç´ ï¼š

```Java
    private E unlinkFirst() {
        // é¦–èŠ‚ç‚¹
        Node<E> f = first;

        // ç©ºé˜Ÿåˆ—ï¼Œç›´æ¥è¿”å›null
        if (f == null)
            return null;

        // first.next
        Node<E> n = f.next;

        // èŠ‚ç‚¹item
        E item = f.item;

        // ç§»é™¤æ‰first ==> first = first.next
        f.item = null;
        f.next = f; // help GC
        first = n;

        // ç§»é™¤åä¸ºç©ºé˜Ÿåˆ—ï¼Œä»…æœ‰ä¸€ä¸ªèŠ‚ç‚¹
        if (n == null)
            last = null;
        else
        // nçš„preåŸæ¥æŒ‡å‘ä¹‹å‰çš„firstï¼Œç°åœ¨nå˜ä¸ºfirstäº†ï¼ŒpreæŒ‡å‘null
            n.prev = null;
        --count;
        notFull.signal();
        return item;
    }
```

**pollLast**

pollLast():è·å–å¹¶ç§»é™¤æ­¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼›å¦‚æœæ­¤åŒç«¯é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å› nullã€‚

```Java
    public E pollLast() {
        final ReentrantLock lock = this.lock;
        lock.lock();
        try {
            return unlinkLast();
        } finally {
            lock.unlock();
        }
    }
```

è°ƒç”¨unlinkLastç§»é™¤å°¾ç»“ç‚¹ï¼Œé“¾è¡¨ç©ºè¿”å›null ï¼š

```Java
    private E unlinkLast() {
        // assert lock.isHeldByCurrentThread();
        Node<E> l = last;
        if (l == null)
            return null;
        Node<E> p = l.prev;
        E item = l.item;
        l.item = null;
        l.prev = l; // help GC
        last = p;
        if (p == null)
            first = null;
        else
            p.next = null;
        --count;
        notFull.signal();
        return item;
    }
```

LinkedBlockingDequeå¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯é€šè¿‡linkFirstã€linkLastã€unlinkFirstã€unlinkLastè¿™å››ä¸ªæ–¹æ³•æ¥å®ç°çš„ï¼Œå› ä¸ºæ˜¯åŒå‘é˜Ÿåˆ—ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½æ˜¯é’ˆå¯¹firstã€lastçš„æ“ä½œï¼Œçœ‹æ‡‚è¿™ä¸ªæ•´ä¸ªLinkedBlockingDequeå°±ä¸éš¾äº†ã€‚

**æŒæ¡äº†åŒå‘é˜Ÿåˆ—çš„æ’å…¥ã€åˆ é™¤æ“ä½œï¼ŒLinkedBlockingDequeå°±æ²¡æœ‰ä»»ä½•éš¾åº¦å¯è¨€äº†ï¼Œæ•°æ®ç»“æ„çš„é‡è¦æ€§å•Šï¼ï¼ï¼ï¼**

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)