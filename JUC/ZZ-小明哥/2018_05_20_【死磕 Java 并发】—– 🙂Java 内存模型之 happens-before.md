title: ã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ Java å†…å­˜æ¨¡å‹ä¹‹ happens-before
date: 2018-05-20
tags:
categories: JUC
permalink: JUC/sike/happens-before
author: å°æ˜å“¥
from_url: http://cmsblogs.com/?p=2122
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247483805&idx=1&sn=0833a7698863d1274a540f4c09297242&chksm=fa497e2ccd3ef73a977d4a2e665ec84b34e6ff63a90348d123adfd92e630c982af1e8be96a13#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://cmsblogs.com/?p=2122 ã€Œå°æ˜å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

ä½œä¸ºã€Œå°æ˜å“¥ã€çš„å¿ å®è¯»è€…ï¼Œã€Œè€è‰¿è‰¿ã€ç•¥ä½œä¿®æ”¹ï¼Œè®°å½•åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œå‚è€ƒçš„èµ„æ–™ã€‚

- [1. å®šä¹‰](http://www.iocoder.cn/JUC/sike/happens-before/)
- [2. è§„åˆ™](http://www.iocoder.cn/JUC/sike/happens-before/)
- [å‚è€ƒèµ„æ–™](http://www.iocoder.cn/JUC/sike/happens-before/)
- [666. å½©è›‹](http://www.iocoder.cn/JUC/sike/happens-before/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åœ¨ä¸Šç¯‡åšå®¢ï¼ˆ[ã€Šã€æ­»ç£• Java å¹¶å‘ã€‘â€”â€“ æ·±å…¥åˆ†æ volatile çš„å®ç°åŸç†ã€‹](http://www.iocoder.cn/JUC/sike/volatile)ï¼‰ä¸­ï¼ŒLZ æåˆ°è¿‡ç”±äºå­˜åœ¨çº¿ç¨‹æœ¬åœ°å†…å­˜å’Œä¸»å†…å­˜çš„åŸå› ï¼Œå†åŠ ä¸Šé‡æ’åºï¼Œä¼šå¯¼è‡´**å¤šçº¿ç¨‹**ç¯å¢ƒä¸‹å­˜åœ¨å¯è§æ€§çš„é—®é¢˜ã€‚é‚£ä¹ˆæˆ‘ä»¬æ­£ç¡®ä½¿ç”¨åŒæ­¥ã€é”çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ A ä¿®æ”¹äº†å˜é‡ `a` ï¼Œä½•æ—¶å¯¹çº¿ç¨‹ B å¯è§ï¼Ÿ

æˆ‘ä»¬æ— æ³•å°±æ‰€æœ‰åœºæ™¯æ¥è§„å®šï¼ŒæŸä¸ªçº¿ç¨‹ä¿®æ”¹çš„å˜é‡ä½•æ—¶å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŒ‡å®šæŸäº›è§„åˆ™ï¼Œè¿™è§„åˆ™å°±æ˜¯ happens-before ã€‚ä» JDK 5 å¼€å§‹ï¼ŒJMM å°±ä½¿ç”¨ happens-before çš„æ¦‚å¿µï¼Œæ¥é˜è¿°å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚

> åœ¨ JMM ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»å­˜åœ¨ happens-before å…³ç³»ã€‚

happens-before åŸåˆ™éå¸¸é‡è¦ï¼Œå®ƒæ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®ï¼Œä¾é è¿™ä¸ªåŸåˆ™ï¼Œæˆ‘ä»¬è§£å†³åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä¸¤æ“ä½œä¹‹é—´æ˜¯å¦å¯èƒ½å­˜åœ¨å†²çªçš„æ‰€æœ‰é—®é¢˜ã€‚ä¸‹é¢æˆ‘ä»¬å°±ä¸€ä¸ªç®€å•çš„ä¾‹å­ç¨å¾®äº†è§£ä¸‹happens-before ï¼›

```Java
i = 1; // çº¿ç¨‹ A æ‰§è¡Œ
j = i;  //çº¿ç¨‹ B æ‰§è¡Œ
```

`j` æ˜¯å¦ç­‰äº 1 å‘¢ï¼Ÿå‡å®šçº¿ç¨‹ A çš„æ“ä½œï¼ˆ`i = 1`ï¼‰happens-before çº¿ç¨‹ B çš„æ“ä½œï¼ˆ`j = i`ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç¡®å®šï¼Œçº¿ç¨‹ B æ‰§è¡Œå `j = 1` **ä¸€å®š**æˆç«‹ã€‚å¦‚æœä»–ä»¬ä¸å­˜åœ¨ happens-before åŸåˆ™ï¼Œé‚£ä¹ˆ `j = 1` **ä¸ä¸€å®š**æˆç«‹ã€‚è¿™å°±æ˜¯happens-beforeåŸåˆ™çš„å¨åŠ›ã€‚

# 1. å®šä¹‰

**happens-before åŸåˆ™**ã€å®šä¹‰ã€‘å¦‚ä¸‹ï¼š

* 1. å¦‚æœä¸€ä¸ªæ“ä½œ happens-before å¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœï¼Œå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚
* 2. ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨ happens-before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€ä¸€å®šè¦æŒ‰ç…§ happens-before åŸåˆ™åˆ¶å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœä¸æŒ‰ç…§ happens-before å…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ã€‚

# 2. è§„åˆ™

**happens-before åŸåˆ™**ã€è§„åˆ™ã€‘å¦‚ä¸‹ï¼š

> FROM [ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹](#)
>
> * ç¨‹åºæ¬¡åºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œï¼Œhappens-before äºä¹¦å†™åœ¨åé¢çš„æ“ä½œã€‚
> * é”å®šè§„åˆ™ï¼šä¸€ä¸ª unLock æ“ä½œï¼Œhappens-before äºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚
> * volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªå˜é‡çš„å†™æ“ä½œï¼Œhappens-before äºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œã€‚
> * ä¼ é€’è§„åˆ™ï¼šå¦‚æœæ“ä½œ A happens-before æ“ä½œ Bï¼Œè€Œæ“ä½œ B happens-before æ“ä½œCï¼Œåˆ™å¯ä»¥å¾—å‡ºï¼Œæ“ä½œ A happens-before æ“ä½œC
> * çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThread å¯¹è±¡çš„ start æ–¹æ³•ï¼Œhappens-before æ­¤çº¿ç¨‹çš„æ¯ä¸ªä¸€ä¸ªåŠ¨ä½œã€‚
> * çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹ interrupt æ–¹æ³•çš„è°ƒç”¨ï¼Œhappens-before è¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿã€‚
> * çº¿ç¨‹ç»ˆç»“è§„åˆ™ï¼šçº¿ç¨‹ä¸­æ‰€æœ‰çš„æ“ä½œï¼Œéƒ½ happens-before çº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Thread.join() æ–¹æ³•ç»“æŸã€Thread.isAlive() çš„è¿”å›å€¼æ‰‹æ®µï¼Œæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚
> * å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼Œhappens-before å®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹

ä¸Šé¢å…«æ¡æ˜¯**åŸç”Ÿ Java** æ»¡è¶³ happens-before å…³ç³»çš„è§„åˆ™ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¯¹ä»–ä»¬è¿›è¡Œæ¨å¯¼å‡ºå…¶ä»–æ»¡è¶³ happens-before çš„è§„åˆ™ï¼š

1. å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—çš„æ“ä½œï¼Œhappens-before ä»é˜Ÿåˆ—ä¸­å–å‡ºè¿™ä¸ªå…ƒç´ çš„æ“ä½œã€‚
2. å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å®¹å™¨çš„æ“ä½œï¼Œhappens-before ä»å®¹å™¨ä¸­å–å‡ºè¿™ä¸ªå…ƒç´ çš„æ“ä½œã€‚
3. åœ¨ CountDownLatch ä¸Šçš„ countDown æ“ä½œï¼Œhappens-before CountDownLatch ä¸Šçš„ await æ“ä½œã€‚
4. é‡Šæ”¾ Semaphore ä¸Šçš„ release çš„æ“ä½œï¼Œhappens-before ä¸Šçš„ acquire æ“ä½œã€‚
5. Future è¡¨ç¤ºçš„ä»»åŠ¡çš„æ‰€æœ‰æ“ä½œï¼Œhappens-before Future ä¸Šçš„ get æ“ä½œã€‚
6. å‘ Executor æäº¤ä¸€ä¸ª Runnable æˆ– Callable çš„æ“ä½œï¼Œhappens-before ä»»åŠ¡å¼€å§‹æ‰§è¡Œæ“ä½œã€‚

è¿™é‡Œå†è¯´ä¸€é happens-before çš„æ¦‚å¿µï¼š**å¦‚æœä¸¤ä¸ªæ“ä½œä¸å­˜åœ¨ä¸Šè¿°ï¼ˆå‰é¢8æ¡ + åé¢6æ¡ï¼‰ä»»ä¸€ä¸€ä¸ª happens-before è§„åˆ™ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œå°±æ²¡æœ‰é¡ºåºçš„ä¿éšœï¼ŒJVM å¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œè¿›è¡Œé‡æ’åºã€‚å¦‚æœæ“ä½œ A happens-before æ“ä½œ Bï¼Œé‚£ä¹ˆæ“ä½œAåœ¨å†…å­˜ä¸Šæ‰€åšçš„æ“ä½œå¯¹æ“ä½œBéƒ½æ˜¯å¯è§çš„ã€‚**

ä¸‹é¢å°±ç”¨ä¸€ä¸ªç®€å•çš„**ä¾‹å­**ï¼Œæ¥æè¿°ä¸‹ happens-before çš„åŸåˆ™ï¼š

```Java
private int i = 0;

public void write(int j ) {
	i = j;
}

public int read() {
	return i;
}
```

æˆ‘ä»¬çº¦å®šçº¿ç¨‹ A æ‰§è¡Œ `#write(int j)`ï¼Œçº¿ç¨‹ B æ‰§è¡Œ `#read()`ï¼Œä¸”çº¿ç¨‹ A ä¼˜å…ˆäºçº¿ç¨‹ B æ‰§è¡Œï¼Œé‚£ä¹ˆçº¿ç¨‹ B è·å¾—ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

å°±è¿™æ®µç®€å•çš„ä»£ç ï¼Œæˆ‘ä»¬æ¥åŸºäº happens-before çš„è§„åˆ™åšä¸€æ¬¡åˆ†æï¼š

1. ç”±äºä¸¤ä¸ªæ–¹æ³•æ˜¯ç”±ä¸åŒçš„çº¿ç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥è‚¯å®šä¸æ»¡è¶³ç¨‹åºæ¬¡åºè§„åˆ™ã€‚
2. ä¸¤ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰ä½¿ç”¨é”ï¼Œæ‰€ä»¥ä¸æ»¡è¶³é”å®šè§„åˆ™ã€‚
3. å˜é‡ `i` ä¸æ˜¯ç”¨volatileä¿®é¥°çš„ï¼Œæ‰€ä»¥ `volatile` å˜é‡è§„åˆ™ä¸æ»¡è¶³ã€‚
4. ä¼ é€’è§„åˆ™è‚¯å®šä¸æ»¡è¶³ã€‚
5. è§„åˆ™ 5ã€6ã€7ã€8 + æ¨å¯¼çš„ 6 æ¡å¯ä»¥å¿½ç•¥ï¼Œå› ä¸ºä»–ä»¬å’Œè¿™æ®µä»£ç æ¯«æ— å…³ç³»ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡ happens-before åŸåˆ™ï¼Œæ¨å¯¼å‡ºçº¿ç¨‹ A happens-before çº¿ç¨‹ B ã€‚è™½ç„¶ï¼Œå¯ä»¥ç¡®è®¤åœ¨æ—¶é—´ä¸Šï¼Œçº¿ç¨‹ A ä¼˜å…ˆäºçº¿ç¨‹ B æ‰§è¡Œï¼Œä½†æ˜¯å°±æ˜¯æ— æ³•ç¡®è®¤çº¿ç¨‹Bè·å¾—çš„ç»“æœæ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥è¿™æ®µä»£ç **ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**ã€‚

é‚£ä¹ˆæ€ä¹ˆä¿®å¤è¿™æ®µä»£ç å‘¢ï¼Ÿæ»¡è¶³è§„åˆ™ 2ã€3 ä»»ä¸€å³å¯ã€‚

-------

> happen-beforeåŸåˆ™æ˜¯JMMä¸­éå¸¸é‡è¦çš„åŸåˆ™ï¼Œå®ƒæ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¯è§æ€§ã€‚

ä¸‹å›¾æ˜¯ happens-before ä¸ JMM çš„å…³ç³»å›¾ï¼š

> FROM [ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹](#)
>
> ![happens-before](https://gitee.com/chenssy/blog-home/raw/master/image/sijava/201812083001.png)

# å‚è€ƒèµ„æ–™

1. å‘¨å¿—æ˜ï¼šã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹
2. æ–¹è…¾é£ï¼šã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹

# 666. å½©è›‹

æ•´ç†æœ¬å°èŠ‚ï¼Œç®€å•è„‘å›¾å¦‚ä¸‹ï¼š![è„‘å›¾](http://www.iocoder.cn/images/JUC/happens-before-01.png)

å¦‚æœä½ å¯¹ Java å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

