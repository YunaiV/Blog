title: ã€å å°ç‹¼ã€‘Netty å…¥é—¨ç®€ä»‹
date: 2018-01-01
tags:
categories: Netty
permalink: Netty/zhanxiaolang/intro
author: å å°ç‹¼
from_url: https://www.jianshu.com/p/1123c9164e3e
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484457&idx=1&sn=0131c03cb88d828adb575ad4fc368282&chksm=fa497b98cd3ef28e60017027eafc0c11eb63c1e2d7876780b5ff44e5b3b7549f58068287988c#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/1123c9164e3e ã€Œå å°ç‹¼ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [å‰è¨€](http://www.iocoder.cn/Netty/zhanxiaolang/intro/)
- [Reactoræ¨¡å‹](http://www.iocoder.cn/Netty/zhanxiaolang/intro/)
- [ç¤ºä¾‹ä»£ç ](http://www.iocoder.cn/Netty/zhanxiaolang/intro/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

### å‰è¨€

Nettyæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„NIOæ¡†æ¶ï¼Œæä¾›äº†å¯¹TCPã€UDPå’Œæ–‡ä»¶ä¼ è¾“çš„æ”¯æŒï¼Œä½œä¸ºä¸€ä¸ªå¼‚æ­¥NIOæ¡†æ¶ï¼ŒNettyçš„æ‰€æœ‰IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œé€šè¿‡Future-Listeneræœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾—IOæ“ä½œç»“æœã€‚

ä½œä¸ºå½“å‰æœ€æµè¡Œçš„NIOæ¡†æ¶ï¼ŒNettyåœ¨äº’è”ç½‘é¢†åŸŸã€å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸã€æ¸¸æˆè¡Œä¸šã€é€šä¿¡è¡Œä¸šç­‰è·å¾—äº†å¹¿æ³›çš„åº”ç”¨ï¼Œä¸€äº›ä¸šç•Œè‘—åçš„å¼€æºç»„ä»¶ä¹ŸåŸºäºNettyæ„å»ºï¼Œæ¯”å¦‚RPCæ¡†æ¶ã€zookeeperç­‰ã€‚

ä¸ç†Ÿæ‚‰NIOçš„å¯ä»¥å…ˆçœ‹çœ‹ä¸‹é¢ä¸¤ç¯‡æ–‡ç« 
1ã€[æ·±å…¥æµ…å‡ºNIOä¹‹Channelã€Buffer](https://www.jianshu.com/p/052035037297)
2ã€[æ·±å…¥æµ…å‡ºNIOä¹‹Selectorå®ç°åŸç†](https://www.jianshu.com/p/0d497fe5484a)

é‚£ä¹ˆï¼ŒNettyæ€§èƒ½ä¸ºå•¥è¿™ä¹ˆé«˜ï¼Ÿä¸»è¦æ˜¯å› ä¸ºå…¶å†…éƒ¨Reactoræ¨¡å‹çš„å®ç°ã€‚

### Reactoræ¨¡å‹

Nettyä¸­çš„Reactoræ¨¡å‹ä¸»è¦ç”±å¤šè·¯å¤ç”¨å™¨(Acceptor)ã€äº‹ä»¶åˆ†å‘å™¨(Dispatcher)ã€äº‹ä»¶å¤„ç†å™¨(Handler)ç»„æˆï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç§ã€‚

1ã€**å•çº¿ç¨‹æ¨¡å‹**ï¼šæ‰€æœ‰I/Oæ“ä½œéƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆï¼Œå³å¤šè·¯å¤ç”¨ã€äº‹ä»¶åˆ†å‘å’Œå¤„ç†éƒ½æ˜¯åœ¨ä¸€ä¸ªReactorçº¿ç¨‹ä¸Šå®Œæˆçš„ã€‚

![img](http://upload-images.jianshu.io/upload_images/2184951-67e4d230991bbd84.png)

å¯¹äºä¸€äº›å°å®¹é‡åº”ç”¨åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹ã€‚ä½†æ˜¯å¯¹äºé«˜è´Ÿè½½ã€å¤§å¹¶å‘çš„åº”ç”¨å´ä¸åˆé€‚ï¼Œä¸»è¦åŸå› å¦‚ä¸‹ï¼š

- ä¸€ä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†æˆç™¾ä¸Šåƒçš„é“¾è·¯ï¼Œæ€§èƒ½ä¸Šæ— æ³•æ”¯æ’‘ï¼Œå³ä¾¿CPUè´Ÿè·è¾¾åˆ°100%ï¼Œä¹Ÿæ— æ³•æ»¡è¶³æµ·é‡æ¶ˆæ¯çš„ç¼–ç ã€è§£ç ã€è¯»å–å’Œå‘é€ï¼›
- å½“è´Ÿè½½è¿‡é‡åï¼Œå¤„ç†é€Ÿåº¦å°†å˜æ…¢ï¼Œè¿™ä¼šå¯¼è‡´å¤§é‡å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶ï¼Œè¶…æ—¶ä¹‹åå¾€å¾€ä¼šè¿›è¡Œé‡å‘ï¼Œæœ€ç»ˆä¼šå¯¼è‡´å¤§é‡æ¶ˆæ¯ç§¯å‹å’Œå¤„ç†è¶…æ—¶ï¼Œæˆä¸ºç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆï¼›
- ä¸€æ—¦å•çº¿ç¨‹æ„å¤–è·‘é£ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœï¼Œå¯é æ€§ä¸é«˜ã€‚

2ã€**å¤šçº¿ç¨‹æ¨¡å‹**ï¼šä¸ºäº†è§£å†³å•çº¿ç¨‹æ¨¡å‹å­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œæ¼”åŒ–è€Œæ¥çš„Reactorçº¿ç¨‹æ¨¡å‹ã€‚

![img](http://upload-images.jianshu.io/upload_images/2184951-069b2818fa205975.png)

å¤šçº¿ç¨‹æ¨¡å‹çš„ç‰¹ç‚¹ï¼š

- æœ‰ä¸“é—¨ä¸€ä¸ªAcceptorçº¿ç¨‹ç”¨äºç›‘å¬æœåŠ¡ç«¯ï¼Œæ¥æ”¶å®¢æˆ·ç«¯çš„TCPè¿æ¥è¯·æ±‚ï¼›
- ç½‘ç»œIOçš„è¯»å†™æ“ä½œç”±ä¸€ä¸ªNIOçº¿ç¨‹æ± è´Ÿè´£ï¼Œçº¿ç¨‹æ± å¯ä»¥é‡‡ç”¨æ ‡å‡†çš„JDKçº¿ç¨‹æ± å®ç°ï¼ŒåŒ…å«ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—å’ŒNä¸ªå¯ç”¨çš„çº¿ç¨‹ï¼Œç”±è¿™äº›NIOçº¿ç¨‹è´Ÿè´£æ¶ˆæ¯çš„è¯»å–ã€è§£ç ã€ç¼–ç å’Œå‘é€ï¼›
- ä¸€ä¸ªNIOçº¿ç¨‹å¯ä»¥åŒæ—¶å¤„ç†å¤šæ¡é“¾è·¯ï¼Œä½†æ˜¯ä¸€ä¸ªé“¾è·¯åªèƒ½å¯¹åº”ä¸€ä¸ªNIOçº¿ç¨‹ï¼Œé˜²æ­¢å‘ç”Ÿå¹¶å‘æ“ä½œé—®é¢˜ã€‚

åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼ŒReactorå¤šçº¿ç¨‹æ¨¡å‹éƒ½å¯ä»¥æ»¡è¶³æ€§èƒ½éœ€æ±‚ï¼›ä½†æ˜¯ï¼Œåœ¨æç‰¹æ®Šåº”ç”¨åœºæ™¯ä¸­ï¼Œä¸€ä¸ªNIOçº¿ç¨‹è´Ÿè´£ç›‘å¬å’Œå¤„ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯è¿æ¥å¯èƒ½ä¼šå­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚ä¾‹å¦‚ç™¾ä¸‡å®¢æˆ·ç«¯å¹¶å‘è¿æ¥ï¼Œæˆ–è€…æœåŠ¡ç«¯éœ€è¦å¯¹å®¢æˆ·ç«¯çš„æ¡æ‰‹æ¶ˆæ¯è¿›è¡Œå®‰å…¨è®¤è¯ï¼Œè®¤è¯æœ¬èº«éå¸¸æŸè€—æ€§èƒ½ã€‚åœ¨è¿™ç±»åœºæ™¯ä¸‹ï¼Œå•ç‹¬ä¸€ä¸ªAcceptorçº¿ç¨‹å¯èƒ½ä¼šå­˜åœ¨æ€§èƒ½ä¸è¶³é—®é¢˜ï¼Œä¸ºäº†è§£å†³æ€§èƒ½é—®é¢˜ï¼Œäº§ç”Ÿäº†ç¬¬ä¸‰ç§Reactorçº¿ç¨‹æ¨¡å‹-ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹ã€‚

3ã€**ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹**ï¼šé‡‡ç”¨å¤šä¸ªreactorï¼Œæ¯ä¸ªreactoréƒ½åœ¨è‡ªå·±å•ç‹¬çš„çº¿ç¨‹é‡Œæ‰§è¡Œã€‚å¦‚æœæ˜¯å¤šæ ¸ï¼Œåˆ™å¯ä»¥åŒæ—¶å“åº”å¤šä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¸€æ—¦é“¾è·¯å»ºç«‹æˆåŠŸå°±å°†é“¾è·¯æ³¨å†Œåˆ°è´Ÿè´£I/Oè¯»å†™çš„SubReactorçº¿ç¨‹æ± ä¸Šã€‚

![img](http://upload-images.jianshu.io/upload_images/2184951-7af88a4ac1742965.png)

äº‹å®ä¸Šï¼ŒNettyçš„çº¿ç¨‹æ¨¡å‹å¹¶éå›ºå®šä¸å˜ï¼Œåœ¨å¯åŠ¨è¾…åŠ©ç±»ä¸­åˆ›å»ºä¸åŒçš„EventLoopGroupå®ä¾‹å¹¶é€šè¿‡é€‚å½“çš„å‚æ•°é…ç½®ï¼Œå°±å¯ä»¥æ”¯æŒä¸Šè¿°ä¸‰ç§Reactorçº¿ç¨‹æ¨¡å‹ã€‚æ­£æ˜¯å› ä¸ºNettyå¯¹Reactorçº¿ç¨‹æ¨¡å‹çš„æ”¯æŒæä¾›äº†çµæ´»çš„å®šåˆ¶èƒ½åŠ›ï¼Œæ‰€ä»¥å¯ä»¥æ»¡è¶³ä¸åŒä¸šåŠ¡åœºæ™¯çš„æ€§èƒ½éœ€æ±‚ã€‚

### ç¤ºä¾‹ä»£ç 

ä»¥ä¸‹æ˜¯serverå’Œclientçš„ç¤ºä¾‹ä»£ç ï¼Œå…¶ä¸­ä½¿ç”¨çš„æ˜¯ Netty 4.xï¼Œå…ˆçœ‹çœ‹å¦‚ä½•å®ç°ï¼Œåç»­ä¼šé’ˆå¯¹å„ä¸ªæ¨¡å—è¿›è¡Œæ·±å…¥åˆ†æã€‚

server ä»£ç å®ç°

```Java
public class EchoServer {
    private final int port;
    public EchoServer(int port) {
        this.port = port;
    }

    public void run() throws Exception {
        // Configure the server.
        EventLoopGroup bossGroup = new NioEventLoopGroup();  // (1)
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            ServerBootstrap b = new ServerBootstrap(); // (2)
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class) // (3)
             .option(ChannelOption.SO_BACKLOG, 100)
             .handler(new LoggingHandler(LogLevel.INFO))
             .childHandler(new ChannelInitializer<SocketChannel>() { // (4)
                 @Override
                 public void initChannel(SocketChannel ch) throws Exception {
                     ch.pipeline().addLast(
                             //new LoggingHandler(LogLevel.INFO),
                             new EchoServerHandler());
                 }
             });

            // Start the server.
            ChannelFuture f = b.bind(port).sync(); // (5)

            // Wait until the server socket is closed.
            f.channel().closeFuture().sync();
        } finally {
            // Shut down all event loops to terminate all threads.
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port;
        if (args.length > 0) {
            port = Integer.parseInt(args[0]);
        } else {
            port = 8080;
        }
        new EchoServer(port).run();
    }
}
```

EchoServerHandler å®ç°

```Java
public class EchoServerHandler extends ChannelInboundHandlerAdapter {

    private static final Logger logger = Logger.getLogger(
            EchoServerHandler.class.getName());

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        ctx.write(msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {
        ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        // Close the connection when an exception is raised.
        logger.log(Level.WARNING, "Unexpected exception from downstream.", cause);
        ctx.close();
    }
}
```

1ã€[NioEventLoopGroup](https://link.jianshu.com?t=http%3A%2F%2Fnetty.io%2F4.0%2Fapi%2Fio%2Fnetty%2Fchannel%2Fnio%2FNioEventLoopGroup.html) æ˜¯ç”¨æ¥å¤„ç†I/Oæ“ä½œçš„çº¿ç¨‹æ± ï¼ŒNettyå¯¹ EventLoopGroup æ¥å£é’ˆå¯¹ä¸åŒçš„ä¼ è¾“åè®®æä¾›äº†ä¸åŒçš„å®ç°ã€‚åœ¨æœ¬ä¾‹å­ä¸­ï¼Œéœ€è¦å®ä¾‹åŒ–ä¸¤ä¸ªNioEventLoopGroupï¼Œé€šå¸¸ç¬¬ä¸€ä¸ªç§°ä¸ºâ€œbossâ€ï¼Œç”¨æ¥acceptå®¢æˆ·ç«¯è¿æ¥ï¼Œå¦ä¸€ä¸ªç§°ä¸ºâ€œworkerâ€ï¼Œå¤„ç†å®¢æˆ·ç«¯æ•°æ®çš„è¯»å†™æ“ä½œã€‚
2ã€[ServerBootstrap](https://link.jianshu.com?t=http%3A%2F%2Fnetty.io%2F4.0%2Fapi%2Fio%2Fnetty%2Fbootstrap%2FServerBootstrap.html) æ˜¯å¯åŠ¨æœåŠ¡çš„è¾…åŠ©ç±»ï¼Œæœ‰å…³socketçš„å‚æ•°å¯ä»¥é€šè¿‡ServerBootstrapè¿›è¡Œè®¾ç½®ã€‚
3ã€è¿™é‡ŒæŒ‡å®šNioServerSocketChannelç±»åˆå§‹åŒ–channelç”¨æ¥æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ã€‚
4ã€é€šå¸¸ä¼šä¸ºæ–°SocketChannelé€šè¿‡æ·»åŠ ä¸€äº›handlerï¼Œæ¥è®¾ç½®ChannelPipelineã€‚[ChannelInitializer](https://link.jianshu.com?t=http%3A%2F%2Fnetty.io%2F4.0%2Fapi%2Fio%2Fnetty%2Fchannel%2FChannelInitializer.html) æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„handlerï¼Œå…¶ä¸­initChannelæ–¹æ³•å¯ä»¥ä¸ºSocketChannel çš„pipelineæ·»åŠ æŒ‡å®šhandlerã€‚
5ã€é€šè¿‡ç»‘å®šç«¯å£8080ï¼Œå°±å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†ã€‚

client ä»£ç å®ç°

```Java
public class EchoClient {

    private final String host;
    private final int port;
    private final int firstMessageSize;

    public EchoClient(String host, int port, int firstMessageSize) {
        this.host = host;
        this.port = port;
        this.firstMessageSize = firstMessageSize;
    }

    public void run() throws Exception {
        // Configure the client.
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            Bootstrap b = new Bootstrap();
            b.group(group)
             .channel(NioSocketChannel.class)
             .option(ChannelOption.TCP_NODELAY, true)
             .handler(new ChannelInitializer<SocketChannel>() {
                 @Override
                 public void initChannel(SocketChannel ch) throws Exception {
                     ch.pipeline().addLast(
                             //new LoggingHandler(LogLevel.INFO),
                             new EchoClientHandler(firstMessageSize));
                 }
             });

            // Start the client.
            ChannelFuture f = b.connect(host, port).sync();

            // Wait until the connection is closed.
            f.channel().closeFuture().sync();
        } finally {
            // Shut down the event loop to terminate all threads.
            group.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        final String host = args[0];
        final int port = Integer.parseInt(args[1]);
        final int firstMessageSize;
        if (args.length == 3) {
            firstMessageSize = Integer.parseInt(args[2]);
        } else {
            firstMessageSize = 256;
        }

        new EchoClient(host, port, firstMessageSize).run();
    }
}
```

EchoClientHandler å®ç°

```Java
public class EchoClientHandler extends ChannelInboundHandlerAdapter {

    private static final Logger logger = Logger.getLogger(
            EchoClientHandler.class.getName());

    private final ByteBuf firstMessage;

    /**
     * Creates a client-side handler.
     */
    public EchoClientHandler(int firstMessageSize) {
        if (firstMessageSize <= 0) {
            throw new IllegalArgumentException("firstMessageSize: " + firstMessageSize);
        }
        firstMessage = Unpooled.buffer(firstMessageSize);
        for (int i = 0; i < firstMessage.capacity(); i ++) {
            firstMessage.writeByte((byte) i);
        }
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx) {
        ctx.writeAndFlush(firstMessage);
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        ctx.write(msg);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {
       ctx.flush();
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        // Close the connection when an exception is raised.
        logger.log(Level.WARNING, "Unexpected exception from downstream.", cause);
        ctx.close();
    }
}
```

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Netty å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)