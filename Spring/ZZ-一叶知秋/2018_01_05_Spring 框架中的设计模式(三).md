title: Spring æ¡†æ¶ä¸­çš„è®¾è®¡æ¨¡å¼(ä¸‰)
date: 2018-01-05
tag: 
categories: Spring
permalink: Spring/DesignPattern-3
author: ä¸€å¶çŸ¥ç§‹
from_url: https://muyinchen.github.io/2017/07/28/Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F(%E4%B8%89)/
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://muyinchen.github.io/2017/07/28/Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F(%E4%B8%89)/ ã€Œä¸€å¶çŸ¥ç§‹ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [åŸå‹æ¨¡å¼](http://www.iocoder.cn/Spring/DesignPattern-3/)
- [å¯¹è±¡æ± ](http://www.iocoder.cn/Spring/DesignPattern-3/)
- [è§‚å¯Ÿè€…](http://www.iocoder.cn/Spring/DesignPattern-3/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> åœ¨ä¹‹å‰çš„ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸€äº›åœ¨Springæ¡†æ¶ä¸­å®ç°çš„è®¾è®¡æ¨¡å¼ã€‚è¿™ä¸€æ¬¡æˆ‘ä»¬ä¼šå‘ç°è¿™ä¸ªæµè¡Œæ¡†æ¶ä½¿ç”¨çš„3ç§æ–°æ¨¡å¼ã€‚
> æœ¬æ–‡å°†ä»æè¿°ä¸¤ä¸ªåˆ›æ„è®¾è®¡æ¨¡å¼å¼€å§‹ï¼šåŸå‹å’Œå¯¹è±¡æ± ã€‚æœ€åæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨è¡Œä¸ºæ¨¡å¼â€”>è§‚å¯Ÿè€…ã€‚

## åŸå‹æ¨¡å¼

è¿™ç¯‡æ–‡ç« çš„ç¬¬ä¸€ä¸ªè®¾è®¡æ¨¡å¼æ˜¯**åŸå‹**ã€‚å¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£æŸ¥æ‰¾æœ‰å…³Springä½œç”¨åŸŸä¸­çš„beanä½œç”¨åŸŸçš„æ–‡ç« ä¸­ä»‹ç»äº†ç±»ä¼¼çš„æ¦‚å¿µ(**prototype**)ã€‚åŸå‹è®¾è®¡æ¨¡å¼ä¸æœ‰ç”¨ç›¸åŒåç§°çš„(**prototype**)ä½œç”¨åŸŸæœ‰ç‚¹ç›¸ä¼¼ã€‚æ­¤è®¾è®¡æ¨¡å¼å…è®¸é€šè¿‡å¤åˆ¶å·²å­˜åœ¨çš„å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ã€‚å‰¯æœ¬åº”è¯¥æ˜¯**çœŸæ­£çš„å‰¯æœ¬**ã€‚è¿™æ„å‘³ç€æ–°å¯¹è±¡çš„æ‰€æœ‰å±æ€§åº”ä¸å¤åˆ¶å¯¹è±¡çš„å±æ€§ç›¸åŒã€‚å¦‚æœä¸æ¸…æ¥šï¼Œæ¯”ä¸€ä¸ªç®€å•çš„`JUnit`æ¡ˆä¾‹æ›´å¥½çš„è¯´æ˜ï¼š

```Java
public class PrototypeTest {

  @Test
  public void test() {
    Robot firstRobot = new Robot("Droid#1");
    Robot secondRobot = (Robot) firstRobot.clone();
    assertTrue("Cloned robot's instance can't be the same as the"
      +" source robot instance",
      firstRobot != secondRobot);
    assertTrue("Cloned robot's name should be '"+firstRobot.getName()+"'"
      +" but was '"+secondRobot.getName()+"'",
      secondRobot.getName().equals(firstRobot.getName()));
  }

}


class Robot implements Cloneable {
  private String name;

  public Robot(String name) {
    this.name = name;
  }

  public String getName() {
    return this.name;
  }

  protected Object clone() throws CloneNotSupportedException {
    return super.clone();
  }
}
```

åœ¨`Spring`ä¸­ï¼Œåœ¨**org.springframework.beans.factory.support.AbstractBeanFactory**ä¸­ä½¿ç”¨ä¸€ç§ç‰¹å®šçš„åŸå‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒå°†åˆå§‹åŒ–`beanåŸå‹ä½œç”¨åŸŸ`ã€‚æ–°å¯¹è±¡åŸºäºé…ç½®æ–‡ä»¶ä¸­çš„beanå®šä¹‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç»™å®šçš„ä¾‹å­ä¸­ï¼š

```XML
<bean id="shoppingCart" class="com.migo.data.ShoppingCart" scope="prototype">
  <property name="id" value="9"></property>
</bean>
```

```Java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations={"applicationContext-test.xml"})
public class SpringPrototypeTest {

  @Autowired
  private BeanFactory beanFactory;

  @Test
  public void test() {
    ShoppingCart cart1 = (ShoppingCart) beanFactory.getBean("shoppingCart");
    assertTrue("Id of cart1 should be 9 but was "+cart1.getId(),
      cart1.getId() == 9);
    cart1.setId(100);
    ShoppingCart cart2 = (ShoppingCart) beanFactory.getBean("shoppingCart");
    assertTrue("Id of cart2 should be 9 but was "+cart2.getId(),
      cart2.getId() == 9);
    assertTrue("Id of second cart ("+cart2.getId()+") shouldn't be the same as the first one: "+cart1.getId(),
      cart1.getId() != cart2.getId());
    cart2.setId(cart1.getId());
    assertTrue("Now (after cart2.setId(cart1.getId())), the id of second cart ("+cart2.getId()+") should be the same as the first one: "
      +cart1.getId(), cart1.getId() == cart2.getId());
    assertTrue("Both instance shouldn't be the same", cart1 != cart2);
  }

}
```

ä»å‰é¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œ`ShoppingCart`å®ä¾‹æ˜¯ç›´æ¥ä»beanå®šä¹‰åˆ›å»ºçš„ã€‚æœ€åˆï¼Œ`cart1`å’Œ`cart2`å¯¹è±¡çš„`id`å€¼ä¸º`9`.å®ƒåœ¨æµ‹è¯•ç»“æŸæ—¶è¢«ä¿®æ”¹ï¼Œä»¥è¯æ˜ä¸¤ä¸ªå¼•ç”¨éƒ½å±äºä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ã€‚

## å¯¹è±¡æ± 

`Spring`ä¸­ä½¿ç”¨çš„å¦ä¸€ä¸ªæ¨¡å‹æ˜¯**å¯¹è±¡æ± è®¾è®¡æ¨¡å¼**ã€‚å…¶ä¸»è¦ç›®çš„åœ¨äºåœ¨ä¸€ä¸ªæ± ä¸­ä¿å­˜ç‰¹å®šæ•°é‡çš„å¯¹è±¡ï¼Œå¹¶æ ¹æ®éœ€è¦é‡æ–°ä½¿ç”¨ã€‚é€šè¿‡å®ƒï¼Œæˆ‘ä»¬å¯ä»¥æ”¹å–„æˆ‘ä»¬æƒ³è¦ä½¿ç”¨`å·¨å‹å¯¹è±¡`çš„å“åº”æ—¶é—´ã€‚`å·¨å‹`æ„å‘³ç€è¿™äº›å¯¹è±¡çš„æ„é€ éœ€è¦å¾ˆå¤šæ—¶é—´ï¼ˆä¾‹å¦‚ï¼šæŒæœ‰æ•°æ®åº“è¿æ¥çš„å¯¹è±¡ï¼‰ï¼Œæœ€å¥½é‡ç”¨å·²ç»å­˜åœ¨çš„å’Œæœªè·å–çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°å¯¹è±¡ã€‚

Springè¿˜ä½¿ç”¨çº¿ç¨‹æ± æ¥ç®¡ç†å…¶è°ƒåº¦éƒ¨åˆ†ã€‚ä¸€äº›ç¤ºä¾‹ä½äº**org.springframework.scheduling.concurrentä¸­**ã€‚æˆ‘ä»¬æ£€ç´¢æ•°æ®åº“ï¼ˆ`Spring JDBC`ï¼‰é¡¹ç›®ä¸­çš„å¯¹è±¡æ± çš„æƒ³æ³•ã€‚æ•°æ®åº“è¿æ¥æ± ä¸æ˜¯ç”±`Spring`ç›´æ¥å®ç°çš„ï¼Œè€Œæ˜¯é€‚ç”¨äº`Spring`å·¥ä½œæ–¹å¼çš„é¡¹ç›®ï¼Œå¦‚`C3P0`æˆ–`Jakarta Commons DBCP`è¿æ¥æ± ã€‚

## è§‚å¯Ÿè€…

è¿™é‡Œå‘ˆç°çš„æœ€åä¸€ä¸ªè®¾è®¡æ¨¡å¼æ˜¯**è§‚å¯Ÿè€…**ã€‚å½“ä¸€ä¸ªæˆ–å‡ ä¸ªè¯¾ç¨‹æ­£åœ¨ç­‰å¾…å…·ä½“äº‹ä»¶æ—¶å¯ä»¥ä½¿ç”¨å®ƒã€‚è§‚å¯Ÿè€…æ¨¡å¼ç”±ä¸€ä¸ªç§‘ç›®å’Œè§‚å¯Ÿå‘˜åå•ç»„æˆã€‚ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­å°±æ˜¯`GUIç•Œé¢`ï¼Œå…¶ä¸­ç‚¹å‡»æŒ‰é’®ï¼ˆæŒ‰é’®æ˜¯ä¸»é¢˜ï¼‰ä¼šå¼•èµ·å¬ä¼—ï¼ˆè§‚å¯Ÿè€…ï¼‰å¯åŠ¨çš„ä¸€äº›æ“ä½œ(å†è¯´çš„ç›´ç™½ç‚¹å°±æ˜¯ç”µå½±é™¢ä¸€åœºç”µå½±è¿™ä¸ª`subject`,éœ€è¦`è§‚ä¼—`(ä¹Ÿå°±æ˜¯è§‚å¯Ÿè€…å’¯),ç”µå½±äº§ç”Ÿçš„ä¸€äº›ç”»é¢äº§ç”Ÿçš„äº‹ä»¶ï¼Œæ¯”å¦‚ææ€– ç”µå½±ç»™ç”·äººå¥³äººå¸¦æ¥çš„ä¸åŒçš„æ„Ÿå®˜çš„æ„Ÿå—ï¼Œä¼ æ’­åˆ°è§‚å¯Ÿè€…ä¹Ÿå°±æ˜¯è§‚ä¼—çš„çœ¼é‡Œæ‰€å¸¦æ¥çš„ä¸ä¸€æ ·çš„ååº”ï¼Œè¿™ä¸ªä¸­é—´ä¸€èˆ¬ä¼šæ·»åŠ ä¸€ä¸ª`äº‹ä»¶ä¼ æ’­è€…`ï¼Œåœ¨åé¢è§£é‡Š`Spring`çš„ä¾‹å­çš„æ—¶å€™ä¼šè¯´åˆ°)ï¼Œä¾‹å¦‚ï¼šæ‰“å¼€ä¸€ä¸ªæ–°é¡µé¢è¿™ä¸ªåŠ¨ä½œã€‚å¯ä»¥å‚è€ƒä¸‹é¢çš„ä¾‹å­ï¼š

```Java
public class ObserverTest {

  @Test
  public void test() {
    Observer pageOpener = new PageOpener();
    Observer register = new Register();
    Button btn = new Button();
    btn.addListener(pageOpener);
    btn.addListener(register);
    btn.clickOn();
    assertTrue("Button should be clicked but it wasn't",
      btn.wasClicked());
    assertTrue("Page opener should be informed about click but it wasn't",
      pageOpener.wasInformed());
    assertTrue("Register should be informed about click but it wasn't",
      register.wasInformed());
  }

}

class Button {

  private boolean clicked;
  private List<observer> listeners;

  public List<observer> getListeners() {
    if (this.listeners == null) {
      this.listeners = new ArrayList<observer>();
    }
    return this.listeners;
  }

  public void addListener(Observer observer) {
    getListeners().add(observer);
  }

  public boolean wasClicked() {
    return this.clicked;
  }

  public void clickOn() {
    this.clicked = true;
    informAll();
  }

  private void informAll() {
    for (Observer observer : getListeners()) {
      observer.informAboutEvent();
    }
  }

}

abstract class Observer {
  protected boolean informed;

  public void informAboutEvent() {
    this.informed = true;
  }

  public boolean wasInformed() {
    return this.informed;
  }
}

class PageOpener extends Observer {

  @Override
  public void informAboutEvent() {
    System.out.println("Preparing download of new page");
    super.informAboutEvent();
  }

}

class Register extends Observer {

  @Override
  public void informAboutEvent() {
    System.out.println("Adding the action to register");
    super.informAboutEvent();
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå…³äºæˆ‘ä»¬çš„`Button`å®ä¾‹ç‚¹å‡»çš„äº‹ä»¶è¢«å‘é€åˆ°æ‰€æœ‰çš„è§‚å¯Ÿè€…å¯¹è±¡ã€‚ä»è¿™äº›å¯¹è±¡å¼€å§‹ä¸‹è½½é¡µé¢å†…å®¹ï¼Œç¬¬äºŒä¸ªå°†åœ¨äº‹ä»¶çš„ä¿¡æ¯ä¿å­˜åœ¨æ³¨å†Œè¡¨ä¸­ã€‚åœ¨`Spring`ä¸­ï¼Œè§‚å¯Ÿè€…è®¾è®¡æ¨¡å¼ç”¨äºå°†ä¸åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ç›¸å…³çš„äº‹ä»¶ä¼ è¾“åˆ°**org.springframework.context.ApplicationListenerçš„å®ç°**ã€‚è¦äº†è§£å®ƒä»¬çš„å®ç°æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`AbstractApplicationContext`ç±»(è€ç‰ˆæœ¬çš„ä»£ç ï¼Œæ–°ç‰ˆæœ¬çš„è¯·è‡ªè¡Œå¯¹ç…§)ï¼š

```java
public abstract class AbstractApplicationContext extends DefaultResourceLoader
  implements ConfigurableApplicationContext, DisposableBean {
  /** Statically specified listeners */
  private Set<applicationlistener<?>> applicationListeners = new LinkedHashSet<applicationlistener<?>>();

  // some other fields and methods
  @Override
  public void addApplicationListener(ApplicationListener<?> listener) {
    if (this.applicationEventMulticaster != null) {
      this.applicationEventMulticaster.addApplicationListener(listener);
    }
    else {//æ–°ç‰ˆæœ¬è¿™é‡Œç›´æ¥å’”åš“æ‰ï¼Œä¸Šé¢çš„applicationEventMulticasterä¸€æ—¦ä¸ºç©ºï¼Œå°±ä¼šæŠ¥é”™çš„
      this.applicationListeners.add(listener);
    }
  }

  /**
    * Return the list of statically specified ApplicationListeners.
    */
  public Collection<applicationlistener<?>> getApplicationListeners() {
    return this.applicationListeners;
  }

  /**
    * Add beans that implement ApplicationListener as listeners.
    * Doesn't affect other listeners, which can be added without being beans.
    */
  protected void registerListeners() {
    // Register statically specified listeners first.
    for (ApplicationListener<?> listener : getApplicationListeners()) {
      getApplicationEventMulticaster().addApplicationListener(listener);
    }
    // Do not initialize FactoryBeans here: We need to leave all regular beans
    // uninitialized to let post-processors apply to them!
    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false);
    for (String lisName : listenerBeanNames) {
      getApplicationEventMulticaster().addApplicationListenerBean(lisName);
    }
  }
}
```

åœ¨æä¾›çš„ä»£ç ä¸­ï¼Œç›‘å¬å™¨åœ¨å†…éƒ¨æ·»åŠ åˆ°åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ç±»ä¸­ï¼Œå¹¶ä¸”åœ¨`registerListeners()`æ–¹æ³•ä¹‹åï¼Œå®ƒä»¬è¢«æ³¨å†Œåˆ°ç”±æ¥å£**org.springframework.context.event.ApplicationEventMulticaster**è¡¨ç¤ºçš„é€‚å½“çš„äº‹ä»¶å¤šè·¯å¹¿æ’­å™¨(å› ä¸ºæœ‰å¾ˆå¤šlisteners)ã€‚`EventMulticaster`è´Ÿè´£ç®¡ç†ä¸åŒçš„`listener`å’Œå‘ä»–ä»¬å‘å¸ƒäº‹ä»¶ã€‚

```java
public class SimpleApplicationEventMulticaster extends AbstractApplicationEventMulticaster {
    private Executor taskExecutor;
    private ErrorHandler errorHandler;

    public SimpleApplicationEventMulticaster() {
    }

    public SimpleApplicationEventMulticaster(BeanFactory beanFactory) {
        this.setBeanFactory(beanFactory);
    }

    public void setTaskExecutor(Executor taskExecutor) {
        this.taskExecutor = taskExecutor;
    }

    protected Executor getTaskExecutor() {
        return this.taskExecutor;
    }

    public void setErrorHandler(ErrorHandler errorHandler) {
        this.errorHandler = errorHandler;
    }

    protected ErrorHandler getErrorHandler() {
        return this.errorHandler;
    }

    public void multicastEvent(ApplicationEvent event) {
        this.multicastEvent(event, this.resolveDefaultEventType(event));
    }
	//å‘å¸ƒäº‹ä»¶:é€šè¿‡æ± æ‰§è¡Œä»»åŠ¡çš„æ–¹å¼æ¥åšå¹¶å‘å¤„ç†ï¼Œè¿™æ ·å°±æŠŠä¹‹å‰çš„å¯¹è±¡æ± æ¨¡å¼ç»™åˆ©ç”¨ä¸Šäº†
    public void multicastEvent(final ApplicationEvent event, ResolvableType eventType) {
        ResolvableType type = eventType != null?eventType:this.resolveDefaultEventType(event);
        Iterator var4 = this.getApplicationListeners(event, type).iterator();

        while(var4.hasNext()) {
            final ApplicationListener<?> listener = (ApplicationListener)var4.next();
            Executor executor = this.getTaskExecutor();
            if(executor != null) {
                executor.execute(new Runnable() {
                    public void run() {
                        SimpleApplicationEventMulticaster.this.invokeListener(listener, event);
                    }
                });
            } else {
                this.invokeListener(listener, event);
            }
        }

    }
...
}
```

è¿™æ¬¡æˆ‘ä»¬è®²3ç§è®¾è®¡æ¨¡å¼:ç”¨äºåœ¨åŒä¸€ä¸ªè°ƒç”¨ä½œç”¨åŸŸå†…åˆ›å»º`beançš„åŸå‹`ï¼Œé¿å…é‡æ–°åˆ›å»ºå·¨å‹å¯¹è±¡çš„å¯¹è±¡æ± ï¼Œä»¥åŠå°†åº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡äº‹ä»¶åˆ†æ´¾ç»™é€‚å½“çš„ç›‘å¬å™¨çš„è§‚å¯Ÿè€…ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Spring æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)