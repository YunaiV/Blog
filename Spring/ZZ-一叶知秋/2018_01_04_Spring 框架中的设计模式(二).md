title: Spring æ¡†æ¶ä¸­çš„è®¾è®¡æ¨¡å¼(äºŒ)
date: 2018-01-04
tag: 
categories: Spring
permalink: Spring/DesignPattern-2
author: ä¸€å¶çŸ¥ç§‹
from_url: https://muyinchen.github.io/2017/07/21/Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F(%E4%BA%8C)/
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://muyinchen.github.io/2017/07/21/Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F(%E4%BA%8C)/ ã€Œä¸€å¶çŸ¥ç§‹ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [ä»£ç†æ¨¡å¼](http://www.iocoder.cn/Spring/DesignPattern-2/)
- [å¤åˆæ¨¡å¼](http://www.iocoder.cn/Spring/DesignPattern-2/)
- [ç­–ç•¥æ¨¡å¼](http://www.iocoder.cn/Spring/DesignPattern-2/)
- [æ¨¡æ¿æ¨¡å¼](http://www.iocoder.cn/Spring/DesignPattern-2/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åœ¨ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬åœ¨Springä¸­æ‰€è°ˆåˆ°çš„è®¾è®¡æ¨¡å¼æ¶‰åŠåˆ°äº†åˆ›å»ºæ¨¡å¼ä¸‰å‰‘å®¢å’Œ1ä¸ªè¡Œä¸ºæ¨¡å¼(è§£é‡Šå™¨æ¨¡å¼)ã€‚è¿™æ¬¡æˆ‘ä»¬ä¼šå°†çœ¼å…‰æ›´å¤šåœ°å…³æ³¨åœ¨å…·æœ‰ç»“æ„æ€§å’Œè¡Œä¸ºæ€§çš„è®¾è®¡æ¨¡å¼ä¸Šã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°æ¯ä¸ªç±»å‹çš„ä¸¤ç§æ¨¡å¼ã€‚é¦–å…ˆå°†å…³æ³¨ç±»å‹æ˜¯çš„ç»“æ„è®¾è®¡æ¨¡å¼ã€‚å®ƒå°†åŒ…å«ä»£ç†å’Œå¤åˆã€‚ä¸‹ä¸€ä¸ªå°†ä»‹ç»è¡Œä¸ºæ¨¡å¼ï¼šç­–ç•¥å’Œæ¨¡æ¿æ–¹æ³•ã€‚

## ä»£ç†æ¨¡å¼

é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰å¯èƒ½æ˜¯ç¼–ç¨‹ä¸­æœ€æµè¡Œçš„æ¦‚å¿µã€‚ç„¶è€Œï¼ŒSpringå¼•å…¥äº†å¦ä¸€ç§ç¼–ç è§„èŒƒï¼Œ**é¢å‘åˆ‡é¢ç¼–ç¨‹**ï¼ˆAOPï¼‰ã€‚ä¸ºäº†ç®€åŒ–å®šä¹‰ï¼ŒAOPæ˜¯é¢å‘ç³»ç»Ÿç‰¹å®šç‚¹çš„ä¸€ç§ç¼–ç¨‹ï¼Œå¦‚ï¼šå¼‚å¸¸æŠ›å‡ºï¼Œç‰¹å®šç±»åˆ«æ–¹æ³•çš„æ‰§è¡Œç­‰.AOPå…è®¸åœ¨æ‰§è¡Œè¿™äº›ç‰¹å®šç‚¹ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œè¡¥å……åŠ¨ä½œã€‚å¦‚ä½•å®ç°è¿™ç§æ“ä½œï¼Ÿå®ƒå¯ä»¥é€šè¿‡ç›‘å¬å™¨(listeners)è¿›è¡Œã€‚ä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨åªè¦å¯èƒ½å­˜åœ¨è°ƒç”¨çš„åœ°æ–¹éƒ½éœ€è¦å®šä¹‰ç›‘å¬å™¨æ¥è¿›è¡Œç›‘å¬ï¼ˆæ¯”å¦‚åœ¨ä¸€ä¸ªæ–¹æ³•çš„å¼€å§‹çš„åœ°æ–¹ï¼‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆSpringä¸é‡‡ç”¨è¿™ä¸ªideaã€‚ç›¸åï¼ŒSpringå®ç°äº†ä¸€ç§èƒ½å¤Ÿé€šè¿‡é¢å¤–çš„æ–¹æ³•è°ƒç”¨å®Œæˆä»»åŠ¡çš„è®¾è®¡æ¨¡å¼ - **ä»£ç†è®¾è®¡æ¨¡å¼**ã€‚

ä»£ç†å°±åƒå¯¹è±¡çš„é•œåƒä¸€æ ·ã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œä»£ç†å¯¹è±¡ä¸ä»…å¯ä»¥è¦†ç›–çœŸå®å¯¹è±¡ï¼Œè¿˜å¯ä»¥æ‰©å±•å…¶åŠŸèƒ½ã€‚å› æ­¤ï¼Œå¯¹äºåªèƒ½åœ¨å±å¹•ä¸Šæ‰“å°ä¸€äº›æ–‡æœ¬çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ å¦ä¸€ä¸ªå¯¹è±¡æ¥è¿‡æ»¤æ˜¾ç¤ºå•è¯ã€‚å¯ä»¥é€šè¿‡ä»£ç†æ¥å®šä¹‰ç¬¬äºŒä¸ªå¯¹è±¡çš„è°ƒç”¨ã€‚ä»£ç†æ˜¯å°è£…çœŸå®å¯¹è±¡çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°è¯•è°ƒç”¨Waiter beanï¼Œé‚£ä¹ˆæ‚¨å°†è°ƒç”¨è¯¥Beançš„ä»£ç†ï¼Œå…¶è¡Œä¸ºæ–¹å¼å®Œå…¨ç›¸åŒã€‚

ä»£ç†è®¾è®¡æ¨¡å¼çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯**org.springframework.aop.framework.ProxyFactoryBean**ã€‚è¯¥å·¥å‚æ ¹æ®Spring beanæ„å»ºAOPä»£ç†ã€‚è¯¥ç±»å®ç°äº†å®šä¹‰**getObject()**æ–¹æ³•çš„`FactoryBean`æ¥å£ã€‚æ­¤æ–¹æ³•ç”¨äºå°†éœ€æ±‚`Bean`çš„å®ä¾‹è¿”å›ç»™`bean factory`ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¸æ˜¯è¿”å›çš„å®ä¾‹ï¼Œè€Œæ˜¯`AOPä»£ç†`ã€‚åœ¨æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•ä¹‹å‰ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨è¡¥å……æ–¹æ³•æ¥è¿›ä¸€æ­¥â€œä¿®é¥°â€ä»£ç†å¯¹è±¡(å…¶å®æ‰€è°“çš„é™æ€ä»£ç†ä¸è¿‡æ˜¯åœ¨è£…é¥°æ¨¡å¼ä¸ŠåŠ äº†ä¸ªè¦ä¸è¦ä½ æ¥å¹²åŠ¨ä½œè¡Œä¸ºè€Œå·²ï¼Œè€Œä¸æ˜¯è£…é¥°æ¨¡å¼ä»€ä¹ˆä¹Ÿä¸åšå°±åŠ äº†ä»¶è¡£æœï¼Œå…¶ä»–è¿˜å¾—ç”±ä½ æ¥å…¨æƒå®Œæˆ)ã€‚

`ProxyFactory`çš„ä¸€ä¸ªä¾‹å­æ˜¯ï¼š

```java
public class TestProxyAop {

  @Test
  public void test() {
    ProxyFactory factory = new ProxyFactory(new House());
    factory.addInterface(Construction.class);
    factory.addAdvice(new BeforeConstructAdvice());
    factory.setExposeProxy(true);

    Construction construction = (Construction) factory.getProxy();
    construction.construct();
    assertTrue("Construction is illegal. "
      + "Supervisor didn't give a permission to build "
      + "the house", construction.isPermitted());
  }

}

interface Construction {
  public void construct();
  public void givePermission();
  public boolean isPermitted();
}

class House implements Construction{

  private boolean permitted = false;

  @Override
  public boolean isPermitted() {
    return this.permitted;
  }

  @Override
  public void construct() {
    System.out.println("I'm constructing a house");
  }

  @Override
  public void givePermission() {
    System.out.println("Permission is given to construct a simple house");
    this.permitted = true;
  }
}

class BeforeConstructAdvice implements MethodBeforeAdvice {

  @Override
  public void before(Method method, Object[] arguments, Object target) throws Throwable {
    if (method.getName().equals("construct")) {
      ((Construction) target).givePermission();
    }
  }

}
```

è¿™ä¸ªæµ‹è¯•åº”è¯¥é€šè¿‡ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ç›´æ¥åœ¨Houseå®ä¾‹ä¸Šæ“ä½œï¼Œè€Œæ˜¯ä»£ç†å®ƒã€‚ä»£ç†è°ƒç”¨ç¬¬ä¸€ä¸ª`BeforeConstructAdvice`çš„`before`æ–¹æ³•ï¼ˆæŒ‡å‘åœ¨æ‰§è¡Œç›®æ ‡æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ä¸º`construct()`ï¼‰é€šè¿‡å®ƒï¼Œç»™å‡ºäº†ä¸€ä¸ªâ€œæƒé™â€æ¥æ„é€ å¯¹è±¡çš„å­—æ®µï¼ˆhouseï¼‰ã€‚ä»£ç†å±‚æä¾›äº†ä¸€ä¸ªé¢å¤–æ–°åŠŸèƒ½ï¼Œå› ä¸ºå®ƒå¯ä»¥ç®€å•åœ°åˆ†é…ç»™å¦ä¸€ä¸ªå¯¹è±¡ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªèƒ½åœ¨beforeæ–¹æ³•ä¹‹å‰ä¿®æ”¹è¿‡æ»¤å™¨ã€‚

## å¤åˆæ¨¡å¼

å¦ä¸€ç§ç»“æ„æ¨¡å¼æ˜¯**å¤åˆæ¨¡å¼**ã€‚åœ¨å…³äº[Springä¸­è®¾è®¡æ¨¡å¼](https://muyinchen.github.io/2017/07/20/Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F(%E4%B8%80))çš„ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ„å»ºå™¨æ¥æ„é€ å¤æ‚å¯¹è±¡ã€‚å¦ä¸€ç§å®ç°æ–¹æ³•æ˜¯ä½¿ç”¨å¤åˆæ¨¡å¼ã€‚è¿™ç§æ¨¡å¼æ˜¯åŸºäºå…·æœ‰å…±åŒè¡Œä¸ºçš„å¤šä¸ªå¯¹è±¡çš„å­˜åœ¨ï¼Œç”¨äºæ„å»ºæ›´å¤§çš„å¯¹è±¡ã€‚è¾ƒå¤§çš„å¯¹è±¡ä»ç„¶å…·æœ‰ä¸æœ€å°å¯¹è±¡ç›¸åŒçš„ç‰¹å¾ã€‚é‚£ä¹ˆç”¨å®ƒæ¥å®šä¹‰ç›¸åŒçš„è¡Œä¸ºã€‚

å¤åˆå¯¹è±¡çš„éSpringç¤ºä¾‹å¯ä»¥æ˜¯ä¸€ä¸ªå†™å…¥HTMLçš„æ–‡æœ¬å¯¹è±¡ï¼Œç”±åŒ…å«spanæˆ–emæ ‡ç­¾çš„æ®µè½ç»„æˆï¼š

```Java
public class CompositeTest {

  @Test
  public void test() {
    TextTagComposite composite = new PTag();
    composite.addTag(new SpanTag());
    composite.addTag(new EmTag());

    // sample client code
    composite.startWrite();
    for (TextTag leaf : composite.getTags()) {
      leaf.startWrite();
      leaf.endWrite();
    }
    composite.endWrite();
    assertTrue("Composite should contain 2 tags but it contains "+composite.getTags().size(), composite.getTags().size() == 2);
  }

}


interface TextTag {
  public void startWrite();
  public void endWrite();
}

interface TextTagComposite extends TextTag {
  public List<TextTag> getTags();
  public void addTag(TextTag tag);
}

class PTag implements TextTagComposite {
  private List<TextTag> tags = new ArrayList<TextTag>();

  @Override
  public void startWrite() {
    System.out.println("<p>");
  }

  @Override
  public void endWrite() {
    System.out.println("</p>");
  }

  @Override
  public List<TextTag> getTags() {
    return tags;
  }

  @Override
  public void addTag(TextTag tag) {
    tags.add(tag);
  }
}

class SpanTag implements TextTag {

  @Override
  public void startWrite() {
    System.out.println("<span>");
  }

  @Override
  public void endWrite() {
    System.out.println("</span>");
  }

}

class EmTag implements TextTag {

  @Override
  public void startWrite() {
    System.out.println("<em>");
  }

  @Override
  public void endWrite() {
    System.out.println("</em>");
  }

}
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¤åˆå¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥åŒºåˆ†å¤åˆä¸éå¤åˆå¯¹è±¡ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå¯ä»¥å®¹çº³ä¸€ä¸ªæˆ–å¤šä¸ªéå¤åˆå¯¹è±¡ï¼ˆ`PTag`ç±»ä¸­çš„`private List tags`å­—æ®µï¼‰ã€‚éå¤åˆå¯¹è±¡ç§°ä¸ºå¶å­ã€‚`TextTag`æ¥å£è¢«ç§°ä¸ºç»„ä»¶ï¼Œå› ä¸ºå®ƒä¸ºä¸¤ä¸ªå¯¹è±¡ç±»å‹æä¾›äº†å…±åŒçš„è¡Œä¸ºè§„èŒƒ(æœ‰ç‚¹åƒ`Linux`æ–‡ä»¶ç®¡ç†ç³»ç»Ÿçš„æœ‰å…±åŒç‚¹çš„æ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹è¿›è¡Œç®¡ç†ï¼Œå…¶å®å°±æ˜¯èŠ‚ç‚¹ç®¡ç†)ã€‚

åœ¨`Spring`ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬æ£€ç´¢å¤åˆå¯¹è±¡çš„æ¦‚å¿µæ˜¯**org.springframework.beans.BeanMetadataElement**æ¥å£ï¼Œç”¨äºé…ç½®`bean`å¯¹è±¡ã€‚å®ƒæ˜¯æ‰€æœ‰ç»§æ‰¿å¯¹è±¡çš„åŸºæœ¬ç•Œé¢ã€‚ç°åœ¨ï¼Œåœ¨ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¶å­ï¼Œç”±**org.springframework.beans.factory.parsing.BeanComponentDefinition**è¡¨ç¤ºï¼Œå¦ä¸€è¾¹æ˜¯å¤åˆ**org.springframework.beans.factory.parsing.CompositeComponentDefinition**ã€‚`CompositeComponentDefinition`ç±»ä¼¼äºç»„ä»¶ï¼Œå› ä¸ºå®ƒåŒ…å«**addNestedComponentï¼ˆComponentDefinition componentï¼‰**æ–¹æ³•ï¼Œå®ƒå…è®¸å°†å¶æ·»åŠ åˆ°ç§æœ‰finalåˆ—è¡¨ä¸­`nestedComponents`ã€‚æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œç”±äºæ­¤åˆ—è¡¨ï¼Œ`BeanComponentDefinition`å’Œ`CompositeComponentDefinition`çš„ç»„ä»¶æ˜¯**org.springframework.beans.factory.parsing.ComponentDefinition**ã€‚

[![img](https://pic2.zhimg.com/80/v2-d48ac32165e185263a7fb673e1da97f5_hd.png)](https://pic2.zhimg.com/80/v2-d48ac32165e185263a7fb673e1da97f5_hd.png)

## ç­–ç•¥æ¨¡å¼

æœ¬æ–‡æè¿°çš„ç¬¬ä¸‰ä¸ªæ¦‚å¿µæ˜¯**ç­–ç•¥è®¾è®¡æ¨¡å¼**ã€‚ç­–ç•¥å®šä¹‰äº†é€šè¿‡ä¸åŒæ–¹å¼å®Œæˆç›¸åŒäº‹æƒ…çš„å‡ ä¸ªå¯¹è±¡ã€‚å®Œæˆä»»åŠ¡çš„æ–¹å¼å–å†³äºé‡‡ç”¨çš„ç­–ç•¥ã€‚ä¸¾ä¸ªä¾‹å­è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥å»ä¸€ä¸ªå›½å®¶ã€‚æˆ‘ä»¬å¯ä»¥ä¹˜å…¬å…±æ±½è½¦ï¼Œé£æœºï¼Œèˆ¹ç”šè‡³æ±½è½¦å»é‚£é‡Œã€‚æ‰€æœ‰è¿™äº›æ–¹æ³•å°†æŠŠæˆ‘ä»¬è¿é€åˆ°ç›®çš„åœ°å›½å®¶ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ£€æŸ¥æˆ‘ä»¬çš„é“¶è¡Œå¸æˆ·æ¥é€‰æ‹©æœ€é€‚åº”çš„æ–¹å¼ã€‚å¦‚æœæˆ‘ä»¬æœ‰å¾ˆå¤šé’±ï¼Œæˆ‘ä»¬å°†é‡‡å–æœ€å¿«çš„æ–¹å¼ï¼ˆå¯èƒ½æ˜¯ç§äººé£è¡Œï¼‰ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰è¶³å¤Ÿçš„è¯ï¼Œæˆ‘ä»¬ä¼šé‡‡å–æœ€æ…¢çš„ï¼ˆå…¬è½¦ï¼Œæ±½è½¦ï¼‰ã€‚è¯¥é“¶è¡Œè´¦æˆ·ä½œä¸ºç¡®å®šé€‚åº”ç­–ç•¥çš„å› ç´ ã€‚

Springåœ¨**org.springframework.web.servlet.mvc.multiaction.MethodNameResolver**ç±»(è¿‡æ—¶ï¼Œä½†ä¸å½±å“æ‹¿æ¥ç ”ç©¶)ä¸­ä½¿ç”¨ç­–ç•¥è®¾è®¡æ¨¡å¼ã€‚å®ƒæ˜¯`MultiActionController`(åŒæ ·è¿‡æ—¶)çš„å‚æ•°åŒ–å®ç°ã€‚åœ¨å¼€å§‹è§£é‡Šç­–ç•¥ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£MultiActionControllerçš„å®ç”¨æ€§ã€‚è¿™ä¸ªç±»å…è®¸åŒä¸€ä¸ªç±»å¤„ç†å‡ ç§ç±»å‹çš„è¯·æ±‚ã€‚ä½œä¸ºSpringä¸­çš„æ¯ä¸ªæ§åˆ¶å™¨ï¼ŒMultiActionControlleræ‰§è¡Œæ–¹æ³•æ¥å“åº”æä¾›çš„è¯·æ±‚ã€‚ç­–ç•¥ç”¨äºæ£€æµ‹åº”ä½¿ç”¨å“ªç§æ–¹æ³•ã€‚è§£æè¿‡ç¨‹åœ¨MethodNameResolverå®ç°ä¸­å®ç°ï¼Œä¾‹å¦‚åœ¨åŒä¸€ä¸ªåŒ…ä¸­çš„**ParameterMethodNameResolverä¸­**ã€‚æ–¹æ³•å¯ä»¥é€šè¿‡å¤šä¸ªæ¡ä»¶è§£å†³ï¼šå±æ€§æ˜ å°„ï¼ŒHTTPè¯·æ±‚å‚æ•°æˆ–URLè·¯å¾„ã€‚

```java
@Override
public String getHandlerMethodName(HttpServletRequest request) throws NoSuchRequestHandlingMethodException {
  String methodName = null;

  // Check parameter names where the very existence of each parameter
  // means that a method of the same name should be invoked, if any.
  if (this.methodParamNames != null) {
    for (String candidate : this.methodParamNames) {
      if (WebUtils.hasSubmitParameter(request, candidate)) {
        methodName = candidate;
        if (logger.isDebugEnabled()) {
          logger.debug("Determined handler method '" + methodName +
            "' based on existence of explicit request parameter of same name");
        }
        break;
      }
    }
  }

  // Check parameter whose value identifies the method to invoke, if any.
  if (methodName == null && this.paramName != null) {
    methodName = request.getParameter(this.paramName);
    if (methodName != null) {
      if (logger.isDebugEnabled()) {
        logger.debug("Determined handler method '" + methodName +
          "' based on value of request parameter '" + this.paramName + "'");
      }
    }
  }

  if (methodName != null && this.logicalMappings != null) {
    // Resolve logical name into real method name, if appropriate.
    String originalName = methodName;
    methodName = this.logicalMappings.getProperty(methodName, methodName);
    if (logger.isDebugEnabled()) {
      logger.debug("Resolved method name '" + originalName + "' to handler method '" + methodName + "'");
    }
  }

  if (methodName != null && !StringUtils.hasText(methodName)) {
    if (logger.isDebugEnabled()) {
      logger.debug("Method name '" + methodName + "' is empty: treating it as no method name found");
    }
    methodName = null;
  }

  if (methodName == null) {
    if (this.defaultMethodName != null) {
      // No specific method resolved: use default method.
      methodName = this.defaultMethodName;
      if (logger.isDebugEnabled()) {
        logger.debug("Falling back to default handler method '" + this.defaultMethodName + "'");
      }
    }
    else {
      // If resolution failed completely, throw an exception.
      throw new NoSuchRequestHandlingMethodException(request);
    }
  }

  return methodName;
}
```

æ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°çš„ï¼Œæ–¹æ³•çš„åç§°é€šè¿‡æä¾›çš„å‚æ•°æ˜ å°„ï¼ŒURLä¸­çš„é¢„å®šä¹‰å±æ€§æˆ–å‚æ•°å­˜åœ¨æ¥è§£å†³ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‚æ•°çš„åç§°æ˜¯actionï¼‰ã€‚

## æ¨¡æ¿æ¨¡å¼

æœ¬æ–‡æå‡ºçš„æœ€åä¸€ä¸ªè®¾è®¡æ¨¡å¼æ˜¯**æ¨¡æ¿æ–¹æ³•**ã€‚æ­¤æ¨¡å¼å®šä¹‰äº†ç±»è¡Œä¸ºçš„éª¨æ¶ï¼Œå¹¶å°†å­æ­¥éª¤çš„æŸäº›æ­¥éª¤çš„å»¶è¿Ÿæ‰§è¡Œ(å…·ä½“å°±æ˜¯ä¸‹é¢ä¾‹å­ä¸­ä¸€ä¸ªæ–¹æ³•æ”¾åœ¨å¦ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œåªæœ‰è°ƒç”¨å¦ä¸€æ–¹æ–¹æ³•çš„æ—¶å€™è¿™ä¸ªæ–¹æ³•æ‰ä¼šæ‰§è¡Œ,è€Œä¸”è¿˜å¯èƒ½ä¼šåœ¨å…¶ä»–è¡Œä¸ºæ–¹æ³•ä¹‹åæŒ‰é¡ºåºæ‰§è¡Œ)ã€‚å…¶ä¸­å†™äº†ä¸€ç§æ–¹æ³•(ä¸‹é¢ä¾‹å­ä¸­çš„construct())ï¼Œæ³¨æ„å®šä¹‰ä¸ºfinalï¼Œèµ·ç€åŒæ­¥å™¨çš„è§’è‰²ã€‚å®ƒä»¥ç»™å®šçš„é¡ºåºæ‰§è¡Œç”±å­ç±»å®šä¹‰çš„æ–¹æ³•ã€‚åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¨¡æ¿æ–¹æ³•ä¸æˆ¿å±‹å»ºè®¾è¿›è¡Œæ¯”è¾ƒã€‚ç‹¬ç«‹äºå»ºé€ æˆ¿å±‹çš„å…¬å¸ï¼Œæˆ‘ä»¬éœ€è¦ä»å»ºç«‹åŸºç¡€å¼€å§‹ï¼Œåªæœ‰åœ¨æˆ‘ä»¬å®Œæˆä¹‹åæ‰èƒ½åšå…¶ä»–çš„å·¥ä½œã€‚è¿™ä¸ªæ‰§è¡Œé€»è¾‘å°†è¢«ä¿å­˜åœ¨ä¸€ä¸ªæˆ‘ä»¬ä¸èƒ½æ”¹å˜çš„æ–¹æ³•ä¸­ã€‚ä¾‹å¦‚åŸºç¡€å»ºè®¾æˆ–åˆ·å¢™ä¼šè¢«ä½œä¸ºä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ä¸­çš„æ–¹æ³•ï¼Œå…·ä½“åˆ°å»ºç­‘æˆ¿å±‹çš„å…¬å¸ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç»™å®šçš„ä¾‹å­ä¸­çœ‹åˆ°å®ƒï¼š

```java
public class TemplateMethod {

  public static void main(String[] args) {
    HouseAbstract house = new SeaHouse();
    house.construct();
  }

}

abstract class HouseAbstract {
  protected abstract void constructFoundations();
  protected abstract void constructWall();

  // template method
  public final void construct() {
    constructFoundations();
    constructWall();
  }
}

class EcologicalHouse extends HouseAbstract {

  @Override
  protected void constructFoundations() {
    System.out.println("Making foundations with wood");
  }

  @Override
  protected void constructWall() {
    System.out.println("Making wall with wood");
  }

}

class SeaHouse extends HouseAbstract {

  @Override
  protected void constructFoundations() {
    System.out.println("Constructing very strong foundations");
  }

  @Override
  protected void constructWall() {
    System.out.println("Constructing very strong wall");
  }

}
```

è¯¥ä»£ç åº”è¯¥è¾“å‡ºï¼š

```java
Constructing very strong foundations
Constructing very strong wall
```

Springåœ¨**org.springframework.context.support.AbstractApplicationContext**ç±»ä¸­ä½¿ç”¨æ¨¡æ¿æ–¹æ³•ã€‚ä»–ä»¬ä¸æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯construct ï¼‰ï¼Œè€Œæ˜¯å¤šä¸ªã€‚ä¾‹å¦‚ï¼Œ**getsFreshBeanFactory**è¿”å›å†…éƒ¨`beanå·¥å‚`çš„æ–°ç‰ˆæœ¬ï¼Œè°ƒç”¨ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼š`refreshBeanFactory`ï¼ˆåˆ·æ–°å·¥å‚beanï¼‰å’Œ`getBeanFactory`ï¼ˆä»¥è·å–æ›´æ–°çš„å·¥å‚beanï¼‰ã€‚è¿™ä¸ªæ–¹æ³•å’Œå…¶ä»–ä¸€äº›æ–¹æ³•ä¸€æ ·ï¼Œç”¨åœ¨**public void refresh()**ä¸­ï¼ŒæŠ›å‡º**æ„é€ åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡çš„BeansExceptionï¼ŒIllegalStateException**æ–¹æ³•(è¿™é‡Œä¼šåœ¨åé¢Springä¸­ä¸åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡åˆ†æä¸­å†æ¬¡æåˆ°)ã€‚

æˆ‘ä»¬å¯ä»¥ä»åŒä¸€ä¸ªåŒ…ä¸­çš„GenericApplicationContextæ‰¾åˆ°ä¸€äº›é€šè¿‡æ¨¡æ¿æ–¹æ³•æ‰€å®ç°çš„æŠ½è±¡æ–¹æ³•çš„å®ç°çš„ä¾‹å­(è¯´çš„æœ‰ç‚¹æ‹—å£ï¼Œå¤šè¯»å‡ éå°±å¥½):

```java
/**
  * Do nothing: We hold a single internal BeanFactory and rely on callers
  * to register beans through our public methods (or the BeanFactory's).
  * @see #registerBeanDefinition
  */
@Override
protected final void refreshBeanFactory() throws IllegalStateException {
  if (this.refreshed) {
    throw new IllegalStateException(
      "GenericApplicationContext does not support multiple refresh attempts: just call 'refresh' once");
  }
  this.beanFactory.setSerializationId(getId());
  this.refreshed = true;
}

@Override
protected void cancelRefresh(BeansException ex) {
  this.beanFactory.setSerializationId(null);
  super.cancelRefresh(ex);
}

/**
  * Not much to do: We hold a single internal BeanFactory that will never
  * get released.
  */
@Override
protected final void closeBeanFactory() {
  this.beanFactory.setSerializationId(null);
}

/**
  * Return the single internal BeanFactory held by this context
  * (as ConfigurableListableBeanFactory).
  */
@Override
public final ConfigurableListableBeanFactory getBeanFactory() {
  return this.beanFactory;
}

/**
  * Return the underlying bean factory of this context,
  * available for registering bean definitions.
  * <p><b>NOTE:</b> You need to call {@link #refresh()} to initialize the
  * bean factory and its contained beans with application context semantics
  * (autodetecting BeanFactoryPostProcessors, etc).
  * @return the internal bean factory (as DefaultListableBeanFactory)
  */
public final DefaultListableBeanFactory getDefaultListableBeanFactory() {
  return this.beanFactory;
}
```

ç»è¿‡ä¸Šé¢è¿™äº›å¯ä»¥è®©æˆ‘ä»¬å‘ç°Springå¦‚ä½•é€šè¿‡ä½¿ç”¨è¡Œä¸ºå’Œç»“æ„è®¾è®¡æ¨¡å¼æ¥æ›´å¥½åœ°ç»„ç»‡ä¸Šä¸‹æ–‡ï¼ˆ**æ¨¡æ¿æ–¹æ³•**ï¼‰ï¼Œå¹¶é€šè¿‡ç›¸åº”**ç­–ç•¥**æ¥è§£å†³æ‰§è¡Œæ–¹æ³•ã€‚å®ƒä½¿ç”¨ä¸¤ç§ç»“æ„è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡**ä»£ç†æ¨¡å¼**æ¥ç®€åŒ–AOPéƒ¨åˆ†å¹¶é€šè¿‡**å¤åˆæ¨¡å¼**æ¥æ„é€ å¤æ‚å¯¹è±¡ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Spring æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)