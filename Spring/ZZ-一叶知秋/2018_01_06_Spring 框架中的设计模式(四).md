title: Spring æ¡†æ¶ä¸­çš„è®¾è®¡æ¨¡å¼(å››)
date: 2018-01-06
tag: 
categories: Spring
permalink: Spring/DesignPattern-4
author: ä¸€å¶çŸ¥ç§‹
from_url: https://muyinchen.github.io/2017/07/28/Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20(%E5%9B%9B)/
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://muyinchen.github.io/2017/07/28/Spring%E6%A1%86%E6%9E%B6%E4%B8%AD%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20(%E5%9B%9B)/ ã€Œä¸€å¶çŸ¥ç§‹ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [é€‚é…å™¨](http://www.iocoder.cn/Spring/DesignPattern-4/)
- [è£…é¥°](http://www.iocoder.cn/Spring/DesignPattern-4/)
- [å•ä¾‹](http://www.iocoder.cn/Spring/DesignPattern-4/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

æœ¬æ–‡æ˜¯Springæ¡†æ¶ä¸­ä½¿ç”¨çš„è®¾è®¡æ¨¡å¼ç¬¬å››ç¯‡ã€‚æœ¬æ–‡å°†åœ¨æ­¤å‘ˆç°å‡ºæ–°çš„3ç§æ¨¡å¼ã€‚

ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬ä¼šè®¨è®º2ç§ç»“æ„æ¨¡å¼ï¼šé€‚é…å™¨å’Œè£…é¥°å™¨ã€‚åœ¨ç¬¬ä¸‰éƒ¨åˆ†å’Œæœ€åä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†è®¨è®ºå•ä¾‹æ¨¡å¼ã€‚

## é€‚é…å™¨

å½“æˆ‘ä»¬éœ€è¦åœ¨ç»™å®šåœºæ™¯ä¸‹(ä¹Ÿå°±æ˜¯ç»™å®šæ¥å£)æƒ³è¦ä¸æ”¹å˜è‡ªèº«è¡Œä¸ºè€Œåˆæƒ³åšåˆ°ä¸€äº›äº‹æƒ…çš„æƒ…å†µä¸‹(å°±æ˜¯æˆ‘ç»™ç”µä¹Ÿå°±æ˜¯æ¥å£äº†ï¼Œä½ æ¥åšäº‹ä¹Ÿå°±æ˜¯å„ç§ç”µå™¨)ï¼Œä½¿ç”¨**é€‚é…å™¨è®¾è®¡æ¨¡å¼**(è¿™é‡Œå†è¯´ä¸€ç‚¹ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å†ä¸€ä¸ªè§„ç« åˆ¶åº¦çš„ç¯å¢ƒä¸‹ï¼Œå¦‚ä½•å»é€‚åº”å¹¶è¾¾åˆ°æˆ‘ä»¬æœŸå¾…çš„æ•ˆæœï¼Œæ”¾åœ¨æ¶æ„è®¾è®¡è¿™é‡Œï¼Œå¯ä»¥æ‹¿ä¸€ä¸ªphpç³»ç»Ÿå’Œä¸€ä¸ªJavaç³»ç»Ÿæ¥è¯´ï¼Œå‡å¦‚ä¸¤è€…è¦äº’ç›¸è°ƒç”¨å¯¹æ–¹çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€å¥—å¯¹å¤–çš„apiæ¥é€‚é…)ã€‚è¿™æ„å‘³ç€åœ¨è°ƒç”¨æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæˆ‘ä»¬å°†æ›´æ”¹ä½¿ç”¨å¯¹è±¡è€Œä¸æ”¹å˜æœºåˆ¶ã€‚æ‹¿ä¸€ä¸ªç°å®ä¸­çš„ä¾‹å­è¿›è¡Œè¯´æ˜ï¼Œæƒ³è±¡ä¸€ä¸‹ä½ æƒ³è¦ç”¨ç”µé’»æ¥é’»ä¸€ä¸ªæ´ã€‚è¦é’»ä¸€ä¸ªå°æ´ï¼Œä½ ä¼šä½¿ç”¨å°é’»å¤´ï¼Œé’»ä¸€ä¸ªå¤§çš„éœ€è¦ç”¨å¤§é’»å¤´ã€‚å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```java
public class AdapterTest {

  public static void main(String[] args) {
    HoleMaker maker = new HoleMakerImpl();
    maker.makeHole(1);
    maker.makeHole(2);
    maker.makeHole(30);
    maker.makeHole(40);
  }
}

interface HoleMaker {
  public void makeHole(int diameter);
}

interface DrillBit {
  public void makeSmallHole();
  public void makeBigHole();
}

// Two adaptee objects
class BigDrillBit implements DrillBit {

  @Override
  public void makeSmallHole() {
    // do nothing
  }

  @Override
  public void makeBigHole() {
    System.out.println("Big hole is made byt WallBigHoleMaker");
  }
}

class SmallDrillBit implements DrillBit {

  @Override
  public void makeSmallHole() {
    System.out.println("Small hole is made byt WallSmallHoleMaker");
  }

  @Override
  public void makeBigHole() {
    // do nothing
  }
}

// Adapter class
class Drill implements HoleMaker {

  private DrillBit drillBit;

  public Drill(int diameter) {
    drillBit = getMakerByDiameter(diameter);
  }

  @Override
  public void makeHole(int diameter) {
    if (isSmallDiameter(diameter)) {
            drillBit.makeSmallHole();
    } else {
            drillBit.makeBigHole();
    }
  }

  private DrillBit getMakerByDiameter(int diameter) {
    if (isSmallDiameter(diameter)) {
            return new SmallDrillBit();
    }
    return new BigDrillBit();
  }

  private boolean isSmallDiameter(int diameter) {
    return diameter < 10;
  }
}

// Client class
class HoleMakerImpl implements HoleMaker {

  @Override
  public void makeHole(int diameter) {
    HoleMaker maker = new Drill(diameter);
    maker.makeHole(diameter);
  }
}
```

ä»¥ä¸Šä»£ç çš„ç»“æœå¦‚ä¸‹:

```Java
Small hole is made byt SmallDrillBit
Small hole is made byt SmallDrillBit
Big hole is made byt BigDrillBit
Big hole is made byt BigDrillBit
```

å¯ä»¥çœ‹åˆ°ï¼Œhole æ˜¯ç”±æ‰€åŒ¹é…çš„DrillBitå¯¹è±¡åˆ¶æˆçš„ã€‚å¦‚æœå­”çš„ç›´å¾„å°äº10ï¼Œåˆ™ä½¿ç”¨SmallDrillBitã€‚å¦‚æœå®ƒæ›´å¤§ï¼Œæˆ‘ä»¬ä½¿ç”¨BigDrillBitã€‚

æ€è·¯å°±æ˜¯ï¼Œè¦æ‰“æ´ï¼Œé‚£å°±è¦æœ‰æ‰“æ´çš„å·¥å…·ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªç”µé’»æ¥å£å’Œé’»å¤´ã€‚ç”µé’»å°±æ˜¯ç”¨æ¥æ‰“æ´çš„ï¼Œæ‰€ä»¥ï¼Œå®ƒå°±ä¸€ä¸ªæ¥å£æ–¹æ³•å³å¯ï¼Œæ¥ä¸‹æ¥å®šä¹‰é’»å¤´çš„æ¥å£ï¼Œæ— éå°±æ˜¯é’»å¤´çš„å°ºå¯¸æ ‡å‡†ï¼Œç„¶åæå‡ºä¸¤ä¸ªé’»å¤´å®ç°ç±»å‡ºæ¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠé’»å¤´å’Œç”µé’»ä¸»æœºç»„è£…èµ·æ¥å’¯ï¼Œä¹Ÿå°±æ˜¯`Drill`ç±»ï¼Œé‡Œé¢æœ‰ç”µé’»æ¥å£+é’»å¤´(æ ¹æ®è¦é’»çš„å­”å¤§å°æ¥ç¡®å®šç”¨å“ªä¸ªé’»å¤´)ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æŠŠå‡ ä¸ªå•ä¸€çš„ä¸œè¥¿ç»„åˆèµ·æ¥æ‹¥æœ‰ä¸°å¯Œçš„åŠŸèƒ½ï¼Œæœ€åæˆ‘ä»¬è¿›è¡Œå°è£…ä¸‹:`HoleMakerImpl`ï¼Œè¿™æ ·åªéœ€è¦æ ¹æ®å°ºå¯¸å°±å¯ä»¥æ‰“ç›¸åº”çš„å­”äº†ï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£æä¸ºç®€å•ï¼Œæ— é¡»ç®¡å†…éƒ¨é€»è¾‘æ˜¯å¤šä¹ˆå¤æ‚

Springä½¿ç”¨é€‚é…å™¨è®¾è®¡æ¨¡å¼æ¥å¤„ç†ä¸åŒservletå®¹å™¨ä¸­çš„**åŠ è½½æ—¶ç¼–ç»‡**(**load-time-weaving**)ã€‚åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰ä¸­ä½¿ç”¨**load-time-weaving**ï¼Œä¸€ç§æ–¹å¼æ˜¯åœ¨ç±»åŠ è½½æœŸé—´å°†AspectJçš„æ–¹é¢æ³¨å…¥å­—èŠ‚ç ã€‚å¦ä¸€ç§æ–¹å¼æ˜¯å¯¹ç±»è¿›è¡Œç¼–è¯‘æ—¶æ³¨å…¥æˆ–å¯¹å·²ç¼–è¯‘çš„ç±»è¿›è¡Œé™æ€æ³¨å…¥ã€‚

æˆ‘ä»¬å¯ä»¥ä»å…³äºSpringå’ŒJBossçš„å¤„ç†æ¥å£è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå®ƒåŒ…å«åœ¨**org.springframework.instrument.classloading.jboss**åŒ…ä¸­ã€‚æˆ‘ä»¬æ£€ç´¢`JBossLoadTimeWeaverç±»`è´Ÿè´£`JBosså®¹å™¨`çš„ç¼–ç»‡ç®¡ç†ã€‚ç„¶è€Œï¼Œç±»åŠ è½½å™¨å¯¹äº`JBoss 6`ï¼ˆä½¿ç”¨`JBossMCAdapter`å®ä¾‹ï¼‰å’Œ`JBoss 7/8`ï¼ˆä½¿ç”¨`JBossModulesAdapter`å®ä¾‹ï¼‰æ˜¯ä¸åŒçš„ã€‚æ ¹æ®`JBoss`ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åœ¨`JBossLoadTimeWeaver`æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ç›¸åº”çš„é€‚é…å™¨ï¼ˆä¸æˆ‘ä»¬ç¤ºä¾‹ä¸­çš„`Drill`çš„æ„é€ å‡½æ•°å®Œå…¨ç›¸åŒï¼‰ï¼š

```java
public JBossLoadTimeWeaver(ClassLoader classLoader) {
  private final JBossClassLoaderAdapter adapter;

  Assert.notNull(classLoader, "ClassLoader must not be null");
  if (classLoader.getClass().getName().startsWith("org.jboss.modules")) {
    // JBoss AS 7 or WildFly 8
    this.adapter = new JBossModulesAdapter(classLoader);
  }
  else {
    // JBoss AS 6
    this.adapter = new JBossMCAdapter(classLoader);
  }
}
```

è€Œä¸”ï¼Œæ­¤é€‚é…å™¨æ‰€åˆ›å»ºçš„å®ä¾‹ç”¨äºæ ¹æ®è¿è¡Œçš„servletå®¹å™¨ç‰ˆæœ¬è¿›è¡Œç¼–ç»‡æ“ä½œï¼š

```java
@Override
public void addTransformer(ClassFileTransformer transformer) {
  this.adapter.addTransformer(transformer);
}

@Override
public ClassLoader getInstrumentableClassLoader() {
  return this.adapter.getInstrumentableClassLoader();
}
```

> æ€»ç»“ï¼šé€‚é…å™¨æ¨¡å¼ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬ç”¨ç¬¬ä¸€äººç§°çš„è§†è§’å»çœ‹ä¸–ç•Œï¼Œæˆ‘æƒ³æ‹“å±•æˆ‘è‡ªå·±çš„æŠ€èƒ½çš„æ—¶å€™ï¼Œå°±å®è¡Œæ‹¿æ¥ä¸»ä¹‰ï¼Œå°±å¥½æ¯”è¿™é‡Œçš„æˆ‘æ˜¯ç”µé’»çš„è§†è§’ï¼Œé‚£ä¹ˆæˆ‘æƒ³æ‹¥æœ‰é’»å¤§å­”æˆ–è€…å°å­”çš„åŠŸèƒ½ï¼Œé‚£å°±æŠŠé’»å¤´æ‹¿åˆ°æ‰‹ç»„åˆèµ·æ¥å°±å¥½ã€‚
>
> å’Œè£…é¥°æ¨¡å¼çš„åŒºåˆ«ï¼šè£…é¥°æ¨¡å¼å±äºç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œä¹Ÿå°±æ˜¯ä¸Šå¸è§†è§’ï¼æˆ‘åªéœ€è¦æŠŠå‡ ä¸ªåŠŸèƒ½æ€§çš„ç»„ä»¶ç»™æ‹¿åˆ°æ‰‹ï¼Œè¿›è¡Œç»„åˆä¸€ä¸‹ï¼Œå®ç°ä¸€ä¸ªæ›´åŠ `niubility`çš„åŠŸèƒ½è¿™é‡Œæå‰è¯´ä¸‹ï¼Œè¿™æ ·çœ‹ä¸‹é¢çš„å†…å®¹èƒ½å¥½ç†è§£äº›ã€‚ä¸‹é¢è§£é‡Šè£…é¥°æ¨¡å¼

## è£…é¥°

è¿™é‡Œæè¿°çš„ç¬¬äºŒç§è®¾è®¡æ¨¡å¼çœ‹èµ·æ¥ç±»ä¼¼äºé€‚é…å™¨ã€‚å®ƒæ˜¯**è£…é¥°æ¨¡å¼**ã€‚è¿™ç§è®¾è®¡æ¨¡å¼çš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºç»™å®šçš„å¯¹è±¡æ·»åŠ è¡¥å……è§’è‰²ã€‚ä¸¾ä¸ªç°å®çš„ä¾‹å­ï¼Œå°±æ‹¿å’–å•¡æ¥è®²ã€‚é€šå¸¸è¶Šé»‘è¶Šè‹¦ï¼Œä½ å¯ä»¥æ·»åŠ ï¼ˆ`è£…é¥°`ï¼‰ç³–å’Œç‰›å¥¶ï¼Œä½¿å’–å•¡ä¸é‚£ä¹ˆè‹¦ã€‚å’–å•¡åœ¨è¿™é‡Œè¢«è£…é¥°çš„å¯¹è±¡ï¼Œç³–ä¸ç‰›å¥¶æ˜¯ç”¨æ¥è£…é¥°çš„ã€‚å¯ä»¥å‚è€ƒä¸‹é¢çš„ä¾‹å­ï¼š

```java
public class DecoratorSample {

  @Test
  public void test() {
    Coffee sugarMilkCoffee=new MilkDecorator(new SugarDecorator(new BlackCoffee()));
    assertEquals(sugarMilkCoffee.getPrice(), 6d, 0d);
  }
}

// decorated
abstract class Coffee{
  protected int candied=0;
  protected double price=2d;
  public abstract int makeMoreCandied();
  public double getPrice(){
    return this.price;
  }
  public void setPrice(double price){
    this.price+=price;
  }
}
class BlackCoffee extends Coffee{
  @Override
  public int makeMoreCandied(){
    return 0;
  }
  @Override
  public double getPrice(){
    return this.price;
  }
}

// abstract decorator
abstract class CoffeeDecorator extends Coffee{
  protected Coffee coffee;
  public CoffeeDecorator(Coffee coffee){
    this.coffee=coffee;
  }
  @Override
  public double getPrice(){
    return this.coffee.getPrice();
  }
  @Override
  public int makeMoreCandied(){
    return this.coffee.makeMoreCandied();
  }
}

// concrete decorators
class MilkDecorator extends CoffeeDecorator{
  public MilkDecorator(Coffee coffee){
    super(coffee);
  }
  @Override
  public double getPrice(){
    return super.getPrice()+1d;
  }
  @Override
  public int makeMoreCandied(){
    return super.makeMoreCandied()+1;
  }
}
class SugarDecorator extends CoffeeDecorator{
  public SugarDecorator(Coffee coffee){
    super(coffee);
  }
  @Override
  public double getPrice(){
    return super.getPrice()+3d;
  }
  @Override
  public int makeMoreCandied(){
    return super.makeMoreCandied()+1;
  }
}
```

ä¸Šé¢è¿™ä¸ªç®€å•çš„è£…é¥°å™¨çš„å°ä¾‹å­æ˜¯åŸºäºå¯¹çˆ¶æ–¹æ³•çš„è°ƒç”¨ï¼Œä»è€Œæ”¹å˜æœ€åçš„å±æ€§ï¼ˆæˆ‘ä»¬è¿™é‡Œæ˜¯æŒ‡ä»·æ ¼å’ŒåŠ ç³–å¤šå°‘ï¼‰ã€‚åœ¨Springä¸­ï¼Œæˆ‘ä»¬åœ¨å¤„ç†ä¸Springç®¡ç†ç¼“å­˜åŒæ­¥äº‹åŠ¡çš„ç›¸å…³ç±»ä¸­å¯ä»¥ å‘ç°è£…é¥°å™¨è®¾è®¡æ¨¡å¼çš„ä¾‹å­ã€‚è¿™ä¸ªç±»æ˜¯**org.springframework.cache.transaction.TransactionAwareCacheDecorator**ã€‚

è¿™ä¸ªç±»çš„å“ªäº›ç‰¹æ€§è¯æ˜å®ƒæ˜¯**org.springframework.cache.Cache**å¯¹è±¡çš„è£…é¥°å™¨ï¼Ÿé¦–å…ˆï¼Œä¸æˆ‘ä»¬çš„å’–å•¡ç¤ºä¾‹ä¸€æ ·ï¼Œ`TransactionAwareCacheDecorator`çš„æ„é€ å‡½æ•°æ¥æ”¶å‚æ•°è£…é¥°å¯¹è±¡ï¼ˆCacheï¼‰ï¼š

```Java
private final Cache targetCache;
/**
 * Create a new TransactionAwareCache for the given target Cache.
 * @param targetCache the target Cache to decorate
 */
public TransactionAwareCacheDecorator(Cache targetCache) {
  Assert.notNull(targetCache, "Target Cache must not be null");
  this.targetCache = targetCache;
}
```

å…¶æ¬¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ–°çš„è¡Œä¸º:ä¸ºç»™å®šçš„ç›®æ ‡ç¼“å­˜åˆ›å»ºä¸€ä¸ªæ–°çš„TransactionAwareCacheã€‚è¿™ä¸ªæˆ‘ä»¬å¯ä»¥åœ¨`TransactionAwareCacheDecorator`çš„æ³¨é‡Šä¸­å¯ä»¥é˜…è¯»åˆ°ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯æä¾›ç¼“å­˜å’ŒSpringäº‹åŠ¡ä¹‹é—´çš„åŒæ­¥çº§åˆ«ã€‚è¿™æ˜¯é€šè¿‡**org.springframework.transaction.support.TransactionSynchronizationManager**ä¸­çš„ä¸¤ç§ç¼“å­˜æ–¹æ³•å®ç°çš„ï¼š`put` å’Œ `evict`(å…¶å®æœ€ç»ˆä¸è¿˜æ˜¯é€šè¿‡`targetCache`æ¥å®ç°çš„ä¹ˆ)ï¼š

```java
@Override
public void put(final Object key, final Object value) {
  if (TransactionSynchronizationManager.isSynchronizationActive()) {
    TransactionSynchronizationManager.registerSynchronization(
      new TransactionSynchronizationAdapter() {
        @Override
        public void afterCommit() {
          targetCache.put(key, value);
        }
    });
  }
  else {
    this.targetCache.put(key, value);
  }
}

@Override
public void evict(final Object key) {
  if (TransactionSynchronizationManager.isSynchronizationActive()) {
          TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronizationAdapter() {
              @Override
              public void afterCommit() {
                targetCache.evict(key);
              }
          });
  }
  else {
    this.targetCache.evict(key);
  }
}
```

è¿™ç§æ¨¡å¼çœ‹èµ·æ¥ç±»ä¼¼äºé€‚é…å™¨ï¼Œå¯¹å§ï¼Ÿä½†æ˜¯ï¼Œå®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€‚é…å™¨å°†å¯¹è±¡é€‚é…åˆ°è¿è¡Œæ—¶ç¯å¢ƒï¼Œå³ã€‚å¦‚æœæˆ‘ä»¬åœ¨JBoss 6ä¸­è¿è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸JBoss 7ä¸åŒçš„ç±»åŠ è½½å™¨ã€‚Decoratoræ¯æ¬¡ä½¿ç”¨ç›¸åŒçš„ä¸»å¯¹è±¡ï¼ˆCacheï¼‰å·¥ä½œï¼Œå¹¶ä¸”ä»…å‘å…¶æ·»åŠ æ–°è¡Œä¸ºï¼ˆä¸æœ¬ä¾‹ä¸­çš„Springäº‹åŠ¡åŒæ­¥ï¼‰ï¼Œå¦å¤–ï¼Œå¯ä»¥é€šè¿‡æˆ‘åœ¨è§£è¯»è¿™ä¸ªè®¾è®¡æ¨¡å¼ä¹‹å‰çš„è¯´æ³•æ¥åŒºåˆ†äºŒè€…ã€‚

æˆ‘ä»¬å†ä»¥springbootçš„åˆå§‹åŒ–æ¥ä¸¾ä¸ªä¾‹å­çš„ï¼Œè¿™å—åé¢ä¼šè¿›è¡Œä»”ç»†çš„æºç åˆ†æçš„ï¼Œè¿™é‡Œå°±ä»…ä»…ç”¨è®¾è®¡æ¨¡å¼æ¥è¯´ä¸‹çš„:

```java
/**
 * Event published as early as conceivably possible as soon as a {@link SpringApplication}
 * has been started - before the {@link Environment} or {@link ApplicationContext} is
 * available, but after the {@link ApplicationListener}s have been registered. The source
 * of the event is the {@link SpringApplication} itself, but beware of using its internal
 * state too much at this early stage since it might be modified later in the lifecycle.
 *
 * @author Dave Syer
 */
@SuppressWarnings("serial")
public class ApplicationStartedEvent extends SpringApplicationEvent {

	/**
	 * Create a new {@link ApplicationStartedEvent} instance.
	 * @param application the current application
	 * @param args the arguments the application is running with
	 */
	public ApplicationStartedEvent(SpringApplication application, String[] args) {
		super(application, args);
	}

}
```

ä»æ³¨é‡Šå¯ä»¥çœ‹å‡º `ApplicationListener`è¦å…ˆè¡Œåˆ°ä½çš„ï¼Œç„¶åå°±æ˜¯startedçš„æ—¶å€™`Event published`èµ°èµ·ï¼Œæ¥ç€å°±æ˜¯`Environment`é…ç½®å¥½ï¼Œ`ApplicationContext`è¿›è¡Œåˆå§‹åŒ–å®Œæ¯•ï¼Œé‚£æˆ‘ä»¬å»çœ‹`ApplicationListener`çš„æºç :

```java
/**
 * Listener for the {@link SpringApplication} {@code run} method.
 * {@link SpringApplicationRunListener}s are loaded via the {@link SpringFactoriesLoader}
 * and should declare a public constructor that accepts a {@link SpringApplication}
 * instance and a {@code String[]} of arguments. A new
 * {@link SpringApplicationRunListener} instance will be created for each run.
 *
 * @author Phillip Webb
 * @author Dave Syer
 */
public interface SpringApplicationRunListener {

	/**
	 * Called immediately when the run method has first started. Can be used for very
	 * early initialization.
	 */
	void started();

	/**
	 * Called once the environment has been prepared, but before the
	 * {@link ApplicationContext} has been created.
	 * @param environment the environment
	 */
	void environmentPrepared(ConfigurableEnvironment environment);

	/**
	 * Called once the {@link ApplicationContext} has been created and prepared, but
	 * before sources have been loaded.
	 * @param context the application context
	 */
	void contextPrepared(ConfigurableApplicationContext context);

	/**
	 * Called once the application context has been loaded but before it has been
	 * refreshed.
	 * @param context the application context
	 */
	void contextLoaded(ConfigurableApplicationContext context);

	/**
	 * Called immediately before the run method finishes.
	 * @param context the application context or null if a failure occurred before the
	 * context was created
	 * @param exception any run exception or null if run completed successfully.
	 */
	void finished(ConfigurableApplicationContext context, Throwable exception);

}
```

çœ‹ç±»æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œéœ€è¦å®ç°æ­¤æ¥å£å†…æ‰€å®šä¹‰çš„è¿™å‡ ä¸ªæ–¹æ³•ï¼Œokï¼Œæ¥çœ‹ä¸ªå®ç°ç±»:

```java
/**
 * {@link SpringApplicationRunListener} to publish {@link SpringApplicationEvent}s.
 * <p>
 * Uses an internal {@link ApplicationEventMulticaster} for the events that are fired
 * before the context is actually refreshed.
 *
 * @author Phillip Webb
 * @author Stephane Nicoll
 */
public class EventPublishingRunListener implements SpringApplicationRunListener, Ordered {

	private final SpringApplication application;

	private final String[] args;

	private final ApplicationEventMulticaster initialMulticaster;

	public EventPublishingRunListener(SpringApplication application, String[] args) {
		this.application = application;
		this.args = args;
		this.initialMulticaster = new SimpleApplicationEventMulticaster();
		for (ApplicationListener<?> listener : application.getListeners()) {
			this.initialMulticaster.addApplicationListener(listener);
		}
	}

	@Override
	public int getOrder() {
		return 0;
	}

	@Override
	public void started() {
		this.initialMulticaster
				.multicastEvent(new ApplicationStartedEvent(this.application, this.args));
	}

	@Override
	public void environmentPrepared(ConfigurableEnvironment environment) {
		this.initialMulticaster.multicastEvent(new ApplicationEnvironmentPreparedEvent(
				this.application, this.args, environment));
	}

	@Override
	public void contextPrepared(ConfigurableApplicationContext context) {

	}

	@Override
	public void contextLoaded(ConfigurableApplicationContext context) {
		for (ApplicationListener<?> listener : this.application.getListeners()) {
			if (listener instanceof ApplicationContextAware) {
				((ApplicationContextAware) listener).setApplicationContext(context);
			}
			context.addApplicationListener(listener);
		}
		this.initialMulticaster.multicastEvent(
				new ApplicationPreparedEvent(this.application, this.args, context));
	}

	@Override
	public void finished(ConfigurableApplicationContext context, Throwable exception) {
		// Listeners have been registered to the application context so we should
		// use it at this point
		context.publishEvent(getFinishedEvent(context, exception));
	}

	private SpringApplicationEvent getFinishedEvent(
			ConfigurableApplicationContext context, Throwable exception) {
		if (exception != null) {
			return new ApplicationFailedEvent(this.application, this.args, context,
					exception);
		}
		return new ApplicationReadyEvent(this.application, this.args, context);
	}

}
```

ä»ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ`EventPublishingRunListener`é‡Œå¯¹æ¥å£åŠŸèƒ½çš„å®ç°ï¼Œä¸»è¦æ˜¯é€šè¿‡`SpringApplication` `ApplicationEventMulticaster` æ¥å®ç°çš„ï¼Œè‡ªå·±ä¸å¹²æ´»ï¼ŒæŒ‚ä¸ªè™šåï¼Œä»ä¸Šå¸æ¨¡å¼çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸å°±æ˜¯åº”ç”¨äº†è£…é¥°æ¨¡å¼æ¥å®ç°çš„ä¹ˆã€‚

æ›´å¤šæºç è§£æè¯·å…³æ³¨åç»­çš„æœ¬äººå¯¹Springæ¡†æ¶å…¨é¢çš„é‡ç‚¹éƒ¨åˆ†è§£æç³»åˆ—åšæ–‡

## å•ä¾‹

**å•ä¾‹**ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨å¾ˆå¤šSpring Frameworkä¸­å…³äºå•ä¾‹å’ŒåŸå‹beançš„æ–‡ç« (ç½‘ä¸Šå¤ªå¤šäº†)ä¸­å·²ç»çœ‹åˆ°è¿‡çš„ï¼Œå•ä¾‹æ˜¯å‡ ä¸ªbeanä½œç”¨åŸŸä¸­çš„ä¸­çš„ä¸€ä¸ªã€‚æ­¤ä½œç”¨åŸŸåœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ä»…åˆ›å»ºä¸€ä¸ªç»™å®šbeançš„å®ä¾‹ã€‚ä¸signletonè®¾è®¡æ¨¡å¼æœ‰æ‰€åŒºåˆ«çš„æ˜¯ï¼ŒSpringå°†å®ä¾‹çš„æ•°é‡é™åˆ¶çš„ä½œç”¨åŸŸåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ã€‚è€ŒSingletonè®¾è®¡æ¨¡å¼åœ¨Javaåº”ç”¨ç¨‹åºä¸­æ˜¯å°†è¿™äº›å®ä¾‹çš„æ•°é‡é™åˆ¶åœ¨ç»™å®šç±»åŠ è½½å™¨ç®¡ç†çš„æ•´ä¸ªç©ºé—´ä¸­ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¸ºä¸¤ä¸ªSpringçš„ä¸Šä¸‹æ–‡(åŒä¸€ä»½é…ç½®æ–‡ä»¶èµ·ä¸¤ä¸ªå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯ä¸åŒç«¯å£çš„å®¹å™¨å®ä¾‹)ä½¿ç”¨ç›¸åŒçš„ç±»åŠ è½½å™¨ï¼Œå¹¶æ£€ç´¢ä¸¤ä¸ªå•ä¾‹ä½œç”¨åŸŸçš„beanã€‚

åœ¨çœ‹Springå•ä¾‹åº”ç”¨ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªJavaçš„å•ä¾‹ä¾‹å­ï¼š

```java
public class SingletonTest {

  @Test
  public void test() {
    President president1 = (President) SingletonsHolder.PRESIDENT.getHoldedObject();
    President president2 = (President) SingletonsHolder.PRESIDENT.getHoldedObject();
    assertTrue("Both references of President should point to the same object", president1 == president2);
    System.out.println("president1 = "+president1+" and president2 = "+president2);
    // sample output
    // president1 = com.migo.test.President@17414c8 and president2 = com.migo.test.President@17414c8

  }

}

enum SingletonsHolder {

  PRESIDENT(new President());

  private Object holdedObject;

  private SingletonsHolder(Object o) {
          this.holdedObject = o;
  }

  public Object getHoldedObject() {
          return this.holdedObject;
  }

}

class President {
}
```

è¿™ä¸ªæµ‹è¯•ä¾‹å­è¯æ˜ï¼Œåªæœ‰ä¸€ä¸ªç”±SingletonsHolderæ‰€æŒæœ‰çš„Presidentå®ä¾‹ã€‚åœ¨Springä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨beanå·¥å‚ä¸­æ‰¾åˆ°å•ä¾‹åº”ç”¨çš„å½±å­ï¼ˆä¾‹å¦‚åœ¨**org.springframework.beans.factory.config.AbstractFactoryBeanä¸­**ï¼‰ï¼š

```java
/**
 * Expose the singleton instance or create a new prototype instance.
 * @see #createInstance()
 * @see #getEarlySingletonInterfaces()
 */
@Override
public final T getObject() throws Exception {
  if (isSingleton()) {
    return (this.initialized ? this.singletonInstance : getEarlySingletonInstance());
  }
  else {
    return createInstance();
  }
}
```

æˆ‘ä»¬çœ‹åˆ°ï¼Œå½“éœ€æ±‚å¯¹è±¡è¢«è§†ä¸ºå•ä¾‹æ—¶ï¼Œå®ƒåªè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡ä½¿ç”¨åŒä¸€ä¸ªbeanç±»çš„å®ä¾‹åè¿”å›ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç»™å®šçš„ä¾‹å­ä¸­çœ‹åˆ°ï¼Œç±»ä¼¼äºæˆ‘ä»¬ä»¥å‰çœ‹åˆ°çš„Presidentæƒ…å†µã€‚å°†æµ‹è¯•beanå®šä¹‰ä¸ºï¼š

```xml
<bean id="shoppingCart" class="com.migo.data.ShoppingCart" />
```

æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class SingletonSpringTest {

  @Test
  public void test() {
    // retreive two different contexts
    ApplicationContext firstContext = new FileSystemXmlApplicationContext("applicationContext-test.xml");
    ApplicationContext secondContext = new FileSystemXmlApplicationContext("applicationContext-test.xml");

    // prove that both contexts are loaded by the same class loader
    assertTrue("Class loaders for both contexts should be the same",
      firstContext.getClassLoader() == secondContext.getClassLoader());
    // compare the objects from different contexts
    ShoppingCart firstShoppingCart = (ShoppingCart) firstContext.getBean("shoppingCart");
    ShoppingCart secondShoppingCart = (ShoppingCart) secondContext.getBean("shoppingCart");
    assertFalse("ShoppingCart instances got from different application context shouldn't be the same",
      firstShoppingCart == secondShoppingCart);

    // compare the objects from the same context
    ShoppingCart firstShoppingCartBis = (ShoppingCart) firstContext.getBean("shoppingCart");
    assertTrue("ShoppingCart instances got from the same application context should be the same",
      firstShoppingCart == firstShoppingCartBis);
  }
}
```

è¿™ä¸ªæµ‹è¯•æ¡ˆä¾‹æ˜¾ç¤ºäº†Springå•ä¾‹æ¨¡å¼ä¸çº¯ç²¹çš„å•ä¾‹è®¾è®¡æ¨¡å¼çš„ä¸»è¦åŒºåˆ«ã€‚å°½ç®¡ä½¿ç”¨ç›¸åŒçš„ç±»åŠ è½½å™¨æ¥åŠ è½½ä¸¤ä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯ShoppingCartçš„å®ä¾‹æ˜¯ä¸ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬æ¯”è¾ƒä¸¤æ¬¡åˆ›å»ºå¹¶å±äºç›¸åŒä¸Šä¸‹æ–‡çš„å®ä¾‹æ—¶ï¼Œæˆ‘ä»¬è®¤ä¸ºå®ƒä»¬æ˜¯ç›¸ç­‰çš„ã€‚

ä¹Ÿæ­£å› ä¸ºæœ‰äº†å•ä¾‹ï¼ŒSpringå¯ä»¥æ§åˆ¶åœ¨æ¯ä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­åªæœ‰ä¸€ä¸ªè¿™æ ·æŒ‡å®šçš„beançš„å®ä¾‹å¯ç”¨ã€‚å› ä¸ºé€‚é…å™¨ï¼ŒSpringå¯ä»¥å†³å®šä½¿ç”¨ç”±è°æ¥å¤„ç†`JBoss servlet`å®¹å™¨ä¸­çš„åŠ è½½æ—¶ç¼–ç»‡,ä¹Ÿå¯ä»¥å®ç°`ConfigurableListableBeanFactory`çš„ç›¸åº”å®ä¾‹ã€‚ç¬¬ä¸‰ç§è®¾è®¡æ¨¡å¼ï¼Œè£…é¥°å™¨ï¼Œç”¨äºå‘Cacheå¯¹è±¡æ·»åŠ åŒæ­¥åŠŸèƒ½ï¼Œè¿˜æœ‰Springbootçš„å®¹å™¨åˆå§‹åŒ–ã€‚

å…¶å®å¯¹äºé€‚é…å™¨å’Œè£…é¥°è€…ç¡®å®æœ‰å¤ªå¤šçš„ç›¸ä¼¼çš„åœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯è¿è¡Œæ—¶é€‰æ‹©ï¼Œä¸€ä¸ªæ˜¯åŠ æ–™ç»„åˆäº§ç”Ÿæ–°çš„åŒ–å­¦æ•ˆåº”ï¼Œè¿˜æœ‰ä»çœ‹å¾…äº‹ç‰©çš„è§’åº¦ä¸åŒå¾—åˆ°ä¸åŒçš„è¡Œä¸ºï¼Œé€‚é…é€‚é…ï¼Œæ›´æ³¨é‡é¢å‘æ¥å£çš„å®ç°ï¼Œè€Œå†…éƒ¨åˆæ ¹æ®ä¸åŒæƒ…å†µè°ƒç”¨é¢å‘ä¸€å¥—æ¥å£çš„å¤šå¥—å®ç°çš„å®ä¾‹çš„ç›¸åº”æ–¹æ³•æ¥å®ç°æ‰€è¦å®ç°çš„å…·ä½“åŠŸèƒ½ï¼Œè£…é¥°è€…æ›´æ³¨é‡æ·»æ²¹åŠ é†‹ï¼Œé€šè¿‡ç»„åˆä¸€äº›å…¶ä»–å¯¹è±¡å®ä¾‹æ¥è®©è‡ªå·±çš„åŠŸèƒ½å®ç°çš„æ›´åŠ åä¸½ä¸€äº›(è¾¾åˆ°1+1>2çš„è¿™ç§æ•ˆæœ)ã€‚ä¸€å®¶ä¹‹è¨€ï¼Œæœ‰æ›´å¥½çš„ç†è§£å¯ä»¥è”ç³»æˆ‘ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Spring æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)