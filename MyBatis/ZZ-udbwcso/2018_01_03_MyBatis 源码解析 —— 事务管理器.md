title: MyBatis æºç è§£æ â€”â€” äº‹åŠ¡ç®¡ç†å™¨
date: 2018-01-03
tag: 
categories: MyBatis
permalink: MyBatis/udbwcso/Transaction-Manager
author: udbwcso
from_url: https://my.oschina.net/u/657390/blog/663080
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://my.oschina.net/u/657390/blog/663080 ã€Œudbwcsoã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [666. å½©è›‹](http://www.iocoder.cn/MyBatis/udbwcso/Transaction-Manager/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

è¿™æ¬¡é‡ç‚¹åˆ†æmybatisçš„äº‹åŠ¡ç®¡ç†å™¨

ä»æ—§ä»å®˜ç½‘ç»™çš„ä¾‹å­ç€æ‰‹åˆ†æ,é…ç½®æ–‡ä»¶mybatis-config.xml

```XML
<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE configuration
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
      <environments default="development">
        <environment id="development">
          <transactionManager type="JDBC"/>
          <dataSource type="POOLED">
            <property name="driver" value="${driver}"/>
            <property name="url" value="${url}"/>
            <property name="username" value="${username}"/>
            <property name="password" value="${password}"/>
          </dataSource>
        </environment>
      </environments>
      <mappers>
        <mapper resource="org/mybatis/example/BlogMapper.xml"/>
      </mappers>
  </configuration>
```



åœ¨æ ¹ç»“ç‚¹configurationä¸‹æœ‰environmentså’Œmappersä¸¤ä¸ªç»“ç‚¹.

environments:ç¯å¢ƒ,mybatiså¯ä»¥é…ç½®å¤šä¸ªç¯å¢ƒå³å¯ä»¥å°† SQL æ˜ å°„åº”ç”¨äºå¤šç§æ•°æ®åº“ä¹‹ä¸­.å¦‚å¼€å‘,æµ‹è¯•,ç”Ÿäº§å¯¹åº”ä¸åŒçš„æ•°æ®åº“.

mappers:æ˜ å°„å™¨,æä¾›æ˜ å°„æ–‡ä»¶çš„åœ°å€.

åœ¨environmentä¸‹çš„transactionManagerå°±æ˜¯ç°åœ¨è¦é‡ç‚¹åˆ†æçš„å¯¹è±¡.

mybatisä¸­æœ‰ä¸¤ç§ç±»å‹çš„äº‹åŠ¡ç®¡ç†å™¨,JDBCå’ŒMANAGED.

JDBC:ç›´æ¥ä½¿ç”¨äº† JDBC çš„æäº¤å’Œå›æ»šè®¾ç½®ï¼Œå®ƒä¾èµ–äºä»æ•°æ®æºå¾—åˆ°çš„è¿æ¥æ¥ç®¡ç†äº‹åŠ¡èŒƒå›´ã€‚

MANAGED:ä¸æäº¤æˆ–å›æ»šä¸€ä¸ªè¿æ¥ï¼Œè€Œæ˜¯è®©å®¹å™¨æ¥ç®¡ç†äº‹åŠ¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚

å¯¹ä¾‹å­è¿›è¡Œåˆ†æ,ä¹‹å‰åˆ†æè¿‡

```Java
String resource = "org/mybatis/example/mybatis-config.xml";
InputStream inputStream = Resources.getResourceAsStream(resource);
sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
```



ç°åœ¨å†æ¥åˆ†æ

```Java
SqlSession session = sqlSessionFactory.openSession();
```

DefaultSqlSessionFactoryé‡Œçš„openSession

```Java
public SqlSession openSession() {
  return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);
}
```



openSessionFromDataSource

```Java
private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
  Transaction tx = null;
  try {
    //æ ¹æ®é…ç½®è·å–ç¯å¢ƒ
    final Environment environment = configuration.getEnvironment();
    //æ„å»ºäº‹åŠ¡å·¥å‚
    final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);
    //é€šè¿‡äº‹åŠ¡å·¥å‚åˆ›å»ºäº‹åŠ¡
    tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);
    final Executor executor = configuration.newExecutor(tx, execType);
    return new DefaultSqlSession(configuration, executor, autoCommit);
  } catch (Exception e) {
    closeTransaction(tx); // may have fetched a connection so lets call close()
    throw ExceptionFactory.wrapException("Error opening session.  Cause: " + e, e);
  } finally {
    ErrorContext.instance().reset();
  }
}
```



çœ‹ä¸€ä¸‹å„ä¸ªç±»ä¹‹é—´çš„å…³ç³»

![img](http://static.iocoder.cn/oschina/uploads/space/2016/0420/145050_579o_657390.png)

JdbcTransactionå’ŒManagedTransactionå¯¹åº”äº‹åŠ¡ç®¡ç†å™¨çš„ä¸¤ç§ç±»å‹JDBCå’ŒMANAGED.

ç”±äºManagedTransactionå‡ ä¹æ²¡åšä»€ä¹ˆ,æ‰€ä»¥é‡ç‚¹åˆ†æJdbcTransaction.

å› ä¸ºJdbcTransactionç›´æ¥ä½¿ç”¨äº† JDBC çš„æäº¤å’Œå›æ»šè®¾ç½®ï¼Œå®ƒä¾èµ–äºä»æ•°æ®æºå¾—åˆ°çš„è¿æ¥æ¥ç®¡ç†äº‹åŠ¡èŒƒå›´ã€‚

é‚£ä¹ˆç›´æ¥æ¥çœ‹çœ‹JDBCçš„äº‹åŠ¡

java.sql.Connection

```Java
/**
 * A constant indicating that transactions are not supported.
 */
int TRANSACTION_NONE             = 0;

/**
 * A constant indicating that
 * dirty reads, non-repeatable reads and phantom reads can occur.
 * This level allows a row changed by one transaction to be read
 * by another transaction before any changes in that row have been
 * committed (a "dirty read").  If any of the changes are rolled back,
 * the second transaction will have retrieved an invalid row.
 */
int TRANSACTION_READ_UNCOMMITTED = 1;

/**
 * A constant indicating that
 * dirty reads are prevented; non-repeatable reads and phantom
 * reads can occur.  This level only prohibits a transaction
 * from reading a row with uncommitted changes in it.
 */
int TRANSACTION_READ_COMMITTED   = 2;

/**
 * A constant indicating that
 * dirty reads and non-repeatable reads are prevented; phantom
 * reads can occur.  This level prohibits a transaction from
 * reading a row with uncommitted changes in it, and it also
 * prohibits the situation where one transaction reads a row,
 * a second transaction alters the row, and the first transaction
 * rereads the row, getting different values the second time
 * (a "non-repeatable read").
 */
int TRANSACTION_REPEATABLE_READ  = 4;

/**
 * A constant indicating that
 * dirty reads, non-repeatable reads and phantom reads are prevented.
 * This level includes the prohibitions in
 * <code>TRANSACTION_REPEATABLE_READ</code> and further prohibits the
 * situation where one transaction reads all rows that satisfy
 * a <code>WHERE</code> condition, a second transaction inserts a row that
 * satisfies that <code>WHERE</code> condition, and the first transaction
 * rereads for the same condition, retrieving the additional
 * "phantom" row in the second read.
 */
int TRANSACTION_SERIALIZABLE     = 8;
```



äº‹åŠ¡éš”ç¦»çº§åˆ«

TRANSACTION_NONE:ä¸æ”¯æŒäº‹åŠ¡

TRANSACTION_READ_UNCOMMITTED:å…è®¸è„è¯»ã€ä¸å¯é‡å¤çš„è¯»å’Œè™šè¯».

TRANSACTION_READ_COMMITTED:ä¸å…è®¸è„è¯»,å…è®¸ä¸å¯é‡å¤çš„è¯»å’Œè™šè¯».

TRANSACTION_REPEATABLE_READ:ä¸å…è®¸è„è¯»å’Œä¸å¯é‡å¤çš„è¯»,å…è®¸è™šè¯».

TRANSACTION_SERIALIZABLE:ä¸å…è®¸è„è¯»ã€ä¸å¯é‡å¤çš„è¯»å’Œè™šè¯».

è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œä½†äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡å°±å¯ä»¥å–åˆ°è¯¥äº‹åŠ¡æ²¡æœ‰æäº¤çš„æ›´æ–°ç»“æœã€‚

ä¸å¯é‡å¤è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡åœ¨æ•´ä¸ªäº‹åŠ¡è¿‡ç¨‹ä¸­å¯¹åŒä¸€ç¬”æ•°æ®è¿›è¡Œå¤šæ¬¡è¯»å–ï¼Œæ¯æ¬¡è¯»å–ç»“æœéƒ½ä¸åŒã€‚

è™šè¯»ï¼šåŒä¸€ä¸ªæŸ¥è¯¢åœ¨æ•´ä¸ªäº‹åŠ¡è¿‡ç¨‹ä¸­å¤šæ¬¡æ‰§è¡Œåï¼ŒæŸ¥è¯¢æ‰€å¾—çš„ç»“æœé›†æ˜¯ä¸ä¸€æ ·çš„ã€‚è™šè¯»é’ˆå¯¹çš„æ˜¯å¤šæ¡è®°å½•ã€‚

ä¸å¯é‡å¤è¯»:åˆ—å€¼çš„ä¸åŒ; è™šè¯»:è®°å½•æ•°é‡çš„ä¸åŒã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ MyBatis æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)