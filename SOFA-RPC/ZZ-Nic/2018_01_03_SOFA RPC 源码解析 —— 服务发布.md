title: SOFA RPC æºç è§£æ â€”â€” æœåŠ¡å‘å¸ƒ
date: 2018-01-03
tag: 
categories: SOFA RPC
permalink: SOFARPC/Nic/service-export
author: é‹’Nic
from_url: https://www.jianshu.com/p/6a9b7e630fa1
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/6a9b7e630fa1 ã€Œé‹’Nicã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

**ç®€ä»‹æ‘˜è¦**
 SOFARPCæ˜¯èš‚èšé‡‘æœå¼€æºçš„é«˜å¯æ‰©å±•æ€§ã€é«˜æ€§èƒ½ã€ç”Ÿäº§çº§çš„è½»é‡çº§Java RPCæœåŠ¡æ¡†æ¶ï¼ŒåŸºäºNettyç½‘ç»œé€šä¿¡æ¡†æ¶æä¾›åº”ç”¨ä¹‹é—´çš„ç‚¹å¯¹ç‚¹æœåŠ¡è°ƒç”¨åŠŸèƒ½ï¼Œä¸ºåº”ç”¨ä¹‹é—´æä¾›ç‚¹å¯¹ç‚¹è¿œç¨‹æœåŠ¡è°ƒç”¨åŠŸèƒ½ã€‚SOFARPCæœåŠ¡å‘å¸ƒæŒ‰ç…§ç¼–ç¨‹ç•Œé¢åˆ†ä¸ºä¸¤ç§ä½¿ç”¨SOFARPCçš„æ–¹å¼ï¼š
 1.é€šè¿‡SOFARPCä½¿ç”¨ï¼š
 æœåŠ¡å‘å¸ƒè¿‡ç¨‹æ¶‰åŠåˆ°RegistryConfigæ³¨å†Œä¸­å¿ƒé…ç½®ç±»ï¼ŒServerConfig æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ç±»ä»¥åŠProviderConfigæœåŠ¡å‘å¸ƒé…ç½®ç±»ã€‚
 (1)RegistryConfigæ³¨å†Œä¸­å¿ƒé…ç½®ç±»

```Java
RegistryConfig registryConfig = new RegistryConfig()
            .setProtocol("zookeeper")
            .setAddress("127.0.0.1:2181")
```

RegistryConfigè¡¨ç¤ºæ³¨å†Œä¸­å¿ƒï¼Œå¦‚ä¸Šå£°æ˜æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åœ°å€å’Œç«¯å£æ˜¯127.0.0.1:2181ï¼Œåè®®æ˜¯Zookeeperã€‚
 (2)ServerConfigæœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ç±»

```Java
ServerConfig serverConfig = new ServerConfig()
           .setPort(8803)
           .setProtocol("bolt");
```

ServerConfigè¡¨ç¤ºæœåŠ¡è¿è¡Œå®¹å™¨ï¼Œå¦‚ä¸Šå£°æ˜ä¸€ä¸ªä½¿ç”¨8803ç«¯å£å’Œbolt åè®®çš„serverã€‚
 (3)ProviderConfigæœåŠ¡å‘å¸ƒé…ç½®ç±»

```Java
ProviderConfig<HelloWorldService> providerConfig = new ProviderConfig<HelloWorldService>()
            .setInterfaceId(HelloWorldService.class.getName())
            .setRef(new HelloWorldServiceImpl())
            .setServer(serverConfig)
            .setRegistry(registryConfig);
providerConfig.export();
```

ProviderConfigè¡¨ç¤ºæœåŠ¡å‘å¸ƒï¼Œå¦‚ä¸Šå£°æ˜æœåŠ¡çš„æ¥å£ï¼Œå®ç°å’Œè¯¥æœåŠ¡è¿è¡Œçš„serverï¼Œæœ€ç»ˆé€šè¿‡exportæ–¹æ³•å°†æ­¤æœåŠ¡å‘å¸ƒå‡ºå»ã€‚
 SOFARPCæœåŠ¡å‘å¸ƒæ”¯æŒå¦‚ä¸‹ç‰¹æ€§ï¼š
 (1)åŒä¸€æœåŠ¡å‘å¸ƒboltï¼Œrestï¼Œdubboå¤šç§åè®®ï¼Œæ„å»ºå¤šä¸ªServerConfigè®¾ç½®ç»™ProviderConfigï¼š

```Java
 List<ServerConfig> serverConfigs = new ArrayList<ServerConfig>();
 serverConfigs.add(serverConfigA);
 serverConfigs.add(serverConfigB);
 providerConfig.setServer(serverConfigs);
```

(2)åŒä¸€æœåŠ¡æ³¨å†Œå¤šä¸ªæ³¨å†Œä¸­å¿ƒï¼Œæ„å»ºå¤šä¸ªRegistryConfigè®¾ç½®ç»™ ProviderConfigï¼š

```Java
List<RegistryConfig> registryConfigs = new ArrayList<RegistryConfig>();
registryConfigs.add(registryA);
registryConfigs.add(registryB);
providerConfig.setRegistry(registryConfigs);
```

(3)æä¾›MethodConfigè¿›è¡Œæ–¹æ³•çº§åˆ«å‚æ•°è®¾ç½®ï¼ŒAPIæ–¹å¼ä½¿ç”¨ç›¸åº”çš„å¯¹è±¡setæ³•å³å¯ä¸ºå…¶è®¾ç½®å‚æ•°ï¼š

```Java
MethodConfig methodConfigA = new MethodConfig();
MethodConfig methodConfigB = new MethodConfig();
List<MethodConfig> methodConfigs = new ArrayList<MethodConfig>();
methodConfigs.add(methodConfigA);
methodConfigs.add(methodConfigB);
providerConfig.setMethods(methodConfigs);  //æœåŠ¡ç«¯è®¾ç½®
```

2.é€šè¿‡SOFABootä½¿ç”¨ï¼š
 (1)æœåŠ¡å‘å¸ƒä½¿ç”¨XMLé…ç½®é€šè¿‡sofa:serviceå…ƒç´ è¡¨ç¤ºå‘å¸ƒæœåŠ¡ï¼ŒXMLé…ç½®å¦‚ä¸‹æ‰€ç¤ºå°±èƒ½å¤Ÿå‘å¸ƒSOFARPCæœåŠ¡ï¼š

```XML
<bean id="helloSyncServiceImpl" class="com.alipay.sofa.rpc.samples.invoke.HelloSyncServiceImpl"/>
<sofa:service ref="helloSyncServiceImpl" interface="com.alipay.sofa.rpc.samples.invoke.HelloSyncService">
    <sofa:binding.bolt/>
</sofa:service>
```

å¦‚ä¸Šå£°æ˜æœåŠ¡å®ç°helloSyncServiceImplï¼Œé€šè¿‡sofa:serviceå…ƒç´ å°†è¯¥æœåŠ¡å‘å¸ƒï¼Œå…¶ä¸­refå±æ€§è¡¨ç¤ºå‘å¸ƒçš„æœåŠ¡å®ä¾‹ï¼Œinterfaceå±æ€§è¡¨ç¤ºè¯¥æœåŠ¡çš„æ¥å£ã€‚è€Œsofa:binding.boltå…ƒç´ è¡¨ç¤ºè¯¥æœåŠ¡ä¼šæä¾› bolt åè®®è°ƒç”¨é€šé“ã€‚
 å½“SOFARPCåº”ç”¨å¯åŠ¨çš„æ—¶å€™å‘ç°å½“å‰åº”ç”¨éœ€è¦å‘å¸ƒRPCæœåŠ¡çš„è¯ï¼ŒSOFARPCå°†è¿™äº›æœåŠ¡æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œä¸­å¿ƒä¸Šé¢ã€‚æœåŠ¡å‘å¸ƒå°†è¯¥æœåŠ¡å®ä¾‹æ³¨å†Œåˆ°å¯¹åº”åè®®çš„serverä¸Šï¼Œå¹¶ä¸”å‘å¸ƒè¯¥æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯åˆ°æ³¨å†Œä¸­å¿ƒã€‚
 ä¸€ä¸ªæœåŠ¡ä¹Ÿå¯ä»¥é€šè¿‡å¤šç§åè®®è¿›è¡Œå‘å¸ƒï¼Œå¹¶ä¸”é€šè¿‡sofa:methodå…ƒç´ è¡¨ç¤ºæ–¹æ³•çº§åˆ«é…ç½®ï¼ŒXMLé…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š

```XML
<sofa:service ref="helloSyncServiceImpl" interface="com.alipay.sofa.rpc.samples.invoke.HelloSyncService">
    <sofa:binding.bolt/>
    <sofa:binding.rest/>
    <sofa:binding.dubbo/>
</sofa:service>
<sofa:service ref="sampleFacadeImpl" interface="com.alipay.sofa.rpc.bean.SampleFacade">
    <sofa:binding.bolt>
        <sofa:global-attrs timeout="3000"/>
        <sofa:method name="sayName" timeout="2000"/>
    </sofa:binding.bolt>
</sofa:service>
```

(2)æœåŠ¡å‘å¸ƒä½¿ç”¨æ³¨è§£æ–¹å¼é€šè¿‡@SofaServiceæ³¨è§£è¡¨ç¤ºå‘å¸ƒæœåŠ¡ï¼ŒinterfaceTypeå…ƒç´ æŒ‡å®šæœåŠ¡æ¥å£ï¼Œbindingså…ƒç´ æŒ‡å®šåè®®ç±»å‹(å¤šåè®®åœºæ™¯ä½¿ç”¨@SofaServiceBindingæ³¨è§£bindingTypeå…ƒç´ æŒ‡å®šåè®®ç±»å‹)ï¼š

```Java
@SofaService(interfaceType = AnnotationService.class, bindings = { @SofaServiceBinding(bindingType = "bolt") })
@Component
public class AnnotationServiceImpl implements AnnotationService {
    @Override
    public String sayAnnotation(String stirng) {
        return stirng;
    }
}
```

**æºç è§£æ**
 æ­å»ºç¯å¢ƒæœåŠ¡å‘å¸ƒç¤ºä¾‹ï¼š

```Java
package org.alipay.sofa.rpc;

import com.alipay.sofa.rpc.config.ProviderConfig;
import com.alipay.sofa.rpc.config.ServerConfig;

public class RpcServer {

    public static void main(String[] args) {
        ServerConfig serverConfig = new ServerConfig()
                .setProtocol("bolt") // è®¾ç½®ä¸€ä¸ªåè®®ï¼Œé»˜è®¤bolt
                .setPort(12800) // è®¾ç½®ä¸€ä¸ªç«¯å£ï¼Œé»˜è®¤12200
                .setDaemon(false); // éå®ˆæŠ¤çº¿ç¨‹

        ProviderConfig<HelloService> providerConfig = new ProviderConfig<HelloService>()
                .setInterfaceId(HelloService.class.getName()) // æŒ‡å®šæ¥å£
                .setRef(new HelloServiceImpl()) // æŒ‡å®šå®ç°
                .setServer(serverConfig); // æŒ‡å®šæœåŠ¡ç«¯

        providerConfig.export(); // å‘å¸ƒæœåŠ¡
    }
}
```

å‚è€ƒSOFARPC Exampleç¤ºä¾‹æ¨¡å—([com.alipay.sofa.rpc.quickstart.QuickStartServer](https://github.com/alipay/sofa-rpc/blob/master/example/src/test/java/com/alipay/sofa/rpc/quickstart/QuickStartServer.java))ï¼š

```Java
package com.alipay.sofa.rpc.quickstart;

import com.alipay.sofa.rpc.config.ProviderConfig;
import com.alipay.sofa.rpc.config.ServerConfig;

/**
 * Quick Start Server
 */
public class QuickStartServer {

    public static void main(String[] args) {
        ServerConfig serverConfig = new ServerConfig()
            .setProtocol("bolt") // è®¾ç½®ä¸€ä¸ªåè®®ï¼Œé»˜è®¤bolt
            .setPort(12000) // è®¾ç½®ä¸€ä¸ªç«¯å£ï¼Œé»˜è®¤12200
            .setDaemon(false); // éå®ˆæŠ¤çº¿ç¨‹

        ProviderConfig<HelloService> providerConfig = new ProviderConfig<HelloService>()
            .setInterfaceId(HelloService.class.getName()) // æŒ‡å®šæ¥å£
            .setRef(new HelloServiceImpl()) // æŒ‡å®šå®ç°
            .setServer(serverConfig); // æŒ‡å®šæœåŠ¡ç«¯

        providerConfig.export(); // å‘å¸ƒæœåŠ¡
    }
}
```

è¿è¡ŒæœåŠ¡å‘å¸ƒç«¯ç¤ºä¾‹ç±»QuickStartServeræŸ¥çœ‹æä¾›ç«¯è¿è¡Œæ•ˆæœï¼ŒæœåŠ¡æä¾›è€…è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```Java
Connected to the target VM, address: '127.0.0.1:59510', transport: 'socket'
2018-05-14 15:34:11,927 main  INFO [com.alipay.sofa.rpc.context.RpcRuntimeContext:info:102] - Welcome! Loading SOFA RPC Framework : 5.4.0_20180427231325, PID is:1952
2018-05-14 15:34:14,752 main  INFO [com.alipay.sofa.rpc.module.ModuleFactory:info:102] - Install Module: fault-tolerance
2018-05-14 15:34:54,347 main  INFO [com.alipay.sofa.rpc.bootstrap.DefaultProviderBootstrap:infoWithApp:122] - Export provider config : com.alipay.sofa.rpc.quickstart.HelloService: with bean id rpc-cfg-0
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Log4j ]
2018-05-14 15:35:59,083 main  INFO [com.alipay.sofa.common.log:report:30] - Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Log4j ]
```

å‚è€ƒsofa-rpc-boot-projectsèŒƒä¾‹æ¨¡å—([com.alipay.sofa.rpc.samples.annotation](https://github.com/alipay/sofa-rpc-boot-projects/tree/master/sofa-boot-samples/src/main/java/com/alipay/sofa/rpc/samples/annotation))ï¼š

```Java
package com.alipay.sofa.rpc.samples.annotation;

public interface AnnotationService {

    String sayAnnotation(String stirng);

}
package com.alipay.sofa.rpc.samples.annotation;

import com.alipay.sofa.runtime.api.annotation.SofaService;
import com.alipay.sofa.runtime.api.annotation.SofaServiceBinding;
import org.springframework.stereotype.Component;

@SofaService(interfaceType = AnnotationService.class, bindings = { @SofaServiceBinding(bindingType = "bolt") })
@Component
public class AnnotationServiceImpl implements AnnotationService {
    @Override
    public String sayAnnotation(String stirng) {
        return stirng;
    }
}
package com.alipay.sofa.rpc.samples.annotation;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.ImportResource;

@SpringBootApplication
public class AnnotationServerApplication {

    public static void main(String[] args) {

        SpringApplication springApplication = new SpringApplication(AnnotationServerApplication.class);
        ApplicationContext applicationContext = springApplication.run(args);
    }
}
```

è¿è¡ŒæœåŠ¡å‘å¸ƒç«¯èŒƒä¾‹ç±»AnnotationServerApplicationæŸ¥çœ‹æä¾›ç«¯è¿è¡Œæ•ˆæœï¼ŒæœåŠ¡æä¾›è€…è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```Java
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v1.4.2.RELEASE)

Sofa-Middleware-Log SLF4J : Actual logging.path is [ ./logs ]
2018-06-06 00:25:01.856  INFO 14648 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual logging.path is [ ./logs ]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.infra Logback ]
2018-06-06 00:25:02.000  INFO 14648 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.infra Logback ]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.healthcheck Logback ]
2018-06-06 00:25:02.265  INFO 14648 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.healthcheck Logback ]
2018-06-06 00:25:02.512  INFO 14648 --- [           main] c.a.s.r.s.a.AnnotationServerApplication  : Starting AnnotationServerApplication on Program with PID 14648 (D:\Program\Github\sofa-rpc-boot-projects\sofa-boot-samples\target\classes started by Administrator in D:\Program\Github\sofa-rpc-boot-projects)
2018-06-06 00:25:02.514  INFO 14648 --- [           main] c.a.s.r.s.a.AnnotationServerApplication  : No active profile set, falling back to default profiles: default
2018-06-06 00:25:02.836  INFO 14648 --- [           main] ationConfigEmbeddedWebApplicationContext : Refreshing org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@4c12331b: startup date [Wed Jun 06 00:25:02 CST 2018]; root of context hierarchy
2018-06-06 00:25:07.133  INFO 14648 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'com.alipay.sofa.runtime.spring.configuration.SofaRuntimeAutoConfiguration' of type [class com.alipay.sofa.runtime.spring.configuration.SofaRuntimeAutoConfiguration$$EnhancerBySpringCGLIB$$75b40bdf] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:25:07.254  INFO 14648 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'bindingConverterFactory' of type [class com.alipay.sofa.runtime.service.impl.BindingConverterFactoryImpl] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:25:07.292  INFO 14648 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'bindingAdapterFactory' of type [class com.alipay.sofa.runtime.service.impl.BindingAdapterFactoryImpl] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:25:07.311  INFO 14648 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'sofaRuntimeProperties' of type [class com.alipay.sofa.runtime.spring.config.SofaRuntimeProperties] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:25:07.336  INFO 14648 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'sofaRuntimeContext' of type [class com.alipay.sofa.runtime.spi.component.SofaRuntimeContext] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:25:09.229  INFO 14648 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat initialized with port(s): 8080 (http)
2018-06-06 00:25:09.253  INFO 14648 --- [           main] o.apache.catalina.core.StandardService   : Starting service Tomcat
2018-06-06 00:25:09.256  INFO 14648 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/8.5.6
2018-06-06 00:25:10.000  INFO 14648 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2018-06-06 00:25:10.001  INFO 14648 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 7165 ms
2018-06-06 00:25:10.773  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.ServletRegistrationBean  : Mapping servlet: 'dispatcherServlet' to [/]
2018-06-06 00:25:10.785  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'metricsFilter' to: [/*]
2018-06-06 00:25:10.786  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'characterEncodingFilter' to: [/*]
2018-06-06 00:25:10.786  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'hiddenHttpMethodFilter' to: [/*]
2018-06-06 00:25:10.787  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'httpPutFormContentFilter' to: [/*]
2018-06-06 00:25:10.787  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'requestContextFilter' to: [/*]
2018-06-06 00:25:10.787  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'webRequestLoggingFilter' to: [/*]
2018-06-06 00:25:10.788  INFO 14648 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'applicationContextIdFilter' to: [/*]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.runtime Logback ]
2018-06-06 00:25:11.020  INFO 14648 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.runtime Logback ]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc Logback ]
2018-06-06 00:25:11.560  INFO 14648 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc Logback ]
2018-06-06 00:25:12.044  INFO 14648 --- [           main] o.a.c.f.imps.CuratorFrameworkImpl        : Starting
2018-06-06 00:25:12.060  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:zookeeper.version=3.4.6-1569965, built on 02/20/2014 09:09 GMT
2018-06-06 00:25:12.061  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:host.name=Program
2018-06-06 00:25:12.061  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.version=1.8.0_141
2018-06-06 00:25:12.061  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.vendor=Oracle Corporation
2018-06-06 00:25:12.061  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.home=C:\Program Files\Java\jdk1.8.0_141\jre
2018-06-06 00:25:12.062  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.class.path=C:\Program Files\Java\jdk1.8.0_141\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\deploy.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\access-bridge-64.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\cldrdata.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\dnsns.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\jaccess.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\jfxrt.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\localedata.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\nashorn.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunec.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunjce_provider.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunmscapi.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunpkcs11.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\zipfs.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\javaws.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jfxswt.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\management-agent.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\plugin.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\rt.jar;D:\Program\Github\sofa-rpc-boot-projects\sofa-boot-samples\target\classes;D:\Program\Github\sofa-rpc-boot-projects\sofa-boot-starter\target\classes;C:\Users\Administrator\.m2\repository\com\alipay\sofa\sofa-rpc-all\5.4.0\sofa-rpc-all-5.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\bolt\1.4.1\bolt-1.4.1.jar;C:\Users\Administrator\.m2\repository\org\slf4j\slf4j-api\1.7.21\slf4j-api-1.7.21.jar;C:\Users\Administrator\.m2\repository\io\netty\netty-all\4.1.25.Final\netty-all-4.1.25.Final.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\hessian\3.3.0\hessian-3.3.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\tracer-core\2.1.1\tracer-core-2.1.1.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-api\0.22.0\opentracing-api-0.22.0.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-noop\0.22.0\opentracing-noop-0.22.0.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-mock\0.22.0\opentracing-mock-0.22.0.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-util\0.22.0\opentracing-util-0.22.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\lookout\lookout-api\1.4.0\lookout-api-1.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\runtime-sofa-boot-starter\2.4.0\runtime-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-client\2.9.1\curator-client-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-framework\2.9.1\curator-framework-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-recipes\2.9.1\curator-recipes-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-jaxrs\3.0.12.Final\resteasy-jaxrs-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\spec\javax\annotation\jboss-annotations-api_1.1_spec\1.0.1.Final\jboss-annotations-api_1.1_spec-1.0.1.Final.jar;C:\Users\Administrator\.m2\repository\javax\activation\activation\1.1.1\activation-1.1.1.jar;C:\Users\Administrator\.m2\repository\org\apache\httpcomponents\httpclient\4.3.6\httpclient-4.3.6.jar;C:\Users\Administrator\.m2\repository\org\apache\httpcomponents\httpcore\4.3.3\httpcore-4.3.3.jar;C:\Users\Administrator\.m2\repository\commons-logging\commons-logging\1.1.3\commons-logging-1.1.3.jar;C:\Users\Administrator\.m2\repository\commons-codec\commons-codec\1.6\commons-codec-1.6.jar;C:\Users\Administrator\.m2\repository\commons-io\commons-io\2.1\commons-io-2.1.jar;C:\Users\Administrator\.m2\repository\net\jcip\jcip-annotations\1.0\jcip-annotations-1.0.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-client\3.0.12.Final\resteasy-client-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-jackson-provider\3.0.12.Final\resteasy-jackson-provider-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-core-asl\1.9.12\jackson-core-asl-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-mapper-asl\1.9.12\jackson-mapper-asl-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-jaxrs\1.9.12\jackson-jaxrs-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-xc\1.9.12\jackson-xc-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-netty4\3.0.12.Final\resteasy-netty4-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-validator-provider-11\3.0.12.Final\resteasy-validator-provider-11-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\hibernate\hibernate-validator\5.0.1.Final\hibernate-validator-5.0.1.Final.jar;C:\Users\Administrator\.m2\repository\javax\validation\validation-api\1.1.0.Final\validation-api-1.1.0.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\logging\jboss-logging\3.1.1.GA\jboss-logging-3.1.1.GA.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\classmate\0.8.0\classmate-0.8.0.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\jaxrs-api\3.0.12.Final\jaxrs-api-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-multipart-provider\3.0.12.Final\resteasy-multipart-provider-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-jaxb-provider\3.0.12.Final\resteasy-jaxb-provider-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\com\sun\xml\bind\jaxb-impl\2.2.7\jaxb-impl-2.2.7.jar;C:\Users\Administrator\.m2\repository\com\sun\xml\bind\jaxb-core\2.2.7\jaxb-core-2.2.7.jar;C:\Users\Administrator\.m2\repository\javax\xml\bind\jaxb-api\2.2.7\jaxb-api-2.2.7.jar;C:\Users\Administrator\.m2\repository\com\sun\istack\istack-commons-runtime\2.16\istack-commons-runtime-2.16.jar;C:\Users\Administrator\.m2\repository\com\sun\xml\fastinfoset\FastInfoset\1.2.12\FastInfoset-1.2.12.jar;C:\Users\Administrator\.m2\repository\javax\xml\bind\jsr173_api\1.0\jsr173_api-1.0.jar;C:\Users\Administrator\.m2\repository\javax\mail\mail\1.5.0-b01\mail-1.5.0-b01.jar;C:\Users\Administrator\.m2\repository\org\apache\james\apache-mime4j\0.6\apache-mime4j-0.6.jar;C:\Users\Administrator\.m2\repository\javax\el\javax.el-api\2.2.5\javax.el-api-2.2.5.jar;C:\Users\Administrator\.m2\repository\org\glassfish\web\javax.el\2.2.6\javax.el-2.2.6.jar;C:\Users\Administrator\.m2\repository\com\alibaba\dubbo\2.4.10\dubbo-2.4.10.jar;C:\Users\Administrator\.m2\repository\org\jboss\netty\netty\3.2.5.Final\netty-3.2.5.Final.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-beans\4.3.4.RELEASE\spring-beans-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-core\4.3.4.RELEASE\spring-core-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\1.4.2.RELEASE\spring-boot-autoconfigure-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\test-sofa-boot-starter\2.4.0\test-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\healthcheck-sofa-boot-starter\2.4.0\healthcheck-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\infra-sofa-boot-starter\2.4.0\infra-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-context\4.3.4.RELEASE\spring-context-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-aop\4.3.4.RELEASE\spring-aop-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-expression\4.3.4.RELEASE\spring-expression-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot\1.4.2.RELEASE\spring-boot-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-actuator\1.4.2.RELEASE\spring-boot-starter-actuator-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter\1.4.2.RELEASE\spring-boot-starter-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-logging\1.4.2.RELEASE\spring-boot-starter-logging-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\ch\qos\logback\logback-classic\1.1.7\logback-classic-1.1.7.jar;C:\Users\Administrator\.m2\repository\ch\qos\logback\logback-core\1.1.7\logback-core-1.1.7.jar;C:\Users\Administrator\.m2\repository\org\slf4j\jcl-over-slf4j\1.7.21\jcl-over-slf4j-1.7.21.jar;C:\Users\Administrator\.m2\repository\org\slf4j\jul-to-slf4j\1.7.21\jul-to-slf4j-1.7.21.jar;C:\Users\Administrator\.m2\repository\org\slf4j\log4j-over-slf4j\1.7.21\log4j-over-slf4j-1.7.21.jar;C:\Users\Administrator\.m2\repository\org\yaml\snakeyaml\1.17\snakeyaml-1.17.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-actuator\1.4.2.RELEASE\spring-boot-actuator-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-web\1.4.2.RELEASE\spring-boot-starter-web-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\1.4.2.RELEASE\spring-boot-starter-tomcat-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\8.5.6\tomcat-embed-core-8.5.6.jar;C:\Users\Administrator\.m2\repository\org\apache\tomcat\embed\tomcat-embed-el\8.5.6\tomcat-embed-el-8.5.6.jar;C:\Users\Administrator\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\8.5.6\tomcat-embed-websocket-8.5.6.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\jackson\core\jackson-databind\2.8.4\jackson-databind-2.8.4.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\2.8.0\jackson-annotations-2.8.0.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\jackson\core\jackson-core\2.8.4\jackson-core-2.8.4.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-web\4.3.4.RELEASE\spring-web-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-webmvc\4.3.4.RELEASE\spring-webmvc-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\com\alibaba\fastjson\1.2.47\fastjson-1.2.47.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\common\sofa-common-tools\1.0.12\sofa-common-tools-1.0.12.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-test\2.9.1\curator-test-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\apache\zookeeper\zookeeper\3.4.6\zookeeper-3.4.6.jar;C:\Users\Administrator\.m2\repository\log4j\log4j\1.2.16\log4j-1.2.16.jar;C:\Users\Administrator\.m2\repository\jline\jline\0.9.94\jline-0.9.94.jar;C:\Users\Administrator\.m2\repository\io\netty\netty\3.7.0.Final\netty-3.7.0.Final.jar;C:\Users\Administrator\.m2\repository\org\javassist\javassist\3.18.1-GA\javassist-3.18.1-GA.jar;C:\Users\Administrator\.m2\repository\org\apache\commons\commons-math\2.2\commons-math-2.2.jar;C:\Users\Administrator\.m2\repository\com\google\guava\guava\16.0.1\guava-16.0.1.jar;C:\Users\Administrator\.m2\repository\com\101tec\zkclient\0.10\zkclient-0.10.jar;D:\Program\JetBrains\IntelliJ\lib\idea_rt.jar
2018-06-06 00:25:12.066  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.library.path=C:\Program Files\Java\jdk1.8.0_141\bin;C:\WINDOWS\Sun\Java\bin;C:\WINDOWS\system32;C:\WINDOWS;C:\ProgramData\Oracle\Java\javapath;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\Program Files\Java\jdk1.8.0_141\bin;C:\Program Files\Java\jdk1.8.0_141\jre\bin;C:\Program Files\Maven\bin;C:\Program Files (x86)\Git\cmd;C:\Program Files\MySQL\MySQL Utilities 1.6\;C:\Users\Administrator\AppData\Local\Microsoft\WindowsApps;;C:\Program Files\Mercurial;.
2018-06-06 00:25:12.066  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.io.tmpdir=C:\Users\ADMINI~1\AppData\Local\Temp\
2018-06-06 00:25:12.066  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.compiler=<NA>
2018-06-06 00:25:12.067  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:os.name=Windows 10
2018-06-06 00:25:12.067  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:os.arch=amd64
2018-06-06 00:25:12.067  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:os.version=10.0
2018-06-06 00:25:12.067  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:user.name=Administrator
2018-06-06 00:25:12.067  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:user.home=C:\Users\Administrator
2018-06-06 00:25:12.067  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:user.dir=D:\Program\Github\sofa-rpc-boot-projects
2018-06-06 00:25:12.070  INFO 14648 --- [           main] org.apache.zookeeper.ZooKeeper           : Initiating client connection, connectString=127.0.0.1:2181 sessionTimeout=60000 watcher=org.apache.curator.ConnectionState@4d0753c9
2018-06-06 00:25:12.118  INFO 14648 --- [127.0.0.1:2181)] org.apache.zookeeper.ClientCnxn          : Opening socket connection to server 127.0.0.1/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)
2018-06-06 00:25:12.121  INFO 14648 --- [127.0.0.1:2181)] org.apache.zookeeper.ClientCnxn          : Socket connection established to 127.0.0.1/127.0.0.1:2181, initiating session
2018-06-06 00:25:12.265  INFO 14648 --- [127.0.0.1:2181)] org.apache.zookeeper.ClientCnxn          : Session establishment complete on server 127.0.0.1/127.0.0.1:2181, sessionid = 0x10005c434e80000, negotiated timeout = 40000
2018-06-06 00:25:12.277  INFO 14648 --- [ain-EventThread] o.a.c.f.state.ConnectionStateManager     : State change: CONNECTED
2018-06-06 00:25:12.352  WARN 14648 --- [           main] org.apache.curator.utils.ZKPaths         : The version of ZooKeeper being used doesn't support Container nodes. CreateMode.PERSISTENT will be used instead.
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc.boot Logback ]
2018-06-06 00:25:13.094  INFO 14648 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc.boot Logback ]
2018-06-06 00:25:14.686  INFO 14648 --- [           main] s.w.s.m.m.a.RequestMappingHandlerAdapter : Looking for @ControllerAdvice: org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@4c12331b: startup date [Wed Jun 06 00:25:02 CST 2018]; root of context hierarchy
2018-06-06 00:25:14.901  INFO 14648 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped "{[/error]}" onto public org.springframework.http.ResponseEntity<java.util.Map<java.lang.String, java.lang.Object>> org.springframework.boot.autoconfigure.web.BasicErrorController.error(javax.servlet.http.HttpServletRequest)
2018-06-06 00:25:14.904  INFO 14648 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped "{[/error],produces=[text/html]}" onto public org.springframework.web.servlet.ModelAndView org.springframework.boot.autoconfigure.web.BasicErrorController.errorHtml(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)
2018-06-06 00:25:15.002  INFO 14648 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/webjars/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-06 00:25:15.003  INFO 14648 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-06 00:25:15.108  INFO 14648 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**/favicon.ico] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-06 00:25:16.177  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/sofaboot/versions || /sofaboot/versions.json],produces=[application/json]}" onto public java.lang.Object com.alipay.sofa.infra.endpoint.SofaBootVersionEndpointMvcAdapter.invoke()
2018-06-06 00:25:16.183  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/env/{name:.*}],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EnvironmentMvcEndpoint.value(java.lang.String)
2018-06-06 00:25:16.184  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/env || /env.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.186  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/mappings || /mappings.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.188  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/dump || /dump.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.190  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/beans || /beans.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.192  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/info || /info.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.194  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/health || /health.json],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.HealthMvcEndpoint.invoke(java.security.Principal)
2018-06-06 00:25:16.196  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/heapdump || /heapdump.json],methods=[GET],produces=[application/octet-stream]}" onto public void org.springframework.boot.actuate.endpoint.mvc.HeapdumpMvcEndpoint.invoke(boolean,javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse) throws java.io.IOException,javax.servlet.ServletException
2018-06-06 00:25:16.199  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/configprops || /configprops.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.201  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/logfile || /logfile.json],methods=[GET || HEAD]}" onto public void org.springframework.boot.actuate.endpoint.mvc.LogFileMvcEndpoint.invoke(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse) throws javax.servlet.ServletException,java.io.IOException
2018-06-06 00:25:16.211  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/metrics/{name:.*}],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.MetricsMvcEndpoint.value(java.lang.String)
2018-06-06 00:25:16.211  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/metrics || /metrics.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.213  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/trace || /trace.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.215  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/autoconfig || /autoconfig.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:25:16.216  INFO 14648 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/health/readiness || /health/readiness.json],produces=[application/json]}" onto public java.lang.Object com.alipay.sofa.healthcheck.service.SofaBootReadinessCheckMvcEndpoint.invoke(java.security.Principal)
2018-06-06 00:25:16.603  INFO 14648 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup
2018-06-06 00:25:16.684  INFO 14648 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 0
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Logback ]
2018-06-06 00:25:17.592  INFO 14648 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Logback ]
2018-06-06 00:25:19.261  INFO 14648 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)
2018-06-06 00:25:19.313  INFO 14648 --- [           main] c.a.s.r.s.a.AnnotationServerApplication  : Started AnnotationServerApplication in 19.767 seconds (JVM running for 21.37)
```

SOFARPCæœåŠ¡å‘å¸ƒæµç¨‹ï¼š
 (1)åˆ›å»ºæœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ç±»ServerConfigï¼Œè®¾ç½®ServerConfigå®ä¾‹ç›‘å¬ç«¯å£ã€é€šä¿¡åè®®ä»¥åŠæ˜¯å¦ä¸ºå®ˆæŠ¤çº¿ç¨‹(æ˜¯å¦holdä½ç«¯å£ï¼Œtrueçš„è¯éšä¸»çº¿ç¨‹é€€å‡ºè€Œé€€å‡ºï¼Œfalseçš„è¯åˆ™è¦ä¸»åŠ¨é€€å‡º)ç­‰åŸºç¡€é…ç½®ä¿¡æ¯ï¼Œå½“ç„¶ServerConfigé™¤è‡ªå®šä¹‰è®¾ç½®åŸºç¡€é…ç½®ä»¥å¤–ï¼Œç±»åŠ è½½è‡ªåŠ¨åŠ è½½é…ç½®æ–‡ä»¶è·å–æœåŠ¡è¿è¡Œå®¹å™¨é»˜è®¤é…ç½®ï¼š

```Java
/**
 * æœåŠ¡ç«¯é…ç½®
 *
  */
public class ServerConfig extends AbstractIdConfig implements Serializable
```

æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ç±»ServerConfigç»§æ‰¿é»˜è®¤é…ç½®å¸¦IDé…ç½®ç±» AbstractIdConfigï¼ŒæœåŠ¡ç«¯é…ç½®ServerConfigç©ºæ„é€ å™¨æ²¡æœ‰è‡ªåŠ¨åŠ è½½é»˜è®¤é…ç½®ï¼Œå¦‚ä½•å®ç°è‡ªåŠ¨é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½æœåŠ¡ç«¯é»˜è®¤é…ç½®ä¿¡æ¯?é»˜è®¤é…ç½®å¸¦IDç±»AbstractIdConfigé™æ€ä»£ç å—è°ƒç”¨å…¨å±€çš„è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ç±»RpcRuntimeContextçš„now()æ–¹æ³•ï¼Œé€šè¿‡è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ç±»RpcRuntimeContexté™æ€ä»£ç æ¨¡å—åœ¨ç±»åŠ è½½çš„æ—¶å€™è¯»å–é…ç½®æ–‡ä»¶è®¾ç½®æœåŠ¡ç«¯ç±»ServerConfigé»˜è®¤é…ç½®å±æ€§ï¼š

```Java
static {
    RpcRuntimeContext.now();
}
static {
    if (LOGGER.isInfoEnabled()) {
        LOGGER.info("Welcome! Loading SOFA RPC Framework : {}, PID is:{}", Version.BUILD_VERSION, PID);
    }
    put(RpcConstants.CONFIG_KEY_RPC_VERSION, Version.RPC_VERSION);
    // åˆå§‹åŒ–ä¸€äº›ä¸Šä¸‹æ–‡
    initContext();
    // åˆå§‹åŒ–å…¶å®ƒæ¨¡å—
    ModuleFactory.installModules();
    // å¢åŠ jvmå…³é—­äº‹ä»¶
    if (RpcConfigs.getOrDefaultValue(RpcOptions.JVM_SHUTDOWN_HOOK, true)) {
        Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {
            @Override
            public void run() {
                if (LOGGER.isWarnEnabled()) {
                    LOGGER.warn("SOFA RPC Framework catch JVM shutdown event, Run shutdown hook now.");
                }
                destroy(false);
            }
        }, "SOFA-RPC-ShutdownHook"));
    }
}
```

å…¨å±€è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ç±»RpcRuntimeContexté¦–å…ˆåˆå§‹åŒ–ä¸Šä¸‹æ–‡è‡ªåŠ¨éƒ¨ç½²çš„appIdã€appNameã€appInsIdä»¥åŠå½“å‰æ‰€åœ¨æ–‡ä»¶å¤¹åœ°å€appPathä¿¡æ¯ï¼š

```Java
/**
 * åˆå§‹åŒ–ä¸€äº›ä¸Šä¸‹æ–‡
 */
private static void initContext() {
    putIfAbsent(KEY_APPID, RpcConfigs.getOrDefaultValue(APP_ID, null));
    putIfAbsent(KEY_APPNAME, RpcConfigs.getOrDefaultValue(APP_NAME, null));
    putIfAbsent(KEY_APPINSID, RpcConfigs.getOrDefaultValue(INSTANCE_ID, null));
    putIfAbsent(KEY_APPAPTH, System.getProperty("user.dir"));
}
```

å…¶ä¸­é€šè¿‡é…ç½®åŠ è½½å™¨å’Œæ“ä½œå…¥å£RpcConfigsé™æ€ä»£ç å—åœ¨ç±»åŠ è½½çš„æ—¶å€™åŠ è½½rpc-config-default.jsonã€sofa-rpc/rpc-config.jsonã€META-INF/sofa-rpc/rpc-config.jsoné…ç½®æ–‡ä»¶è·å–é»˜è®¤é…ç½®ã€è‡ªå®šä¹‰é…ç½®ä¿¡æ¯è‡ªå®šä¹‰é…ç½®ä¿¡æ¯å­˜å‚¨åœ¨å…¨éƒ¨é…ç½®CFGï¼š

```Java
static {
    init(); // åŠ è½½é…ç½®æ–‡ä»¶
}
private static void init() {
    try {
        // loadDefault
        String json = FileUtils.file2String(RpcConfigs.class, "rpc-config-default.json", "UTF-8");
        Map map = JSON.parseObject(json, Map.class);
        CFG.putAll(map);

        // loadCustom
        loadCustom("sofa-rpc/rpc-config.json");
        loadCustom("META-INF/sofa-rpc/rpc-config.json");

        // load system properties
        CFG.putAll(new HashMap(System.getProperties())); // æ³¨æ„éƒ¨åˆ†å±æ€§å¯èƒ½è¢«è¦†ç›–ä¸ºå­—ç¬¦ä¸²
    } catch (Exception e) {
        throw new SofaRpcRuntimeException("Catch Exception when load RpcConfigs", e);
    }
}
```

æ¥ç€æ‰©å±•åŠ è½½å™¨ExtensionLoaderæ ¹æ®éœ€è¦è¢«åŠ è½½çš„æ¨¡å—åˆ—è¡¨éå†åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½æ¥å®‰è£…æ¨¡æ¿åˆå§‹åŒ–å…¶ä»–æ¨¡å—ï¼š

```Java
/**
 * åŠ è½½å…¨éƒ¨æ¨¡å—
 */
public static void installModules() {
    ExtensionLoader<Module> loader = ExtensionLoaderFactory.getExtensionLoader(Module.class);
    String moduleLoadList = RpcConfigs.getStringValue(RpcOptions.MODULE_LOAD_LIST);
    for (Map.Entry<String, ExtensionClass<Module>> o : loader.getAllExtensions().entrySet()) {
        String moduleName = o.getKey();
        Module module = o.getValue().getExtInstance();
        // judge need load from rpc option
        if (needLoad(moduleLoadList, moduleName)) {
            // judge need load from implement
            if (module.needLoad()) {
                if (LOGGER.isInfoEnabled()) {
                    LOGGER.info("Install Module: {}", moduleName);
                }
                module.install();
                INSTALLED_MODULES.put(moduleName, module);
            } else {
                if (LOGGER.isInfoEnabled()) {
                    LOGGER.info("The module " + moduleName + " does not need to be loaded.");
                }
            }
        } else {
            if (LOGGER.isInfoEnabled()) {
                LOGGER.info("The module " + moduleName + " is not in the module load list.");
            }
        }
    }
}
```

æœ€åæ ¹æ®æ˜¯å¦ä¸»åŠ¨ç›‘å¬JVMå…³é—­äº‹ä»¶(é»˜è®¤ä¸ºtrue)å¢åŠ JVMå…³é—­äº‹ä»¶ç›‘å¬æ‰§è¡Œåæ³¨å†ŒæœåŠ¡ç«¯ï¼Œå…³é—­å¯åŠ¨ç«¯å£ã€å‘å¸ƒæœåŠ¡ã€è°ƒç”¨æœåŠ¡ã€æ³¨å†Œä¸­å¿ƒã€å®¢æˆ·ç«¯å…¬å…±èµ„æºï¼Œå¸è½½æ¨¡å—ã€é’©å­ä»¥åŠæ¸…ç†ç¼“å­˜é”€æ¯æ“ä½œï¼š

```Java
private static void destroy(boolean active) {
     RpcRunningState.setShuttingDown(true);
    for (Destroyable.DestroyHook destroyHook : DESTROY_HOOKS) {
        destroyHook.preDestroy();
    }
    List<ProviderConfig> providerConfigs = new ArrayList<ProviderConfig>();
    for (ProviderBootstrap bootstrap : EXPORTED_PROVIDER_CONFIGS) {
        providerConfigs.add(bootstrap.getProviderConfig());
    }
    // å…ˆåæ³¨å†ŒæœåŠ¡ç«¯
    List<Registry> registries = RegistryFactory.getRegistries();
    if (CommonUtils.isNotEmpty(registries) && CommonUtils.isNotEmpty(providerConfigs)) {
        for (Registry registry : registries) {
            registry.batchUnRegister(providerConfigs);
        }
    }
    // å…³é—­å¯åŠ¨çš„ç«¯å£
    ServerFactory.destroyAll();
    // å…³é—­å‘å¸ƒçš„æœåŠ¡
    for (ProviderBootstrap bootstrap : EXPORTED_PROVIDER_CONFIGS) {
        bootstrap.unExport();
    }
    // å…³é—­è°ƒç”¨çš„æœåŠ¡
    for (ConsumerBootstrap bootstrap : REFERRED_CONSUMER_CONFIGS) {
        ConsumerConfig config = bootstrap.getConsumerConfig();
        if (!CommonUtils.isFalse(config.getParameter(RpcConstants.HIDDEN_KEY_DESTROY))) { // é™¤éä¸è®©ä¸»åŠ¨unrefer
            bootstrap.unRefer();
        }
    }
    // å…³é—­æ³¨å†Œä¸­å¿ƒ
    RegistryFactory.destroyAll();
    // å…³é—­å®¢æˆ·ç«¯çš„ä¸€äº›å…¬å…±èµ„æº
    ClientTransportFactory.closeAll();
    // å¸è½½æ¨¡å—
    if (!RpcRunningState.isUnitTestMode()) {
        ModuleFactory.uninstallModules();
    }
    // å¸è½½é’©å­
    for (Destroyable.DestroyHook destroyHook : DESTROY_HOOKS) {
        destroyHook.postDestroy();
    }
    // æ¸…ç†ç¼“å­˜
    RpcCacheManager.clearAll();
    RpcRunningState.setShuttingDown(false);
    if (LOGGER.isWarnEnabled()) {
        LOGGER.warn("SOFA RPC Framework has been release all resources {}...",
            active ? "actively " : "");
    }
}
```

(2)åˆ›å»ºæœåŠ¡å‘å¸ƒé…ç½®ç±»ProviderConfigï¼Œè®¾ç½®ProviderConfigå®ä¾‹æ¥å£åç§°(æœåŠ¡æ¥å£ï¼šåšä¸ºæœåŠ¡å”¯ä¸€æ ‡è¯†çš„ç»„æˆéƒ¨åˆ†)ã€æ¥å£å®ç°ç±»å¼•ç”¨ä»¥åŠé…ç½®çš„åè®®åˆ—è¡¨å³æŒ‡å®šæœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ï¼š

```Java
/**
 * æœåŠ¡æä¾›è€…é…ç½®
 *
 * @param <T> the type parameter
 */
public class ProviderConfig<T> extends AbstractInterfaceConfig<T, ProviderConfig<T>> implements Serializable
```

æœåŠ¡å‘å¸ƒé…ç½®ç±»ProviderConfigç»§æ‰¿æ¥å£çº§å…¬å…±é…ç½®ç±»AbstractInterfaceConfigï¼Œèƒ½å¤Ÿé€šè¿‡é›†æˆçš„æ³¨å†Œä¸­å¿ƒæ›´æ–°æœåŠ¡å‘å¸ƒæ¥å£çº§åˆ«é…ç½®ä¾‹å¦‚è¶…æ—¶æ—¶é—´ã€æƒé‡ç­‰ã€‚
 (3)æœåŠ¡å‘å¸ƒé…ç½®ç±»ProviderConfigè´Ÿè´£åŠ è½½æ›´æ–°æœåŠ¡å‘å¸ƒæ¥å£çº§é…ç½®ï¼Œæ ¹æ®é¢å‘å¯¹è±¡å•ä¸€èŒè´£åŸåˆ™ï¼Œéœ€è¦ç»‘å®šæœåŠ¡æä¾›è€…å¯åŠ¨ç±»ProviderBootstrapè¿›è¡Œå‘å¸ƒæœåŠ¡ï¼š

```Java
/**
 * å‘å¸ƒæœåŠ¡
 */
public synchronized void export() {
    if (providerBootstrap == null) {
        providerBootstrap = Bootstraps.from(this);
    }
    providerBootstrap.export();
}
```

é¦–å…ˆåˆ¤æ–­æœåŠ¡æä¾›è€…å¯åŠ¨ç±»ProviderBootstrapæ˜¯å¦ä¸ºç©ºï¼Œé€šè¿‡å‘å¸ƒæœåŠ¡è¾…åŠ©å·¥å…·ç±»Bootstrapsæ ¹æ®ç»‘å®šæœåŠ¡å‘å¸ƒé…ç½®æ‰©å±•åŠ è½½å·¥å‚ExtensionLoaderFactoryåŠ è½½åˆå§‹åŒ–ProviderBootstrapå®ä¾‹ï¼š

```
/**
 * å‘å¸ƒä¸€ä¸ªæœåŠ¡
 *
 * @param providerConfig æœåŠ¡å‘å¸ƒè€…é…ç½®
 * @param <T>            æ¥å£ç±»å‹
 * @return å‘å¸ƒå¯åŠ¨ç±»
 */
public static <T> ProviderBootstrap<T> from(ProviderConfig<T> providerConfig) {
    String bootstrap = providerConfig.getBootstrap();
    if (StringUtils.isEmpty(bootstrap)) {
        // Use default provider bootstrap
        bootstrap = RpcConfigs.getStringValue(RpcOptions.DEFAULT_PROVIDER_BOOTSTRAP);
        providerConfig.setBootstrap(bootstrap);
    }
    ProviderBootstrap providerBootstrap = ExtensionLoaderFactory.getExtensionLoader(ProviderBootstrap.class)
        .getExtension(bootstrap, new Class[] { ProviderConfig.class }, new Object[] { providerConfig });
    return (ProviderBootstrap<T>) providerBootstrap;
}
```

æ¥ç€å‘å¸ƒæœåŠ¡åŒ…è£…ç±»ProviderBootstrapé€šè¿‡export()æ–¹æ³•å‘å¸ƒæœåŠ¡ï¼ŒProviderBootstrapåŸºäºBoltã€Restã€Dubboç½‘ç»œé€šä¿¡åè®®æä¾›ä¸‰ç§åè®®æœåŠ¡å‘å¸ƒå®ç°ç±»ï¼šBoltProviderBootstrapã€RestProviderBootstrapä»¥åŠDubboProviderBootstrapã€‚é»˜è®¤æœåŠ¡æä¾›è€…å¯åŠ¨å™¨DefaultProviderBootstrapå‘å¸ƒæœåŠ¡export()æ–¹æ³•é¦–å…ˆåˆ¤æ–­æœåŠ¡å‘å¸ƒå»¶è¿Ÿæ—¶é—´é…ç½®(é»˜è®¤0ï¼Œé…ç½®ä¸º-1ä»£è¡¨SpringåŠ è½½å®Œæ¯•)æ˜¯å¦å¤§äº0ï¼Œå¯åŠ¨çº¿ç¨‹ç¡çœ æŒ‡å®šå»¶è¿Ÿæ—¶é—´å»¶è¿ŸåŠ è½½ï¼Œæ¥ç€è°ƒç”¨doExport()æ–¹æ³•æ‰§è¡ŒSOFARPCå‘å¸ƒæœåŠ¡é€»è¾‘ï¼š

```Java
public void export() {
    if (providerConfig.getDelay() > 0) { // å»¶è¿ŸåŠ è½½,å•ä½æ¯«ç§’
        Thread thread = factory.newThread(new Runnable() {
            @Override
            public void run() {
                try {
                    Thread.sleep(providerConfig.getDelay());
                } catch (Throwable ignore) { // NOPMD
                }
                doExport();
            }
        });
        thread.start();
    } else {
        doExport();
    }
}
private void doExport() {
    if (exported) {
        return;
    }
    String key = providerConfig.buildKey();
    String appName = providerConfig.getAppName();
    // æ£€æŸ¥å‚æ•°
    checkParameters();
    if (LOGGER.isInfoEnabled(appName)) {
        LOGGER.infoWithApp(appName, "Export provider config : {} with bean id {}", key, providerConfig.getId());
    }

    // æ³¨æ„åŒä¸€interfaceï¼ŒåŒä¸€uniqleIdï¼Œä¸åŒserveræƒ…å†µ
    AtomicInteger cnt = EXPORTED_KEYS.get(key); // è®¡æ•°å™¨
    if (cnt == null) { // æ²¡æœ‰å‘å¸ƒè¿‡
        cnt = CommonUtils.putToConcurrentMap(EXPORTED_KEYS, key, new AtomicInteger(0));
    }
    int c = cnt.incrementAndGet();
    int maxProxyCount = providerConfig.getRepeatedExportLimit();
    if (maxProxyCount > 0) {
        if (c > maxProxyCount) {
            cnt.decrementAndGet();
            // è¶…è¿‡æœ€å¤§æ•°é‡ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
            throw new SofaRpcRuntimeException("Duplicate provider config with key " + key
                + " has been exported more than " + maxProxyCount + " times!"
                + " Maybe it's wrong config, please check it."
                + " Ignore this if you did that on purpose!");
        } else if (c > 1) {
            if (LOGGER.isInfoEnabled(appName)) {
                LOGGER.infoWithApp(appName, "Duplicate provider config with key {} has been exported!"
                    + " Maybe it's wrong config, please check it."
                    + " Ignore this if you did that on purpose!", key);
            }
        }
    }

    try {
        // æ„é€ è¯·æ±‚è°ƒç”¨å™¨
        providerProxyInvoker = new ProviderProxyInvoker(providerConfig);
        // åˆå§‹åŒ–æ³¨å†Œä¸­å¿ƒ
        if (providerConfig.isRegister()) {
            List<RegistryConfig> registryConfigs = providerConfig.getRegistry();
            if (CommonUtils.isNotEmpty(registryConfigs)) {
                for (RegistryConfig registryConfig : registryConfigs) {
                    RegistryFactory.getRegistry(registryConfig); // æå‰åˆå§‹åŒ–Registry
                }
            }
        }
        // å°†å¤„ç†å™¨æ³¨å†Œåˆ°server
        List<ServerConfig> serverConfigs = providerConfig.getServer();
        for (ServerConfig serverConfig : serverConfigs) {
            try {
                Server server = serverConfig.buildIfAbsent();
                // æ³¨å†Œåºåˆ—åŒ–æ¥å£
                server.registerProcessor(providerConfig, providerProxyInvoker);
                if (serverConfig.isAutoStart()) {
                    server.start();
                }
            } catch (SofaRpcRuntimeException e) {
                throw e;
            } catch (Exception e) {
                LOGGER.errorWithApp(appName, "Catch exception when register processor to server: "
                    + serverConfig.getId(), e);
            }
        }

        // æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
        providerConfig.setConfigListener(new ProviderAttributeListener());
        register();
    } catch (Exception e) {
        cnt.decrementAndGet();
        if (e instanceof SofaRpcRuntimeException) {
            throw (SofaRpcRuntimeException) e;
        } else {
            throw new SofaRpcRuntimeException("Build provider proxy error!", e);
        }
    }

    // è®°å½•ä¸€äº›ç¼“å­˜æ•°æ®
    RpcRuntimeContext.cacheProviderConfig(this);
    exported = true;
}
```

é»˜è®¤æœåŠ¡æä¾›è€…å¯åŠ¨å™¨DefaultProviderBootstrapå‘å¸ƒæœåŠ¡doExport()æ–¹æ³•æ‰§è¡Œé€»è¾‘ï¼š
 (1)æ ¹æ®æœåŠ¡å‘å¸ƒé…ç½®ProviderConfigè·å–æœåŠ¡æ¥å£ã€æœåŠ¡æ ‡ç­¾æ„å»ºkeyä»¥åŠè·å–åº”ç”¨åç§°appNameï¼›
 (2)è°ƒç”¨checkParameters()æ–¹æ³•æ£€æŸ¥å‚æ•°ï¼ŒåŒ…æ‹¬æ£€æŸ¥æ³¨å…¥çš„refæ˜¯å¦æ¥å£å®ç°ç±»ã€æ£€æŸ¥æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®æ˜¯å¦ä¸ºç©ºã€æ£€æŸ¥æ–¹æ³•åŠå…¶é»‘ç™½åå•ï¼š

```Java
/**
 * for check fields and parameters of consumer config
 */
protected void checkParameters() {
    // æ£€æŸ¥æ³¨å…¥çš„refæ˜¯å¦æ¥å£å®ç°ç±»
    Class proxyClass = providerConfig.getProxyClass();
    String key = providerConfig.buildKey();
    T ref = providerConfig.getRef();
    if (!proxyClass.isInstance(ref)) {
        throw ExceptionUtils.buildRuntime("provider.ref",
            ref == null ? "null" : ref.getClass().getName(),
            "This is not an instance of " + providerConfig.getInterfaceId()
                + " in provider config with key " + key + " !");
    }
    // server ä¸èƒ½ä¸ºç©º
    if (CommonUtils.isEmpty(providerConfig.getServer())) {
        throw ExceptionUtils.buildRuntime("server", "NULL", "Value of \"server\" is not specified in provider" +
            " config with key " + key + " !");
    }
    checkMethods(proxyClass);
}
/**
 * æ£€æŸ¥æ–¹æ³•ï¼Œä¾‹å¦‚æ–¹æ³•åã€å¤šæ€ï¼ˆé‡è½½ï¼‰æ–¹æ³•
 *
 * @param itfClass æ¥å£ç±»
 */
protected void checkMethods(Class<?> itfClass) {
    ConcurrentHashMap<String, Boolean> methodsLimit = new ConcurrentHashMap<String, Boolean>();
    for (Method method : itfClass.getMethods()) {
        String methodName = method.getName();
        if (methodsLimit.containsKey(methodName)) {
            // é‡åçš„æ–¹æ³•
            if (LOGGER.isWarnEnabled(providerConfig.getAppName())) {
                LOGGER.warnWithApp(providerConfig.getAppName(), "Method with same name \"" + itfClass.getName()
                    + "." + methodName + "\" exists ! The usage of overloading method in rpc is deprecated.");
            }
        }
        // åˆ¤æ–­æœåŠ¡ä¸‹æ–¹æ³•çš„é»‘ç™½åå•
        Boolean include = methodsLimit.get(methodName);
        if (include == null) {
            include = inList(providerConfig.getInclude(), providerConfig.getExclude(), methodName); // æ£€æŸ¥æ˜¯å¦åœ¨é»‘ç™½åå•ä¸­
            methodsLimit.putIfAbsent(methodName, include);
        }
        providerConfig.setMethodsLimit(methodsLimit);
    }
}
```

(3)æ£€éªŒåŒä¸€ä¸ªæœåŠ¡(æœåŠ¡æ¥å£&æœåŠ¡æ ‡ç­¾ç›¸åŒ)çš„å‘å¸ƒæ¬¡æ•°æ˜¯å¦è¶…è¿‡æœåŠ¡å¼•ç”¨é…ç½®çš„æœ€å¤§æ¬¡æ•°ï¼Œè¶…è¿‡æœ€å¤§æ•°é‡ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼›
 (4)æ ¹æ®æœåŠ¡å‘å¸ƒé…ç½®æ„é€ è¯·æ±‚è°ƒç”¨å™¨ProviderProxyInvokerï¼Œæ„é€ æœåŠ¡ç«¯è°ƒç”¨é“¾æœ€åº•å±‚æ˜¯è°ƒç”¨è¿‡æ»¤å™¨æ‰§è¡Œé“¾filterChainï¼š

```Java
/**
 * æ„é€ æ‰§è¡Œé“¾
 *
 * @param providerConfig æœåŠ¡ç«¯é…ç½®
 */
public ProviderProxyInvoker(ProviderConfig providerConfig) {
    this.providerConfig = providerConfig;
    // æœ€åº•å±‚æ˜¯è°ƒç”¨è¿‡æ»¤å™¨
    this.filterChain = FilterChain.buildProviderChain(providerConfig,
        new ProviderInvoker(providerConfig));
}
```

æœåŠ¡ç«¯è°ƒç”¨é“¾å…¥å£ProviderProxyInvokeræ ¹æ®æœåŠ¡å‘å¸ƒé…ç½®é€šè¿‡æœåŠ¡ç«¯è°ƒç”¨ä¸šåŠ¡å®ç°ç±»ProviderInvokeråˆå§‹åŒ–è¿‡æ»¤å™¨åŒ…è£…Invokerå¯¹è±¡(éš”ç¦»Filterå’ŒServiceçš„å…³ç³»ï¼Œfilteræ˜¯å•ä¾‹)æŒ‡å®šæ— éœ€ä¸‹ä¸€å±‚è¿‡æ»¤å™¨ï¼ŒæŒ‰ç…§è‡ªåŠ¨è£…è½½æ‰©å±•å®ç°é€»è¾‘ï¼Œè·å–ç”¨æˆ·newå®ä¾‹æ–¹å¼æ³¨å…¥çš„è¿‡æ»¤å™¨(ä¼˜å…ˆçº§é«˜)ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ’é™¤ç³»ç»Ÿè¿‡æ»¤å™¨ï¼Œè§£æç”¨æˆ·é€šè¿‡åˆ«åæ–¹å¼æ³¨å…¥çš„è¿‡æ»¤å™¨å‡†å¤‡æ•°æ®ï¼Œè§£æè‡ªåŠ¨åŠ è½½çš„è¿‡æ»¤å™¨åŠ å…¥è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨æ„é€ æ‰§è¡Œé“¾ï¼š

```Java
/**
 * æ„é€ æœåŠ¡ç«¯çš„æ‰§è¡Œé“¾
 *
 * @param providerConfig provideré…ç½®
 * @param lastFilter     æœ€åä¸€ä¸ªfilter
 * @return filteræ‰§è¡Œé“¾
 */
public static FilterChain buildProviderChain(ProviderConfig<?> providerConfig, FilterInvoker lastFilter) {
    /*
     * ä¾‹å¦‚è‡ªåŠ¨è£…è½½æ‰©å±• A(a),B(b),C(c)  filter=[-a,d]  filterRef=[new E, new Exclude(b)]
     * é€»è¾‘å¦‚ä¸‹ï¼š
     * 1.è§£æconfig.getFilterRef()ï¼Œè®°å½•Eå’Œ-b
     * 2.è§£æconfig.getFilter()å­—ç¬¦ä¸²ï¼Œè®°å½• d å’Œ -a,-b
     * 3.å†è§£æè‡ªåŠ¨è£…è½½æ‰©å±•ï¼Œa,bè¢«æ’é™¤äº†ï¼Œæ‰€ä»¥æ‹¿åˆ°c,d
     * 4.å¯¹c dè¿›è¡Œæ’åº
     * 5.æ‹¿åˆ°Cã€Då®ç°ç±»
     * 6.åŠ ä¸Šè‡ªå®šä¹‰ï¼Œè¿”å›Cã€Dã€E
     */
    // ç”¨æˆ·é€šè¿‡è‡ªå·±newå®ä¾‹çš„æ–¹å¼æ³¨å…¥çš„filterï¼Œä¼˜å…ˆçº§é«˜
    List<Filter> customFilters = providerConfig.getFilterRef() == null ?
        new ArrayList<Filter>() : new CopyOnWriteArrayList<Filter>(providerConfig.getFilterRef());
    // å…ˆè§£ææ˜¯å¦æœ‰ç‰¹æ®Šå¤„ç†
    HashSet<String> excludes = parseExcludeFilter(customFilters);

    // å‡†å¤‡æ•°æ®ï¼šç”¨æˆ·é€šè¿‡åˆ«åçš„æ–¹å¼æ³¨å…¥çš„filterï¼Œéœ€è¦è§£æ
    List<ExtensionClass<Filter>> extensionFilters = new ArrayList<ExtensionClass<Filter>>();
    List<String> filterAliases = providerConfig.getFilter(); //
    if (CommonUtils.isNotEmpty(filterAliases)) {
        for (String filterAlias : filterAliases) {
            if (startsWithExcludePrefix(filterAlias)) { // æ’é™¤ç”¨çš„ç‰¹æ®Šå­—ç¬¦
                excludes.add(filterAlias.substring(1));
            } else {
                ExtensionClass<Filter> filter = EXTENSION_LOADER.getExtensionClass(filterAlias);
                if (filter != null) {
                    extensionFilters.add(filter);
                }
            }
        }
    }
    // è§£æè‡ªåŠ¨åŠ è½½çš„è¿‡æ»¤å™¨
    if (!excludes.contains(StringUtils.ALL) && !excludes.contains(StringUtils.DEFAULT)) { // é…äº†-*å’Œ-defaultè¡¨ç¤ºä¸åŠ è½½å†…ç½®
        for (Map.Entry<String, ExtensionClass<Filter>> entry : PROVIDER_AUTO_ACTIVES.entrySet()) {
            if (!excludes.contains(entry.getKey())) {
                extensionFilters.add(entry.getValue());
            }
        }
    }
    excludes = null; // ä¸éœ€è¦äº†
    // æŒ‰orderä»å°åˆ°å¤§æ’åº
    if (extensionFilters.size() > 1) {
        Collections.sort(extensionFilters, new OrderedComparator<ExtensionClass<Filter>>());
    }
    List<Filter> actualFilters = new ArrayList<Filter>();
    for (ExtensionClass<Filter> extensionFilter : extensionFilters) {
        actualFilters.add(extensionFilter.getExtInstance());
    }
    // åŠ å…¥è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨
    actualFilters.addAll(customFilters);
    return new FilterChain(actualFilters, lastFilter, providerConfig);
}
/**
 * æ„é€ æ‰§è¡Œé“¾
 *
 * @param filters     åŒ…è£…è¿‡æ»¤å™¨åˆ—è¡¨
 * @param lastInvoker æœ€ç»ˆè¿‡æ»¤å™¨
 * @param config      æ¥å£é…ç½®
 */
protected FilterChain(List<Filter> filters, FilterInvoker lastInvoker, AbstractInterfaceConfig config) {
    // è°ƒç”¨è¿‡ç¨‹å¤–é¢åŒ…è£…å¤šå±‚è‡ªå®šä¹‰filter
    // å‰é¢çš„è¿‡æ»¤å™¨åœ¨æœ€å¤–å±‚
    invokerChain = lastInvoker;
    if (CommonUtils.isNotEmpty(filters)) {
        loadedFilters = new ArrayList<Filter>();
        for (int i = filters.size() - 1; i >= 0; i--) {
            try {
                Filter filter = filters.get(i);
                if (filter.needToLoad(invokerChain)) {
                    invokerChain = new FilterInvoker(filter, invokerChain, config);
                    // cache this for filter when async respond
                    loadedFilters.add(filter);
                }
            } catch (Exception e) {
                LOGGER.error("Error when build filter chain", e);
                throw new SofaRpcRuntimeException("Error when build filter chain", e);
            }
        }
    }
}
```

(5)åˆ¤æ–­æœåŠ¡é…ç½®æ˜¯å¦æ³¨å†Œæå‰åˆå§‹åŒ–æ³¨å†Œä¸­å¿ƒï¼Œæ³¨å†Œä¸­å¿ƒé…ç½®ç±»RegistryConfigæ ¹æ®æ³¨å†Œä¸­å¿ƒé…ç½®è·å–æ³¨å†Œä¸­å¿ƒå®ç°ç±»Registryå®ä¾‹ï¼Œæ³¨å†Œä¸­å¿ƒå®ç°ç±»RegistryåŒ…æ‹¬åŸºäºæœ¬åœ°æ–‡ä»¶æ³¨å†Œä¸­å¿ƒLocalRegistryå’ŒåŸºäºZookeeperåˆ†å¸ƒå¼åè°ƒç³»ç»Ÿæ³¨å†Œä¸­å¿ƒZookeeperRegistryï¼š

```Java
/**
 * å¾—åˆ°æ³¨å†Œä¸­å¿ƒå¯¹è±¡
 *
 * @param registryConfig RegistryConfigç±»
 * @return Registryå®ç°
 */
public static synchronized Registry getRegistry(RegistryConfig registryConfig) {
    if (ALL_REGISTRIES.size() > 3) { // è¶…è¿‡3æ¬¡ æ˜¯ä¸æ˜¯é…é”™äº†ï¼Ÿ
        if (LOGGER.isWarnEnabled()) {
            LOGGER.warn("Size of registry is greater than 3, Please check it!");
        }
    }
    try {
        // æ³¨æ„ï¼šRegistryConfigé‡å†™äº†equalsæ–¹æ³•ï¼Œå¦‚æœå¤šä¸ªRegistryConfigå±æ€§ä¸€æ ·ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªå¯¹è±¡
        Registry registry = ALL_REGISTRIES.get(registryConfig);
        if (registry == null) {
            ExtensionClass<Registry> ext = ExtensionLoaderFactory.getExtensionLoader(Registry.class)
                .getExtensionClass(registryConfig.getProtocol());
            if (ext == null) {
                throw ExceptionUtils.buildRuntime("registry.protocol", registryConfig.getProtocol(),
                    "Unsupported protocol of registry config !");
            }
            registry = ext.getExtInstance(new Class[] { RegistryConfig.class }, new Object[] { registryConfig });
            ALL_REGISTRIES.put(registryConfig, registry);
        }
        return registry;
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException(e.getMessage(), e);
    }
}
```

(6)æ ¹æ®æœåŠ¡å‘å¸ƒé…ç½®ProviderConfigè·å–æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®åˆ—è¡¨ï¼Œéå†æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®æ„å»ºå¯åŠ¨æœåŠ¡è¿è¡Œå®¹å™¨Serverå®ä¾‹ï¼ŒæœåŠ¡è¿è¡Œå®¹å™¨ServeråŒ…æ‹¬åŸºäºBoltåè®®çš„BoltServerå’ŒåŸºäºReståè®®çš„RestServerï¼š

```
/**
 * å¯åŠ¨æœåŠ¡
 *
 * @return the server
 */
public synchronized Server buildIfAbsent() {
    if (server != null) {
        return server;
    }
    // æå‰æ£€æŸ¥åè®®+åºåˆ—åŒ–æ–¹å¼
    // ConfigValueHelper.check(ProtocolType.valueOf(getProtocol()),
    //                SerializationType.valueOf(getSerialization()));

    server = ServerFactory.getServer(this);
    return server;
}
```

é€šè¿‡æœåŠ¡è¿è¡Œå®¹å™¨å·¥å‚ServerFactoryçš„getServer()æ–¹æ³•è·å–å¯åŠ¨åŸºäºå½“å‰æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ServerConfigçš„æœåŠ¡ç«¯Serverå®ä¾‹ï¼Œé¦–å…ˆæŒ‰ç…§æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ç¡®å®šæœåŠ¡ç«¯Serverçš„Hostå’ŒPortï¼Œæ‰©å±•åŠ è½½å™¨å·¥å‚ExtensionLoaderFactoryç”ŸæˆæœåŠ¡è¿è¡Œå®¹å™¨Serverå®ä¾‹ï¼Œåˆå§‹åŒ–å¯åŠ¨æœåŠ¡ç«¯Serverï¼Œç¼“å­˜æœåŠ¡ç«¯Serveråˆ°SERVER_MAPï¼š

```Java
/**
 * åˆå§‹åŒ–Serverå®ä¾‹
 *
 * @param serverConfig æœåŠ¡ç«¯é…ç½®
 * @return Server
 */
public synchronized static Server getServer(ServerConfig serverConfig) {
    try {
        Server server = SERVER_MAP.get(Integer.toString(serverConfig.getPort()));
        if (server == null) {
            // ç®—ä¸‹ç½‘å¡å’Œç«¯å£
            resolveServerConfig(serverConfig);

            ExtensionClass<Server> ext = ExtensionLoaderFactory.getExtensionLoader(Server.class)
                .getExtensionClass(serverConfig.getProtocol());
            if (ext == null) {
                throw ExceptionUtils.buildRuntime("server.protocol", serverConfig.getProtocol(),
                    "Unsupported protocol of server!");
            }
            server = ext.getExtInstance();
            server.init(serverConfig);
            SERVER_MAP.put(serverConfig.getPort() + "", server);
        }
        return server;
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException(e.getMessage(), e);
    }
}
```

é»˜è®¤æœåŠ¡è¿è¡Œå®¹å™¨BoltServerå¯åŠ¨Serverç«¯è®¾ç½®æœåŠ¡è¿è¡Œå®¹å™¨é…ç½®å¼•ç”¨ï¼ŒæŒ‰ç…§æœåŠ¡ç«¯ä¸šåŠ¡çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€çº¿ç¨‹é˜Ÿåˆ—ä»¥åŠå›æ”¶æ—¶é—´é…ç½®åˆå§‹åŒ–ä¸šåŠ¡çº¿ç¨‹æ± æä¾›ç»™RpcHandler å¤„ç†å¤æ‚ä¸šåŠ¡ä½¿ç”¨ï¼Œä¸ä¼šå½±å“Netty IOçº¿ç¨‹è¿è¡Œã€‚æ ¹æ®æœåŠ¡è¿è¡Œå®¹å™¨BoltServeråˆ›å»ºBoltServerProcessorå¤„ç†å™¨å¹¶ä¸”æ”¯æŒè‡ªå®šä¹‰ä¸šåŠ¡çº¿ç¨‹æ± ï¼ŒBoltServerProcessorå¤„ç†å™¨ç»§æ‰¿AbstractUserProcessorç±»å®ç°UserProcessoræ¥å£ï¼Œå½“è°ƒç”¨RpcHandlerå¤„ç†å™¨çš„channelRead(ChannelHandlerContext ctx, Object msg)æ–¹æ³•æ—¶å€™ï¼Œæ ¹æ®è¯·æ±‚ç±»åç§°è·å–å¯¹åº”çš„UserProcessoræ‰§è¡ŒhandleRequest(BizContext bizCtx, AsyncContext asyncCtx, SofaRequest request)æ–¹æ³•æŸ¥æ‰¾æœåŠ¡è°ƒç”¨å™¨ã€è¯·æ±‚æ–¹æ³•å®æ–½è°ƒç”¨æ–¹æ³•å¤„ç†è¯·æ±‚ï¼š

```Java
public void init(ServerConfig serverConfig) {
    this.serverConfig = serverConfig;
    // å¯åŠ¨çº¿ç¨‹æ± 
    bizThreadPool = initThreadPool(serverConfig);
    boltServerProcessor = new BoltServerProcessor(this);
}
protected ThreadPoolExecutor initThreadPool(ServerConfig serverConfig) {
    ThreadPoolExecutor threadPool = BusinessPool.initPool(serverConfig);
    threadPool.setThreadFactory(new NamedThreadFactory(
        "BOLT-BIZ-" + serverConfig.getPort(), serverConfig.isDaemon()));
    threadPool.setRejectedExecutionHandler(new SofaRejectedExecutionHandler());
    if (serverConfig.isPreStartCore()) { // åˆå§‹åŒ–æ ¸å¿ƒçº¿ç¨‹æ± 
        threadPool.prestartAllCoreThreads();
    }
    return threadPool;
}
/**
 * Construct
 *
 * @param boltServer æ‰€åœ¨çš„Server
 */
public BoltServerProcessor(BoltServer boltServer) {
    this.boltServer = boltServer;
    this.executorSelector = new UserThreadPoolSelector(); // æ”¯æŒè‡ªå®šä¹‰ä¸šåŠ¡çº¿ç¨‹æ± 
}
/**
 * Bolt server processor of bolt server.
 *
 */
public class BoltServerProcessor extends AsyncUserProcessor<SofaRequest>{...}
public abstract class AsyncUserProcessor<T> extends AbstractUserProcessor<T>{...}
public abstract class AbstractUserProcessor<T> implements UserProcessor<T>{...}
public void process(RemotingContext ctx, RpcRequestCommand cmd, ExecutorService defaultExecutor) throws Exception {
    if (this.deserializeRequestCommand(ctx, cmd, 0)) {
        UserProcessor userProcessor = ctx.getUserProcessor(cmd.getRequestClass());
        if (userProcessor == null) {
            String errMsg = "No user processor found for request: " + cmd.getRequestClass();
            logger.error(errMsg);
            this.sendResponseIfNecessary(ctx, cmd.getType(), this.getCommandFactory().createExceptionResponse(cmd.getId(), errMsg));
        } else {
            ctx.setTimeoutDiscard(userProcessor.timeoutDiscard());
            if (userProcessor.processInIOThread()) {
                if (this.deserializeRequestCommand(ctx, cmd, 2)) {
                    (new RpcRequestProcessor.ProcessTask(ctx, cmd)).run();
                }
            } else {
                Executor executor = null;
                if (null == userProcessor.getExecutorSelector()) {
                    executor = userProcessor.getExecutor();
                } else {
                    if (!this.deserializeRequestCommand(ctx, cmd, 1)) {
                        return;
                    }

                    executor = userProcessor.getExecutorSelector().select(cmd.getRequestClass(), cmd.getRequestHeader());
                }

                if (executor == null) {
                    executor = this.getExecutor() == null ? defaultExecutor : this.getExecutor();
                }

                ((Executor)executor).execute(new RpcRequestProcessor.ProcessTask(ctx, cmd));
            }
        }
    }
}

```





 ä»€ä¹ˆæ—¶å€™è°ƒç”¨BoltServerProcessorå¤„ç†å™¨handleRequestæ–¹æ³•æ‰§è¡Œæ–¹æ³•è°ƒç”¨å¤„ç†è¯·æ±‚ï¼ŸæŸ¥çœ‹BoltServerProcessorå¤„ç†å™¨handleRequestæ–¹æ³•è°ƒç”¨é“¾ï¼š



![img](https:////upload-images.jianshu.io/upload_images/6739367-5e646973186fc28d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

BoltServerProcessorå¤„ç†å™¨handleRequestæ–¹æ³•è°ƒç”¨é“¾



 BoltServerProcessorå¤„ç†å™¨handleRequestæ–¹æ³•è°ƒç”¨é“¾é¡¶ç«¯æ˜¯é€šè¿‡RpcRequestProcessorå¤„ç†å™¨ProcessTaskå¤„ç†ä»»åŠ¡è°ƒç”¨ï¼ŒProcessTaskä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± å¤„ç†ï¼ŒæŸ¥çœ‹ProcessTaskæ„é€ æ–¹æ³•è°ƒç”¨é“¾ï¼š



![img](https:////upload-images.jianshu.io/upload_images/6739367-df15ea374be3d9c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

ProcessTaskæ„é€ æ–¹æ³•è°ƒç”¨é“¾

ProcessTaskæ„é€ æ–¹æ³•è°ƒç”¨é“¾é¡¶ç«¯æ˜¯é€šè¿‡RpcHandlerå¤„ç†å™¨çš„channelReadæ–¹æ³•å°†æ¶ˆæ¯åˆ†å‘ç»™ç›¸åº”çš„åè®®ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨é»˜è®¤æœåŠ¡ç«¯BoltServerä¸šåŠ¡çº¿ç¨‹æ± bizThreadPoolå¤„ç†å¤æ‚ä¸šåŠ¡ï¼ŸæŸ¥çœ‹BoltServeræœåŠ¡ç«¯getBizThreadPoolæ–¹æ³•è°ƒç”¨é“¾ï¼š



![img](https:////upload-images.jianshu.io/upload_images/6739367-6106117509cba70d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

BoltServeræœåŠ¡ç«¯getBizThreadPoolæ–¹æ³•è°ƒç”¨é“¾

BoltServeræœåŠ¡ç«¯getBizThreadPoolæ–¹æ³•æœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡RpcHandlerå¤„ç†å™¨çš„channelReadæ–¹æ³•è°ƒç”¨ï¼Œå³è·å–æœåŠ¡ç«¯BoltServerä¸šåŠ¡çº¿ç¨‹æ± bizThreadPoolï¼Œæäº¤RpcRequestProcessorå¤„ç†å™¨ProcessTaskä»»åŠ¡ï¼Œæ‰§è¡ŒBoltServerProcessorå¤„ç†å™¨handleRequestæ–¹æ³•å¤„ç†è¯·æ±‚ã€‚

(7)æœåŠ¡ç«¯Serverå®ä¾‹æ³¨å†ŒæœåŠ¡æä¾›è€…é…ç½®ã€æœåŠ¡ç«¯è°ƒç”¨å®ç°ï¼Œé»˜è®¤æœåŠ¡è¿è¡Œå®¹å™¨BoltServerç¼“å­˜æœåŠ¡ç«¯è°ƒç”¨Invokerå¯¹è±¡åˆ°æ¥å£--> Invokeræ˜ å°„invokerMapä»¥åŠæœåŠ¡å‘å¸ƒæ¥å£æ–¹æ³•ï¼š

```Java
public void registerProcessor(ProviderConfig providerConfig, Invoker instance) {
    // ç¼“å­˜Invokerå¯¹è±¡
    String key = ConfigUniqueNameGenerator.getUniqueName(providerConfig);
    invokerMap.put(key, instance);
    // ç¼“å­˜æ¥å£çš„æ–¹æ³•
    for (Method m : providerConfig.getProxyClass().getMethods()) {
        ReflectCache.putOverloadMethodCache(key, m);
    }
}

```

(8)åˆ¤æ–­æœåŠ¡ç«¯é…ç½®ServerConfigæ˜¯å¦è‡ªåŠ¨å¯åŠ¨ï¼Œå¯åŠ¨æœåŠ¡è¿è¡Œå®¹å™¨Serverå®ä¾‹ï¼š

```Java
public void start() {
    if (started) {
        return;
    }
    synchronized (this) {
        if (started) {
            return;
        }
        // ç”ŸæˆServerå¯¹è±¡
        remotingServer = initRemotingServer();
        try {
            if (!remotingServer.start(serverConfig.getBoundHost())) {
                throw new SofaRpcRuntimeException("Failed to start bolt server, see more detail from bolt log.");
            }
            started = true;
        } catch (SofaRpcRuntimeException e) {
            throw e;
        } catch (Exception e) {
            throw new SofaRpcRuntimeException("Failed to start bolt server!", e);
        }
    }
}

```

é»˜è®¤æœåŠ¡ç«¯BoltServerå¯åŠ¨æœåŠ¡é¦–å…ˆä»¥æœåŠ¡ç«¯é…ç½®ç«¯å£é€šè¿‡RpcServeråˆå§‹åŒ–ç”Ÿæˆè¿œç¨‹æœåŠ¡ç«¯Serverå®ä¾‹ï¼Œè¿œç¨‹æœåŠ¡ç«¯Serverå°†BoltServerProcessorå¤„ç†å™¨ç¼“å­˜åˆ°userProcessorsï¼š

```Java
protected RemotingServer initRemotingServer() {
    // ç»‘å®šåˆ°ç«¯å£
    RemotingServer remotingServer = new RpcServer(serverConfig.getPort());
    remotingServer.registerUserProcessor(boltServerProcessor);
    return remotingServer;
}
public RpcServer(int port) {
    super(port);
    this.globalSwitch = new GlobalSwitch();
    this.connectionEventListener = new ConnectionEventListener();
    this.userProcessors = new ConcurrentHashMap(4);
    this.bossGroup = new NioEventLoopGroup(1, new NamedThreadFactory("Rpc-netty-server-boss"));
}
public void registerUserProcessor(UserProcessor<?> processor) {
    if (processor != null && !StringUtils.isBlank(processor.interest())) {
        UserProcessor<?> preProcessor = (UserProcessor)this.userProcessors.putIfAbsent(processor.interest(), processor);
        if (preProcessor != null) {
            String errMsg = "Processor with interest key [" + processor.interest() + "] has already been registered to rpc server, can not register again!";
            throw new RuntimeException(errMsg);
        }
    } else {
        throw new RuntimeException("User processor or processor interest should not be blank!");
    }
}

```

æ¥ç€è¿œç¨‹æœåŠ¡ç«¯ServeræŒ‰ç…§æœåŠ¡è¿è¡Œå®¹å™¨ç»‘å®šHosté…ç½®å¯åŠ¨æœåŠ¡ï¼Œæ‰§è¡Œinit()æ–¹æ³•åˆå§‹åŒ–RpcRemotingè¿œç¨‹è¿æ¥äº‹ä»¶å¤„ç†å™¨ä»¥åŠè¿æ¥ç®¡ç†å™¨ï¼Œåˆå§‹åŒ–æœåŠ¡å¯åŠ¨ç±»ServerBootstrapå®ä¾‹ï¼Œè®¾ç½®æœåŠ¡å¯åŠ¨ç±»ServerBootstrapå±æ€§ï¼Œæ ¹æ®ç¼“å­˜BoltServerProcessorçš„userProcessorsåˆ›å»ºRpcHandlerå¤„ç†å™¨å¹¶ä¸”æ·»åŠ åˆ°ChannelPipelineï¼Œåˆ›å»ºRpcæœåŠ¡è¿æ¥ï¼Œæ‰§è¡ŒdoStart()æ–¹æ³•æœåŠ¡å¯åŠ¨ç±»ServerBootstrapå®ä¾‹ç»‘å®šæŒ‡å®šIPåœ°å€åŒæ­¥ï¼š

```Java
public boolean start(String ip) {
    this.init();
    if (this.started.compareAndSet(false, true)) {
        try {
            logger.warn("Server started on " + ip + ":" + this.port);
            return this.doStart(ip);
        } catch (Throwable var3) {
            this.started.set(false);
            logger.error("ERROR: Failed to start the Server!", var3);
            return false;
        }
    } else {
        logger.error("ERROR: The server has already started!");
        return false;
    }
}
protected void doInit() {
    if (this.addressParser == null) {
        this.addressParser = new RpcAddressParser();
    }

    this.initRpcRemoting((RpcRemoting)null);
    this.bootstrap = new ServerBootstrap();
    ((ServerBootstrap)((ServerBootstrap)((ServerBootstrap)this.bootstrap.group(this.bossGroup, workerGroup).channel(NioServerSocketChannel.class)).option(ChannelOption.SO_BACKLOG, SystemProperties.tcp_so_backlog())).option(ChannelOption.SO_REUSEADDR, SystemProperties.tcp_so_reuseaddr())).childOption(ChannelOption.TCP_NODELAY, SystemProperties.tcp_nodelay()).childOption(ChannelOption.SO_KEEPALIVE, SystemProperties.tcp_so_keepalive());
    this.initWriteBufferWaterMark();
    boolean pooledBuffer = SystemProperties.netty_buffer_pooled();
    if (pooledBuffer) {
        ((ServerBootstrap)this.bootstrap.option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)).childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);
    }

    final boolean idleSwitch = SystemProperties.tcp_idle_switch();
    final int idleTime = SystemProperties.tcp_server_idle();
    final ChannelHandler serverIdleHandler = new ServerIdleHandler();
    final RpcHandler rpcHandler = new RpcHandler(true, this.userProcessors);
    this.bootstrap.childHandler(new ChannelInitializer<SocketChannel>() {
        protected void initChannel(SocketChannel channel) throws Exception {
            ChannelPipeline pipeline = channel.pipeline();
            pipeline.addLast("decoder", new RpcProtocolDecoder(1));
            pipeline.addLast("encoder", new ProtocolCodeBasedEncoder(ProtocolCode.fromBytes(new byte[]{2})));
            if (idleSwitch) {
                pipeline.addLast("idleStateHandler", new IdleStateHandler(0L, 0L, (long)idleTime, TimeUnit.MILLISECONDS));
                pipeline.addLast("serverIdleHandler", serverIdleHandler);
            }

            pipeline.addLast("connectionEventHandler", RpcServer.this.connectionEventHandler);
            pipeline.addLast("handler", rpcHandler);
            this.createConnection(channel);
        }

        private void createConnection(SocketChannel channel) {
            Url url = RpcServer.this.addressParser.parse(RemotingUtil.parseRemoteAddress(channel));
            if (RpcServer.this.globalSwitch.isOn(2)) {
                RpcServer.this.connectionManager.add(new Connection(channel, url), url.getUniqueKey());
            } else {
                new Connection(channel, url);
            }

            channel.pipeline().fireUserEventTriggered(ConnectionEventType.CONNECT);
        }
    });
}
protected boolean doStart() throws InterruptedException {
    this.channelFuture = this.bootstrap.bind(new InetSocketAddress(this.port)).sync();
    return this.channelFuture.isSuccess();
}

```

(9)æœåŠ¡å‘å¸ƒé…ç½®ProviderConfigå®ä¾‹ç»‘å®šProvideré…ç½®å‘ç”Ÿå˜åŒ–ç›‘å¬å™¨ProviderAttributeListenerï¼Œç›‘å¬Providerå±æ€§å˜åŒ–æ›´æ–°æœåŠ¡å‘å¸ƒé…ç½®å±æ€§ï¼š

```Java
/**
 * Provideré…ç½®å‘ç”Ÿå˜åŒ–ç›‘å¬å™¨
 */
private class ProviderAttributeListener implements ConfigListener {

    @Override
    public void configChanged(Map newValue) {
    }

    @Override
    public synchronized void attrUpdated(Map newValueMap) {
        String appName = providerConfig.getAppName();
        // å¯ä»¥æ”¹å˜çš„é…ç½® ä¾‹å¦‚tag concurrentsç­‰
        Map<String, String> newValues = (Map<String, String>) newValueMap;
        Map<String, String> oldValues = new HashMap<String, String>();
        boolean reexport = false;
        try { // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
              // æ˜¯å¦è¿‡æ»¤map?
            for (Map.Entry<String, String> entry : newValues.entrySet()) {
                String newValue = entry.getValue();
                String oldValue = providerConfig.queryAttribute(entry.getKey());
                boolean changed = oldValue == null ? newValue != null : !oldValue.equals(newValue);
                if (changed) {
                    oldValues.put(entry.getKey(), oldValue);
                }
                reexport = reexport || changed;
            }
        } catch (Exception e) {
            LOGGER.errorWithApp(appName, "Catch exception when provider attribute compare", e);
            return;
        }

        // éœ€è¦é‡æ–°å‘å¸ƒ
        if (reexport) {
            try {
                if (LOGGER.isInfoEnabled(appName)) {
                    LOGGER.infoWithApp(appName, "Reexport service {}", providerConfig.buildKey());
                }
                unExport();
                // change attrs
                for (Map.Entry<String, String> entry : newValues.entrySet()) {
                    providerConfig.updateAttribute(entry.getKey(), entry.getValue(), true);
                }
                export();
            } catch (Exception e) {
                LOGGER.errorWithApp(appName, "Catch exception when provider attribute changed", e);
                //rollback old attrs
                for (Map.Entry<String, String> entry : oldValues.entrySet()) {
                    providerConfig.updateAttribute(entry.getKey(), entry.getValue(), true);
                }
                export();
            }
        }

    }
}

```

(10)æ³¨å†Œè®¢é˜…æœåŠ¡åˆ—è¡¨ï¼Œåˆ¤æ–­æœåŠ¡å‘å¸ƒé…ç½®æ˜¯å¦æ³¨å†Œï¼Œæ ¹æ®æœåŠ¡å‘å¸ƒæ³¨å†Œä¸­å¿ƒé…ç½®åˆ—è¡¨éå†æ³¨å†Œä¸­å¿ƒé…ç½®é€šè¿‡æ³¨å†Œä¸­å¿ƒå·¥å‚è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹å¹¶ä¸”åˆå§‹åŒ–å¯åŠ¨æ³¨å†Œä¸­å¿ƒï¼Œæ³¨å†ŒæœåŠ¡å‘å¸ƒé…ç½®åˆ°æ³¨å†Œä¸­å¿ƒï¼š

```Java
/**
 * è®¢é˜…æœåŠ¡åˆ—è¡¨
 */
protected void register() {
    if (providerConfig.isRegister()) {
        List<RegistryConfig> registryConfigs = providerConfig.getRegistry();
        if (registryConfigs != null) {
            for (RegistryConfig registryConfig : registryConfigs) {
                Registry registry = RegistryFactory.getRegistry(registryConfig);
                registry.init();
                registry.start();
                try {
                    registry.register(providerConfig);
                } catch (SofaRpcRuntimeException e) {
                    throw e;
                } catch (Throwable e) {
                    String appName = providerConfig.getAppName();
                    if (LOGGER.isWarnEnabled(appName)) {
                        LOGGER.warnWithApp(appName, "Catch exception when register to registry: "
                            + registryConfig.getId(), e);
                    }
                }
            }
        }
    }
}

```

(11)å…¨å±€è¿è¡Œæ—¶ä¸Šä¸‹æ–‡RpcRuntimeContextå¢åŠ ç¼“å­˜ProviderConfigï¼Œç¼“å­˜æœåŠ¡å‘å¸ƒé…ç½®åˆ°EXPORTED_PROVIDER_CONFIGSé›†åˆã€‚
 **è§£ææ€»ç»“**
 SOFARPCæœåŠ¡å‘å¸ƒæµç¨‹æ¦‚æ‹¬ä¸ºSOFARPCæœåŠ¡éœ€è¦åˆ›å»ºæœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ServerConfigï¼Œè‡ªå®šä¹‰è®¾ç½®åŸºç¡€é…ç½®å¹¶ä¸”é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½æœåŠ¡ç«¯é»˜è®¤é…ç½®ï¼›åˆ›å»ºæœåŠ¡å‘å¸ƒé…ç½®ProviderConfigï¼Œè‡ªå®šä¹‰è®¾ç½®æ¥å£åç§°ã€æ¥å£å®ç°ç±»å¼•ç”¨ä»¥åŠæŒ‡å®šæœåŠ¡ç«¯é…ç½®ï¼›æœåŠ¡å‘å¸ƒå¯åŠ¨ç±»ProviderBootstrapå‘å¸ƒæœåŠ¡ï¼šæ„é€ è¯·æ±‚è°ƒç”¨å™¨ProviderProxyInvoker(æœ€åº•å±‚è°ƒç”¨è¿‡æ»¤å™¨æ‰§è¡Œé“¾FilterChain)ï¼Œæå‰åˆå§‹åŒ–æ³¨å†Œä¸­å¿ƒï¼Œåˆ›å»ºæœåŠ¡ç«¯ServeråŒ…æ‹¬å¯åŠ¨ä¸šåŠ¡çº¿ç¨‹æ± bizThreadPool ã€åˆ›å»ºBoltServerProcessorå¤„ç†å™¨ï¼ŒæœåŠ¡ç«¯Serveræ³¨å†ŒæœåŠ¡æä¾›è€…é…ç½®ProviderConfigã€æœåŠ¡ç«¯è°ƒç”¨å®ç°ProviderProxyInvokerï¼ŒæœåŠ¡ç«¯Serverå¯åŠ¨æœåŠ¡åˆ›å»ºRpcServerï¼Œå°†BoltServerProcessorå¤„ç†å™¨ç¼“å­˜åˆ°userProcessorsï¼Œåˆå§‹åŒ–æœåŠ¡å¯åŠ¨ServerBootstrapï¼Œæ ¹æ®userProcessorsåˆ›å»ºRpcHandlerå¤„ç†å™¨æ·»åŠ åˆ°ChannelPipelineï¼Œåˆ›å»ºRPCæœåŠ¡è¿æ¥å®Œæˆå¯åŠ¨æœåŠ¡é“¾è·¯ã€‚RPCæœåŠ¡è¯·æ±‚è°ƒç”¨RpcHandlerçš„channelRead()æ–¹æ³•è·å–UserProcessoræ‰§è¡ŒhandlerRequest()æ–¹æ³•æŸ¥æ‰¾æœåŠ¡è°ƒç”¨å™¨Invokerå®æ–½è°ƒç”¨è¿‡æ»¤å™¨æ‰§è¡Œé“¾FilterChainæ–¹æ³•è°ƒç”¨ã€‚




![img](https:////upload-images.jianshu.io/upload_images/6739367-2e09c4152edc65d8.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

SOFARPCæœåŠ¡å‘å¸ƒæµç¨‹