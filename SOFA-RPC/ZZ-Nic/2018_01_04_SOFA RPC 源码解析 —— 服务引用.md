title: SOFA RPC æºç è§£æ â€”â€” æœåŠ¡å¼•ç”¨
date: 2018-01-04
tag: 
categories: SOFA RPC
permalink: SOFARPC/Nic/service-refer
author: é‹’Nic
from_url: https://www.jianshu.com/p/47816d0f1317
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/47816d0f1317 ã€Œé‹’Nicã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

**ç®€ä»‹æ‘˜è¦**
 SOFARPCæœåŠ¡å‘å¸ƒåˆ›å»ºæœåŠ¡è¿è¡Œå®¹å™¨é…ç½®ServerConfigï¼Œè®¾ç½®åŸºç¡€é…ç½®å¹¶ä¸”é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½æœåŠ¡ç«¯é»˜è®¤é…ç½®ï¼›åˆ›å»ºæœåŠ¡å‘å¸ƒé…ç½®ProviderConfigï¼Œè®¾ç½®æ¥å£åç§°ã€æ¥å£å®ç°ç±»å¼•ç”¨ä»¥åŠæŒ‡å®šæœåŠ¡ç«¯é…ç½®ï¼›é€šè¿‡æœåŠ¡å‘å¸ƒå¯åŠ¨ç±»ProviderBootstrapå‘å¸ƒæœåŠ¡ã€‚SOFARPCæœåŠ¡å¼•ç”¨æŒ‰ç…§ç¼–ç¨‹ç•Œé¢åˆ†ä¸ºä¸¤ç§ä½¿ç”¨SOFARPCçš„æ–¹å¼ï¼š
 1.é€šè¿‡SOFARPCä½¿ç”¨ï¼š
 æœåŠ¡å¼•ç”¨è¿‡ç¨‹æ¶‰åŠåˆ°RegistryConfigæ³¨å†Œä¸­å¿ƒé…ç½®ç±»ä»¥åŠConsumerConfigæœåŠ¡å¼•ç”¨é…ç½®ç±»ã€‚
 (1)RegistryConfigæ³¨å†Œä¸­å¿ƒé…ç½®ç±»

```Java
RegistryConfig registryConfig = new RegistryConfig()
            .setProtocol("zookeeper")
            .setAddress("127.0.0.1:2181")
```

RegistryConfigè¡¨ç¤ºæ³¨å†Œä¸­å¿ƒï¼Œå¦‚ä¸Šå£°æ˜æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åœ°å€å’Œç«¯å£æ˜¯127.0.0.1:2181ï¼Œåè®®æ˜¯Zookeeperã€‚
 (2) ConsumerConfigæœåŠ¡å¼•ç”¨é…ç½®ç±»

```Java
ConsumerConfig<HelloService> consumerConfig = new ConsumerConfig<HelloService>()
            .setInterfaceId(HelloService.class.getName())
            .setRegistry(registryConfig);
HelloService helloService = consumerConfig.refer();
```

ConsumerConfigè¡¨ç¤ºæœåŠ¡å¼•ç”¨ï¼Œå¦‚ä¸Šå£°æ˜æ‰€å¼•ç”¨æœåŠ¡çš„æ¥å£å’ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚æœ€ç»ˆé€šè¿‡referæ–¹æ³•å°†æ­¤æœåŠ¡å¼•ç”¨ï¼Œè·å–åˆ°è¯¥æœåŠ¡çš„è¿œç¨‹è°ƒç”¨çš„ä»£ç†ã€‚
 SOFARPCæœåŠ¡å¼•ç”¨æ”¯æŒå¦‚ä¸‹ç‰¹æ€§ï¼š
 (1)åŒä¸€æœåŠ¡æ³¨å†Œå¤šä¸ªæ³¨å†Œä¸­å¿ƒï¼Œæ„å»ºå¤šä¸ªRegistryConfigè®¾ç½®ç»™ ConsumerConfigï¼š

```Java
List<RegistryConfig> registryConfigs = new ArrayList<RegistryConfig>();
registryConfigs.add(registryA);
registryConfigs.add(registryB);
consumerConfig.setRegistry(registryConfigs);
```

(2)æä¾›MethodConfigè¿›è¡Œæ–¹æ³•çº§åˆ«å‚æ•°è®¾ç½®ï¼ŒAPIæ–¹å¼ä½¿ç”¨ç›¸åº”çš„å¯¹è±¡setæ³•å³å¯ä¸ºå…¶è®¾ç½®å‚æ•°ï¼š

```Java
MethodConfig methodConfigA = new MethodConfig();
MethodConfig methodConfigB = new MethodConfig();
List<MethodConfig> methodConfigs = new ArrayList<MethodConfig>();
methodConfigs.add(methodConfigA);
methodConfigs.add(methodConfigB);
consumerConfig.setMethods(methodConfigs);  //å®¢æˆ·ç«¯è®¾ç½®
```

2.é€šè¿‡SOFABootä½¿ç”¨ï¼š
 (1)æœåŠ¡å¼•ç”¨ä½¿ç”¨XMLé…ç½®é€šè¿‡sofa:referenceå…ƒç´ è¡¨ç¤ºå¼•ç”¨æœåŠ¡ï¼ŒXMLé…ç½®å¦‚ä¸‹æ‰€ç¤ºå°±èƒ½å¤Ÿå¼•ç”¨SOFARPCæœåŠ¡ï¼š

```XML
<sofa:reference id="helloSyncServiceReference" interface="com.alipay.sofa.rpc.samples.invoke.HelloSyncService">
    <sofa:binding.bolt/>
</sofa:reference>
```

å¦‚ä¸Šé€šè¿‡sofa:referenceå…ƒç´ å¼•ç”¨äº†ä¸€ä¸ªæœåŠ¡ï¼Œå…¶ä¸­idå±æ€§è¡¨ç¤ºè¯¥æœåŠ¡å¼•ç”¨åœ¨Springä¸Šä¸‹æ–‡ä¸­çš„å”¯ä¸€æ ‡è¯†ï¼Œinterfaceè¡¨ç¤ºè¯¥æœåŠ¡çš„æ¥å£ã€‚sofa:binding.boltè¡¨ç¤ºè¯¥æœåŠ¡å¼•ç”¨è°ƒç”¨æ—¶ä½¿ç”¨çš„åè®®ä¸ºboltã€‚
 å½“å¼•ç”¨æœåŠ¡çš„SOFARPCåº”ç”¨å¯åŠ¨çš„æ—¶å€™ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè®¢é˜…åˆ°ç›¸åº”æœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚æœåŠ¡æ³¨å†Œä¸­å¿ƒæ”¶åˆ°è®¢é˜…è¯·æ±‚å°†å‘å¸ƒæ–¹çš„å…ƒæ•°æ®åˆ—è¡¨å®æ—¶æ¨é€ç»™æœåŠ¡å¼•ç”¨æ–¹ã€‚å½“æœåŠ¡å¼•ç”¨æ–¹æ‹¿åˆ°å‘å¸ƒæ–¹çš„åœ°å€ä»ä¸­é€‰å–åœ°å€å‘èµ·æœåŠ¡è°ƒç”¨ã€‚SOFARPCåº”ç”¨å¯åŠ¨ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å¼•ç”¨ç”Ÿæˆä¸€ä¸ªè¿œç¨‹è°ƒç”¨çš„ä»£ç†ï¼ŒSpringè·å–Beané€šè¿‡idè·å–åˆ°æœåŠ¡å¼•ç”¨è¿›è¡Œä½¿ç”¨ï¼š

```Java
HelloSyncService helloSyncServiceReference = (HelloSyncService) applicationContext
            .getBean("helloSyncServiceReference");
String result = helloSyncServiceReference.saySync("sync");
```

æ¯ä¸€ä¸ªæœåŠ¡å¼•ç”¨å¯¹åº”sofa:bindingå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæƒ³å¯¹åŒä¸€ä¸ªæœåŠ¡å‘èµ·ä¸åŒåè®®çš„è°ƒç”¨ï¼Œéœ€è¦å¦‚ä¸‹é…ç½®ï¼š

```XML
<sofa:reference id="boltHelloSyncServiceReference" interface="com.alipay.sofa.rpc.samples.invoke.HelloSyncService">
    <sofa:binding.bolt/>
</sofa:reference>
<sofa:reference id="restHelloSyncServiceReference" interface="com.alipay.sofa.rpc.samples.invoke.HelloSyncService">
    <sofa:binding.rest/>
</sofa:reference>
<sofa:reference id="dubboHelloSyncServiceReference" interface="com.alipay.sofa.rpc.samples.invoke.HelloSyncService">
    <sofa:binding.dubbo/>
</sofa:reference>
```

å£°æ˜æœåŠ¡å¼•ç”¨çš„åŒæ—¶è®¾ç½®éœ€è¦çš„å‚æ•°ï¼Œglobal-attrså…ƒç´ è®¾ç½®è°ƒç”¨è¶…æ—¶ï¼Œåœ°å€ç­‰å¾…æ—¶é—´ç­‰å‚æ•°ï¼› target-urlå…ƒç´ èƒ½å¤Ÿè®¾ç½®ç›´è¿è°ƒç”¨çš„åœ°å€ï¼›methodæ ‡ç­¾èƒ½å¤Ÿè®¾ç½®æ–¹æ³•çº§åˆ«å‚æ•°ï¼š

```XML
<sofa:reference id="personReferenceBolt" interface="com.alipay.sofa.boot.examples.demo.rpc.bean.PersonService">
    <sofa:binding.bolt>
        <sofa:global-attrs timeout="3000" address-wait-time="2000"/>  <!-- è°ƒç”¨è¶…æ—¶ï¼›åœ°å€ç­‰å¾…æ—¶é—´ã€‚ -->
        <sofa:route target-url="127.0.0.1:22000"/>  <!-- ç›´è¿åœ°å€ -->
        <sofa:method name="sayName" timeout="3000"/> <!-- æ–¹æ³•çº§åˆ«é…ç½® -->
    </sofa:binding.bolt>
</sofa:reference>

<sofa:reference id="personReferenceBolt" interface="com.alipay.sofa.boot.examples.demo.rpc.bean.PersonService">
    <sofa:binding.bolt/>
</sofa:reference>
<sofa:reference id="personReferenceRest" interface="com.alipay.sofa.boot.examples.demo.rpc.bean.PersonService">
    <sofa:binding.rest/>
</sofa:reference>
<sofa:reference id="personReferenceDubbo" interface="com.alipay.sofa.boot.examples.demo.rpc.bean.PersonService">
    <sofa:binding.dubbo/>
</sofa:reference>
```

å…¶ä¸­sofa:referenceå…ƒç´ è¡¨ç¤ºå¼•ç”¨è¯¥æœåŠ¡ï¼Œsofa:bindingå…ƒç´ å£°æ˜è¯¥æœåŠ¡å¼•ç”¨çš„è°ƒç”¨çš„åè®®ã€‚å¦‚ä¸ŠSpringä¸Šä¸‹æ–‡æ„å»ºä¸‰ä¸ªæœåŠ¡çš„è¿œç¨‹ä»£ç†ç±»ï¼Œåå­—åˆ†åˆ«ä¸ºpersonReferenceBoltã€personReferenceRestä»¥åŠpersonReferenceDubboã€‚
 (2)æœåŠ¡å¼•ç”¨ä½¿ç”¨æ³¨è§£æ–¹å¼é€šè¿‡@SofaReferenceæ³¨è§£è¡¨ç¤ºå¼•ç”¨æœåŠ¡ï¼ŒinterfaceTypeå…ƒç´ æŒ‡å®šæœåŠ¡æ¥å£ï¼Œbindingså…ƒç´ æŒ‡å®šåè®®ç±»å‹(å¤šåè®®åœºæ™¯ä½¿ç”¨@SofaReferenceBindingæ³¨è§£bindingTypeå…ƒç´ æŒ‡å®šåè®®ç±»å‹ï¼Œæš‚æ—¶åªæ”¯æŒboltåè®®)ï¼š

```Java
@Component
public class AnnotationClientImpl {

    @SofaReference(interfaceType = AnnotationService.class, binding = @SofaReferenceBinding(bindingType = "bolt"))
    private AnnotationService annotationService;

    public String sayClientAnnotation(String str) {

        String result = annotationService.sayAnnotation(str);

        return result;
    }
}
```

å®¢æˆ·ç«¯æ¨¡å—åŒ…å«é›†ç¾¤ç®¡ç†ã€è·¯ç”±ã€åœ°å€ç®¡ç†å™¨ã€è¿æ¥ç®¡ç†å™¨ã€è´Ÿè½½å‡è¡¡å™¨ï¼Œä»¥åŠä¸ä»£ç†ã€æ³¨å†Œä¸­å¿ƒç­‰æ¨¡å—äº¤äº’ï¼š



![img](https:////upload-images.jianshu.io/upload_images/6739367-b97e3455c54e3d1d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/554/format/jpeg)

å®¢æˆ·ç«¯è°ƒç”¨æµç¨‹

æºç è§£æ

 æ­å»ºç¯å¢ƒæœåŠ¡å‘å¸ƒç¤ºä¾‹ï¼š



```Java
package org.alipay.sofa.rpc;

import com.alipay.sofa.rpc.config.ConsumerConfig;

public class RpcClient {

    public static void main(String[] args) {

        ConsumerConfig<HelloService> consumerConfig = new ConsumerConfig<HelloService>()
                .setInterfaceId(HelloService.class.getName()) // æŒ‡å®šæ¥å£
                .setProtocol("bolt") // æŒ‡å®šåè®®
                .setDirectUrl("bolt://127.0.0.1:12200") // æŒ‡å®šç›´è¿åœ°å€
                .setConnectTimeout(10 * 1000);

        HelloService helloService = consumerConfig.refer();

        while (true) {
            try {
                System.out.println(helloService.sayHello("world"));
            } catch (Exception e) {
                e.printStackTrace();
            }

            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

        }
    }
}
```

å‚è€ƒSOFARPC Exampleç¤ºä¾‹æ¨¡å—([com.alipay.sofa.rpc.quickstart.QuickStartClient](https://github.com/alipay/sofa-rpc/blob/master/example/src/test/java/com/alipay/sofa/rpc/quickstart/QuickStartClient.java))ï¼š

```Java
package com.alipay.sofa.rpc.quickstart;

import com.alipay.sofa.rpc.config.ConsumerConfig;

/**
 * Quick Start client
 */
public class QuickStartClient {

    public static void main(String[] args) {

        ConsumerConfig<HelloService> consumerConfig = new ConsumerConfig<HelloService>()
            .setInterfaceId(HelloService.class.getName()) // æŒ‡å®šæ¥å£
            .setProtocol("bolt") // æŒ‡å®šåè®®
            .setDirectUrl("bolt://127.0.0.1:12200") // æŒ‡å®šç›´è¿åœ°å€
            .setConnectTimeout(10 * 1000);

        HelloService helloService = consumerConfig.refer();

        while (true) {
            try {
                System.out.println(helloService.sayHello("world"));
            } catch (Exception e) {
                e.printStackTrace();
            }

            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

        }
    }
}
```

è¿è¡ŒæœåŠ¡å¼•ç”¨ç«¯ç¤ºä¾‹ç±»QuickStartClientæŸ¥çœ‹æ¶ˆè´¹ç«¯è¿è¡Œæ•ˆæœï¼ŒæœåŠ¡æ¶ˆè´¹è€…è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```Java
2018-05-18 01:51:20,472 main  INFO [com.alipay.sofa.rpc.context.RpcRuntimeContext:info:102] - Welcome! Loading SOFA RPC Framework : 5.4.0_20180427231325, PID is:1424
2018-05-18 01:51:20,555 main  INFO [com.alipay.sofa.rpc.module.ModuleFactory:info:102] - Install Module: fault-tolerance
2018-05-18 01:51:20,658 main  INFO [com.alipay.sofa.rpc.bootstrap.DefaultConsumerBootstrap:infoWithApp:122] - Refer consumer config : bolt://com.alipay.sofa.rpc.quickstart.HelloService: with bean id rpc-cfg-0
2018-05-18 01:51:21,119 main  INFO [com.alipay.sofa.rpc.client.AllConnectConnectionHolder:infoWithApp:122] - Add provider of com.alipay.sofa.rpc.quickstart.HelloService, size is : 1
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Log4j ]
2018-05-18 01:51:21,322 SOFA-CLI-CONN-com.alipay.sofa.rpc.quickstart.HelloService-3-T1  INFO [com.alipay.sofa.common.log:report:30] - Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Log4j ]
log4j:ERROR Failed to rename [C:\Users\Administrator\logs/bolt/connection-event.log] to [C:\Users\Administrator\logs/bolt/connection-event.log.2018-05-12].
2018-05-18 01:51:25,236 SOFA-CLI-CONN-com.alipay.sofa.rpc.quickstart.HelloService-3-T1  INFO [com.alipay.sofa.rpc.client.AllConnectConnectionHolder:infoWithApp:122] - Connect to com.alipay.sofa.rpc.quickstart.HelloService provider:bolt://127.0.0.1:12200 success ! The connection is 127.0.0.1:12200 <-> 127.0.0.1:51301
hello world ï¼
hello world ï¼
```

å‚è€ƒsofa-rpc-boot-projectsèŒƒä¾‹æ¨¡å—([com.alipay.sofa.rpc.samples.annotation](https://github.com/alipay/sofa-rpc-boot-projects/tree/master/sofa-boot-samples/src/main/java/com/alipay/sofa/rpc/samples/annotation))ï¼š

```Java
package com.alipay.sofa.rpc.samples.annotation;

public interface AnnotationService {

    String sayAnnotation(String stirng);

}
package com.alipay.sofa.rpc.samples.annotation;

import com.alipay.sofa.runtime.api.annotation.SofaReference;
import com.alipay.sofa.runtime.api.annotation.SofaReferenceBinding;
import org.springframework.stereotype.Component;

@Component
public class AnnotationClientImpl {

    @SofaReference(interfaceType = AnnotationService.class, binding = @SofaReferenceBinding(bindingType = "bolt"))
    private AnnotationService annotationService;

    public String sayClientAnnotation(String str) {

        String result = annotationService.sayAnnotation(str);

        return result;
    }
}
package com.alipay.sofa.rpc.samples.annotation;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.ApplicationContext;

@SpringBootApplication
public class AnotationClientApplication {

    public static void main(String[] args) {

        //change port to run in local machine
        System.setProperty("server.port", "8081");

        SpringApplication springApplication = new SpringApplication(AnotationClientApplication.class);

        ApplicationContext applicationContext = springApplication.run(args);

        AnnotationClientImpl annotationService = applicationContext.getBean(AnnotationClientImpl.class);

        String result = annotationService.sayClientAnnotation("annotation");
        System.out.println("invoke result:" + result);

        if ("annotation".equalsIgnoreCase(result)) {
            System.out.println("annotation invoke success");
        } else {
            System.out.println("annotation invoke fail");
        }
    }
}
```

è¿è¡ŒæœåŠ¡å¼•ç”¨ç«¯èŒƒä¾‹ç±»AnnotationClientApplicationæŸ¥çœ‹æ¶ˆè´¹ç«¯è¿è¡Œæ•ˆæœï¼ŒæœåŠ¡æ¶ˆè´¹è€…è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š

```Java
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v1.4.2.RELEASE)

Sofa-Middleware-Log SLF4J : Actual logging.path is [ ./logs ]
2018-06-06 00:35:18.357  INFO 10108 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual logging.path is [ ./logs ]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.infra Logback ]
2018-06-06 00:35:18.384  INFO 10108 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.infra Logback ]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.healthcheck Logback ]
2018-06-06 00:35:18.687  INFO 10108 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.healthcheck Logback ]
2018-06-06 00:35:18.809  INFO 10108 --- [           main] c.a.s.r.s.a.AnotationClientApplication   : Starting AnotationClientApplication on Program with PID 10108 (D:\Program\Github\sofa-rpc-boot-projects\sofa-boot-samples\target\classes started by Administrator in D:\Program\Github\sofa-rpc-boot-projects)
2018-06-06 00:35:18.811  INFO 10108 --- [           main] c.a.s.r.s.a.AnotationClientApplication   : No active profile set, falling back to default profiles: default
2018-06-06 00:35:19.146  INFO 10108 --- [           main] ationConfigEmbeddedWebApplicationContext : Refreshing org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@4c12331b: startup date [Wed Jun 06 00:35:19 CST 2018]; root of context hierarchy
2018-06-06 00:35:24.647  INFO 10108 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'com.alipay.sofa.runtime.spring.configuration.SofaRuntimeAutoConfiguration' of type [class com.alipay.sofa.runtime.spring.configuration.SofaRuntimeAutoConfiguration$$EnhancerBySpringCGLIB$$2f86d19a] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:35:25.119  INFO 10108 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'bindingConverterFactory' of type [class com.alipay.sofa.runtime.service.impl.BindingConverterFactoryImpl] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:35:25.231  INFO 10108 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'bindingAdapterFactory' of type [class com.alipay.sofa.runtime.service.impl.BindingAdapterFactoryImpl] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:35:25.235  INFO 10108 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'sofaRuntimeProperties' of type [class com.alipay.sofa.runtime.spring.config.SofaRuntimeProperties] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:35:25.247  INFO 10108 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'sofaRuntimeContext' of type [class com.alipay.sofa.runtime.spi.component.SofaRuntimeContext] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2018-06-06 00:35:26.374  INFO 10108 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat initialized with port(s): 8081 (http)
2018-06-06 00:35:26.400  INFO 10108 --- [           main] o.apache.catalina.core.StandardService   : Starting service Tomcat
2018-06-06 00:35:26.402  INFO 10108 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/8.5.6
2018-06-06 00:35:26.897  INFO 10108 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2018-06-06 00:35:26.898  INFO 10108 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 7752 ms
2018-06-06 00:35:27.573  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.ServletRegistrationBean  : Mapping servlet: 'dispatcherServlet' to [/]
2018-06-06 00:35:27.582  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'metricsFilter' to: [/*]
2018-06-06 00:35:27.583  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'characterEncodingFilter' to: [/*]
2018-06-06 00:35:27.583  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'hiddenHttpMethodFilter' to: [/*]
2018-06-06 00:35:27.584  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'httpPutFormContentFilter' to: [/*]
2018-06-06 00:35:27.584  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'requestContextFilter' to: [/*]
2018-06-06 00:35:27.584  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'webRequestLoggingFilter' to: [/*]
2018-06-06 00:35:27.584  INFO 10108 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'applicationContextIdFilter' to: [/*]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.runtime Logback ]
2018-06-06 00:35:29.847  INFO 10108 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.runtime Logback ]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc Logback ]
2018-06-06 00:35:34.481  INFO 10108 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc Logback ]
2018-06-06 00:35:35.080  INFO 10108 --- [           main] o.a.c.f.imps.CuratorFrameworkImpl        : Starting
2018-06-06 00:35:35.110  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:zookeeper.version=3.4.6-1569965, built on 02/20/2014 09:09 GMT
2018-06-06 00:35:35.114  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:host.name=Program
2018-06-06 00:35:35.114  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.version=1.8.0_141
2018-06-06 00:35:35.114  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.vendor=Oracle Corporation
2018-06-06 00:35:35.115  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.home=C:\Program Files\Java\jdk1.8.0_141\jre
2018-06-06 00:35:35.138  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.class.path=C:\Program Files\Java\jdk1.8.0_141\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\deploy.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\access-bridge-64.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\cldrdata.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\dnsns.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\jaccess.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\jfxrt.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\localedata.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\nashorn.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunec.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunjce_provider.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunmscapi.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\sunpkcs11.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\ext\zipfs.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\javaws.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jfxswt.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\management-agent.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\plugin.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_141\jre\lib\rt.jar;D:\Program\Github\sofa-rpc-boot-projects\sofa-boot-samples\target\classes;D:\Program\Github\sofa-rpc-boot-projects\sofa-boot-starter\target\classes;C:\Users\Administrator\.m2\repository\com\alipay\sofa\sofa-rpc-all\5.4.0\sofa-rpc-all-5.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\bolt\1.4.1\bolt-1.4.1.jar;C:\Users\Administrator\.m2\repository\org\slf4j\slf4j-api\1.7.21\slf4j-api-1.7.21.jar;C:\Users\Administrator\.m2\repository\io\netty\netty-all\4.1.25.Final\netty-all-4.1.25.Final.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\hessian\3.3.0\hessian-3.3.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\tracer-core\2.1.1\tracer-core-2.1.1.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-api\0.22.0\opentracing-api-0.22.0.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-noop\0.22.0\opentracing-noop-0.22.0.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-mock\0.22.0\opentracing-mock-0.22.0.jar;C:\Users\Administrator\.m2\repository\io\opentracing\opentracing-util\0.22.0\opentracing-util-0.22.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\lookout\lookout-api\1.4.0\lookout-api-1.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\runtime-sofa-boot-starter\2.4.0\runtime-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-client\2.9.1\curator-client-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-framework\2.9.1\curator-framework-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-recipes\2.9.1\curator-recipes-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-jaxrs\3.0.12.Final\resteasy-jaxrs-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\spec\javax\annotation\jboss-annotations-api_1.1_spec\1.0.1.Final\jboss-annotations-api_1.1_spec-1.0.1.Final.jar;C:\Users\Administrator\.m2\repository\javax\activation\activation\1.1.1\activation-1.1.1.jar;C:\Users\Administrator\.m2\repository\org\apache\httpcomponents\httpclient\4.3.6\httpclient-4.3.6.jar;C:\Users\Administrator\.m2\repository\org\apache\httpcomponents\httpcore\4.3.3\httpcore-4.3.3.jar;C:\Users\Administrator\.m2\repository\commons-logging\commons-logging\1.1.3\commons-logging-1.1.3.jar;C:\Users\Administrator\.m2\repository\commons-codec\commons-codec\1.6\commons-codec-1.6.jar;C:\Users\Administrator\.m2\repository\commons-io\commons-io\2.1\commons-io-2.1.jar;C:\Users\Administrator\.m2\repository\net\jcip\jcip-annotations\1.0\jcip-annotations-1.0.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-client\3.0.12.Final\resteasy-client-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-jackson-provider\3.0.12.Final\resteasy-jackson-provider-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-core-asl\1.9.12\jackson-core-asl-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-mapper-asl\1.9.12\jackson-mapper-asl-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-jaxrs\1.9.12\jackson-jaxrs-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\codehaus\jackson\jackson-xc\1.9.12\jackson-xc-1.9.12.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-netty4\3.0.12.Final\resteasy-netty4-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-validator-provider-11\3.0.12.Final\resteasy-validator-provider-11-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\hibernate\hibernate-validator\5.0.1.Final\hibernate-validator-5.0.1.Final.jar;C:\Users\Administrator\.m2\repository\javax\validation\validation-api\1.1.0.Final\validation-api-1.1.0.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\logging\jboss-logging\3.1.1.GA\jboss-logging-3.1.1.GA.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\classmate\0.8.0\classmate-0.8.0.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\jaxrs-api\3.0.12.Final\jaxrs-api-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-multipart-provider\3.0.12.Final\resteasy-multipart-provider-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\org\jboss\resteasy\resteasy-jaxb-provider\3.0.12.Final\resteasy-jaxb-provider-3.0.12.Final.jar;C:\Users\Administrator\.m2\repository\com\sun\xml\bind\jaxb-impl\2.2.7\jaxb-impl-2.2.7.jar;C:\Users\Administrator\.m2\repository\com\sun\xml\bind\jaxb-core\2.2.7\jaxb-core-2.2.7.jar;C:\Users\Administrator\.m2\repository\javax\xml\bind\jaxb-api\2.2.7\jaxb-api-2.2.7.jar;C:\Users\Administrator\.m2\repository\com\sun\istack\istack-commons-runtime\2.16\istack-commons-runtime-2.16.jar;C:\Users\Administrator\.m2\repository\com\sun\xml\fastinfoset\FastInfoset\1.2.12\FastInfoset-1.2.12.jar;C:\Users\Administrator\.m2\repository\javax\xml\bind\jsr173_api\1.0\jsr173_api-1.0.jar;C:\Users\Administrator\.m2\repository\javax\mail\mail\1.5.0-b01\mail-1.5.0-b01.jar;C:\Users\Administrator\.m2\repository\org\apache\james\apache-mime4j\0.6\apache-mime4j-0.6.jar;C:\Users\Administrator\.m2\repository\javax\el\javax.el-api\2.2.5\javax.el-api-2.2.5.jar;C:\Users\Administrator\.m2\repository\org\glassfish\web\javax.el\2.2.6\javax.el-2.2.6.jar;C:\Users\Administrator\.m2\repository\com\alibaba\dubbo\2.4.10\dubbo-2.4.10.jar;C:\Users\Administrator\.m2\repository\org\jboss\netty\netty\3.2.5.Final\netty-3.2.5.Final.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-beans\4.3.4.RELEASE\spring-beans-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-core\4.3.4.RELEASE\spring-core-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\1.4.2.RELEASE\spring-boot-autoconfigure-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\test-sofa-boot-starter\2.4.0\test-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\healthcheck-sofa-boot-starter\2.4.0\healthcheck-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\infra-sofa-boot-starter\2.4.0\infra-sofa-boot-starter-2.4.0.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-context\4.3.4.RELEASE\spring-context-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-aop\4.3.4.RELEASE\spring-aop-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-expression\4.3.4.RELEASE\spring-expression-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot\1.4.2.RELEASE\spring-boot-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-actuator\1.4.2.RELEASE\spring-boot-starter-actuator-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter\1.4.2.RELEASE\spring-boot-starter-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-logging\1.4.2.RELEASE\spring-boot-starter-logging-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\ch\qos\logback\logback-classic\1.1.7\logback-classic-1.1.7.jar;C:\Users\Administrator\.m2\repository\ch\qos\logback\logback-core\1.1.7\logback-core-1.1.7.jar;C:\Users\Administrator\.m2\repository\org\slf4j\jcl-over-slf4j\1.7.21\jcl-over-slf4j-1.7.21.jar;C:\Users\Administrator\.m2\repository\org\slf4j\jul-to-slf4j\1.7.21\jul-to-slf4j-1.7.21.jar;C:\Users\Administrator\.m2\repository\org\slf4j\log4j-over-slf4j\1.7.21\log4j-over-slf4j-1.7.21.jar;C:\Users\Administrator\.m2\repository\org\yaml\snakeyaml\1.17\snakeyaml-1.17.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-actuator\1.4.2.RELEASE\spring-boot-actuator-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-web\1.4.2.RELEASE\spring-boot-starter-web-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\1.4.2.RELEASE\spring-boot-starter-tomcat-1.4.2.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\8.5.6\tomcat-embed-core-8.5.6.jar;C:\Users\Administrator\.m2\repository\org\apache\tomcat\embed\tomcat-embed-el\8.5.6\tomcat-embed-el-8.5.6.jar;C:\Users\Administrator\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\8.5.6\tomcat-embed-websocket-8.5.6.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\jackson\core\jackson-databind\2.8.4\jackson-databind-2.8.4.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\2.8.0\jackson-annotations-2.8.0.jar;C:\Users\Administrator\.m2\repository\com\fasterxml\jackson\core\jackson-core\2.8.4\jackson-core-2.8.4.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-web\4.3.4.RELEASE\spring-web-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\org\springframework\spring-webmvc\4.3.4.RELEASE\spring-webmvc-4.3.4.RELEASE.jar;C:\Users\Administrator\.m2\repository\com\alibaba\fastjson\1.2.47\fastjson-1.2.47.jar;C:\Users\Administrator\.m2\repository\com\alipay\sofa\common\sofa-common-tools\1.0.12\sofa-common-tools-1.0.12.jar;C:\Users\Administrator\.m2\repository\org\apache\curator\curator-test\2.9.1\curator-test-2.9.1.jar;C:\Users\Administrator\.m2\repository\org\apache\zookeeper\zookeeper\3.4.6\zookeeper-3.4.6.jar;C:\Users\Administrator\.m2\repository\log4j\log4j\1.2.16\log4j-1.2.16.jar;C:\Users\Administrator\.m2\repository\jline\jline\0.9.94\jline-0.9.94.jar;C:\Users\Administrator\.m2\repository\io\netty\netty\3.7.0.Final\netty-3.7.0.Final.jar;C:\Users\Administrator\.m2\repository\org\javassist\javassist\3.18.1-GA\javassist-3.18.1-GA.jar;C:\Users\Administrator\.m2\repository\org\apache\commons\commons-math\2.2\commons-math-2.2.jar;C:\Users\Administrator\.m2\repository\com\google\guava\guava\16.0.1\guava-16.0.1.jar;C:\Users\Administrator\.m2\repository\com\101tec\zkclient\0.10\zkclient-0.10.jar;D:\Program\JetBrains\IntelliJ\lib\idea_rt.jar
2018-06-06 00:35:35.148  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.library.path=C:\Program Files\Java\jdk1.8.0_141\bin;C:\WINDOWS\Sun\Java\bin;C:\WINDOWS\system32;C:\WINDOWS;C:\ProgramData\Oracle\Java\javapath;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\Program Files\Java\jdk1.8.0_141\bin;C:\Program Files\Java\jdk1.8.0_141\jre\bin;C:\Program Files\Maven\bin;C:\Program Files (x86)\Git\cmd;C:\Program Files\MySQL\MySQL Utilities 1.6\;C:\Users\Administrator\AppData\Local\Microsoft\WindowsApps;;C:\Program Files\Mercurial;.
2018-06-06 00:35:35.148  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.io.tmpdir=C:\Users\ADMINI~1\AppData\Local\Temp\
2018-06-06 00:35:35.148  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:java.compiler=<NA>
2018-06-06 00:35:35.149  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:os.name=Windows 10
2018-06-06 00:35:35.156  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:os.arch=amd64
2018-06-06 00:35:35.156  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:os.version=10.0
2018-06-06 00:35:35.157  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:user.name=Administrator
2018-06-06 00:35:35.157  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:user.home=C:\Users\Administrator
2018-06-06 00:35:35.157  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Client environment:user.dir=D:\Program\Github\sofa-rpc-boot-projects
2018-06-06 00:35:35.164  INFO 10108 --- [           main] org.apache.zookeeper.ZooKeeper           : Initiating client connection, connectString=127.0.0.1:2181 sessionTimeout=60000 watcher=org.apache.curator.ConnectionState@572e6fd9
2018-06-06 00:35:35.347  INFO 10108 --- [127.0.0.1:2181)] org.apache.zookeeper.ClientCnxn          : Opening socket connection to server 127.0.0.1/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)
2018-06-06 00:35:35.351  INFO 10108 --- [127.0.0.1:2181)] org.apache.zookeeper.ClientCnxn          : Socket connection established to 127.0.0.1/127.0.0.1:2181, initiating session
2018-06-06 00:35:35.497  INFO 10108 --- [127.0.0.1:2181)] org.apache.zookeeper.ClientCnxn          : Session establishment complete on server 127.0.0.1/127.0.0.1:2181, sessionid = 0x10005c434e80001, negotiated timeout = 40000
2018-06-06 00:35:35.507  INFO 10108 --- [ain-EventThread] o.a.c.f.state.ConnectionStateManager     : State change: CONNECTED
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Logback ]
2018-06-06 00:35:40.802  INFO 10108 --- [ionService-3-T1] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.remoting Logback ]
Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc.boot Logback ]
2018-06-06 00:35:44.158  INFO 10108 --- [           main] com.alipay.sofa.common.log               : Sofa-Middleware-Log SLF4J : Actual binding is of type [ com.alipay.sofa.rpc.boot Logback ]
2018-06-06 00:35:51.863  INFO 10108 --- [           main] s.w.s.m.m.a.RequestMappingHandlerAdapter : Looking for @ControllerAdvice: org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@4c12331b: startup date [Wed Jun 06 00:35:19 CST 2018]; root of context hierarchy
2018-06-06 00:35:52.090  INFO 10108 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped "{[/error]}" onto public org.springframework.http.ResponseEntity<java.util.Map<java.lang.String, java.lang.Object>> org.springframework.boot.autoconfigure.web.BasicErrorController.error(javax.servlet.http.HttpServletRequest)
2018-06-06 00:35:52.092  INFO 10108 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped "{[/error],produces=[text/html]}" onto public org.springframework.web.servlet.ModelAndView org.springframework.boot.autoconfigure.web.BasicErrorController.errorHtml(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)
2018-06-06 00:35:52.172  INFO 10108 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/webjars/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-06 00:35:52.173  INFO 10108 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-06 00:35:52.274  INFO 10108 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**/favicon.ico] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-06 00:35:59.017  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/heapdump || /heapdump.json],methods=[GET],produces=[application/octet-stream]}" onto public void org.springframework.boot.actuate.endpoint.mvc.HeapdumpMvcEndpoint.invoke(boolean,javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse) throws java.io.IOException,javax.servlet.ServletException
2018-06-06 00:35:59.019  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/sofaboot/versions || /sofaboot/versions.json],produces=[application/json]}" onto public java.lang.Object com.alipay.sofa.infra.endpoint.SofaBootVersionEndpointMvcAdapter.invoke()
2018-06-06 00:35:59.026  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/info || /info.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.029  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/dump || /dump.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.032  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/env/{name:.*}],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EnvironmentMvcEndpoint.value(java.lang.String)
2018-06-06 00:35:59.033  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/env || /env.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.035  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/health || /health.json],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.HealthMvcEndpoint.invoke(java.security.Principal)
2018-06-06 00:35:59.038  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/trace || /trace.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.041  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/health/readiness || /health/readiness.json],produces=[application/json]}" onto public java.lang.Object com.alipay.sofa.healthcheck.service.SofaBootReadinessCheckMvcEndpoint.invoke(java.security.Principal)
2018-06-06 00:35:59.043  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/logfile || /logfile.json],methods=[GET || HEAD]}" onto public void org.springframework.boot.actuate.endpoint.mvc.LogFileMvcEndpoint.invoke(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse) throws javax.servlet.ServletException,java.io.IOException
2018-06-06 00:35:59.049  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/configprops || /configprops.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.052  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/mappings || /mappings.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.061  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/metrics/{name:.*}],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.MetricsMvcEndpoint.value(java.lang.String)
2018-06-06 00:35:59.062  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/metrics || /metrics.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.063  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/autoconfig || /autoconfig.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.066  INFO 10108 --- [           main] o.s.b.a.e.mvc.EndpointHandlerMapping     : Mapped "{[/beans || /beans.json],methods=[GET],produces=[application/json]}" onto public java.lang.Object org.springframework.boot.actuate.endpoint.mvc.EndpointMvcAdapter.invoke()
2018-06-06 00:35:59.731  INFO 10108 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup
2018-06-06 00:35:59.764  INFO 10108 --- [           main] o.s.c.support.DefaultLifecycleProcessor  : Starting beans in phase 0
2018-06-06 00:36:00.855  INFO 10108 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8081 (http)
2018-06-06 00:36:00.864  INFO 10108 --- [           main] c.a.s.r.s.a.AnotationClientApplication   : Started AnotationClientApplication in 44.609 seconds (JVM running for 46.813)
invoke result:annotation
annotation invoke success
```

SOFARPCæœåŠ¡å¼•ç”¨æµç¨‹ï¼š
 (1)åˆ›å»ºæœåŠ¡å¼•ç”¨é…ç½®ç±»ConsumerConfigï¼Œè®¾ç½®ConsumerConfigå®ä¾‹æ¥å£åç§°(æœåŠ¡æ¥å£ï¼šåšä¸ºæœåŠ¡å”¯ä¸€æ ‡è¯†çš„ç»„æˆéƒ¨åˆ†)ã€è°ƒç”¨åè®®ã€ç›´è¿è°ƒç”¨åœ°å€ä»¥åŠè¿æ¥è¶…æ—¶æ—¶é—´ï¼š

```Java
/**
 * æœåŠ¡æ¶ˆè´¹è€…é…ç½®
 *
 * @param <T> the type parameter
 */
public class ConsumerConfig<T> extends AbstractInterfaceConfig<T, ConsumerConfig<T>> implements Serializable
```

æœåŠ¡å¼•ç”¨é…ç½®ç±»ConsumerConfigç»§æ‰¿æ¥å£çº§å…¬å…±é…ç½®ç±»AbstractInterfaceConfigï¼Œèƒ½å¤Ÿé€šè¿‡é›†æˆçš„æ³¨å†Œä¸­å¿ƒåŠ¨æ€è°ƒæ•´æœåŠ¡å¼•ç”¨æ¥å£&IPçº§åˆ«é…ç½®ä¾‹å¦‚è¶…æ—¶æ—¶é—´ã€æƒé‡ç­‰ã€‚
 (2)æœåŠ¡å¼•ç”¨é…ç½®ç±»ConsumerConfigè´Ÿè´£åŠ è½½è°ƒæ•´æœåŠ¡å¼•ç”¨æ¥å£&IPçº§é…ç½®ï¼Œæ ¹æ®æœåŠ¡æ¶ˆè´¹é…ç½®è·å–ä»£ç†å¯¹è±¡å¼•ç”¨ï¼Œå•ä¸€èŒè´£åŸåˆ™ç»‘å®šæœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨ç±»ConsumerBootstrapå®æ–½å¼•ç”¨æœåŠ¡ï¼š

```Java
/**
 * å¼•ç”¨æœåŠ¡
 *
 * @return æœåŠ¡ä»£ç†ç±» t
 */
public T refer() {
    if (consumerBootstrap == null) {
        consumerBootstrap = Bootstraps.from(this);
    }
    return consumerBootstrap.refer();
}
```

é¦–å…ˆåˆ¤æ–­æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨ç±»ConsumerBootstrapæ˜¯å¦ä¸ºç©ºï¼Œé€šè¿‡å¼•ç”¨æœåŠ¡è¾…åŠ©å·¥å…·ç±»BootstrapsæŒ‰ç…§ç»‘å®šæœåŠ¡å¼•ç”¨é…ç½®æ‰©å±•åŠ è½½å·¥å‚ExtensionLoaderFactoryåŠ è½½åˆå§‹åŒ–ConsumerBootstrapå®ä¾‹ï¼Œé»˜è®¤æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨ç±»ConsumerBootstrapä¸è°ƒç”¨åè®®å¯åŠ¨ç±»å®ä¾‹ç›¸åŒï¼š

```Java
/**
 * å¼•ç”¨ä¸€ä¸ªæœåŠ¡
 *
 * @param consumerConfig æœåŠ¡æ¶ˆè´¹è€…é…ç½®
 * @param <T>            æ¥å£ç±»å‹
 * @return å¼•ç”¨å¯åŠ¨ç±»
 */
public static <T> ConsumerBootstrap<T> from(ConsumerConfig<T> consumerConfig) {
    String bootstrap = consumerConfig.getBootstrap();
    ConsumerBootstrap consumerBootstrap;
    if (StringUtils.isNotEmpty(bootstrap)) {
        consumerBootstrap = ExtensionLoaderFactory.getExtensionLoader(ConsumerBootstrap.class)
            .getExtension(bootstrap,
                new Class[] { ConsumerConfig.class },
                new Object[] { consumerConfig });
    } else {
        // default is same with protocol
        bootstrap = consumerConfig.getProtocol();
        ExtensionLoader extensionLoader = ExtensionLoaderFactory.getExtensionLoader(ConsumerBootstrap.class);
        ExtensionClass<ConsumerBootstrap> extensionClass = extensionLoader.getExtensionClass(bootstrap);
        if (extensionClass == null) {
            // if not exist, use default consumer bootstrap
            bootstrap = RpcConfigs.getStringValue(RpcOptions.DEFAULT_CONSUMER_BOOTSTRAP);
            consumerConfig.setBootstrap(bootstrap);
            consumerBootstrap = ExtensionLoaderFactory.getExtensionLoader(ConsumerBootstrap.class)
                .getExtension(bootstrap, new Class[] { ConsumerConfig.class }, new Object[] { consumerConfig });
        } else {
            consumerConfig.setBootstrap(bootstrap);
            consumerBootstrap = extensionClass.getExtInstance(
                new Class[] { ConsumerConfig.class }, new Object[] { consumerConfig });
        }
    }
    return (ConsumerBootstrap<T>) consumerBootstrap;
}
```

æ¥ç€å¼•ç”¨æœåŠ¡åŒ…è£…ç±»ConsumerBootstrapé€šè¿‡refer()æ–¹æ³•è°ƒç”¨æœåŠ¡ï¼ŒConsumerBootstrapåŸºäºBoltã€Restã€Dubboç½‘ç»œé€šä¿¡åè®®æä¾›ä¸‰ç§åè®®æœåŠ¡å¼•ç”¨å®ç°ç±»ï¼šBoltConsumerBootstrapã€RestConsumerBootstrapä»¥åŠDubboConsumerBootstrapã€‚é»˜è®¤æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨å™¨DefaultConsumerBootstrapè°ƒç”¨æœåŠ¡refer()æ–¹æ³•é¦–å…ˆåŒæ­¥åŒé‡æ£€æŸ¥æœåŠ¡å¼•ç”¨ä»£ç†å®ç°ç±»å®ä¾‹æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è¿”å›ä»£ç†å®ç°å¼•ç”¨ï¼Œæ¥ç€æ‰§è¡ŒSOFARPCå¼•ç”¨æœåŠ¡é€»è¾‘ï¼š

```Java
public T refer() {
    if (proxyIns != null) {
        return proxyIns;
    }
    synchronized (this) {
        if (proxyIns != null) {
            return proxyIns;
        }
        String key = consumerConfig.buildKey();
        String appName = consumerConfig.getAppName();
        // æ£€æŸ¥å‚æ•°
        checkParameters();
        // æå‰æ£€æŸ¥æ¥å£ç±»
        if (LOGGER.isInfoEnabled(appName)) {
            LOGGER.infoWithApp(appName, "Refer consumer config : {} with bean id {}", key, consumerConfig.getId());
        }

        // æ³¨æ„åŒä¸€interfaceï¼ŒåŒä¸€tagsï¼ŒåŒä¸€protocolæƒ…å†µ
        AtomicInteger cnt = REFERRED_KEYS.get(key); // è®¡æ•°å™¨
        if (cnt == null) { // æ²¡æœ‰å‘å¸ƒè¿‡
            cnt = CommonUtils.putToConcurrentMap(REFERRED_KEYS, key, new AtomicInteger(0));
        }
        int c = cnt.incrementAndGet();
        int maxProxyCount = consumerConfig.getRepeatedReferLimit();
        if (maxProxyCount > 0) {
            if (c > maxProxyCount) {
                cnt.decrementAndGet();
                // è¶…è¿‡æœ€å¤§æ•°é‡ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
                throw new SofaRpcRuntimeException("Duplicate consumer config with key " + key
                    + " has been referred more than " + maxProxyCount + " times!"
                    + " Maybe it's wrong config, please check it."
                    + " Ignore this if you did that on purpose!");
            } else if (c > 1) {
                if (LOGGER.isInfoEnabled(appName)) {
                    LOGGER.infoWithApp(appName, "Duplicate consumer config with key {} has been referred!"
                        + " Maybe it's wrong config, please check it."
                        + " Ignore this if you did that on purpose!", key);
                }
            }
        }

        try {
            // build cluster
            cluster = ClusterFactory.getCluster(this);
            // build listeners
            consumerConfig.setConfigListener(buildConfigListener(this));
            consumerConfig.setProviderInfoListener(buildProviderInfoListener(this));
            // init cluster
            cluster.init();
            // æ„é€ Invokerå¯¹è±¡ï¼ˆæ‰§è¡Œé“¾ï¼‰
            proxyInvoker = buildClientProxyInvoker(this);
            // åˆ›å»ºä»£ç†ç±»
            proxyIns = (T) ProxyFactory.buildProxy(consumerConfig.getProxy(), consumerConfig.getProxyClass(),
                proxyInvoker);
        } catch (Exception e) {
            if (cluster != null) {
                cluster.destroy();
                cluster = null;
            }
            consumerConfig.setConfigListener(null);
            consumerConfig.setProviderInfoListener(null);
            cnt.decrementAndGet(); // å‘å¸ƒå¤±è´¥ä¸è®¡æ•°
            if (e instanceof SofaRpcRuntimeException) {
                throw (SofaRpcRuntimeException) e;
            } else {
                throw new SofaRpcRuntimeException("Build consumer proxy error!", e);
            }
        }
        if (consumerConfig.getOnAvailable() != null && cluster != null) {
            cluster.checkStateChange(false); // çŠ¶æ€å˜åŒ–é€šçŸ¥ç›‘å¬å™¨
        }
        RpcRuntimeContext.cacheConsumerConfig(this);
        return proxyIns;
    }
}
```

é»˜è®¤æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨å™¨DefaultConsumerBootstrapå¼•ç”¨æœåŠ¡æ–¹æ³•æ‰§è¡Œé€»è¾‘ï¼š
 (1)æ ¹æ®æœåŠ¡å¼•ç”¨é…ç½®ConsumerConfig è·å–è°ƒç”¨åè®®ã€æœåŠ¡æ¥å£ä»¥åŠæœåŠ¡æ ‡ç­¾æ„å»ºkeyä»¥åŠè·å–åº”ç”¨åç§°appNameï¼›
 (2)è°ƒç”¨checkParameters()æ–¹æ³•æ£€æŸ¥æœåŠ¡æ¶ˆè´¹è€…é…ç½®å­—æ®µå’Œå‚æ•°ï¼š

```Java
/**
 * for check fields and parameters of consumer config
 */
protected void checkParameters() {

}
```

(3)æ£€éªŒåŒä¸€ä¸ªæœåŠ¡(è°ƒç”¨åè®®&æœåŠ¡æ¥å£&æœåŠ¡æ ‡ç­¾ç›¸åŒ)çš„å‘å¸ƒæ¬¡æ•°æ˜¯å¦è¶…è¿‡æœåŠ¡å¼•ç”¨é…ç½®çš„æœ€å¤§æ¬¡æ•°ï¼Œè¶…è¿‡æœ€å¤§æ•°é‡ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼›
 (4)å®¢æˆ·ç«¯é›†ç¾¤å·¥å‚ClusterFactoryé€šè¿‡æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨å™¨æ„é€ å®¢æˆ·ç«¯é›†ç¾¤Clusterï¼Œæ ¹æ®æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨å™¨æœåŠ¡æ¶ˆè´¹è€…é…ç½®æ‰©å±•åŠ è½½å·¥å‚ExtensionLoaderFactoryåŠ è½½åˆå§‹åŒ–Clusterå®ä¾‹ï¼š

```Java
/**
 * æ„é€ Clientå¯¹è±¡
 *
 * @param consumerBootstrap å®¢æˆ·ç«¯é…ç½®
 * @return Clientå¯¹è±¡
 */
public static Cluster getCluster(ConsumerBootstrap consumerBootstrap) {
    try {
        ConsumerConfig consumerConfig = consumerBootstrap.getConsumerConfig();
        ExtensionClass<Cluster> ext = ExtensionLoaderFactory.getExtensionLoader(Cluster.class)
            .getExtensionClass(consumerConfig.getCluster());
        if (ext == null) {
            throw ExceptionUtils.buildRuntime("consumer.cluster",
                consumerConfig.getCluster(), "Unsupported cluster of client!");
        }
        return ext.getExtInstance(new Class[] { ConsumerBootstrap.class },
            new Object[] { consumerBootstrap });
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException(e.getMessage(), e);
    }
}
```

å®¢æˆ·ç«¯é›†ç¾¤Clusterå°è£…é›†ç¾¤æ¨¡å¼ã€é•¿è¿æ¥ç®¡ç†ã€æœåŠ¡è·¯ç”±ã€è´Ÿè½½å‡è¡¡ç­‰æŠ½è±¡ç±»ï¼Œå®ç°è°ƒç”¨å™¨Invokerã€æœåŠ¡å‘å¸ƒä¿¡æ¯ç›‘å¬å™¨ProviderInfoListenerã€å¯åˆå§‹åŒ–æ¥å£Initializable, å¯é”€æ¯æ¥å£Destroyableï¼Œæ¶µç›–ä¸¤ç§å®¢æˆ·ç«¯é›†ç¾¤å®ç°ç±»ï¼šå¿«é€Ÿå¤±è´¥å®¢æˆ·ç«¯é›†ç¾¤FailFastClusterå’Œæ•…éšœè½¬ç§»(æ”¯æŒé‡è¯•å’ŒæŒ‡å®šåœ°å€è°ƒç”¨)å®¢æˆ·ç«¯é›†ç¾¤FailoverClusterï¼š

```Java
/**
 * å®¢æˆ·ç«¯ï¼Œå°è£…äº†é›†ç¾¤æ¨¡å¼ã€é•¿è¿æ¥ç®¡ç†ã€æœåŠ¡è·¯ç”±ã€è´Ÿè½½å‡è¡¡ç­‰æŠ½è±¡ç±»
 *
 */
@Extensible(singleton = false)
@ThreadSafe
public abstract class Cluster implements Invoker, ProviderInfoListener, Initializable, Destroyable {...}
/**
 * å¿«é€Ÿå¤±è´¥
 *
 */
@Extension("failfast")
public class FailFastCluster extends AbstractCluster {...}
/**
 * æ•…éšœè½¬ç§»ï¼Œæ”¯æŒé‡è¯•å’ŒæŒ‡å®šåœ°å€è°ƒç”¨
 *
 */
@Extension("failover")
public class FailoverCluster extends AbstractCluster {...}
```

(5)æœåŠ¡ç«¯è®¢é˜…è€…é…ç½®å®ä¾‹è®¾ç½®æ ¹æ®æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨å™¨æ„å»ºçš„æœåŠ¡å¼•ç”¨é…ç½®å‘ç”Ÿå˜åŒ–ç›‘å¬å™¨ã€é›†ç¾¤æœåŠ¡ç«¯åœ°å€ç›‘å¬å™¨ï¼›
 (6)åˆå§‹åŒ–å®¢æˆ·ç«¯é›†ç¾¤Clusterå®ä¾‹åŒ…æ‹¬æ„å»ºè·¯ç”±é“¾routerChainï¼ŒåŠ è½½è´Ÿè½½å‡è¡¡ç­–ç•¥loadBalancerï¼Œè·å–åœ°å€ä¿æŒå™¨addressHolderï¼Œæ„é€ è°ƒç”¨ç«¯è¿‡æ»¤é“¾filterChainï¼Œè¿æ¥ç®¡ç†å™¨å¯åŠ¨é‡è¿çº¿ç¨‹ï¼ŒæœåŠ¡æ¶ˆè´¹å¯åŠ¨å™¨è®¢é˜…æœåŠ¡å‘å¸ƒè€…åˆ—è¡¨ï¼Œåˆå§‹åŒ–æœåŠ¡ç«¯è¿æ¥å»ºç«‹é•¿è¿æ¥ï¼š

```Java
public synchronized void init() {
    if (initialized) { // å·²åˆå§‹åŒ–
        return;
    }
    // æ„é€ Routeré“¾
    routerChain = RouterChain.buildConsumerChain(consumerBootstrap);
    // è´Ÿè½½å‡è¡¡ç­–ç•¥ è€ƒè™‘æ˜¯å¦å¯åŠ¨æ€æ›¿æ¢ï¼Ÿ
    loadBalancer = LoadBalancerFactory.getLoadBalancer(consumerBootstrap);
    // åœ°å€ç®¡ç†å™¨
    addressHolder = AddressHolderFactory.getAddressHolder(consumerBootstrap);
    // è¿æ¥ç®¡ç†å™¨
    connectionHolder = ConnectionHolderFactory.getConnectionHolder(consumerBootstrap);
    // æ„é€ Filteré“¾,æœ€åº•å±‚æ˜¯è°ƒç”¨è¿‡æ»¤å™¨
    this.filterChain = FilterChain.buildConsumerChain(this.consumerConfig,
        new ConsumerInvoker(consumerBootstrap));

    if (consumerConfig.isLazy()) { // å»¶è¿Ÿè¿æ¥
        if (LOGGER.isInfoEnabled(consumerConfig.getAppName())) {
            LOGGER.infoWithApp(consumerConfig.getAppName(), "Connection will be initialized when first invoke.");
        }
    }

    // å¯åŠ¨é‡è¿çº¿ç¨‹
    connectionHolder.init();
    try {
        // å¾—åˆ°æœåŠ¡ç«¯åˆ—è¡¨
        List<ProviderGroup> all = consumerBootstrap.subscribe();
        if (CommonUtils.isNotEmpty(all)) {
            // åˆå§‹åŒ–æœåŠ¡ç«¯è¿æ¥ï¼ˆå»ºç«‹é•¿è¿æ¥)
            updateAllProviders(all);
        }
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException("Init provider's transport error!", e);
    }

    // å¯åŠ¨æˆåŠŸ
    initialized = true;

    // å¦‚æœcheck=trueè¡¨ç¤ºå¼ºä¾èµ–
    if (consumerConfig.isCheck() && !isAvailable()) {
        throw new SofaRpcRuntimeException("The consumer is depend on alive provider " +
            "and there is no alive provider, you can ignore it " +
            "by ConsumerConfig.setCheck(boolean) (default is false)");
    }
}
```

è·¯ç”±é“¾RouterChainæ ¹æ®æœåŠ¡ç«¯è®¢é˜…è€…é…ç½®æ„å»ºæœåŠ¡æ¶ˆè´¹è·¯ç”±é“¾ï¼š1.è·å–æœåŠ¡å¼•ç”¨é…ç½®è·¯ç”±è§„åˆ™å¼•ç”¨ï¼›2.è§£æè·¯ç”±è§„åˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦æ’é™¤ç³»ç»Ÿè¿‡æ»¤å™¨ï¼›3.è§£æé€šè¿‡åˆ«åæ–¹å¼æ³¨å…¥çš„è·¯ç”±å‡†å¤‡æ•°æ®ï¼›4.è§£æè‡ªåŠ¨åŠ è½½çš„è·¯ç”±æ·»åŠ åˆ°æ‰©å±•è·¯ç”±é›†åˆï¼›5.æ ¹æ®æ‰©å±•è·¯ç”±å’ŒæœåŠ¡ç«¯è®¢é˜…è€…å¯åŠ¨å™¨åˆ›å»ºè·¯ç”±é“¾RouteChainï¼š

```Java
/**
 * æ„å»ºRouteré“¾
 *
 * @param consumerBootstrap æœåŠ¡ç«¯è®¢é˜…è€…é…ç½®
 * @return è·¯ç”±é“¾
 */
public static RouterChain buildConsumerChain(ConsumerBootstrap consumerBootstrap) {
    ConsumerConfig<?> consumerConfig = consumerBootstrap.getConsumerConfig();
    List<Router> customRouters = consumerConfig.getRouterRef() == null ? new ArrayList<Router>()
        : new CopyOnWriteArrayList<Router>(consumerConfig.getRouterRef());
    // å…ˆè§£ææ˜¯å¦æœ‰ç‰¹æ®Šå¤„ç†
    HashSet<String> excludes = parseExcludeRouter(customRouters);

    // å‡†å¤‡æ•°æ®ï¼šç”¨æˆ·é€šè¿‡åˆ«åçš„æ–¹å¼æ³¨å…¥çš„routerï¼Œéœ€è¦è§£æ
    List<ExtensionClass<Router>> extensionRouters = new ArrayList<ExtensionClass<Router>>();
    List<String> routerAliases = consumerConfig.getRouter();
    if (CommonUtils.isNotEmpty(routerAliases)) {
        for (String routerAlias : routerAliases) {
            if (startsWithExcludePrefix(routerAlias)) { // æ’é™¤ç”¨çš„ç‰¹æ®Šå­—ç¬¦
                excludes.add(routerAlias.substring(1));
            } else {
                extensionRouters.add(EXTENSION_LOADER.getExtensionClass(routerAlias));
            }
        }
    }
    // è§£æè‡ªåŠ¨åŠ è½½çš„router
    if (!excludes.contains(StringUtils.ALL) && !excludes.contains(StringUtils.DEFAULT)) { // é…äº†-*å’Œ-defaultè¡¨ç¤ºä¸åŠ è½½å†…ç½®
        for (Map.Entry<String, ExtensionClass<Router>> entry : CONSUMER_AUTO_ACTIVES.entrySet()) {
            if (!excludes.contains(entry.getKey())) {
                extensionRouters.add(entry.getValue());
            }
        }
    }
    excludes = null; // ä¸éœ€è¦äº†
    // æŒ‰orderä»å°åˆ°å¤§æ’åº
    if (extensionRouters.size() > 1) {
        Collections.sort(extensionRouters, new OrderedComparator<ExtensionClass>());
    }
    List<Router> actualRouters = new ArrayList<Router>();
    for (ExtensionClass<Router> extensionRouter : extensionRouters) {
        Router actualRoute = extensionRouter.getExtInstance();
        actualRouters.add(actualRoute);
    }
    // åŠ å…¥è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨
    actualRouters.addAll(customRouters);
    return new RouterChain(actualRouters, consumerBootstrap);
}
/**
 * åˆ¤æ–­æ˜¯å¦éœ€è¦æ’é™¤ç³»ç»Ÿè¿‡æ»¤å™¨
 *
 * @param customRouters è‡ªå®šä¹‰Router
 * @return æ˜¯å¦æ’é™¤
 */
private static HashSet<String> parseExcludeRouter(List<Router> customRouters) {
    HashSet<String> excludeKeys = new HashSet<String>();
    if (CommonUtils.isNotEmpty(customRouters)) {
        for (Router router : customRouters) {
            if (router instanceof ExcludeRouter) {
                // å­˜åœ¨éœ€è¦æ’é™¤çš„è¿‡æ»¤å™¨
                ExcludeRouter excludeRouter = (ExcludeRouter) router;
                String excludeName = excludeRouter.getExcludeName();
                if (StringUtils.isNotEmpty(excludeName)) {
                    String excludeRouterName = startsWithExcludePrefix(excludeName) ? excludeName.substring(1)
                        : excludeName;
                    if (StringUtils.isNotEmpty(excludeRouterName)) {
                        excludeKeys.add(excludeRouterName);
                    }
                }
                customRouters.remove(router);
            }
        }
    }
    if (!excludeKeys.isEmpty()) {
        if (LOGGER.isInfoEnabled()) {
            LOGGER.info("Find exclude routers: {}", excludeKeys);
        }
    }
    return excludeKeys;
}
public RouterChain(List<Router> actualRouters, ConsumerBootstrap consumerBootstrap) {
    this.routers = new ArrayList<Router>();
    if (CommonUtils.isNotEmpty(actualRouters)) {
        for (Router router : actualRouters) {
            if (router.needToLoad(consumerBootstrap)) {
                router.init(consumerBootstrap);
                routers.add(router);
            }
        }
    }
}
```

è´Ÿè½½å‡è¡¡å·¥å‚LoadBalancerFactoryã€åœ°å€ç®¡ç†å·¥å‚AddressHolderFactoryã€è¿æ¥ç®¡ç†å·¥å‚ConnectionHolderæ ¹æ®æœåŠ¡æ¶ˆè´¹è€…é…ç½®è·å–è´Ÿè½½å‡è¡¡å™¨ã€åœ°å€ä¿æŒå™¨ã€è¿æ¥ç®¡ç†å™¨ï¼šè¯»å–æœåŠ¡æ¶ˆè´¹é…ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥ã€åœ°å€ä¿æŒé…ç½®ã€è¿æ¥ç®¡ç†é…ç½®ï¼Œæ‰©å±•åŠ è½½å·¥å‚ExtensionLoaderFactoryæ ¹æ®è´Ÿè½½å‡è¡¡ã€åœ°å€ä¿æŒã€è¿æ¥ç®¡ç†ç›¸åº”é…ç½®ç”Ÿæˆè´Ÿè½½å‡è¡¡å™¨ã€åœ°å€ä¿æŒå™¨ã€è¿æ¥ç®¡ç†å™¨å®ä¾‹ï¼š

```Java
/**
 * æ ¹æ®åå­—å¾—åˆ°è´Ÿè½½å‡è¡¡å™¨
 *
 * @param consumerBootstrap æœåŠ¡è®¢é˜…è€…é…ç½®
 * @return LoadBalancer
 */
public static LoadBalancer getLoadBalancer(ConsumerBootstrap consumerBootstrap) {
    try {
        String loadBalancer = consumerBootstrap.getConsumerConfig().getLoadBalancer();
        ExtensionClass<LoadBalancer> ext = ExtensionLoaderFactory
            .getExtensionLoader(LoadBalancer.class).getExtensionClass(loadBalancer);
        if (ext == null) {
            throw ExceptionUtils.buildRuntime("consumer.loadBalancer",
                loadBalancer, "Unsupported loadBalancer of client!");
        }
        return ext.getExtInstance(new Class[] { ConsumerBootstrap.class }, new Object[] { consumerBootstrap });
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException(e.getMessage(), e);
    }
}
/**
 * æ ¹æ®é…ç½®å¾—åˆ°è¿æ¥ç®¡ç†å™¨
 *
 * @param consumerBootstrap æœåŠ¡æ¶ˆè´¹è€…é…ç½®
 * @return AddressHolder
 */
public static AddressHolder getAddressHolder(ConsumerBootstrap consumerBootstrap) {
    try {
        String connectionHolder = consumerBootstrap.getConsumerConfig().getAddressHolder();
        ExtensionClass<AddressHolder> ext = ExtensionLoaderFactory.getExtensionLoader(AddressHolder.class)
            .getExtensionClass(connectionHolder);
        if (ext == null) {
            throw ExceptionUtils.buildRuntime("consumer.addressHolder", connectionHolder,
                "Unsupported addressHolder of client!");
        }
        return ext.getExtInstance(new Class[] { ConsumerBootstrap.class }, new Object[] { consumerBootstrap });
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException(e.getMessage(), e);
    }
}
/**
 * æ ¹æ®é…ç½®å¾—åˆ°è¿æ¥ç®¡ç†å™¨
 *
 * @param consumerBootstrap æœåŠ¡æ¶ˆè´¹è€…é…ç½®
 * @return ConnectionHolder
 */
public static ConnectionHolder getConnectionHolder(ConsumerBootstrap consumerBootstrap) {
    try {
        String connectionHolder = consumerBootstrap.getConsumerConfig().getConnectionHolder();
        ExtensionClass<ConnectionHolder> ext = ExtensionLoaderFactory
            .getExtensionLoader(ConnectionHolder.class).getExtensionClass(connectionHolder);
        if (ext == null) {
            throw ExceptionUtils.buildRuntime("consumer.connectionHolder", connectionHolder,
                "Unsupported connectionHolder of client!");
        }
        return ext.getExtInstance(new Class[] { ConsumerBootstrap.class }, new Object[] { consumerBootstrap });
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException(e.getMessage(), e);
    }
}
```

å®¢æˆ·ç«¯é›†ç¾¤æŒ‰ç…§æœåŠ¡å™¨å¯åŠ¨å™¨é…ç½®æ„é€ æ¶ˆè´¹è°ƒç”¨å™¨ConsumerInvokerï¼Œæ¶ˆè´¹è°ƒç”¨å™¨invoke()æ–¹æ³•ä½¿ç”¨å®¢æˆ·ç«¯å‘é€æ•°æ®ç»™æœåŠ¡å™¨æ‰§è¡ŒæœåŠ¡è°ƒç”¨è¿‡ç¨‹ï¼Œè®¾ç½®è°ƒç”¨æœåŠ¡ç«¯è¿œç¨‹åœ°å€åŒæ­¥/å•å‘/Callback/ Futureè°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œè­¬å¦‚Boltå®¢æˆ·ç«¯ä¼ è¾“BoltClientTransportåŒæ­¥è°ƒç”¨é€šè¿‡RpcClientè·å–è¿œç¨‹è¿æ¥ä½¿ç”¨ç®¡é“Channelçš„writeAndFlush(Object msg)æ–¹æ³•å‘é€å®¢æˆ·ç«¯æ•°æ®ï¼Œå¹¶ä¸”æ·»åŠ ç›‘å¬å™¨æä¾›å‘é€å¤±è´¥Futureæ·»åŠ å¤±è´¥å“åº”åœºæ™¯è¿›è¡Œè¿œç¨‹è®¿é—®è°ƒç”¨ã€‚è¿‡æ»¤é“¾FilterChainæ ¹æ®æœåŠ¡ç«¯è®¢é˜…è€…é…ç½®æ„é€ è°ƒç”¨ç«¯æ‰§è¡Œé“¾ï¼Œè°ƒç”¨ç«¯æ‰§è¡Œé“¾æœ€åº•å±‚æ˜¯è°ƒç”¨è¿‡æ»¤å™¨ï¼šæŒ‰ç…§è‡ªåŠ¨è£…è½½æ‰©å±•å®ç°é€»è¾‘è·å–ç”¨æˆ·newå®ä¾‹æ–¹å¼æ³¨å…¥çš„è¿‡æ»¤å™¨(ä¼˜å…ˆçº§é«˜)ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ’é™¤ç³»ç»Ÿè¿‡æ»¤å™¨ï¼Œè§£æç”¨æˆ·é€šè¿‡åˆ«åæ–¹å¼æ³¨å…¥çš„è¿‡æ»¤å™¨å‡†å¤‡æ•°æ®ï¼Œè§£æè‡ªåŠ¨åŠ è½½çš„è¿‡æ»¤å™¨æ·»åŠ åˆ°è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨æ„é€ æ‰§è¡Œé“¾ï¼š

```Java
/**
* Instantiates a new Consumer invoke filter.
*
* @param consumerBootstrap æœåŠ¡å™¨å¯åŠ¨ç€é…ç½®
*/
public ConsumerInvoker(ConsumerBootstrap consumerBootstrap) {
   super(consumerBootstrap.getConsumerConfig());
   this.consumerBootstrap = consumerBootstrap;
}

public SofaResponse invoke(SofaRequest sofaRequest) throws SofaRpcException {
   // è®¾ç½®ä¸‹æœåŠ¡å™¨åº”ç”¨
   ProviderInfo providerInfo = RpcInternalContext.getContext().getProviderInfo();
   String appName = providerInfo.getStaticAttr(ProviderInfoAttrs.ATTR_APP_NAME);
   if (StringUtils.isNotEmpty(appName)) {
       sofaRequest.setTargetAppName(appName);
   }

   // ç›®å‰åªæ˜¯é€šè¿‡clientå‘é€ç»™æœåŠ¡ç«¯
   return consumerBootstrap.getCluster().sendMsg(providerInfo, sofaRequest);
}
/**
* è°ƒç”¨å®¢æˆ·ç«¯
*
* @param transport å®¢æˆ·ç«¯è¿æ¥
* @param request   Requestå¯¹è±¡
* @return è°ƒç”¨ç»“æœ
* @throws SofaRpcException rpcå¼‚å¸¸
*/
protected SofaResponse doSendMsg(ProviderInfo providerInfo, ClientTransport transport,
                                SofaRequest request) throws SofaRpcException {
   RpcInternalContext context = RpcInternalContext.getContext();
   // æ·»åŠ è°ƒç”¨çš„æœåŠ¡ç«¯è¿œç¨‹åœ°å€
   RpcInternalContext.getContext().setRemoteAddress(providerInfo.getHost(), providerInfo.getPort());
   try {
       checkProviderVersion(providerInfo, request); // æ ¹æ®æœåŠ¡ç«¯ç‰ˆæœ¬ç‰¹æ®Šå¤„ç†
       String invokeType = request.getInvokeType();
       int timeout = resolveTimeout(request, consumerConfig, providerInfo);

       SofaResponse response = null;
       // åŒæ­¥è°ƒç”¨
       if (RpcConstants.INVOKER_TYPE_SYNC.equals(invokeType)) {
           long start = RpcRuntimeContext.now();
           try {
               response = transport.syncSend(request, timeout);
           } finally {
               if (RpcInternalContext.isAttachmentEnable()) {
                   long elapsed = RpcRuntimeContext.now() - start;
                   context.setAttachment(RpcConstants.INTERNAL_KEY_CLIENT_ELAPSE, elapsed);
               }
           }
       }
       // å•å‘è°ƒç”¨
       else if (RpcConstants.INVOKER_TYPE_ONEWAY.equals(invokeType)) {
           long start = RpcRuntimeContext.now();
           try {
               transport.oneWaySend(request, timeout);
               response = buildEmptyResponse(request);
           } finally {
               if (RpcInternalContext.isAttachmentEnable()) {
                   long elapsed = RpcRuntimeContext.now() - start;
                   context.setAttachment(RpcConstants.INTERNAL_KEY_CLIENT_ELAPSE, elapsed);
               }
           }
       }
       // Callbackè°ƒç”¨
       else if (RpcConstants.INVOKER_TYPE_CALLBACK.equals(invokeType)) {
           // è°ƒç”¨çº§åˆ«å›è°ƒç›‘å¬å™¨
           SofaResponseCallback sofaResponseCallback = request.getSofaResponseCallback();
           if (sofaResponseCallback == null) {
               SofaResponseCallback methodResponseCallback = consumerConfig
                   .getMethodOnreturn(request.getMethodName());
               if (methodResponseCallback != null) { // æ–¹æ³•çš„Callback
                   request.setSofaResponseCallback(methodResponseCallback);
               }
           }
           // è®°å½•å‘é€å¼€å§‹æ—¶é—´
           context.setAttachment(RpcConstants.INTERNAL_KEY_CLIENT_SEND_TIME, RpcRuntimeContext.now());
           // å¼€å§‹è°ƒç”¨
           transport.asyncSend(request, timeout);
           response = buildEmptyResponse(request);
       }
       // Futureè°ƒç”¨
       else if (RpcConstants.INVOKER_TYPE_FUTURE.equals(invokeType)) {
           // è®°å½•å‘é€å¼€å§‹æ—¶é—´
           context.setAttachment(RpcConstants.INTERNAL_KEY_CLIENT_SEND_TIME, RpcRuntimeContext.now());
           // å¼€å§‹è°ƒç”¨
           ResponseFuture future = transport.asyncSend(request, timeout);
           // æ”¾å…¥çº¿ç¨‹ä¸Šä¸‹æ–‡
           RpcInternalContext.getContext().setFuture(future);
           response = buildEmptyResponse(request);
       } else {
           throw new SofaRpcException(RpcErrorType.CLIENT_UNDECLARED_ERROR, "Unknown invoke type:" + invokeType);
       }
       return response;
   } catch (SofaRpcException e) {
       throw e;
   } catch (Throwable e) { // å®¢æˆ·ç«¯å…¶å®ƒå¼‚å¸¸
       throw new SofaRpcException(RpcErrorType.CLIENT_UNDECLARED_ERROR, e);
   }
}
/**
 * æ„é€ è°ƒç”¨ç«¯çš„æ‰§è¡Œé“¾
 *
 * @param consumerConfig consumeré…ç½®
 * @param lastFilter     æœ€åä¸€ä¸ªfilter
 * @return filteræ‰§è¡Œé“¾
 */
public static FilterChain buildConsumerChain(ConsumerConfig<?> consumerConfig, FilterInvoker lastFilter) {

    /*
    * ä¾‹å¦‚è‡ªåŠ¨è£…è½½æ‰©å±• A(a),B(b),C(c)  filter=[-a,d]  filterRef=[new E, new Exclude(b)]
    * é€»è¾‘å¦‚ä¸‹ï¼š
    * 1.è§£æconfig.getFilterRef()ï¼Œè®°å½•Eå’Œ-b
    * 2.è§£æconfig.getFilter()å­—ç¬¦ä¸²ï¼Œè®°å½• d å’Œ -a,-b
    * 3.å†è§£æè‡ªåŠ¨è£…è½½æ‰©å±•ï¼Œa,bè¢«æ’é™¤äº†ï¼Œæ‰€ä»¥æ‹¿åˆ°c,d
    * 4.å¯¹c dè¿›è¡Œæ’åº
    * 5.æ‹¿åˆ°Cã€Då®ç°ç±»
    * 6.åŠ ä¸Šè‡ªå®šä¹‰ï¼Œè¿”å›Cã€Dã€E
    */
    // ç”¨æˆ·é€šè¿‡è‡ªå·±newå®ä¾‹çš„æ–¹å¼æ³¨å…¥çš„filterï¼Œä¼˜å…ˆçº§é«˜
    List<Filter> customFilters = consumerConfig.getFilterRef() == null ?
        new ArrayList<Filter>() : new CopyOnWriteArrayList<Filter>(consumerConfig.getFilterRef());
    // å…ˆè§£ææ˜¯å¦æœ‰ç‰¹æ®Šå¤„ç†
    HashSet<String> excludes = parseExcludeFilter(customFilters);

    // å‡†å¤‡æ•°æ®ï¼šç”¨æˆ·é€šè¿‡åˆ«åçš„æ–¹å¼æ³¨å…¥çš„filterï¼Œéœ€è¦è§£æ
    List<ExtensionClass<Filter>> extensionFilters = new ArrayList<ExtensionClass<Filter>>();
    List<String> filterAliases = consumerConfig.getFilter(); //
    if (CommonUtils.isNotEmpty(filterAliases)) {
        for (String filterAlias : filterAliases) {
            if (startsWithExcludePrefix(filterAlias)) { // æ’é™¤ç”¨çš„ç‰¹æ®Šå­—ç¬¦
                excludes.add(filterAlias.substring(1));
            } else {
                ExtensionClass<Filter> filter = EXTENSION_LOADER.getExtensionClass(filterAlias);
                if (filter != null) {
                    extensionFilters.add(filter);
                }
            }
        }
    }
    // è§£æè‡ªåŠ¨åŠ è½½çš„è¿‡æ»¤å™¨
    if (!excludes.contains(StringUtils.ALL) && !excludes.contains(StringUtils.DEFAULT)) { // é…äº†-*å’Œ-defaultè¡¨ç¤ºä¸åŠ è½½å†…ç½®
        for (Map.Entry<String, ExtensionClass<Filter>> entry : CONSUMER_AUTO_ACTIVES.entrySet()) {
            if (!excludes.contains(entry.getKey())) {
                extensionFilters.add(entry.getValue());
            }
        }
    }
    excludes = null; // ä¸éœ€è¦äº†
    // æŒ‰orderä»å°åˆ°å¤§æ’åº
    if (extensionFilters.size() > 1) {
        Collections.sort(extensionFilters, new OrderedComparator<ExtensionClass<Filter>>());
    }
    List<Filter> actualFilters = new ArrayList<Filter>();
    for (ExtensionClass<Filter> extensionFilter : extensionFilters) {
        actualFilters.add(extensionFilter.getExtInstance());
    }
    // åŠ å…¥è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨
    actualFilters.addAll(customFilters);
    return new FilterChain(actualFilters, lastFilter, consumerConfig);
}
```

è¿æ¥ç®¡ç†å™¨åˆå§‹åŒ–å¯åŠ¨é‡è¿çº¿ç¨‹ï¼šè¯»å–æœåŠ¡å¼•ç”¨é…ç½®æœåŠ¡æ¥å£ä»¥åŠæœåŠ¡ç«¯æ¶ˆè´¹è€…ç»™æä¾›è€…é‡è¿é—´éš”åˆ›å»ºçº¿ç¨‹æ± å¯åŠ¨é‡è¿+å¿ƒè·³çº¿ç¨‹ï¼Œå­˜æ´»çš„å®¢æˆ·ç«¯åˆ—è¡¨(ä¿æŒé•¿è¿æ¥ï¼Œä¸”ä¸€åˆ‡æ­£å¸¸çš„)æ£€æŸ¥å¯ç”¨è¿æ¥ï¼Œéå¯ç”¨è¿æ¥(ä¸å¯ç”¨çš„é•¿è¿æ¥)ä»å­˜æ´»ä¸¢åˆ°é‡è¯•åˆ—è¡¨ï¼Œå¤±è´¥å¾…é‡è¯•çš„å®¢æˆ·ç«¯åˆ—è¡¨(è¿ä¸Šåæ–­å¼€çš„)å‘½ä¸­æœåŠ¡æä¾›è€…åŠ¨æ€é…ç½®çš„é‡è¯•å‘¨æœŸç³»æ•°è¿›è¡Œé‡è¿ï¼Œå®¢æˆ·ç«¯ä¼ è¾“å»ºç«‹é•¿è¿æ¥(åŸºäºBoltåè®®çš„å®¢æˆ·ç«¯ä¼ è¾“å®ç°BoltClientTransportåªæ”¯æŒé•¿è¿æ¥å…±äº«æ¨¡å¼ï¼ŒRpcClienté€šè¿‡URLç¼“å­˜å’Œè¶…æ—¶æ—¶é—´å»ºç«‹è¿æ¥ï¼ŒåŸºäºç¬¬ä¸‰æ–¹åè®®è­¬å¦‚cxf/resteasyçš„å®¢æˆ·ç«¯ä¼ è¾“å®ç°AbstractProxyClientTransportï¼ŒæŒ‰ç…§å®¢æˆ·ç«¯é…ç½®å»ºç«‹Socketè¿æ¥)ï¼Œä¸¤æ¬¡éªŒè¯æ£€æŸ¥å®¢æˆ·ç«¯ä¼ è¾“æ˜¯å¦å­˜æ´»ï¼Œç¡çœ é˜²æ­¢è¢«è¿ä¸Šåˆè¢«æœåŠ¡ç«¯è¸¢ä¸‹çº¿ï¼Œè®¾ç½®æœåŠ¡æä¾›è€…é‡è¯•å‘¨æœŸç³»æ•°ï¼Œä»é‡è¯•ä¸¢åˆ°å­˜æ´»åˆ—è¡¨ï¼Œå­˜æ´»çš„å®¢æˆ·ç«¯åˆ—è¡¨å’Œå­˜æ´»ä½†æ˜¯äºšå¥åº·èŠ‚ç‚¹(è¿ç»­å¿ƒè·³è¶…æ—¶ï¼Œè¿™ç§åªå‘å¿ƒè·³ï¼Œä¸å‘è¯·æ±‚)åŸæ¥ä¸ºç©ºå˜æˆéç©ºéœ€è¦é€šçŸ¥çŠ¶æ€å˜æˆå¯ç”¨ï¼Œä¸»è¦åŒ…æ‹¬1.å¯åŠ¨æˆåŠŸå˜æˆå¯ç”¨æ—¶ï¼›2.æ³¨å†Œä¸­å¿ƒå¢åŠ ï¼Œæ›´æ–°èŠ‚ç‚¹åå˜æˆå¯ç”¨æ—¶ï¼›3.é‡è¿ä¸Šä»ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹éƒ½æ²¡æœ‰å˜æˆæœ‰å¯ç”¨èŠ‚ç‚¹æ—¶ï¼š

```Java
public void init() {
    if (reconThread == null) {
        startReconnectThread();
    }
}
/**
 * å¯åŠ¨é‡è¿+å¿ƒè·³çº¿ç¨‹
 */
protected void startReconnectThread() {
    final String interfaceId = consumerConfig.getInterfaceId();
    // å¯åŠ¨çº¿ç¨‹æ± 
    // é»˜è®¤æ¯éš”10ç§’é‡è¿
    int reconnect = consumerConfig.getReconnectPeriod();
    if (reconnect > 0) {
        reconnect = Math.max(reconnect, 2000); // æœ€å°2000
        reconThread = new ScheduledService("CLI-RC-" + interfaceId, ScheduledService.MODE_FIXEDDELAY, new
            Runnable() {
                @Override
                public void run() {
                    try {
                        doReconnect();
                    } catch (Throwable e) {
                        LOGGER.errorWithApp(consumerConfig.getAppName(),
                            "Exception when retry connect to provider", e);
                    }
                }
            }, reconnect, reconnect, TimeUnit.MILLISECONDS).start();
    }
}
/**
 * é‡è¿æ–­å¼€å’Œæ­»äº¡çš„èŠ‚ç‚¹
 */
private void doReconnect() {
    String interfaceId = consumerConfig.getInterfaceId();
    String appName = consumerConfig.getAppName();
    int thisTime = reconnectFlag.incrementAndGet();
    boolean print = thisTime % 6 == 0; //æ˜¯å¦æ‰“å°error,æ¯6æ¬¡æ‰“å°ä¸€æ¬¡
    boolean isAliveEmptyFirst = isAvailableEmpty();
    // æ£€æŸ¥å¯ç”¨è¿æ¥  todo subHealth
    for (Map.Entry<ProviderInfo, ClientTransport> alive : aliveConnections.entrySet()) {
        ClientTransport connection = alive.getValue();
        if (connection != null && !connection.isAvailable()) {
            aliveToRetry(alive.getKey(), connection);
        }
    }
    for (Map.Entry<ProviderInfo, ClientTransport> entry : getRetryConnections()
        .entrySet()) {
        ProviderInfo providerInfo = entry.getKey();
        int providerPeriodCoefficient = CommonUtils.parseNum((Integer)
            providerInfo.getDynamicAttr(ProviderInfoAttrs.ATTR_RC_PERIOD_COEFFICIENT), 1);
        if (thisTime % providerPeriodCoefficient != 0) {
            continue; // å¦‚æœå‘½ä¸­é‡è¿å‘¨æœŸï¼Œåˆ™è¿›è¡Œé‡è¿
        }
        ClientTransport transport = entry.getValue();
        if (LOGGER.isDebugEnabled(appName)) {
            LOGGER.debugWithApp("Retry connect to {} provider:{} ...", interfaceId, providerInfo);
        }
        try {
            transport.connect();
            if (doubleCheck(interfaceId, providerInfo, transport)) {
                providerInfo.setDynamicAttr(ProviderInfoAttrs.ATTR_RC_PERIOD_COEFFICIENT, 1);
                retryToAlive(providerInfo, transport);
            }
        } catch (Exception e) {
            if (print) {
                if (LOGGER.isWarnEnabled(appName)) {
                    LOGGER.warnWithApp("Retry connect to {} provider:{} error ! The exception is " + e
                        .getMessage(), interfaceId, providerInfo);
                }
            } else {
                if (LOGGER.isDebugEnabled(appName)) {
                    LOGGER.debugWithApp("Retry connect to {} provider:{} error ! The exception is " + e
                        .getMessage(), interfaceId, providerInfo);
                }
            }
        }
    }
    if (isAliveEmptyFirst && !isAvailableEmpty()) { // åŸæ¥ç©ºï¼Œå˜æˆä¸ç©º
        notifyStateChangeToAvailable();
    }
}
```

æœåŠ¡ç«¯æ¶ˆè´¹è€…å¯åŠ¨å™¨è®¢é˜…æœåŠ¡å‘å¸ƒåˆ—è¡¨ï¼Œè·å–æœåŠ¡æ¶ˆè´¹è€…é…ç½®ç›´è¿è°ƒç”¨åœ°å€ï¼Œåˆ¤æ–­ç›´è¿è°ƒç”¨åœ°å€æ˜¯å¦ä¸ºç©ºï¼Œç›´è¿è°ƒç”¨åœ°å€ä¸ºç©ºæ ¹æ®æ³¨å†Œä¸­å¿ƒé…ç½®ä»æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡å‘å¸ƒåˆ—è¡¨ï¼Œéå†æœåŠ¡ç«¯è®¢é˜…è€…æ³¨å†Œä¸­å¿ƒé…ç½®æ³¨å†Œä¸­å¿ƒå·¥å‚ç”Ÿæˆæ³¨å†Œä¸­å¿ƒå¯¹è±¡ï¼Œåˆå§‹åŒ–å¯åŠ¨æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡å‘å¸ƒåˆ—è¡¨æ·»åŠ åˆ°æœåŠ¡æä¾›è€…åˆ†ç»„ï¼›ç›´è¿è°ƒç”¨åœ°å€éç©ºæŒ‰ç…§é€—å·æˆ–è€…åˆ†å·åˆ†éš”ç›´è¿è°ƒç”¨åœ°å€éå†è½¬æ¢æˆæœåŠ¡ç«¯æä¾›è€…æ·»åŠ åˆ°é»˜è®¤ç›´è¿åˆ†ç»„ï¼Œè¿”å›ç›´è¿æœåŠ¡ç«¯å‘å¸ƒæ–¹åˆ†ç»„ï¼š

```Java
public List<ProviderGroup> subscribe() {
    List<ProviderGroup> result = null;
    String directUrl = consumerConfig.getDirectUrl();
    if (StringUtils.isNotEmpty(directUrl)) {
        // å¦‚æœèµ°ç›´è¿
        result = subscribeFromDirectUrl(directUrl);
    } else {
        // æ²¡æœ‰é…ç½®urlç›´è¿
        List<RegistryConfig> registryConfigs = consumerConfig.getRegistry();
        if (CommonUtils.isNotEmpty(registryConfigs)) {
            // ä»å¤šä¸ªæ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡åˆ—è¡¨
            result = subscribeFromRegistries();
        }
    }
    return result;
}
/**
 * Subscribe provider list from direct url
 *
 * @param directUrl direct url of consume config
 * @return Provider group list
 */
protected List<ProviderGroup> subscribeFromDirectUrl(String directUrl) {
    List<ProviderGroup> result = new ArrayList<ProviderGroup>();
    List<ProviderInfo> tmpProviderInfoList = new ArrayList<ProviderInfo>();
    String[] providerStrs = StringUtils.splitWithCommaOrSemicolon(directUrl);
    for (String providerStr : providerStrs) {
        ProviderInfo providerInfo = convertToProviderInfo(providerStr);
        if (providerInfo.getStaticAttr(ProviderInfoAttrs.ATTR_SOURCE) == null) {
            providerInfo.setStaticAttr(ProviderInfoAttrs.ATTR_SOURCE, "direct");
        }
        tmpProviderInfoList.add(providerInfo);
    }

    result.add(new ProviderGroup(RpcConstants.ADDRESS_DIRECT_GROUP, tmpProviderInfoList));
    return result;
}
/**
 * Subscribe provider list from all registries, the providers will be merged.
 *
 * @return Provider group list
 */
protected List<ProviderGroup> subscribeFromRegistries() {
    List<ProviderGroup> result = new ArrayList<ProviderGroup>();
    List<RegistryConfig> registryConfigs = consumerConfig.getRegistry();
    if (CommonUtils.isEmpty(registryConfigs)) {
        return result;
    }
    // æ˜¯å¦ç­‰å¾…ç»“æœ
    int addressWaitTime = consumerConfig.getAddressWait();
    int maxAddressWaitTime = SofaConfigs.getIntegerValue(consumerConfig.getAppName(),
        SofaOptions.CONFIG_MAX_ADDRESS_WAIT_TIME, SofaOptions.MAX_ADDRESS_WAIT_TIME);
    addressWaitTime = addressWaitTime < 0 ? maxAddressWaitTime : Math.min(addressWaitTime, maxAddressWaitTime);

    ProviderInfoListener listener = consumerConfig.getProviderInfoListener();
    respondRegistries = addressWaitTime == 0 ? null : new CountDownLatch(registryConfigs.size());

    // ä»æ³¨å†Œä¸­å¿ƒè®¢é˜… {groupName: ProviderGroup}
    Map<String, ProviderGroup> tmpProviderInfoList = new HashMap<String, ProviderGroup>();
    for (RegistryConfig registryConfig : registryConfigs) {
        Registry registry = RegistryFactory.getRegistry(registryConfig);
        registry.init();
        registry.start();

        try {
            List<ProviderGroup> current;
            try {
                if (respondRegistries != null) {
                    consumerConfig.setProviderInfoListener(new WrapperClusterProviderInfoListener(listener,
                        respondRegistries));
                }
                current = registry.subscribe(consumerConfig);
            } finally {
                if (respondRegistries != null) {
                    consumerConfig.setProviderInfoListener(listener);
                }
            }
            if (current == null) {
                continue; // æœªåŒæ­¥è¿”å›ç»“æœ
            } else {
                if (respondRegistries != null) {
                    respondRegistries.countDown();
                }
            }
            for (ProviderGroup group : current) { //  å½“å‰æ³¨å†Œä¸­å¿ƒçš„
                String groupName = group.getName();
                if (!group.isEmpty()) {
                    ProviderGroup oldGroup = tmpProviderInfoList.get(groupName);
                    if (oldGroup != null) {
                        oldGroup.addAll(group.getProviderInfos());
                    } else {
                        tmpProviderInfoList.put(groupName, group);
                    }
                }
            }
        } catch (SofaRpcRuntimeException e) {
            throw e;
        } catch (Throwable e) {
            String appName = consumerConfig.getAppName();
            if (LOGGER.isWarnEnabled(appName)) {
                LOGGER.warnWithApp(appName,
                    "Catch exception when subscribe from registry: " + registryConfig.getId()
                        + ", but you can ignore if it's called by JVM shutdown hook", e);
            }
        }
    }
    if (respondRegistries != null) {
        try {
            respondRegistries.await(addressWaitTime, TimeUnit.MILLISECONDS);
        } catch (Exception ignore) { // NOPMD
        }
    }
    return new ArrayList<ProviderGroup>(tmpProviderInfoList.values());
}
```

éå†ç›´è¿æœåŠ¡ç«¯æä¾›è€…åˆ†ç»„åˆå§‹åŒ–æœåŠ¡ç«¯è¿æ¥(å»ºç«‹é•¿è¿æ¥)ï¼Œæ£€æŸ¥æœåŠ¡èŠ‚ç‚¹åè®®ç±»å‹å’Œåºåˆ—åŒ–æ–¹å¼ä¿¡æ¯ï¼Œåœ°å€ä¿æŒå™¨/è¿æ¥ç®¡ç†å™¨å…¨é‡æ›´æ–°å…¨éƒ¨æœåŠ¡ç«¯åˆ—è¡¨ï¼Œä¾èµ–æœåŠ¡ç«¯æ¶ˆè´¹è€…é…ç½®ã€åœ°å€ä¿æŒå™¨æœåŠ¡ç«¯å‘å¸ƒè€…åˆ†ç»„ã€ç›´è¿æœåŠ¡ç«¯æä¾›è€…åˆ†ç»„æ„å»ºæœåŠ¡æä¾›æ›´æ–°äº‹ä»¶ç»™äº‹ä»¶æ€»çº¿å‘å¸ƒï¼Œäº‹ä»¶æ€»çº¿æŒ‰ç…§äº‹ä»¶è®¢é˜…è€…æ˜¯å¦åŒæ­¥è¿›è¡Œäº‹ä»¶åŒæ­¥/å¼‚æ­¥å¤„ç†ï¼š

```Java
public void updateAllProviders(List<ProviderGroup> providerGroups) {
   List<ProviderGroup> oldProviderGroups = new ArrayList<ProviderGroup>(addressHolder.getProviderGroups());
   int count = 0;
   if (providerGroups != null) {
       for (ProviderGroup providerGroup : providerGroups) {
           checkProviderInfo(providerGroup);
           count += providerGroup.size();
       }
   }
   if (count == 0) {
       Collection<ProviderInfo> currentProviderList = currentProviderList();
       addressHolder.updateAllProviders(providerGroups);
       if (CommonUtils.isNotEmpty(currentProviderList)) {
           if (LOGGER.isWarnEnabled(consumerConfig.getAppName())) {
               LOGGER.warnWithApp(consumerConfig.getAppName(), "Provider list is emptied, may be all " +
                   "providers has been closed, or this consumer has been add to blacklist");
               closeTransports();
           }
       }
   } else {
       addressHolder.updateAllProviders(providerGroups);
       connectionHolder.updateAllProviders(providerGroups);
   }
   if (EventBus.isEnable(ProviderInfoUpdateAllEvent.class)) {
       ProviderInfoUpdateAllEvent event = new ProviderInfoUpdateAllEvent(consumerConfig, oldProviderGroups,
           providerGroups);
       EventBus.post(event);
   }
}
/**
* æ£€æµ‹æœåŠ¡èŠ‚ç‚¹çš„ä¸€äº›ä¿¡æ¯
*
* @param providerGroup æœåŠ¡åˆ—è¡¨åˆ†ç»„
*/
protected void checkProviderInfo(ProviderGroup providerGroup) {
   List<ProviderInfo> providerInfos = providerGroup == null ? null : providerGroup.getProviderInfos();
   if (CommonUtils.isEmpty(providerInfos)) {
       return;
   }
   Iterator<ProviderInfo> iterator = providerInfos.iterator();
   while (iterator.hasNext()) {
       ProviderInfo providerInfo = iterator.next();
       if (!StringUtils.equals(providerInfo.getProtocolType(), consumerConfig.getProtocol())) {
           if (LOGGER.isWarnEnabled(consumerConfig.getAppName())) {
               LOGGER.warnWithApp(consumerConfig.getAppName(),
                   "Unmatched protocol between consumer [{}] and provider [{}].",
                   consumerConfig.getProtocol(), providerInfo.getProtocolType());
           }
       }
       if (StringUtils.isEmpty(providerInfo.getSerializationType())) {
           providerInfo.setSerializationType(consumerConfig.getSerialization());
       }
   }
}
/**
* ç»™äº‹ä»¶æ€»çº¿ä¸­ä¸¢ä¸€ä¸ªäº‹ä»¶
*
* @param event äº‹ä»¶
*/
public static void post(final Event event) {
   if (!isEnable()) {
       return;
   }
   CopyOnWriteArraySet<Subscriber> subscribers = SUBSCRIBER_MAP.get(event.getClass());
   if (CommonUtils.isNotEmpty(subscribers)) {
       for (final Subscriber subscriber : subscribers) {
           if (subscriber.isSync()) {
               handleEvent(subscriber, event);
           } else { // å¼‚æ­¥
               final RpcInternalContext context = RpcInternalContext.peekContext();
               AsyncRuntime.getAsyncThreadPool().execute(
                   new Runnable() {
                       @Override
                       public void run() {
                           try {
                               RpcInternalContext.setContext(context);
                               handleEvent(subscriber, event);
                           } catch (Exception e) {
                               RpcInternalContext.removeContext();
                           }
                       }
                   });
           }
       }
   }
}
private static void handleEvent(final Subscriber subscriber, final Event event) {
   try {
       subscriber.onEvent(event);
   } catch (Throwable e) {
       if (LOGGER.isWarnEnabled()) {
           LOGGER.warn("Handle " + event.getClass() + " error", e);
       }
   }
}
```

(7)æœåŠ¡ç«¯è®¢é˜…è€…å¯åŠ¨å™¨åˆ›å»ºå®¢æˆ·ç«¯ä»£ç†è°ƒç”¨å™¨ClientProxyInvokeræ‰§è¡Œé“¾ï¼Œæ„å»ºä»£ç†è°ƒç”¨å™¨é€šè¿‡é»˜è®¤è°ƒç”¨ç«¯ä»£ç†æ‰§è¡Œå™¨æ„é€ æ‰§è¡Œé“¾ç¼“å­˜æ¥å£åå’Œåºåˆ—åŒ–ç±»å‹ï¼Œæ³¨å…¥åˆ°åŠ¨æ€ä»£ç†è°ƒç”¨å¤„ç†å™¨æä¾›æ„å»ºä»£ç†ç±»è°ƒç”¨å™¨æ‰§è¡Œå‚æ•°ï¼š

```Java
/**
* Build ClientProxyInvoker for consumer bootstrap.
*
* @param bootstrap ConsumerBootstrap
* @return ClientProxyInvoker
*/
protected ClientProxyInvoker buildClientProxyInvoker(ConsumerBootstrap bootstrap) {
   return new DefaultClientProxyInvoker(bootstrap);
}
/**
* æ„é€ æ‰§è¡Œé“¾
*
* @param bootstrap è°ƒç”¨ç«¯é…ç½®
*/
public DefaultClientProxyInvoker(ConsumerBootstrap bootstrap) {
   super(bootstrap);
   cacheCommonData();
}
```

(8)ä»£ç†å·¥å‚æŒ‰ç…§æœåŠ¡ç«¯è®¢é˜…è€…é…ç½®ä»£ç†ç±»å‹æ„å»ºå®¢æˆ·ç«¯ä»£ç†è°ƒç”¨å™¨ä»£ç†ç±»å®ä¾‹ï¼Œç¼“å­˜æœåŠ¡ç«¯æ¶ˆè´¹è€…é…ç½®ConsumerConfigï¼ŒåŠ¨æ€ä»£ç†ç±»å‹åŒ…æ‹¬åŸºäºJDKåŠ¨æ€ä»£ç†å®ç°JDKProxy(é»˜è®¤)å’ŒåŸºäºJavassiståŠ¨æ€ä»£ç†å®ç°JavassistProxyï¼Œå…¶ä¸­JDKProxyä»£ç†å®ç°é€šè¿‡JDKä»£ç†å¤„ç†å™¨JDKInvocationHandleræ‹¦æˆªè¯·æ±‚å˜ä¸ºInvocationæ‰§è¡Œinvoke()æ–¹æ³•è¿œç¨‹è°ƒç”¨ï¼Œå®¢æˆ·ç«¯ä»£ç†è°ƒç”¨å™¨ClientProxyInvokerå®æ–½Proxyæ‹¦æˆªè°ƒç”¨ä½¿ç”¨å®¢æˆ·ç«¯é›†ç¾¤Clusteræœ€åº•å±‚è°ƒç”¨è¿‡æ»¤å™¨ï¼Œä»¥æ¶ˆè´¹ç«¯è°ƒç”¨å™¨ConsumerInvokerè¿›è¡ŒClientå‘é€æ•°æ®ç»™Serverè°ƒç”¨è¿‡ç¨‹ï¼Œå³Cluster.sendMsg()->ClientTransport.****Send()->RpcClient.invokeWith*****()->Channel.writeAndFlush()ï¼š

```Java
/**
 * æ„å»ºä»£ç†ç±»å®ä¾‹
 *
 * @param proxyType    ä»£ç†ç±»å‹
 * @param clazz        åŸå§‹ç±»
 * @param proxyInvoker ä»£ç æ‰§è¡Œçš„Invoker
 * @param <T>          ç±»å‹
 * @return ä»£ç†ç±»å®ä¾‹
 * @throws Exception
 */
public static <T> T buildProxy(String proxyType, Class<T> clazz, Invoker proxyInvoker) throws Exception {
    try {
        ExtensionClass<Proxy> ext = ExtensionLoaderFactory.getExtensionLoader(Proxy.class)
            .getExtensionClass(proxyType);
        if (ext == null) {
            throw ExceptionUtils.buildRuntime("consumer.proxy", proxyType,
                "Unsupported proxy of client!");
        }
        Proxy proxy = ext.getExtInstance();
        return proxy.getProxy(clazz, proxyInvoker);
    } catch (SofaRpcRuntimeException e) {
        throw e;
    } catch (Throwable e) {
        throw new SofaRpcRuntimeException(e.getMessage(), e);
    }
}
public Object invoke(Object proxy, Method method, Object[] paramValues)
    throws Throwable {
    String methodName = method.getName();
    Class[] paramTypes = method.getParameterTypes();
    if ("toString".equals(methodName) && paramTypes.length == 0) {
        return proxyInvoker.toString();
    } else if ("hashCode".equals(methodName) && paramTypes.length == 0) {
        return proxyInvoker.hashCode();
    } else if ("equals".equals(methodName) && paramTypes.length == 1) {
        Object another = paramValues[0];
        return proxy == another ||
            (proxy.getClass().isInstance(another) && proxyInvoker.equals(JDKProxy.parseInvoker(another)));
    }
    SofaRequest sofaRequest = MessageBuilder.buildSofaRequest(method.getDeclaringClass(),
        method, paramTypes, paramValues);
    SofaResponse response = proxyInvoker.invoke(sofaRequest);
    if (response.isError()) {
        throw new SofaRpcException(RpcErrorType.SERVER_UNDECLARED_ERROR, response.getErrorMsg());
    }
    Object ret = response.getAppResponse();
    if (ret instanceof Throwable) {
        throw (Throwable) ret;
    } else {
        if (ret == null) {
            return ClassUtils.getDefaultPrimitiveValue(method.getReturnType());
        }
        return ret;
    }
}
/**
 * proxyæ‹¦æˆªçš„è°ƒç”¨
 *
 * @param request è¯·æ±‚æ¶ˆæ¯
 * @return è°ƒç”¨ç»“æœ
 */
public SofaResponse invoke(SofaRequest request) throws SofaRpcException {
    SofaResponse response = null;
    Throwable throwable = null;
    try {
        RpcInternalContext.pushContext();
        RpcInternalContext context = RpcInternalContext.getContext();
        context.setProviderSide(false);
        // åŒ…è£…è¯·æ±‚
        decorateRequest(request);
        try {
            // äº§ç”Ÿå¼€å§‹è°ƒç”¨äº‹ä»¶
            if (EventBus.isEnable(ClientStartInvokeEvent.class)) {
                EventBus.post(new ClientStartInvokeEvent(request));
            }
            // å¾—åˆ°ç»“æœ
            response = cluster.invoke(request);
        } catch (SofaRpcException e) {
            throwable = e;
            throw e;
        } finally {
            // äº§ç”Ÿè°ƒç”¨ç»“æŸäº‹ä»¶
            if (!request.isAsync()) {
                if (EventBus.isEnable(ClientEndInvokeEvent.class)) {
                    EventBus.post(new ClientEndInvokeEvent(request, response, throwable));
                }
            }
        }
        // åŒ…è£…å“åº”
        decorateResponse(response);
        return response;
    } finally {
        RpcInternalContext.removeContext();
        RpcInternalContext.popContext();
    }
}
```

**è§£ææ€»ç»“**
 SOFARPCæœåŠ¡å¼•ç”¨æµç¨‹æ¦‚æ‹¬ä¸ºSOFARPCæœåŠ¡éœ€è¦åˆ›å»ºæœåŠ¡å¼•ç”¨é…ç½®ConsumerConfigï¼Œè‡ªå®šä¹‰è®¾ç½®æ¥å£åç§°ã€è°ƒç”¨åè®®ã€ç›´è¿è°ƒç”¨åœ°å€ä»¥åŠè¿æ¥è¶…æ—¶æ—¶é—´ç­‰å®¢æˆ·ç«¯é…ç½®ï¼›æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨ç±»ConsumerBootstrapå¼•ç”¨æœåŠ¡ï¼šæ„é€ å®¢æˆ·ç«¯é›†ç¾¤Clusterå°è£…é›†ç¾¤æ¨¡å¼ã€é•¿è¿æ¥ç®¡ç†ã€æœåŠ¡è·¯ç”±ã€è´Ÿè½½å‡è¡¡ï¼Œåˆå§‹åŒ–å®¢æˆ·ç«¯é›†ç¾¤Cluster(æ„å»ºRouteré“¾routerChainï¼ŒåŠ è½½è´Ÿè½½å‡è¡¡ç­–ç•¥loadBalancerï¼Œè·å–åœ°å€ä¿æŒå™¨addressHolderï¼Œæ„é€ Filteré“¾filterChainæœ€åº•å±‚æ˜¯è°ƒç”¨è¿‡æ»¤å™¨ï¼Œè¿æ¥ç®¡ç†å™¨å¯åŠ¨é‡è¿çº¿ç¨‹ï¼Œè®¢é˜…æœåŠ¡å‘å¸ƒè€…ï¼Œåˆå§‹åŒ–æœåŠ¡ç«¯è¿æ¥(å»ºç«‹é•¿è¿æ¥)ï¼Œåˆ›å»ºå®¢æˆ·ç«¯ä»£ç†è°ƒç”¨å™¨ClientProxyInvokeræ‰§è¡Œé“¾ï¼Œåˆ›å»ºå®¢æˆ·ç«¯è°ƒç”¨å™¨ä»£ç†å®ç°å¼•ç”¨æœåŠ¡é“¾è·¯ï¼ŒåŸºäºJDKåŠ¨æ€ä»£ç†åœºæ™¯RPCæœåŠ¡è¿œç¨‹æ ¹æ®JDKä»£ç†å¤„ç†å™¨JDKInvocationHandleræ‹¦æˆªè¯·æ±‚è½¬æ¢æˆInvocationæ‰§è¡Œinvoke()æ–¹æ³•ä»¥å®¢æˆ·ç«¯ä»£ç†è°ƒç”¨å™¨ClientProxyInvokerå®æ–½Proxyæ‹¦æˆªè°ƒç”¨ï¼Œä½¿ç”¨å®¢æˆ·ç«¯é›†ç¾¤Clusterè°ƒç”¨æ¶ˆè´¹ç«¯è°ƒç”¨å™¨ConsumerInvokerè¿›è¡Œå®¢æˆ·ç«¯å‘é€æ•°æ®ç»™æœåŠ¡ç«¯å®Œæˆè¿œç¨‹è°ƒç”¨è¿‡ç¨‹ã€‚