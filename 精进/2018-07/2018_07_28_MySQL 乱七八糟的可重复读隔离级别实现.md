title: MySQL ä¹±ä¸ƒå…«ç³Ÿçš„å¯é‡å¤è¯»éš”ç¦»çº§åˆ«å®ç°
date: 2018-07-28
tags:
categories: ç²¾è¿›
permalink: Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels
author: shimohq
from_url: https://www.jianshu.com/p/69fd2ca17cfd
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484915&idx=2&sn=a4c247a6bde0b3897be871a9706f3f1c&chksm=fa497a42cd3ef3541743cd9c835bf8a7a2100d0a0ab38ad63a4f943077f375e5bff75a937af9&token=1286521154&lang=zh_CN#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/69fd2ca17cfd ã€Œshimohqã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [ä»€ä¹ˆæ˜¯äº‹åŠ¡](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
- [äº‹åŠ¡çš„å®ç°æ–¹å¼](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
- [ä¸åŒæœºåˆ¶ä¸‹çš„ä¸åŒéš”ç¦»çº§åˆ«](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
- [å¹»è¯»ï¼ˆP3ï¼A3ï¼‰å’Œå†™åæ–œï¼ˆA5Bï¼‰](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
- [mysqlä¸­çš„å¯é‡å¤åº¦](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
  - [å¹»è¯»](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
  - [å†™åæ–œ](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
  - [mysqlä¸­å¯é‡å¤è¯»çš„å®ç°](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
- [postgresqlä¸­çš„å¯é‡å¤è¯»](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
  - [æ— å¹»è¯»](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
  - [å†™åæ–œ](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)
- [å‚è€ƒæ–‡æ¡£](http://www.iocoder.cn/Fight/MySQL-messy-implementation-of-repeatable-read-isolation-levels/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

mysqlçš„éš”ç¦»çº§åˆ«å¹¶éæ˜¯æŒ‰ç…§æ ‡å‡†å®ç°çš„ï¼Œä½œä¸ºä»pgåˆ‡è¿‡æ¥çš„ç¨‹åºå‘˜è¿˜çœŸæ˜¯ä¸å¤ªé€‚åº”ï¼Œè¿™ç¯‡æ–‡ç« è®¨è®ºmysqléš”ç¦»çº§åˆ«å®ç°çš„ï¼Œå¸Œæœ›å¯¹å¤§å®¶èƒ½æœ‰å¸®åŠ©ã€‚

# ä»€ä¹ˆæ˜¯äº‹åŠ¡

äº‹åŠ¡æ˜¯æ•°æ®åº“ä¸€ç»„è¯»å†™æ“ä½œçš„é›†åˆï¼Œäº‹åŠ¡å…·æœ‰ACIDå››ä¸ªç‰¹æ€§ï¼ŒåŸå­æ€§ï¼Œä¸€è‡´æ€§ï¼Œéš”ç¦»æ€§å’ŒæŒä¹…æ€§ã€‚
 äº‹åŠ¡æœ‰å››ä¸ªéš”ç¦»çº§åˆ«ï¼Œåˆ†åˆ«æ˜¯è¯»æœªæäº¤ï¼Œè¯»å·²æäº¤ï¼Œå¯é‡å¤è¯»å’Œä¸²è¡ŒåŒ–ã€‚
 ä»¥ä¸Šè¿™äº›å†…å®¹ç›¸ä¿¡ç†Ÿæ‚‰ä¼ ç»Ÿæ•°æ®åº“çš„äººï¼Œå¯¹è¿™äº›éƒ½å¾ˆç†Ÿæ‚‰ï¼Œæ¥ä¸‹æ¥è®²çš„å†…å®¹å¯èƒ½æœ‰äº›äººå°±ä¸å¤ªäº†è§£äº†ã€‚

# äº‹åŠ¡çš„å®ç°æ–¹å¼

æ•°æ®åº“äº‹åŠ¡çš„å®ç°æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼š

1. åŸºäºé”çš„ï¼›
2. åŸºäºæ—¶é—´æˆ³çš„ï¼Œç°åœ¨ä¸»æµçš„å®ç°å°±æ˜¯åŸºäºæ—¶é—´æˆ³çš„æ–¹å¼çš„ä¸€ç§ï¼Œå°±æ˜¯å¤§å®¶ç†Ÿæ‚‰çš„MVCCæœºåˆ¶ï¼›

å› ä¸ºæœºåˆ¶ä¸åŒï¼Œæ‰€ä»¥äº‹åŠ¡çš„è¡¨ç°ä¹Ÿä¸å°½ç›¸åŒã€‚

# ä¸åŒæœºåˆ¶ä¸‹çš„ä¸åŒéš”ç¦»çº§åˆ«

SQLæ ‡å‡†å®šä¹‰äº†å››ç§éš”ç¦»çº§åˆ«ï¼Œåˆ†åˆ«æ˜¯è¯»æœªæäº¤ï¼Œè¯»å·²æäº¤ï¼Œå¯é‡å¤è¯»ï¼Œå¯ä¸²è¡ŒåŒ–ã€‚å¾ˆæ˜æ˜¾ï¼Œè¶Šä½éš”ç¦»çº§åˆ«çš„äº‹åŠ¡å¹¶å‘è¡Œæ›´å¥½ï¼Œä½†æ˜¯ä¸€è‡´æ€§æ›´ä½ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œä½éš”ç¦»çº§åˆ«çš„äº‹åŠ¡æ˜¯ä¸ç¬¦åˆAå’ŒIçš„ï¼Œå¸¸ç”¨çš„éš”ç¦»çº§åˆ«å¤šä¸ºè¯»å·²æäº¤å’Œå¯é‡å¤åº¦ã€‚
 ä½†æ˜¯éš”ç¦»çº§åˆ«çš„å®šä¹‰æ˜¯åŸºäºé”å¹¶å‘æ§åˆ¶å®ç°çš„ï¼ŒåŸºäºMVCCæœºåˆ¶å®ç°çš„æ•°æ®åº“äº‹åŠ¡è¡¨ç°è¡Œä¸ºä¼šç¨æœ‰ä¸åŒã€‚
 jim grayæ›¾ç»æœ‰ä¸€ç¯‡è®ºæ–‡è®¨è®ºä¸åŒæœºåˆ¶å®ç°çš„æ•°æ®åº“éš”ç¦»çº§åˆ«çš„ä¸åŒè¡¨ç°ï¼Œå¹¶å°†éš”ç¦»çº§åˆ«æ‰©å±•åˆ°7ä¸ªã€‚è§ä¸‹å›¾ï¼š

![ä¸ƒç§éš”ç¦»çº§åˆ«](http://upload-images.jianshu.io/upload_images/4173742-701ad9487ff9d28a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)



åŸºäºæ­¤å°†å¸¸è§çš„ä¼ ç»Ÿæ•°æ®åº“éš”ç¦»çº§åˆ«ç»Ÿè®¡å¦‚ä¸‹ï¼š

1.  **SYBASE**æ”¯æŒçš„éš”ç¦»çº§åˆ«ï¼šdegree 0ï¼ˆread uncommittedï¼‰ã€degree 1ï¼ˆread committedï¼‰ã€degree 2ï¼ˆrepeatable readï¼‰ã€degree 3ï¼ˆserializable isolationï¼‰ï¼›
2.  **ORACLE**æ”¯æŒçš„éš”ç¦»çº§åˆ«ï¼šread committedï¼ˆconsistent readï¼‰ã€serializable(snapshot isolation)ï¼›
3.  **DB2**æ”¯æŒçš„éš”ç¦»çº§åˆ«ï¼šread uncommittedã€cursor stabilityã€read stabilityã€repeatable readï¼›
4.  **Postgresql**æ”¯æŒçš„éš”ç¦»çº§åˆ«ï¼šread committedï¼ˆconsistent readï¼‰ã€repeatable read(snapshot isolation)ã€serializable isolation(Serialaizable Snapshot Isolation)ï¼›
5.  **SQL Serveræ”¯æŒ**çš„éš”ç¦»çº§åˆ«ï¼šread uncommittedã€read committed snapshot ã€read committed ã€repeatable readã€snapshot isolationã€serializable isolationï¼›
6.  **MySQL**æ”¯æŒçš„éš”ç¦»çº§åˆ«ï¼šread uncommittedã€read committedï¼ˆconsistent readï¼‰ã€**repeatable read(snapshot isolation)**ã€serializable isolationï¼›

# å¹»è¯»ï¼ˆP3ï¼A3ï¼‰å’Œå†™åæ–œï¼ˆA5Bï¼‰

ä¸Šå›¾çš„å„ä¸ªå­—æ¯éƒ½æ˜¯æ•°æ®åº“çš„å„ç§ä¸ä¸€è‡´ç°è±¡ã€‚å¦‚æœæŠŠå†™æ“ä½œè®°ä½œwï¼Œè¯»æ“ä½œè®°ä½œrï¼Œé‚£ä¹ˆè¿™äº›æœ‰å®³ä¾èµ–å¯ä»¥è¡¨ç¤ºä¸ºä¸‹å›¾

| identifier | query                                                      | phenomena                   |
| ---------- | ---------------------------------------------------------- | --------------------------- |
| P0         | w1[x]...w2[x]...((c1 or a1) and (c2 or a2) in any order)   | Dirty Write                 |
| P1         | w1[x]...r2[x]...((c1 or a1) and (c2 or a2) in any order)   | Dirty Read                  |
| P2         | r1[x]...w2[x]...((c1 or a1) and (c2 or a2) any order)      | Fuzzy / Non-Repeatable Read |
| **P3**     | r1[P]...w2[y in P]...((c1 or a1) and (c2 or a2) any order) | Phantom                     |
| P4         | r1[x]...w2[x]...w1[x]...c1                                 | Lost Update                 |
| P4C        | rc1[x]...w2[x]...w1[x]...c1                                | Lost Update                 |
| **A3**     | r1[P]...w2[y in P]...c2....r1[P]...c1                      | Phantom                     |
| A5A        | r1[x]...w2[x]...w2[y]...c2...r1[y]...(c1 or a1)            | Read Skew                   |
| **A5B**    | r1[x]...r2[y]...w1[y]...w2[x]...(c1 and c2 occur)          | Write Skew                  |

# mysqlä¸­çš„å¯é‡å¤åº¦

## å¹»è¯»

mysqlæ˜¯æ”¯æŒMVCCæœºåˆ¶å®ç°çš„æ•°æ®åº“ï¼Œå› æ­¤å¾ˆå¤šäººï¼ˆåŒ…æ‹¬æˆ‘ï¼‰ä¼šæƒ³å½“ç„¶è®¤ä¸ºä»–çš„SIåº”è¯¥å°±æ˜¯æ ‡å‡†çš„å®ç°ï¼Œä¸ä¼šå‡ºç°å¹»è¯»(A3/P3)çš„ç°è±¡ã€‚æ¥ä¸‹æ¥ï¼Œè¯·çœ‹å¦‚ä¸‹ä¾‹å­ï¼š

![mysqlå¹»è¯»1-1](http://upload-images.jianshu.io/upload_images/4173742-20abfe7a9b1d23a8.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œäº‹åŠ¡2çš„insertå‘ç”Ÿåœ¨ä¸¤æ¬¡selectä¹‹é—´ï¼Œè¿™ä¸¤æ¬¡selectä¹Ÿå¦‚SIä¸€æ ·æ­£ç¡®çš„æ˜¾ç¤ºäº†è¯¥çœ‹åˆ°çš„ç»“æœï¼Œä½†æ˜¯updateå‘ç”Ÿä¹‹åï¼Œä¸€åˆ‡å°±å˜äº†ï¼ŒMySQLçš„RRéš”ç¦»çº§åˆ«ä¹Ÿä¼šå¹»è¯»ï¼ï¼ï¼

## å†™åæ–œ

ä¹Ÿè®¸æœ‰äººä¼šè¯´ï¼ŒmysqlåŒæ—¶ä¹Ÿæ˜¯ä½¿ç”¨é”çš„ï¼Œå› æ­¤å‘ç”Ÿå¹»è¯»ä¸å¥‡æ€ªï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹æ¥ä¸‹æ¥è¿™ä¸ªå†™åæ–œçš„ç»å…¸ä¾‹å­ï¼š

![mysql write skew](http://upload-images.jianshu.io/upload_images/4173742-0218b829939a622e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)



æ˜¾ç„¶ï¼Œmysqlä¹Ÿæ˜¯ä¼šå‘ç”Ÿå†™åæ–œçš„ã€‚

## mysqlä¸­å¯é‡å¤è¯»çš„å®ç°

çœ‹æºç å¯ä»¥å‘ç°ï¼Œmysqlä¸­çš„è¯»æ“ä½œæ˜¯ä½¿ç”¨MVCCæœºåˆ¶å®ç°ï¼Œå¯ä»¥æ­£ç¡®çš„æŸ¥æ‰¾åˆ°éœ€è¦çš„è¡Œï¼Œä½†æ˜¯å†™æ“ä½œå®ç°çš„æ—¶å€™æœ‰ä¸¤ç‚¹å’Œæˆ‘æƒ³çš„ä¸å¤ªä¸€æ ·ï¼š

1. å†™æ“ä½œæ°¸è¿œè¯»å–å·²æäº¤çš„æ•°æ®ï¼Œå¹¶æ²¡æœ‰èµ°MVCCçš„é€»è¾‘ï¼›
2. å†™æ“ä½œçš„å¹¶å‘æ˜¯é€šè¿‡é”æ§åˆ¶çš„ï¼Œä¸æ£€æŸ¥æ›´æ–°è¡Œæ˜¯å¦æ˜¯å¯¹æœ¬äº‹åŠ¡å¯è§çš„ã€‚

MVCCæœºåˆ¶è¡Œçš„å¯è§æ¡ä»¶å¾ˆç®€å•ï¼Œå¯ä»¥æ€»ç»“ä¸ºä¸¤å¥è¯ï¼š

1. **å¯¹ä¸åŒäº‹åŠ¡ï¼Œæ’å…¥äº‹åŠ¡å·²æäº¤ï¼Œåˆ é™¤äº‹åŠ¡æœªæäº¤(updateå¯ä»¥çœ‹åšå…ˆåˆ é™¤åæ’å…¥)ï¼›**
2. **å¯¹æœ¬äº‹åŠ¡ï¼Œæ’å…¥çš„statementå‘ç”Ÿåœ¨è‡ªå·±ä¹‹å‰ï¼Œåˆ é™¤çš„statementæœªå‘ç”Ÿæˆ–åœ¨è‡ªå·±ä¹‹åï¼›**

å¥—ç”¨å¹»è¯»é‚£ä¸ªä¾‹å­ï¼Œæœ¬æ¥äº‹åŠ¡1æ˜¯ä¸è¯¥çœ‹åˆ°æ–°æ’å…¥çš„è¡Œçš„ï¼ˆå› ä¸ºä¸ç¬¦åˆå¯è§æ¡ä»¶1ï¼‰ï¼Œä½†æ˜¯updateåªè¯»å–æœ€æ–°çš„è¡Œï¼Œå› æ­¤å¯¹æ–°æ’å…¥çš„è¡Œåšäº†ä¸€æ¬¡æ›´æ–°ï¼Œå¯¼è‡´è¯¥è¡Œç¬¦åˆå¯è§æ¡ä»¶2ï¼Œå†æ¬¡selectå°±å¯ä»¥æŸ¥åˆ°è¿™ä¸ªè¡Œã€‚

æ ¹æ®è¿™ä¸ªå®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æ¨ç†å‡ºï¼Œ**mysqlçš„å¯é‡å¤è¯»åŒæ ·ä¼šå‘ç”Ÿlost updateå’Œread skewï¼Œåªè¦æµ‹è¯•çš„äº‹åŠ¡ä¸­å­˜åœ¨å†™æ“ä½œã€‚å…·ä½“ä¾‹å­å¯è§æ­¤å¤„**

mysqlçš„å¯é‡å¤è¯»æ˜¯æ¯”SIæ›´ä½çš„éš”ç¦»çº§åˆ«ï¼Œåœ¨å‘ç”Ÿå¹»è¯»æ—¶ï¼ŒSIéš”ç¦»çº§åˆ«äº‹ç‰©çš„æ­£ç¡®è¡Œä¸ºåº”è¯¥æ˜¯åæäº¤çš„äº‹åŠ¡å›æ»šï¼Œè€Œmysqlä¸¤ä¸ªäº‹åŠ¡éƒ½å¯ä»¥æäº¤ï¼Œæ˜¾ç„¶ï¼Œä»–çš„ä¸€è‡´æ€§æ›´ä½ï¼Œä½†æ˜¯å¹¶å‘æ€§æ›´å¥½ï¼ˆå›æ»šç‡ä½ï¼‰ï¼Œè¿™æ˜¯ä¸€æ¬¡åœ¨ç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯ï¼Œæ€§èƒ½å’Œä¸€è‡´æ€§ä¹‹é—´çš„æƒè¡¡ï¼Œè‡³äºä¼˜åŠ£ï¼Œå°±è§ä»è§æ™ºäº†ï¼Œè‡³å°‘ç°åœ¨çœ‹æ¥ä¸åã€‚

# postgresqlä¸­çš„å¯é‡å¤è¯»

## æ— å¹»è¯»

pgå®ç°çš„éš”ç¦»çº§åˆ«æ˜¯æ¯”è¾ƒæ ‡å‡†çš„ï¼Œå¯é‡å¤åº¦çº§åˆ«ï¼ˆå®é™…æ˜¯SIï¼‰æ²¡æœ‰å¹»è¯»ï¼Œè¿™é‡Œä¸¾ä¸¤ä¸ªä¾‹å­

### ç¬¬ä¸€ä¸ªä¾‹å­

![pgæ— å¹»è¯»1](http://upload-images.jianshu.io/upload_images/4173742-3c2b48f0ccb7f53a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)



 

ç±»æ¯”mysqlçš„ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œå’Œmysqlä¸åŒï¼Œå¯ä»¥çœ‹åˆ°pgçš„äº‹åŠ¡updateçš„æ—¶å€™åªæ›´æ–°äº†ä¸¤è¡Œï¼Œä¸åŒ…æ‹¬æ–°æ’å…¥çš„è¡Œ

### ç¬¬äºŒä¸ªä¾‹å­

![pgæ— å¹»è¯»2](http://upload-images.jianshu.io/upload_images/4173742-1a6aec52387c49d7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)



 

å½“è¯¥è¡ŒåŒæ—¶è¢«ä¸¤ä¸ªå¯é‡å¤çº§åˆ«çš„äº‹åŠ¡æ›´æ–°æ—¶ï¼Œåæäº¤çš„äº‹åŠ¡ä¼šå›æ»šï¼Œå› ä¸ºæ›´æ–°åªèƒ½åœ¨æœ€æ–°çš„è¡Œä¸Šæ‰§è¡Œï¼Œå¦åˆ™å°±æ˜¯ä¸¢å¤±æ›´æ–°äº†ã€‚

## å†™åæ–œ

![pg write skew](http://upload-images.jianshu.io/upload_images/4173742-1ef17648410f99ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)



 

å¯ä»¥çœ‹åˆ°ï¼Œpgçš„å¯é‡å¤çº§åˆ«äº‹åŠ¡ï¼Œè¿˜æ˜¯å­˜åœ¨å†™åæ–œçš„ï¼Œè¿™æ˜¯ç¬¦åˆæ ‡å‡†çš„ã€‚

# å‚è€ƒæ–‡æ¡£

1. ã€ŠA Critique of ANSI SQL Isolation Levelsã€‹
2. mysqlæºç 
3. pgæºç 
4. [https://github.com/ept/hermitage/blob/master/mysql.md](https://link.jianshu.com?t=https%3A%2F%2Fgithub.com%2Fept%2Fhermitage%2Fblob%2Fmaster%2Fmysql.md)

 

 

 

 

 