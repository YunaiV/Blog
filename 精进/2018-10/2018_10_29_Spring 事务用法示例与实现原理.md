title: Spring äº‹åŠ¡ç”¨æ³•ç¤ºä¾‹ä¸å®ç°åŸç†
date: 2018-10-29
tags:
categories: ç²¾è¿›
permalink: Fight/Spring-transaction-usage-examples-and-implementation-principles
author: çˆ±å®è´ä¸¶
from_url: https://my.oschina.net/zhangxufeng/blog/1935556
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247485504&idx=2&sn=63fc41bfd4e929290d229962fa020e55&chksm=fa4977f1cd3efee79536750bb525d1c642b2a9aa852691493c1fc0e00b741d859b2e76770d4c&token=696637778&lang=zh_CN#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://my.oschina.net/zhangxufeng/blog/1935556 ã€Œçˆ±å®è´ä¸¶ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. ä½¿ç”¨ç¤ºä¾‹](http://www.iocoder.cn/Fight/Spring-transaction-usage-examples-and-implementation-principles/)
- [2. æ ‡ç­¾è§£æ](http://www.iocoder.cn/Fight/Spring-transaction-usage-examples-and-implementation-principles/)
- [3. å®ç°åŸç†](http://www.iocoder.cn/Fight/Spring-transaction-usage-examples-and-implementation-principles/)
- [4. å°ç»“](http://www.iocoder.cn/Fight/Spring-transaction-usage-examples-and-implementation-principles/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

â€‹       å…³äºäº‹åŠ¡ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯æ•°æ®å®Œæ•´æ€§è€Œå­˜åœ¨çš„ä¸€ç§å·¥å…·ï¼Œå…¶ä¸»è¦æœ‰å››å¤§ç‰¹æ€§ï¼šåŸå­æ€§ï¼Œä¸€è‡´æ€§ï¼Œéš”ç¦»æ€§å’ŒæŒä¹…æ€§ã€‚å¯¹äºSpringäº‹åŠ¡ï¼Œå…¶æœ€ç»ˆè¿˜æ˜¯åœ¨æ•°æ®åº“å±‚é¢å®ç°çš„ï¼Œè€ŒSpringåªæ˜¯ä»¥ä¸€ç§æ¯”è¾ƒä¼˜é›…çš„æ–¹å¼å¯¹å…¶è¿›è¡Œå°è£…æ”¯æŒã€‚æœ¬æ–‡é¦–å…ˆä¼šé€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥è®²è§£Springäº‹åŠ¡æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œç„¶åä¼šè®²è§£Springæ˜¯å¦‚ä½•è§£æxmlä¸­çš„æ ‡ç­¾ï¼Œå¹¶å¯¹äº‹åŠ¡è¿›è¡Œæ”¯æŒçš„ã€‚

# 1. ä½¿ç”¨ç¤ºä¾‹

â€‹       å…³äºäº‹åŠ¡æœ€ç®€å•çš„ç¤ºä¾‹ï¼Œå°±æ˜¯å…¶ä¸€è‡´æ€§ï¼Œæ¯”å¦‚åœ¨æ•´ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœä»»ä½•ä¸€ä¸ªä½ç½®æŠ¥é”™äº†ï¼Œé‚£ä¹ˆéƒ½ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šï¼Œå›æ»šä¹‹åæ•°æ®çš„çŠ¶æ€å°†å’Œäº‹åŠ¡æ‰§è¡Œä¹‹å‰å®Œå…¨ä¸€è‡´ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥ç”¨æˆ·æ•°æ®ä¸ºä¾‹ï¼Œåœ¨æ’å…¥ç”¨æˆ·æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœç¨‹åºæŠ¥é”™äº†ï¼Œé‚£ä¹ˆæ’å…¥çš„åŠ¨ä½œå°±ä¼šå›æ»šã€‚å¦‚ä¸‹æ˜¯ç”¨æˆ·çš„å®ä½“ï¼š

```java
public class User {
  private long id;
  private String name;
  private int age;

  // getter, setter...
}
```

â€‹       å¦‚ä¸‹æ˜¯æ¨¡æ‹Ÿæ’å…¥ç”¨æˆ·æ•°æ®çš„ä¸šåŠ¡ä»£ç ï¼š

```java
public interface UserService {
  void insert(User user);
}

@Service
@Transactional
public class UserServiceImpl implements UserService {
  @Autowired
  private JdbcTemplate jdbcTemplate;

  @Override
  public void insert(User user) {
    jdbcTemplate.update("insert into user (name, age) value (?, ?)",
        user.getName(), user.getAge());
  }
}
```

â€‹       åœ¨è¿›è¡Œäº‹åŠ¡æ”¯æŒæ—¶ï¼ŒSpringåªéœ€è¦ä½¿ç”¨è€…åœ¨éœ€è¦äº‹åŠ¡æ”¯æŒçš„beanä¸Šä½¿ç”¨`@Transactional`æ³¨è§£å³å¯ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«å’Œä¼ æ’­ç‰¹æ€§çš„å±æ€§ï¼Œåˆ™ä½¿ç”¨è¯¥æ³¨è§£ä¸­çš„å±æ€§è¿›è¡ŒæŒ‡å®šã€‚è¿™é‡Œé»˜è®¤çš„éš”ç¦»çº§åˆ«ä¸å„ä¸ªæ•°æ®åº“ä¸€è‡´ï¼Œæ¯”å¦‚MySQLæ˜¯Repeatable Readï¼Œè€Œä¼ æ’­ç‰¹æ€§é»˜è®¤åˆ™ä¸º`Propagation.REQUIRED`ï¼Œå³åªéœ€è¦å½“å‰æ“ä½œå…·æœ‰äº‹åŠ¡å³å¯ã€‚å¦‚ä¸‹æ˜¯xmlæ–‡ä»¶çš„é…ç½®ï¼š

```XML
<bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="url" value="jdbc:mysql://localhost/test?useUnicode=true"/>
    <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
    <property name="username" value="****"/>
    <property name="password" value="******"/>
</bean>

<bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
    <property name="dataSource" ref="dataSource"/>
</bean>

<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="dataSource"/>
</bean>

<context:component-scan base-package="com.transaction"/>
<tx:annotation-driven/>
```

â€‹       ä¸Šè¿°æ•°æ®åº“é…ç½®ç”¨æˆ·æŒ‰ç…§å„è‡ªçš„è®¾ç½®è¿›è¡Œé…ç½®å³å¯ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¯¹äºæ•°æ®åº“çš„é…ç½®ï¼Œä¸»è¦åŒ…æ‹¬å››ä¸ªæ–¹é¢ï¼š

- DataSourceé…ç½®ï¼šè®¾ç½®å½“å‰åº”ç”¨æ‰€éœ€è¦è¿æ¥çš„æ•°æ®åº“ï¼ŒåŒ…æ‹¬é“¾æ¥ï¼Œç”¨æˆ·åï¼Œå¯†ç ç­‰ï¼›
- JdbcTemplateå£°æ˜ï¼šå°è£…äº†å®¢æˆ·ç«¯è°ƒç”¨æ•°æ®åº“çš„æ–¹å¼ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å…¶ä»–çš„æ–¹å¼ï¼Œæ¯”å¦‚JpaRepositoryï¼ŒMybatisç­‰ç­‰ï¼›
- TransactionManageré…ç½®ï¼šæŒ‡å®šäº†äº‹åŠ¡çš„ç®¡ç†æ–¹å¼ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯DataSourceTransactionManagerï¼Œå¯¹äºä¸åŒçš„é“¾æ¥æ–¹å¼ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä¸åŒçš„é…ç½®ï¼Œæ¯”å¦‚å¯¹äºJpaRepositoryä½¿ç”¨JpaTransactionManagerï¼Œå¯¹äºHibernateï¼Œä½¿ç”¨HibernateTransactionManagerï¼›
- tx:annotation-drivenï¼šä¸»è¦ç”¨äºäº‹åŠ¡é©±åŠ¨ï¼Œå…¶ä¼šé€šè¿‡AOPçš„æ–¹å¼å£°æ˜ä¸€ä¸ªä¸ºäº‹åŠ¡æ”¯æŒçš„Advisorï¼Œé€šè¿‡è¯¥Advisorå’Œäº‹åŠ¡çš„ç›¸å…³é…ç½®è¿›è¡Œäº‹åŠ¡ç›¸å…³æ“ä½œã€‚

â€‹       æŒ‰ç…§ä¸Šè¿°é…ç½®ï¼Œæˆ‘ä»¬çš„äº‹åŠ¡åŠŸèƒ½å³é…ç½®å®Œæˆï¼Œå¦‚ä¸‹æ˜¯æˆ‘ä»¬çš„é©±åŠ¨ç±»ç¨‹åºï¼š

```java
public class TransactionApp {
  @Test
  public void testTransaction() {
    ApplicationContext ac = new ClassPathXmlApplicationContext("applicationContext.xml");
    UserService userService = ac.getBean(UserService.class);
    User user = getUser();
    userService.insert(user);
  }

  private User getUser() {
    User user = new User();
    user.setName("Mary");
    user.setAge(27);
    return user;
  }
}
```

â€‹       è¿è¡Œä¸Šè¿°ç¨‹åºä¹‹åï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®åº“ä¸­æˆåŠŸæ–°å¢äº†ä¸€æ¡æ•°æ®ã€‚è¿™é‡Œå¦‚æœæˆ‘ä»¬å°†ä¸šåŠ¡ä»£ç çš„æ’å…¥è¯­å¥ä¹‹åæ‰‹åŠ¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆï¼Œç†è®ºä¸Šæ’å…¥è¯­å¥æ˜¯ä¼šå›æ»šçš„ã€‚å¦‚ä¸‹æ˜¯ä¿®æ”¹åçš„serviceä»£ç ï¼š

```java
@Service
@Transactional
public class UserServiceImpl implements UserService {
  @Autowired
  private JdbcTemplate jdbcTemplate;

  @Override
  public void insert(User user) {
    jdbcTemplate.update("insert into user (name, age) value (?, ?)",
        user.getName(), user.getAge());
    throw new RuntimeException();
  }
}
```

â€‹       è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æŠ›å‡ºäº†ä¸€ä¸ªRuntimeExceptionï¼Œå†æ¬¡è¿è¡Œä¸Šè¿°ç¨‹åºä¹‹åæˆ‘ä»¬å‘ç°æ•°æ®åº“ä¸­æ˜¯æ²¡æœ‰æ–°å¢çš„æ•°æ®çš„ï¼Œè¿™è¯´æ˜æˆ‘ä»¬çš„äº‹åŠ¡åœ¨ç¨‹åºå‡ºé”™åæ˜¯èƒ½å¤Ÿä¿è¯æ•°æ®ä¸€è‡´æ€§çš„ã€‚

# 2. æ ‡ç­¾è§£æ

â€‹       å…³äºäº‹åŠ¡çš„å®ç°åŸç†ï¼Œæˆ‘ä»¬é¦–å…ˆè®²è§£Springæ˜¯å¦‚ä½•è§£ææ ‡ç­¾ï¼Œå¹¶ä¸”å°è£…ç›¸å…³beançš„ï¼Œåé¢æˆ‘ä»¬ä¼šæ·±å…¥è®²è§£Springæ˜¯å¦‚ä½•å°è£…æ•°æ®åº“äº‹åŠ¡çš„ã€‚

â€‹       æ ¹æ®ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå…¶ä¸»è¦æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼šDataSourceï¼ŒTransactionManagerå’Œtx:annotation-drivenæ ‡ç­¾ã€‚è¿™é‡Œå‰é¢ä¸¤ä¸ªéƒ¨åˆ†ä¸»è¦æ˜¯å£°æ˜äº†ä¸¤ä¸ªbeanï¼Œåˆ†åˆ«ç”¨äºæ•°æ®åº“è¿æ¥çš„ç®¡ç†å’Œäº‹åŠ¡çš„ç®¡ç†ï¼Œè€Œtx:annotation-drivenæ‰æ˜¯Springäº‹åŠ¡çš„é©±åŠ¨ã€‚æ ¹æ®æœ¬äººå‰é¢å¯¹Springè‡ªå®šä¹‰æ ‡ç­¾çš„è®²è§£ï¼ˆ[Springè‡ªå®šä¹‰æ ‡ç­¾è§£æä¸å®ç°](https://my.oschina.net/zhangxufeng/blog/1815705)ï¼‰ï¼Œå¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œ`tx:annotation-driven`æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ ‡ç­¾ï¼Œæˆ‘ä»¬æ ¹æ®å…¶å‘½åç©ºé—´ï¼ˆwww.springframework.org/schema/txï¼‰åœ¨å…¨å±€èŒƒå›´å†…æœç´¢ï¼Œå¯ä»¥æ‰¾åˆ°å…¶å¤„ç†å™¨æŒ‡å®šæ–‡ä»¶spring.handlersï¼Œè¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```
http\://www.springframework.org/schema/tx=org.springframework.transaction.config.TxNamespaceHandler
```

â€‹       è¿™é‡Œä¹Ÿå°±æ˜¯è¯´`tx:annotation-driven`æ ‡ç­¾çš„è§£æåœ¨`TxNamespaceHandler`ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­æ‰“å¼€è¯¥æ–‡ä»¶å¯ä»¥çœ‹åˆ°èµ·`init()`æ–¹æ³•å¦‚ä¸‹ï¼š

```java
@Override
public void init() {
    registerBeanDefinitionParser("advice", new TxAdviceBeanDefinitionParser());
    registerBeanDefinitionParser("annotation-driven",
        new AnnotationDrivenBeanDefinitionParser());
    registerBeanDefinitionParser("jta-transaction-manager",
        new JtaTransactionManagerBeanDefinitionParser());
}
```

â€‹       å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„`annotation-driven`æ˜¯åœ¨`AnnotationDrivenBeanDefinitionParser`ä¸­è¿›è¡Œå¤„ç†çš„ï¼Œå…¶`parse()`æ–¹æ³•å°±æ˜¯è§£ææ ‡ç­¾ï¼Œå¹¶ä¸”æ³¨å†Œç›¸å…³beançš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ˜¯è¯¥æ–¹æ³•çš„å®ç°ï¼š

```java
public BeanDefinition parse(Element element, ParserContext parserContext) {
    // æ³¨å†Œäº‹åŠ¡ç›¸å…³çš„ç›‘å¬å™¨ï¼Œå¦‚æœæŸä¸ªæ–¹æ³•æ ‡æ³¨äº†TransactionalEventListeneræ³¨è§£ï¼Œ
    // é‚£ä¹ˆè¯¥æ–¹æ³•å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡äº‹ä»¶è§¦å‘æ–¹æ³•ï¼Œå³å‘ç”ŸæŸç§äº‹åŠ¡äº‹ä»¶åï¼Œå°†ä¼šæ ¹æ®è¯¥æ³¨è§£çš„è®¾ç½®ï¼Œå›è°ƒæŒ‡å®š
    // ç±»å‹çš„æ–¹æ³•ã€‚å¸¸è§çš„äº‹åŠ¡äº‹ä»¶æœ‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰å’Œäº‹åŠ¡å®Œæˆ(åŒ…æ‹¬æŠ¥é”™åçš„å®Œæˆ)åçš„äº‹ä»¶ã€‚
    registerTransactionalEventListenerFactory(parserContext);
    String mode = element.getAttribute("mode");
    // è·å–å½“å‰äº‹åŠ¡é©±åŠ¨ç¨‹åºçš„æ¨¡å¼ï¼Œå¦‚æœä½¿ç”¨äº†aspectjæ¨¡å¼ï¼Œåˆ™ä¼šæ³¨å†Œä¸€ä¸ªAnnotationTransactionAspect
    // ç±»å‹çš„beanï¼Œç”¨æˆ·å¯ä»¥ä»¥aspectjçš„æ–¹å¼ä½¿ç”¨è¯¥beanå¯¹äº‹åŠ¡è¿›è¡Œæ›´å¤šçš„é…ç½®
    if ("aspectj".equals(mode)) {
        registerTransactionAspect(element, parserContext);
    } else {
        // ä¸€èˆ¬ä½¿ç”¨çš„æ˜¯å½“å‰è¿™ç§æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å°†ä¼šåœ¨Springä¸­æ³¨å†Œä¸‰ä¸ªbeanï¼Œåˆ†åˆ«æ˜¯
        // AnnotationTransactionAttributeSourceï¼ŒTransactionInterceptor
        // å’ŒBeanFactoryTransactionAttributeSourceAdvisorï¼Œå¹¶é€šè¿‡Aopçš„æ–¹å¼å®ç°äº‹åŠ¡
        AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext);
    }
    return null;
}
```

â€‹       å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºäº‹åŠ¡çš„é©±åŠ¨ï¼Œè¿™é‡Œä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼šâ‘ æ³¨å†Œäº‹åŠ¡ç›¸å…³çš„äº‹ä»¶è§¦å‘å™¨ï¼Œè¿™äº›è§¦å‘å™¨ç”±ç”¨æˆ·è‡ªè¡Œæä¾›ï¼Œåœ¨äº‹åŠ¡è¿›è¡Œæäº¤æˆ–äº‹åŠ¡å®Œæˆæ—¶ä¼šè§¦å‘ç›¸åº”çš„æ–¹æ³•ï¼›â‘¡åˆ¤æ–­å½“å‰äº‹åŠ¡é©±åŠ¨çš„æ¨¡å¼ï¼Œæœ‰é»˜è®¤æ¨¡å¼å’Œaspectjæ¨¡å¼ï¼Œå¯¹äºaspectjæ¨¡å¼ï¼ŒSpringä¼šæ³¨å†Œä¸€ä¸ªAnnotationTransactionAspectç±»å‹çš„beanï¼Œç”¨äºç”¨æˆ·ä½¿ç”¨æ›´äº²è¿‘äºaspectjçš„æ–¹å¼è¿›è¡Œäº‹åŠ¡å¤„ç†ï¼›å¯¹äºé»˜è®¤æ¨¡å¼ï¼Œè¿™é‡Œä¸»è¦æ˜¯å£°æ˜äº†ä¸‰ä¸ªbeanï¼Œæœ€ç»ˆé€šè¿‡Aopçš„æ–¹å¼è¿›è¡Œäº‹åŠ¡åˆ‡å…¥ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹Springæ˜¯å¦‚ä½•æ³¨å†Œè¿™ä¸‰ä¸ªbeançš„ï¼Œå¦‚ä¸‹æ˜¯`AopAutoProxyConfigurer.configureAutoProxyCreator`çš„æºç ï¼š

```java
public static void configureAutoProxyCreator(Element element,
        ParserContext parserContext) {
    // è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯åœ¨å½“å‰BeanFactoryä¸­æ³¨å†ŒInfrastructureAdvisorAutoProxyCreatorè¿™ä¸ª
    // beanï¼Œè¿™ä¸ªbeanç»§æ‰¿äº†AbstractAdvisorAutoProxyCreatorï¼Œä¹Ÿå°±æ˜¯å…¶å®ç°åŸç†ä¸æˆ‘ä»¬å‰é¢
    // è®²è§£çš„Spring Aopçš„å®ç°åŸç†å‡ ä¹ä¸€è‡´
    AopNamespaceUtils.registerAutoProxyCreatorIfNecessary(parserContext, element);

    // è¿™é‡Œçš„txAdvisorBeanNameå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦æ³¨å†Œçš„beanï¼Œå…¶ç±»å‹å°±æ˜¯ä¸‹é¢æ³¨å†Œçš„
    // BeanFactoryTransactionAttributeSourceAdvisorï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ª
    // Advisorç±»å‹çš„å¯¹è±¡ï¼Œå› è€ŒSpring Aopä¼šå°†å…¶ä½œä¸ºä¸€ä¸ªåˆ‡é¢ç»‡å…¥åˆ°æŒ‡å®šçš„beanä¸­
    String txAdvisorBeanName = TransactionManagementConfigUtils
        .TRANSACTION_ADVISOR_BEAN_NAME;
    // å¦‚æœå½“å‰BeanFactoryä¸­å·²ç»å­˜åœ¨äº†ç›®æ ‡beanï¼Œåˆ™ä¸è¿›è¡Œæ³¨å†Œ
    if (!parserContext.getRegistry().containsBeanDefinition(txAdvisorBeanName)) {
        Object eleSource = parserContext.extractSource(element);
        // æ³¨å†ŒAnnotationTransactionAttributeSourceï¼Œè¿™ä¸ªbeançš„ä¸»è¦ä½œç”¨æ˜¯å°è£…
        // @Transactionalæ³¨è§£ä¸­å£°æ˜çš„å„ä¸ªå±æ€§
        RootBeanDefinition sourceDef = new RootBeanDefinition(
       "org.springframework.transaction.annotation.AnnotationTransactionAttributeSource");
        sourceDef.setSource(eleSource);
        sourceDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
        String sourceName = parserContext.getReaderContext()
            .registerWithGeneratedName(sourceDef);

        // æ³¨å†ŒTransactionInterceptorç±»å‹çš„beanï¼Œå¹¶ä¸”å°†ä¸Šé¢çš„å°è£…å±æ€§çš„beanè®¾ç½®ä¸ºå…¶ä¸€ä¸ªå±æ€§ã€‚
        // è¿™ä¸ªbeanæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªAdvice(å¯æŸ¥çœ‹å…¶ç»§æ‰¿ç»“æ„)ï¼ŒSpring Aopä½¿ç”¨Advisorå°è£…å®ç°åˆ‡é¢
        // é€»è¾‘ç»‡å…¥æ‰€éœ€çš„æ‰€æœ‰å±æ€§ï¼Œä½†çœŸæ­£çš„åˆ‡é¢é€»è¾‘å´æ˜¯ä¿å­˜åœ¨å…¶Adviceå±æ€§ä¸­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„
        // TransactionInterceptoræ‰æ˜¯çœŸæ­£å°è£…äº†äº‹åŠ¡åˆ‡é¢é€»è¾‘çš„bean
        RootBeanDefinition interceptorDef =
            new RootBeanDefinition(TransactionInterceptor.class);
        interceptorDef.setSource(eleSource);
        interceptorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
        registerTransactionManager(element, interceptorDef);
        interceptorDef.getPropertyValues().add("transactionAttributeSource",
            new RuntimeBeanReference(sourceName));
        String interceptorName = parserContext.getReaderContext()
            .registerWithGeneratedName(interceptorDef);

        // æ³¨å†ŒBeanFactoryTransactionAttributeSourceAdvisorç±»å‹çš„beanï¼Œè¿™ä¸ªbeanå®ç°äº†
        // Advisoræ¥å£ï¼Œå®é™…ä¸Šå°±æ˜¯å°è£…äº†å½“å‰éœ€è¦ç»‡å…¥çš„åˆ‡é¢çš„æ‰€æœ‰æ‰€éœ€çš„å±æ€§
        RootBeanDefinition advisorDef =
            new RootBeanDefinition(BeanFactoryTransactionAttributeSourceAdvisor.class);
        advisorDef.setSource(eleSource);
        advisorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
        advisorDef.getPropertyValues().add("transactionAttributeSource",
            new RuntimeBeanReference(sourceName));
        advisorDef.getPropertyValues().add("adviceBeanName", interceptorName);
        if (element.hasAttribute("order")) {
            advisorDef.getPropertyValues().add("order", element.getAttribute("order"));
        }
        parserContext.getRegistry().registerBeanDefinition(txAdvisorBeanName, advisorDef);

        // å°†éœ€è¦æ³¨å†Œçš„beanå°è£…åˆ°CompositeComponentDefinitionä¸­ï¼Œå¹¶ä¸”è¿›è¡Œæ³¨å†Œ
        CompositeComponentDefinition compositeDef =
            new CompositeComponentDefinition(element.getTagName(), eleSource);
        compositeDef.addNestedComponent(
            new BeanComponentDefinition(sourceDef, sourceName));
        compositeDef.addNestedComponent(
            new BeanComponentDefinition(interceptorDef, interceptorName));
        compositeDef.addNestedComponent(
            new BeanComponentDefinition(advisorDef, txAdvisorBeanName));
        parserContext.registerComponent(compositeDef);
    }
}
```

â€‹       å¦‚æ­¤ï¼ŒSpringäº‹åŠ¡ç›¸å…³çš„æ ‡ç­¾å³è§£æå®Œæˆï¼Œè¿™é‡Œä¸»è¦æ˜¯å£°æ˜äº†ä¸€ä¸ª`BeanFactoryTransactionAttributeSourceAdvisor`ç±»å‹çš„beanåˆ°BeanFactoryä¸­ï¼Œå…¶å®é™…ä¸ºAdvisorç±»å‹ï¼Œè¿™ä¹Ÿæ˜¯Springäº‹åŠ¡èƒ½å¤Ÿé€šè¿‡Aopå®ç°äº‹åŠ¡çš„æ ¹æœ¬åŸå› ã€‚

# 3. å®ç°åŸç†

â€‹       å…³äºSpringäº‹åŠ¡çš„å®ç°åŸç†ï¼Œè¿™é‡Œéœ€è¦æŠ“ä½çš„å°±æ˜¯ï¼Œå…¶æ˜¯ä½¿ç”¨Aopå®ç°çš„ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒAopåœ¨è¿›è¡Œè§£æçš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šç”Ÿæˆä¸€ä¸ªAdivsorå¯¹è±¡ï¼Œè¿™ä¸ªAdvisorå¯¹è±¡ä¸­å°è£…äº†åˆ‡é¢ç»‡å…¥æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬æœ€é‡è¦çš„ä¸¤ä¸ªéƒ¨åˆ†å°±æ˜¯`Pointcut`å’Œ`Adivce`å±æ€§ã€‚è¿™é‡Œ`Pointcut`ç”¨äºåˆ¤æ–­ç›®æ ‡beanæ˜¯å¦éœ€è¦ç»‡å…¥å½“å‰åˆ‡é¢é€»è¾‘ï¼›`Advice`åˆ™å°è£…äº†éœ€è¦ç»‡å…¥çš„åˆ‡é¢é€»è¾‘ã€‚å¦‚ä¸‹æ˜¯è¿™ä¸‰ä¸ªéƒ¨åˆ†çš„ç®€è¦å…³ç³»å›¾ï¼š

![Advisor](http://static.iocoder.cn/06315659a22856140ec50910710daa93)

â€‹       åŒæ ·çš„ï¼Œå¯¹äºSpringäº‹åŠ¡ï¼Œå…¶æ—¢ç„¶æ˜¯ä½¿ç”¨Spring Aopå®ç°çš„ï¼Œé‚£ä¹ˆä¹ŸåŒæ ·ä¼šæœ‰è¿™ä¸‰ä¸ªæˆå‘˜ã€‚æˆ‘ä»¬è¿™é‡Œæˆ‘ä»¬åªçœ‹åˆ°äº†æ³¨å†Œçš„Advisorå’ŒAdviceï¼ˆå³BeanFactoryTransactionAttributeSourceAdvisorå’ŒTransactionInterceptorï¼‰ï¼Œé‚£ä¹ˆPointcutåœ¨å“ªé‡Œå‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬æŸ¥çœ‹`BeanFactoryTransactionAttributeSourceAdvisor`çš„æºç å¯ä»¥å‘ç°ï¼Œå…¶å†…éƒ¨å£°æ˜äº†ä¸€ä¸ª`TransactionAttributeSourcePointcut`ç±»å‹çš„å±æ€§ï¼Œå¹¶ä¸”ç›´æ¥åœ¨å†…éƒ¨è¿›è¡Œäº†å®ç°ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰¾çš„Pointcutã€‚è¿™é‡Œè¿™ä¸‰ä¸ªå¯¹è±¡å¯¹åº”çš„å…³ç³»å¦‚ä¸‹ï¼š

![Transaction](http://static.iocoder.cn/edca298c00901d00cdd69ba3a92df366)

â€‹       è¿™æ ·ï¼Œç”¨äºå®ç°Springäº‹åŠ¡çš„Advisorï¼ŒPointcutä»¥åŠAdviceéƒ½å·²ç»æ‰¾åˆ°äº†ã€‚å…³äºè¿™ä¸‰ä¸ªç±»çš„å…·ä½“ä½œç”¨ï¼Œæˆ‘ä»¬è¿™é‡Œè¿›è¡Œæ•´ä½“çš„ä¸Šçš„è®²è§£ï¼Œåé¢æˆ‘ä»¬å°†ä¼šæ·±å…¥å…¶å†…éƒ¨è®²è§£å…¶æ˜¯å¦‚ä½•è¿›è¡Œbeançš„è¿‡æ»¤ä»¥åŠäº‹åŠ¡é€»è¾‘çš„ç»‡å…¥çš„ã€‚

- BeanFactoryTransactionAttributeSourceAdvisorï¼šå°è£…äº†å®ç°äº‹åŠ¡æ‰€éœ€çš„æ‰€æœ‰å±æ€§ï¼ŒåŒ…æ‹¬Pointcutï¼ŒAdviceï¼ŒTransactionManagerä»¥åŠä¸€äº›å…¶ä»–çš„åœ¨Transactionalæ³¨è§£ä¸­å£°æ˜çš„å±æ€§ï¼›
- TransactionAttributeSourcePointcutï¼šç”¨äºåˆ¤æ–­å“ªäº›beanéœ€è¦ç»‡å…¥å½“å‰çš„äº‹åŠ¡é€»è¾‘ã€‚è¿™é‡Œå¯æƒ³è€ŒçŸ¥ï¼Œå…¶åˆ¤æ–­çš„åŸºæœ¬é€»è¾‘å°±æ˜¯åˆ¤æ–­å…¶æ–¹æ³•æˆ–ç±»å£°æ˜ä¸Šæœ‰æ²¡æœ‰ä½¿ç”¨@Transactionalæ³¨è§£ï¼Œå¦‚æœä½¿ç”¨äº†å°±æ˜¯éœ€è¦ç»‡å…¥äº‹åŠ¡é€»è¾‘çš„bean;
- TransactionInterceptorï¼šè¿™ä¸ªbeanæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªAdviceï¼Œå…¶å°è£…äº†å½“å‰éœ€è¦ç»‡å…¥ç›®æ ‡beançš„åˆ‡é¢é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯Springäº‹åŠ¡æ˜¯å¦‚æœå€ŸåŠ©äºæ•°æ®åº“äº‹åŠ¡æ¥å®ç°å¯¹ç›®æ ‡æ–¹æ³•çš„ç¯ç»•çš„ã€‚

# 4. å°ç»“

â€‹       æœ¬æ–‡é¦–å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­è®²è§£äº†Springäº‹åŠ¡æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œç„¶åè®²è§£äº†Springäº‹åŠ¡è¿›è¡Œæ ‡ç­¾è§£æçš„æ—¶å€™åšäº†å“ªäº›å·¥ä½œï¼Œæœ€åè®²è§£äº†Springäº‹åŠ¡æ˜¯å¦‚ä½•ä¸Spring Aopè¿›è¡Œä¸€ä¸€å¯¹åº”çš„ï¼Œå¹¶ä¸”æ˜¯å¦‚ä½•é€šè¿‡Spring Aopå®ç°å°†äº‹åŠ¡é€»è¾‘ç»‡å…¥ç›®æ ‡beançš„ã€‚
