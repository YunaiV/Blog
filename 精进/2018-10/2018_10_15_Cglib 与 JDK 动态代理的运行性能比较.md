title: Cglib ä¸ JDK åŠ¨æ€ä»£ç†çš„è¿è¡Œæ€§èƒ½æ¯”è¾ƒ
date: 2018-10-15
tags:
categories: ç²¾è¿›
permalink: Fight/The-running-performance-of-Cglib-compared-to-the-JDK-dynamic-proxy
author: haiq
from_url: https://www.cnblogs.com/haiq/p/4304615.html
wechat_url:

----

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnblogs.com/haiq/p/4304615.html ã€Œhaiqã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

éƒ½è¯´ Cglib åˆ›å»ºçš„åŠ¨æ€ä»£ç†çš„è¿è¡Œæ€§èƒ½æ¯” JDK åŠ¨æ€ä»£ç†èƒ½é«˜å‡ºå¤§æ¦‚ 10 å€ï¼Œä»Šæ—¥æŠ±ç€æ€€ç–‘ç²¾ç¥éªŒè¯äº†ä¸€ä¸‹ï¼Œ**å‘ç°æƒ…å†µæœ‰æ‰€ä¸åŒï¼Œ**é‚è´´å‡ºå®éªŒç»“æœï¼Œä»¥ä¾›å‚è€ƒå’Œè®¨è®ºã€‚

ä»£ç å¾ˆç®€å•ï¼Œé¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ª Test æ¥å£ï¼Œå’Œä¸€ä¸ªå®ç° TestImpl ã€‚Test æ¥å£ä»…å®šä¹‰ä¸€ä¸ªæ–¹æ³• testï¼Œå¯¹ä¼ å…¥çš„ int å‚æ•°åŠ  1 åè¿”å›ã€‚ä»£ç å¦‚ä¸‹ï¼š



```java
package my.test;

public interface Test {

    public int test(int i);

}
```



```java
package my.test;

public class TestImpl implements Test{
    public int test(int i) {
        return i+1;
    }
}
```



ç„¶åï¼Œå®šä¹‰äº†ä¸‰ç§ä»£ç†çš„å®ç°ï¼šè£…é¥°è€…æ¨¡å¼å®ç°çš„ä»£ç†(decorator)ï¼ŒJDK åŠ¨æ€ä»£ç†(dynamic proxy) å’Œ Cglib åŠ¨æ€ä»£ç† (cglib proxy)ã€‚ä»£ç å¦‚ä¸‹ï¼š



```java
package my.test;

public class DecoratorTest implements Test{
    private Test target;

    public DecoratorTest(Test target) {
        this.target = target;
    }

    public int test(int i) {
        return target.test(i);
    }
}
```



```java
package my.test;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;

public class DynamicProxyTest implements InvocationHandler {
    private Test target;

    private DynamicProxyTest(Test target) {
        this.target = target;
    }

    public static Test newProxyInstance(Test target) {
        return (Test) Proxy
                .newProxyInstance(DynamicProxyTest.class.getClassLoader(),
                        new Class<?>[] { Test.class },
                        new DynamicProxyTest(target));

    }

    public Object invoke(Object proxy, Method method, Object[] args)
            throws Throwable {
        return method.invoke(target, args);
    }
}
```



```java
package my.test;

import java.lang.reflect.Method;

import net.sf.cglib.proxy.Enhancer;
import net.sf.cglib.proxy.MethodInterceptor;
import net.sf.cglib.proxy.MethodProxy;

public class CglibProxyTest implements MethodInterceptor {

    private CglibProxyTest() {
    }

    public static <T extends Test> Test newProxyInstance(Class<T> targetInstanceClazz){
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(targetInstanceClazz);
        enhancer.setCallback(new CglibProxyTest());
        return (Test) enhancer.create();
    }

    public Object intercept(Object obj, Method method, Object[] args,
            MethodProxy proxy) throws Throwable {
        return proxy.invokeSuper(obj, args);
    }

}
```



ä»¥ TestImpl çš„è°ƒç”¨è€—æ—¶ä½œä¸ºåŸºå‡†ï¼Œå¯¹æ¯”é€šè¿‡å…¶å®ƒä¸‰ç§ä»£ç†è¿›è¡Œè°ƒç”¨çš„è€—æ—¶ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š



```java
package my.test;

import java.util.LinkedHashMap;
import java.util.Map;

public class ProxyPerfTester {

    public static void main(String[] args) {
        //åˆ›å»ºæµ‹è¯•å¯¹è±¡ï¼›
        Test nativeTest = new TestImpl();
        Test decorator = new DecoratorTest(nativeTest);
        Test dynamicProxy = DynamicProxyTest.newProxyInstance(nativeTest);
        Test cglibProxy = CglibProxyTest.newProxyInstance(TestImpl.class);

        //é¢„çƒ­ä¸€ä¸‹ï¼›
        int preRunCount = 10000;
        runWithoutMonitor(nativeTest, preRunCount);
        runWithoutMonitor(decorator, preRunCount);
        runWithoutMonitor(cglibProxy, preRunCount);
        runWithoutMonitor(dynamicProxy, preRunCount);

        //æ‰§è¡Œæµ‹è¯•ï¼›
        Map<String, Test> tests = new LinkedHashMap<String, Test>();
        tests.put("Native   ", nativeTest);
        tests.put("Decorator", decorator);
        tests.put("Dynamic  ", dynamicProxy);
        tests.put("Cglib    ", cglibProxy);
        int repeatCount = 3;
        int runCount = 1000000;
        runTest(repeatCount, runCount, tests);
        runCount = 50000000;
        runTest(repeatCount, runCount, tests);
    }

    private static void runTest(int repeatCount, int runCount, Map<String, Test> tests){
        System.out.println(String.format("\n==================== run test : [repeatCount=%s] [runCount=%s] [java.version=%s] ====================", repeatCount, runCount, System.getProperty("java.version")));
        for (int i = 0; i < repeatCount; i++) {
            System.out.println(String.format("\n--------- test : [%s] ---------", (i+1)));
            for (String key : tests.keySet()) {
                runWithMonitor(tests.get(key), runCount, key);
            }
        }
    }

    private static void runWithoutMonitor(Test test, int runCount) {
        for (int i = 0; i < runCount; i++) {
            test.test(i);
        }
    }

    private static void runWithMonitor(Test test, int runCount, String tag) {
        long start = System.currentTimeMillis();
        for (int i = 0; i < runCount; i++) {
            test.test(i);
        }
        long end = System.currentTimeMillis();
        System.out.println("["+tag + "] Elapsed Time:" + (end-start) + "ms");
    }
}
```



æµ‹è¯•ç”¨ä¾‹åˆ†åˆ«åœ¨ jdk6ã€ jdk7ã€jdk8 ä¸‹è¿›è¡Œäº†æµ‹è¯•ï¼Œæ¯æ¬¡æµ‹è¯•åˆ†åˆ«ä»¥ 1,000,000 å’Œ 50,000,000 å¾ªç¯æ¬¡æ•°è°ƒç”¨ test æ–¹æ³•ï¼Œå¹¶é‡å¤3æ¬¡ã€‚



- jdk6 ä¸‹çš„æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

```java
==================== run test : [repeatCount=3] [runCount=1000000] [java.version=1.6.0_45] ====================

--------- test : [1] ---------
[Native   ] Elapsed Time:2ms
[Decorator] Elapsed Time:12ms
[Dynamic  ] Elapsed Time:31ms
[Cglib    ] Elapsed Time:31ms

--------- test : [2] ---------
[Native   ] Elapsed Time:7ms
[Decorator] Elapsed Time:7ms
[Dynamic  ] Elapsed Time:31ms
[Cglib    ] Elapsed Time:27ms

--------- test : [3] ---------
[Native   ] Elapsed Time:7ms
[Decorator] Elapsed Time:6ms
[Dynamic  ] Elapsed Time:23ms
[Cglib    ] Elapsed Time:29ms

==================== run test : [repeatCount=3] [runCount=50000000] [java.version=1.6.0_45] ====================

--------- test : [1] ---------
[Native   ] Elapsed Time:212ms
[Decorator] Elapsed Time:226ms
[Dynamic  ] Elapsed Time:1054ms
[Cglib    ] Elapsed Time:830ms

--------- test : [2] ---------
[Native   ] Elapsed Time:184ms
[Decorator] Elapsed Time:222ms
[Dynamic  ] Elapsed Time:1020ms
[Cglib    ] Elapsed Time:826ms

--------- test : [3] ---------
[Native   ] Elapsed Time:184ms
[Decorator] Elapsed Time:208ms
[Dynamic  ] Elapsed Time:979ms
[Cglib    ] Elapsed Time:832ms
```

ã€€ã€€æµ‹è¯•ç»“æœè¡¨æ˜ï¼šjdk6 ä¸‹ï¼Œåœ¨è¿è¡Œæ¬¡æ•°è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ŒjdkåŠ¨æ€ä»£ç†ä¸ cglib å·®è·ä¸æ˜æ˜¾ï¼Œç”šè‡³æ›´å¿«ä¸€äº›ï¼›è€Œå½“è°ƒç”¨æ¬¡æ•°å¢åŠ ä¹‹åï¼Œ cglib è¡¨ç°ç¨å¾®æ›´å¿«ä¸€äº›ï¼Œç„¶è€Œä»…ä»…æ˜¯â€œç¨å¾®â€å¥½ä¸€äº›ï¼Œè¿œæ²¡è¾¾åˆ° 10 å€å·®è·ã€‚

- jdk7 ä¸‹çš„æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

```java
==================== run test : [repeatCount=3] [runCount=1000000] [java.version=1.7.0_60] ====================

--------- test : [1] ---------
[Native   ] Elapsed Time:2ms
[Decorator] Elapsed Time:12ms
[Dynamic  ] Elapsed Time:19ms
[Cglib    ] Elapsed Time:26ms

--------- test : [2] ---------
[Native   ] Elapsed Time:3ms
[Decorator] Elapsed Time:5ms
[Dynamic  ] Elapsed Time:17ms
[Cglib    ] Elapsed Time:20ms

--------- test : [3] ---------
[Native   ] Elapsed Time:4ms
[Decorator] Elapsed Time:4ms
[Dynamic  ] Elapsed Time:13ms
[Cglib    ] Elapsed Time:27ms

==================== run test : [repeatCount=3] [runCount=50000000] [java.version=1.7.0_60] ====================

--------- test : [1] ---------
[Native   ] Elapsed Time:208ms
[Decorator] Elapsed Time:210ms
[Dynamic  ] Elapsed Time:551ms
[Cglib    ] Elapsed Time:923ms

--------- test : [2] ---------
[Native   ] Elapsed Time:238ms
[Decorator] Elapsed Time:210ms
[Dynamic  ] Elapsed Time:483ms
[Cglib    ] Elapsed Time:872ms

--------- test : [3] ---------
[Native   ] Elapsed Time:217ms
[Decorator] Elapsed Time:208ms
[Dynamic  ] Elapsed Time:494ms
[Cglib    ] Elapsed Time:881ms
```



æµ‹è¯•ç»“æœè¡¨æ˜ï¼š**jdk7 ä¸‹ï¼Œæƒ…å†µå‘ç”Ÿäº†é€†è½¬ï¼**åœ¨è¿è¡Œæ¬¡æ•°è¾ƒå°‘ï¼ˆ1,000,000ï¼‰çš„æƒ…å†µä¸‹ï¼ŒjdkåŠ¨æ€ä»£ç†æ¯” cglib å¿«äº†å·®ä¸å¤š30%ï¼›è€Œå½“è°ƒç”¨æ¬¡æ•°å¢åŠ ä¹‹å(50,000,000)ï¼Œ åŠ¨æ€ä»£ç†æ¯” cglib å¿«äº†æ¥è¿‘1å€ã€‚

æ¥ä¸‹æ¥å†çœ‹çœ‹jdk8ä¸‹çš„è¡¨ç°å¦‚ä½•ã€‚

- jdk8 ä¸‹çš„æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š



```java
==================== run test : [repeatCount=3] [runCount=1000000] [java.version=1.8.0_05] ====================

--------- test : [1] ---------
[Native   ] Elapsed Time:5ms
[Decorator] Elapsed Time:11ms
[Dynamic  ] Elapsed Time:27ms
[Cglib    ] Elapsed Time:52ms

--------- test : [2] ---------
[Native   ] Elapsed Time:4ms
[Decorator] Elapsed Time:6ms
[Dynamic  ] Elapsed Time:11ms
[Cglib    ] Elapsed Time:24ms

--------- test : [3] ---------
[Native   ] Elapsed Time:4ms
[Decorator] Elapsed Time:5ms
[Dynamic  ] Elapsed Time:9ms
[Cglib    ] Elapsed Time:26ms

==================== run test : [repeatCount=3] [runCount=50000000] [java.version=1.8.0_05] ====================

--------- test : [1] ---------
[Native   ] Elapsed Time:194ms
[Decorator] Elapsed Time:211ms
[Dynamic  ] Elapsed Time:538ms
[Cglib    ] Elapsed Time:965ms

--------- test : [2] ---------
[Native   ] Elapsed Time:194ms
[Decorator] Elapsed Time:214ms
[Dynamic  ] Elapsed Time:503ms
[Cglib    ] Elapsed Time:969ms

--------- test : [3] ---------
[Native   ] Elapsed Time:190ms
[Decorator] Elapsed Time:209ms
[Dynamic  ] Elapsed Time:495ms
[Cglib    ] Elapsed Time:939ms
```



æµ‹è¯•ç»“æœè¡¨æ˜ï¼š**jdk8 ä¸‹ï¼Œå»¶ç»­äº† JDK7 ä¸‹çš„æƒŠå¤©å¤§é€†è½¬ï¼**ä¸è¿‡è¿˜è§‚å¯Ÿå¦å¤–æœ‰ä¸€ä¸ªç»†å¾®çš„å˜åŒ–ï¼Œä»ç»å¯¹å€¼æ¥çœ‹ cglib åœ¨ jdk8 ä¸‹çš„è¡¨ç°ä¼¼ä¹æ¯” jdk7 è¿˜è¦å·®ä¸€ç‚¹ç‚¹ï¼Œå°½ç®¡åªæ˜¯ä¸€ç‚¹ç‚¹ï¼Œä½†ç»è¿‡åå¤å¤šæ¬¡çš„æ‰§è¡Œä»ç„¶æ˜¯è¿™ä¸ªè¶‹åŠ¿ï¼ˆæ³¨ï¼šè¿™ä¸ªè¶‹åŠ¿çš„ç»“è®ºå¹¶ä¸ä¸¥è°¨ï¼Œåªæ˜¯æå¸¦ä¸€æï¼Œå¦‚éœ€å¾—å‡ºç»“è®ºè¿˜éœ€è¿›è¡Œæ›´å¤šæ ·çš„å¯¹æ¯”å®éªŒï¼‰ã€‚



ç»“è®ºï¼šä» jdk6 åˆ° jdk7ã€jdk8 ï¼ŒåŠ¨æ€ä»£ç†çš„æ€§èƒ½å¾—åˆ°äº†æ˜¾è‘—çš„æå‡ï¼Œè€Œ cglib çš„è¡¨ç°å¹¶æœªè·Ÿä¸Šï¼Œç”šè‡³å¯èƒ½ä¼šç•¥å¾®ä¸‹é™ã€‚ä¼ è¨€çš„ cglib æ¯” jdkåŠ¨æ€ä»£ç†é«˜å‡º 10 å€çš„æƒ…å†µä¹Ÿè®¸æ˜¯å‡ºç°åœ¨æ›´ä½ç‰ˆæœ¬çš„ jdk ä¸Šå§ã€‚

ä»¥ä¸Šæµ‹è¯•ç”¨ä¾‹è™½ç„¶ç®€å•ï¼Œä½†æ­ç¤ºäº† jdk ç‰ˆæœ¬å‡çº§å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›æ–°æŠ€æœ¯æ”¹å˜ï¼Œä¼šä½¿æˆ‘ä»¬ä»¥å‰çš„ç»éªŒå¤±æ•ˆã€‚æ”¾åœ¨çœŸå®ä¸šåŠ¡åœºæ™¯ä¸‹æ—¶ï¼Œè¿˜éœ€è¦æŒ‰ç…§å®é™…æƒ…å†µè¿›è¡Œæµ‹è¯•åæ‰èƒ½å¾—å‡ºç‰¹å®šäºåœºæ™¯çš„ç»“è®ºã€‚

æ€»ä¹‹ï¼Œå®è·µå‡ºçœŸçŸ¥ï¼Œè¿˜è¦ä¸æ—¶ä¿±è¿›åœ°å»æ£€è§†æ›´æ–°ä¸€äº›ä»¥å¾€ç»éªŒã€‚



æ³¨ï¼šä¸Šè¿°å®éªŒä¸­ cglib çš„ç‰ˆæœ¬æ˜¯ 3.1 ã€‚