title: Java ä¸­çš„å››ç§å¼•ç”¨ç±»å‹
date: 2018-11-21
tags:
categories: ç²¾è¿›
permalink: Fight/Four-reference-types-in-Java
author: suting
from_url: https://juejin.im/post/5a5129f5f265da3e317dfc08
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247485766&idx=1&sn=1a51c202b3d57379a232997a4f64c376&chksm=fa4976f7cd3effe15252f893459f17d85b5b3646894bd540071d34f38147e78873b9462d7c79&token=582518212&lang=zh_CN#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://juejin.im/post/5a5129f5f265da3e317dfc08 ã€Œsutingã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [ä¸€ã€èƒŒæ™¯](http://www.iocoder.cn/Fight/Four-reference-types-in-Java/)
- [äºŒã€ç®€ä»‹](http://www.iocoder.cn/Fight/Four-reference-types-in-Java/)
  - [1. å¼ºå¼•ç”¨ StrongReference](http://www.iocoder.cn/Fight/Four-reference-types-in-Java/)
  - [2. å¼±å¼•ç”¨ WeakReference](http://www.iocoder.cn/Fight/Four-reference-types-in-Java/)
  - [3. è½¯å¼•ç”¨ SoftReference](http://www.iocoder.cn/Fight/Four-reference-types-in-Java/)
  - [4. è™šå¼•ç”¨ PhantomReference](http://www.iocoder.cn/Fight/Four-reference-types-in-Java/)
- [ä¸‰ã€å°ç»“](http://www.iocoder.cn/Fight/Four-reference-types-in-Java/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# ä¸€ã€èƒŒæ™¯

  Javaçš„å†…å­˜å›æ”¶ä¸éœ€è¦ç¨‹åºå‘˜è´Ÿè´£ï¼ŒJVMä¼šåœ¨å¿…è¦æ—¶å¯åŠ¨Java GCå®Œæˆåƒåœ¾å›æ”¶ã€‚Javaä»¥ä¾¿æˆ‘ä»¬æ§åˆ¶å¯¹è±¡çš„ç”Ÿå­˜å‘¨æœŸï¼Œæä¾›ç»™äº†æˆ‘ä»¬å››ç§å¼•ç”¨æ–¹å¼ï¼Œå¼•ç”¨å¼ºåº¦ä»å¼ºåˆ°å¼±åˆ†åˆ«ä¸ºï¼šå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ã€‚

# äºŒã€ç®€ä»‹

## 1. å¼ºå¼•ç”¨ StrongReference

  StrongReferenceæ˜¯Javaçš„é»˜è®¤å¼•ç”¨å½¢å¼ï¼Œä½¿ç”¨æ—¶ä¸éœ€è¦æ˜¾ç¤ºå®šä¹‰ã€‚ä»»ä½•é€šè¿‡å¼ºå¼•ç”¨æ‰€ä½¿ç”¨çš„å¯¹è±¡ä¸ç®¡ç³»ç»Ÿèµ„æºæœ‰å¤šç´§å¼ ï¼ŒJava GCéƒ½ä¸ä¼šä¸»åŠ¨å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡ã€‚

```Java
public class StrongReferenceTest {

	public static int M = 1024*1024;

	public static void printlnMemory(String tag){
		Runtime runtime = Runtime.getRuntime();
		int M = StrongReferenceTest.M;
		System.out.println("\n"+tag+":");
		System.out.println(runtime.freeMemory()/M+"M(free)/" + runtime.totalMemory()/M+"M(total)");
	}

	public static void main(String[] args){
		StrongReferenceTest.printlnMemory("1.åŸå¯ç”¨å†…å­˜å’Œæ€»å†…å­˜");

		//å®ä¾‹åŒ–10Mçš„æ•°ç»„å¹¶ä¸strongReferenceå»ºç«‹å¼ºå¼•ç”¨
		byte[] strongReference = new byte[10*StrongReferenceTest.M];
		StrongReferenceTest.printlnMemory("2.å®ä¾‹åŒ–10Mçš„æ•°ç»„,å¹¶å»ºç«‹å¼ºå¼•ç”¨");
		System.out.println("strongReference : "+strongReference);

		System.gc();
		StrongReferenceTest.printlnMemory("3.GCå");
		System.out.println("strongReference : "+strongReference);

		//strongReference = null;å,å¼ºå¼•ç”¨æ–­å¼€äº†
		strongReference = null;
		StrongReferenceTest.printlnMemory("4.å¼ºå¼•ç”¨æ–­å¼€å");
		System.out.println("strongReference : "+strongReference);

		System.gc();
		StrongReferenceTest.printlnMemory("5.GCå");
		System.out.println("strongReference : "+strongReference);
		}
}
```

è¿è¡Œç»“æœï¼š

![img](https://user-gold-cdn.xitu.io/2018/1/7/160cd0dc536b2384?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



## 2. å¼±å¼•ç”¨ WeakReference

  å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰å¼±å¼•ç”¨ï¼Œæ— è®ºå†…å­˜å……è¶³ä¸å¦ï¼ŒJava GCåå¯¹è±¡å¦‚æœåªæœ‰å¼±å¼•ç”¨å°†ä¼šè¢«è‡ªåŠ¨å›æ”¶ã€‚

```Java
public class WeakReferenceTest {

	public static int M = 1024*1024;

	public static void printlnMemory(String tag){
		Runtime runtime = Runtime.getRuntime();
		int M = WeakReferenceTest.M;
		System.out.println("\n"+tag+":");
		System.out.println(runtime.freeMemory()/M+"M(free)/" + runtime.totalMemory()/M+"M(total)");
	}

	public static void main(String[] args){
		WeakReferenceTest.printlnMemory("1.åŸå¯ç”¨å†…å­˜å’Œæ€»å†…å­˜");

		//åˆ›å»ºå¼±å¼•ç”¨
		WeakReference<Object> weakRerference = new WeakReference<Object>(new byte[10*WeakReferenceTest.M]);
		WeakReferenceTest.printlnMemory("2.å®ä¾‹åŒ–10Mçš„æ•°ç»„,å¹¶å»ºç«‹å¼±å¼•ç”¨");
		System.out.println("weakRerference.get() : "+weakRerference.get());

		System.gc();
		StrongReferenceTest.printlnMemory("3.GCå");
		System.out.println("weakRerference.get() : "+weakRerference.get());
	}
}
```

è¿è¡Œç»“æœï¼š



![img](https://user-gold-cdn.xitu.io/2018/1/7/160cd0f1ead8184e?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



## 3. è½¯å¼•ç”¨ SoftReference

  è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„ç‰¹æ€§åŸºæœ¬ä¸€è‡´ï¼Œ ä¸»è¦çš„åŒºåˆ«åœ¨äºè½¯å¼•ç”¨åœ¨å†…å­˜ä¸è¶³æ—¶æ‰ä¼šè¢«å›æ”¶ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨ï¼ŒJava GCåœ¨å†…å­˜å……è¶³çš„æ—¶å€™ä¸ä¼šå›æ”¶å®ƒï¼Œå†…å­˜ä¸è¶³æ—¶æ‰ä¼šè¢«å›æ”¶ã€‚

```Java
public class SoftReferenceTest {

	public static int M = 1024*1024;

	public static void printlnMemory(String tag){
		Runtime runtime = Runtime.getRuntime();
		int M = StrongReferenceTest.M;
		System.out.println("\n"+tag+":");
		System.out.println(runtime.freeMemory()/M+"M(free)/" + runtime.totalMemory()/M+"M(total)");
	}

	public static void main(String[] args){
		SoftReferenceTest.printlnMemory("1.åŸå¯ç”¨å†…å­˜å’Œæ€»å†…å­˜");

		//å»ºç«‹è½¯å¼•ç”¨
		SoftReference<Object> softRerference = new SoftReference<Object>(new byte[10*SoftReferenceTest.M]);
		SoftReferenceTest.printlnMemory("2.å®ä¾‹åŒ–10Mçš„æ•°ç»„,å¹¶å»ºç«‹è½¯å¼•ç”¨");
		System.out.println("softRerference.get() : "+softRerference.get());

		System.gc();
		SoftReferenceTest.printlnMemory("3.å†…å­˜å¯ç”¨å®¹é‡å……è¶³ï¼ŒGCå");
		System.out.println("softRerference.get() : "+softRerference.get());

		//å®ä¾‹åŒ–ä¸€ä¸ª4Mçš„æ•°ç»„,ä½¿å†…å­˜ä¸å¤Ÿç”¨,å¹¶å»ºç«‹è½¯å¼•ç”¨
		//free=10M=4M+10M-4M,è¯æ˜å†…å­˜å¯ç”¨é‡ä¸è¶³æ—¶ï¼ŒGCåbyte[10*m]è¢«å›æ”¶
		SoftReference<Object> softRerference2 = new SoftReference<Object>(new byte[4*SoftReferenceTest.M]);
		SoftReferenceTest.printlnMemory("4.å®ä¾‹åŒ–ä¸€ä¸ª4Mçš„æ•°ç»„å");
		System.out.println("softRerference.get() : "+softRerference.get());
		System.out.println("softRerference2.get() : "+softRerference2.get());
	 }
}
```

è¿è¡Œç»“æœï¼š



![img](https://user-gold-cdn.xitu.io/2018/1/7/160cd1023a8f3de2?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



## 4. è™šå¼•ç”¨ PhantomReference

  ä»PhantomReferenceç±»çš„æºä»£ç å¯ä»¥çŸ¥é“ï¼Œå®ƒçš„get()æ–¹æ³•æ— è®ºä½•æ—¶è¿”å›çš„éƒ½åªä¼šæ˜¯nullã€‚æ‰€ä»¥å•ç‹¬ä½¿ç”¨è™šå¼•ç”¨æ—¶ï¼Œæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œéœ€è¦å’Œå¼•ç”¨é˜Ÿåˆ—ReferenceQueueç±»è”åˆä½¿ç”¨ã€‚å½“æ‰§è¡ŒJava GCæ—¶å¦‚æœä¸€ä¸ªå¯¹è±¡åªæœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„ReferenceQueueä¸­ã€‚

```Java
public class PhantomReferenceTest {

	public static int M = 1024*1024;

	public static void printlnMemory(String tag){
		Runtime runtime = Runtime.getRuntime();
		int M = PhantomReferenceTest.M;
		System.out.println("\n"+tag+":");
		System.out.println(runtime.freeMemory()/M+"M(free)/" + runtime.totalMemory()/M+"M(total)");
	}

	public static void main(String[] args) throws InterruptedException {

		PhantomReferenceTest.printlnMemory("1.åŸå¯ç”¨å†…å­˜å’Œæ€»å†…å­˜");
		byte[] object = new byte[10*PhantomReferenceTest.M];
		PhantomReferenceTest.printlnMemory("2.å®ä¾‹åŒ–10Mçš„æ•°ç»„å");

	    //å»ºç«‹è™šå¼•ç”¨
	    ReferenceQueue<Object> referenceQueue = new ReferenceQueue<Object>();
	    PhantomReference<Object> phantomReference = new PhantomReference<Object>(object,referenceQueue);

	    PhantomReferenceTest.printlnMemory("3.å»ºç«‹è™šå¼•ç”¨å");
	    System.out.println("phantomReference : "+phantomReference);
	    System.out.println("phantomReference.get() : "+phantomReference.get());
	    System.out.println("referenceQueue.poll() : "+referenceQueue.poll());

	    //æ–­å¼€byte[10*PhantomReferenceTest.M]çš„å¼ºå¼•ç”¨
	    object = null;
	    PhantomReferenceTest.printlnMemory("4.æ‰§è¡Œobject = null;å¼ºå¼•ç”¨æ–­å¼€å");

	    System.gc();
	    PhantomReferenceTest.printlnMemory("5.GCå");
	    System.out.println("phantomReference : "+phantomReference);
	    System.out.println("phantomReference.get() : "+phantomReference.get());
	    System.out.println("referenceQueue.poll() : "+referenceQueue.poll());

	    //æ–­å¼€è™šå¼•ç”¨
	    phantomReference = null;
		System.gc();
		PhantomReferenceTest.printlnMemory("6.æ–­å¼€è™šå¼•ç”¨åGC");
	    System.out.println("phantomReference : "+phantomReference);
	    System.out.println("referenceQueue.poll() : "+referenceQueue.poll());
	}
}
```

è¿è¡Œç»“æœï¼š



![img](https://user-gold-cdn.xitu.io/2018/1/7/160cd110cba23d84?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



# ä¸‰ã€å°ç»“

  å¼ºå¼•ç”¨æ˜¯ Java çš„é»˜è®¤å¼•ç”¨å½¢å¼ï¼Œä½¿ç”¨æ—¶ä¸éœ€è¦æ˜¾ç¤ºå®šä¹‰ï¼Œæ˜¯æˆ‘ä»¬å¹³æ—¶æœ€å¸¸ä½¿ç”¨åˆ°çš„å¼•ç”¨æ–¹å¼ã€‚ä¸ç®¡ç³»ç»Ÿèµ„æºæœ‰å¤šç´§å¼ ï¼ŒJava GCéƒ½ä¸ä¼šä¸»åŠ¨å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡ã€‚   å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ä¸€èˆ¬åœ¨å¼•ç”¨å¯¹è±¡ä¸ºéå¿…éœ€å¯¹è±¡çš„æ—¶å€™ä½¿ç”¨ã€‚å®ƒä»¬çš„åŒºåˆ«æ˜¯è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åœ¨åƒåœ¾å›æ”¶æ—¶æ€»æ˜¯ä¼šè¢«å›æ”¶ï¼Œè¢«è½¯å¼•ç”¨å…³è”çš„å¯¹è±¡åªæœ‰åœ¨å†…å­˜ä¸è¶³æ—¶æ‰ä¼šè¢«å›æ”¶ã€‚   è™šå¼•ç”¨çš„get()æ–¹æ³•è·å–çš„æ°¸è¿œæ˜¯nullï¼Œæ— æ³•è·å–å¯¹è±¡å®ä¾‹ã€‚Java GCä¼šæŠŠè™šå¼•ç”¨çš„å¯¹è±¡æ”¾åˆ°å¼•ç”¨é˜Ÿåˆ—é‡Œé¢ã€‚å¯ç”¨æ¥åœ¨å¯¹è±¡è¢«å›æ”¶æ—¶åšé¢å¤–çš„ä¸€äº›èµ„æºæ¸…ç†æˆ–äº‹ç‰©å›æ»šç­‰å¤„ç†ã€‚   ç”±äºæ— æ³•ä»è™šå¼•è·å–åˆ°å¼•ç”¨å¯¹è±¡çš„å®ä¾‹ã€‚å®ƒçš„ä½¿ç”¨æƒ…å†µæ¯”è¾ƒç‰¹åˆ«ï¼Œæ‰€ä»¥è¿™é‡Œä¸æŠŠè™šå¼•ç”¨æ”¾å…¥è¡¨æ ¼è¿›è¡Œå¯¹æ¯”ã€‚è¿™é‡Œå¯¹å¼ºå¼•ç”¨ã€å¼±å¼•ç”¨ã€è½¯å¼•ç”¨è¿›è¡Œå¯¹æ¯”ï¼š

| å¼•ç”¨ç±»å‹ | GCæ—¶JVMå†…å­˜å……è¶³ | GCæ—¶JVMå†…å­˜ä¸è¶³ |
| -------- | --------------- | --------------- |
| å¼ºå¼•ç”¨   | ä¸è¢«å›æ”¶        | ä¸è¢«å›æ”¶        |
| å¼±å¼•ç”¨   | è¢«å›æ”¶          | è¢«å›æ”¶          |
| è½¯å¼•ç”¨   | ä¸è¢«å›æ”¶        | è¢«å›æ”¶          |
