title: Redis ä»å…¥é—¨åˆ°æ”¾å¼ƒ
date: 2018-11-03
tags:
categories: ç²¾è¿›
permalink: Fight/Redis-went-from-getting-started-to-quitting
author: ietf
from_url: https://juejin.im/post/5b4dd82ee51d451925629622
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247485567&idx=1&sn=fcd80be50464f15f463a9551bb18472e&chksm=fa4977cecd3efed8f2d5d4560968d6ac7ec072d4f8d07988d86228d65796b5789608ffdb4e46&token=1977883259&lang=zh_CN#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://juejin.im/post/5b4dd82ee51d451925629622 ã€Œietfã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. Redis ä»‹ç»](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [1.1 NoSQL åŸºæœ¬æ¦‚å¿µ](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [1.2 NoSQL åˆ†ç±»](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [1.3 Redis åŸºæœ¬æ¦‚å¿µ](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [1.4 å‘å±•å†å²](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [1.5 åº”ç”¨åœºæ™¯](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
- [2. Redis å®‰è£…](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [2.1 ä¸‹è½½](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [2.2 å®‰è£…](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [2.3 redis å¯åŠ¨](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
- [3. Redis å®¢æˆ·ç«¯](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [3.1 è‡ªå¸¦å®¢æˆ·ç«¯](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [3.2 å›¾å½¢ç•Œé¢å®¢æˆ·ç«¯](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [3.3 jedis å®¢æˆ·ç«¯](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
- [4. æ•°æ®ç±»å‹](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [4.1 String ç±»å‹](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [4.2 Hash æ•£åˆ—ç±»å‹](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [4.3 List ç±»å‹](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [4.4 Set ç±»å‹](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [4.5 Sortedset ç±»å‹](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
- [5. keys å‘½ä»¤](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [5.1 å¸¸ç”¨å‘½ä»¤](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [5.2 è®¾ç½® key çš„ç”Ÿå­˜æ—¶é—´](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
- [6. Redis æŒä¹…åŒ–æ–¹æ¡ˆ](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [6.1 Rdb æ–¹å¼](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [6.2 Aof æ–¹å¼](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
- [7. Redis çš„ä¸»ä»å¤åˆ¶](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [7.1 ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [7.2 ä¸»ä»å¤åˆ¶è®¾ç½®](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
- [8. Redis é›†ç¾¤](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.1 redis-cluster æ¶æ„å›¾](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.2 redis-cluster æŠ•ç¥¨ å®¹é”™](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.3 å®‰è£… Ruby](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.4 æ­å»ºé›†ç¾¤](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.5 è¿æ¥é›†ç¾¤](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.6 æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.7 jedisè¿æ¥é›†ç¾¤](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)
  - [8.8 ä½¿ç”¨ spring](http://www.iocoder.cn/Fight/Redis-went-from-getting-started-to-quitting/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# 1. Redis ä»‹ç»

## 1.1 NoSQL åŸºæœ¬æ¦‚å¿µ

ä¸ºäº†è§£å†³é«˜å¹¶å‘ã€é«˜å¯ç”¨ã€é«˜å¯æ‰©å±•ï¼Œå¤§æ•°æ®å­˜å‚¨ç­‰ä¸€ç³»åˆ—é—®é¢˜è€Œäº§ç”Ÿçš„æ•°æ®åº“è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯NoSqlã€‚

NoSqlï¼Œå«éå…³ç³»å‹æ•°æ®åº“ï¼Œå®ƒçš„å…¨åNot only sqlã€‚å®ƒä¸èƒ½æ›¿ä»£å…³ç³»å‹æ•°æ®åº“ï¼Œåªèƒ½ä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„ä¸€ä¸ªè‰¯å¥½è¡¥å……ã€‚

## 1.2 NoSQL åˆ†ç±»

- é”®å€¼(Key-Value)å­˜å‚¨æ•°æ®åº“ ç›¸å…³äº§å“ï¼š Tokyo Cabinet/Tyrantã€Redisã€Voldemortã€Berkeley DB å…¸å‹åº”ç”¨ï¼š å†…å®¹ç¼“å­˜ï¼Œä¸»è¦ç”¨äºå¤„ç†å¤§é‡æ•°æ®çš„é«˜è®¿é—®è´Ÿè½½ã€‚ æ•°æ®æ¨¡å‹ï¼š ä¸€ç³»åˆ—é”®å€¼å¯¹ ä¼˜åŠ¿ï¼š å¿«é€ŸæŸ¥è¯¢ åŠ£åŠ¿ï¼š å­˜å‚¨çš„æ•°æ®ç¼ºå°‘ç»“æ„åŒ–
- åˆ—å­˜å‚¨æ•°æ®åº“ ç›¸å…³äº§å“ï¼šCassandra, HBase, Riak å…¸å‹åº”ç”¨ï¼šåˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿ æ•°æ®æ¨¡å‹ï¼šä»¥åˆ—ç°‡å¼å­˜å‚¨ï¼Œå°†åŒä¸€åˆ—æ•°æ®å­˜åœ¨ä¸€èµ· ä¼˜åŠ¿ï¼šæŸ¥æ‰¾é€Ÿåº¦å¿«ï¼Œå¯æ‰©å±•æ€§å¼ºï¼Œæ›´å®¹æ˜“è¿›è¡Œåˆ†å¸ƒå¼æ‰©å±• åŠ£åŠ¿ï¼šåŠŸèƒ½ç›¸å¯¹å±€é™
- æ–‡æ¡£å‹æ•°æ®åº“ ç›¸å…³äº§å“ï¼šCouchDBã€MongoDB å…¸å‹åº”ç”¨ï¼šWebåº”ç”¨ï¼ˆä¸Key-Valueç±»ä¼¼ï¼ŒValueæ˜¯ç»“æ„åŒ–çš„ï¼‰ æ•°æ®æ¨¡å‹ï¼š ä¸€ç³»åˆ—é”®å€¼å¯¹ ä¼˜åŠ¿ï¼šæ•°æ®ç»“æ„è¦æ±‚ä¸ä¸¥æ ¼ åŠ£åŠ¿ï¼š æŸ¥è¯¢æ€§èƒ½ä¸é«˜ï¼Œè€Œä¸”ç¼ºä¹ç»Ÿä¸€çš„æŸ¥è¯¢è¯­æ³•
- å›¾å½¢(Graph)æ•°æ®åº“ ç›¸å…³æ•°æ®åº“ï¼šNeo4Jã€InfoGridã€Infinite Graph å…¸å‹åº”ç”¨ï¼šç¤¾äº¤ç½‘ç»œ æ•°æ®æ¨¡å‹ï¼šå›¾ç»“æ„ ä¼˜åŠ¿ï¼šåˆ©ç”¨å›¾ç»“æ„ç›¸å…³ç®—æ³•ã€‚ åŠ£åŠ¿ï¼šéœ€è¦å¯¹æ•´ä¸ªå›¾åšè®¡ç®—æ‰èƒ½å¾—å‡ºç»“æœï¼Œä¸å®¹æ˜“åšåˆ†å¸ƒå¼çš„é›†ç¾¤æ–¹æ¡ˆã€‚

## 1.3 Redis åŸºæœ¬æ¦‚å¿µ

Redisæ˜¯ä½¿ç”¨cè¯­è¨€å¼€å‘çš„ä¸€ä¸ªé«˜æ€§èƒ½é”®å€¼æ•°æ®åº“ã€‚Rediså¯ä»¥é€šè¿‡ä¸€äº›é”®å€¼ç±»å‹æ¥å­˜å‚¨æ•°æ®ã€‚ é”®å€¼ç±»å‹ï¼š Stringå­—ç¬¦ç±»å‹ mapæ•£åˆ—ç±»å‹ liståˆ—è¡¨ç±»å‹ seté›†åˆç±»å‹ sortedsetæœ‰åºé›†åˆç±»å‹

## 1.4 å‘å±•å†å²

2008å¹´ï¼Œæ„å¤§åˆ©çš„ä¸€å®¶åˆ›ä¸šå…¬å¸Merziaæ¨å‡ºäº†ä¸€æ¬¾åŸºäºMySQLçš„ç½‘ç«™å®æ—¶ç»Ÿè®¡ç³»ç»ŸLLOOGGï¼Œç„¶è€Œæ²¡è¿‡å¤šä¹…è¯¥å…¬å¸çš„åˆ›å§‹äºº Salvatore Sanfilippoä¾¿ å¯¹MySQLçš„æ€§èƒ½æ„Ÿåˆ°å¤±æœ›ï¼Œäºæ˜¯ä»–å†³å®šäº²è‡ªä¸ºLLOOGGé‡èº«å®šåšä¸€ä¸ªæ•°æ®åº“ï¼Œå¹¶äº2009å¹´å¼€å‘å®Œæˆï¼Œè¿™ä¸ªæ•°æ®åº“å°±æ˜¯Redisã€‚ ä¸è¿‡Salvatore Sanfilippoå¹¶ä¸æ»¡è¶³åªå°†Redisç”¨äºLLOOGGè¿™ä¸€æ¬¾äº§å“ï¼Œè€Œæ˜¯å¸Œæœ›æ›´å¤šçš„äººä½¿ç”¨å®ƒï¼Œäºæ˜¯åœ¨åŒä¸€å¹´Salvatore Sanfilippoå°†Rediså¼€æºå‘å¸ƒï¼Œå¹¶å¼€å§‹å’ŒRedisçš„å¦ä¸€åä¸»è¦çš„ä»£ç è´¡çŒ®è€…Pieter Noordhuisä¸€èµ·ç»§ç»­ç€Redisçš„å¼€å‘ï¼Œç›´åˆ°ä»Šå¤©ã€‚

Salvatore Sanfilippoè‡ªå·±ä¹Ÿæ²¡æœ‰æƒ³åˆ°ï¼ŒçŸ­çŸ­çš„å‡ å¹´æ—¶é—´ï¼ŒRediså°±æ‹¥æœ‰äº†åºå¤§çš„ç”¨æˆ·ç¾¤ä½“ã€‚Hacker Newsåœ¨2012å¹´å‘å¸ƒäº†ä¸€ä»½æ•°æ®åº“çš„ä½¿ç”¨æƒ…å†µè°ƒæŸ¥ï¼Œç»“æœæ˜¾ç¤ºæœ‰è¿‘12%çš„å…¬å¸åœ¨ä½¿ç”¨Redisã€‚å›½å†…å¦‚æ–°æµªå¾®åšã€è¡—æ—ç½‘ã€çŸ¥ä¹ç½‘ï¼Œå›½å¤–å¦‚GitHubã€Stack Overflowã€Flickrç­‰éƒ½æ˜¯Redisçš„ç”¨æˆ·ã€‚

VMwareå…¬å¸ä»2010å¹´å¼€å§‹èµåŠ©Redisçš„å¼€å‘ï¼Œ Salvatore Sanfilippoå’ŒPieter Noordhuisä¹Ÿåˆ†åˆ«åœ¨3æœˆå’Œ5æœˆåŠ å…¥VMwareï¼Œå…¨èŒå¼€å‘Redisã€‚

## 1.5 åº”ç”¨åœºæ™¯

ç¼“å­˜ï¼ˆæ•°æ®æŸ¥è¯¢ã€çŸ­è¿æ¥ã€æ–°é—»å†…å®¹ã€å•†å“å†…å®¹ç­‰ç­‰ï¼‰ã€‚ï¼ˆæœ€å¤šä½¿ç”¨ï¼‰ åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ä¸­çš„sessionåˆ†ç¦»ã€‚ èŠå¤©å®¤çš„åœ¨çº¿å¥½å‹åˆ—è¡¨ã€‚ ä»»åŠ¡é˜Ÿåˆ—ã€‚ï¼ˆç§’æ€ã€æŠ¢è´­ã€12306ç­‰ç­‰ï¼‰ åº”ç”¨æ’è¡Œæ¦œã€‚ ç½‘ç«™è®¿é—®ç»Ÿè®¡ã€‚ æ•°æ®è¿‡æœŸå¤„ç†ï¼ˆå¯ä»¥ç²¾ç¡®åˆ°æ¯«ç§’ï¼‰

# 2. Redis å®‰è£…

## 2.1 ä¸‹è½½

å®˜ç½‘åœ°å€ï¼šhttp://redis.io/ ä¸‹è½½åœ°å€ï¼šhttp://download.redis.io/releases/redis-3.0.0.tar.gz

## 2.2 å®‰è£…

```Bash
#sftp ä¸Šä¼ å®‰è£…åŒ…åˆ°linux
#è§£å‹
tar -zxvf redis.3.0.0.tar.gz
#å®‰è£…cè¯­è¨€ç¯å¢ƒ
sudo apt-get install gcc-c++
#ç¼–è¯‘
cd redis-3.0.0
make
#å®‰è£…
make install PREFIX = /usr/local/redis
# æŸ¥çœ‹
cd /usr/local/redis
ls
```

## 2.3 redis å¯åŠ¨

### 2.3.1 å‰ç«¯å¯åŠ¨

- å‰ç«¯å¯åŠ¨å‘½ä»¤ `./redis-server`
- å‰ç«¯å¯åŠ¨çš„å…³é—­ å¼ºåˆ¶å…³é—­ `ctrl+c` æ­£å¸¸å…³é—­ `./redis-cli shutdown`

**tips:**ä¸€æ—¦å®¢æˆ·ç«¯å…³é—­ï¼Œåˆ™redisæœåŠ¡ä¹Ÿä¼šåœæ‰

### 2.3.2 åç«¯å¯åŠ¨

- å°† redis æºç åŒ…ä¸­çš„ redis.conf æ–‡ä»¶æ‹·è´è‡³ bin ç›®å½•ä¸‹ `cp /root/redis-3.0.0/redis.conf`
- ä¿®æ”¹ redis.conf æ–‡ä»¶ï¼Œå°† daemonize æ”¹ä¸º yes `vim redis.conf`
- ä½¿ç”¨åç«¯å‘½ä»¤å¯åŠ¨ redis `./redis-server redis.conf`
- æŸ¥çœ‹æ˜¯å¦å¯åŠ¨æˆåŠŸ `ps -aux | grep redis`
- å…³é—­åç«¯å¯åŠ¨çš„æ–¹å¼ å¼ºåˆ¶å…³é—­ï¼š `kill -9 è¿›ç¨‹å·` æ­£å¸¸å…³é—­ï¼š`./redis-cli shutdown`

# 3. Redis å®¢æˆ·ç«¯

## 3.1 è‡ªå¸¦å®¢æˆ·ç«¯

- å¯åŠ¨ `./redis-cli -h 127.0.0.1 -p 6379` -h æŒ‡å®šè®¿é—® redis æœåŠ¡å™¨çš„ ip åœ°å€ -p æŒ‡å®šè®¿é—®çš„ redis æœåŠ¡å™¨çš„ port ç«¯å£ è¿˜å¯ä»¥å†™æˆ ./redis-cli ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œé»˜è®¤ip 127.0.0.1,é»˜è®¤ç«¯å£ 6379
- å…³é—­ ctrl + c 127.0.0.1:6379>quit

## 3.2 å›¾å½¢ç•Œé¢å®¢æˆ·ç«¯

redis-desktop-manager æ‰“å¼€å¦‚ä¸‹ï¼š



![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fb76b84fb?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)





![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fb77dd501?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



é€‰æ‹©æ•°æ®åº“æ–¹å¼ï¼š select åŠ ä¸Šæ•°æ®åº“çš„ä¸‹æ ‡ï¼Œå°±å¯ä»¥é€‰æ‹©æŒ‡å®šçš„æ•°æ®åº“ä½¿ç”¨ï¼Œä¸‹æ ‡ä»0å¼€å§‹ã€‚

```BASH
127.0.0.1:6379> select 15
OK
127.0.0.1:6379[15]>
```

## 3.3 jedis å®¢æˆ·ç«¯

### 3.3.1 ä»‹ç»

Redisä¸ä»…æ˜¯ä½¿ç”¨å‘½ä»¤æ¥æ“ä½œï¼Œç°åœ¨åŸºæœ¬ä¸Šä¸»æµçš„è¯­è¨€éƒ½æœ‰å®¢æˆ·ç«¯æ”¯æŒï¼Œæ¯”å¦‚javaã€Cã€C#ã€C++ã€phpã€Node.jsã€Goç­‰ã€‚

åœ¨å®˜æ–¹ç½‘ç«™é‡Œåˆ—ä¸€äº›Javaçš„å®¢æˆ·ç«¯ï¼Œæœ‰Jedisã€Redissonã€Jredisã€JDBC-Redisã€ç­‰å…¶ä¸­å®˜æ–¹æ¨èä½¿ç”¨Jediså’ŒRedissonã€‚ åœ¨ä¼ä¸šä¸­ç”¨çš„æœ€å¤šçš„å°±æ˜¯Jedisï¼Œä¸‹é¢æˆ‘ä»¬å°±é‡ç‚¹å­¦ä¹ ä¸‹Jedisã€‚

JedisåŒæ ·ä¹Ÿæ˜¯æ‰˜ç®¡åœ¨githubä¸Šï¼Œåœ°å€ï¼šhttps://github.com/xetorthio/jedis

### 3.3.2 å·¥ç¨‹æ­å»º

- æ·»åŠ  jar commons-pool2-2.3.jar jedis-2.7.0.jar

#### 3.3.2.1 å•ä¾‹è¿æ¥ redis



![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fb78554a7?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



#### 3.3.2.2 ä½¿ç”¨è¿æ¥æ± è¿æ¥ redis



![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fb7d9bcaf?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



#### 3.3.2.3 Spring æ•´åˆ jedisPool

æ·»åŠ  spring çš„ jar åŒ… é…ç½® spring é…ç½®æ–‡ä»¶ applicationContext.xml

```XML
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:mvc="http://www.springframework.org/schema/mvc"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.2.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop-3.2.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-3.2.xsd ">

    <!-- è¿æ¥æ± é…ç½® -->
    <bean id="jedisPoolConfig" class="redis.clients.jedis.JedisPoolConfig">
        <!-- æœ€å¤§è¿æ¥æ•° -->
        <property name="maxTotal" value="30" />
        <!-- æœ€å¤§ç©ºé—²è¿æ¥æ•° -->
        <property name="maxIdle" value="10" />
        <!-- æ¯æ¬¡é‡Šæ”¾è¿æ¥çš„æœ€å¤§æ•°ç›® -->
        <property name="numTestsPerEvictionRun" value="1024" />
        <!-- é‡Šæ”¾è¿æ¥çš„æ‰«æé—´éš”ï¼ˆæ¯«ç§’ï¼‰ -->
        <property name="timeBetweenEvictionRunsMillis" value="30000" />
        <!-- è¿æ¥æœ€å°ç©ºé—²æ—¶é—´ -->
        <property name="minEvictableIdleTimeMillis" value="1800000" />
        <!-- è¿æ¥ç©ºé—²å¤šä¹…åé‡Šæ”¾, å½“ç©ºé—²æ—¶é—´>è¯¥å€¼ ä¸” ç©ºé—²è¿æ¥>æœ€å¤§ç©ºé—²è¿æ¥æ•° æ—¶ç›´æ¥é‡Šæ”¾ -->
        <property name="softMinEvictableIdleTimeMillis" value="10000" />
        <!-- è·å–è¿æ¥æ—¶çš„æœ€å¤§ç­‰å¾…æ¯«ç§’æ•°,å°äºé›¶:é˜»å¡ä¸ç¡®å®šçš„æ—¶é—´,é»˜è®¤-1 -->
        <property name="maxWaitMillis" value="1500" />
        <!-- åœ¨è·å–è¿æ¥çš„æ—¶å€™æ£€æŸ¥æœ‰æ•ˆæ€§, é»˜è®¤false -->
        <property name="testOnBorrow" value="false" />
        <!-- åœ¨ç©ºé—²æ—¶æ£€æŸ¥æœ‰æ•ˆæ€§, é»˜è®¤false -->
        <property name="testWhileIdle" value="true" />
        <!-- è¿æ¥è€—å°½æ—¶æ˜¯å¦é˜»å¡, falseæŠ¥å¼‚å¸¸,tureé˜»å¡ç›´åˆ°è¶…æ—¶, é»˜è®¤true -->
        <property name="blockWhenExhausted" value="false" />
    </bean>

    <!-- rediså•æœº é€šè¿‡è¿æ¥æ±  -->
    <bean id="jedisPool" class="redis.clients.jedis.JedisPool"
        destroy-method="close">
        <constructor-arg name="poolConfig" ref="jedisPoolConfig" />
        <constructor-arg name="host" value="192.168.242.130" />
        <constructor-arg name="port" value="6379" />
    </bean>
</beans>
```

æµ‹è¯•ä»£ç 

```Java
    @Test
    public void testJedisPool() {
        JedisPool pool = (JedisPool) applicationContext.getBean("jedisPool");
        Jedis jedis = null;
        try {
            jedis = pool.getResource();

            jedis.set("name", "lisi");
            String name = jedis.get("name");
            System.out.println(name);
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (jedis != null) {
                // å…³é—­è¿æ¥
                jedis.close();
            }
        }
    }
```

# 4. æ•°æ®ç±»å‹

## 4.1 String ç±»å‹

èµ‹å€¼ set key value

```BASH
127.0.0.1:6379> set test 123
OK
```

å–å€¼ get key

```BASH
127.0.0.1:6379> get test
"123"
```

å–å€¼å¹¶èµ‹å€¼ getset key value

```BASH
127.0.0.1:6379> getset test 321
"123"
127.0.0.1:6379> get test
"321"
```

è®¾ç½®è·å–å¤šä¸ªé”®å€¼ mset key value [key value...] mget key [key...]

```BASH
127.0.0.1:6379> mset k1 v1 k2 v2 k3 v3
OK
127.0.0.1:6379> mget k1 k2
1) "v1"
2) "v2"
```

åˆ é™¤ del key

```BASH
127.0.0.1:6379> del test
(integer) 1
```

æ•°å€¼å¢å‡

- é€’å¢æ•°å­— å½“å­˜å‚¨çš„å­—ç¬¦ä¸²æ˜¯æ•´æ•°æ—¶ï¼ŒRedisæä¾›äº†ä¸€ä¸ªå®ç”¨çš„å‘½ä»¤INCRï¼Œå…¶ä½œç”¨æ˜¯è®©å½“å‰é”®å€¼é€’å¢ï¼Œå¹¶è¿”å›é€’å¢åçš„å€¼ã€‚ è¯­æ³•ï¼šincr key

  ```BASH
  127.0.0.1:6379> set num 1
  OK
  127.0.0.1:6379> incr num
  (integer) 2
  127.0.0.1:6379> incr num
  (integer) 3
  127.0.0.1:6379> incr num
  (integer) 4
  ```

- å¢åŠ æŒ‡å®šçš„æ•´æ•° incrby key increment

  ```BASH
  127.0.0.1:6379> incrby num 2
  (integer) 8
  127.0.0.1:6379> incrby num 2
  (integer) 10
  ```

- é€’å‡æ•°å€¼ decr key

  ```BASH
  127.0.0.1:6379> decr num
  (integer) 9
  127.0.0.1:6379> decr num
  (integer) 8
  ```

- å‡å°‘æŒ‡å®šçš„æ•°å€¼ decryby key decrement

  ```BASH
  127.0.0.1:6379> decrby num 2
  (integer) 6
  127.0.0.1:6379> decrby num 2
  (integer) 4
  ```

å‘å°¾éƒ¨è¿½åŠ å€¼ APPENDçš„ä½œç”¨æ˜¯å‘é”®å€¼çš„æœ«å°¾è¿½åŠ valueã€‚å¦‚æœé”®ä¸å­˜åœ¨åˆ™å°†è¯¥é”®çš„å€¼è®¾ç½®ä¸ºvalueï¼Œå³ç›¸å½“äº SET key valueã€‚è¿”å›å€¼æ˜¯è¿½åŠ åå­—ç¬¦ä¸²çš„æ€»é•¿åº¦ã€‚ è¯­æ³•ï¼šappend key value

```BASH
127.0.0.1:6379> set str hello
OK
127.0.0.1:6379> append str "world"
(integer) 10
127.0.0.1:6379> get str
"helloworld"
```

è·å–å­—ç¬¦ä¸²é•¿åº¦ STRLENå‘½ä»¤è¿”å›é”®å€¼çš„é•¿åº¦ï¼Œå¦‚æœé”®ä¸å­˜åœ¨åˆ™è¿”å›0ã€‚ è¯­æ³•ï¼šstrlen key

```BASH
127.0.0.1:6379> strlen str
(integer) 10
```

åº”ç”¨

- è‡ªå¢ä¸»é”® å•†å“ç¼–å·ã€è®¢å•å·é‡‡ç”¨ string çš„é€’å¢æ•°å­—ç‰¹æ€§ç”Ÿæˆ

## 4.2 Hash æ•£åˆ—ç±»å‹

### 4.2.1 ä½¿ç”¨ string çš„é—®é¢˜

å‡è®¾æœ‰Userå¯¹è±¡ä»¥JSONåºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨åˆ°Redisä¸­ï¼ŒUserå¯¹è±¡æœ‰idï¼Œusernameã€passwordã€ageã€nameç­‰å±æ€§ï¼Œå­˜å‚¨çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š ä¿å­˜ã€æ›´æ–°ï¼šUserå¯¹è±¡  json(string)  redis

å¦‚æœåœ¨ä¸šåŠ¡ä¸Šåªæ˜¯æ›´æ–°ageå±æ€§ï¼Œå…¶ä»–çš„å±æ€§å¹¶ä¸åšæ›´æ–°æˆ‘åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ å¦‚æœä»ç„¶é‡‡ç”¨ä¸Šè¾¹çš„æ–¹æ³•åœ¨ä¼ è¾“ã€å¤„ç†æ—¶ä¼šé€ æˆèµ„æºæµªè´¹ï¼Œä¸‹è¾¹è®²çš„hashå¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

### 4.2.2 ä»‹ç»

hashå«æ•£åˆ—ç±»å‹ï¼Œå®ƒæä¾›äº†å­—æ®µå’Œå­—æ®µå€¼çš„æ˜ å°„ã€‚å­—æ®µå€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä¸æ”¯æŒæ•£åˆ—ç±»å‹ã€é›†åˆç±»å‹ç­‰å…¶å®ƒç±»å‹ã€‚å¦‚ä¸‹ï¼š

![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fb7c5cdaf?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



### 4.2.3 å‘½ä»¤

èµ‹å€¼ HSETå‘½ä»¤ä¸åŒºåˆ†æ’å…¥å’Œæ›´æ–°æ“ä½œï¼Œå½“æ‰§è¡Œæ’å…¥æ“ä½œæ—¶HSETå‘½ä»¤è¿”å›1ï¼Œå½“æ‰§è¡Œæ›´æ–°æ“ä½œæ—¶è¿”å›0ã€‚

- ä¸€æ¬¡åªè®¾ç½®ä¸€ä¸ªå­—æ®µå€¼ è¯­æ³•ï¼šhset key field value

  ```BASH
  127.0.0.1:6379> hset user username zhangsan
  (integer) 1
  ```

- ä¸€æ¬¡è®¾ç½®å¤šä¸ªå­—æ®µå€¼ è¯­æ³•ï¼šhmset key field value [field value...]

  ```BASH
  127.0.0.1:6379> hmset user age 20 username lisi
  OK
  ```

- å½“å­—æ®µä¸å­˜åœ¨æ—¶èµ‹å€¼ï¼Œç±»ä¼¼hset,åŒºåˆ«åœ¨äºå¦‚æœå­—æ®µå­˜åœ¨ï¼Œè¯¥å‘½ä»¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ è¯­æ³•ï¼šhsetnx key field value

  ```BASH
  127.0.0.1:6379> hsetnx user age 30
  (integer) 0
  ```

å–å€¼

- ä¸€æ¬¡è·å–ä¸€ä¸ªå­—æ®µå€¼ è¯­æ³•ï¼šhget key field

  ```BASH
  127.0.0.1:6379> hget user username
  "lisi"
  ```

- ä¸€æ¬¡å¯ä»¥è·å–å¤šä¸ªå­—æ®µå€¼ è¯­æ³•ï¼šhmget key field [field...]

  ```BASH
  127.0.0.1:6379> hmget user age username
  1) "20"
  2) "lisi"
  ```

- è·å–æ‰€æœ‰å­—æ®µå€¼ è¯­æ³•ï¼šhgetall key

  ```BASH
  127.0.0.1:6379> hgetall user
  1) "username"
  2) "lisi"
  3) "age"
  4) "20"
  ```

åˆ é™¤å­—æ®µ å¯ä»¥åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µï¼Œè¿”å›å€¼æ˜¯è¢«åˆ é™¤çš„å­—æ®µçš„ä¸ªæ•°ã€‚ è¯­æ³•ï¼šhdel key field [field...]

```BASH
127.0.0.1:6379> hdel user age
(integer) 1
127.0.0.1:6379> hdel user age username
(integer) 1
```

å¢åŠ æ•°å­— è¯­æ³•ï¼šhincrby key field increment

```BASH
127.0.0.1:6379> hincrby user age 2
(integer) 2
```

åˆ¤æ–­å­—æ®µæ˜¯å¦å­˜åœ¨ è¯­æ³•ï¼šhexists key field

```BASH
127.0.0.1:6379> hexists user age
(integer) 1
```

åªè·å–å­—æ®µåæˆ–å­—æ®µå€¼ è¯­æ³•ï¼š hkeys key hvals key

```BASH
127.0.0.1:6379> hkeys user
1) "age"
```

è·å–å­—æ®µæ•°é‡ è¯­æ³•ï¼šhlen key

```BASH
127.0.0.1:6379> hlen user
(integer) 1
```

åº”ç”¨ å­˜å‚¨å•†å“ä¿¡æ¯

```BASH
127.0.0.1:6379> hlen user
(integer) 1
```

è·å–å•†å“ä¿¡æ¯

```BASH
127.0.0.1:6379> hgetall items:1001
1) "id"
2) "3"
3) "name"
4) "apple"
5) "price"
6) "5.00"
```

## 4.3 List ç±»å‹

### 4.3.1 ArrayList å’Œ LinkedList çš„åŒºåˆ«

Arraylistæ˜¯ä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨æ•°æ®ï¼Œç‰¹ç‚¹ï¼šæŸ¥è¯¢å¿«ã€å¢åˆ æ…¢

Linkedlistæ˜¯ä½¿ç”¨åŒå‘é“¾è¡¨å­˜å‚¨æ•°æ®ï¼Œç‰¹ç‚¹ï¼šå¢åˆ å¿«ã€æŸ¥è¯¢æ…¢ï¼Œä½†æ˜¯æŸ¥è¯¢é“¾è¡¨ä¸¤ç«¯çš„æ•°æ®ä¹Ÿå¾ˆå¿«ã€‚

Redisçš„listæ˜¯é‡‡ç”¨æ¥é“¾è¡¨æ¥å­˜å‚¨çš„ï¼Œæ‰€ä»¥å¯¹äºredisçš„listæ•°æ®ç±»å‹çš„æ“ä½œï¼Œæ˜¯æ“ä½œlistçš„ä¸¤ç«¯æ•°æ®æ¥æ“ä½œçš„ã€‚

### 4.3.2 å‘½ä»¤

å‘åˆ—è¡¨ä¸¤ç«¯å¢åŠ å…ƒç´ 

- å‘åˆ—è¡¨å·¦è¾¹å¢åŠ å…ƒç´  è¯­æ³•ï¼šlpush key value [value...]

```BASH
127.0.0.1:6379> lpush list:1 1 2 3
(integer) 3
```

- å‘åˆ—è¡¨å³è¾¹å¢åŠ å…ƒç´  è¯­æ³•ï¼šrpush key value [value...]

```BASH
127.0.0.1:6379> rpush list:1 4 5 6
(integer) 6
```

æŸ¥çœ‹åˆ—è¡¨ LRANGEå‘½ä»¤æ˜¯åˆ—è¡¨ç±»å‹æœ€å¸¸ç”¨çš„å‘½ä»¤ä¹‹ä¸€ï¼Œè·å–åˆ—è¡¨ä¸­çš„æŸä¸€ç‰‡æ®µï¼Œå°†è¿”å›startã€stopä¹‹é—´çš„æ‰€æœ‰å…ƒç´ ï¼ˆåŒ…å«ä¸¤ç«¯çš„å…ƒç´ ï¼‰ï¼Œç´¢å¼•ä»0å¼€å§‹ã€‚ç´¢å¼•å¯ä»¥æ˜¯è´Ÿæ•°ï¼Œå¦‚ï¼šâ€œ-1â€ä»£è¡¨æœ€åè¾¹çš„ä¸€ä¸ªå…ƒç´ ã€‚

è¯­æ³•ï¼šlrange key start stop

```BASH
127.0.0.1:6379> lrange list:1 0 2
1) "3"
2) "2"
3) "1"
127.0.0.1:6379> lrange list:1 0 -1
1) "3"
2) "2"
3) "1"
4) "4"
5) "5"
6) "6"
```

ä»åˆ—è¡¨ä¸¤ç«¯å¼¹å‡ºå…ƒç´  LPOPå‘½ä»¤ä»åˆ—è¡¨å·¦è¾¹å¼¹å‡ºä¸€ä¸ªå…ƒç´ ï¼Œä¼šåˆ†ä¸¤æ­¥å®Œæˆï¼š

- ç¬¬ä¸€æ­¥æ˜¯å°†åˆ—è¡¨å·¦è¾¹çš„å…ƒç´ ä»åˆ—è¡¨ä¸­ç§»é™¤

- ç¬¬äºŒæ­¥æ˜¯è¿”å›è¢«ç§»é™¤çš„å…ƒç´ å€¼ã€‚ è¯­æ³•ï¼š lpop key rpop key

  ```BASH
  127.0.0.1:6379> lpop list:1
  "3"
  127.0.0.1:6379> rpop list:1
  "6"
  ```

è·å–åˆ—è¡¨ä¸­å…ƒç´ çš„ä¸ªæ•° è¯­æ³•ï¼šllen key

```BASH
127.0.0.1:6379> llen list:1
(integer) 4

```

åˆ é™¤åˆ—è¡¨ä¸­æŒ‡å®šçš„å€¼ LREMå‘½ä»¤ä¼šåˆ é™¤åˆ—è¡¨ä¸­å‰countä¸ªå€¼ä¸ºvalueçš„å…ƒç´ ï¼Œè¿”å›å®é™…åˆ é™¤çš„å…ƒç´ ä¸ªæ•°ã€‚æ ¹æ®countå€¼çš„ä¸åŒï¼Œè¯¥å‘½ä»¤çš„æ‰§è¡Œæ–¹å¼ä¼šæœ‰æ‰€ä¸åŒï¼š

- å½“count>0æ—¶ï¼Œ LREMä¼šä»åˆ—è¡¨å·¦è¾¹å¼€å§‹åˆ é™¤ã€‚
- å½“count<0æ—¶ï¼Œ LREMä¼šä»åˆ—è¡¨åè¾¹å¼€å§‹åˆ é™¤ã€‚
- å½“count=0æ—¶ï¼Œ LREMåˆ é™¤æ‰€æœ‰å€¼ä¸ºvalueçš„å…ƒç´ ã€‚

è¯­æ³•ï¼šlrem key count value

è·å¾—/è®¾ç½®æŒ‡å®šç´¢å¼•çš„å…ƒç´ å€¼

- è·å¾—æŒ‡å®šç´¢å¼•çš„å…ƒç´ å€¼ è¯­æ³•ï¼šlindex key index

  ```BASH
  127.0.0.1:6379> lindex list:1 2
  "4"

  ```

- è®¾ç½®æŒ‡å®šç´¢å¼•çš„å…ƒç´ å€¼ è¯­æ³•ï¼šlset key index value

  ```BASH
  127.0.0.1:6379> lset list:1 2 2
  OK
  ```

åªä¿ç•™åˆ—è¡¨æŒ‡å®šç‰‡æ®µ æŒ‡å®šèŒƒå›´å’Œ lrange ä¸€è‡´ è¯­æ³•ï¼šltrim key start stop

```BASH
127.0.0.1:6379> lrange list:1 0 -1
1) "2"
2) "1"
3) "2"
4) "5"
127.0.0.1:6379> ltrim list:1 0 2
OK
127.0.0.1:6379> lrange list:1 0 -1
1) "2"
2) "1"
3) "2"
```

å‘åˆ—è¡¨ä¸­æ’å…¥å…ƒç´  è¯¥å‘½ä»¤é¦–å…ˆä¼šåœ¨åˆ—è¡¨ä¸­ä»å·¦åˆ°å³æŸ¥æ‰¾å€¼ä¸ºpivotçš„å…ƒç´ ï¼Œç„¶åæ ¹æ®ç¬¬äºŒä¸ªå‚æ•°æ˜¯BEFOREè¿˜æ˜¯AFTERæ¥å†³å®šå°†valueæ’å…¥åˆ°è¯¥å…ƒç´ çš„å‰é¢è¿˜æ˜¯åé¢ã€‚ è¯­æ³•ï¼šlinsert key before | after pivot value

```BASH
127.0.0.1:6379> lrange list:1 0 -1
1) "2"
2) "1"
3) "2"
127.0.0.1:6379> linsert list:1 after 1 9
(integer) 4
127.0.0.1:6379> lrange list:1 0 -1
1) "2"
2) "1"
3) "9"
4) "2"
```

å°†å…ƒç´ ä»ä¸€ä¸ªåˆ—è¡¨è½¬ç§»åˆ°å¦ä¸€ä¸ªåˆ—è¡¨ è¯­æ³•ï¼šrpoplpush source destination

```BASH
127.0.0.1:6379> lrange list:1 0 -1
1) "2"
2) "1"
3) "9"
4) "2"
127.0.0.1:6379> rpoplpush list:1 newlist
"2"
127.0.0.1:6379> lrange newlist 0 -1
1) "2"
127.0.0.1:6379> lrange list:1 0 -1
1) "2"
2) "1"
3) "9"
```

åº”ç”¨ åœ¨Redisä¸­åˆ›å»ºå•†å“è¯„è®ºåˆ—è¡¨ ç”¨æˆ·å‘å¸ƒå•†å“è¯„è®ºï¼Œå°†è¯„è®ºä¿¡æ¯è½¬æˆjsonå­˜å‚¨åˆ°listä¸­ã€‚ ç”¨æˆ·åœ¨é¡µé¢æŸ¥è¯¢è¯„è®ºåˆ—è¡¨ï¼Œä»redisä¸­å–å‡ºjsonæ•°æ®å±•ç¤ºåˆ°é¡µé¢ã€‚

å®šä¹‰å•†å“è¯„è®ºåˆ—è¡¨keyï¼š å•†å“ç¼–å·ä¸º1001çš„å•†å“è¯„è®ºkeyã€items: comment:1001ã€‘

## 4.4 Set ç±»å‹

> é›†åˆç±»å‹ï¼šæ— åºã€ä¸å¯é‡å¤ åˆ—è¡¨ç±»å‹ï¼šæœ‰åºã€å¯é‡å¤

### 4.4.1 å‘½ä»¤

å¢åŠ /åˆ é™¤å…ƒç´  è¯­æ³•ï¼šsadd key member [member...]

```BASH
127.0.0.1:6379> sadd set a b c
(integer) 3
127.0.0.1:6379> sadd set a
(integer) 0
```

è¯­æ³•ï¼šsrem key member [member...]

```BASH
127.0.0.1:6379> srem set c
(integer) 1
```

è·å¾—é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´  è¯­æ³•ï¼šsmembers key

```BASH
127.0.0.1:6379> smembers set
1) "b"
2) "a"
```

åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ è¯­æ³•ï¼šsismember key member

```BASH
127.0.0.1:6379> sismember set a
(integer) 1
127.0.0.1:6379> sismember set h
(integer) 0
```

### 4.4.2 è¿ç®—å‘½ä»¤

é›†åˆçš„å·®é›†è¿ç®— A-B å±äº A å¹¶ä¸” ä¸å±äº B çš„å…ƒç´ æ„æˆçš„é›†åˆ

![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fb7f44674?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 è¯­æ³•ï¼šsdiff key [key...]



```BASH
127.0.0.1:6379> sadd setA 1 2 3
(integer) 3
127.0.0.1:6379> sadd setB 2 3 4
(integer) 3
127.0.0.1:6379> sdiff setA setB
1) "1"
127.0.0.1:6379> sdiff setB setA
1) "4"

```

é›†åˆçš„äº¤é›†è¿ç®— å±äºAä¸”å±äºBçš„å…ƒç´ æ„æˆçš„é›†åˆ

![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fdd992d6b?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 è¯­æ³•ï¼šsinter key [key...]



```BASH
127.0.0.1:6379> sinter setA setB
1) "2"
2) "3"
```

é›†åˆçš„å¹¶é›†è¿ç®— å±äº A æˆ–è€… å±äº B çš„å…ƒç´ æ„æˆçš„é›†åˆ

![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fdf3b75b5?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 è¯­æ³•ï¼šsunion key [key...]



```BASH
127.0.0.1:6379> sunion setA setB
1) "1"
2) "2"
3) "3"
4) "4"
```

è·å¾—é›†åˆä¸­å…ƒç´ çš„ä¸ªæ•° è¯­æ³•ï¼šscard key

```BASH
127.0.0.1:6379> smembers setA
1) "1"
2) "2"
3) "3"
127.0.0.1:6379> scard setA
(integer) 3
```

ä»é›†åˆä¸­å¼¹å‡ºä¸€ä¸ªå…ƒç´  æ³¨æ„:ç”±äºé›†åˆæ˜¯æ— åºçš„ï¼Œæ‰€æœ‰spopå‘½ä»¤ä¼šä»é›†åˆä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå…ƒç´ å¼¹å‡ºã€‚ è¯­æ³•ï¼šspop key

```BASH
127.0.0.1:6379> spop setA
"2"
```

## 4.5 Sortedset ç±»å‹

Sortedset åˆå« zset Sortedset æ˜¯æœ‰åºé›†åˆï¼Œå¯æ’åºçš„ï¼Œä½†æ˜¯å”¯ä¸€ã€‚ Sortedset å’Œ set çš„ä¸åŒä¹‹å¤„ï¼Œä¼šç»™ set ä¸­å…ƒç´ æ·»åŠ ä¸€ä¸ªåˆ†æ•°ï¼Œç„¶åé€šè¿‡è¿™ä¸ªåˆ†æ•°è¿›è¡Œæ’åºã€‚

### 4.5.1 å‘½ä»¤

#### 4.5.1.1 å¢åŠ å…ƒç´ 

å‘æœ‰åºé›†åˆä¸­åŠ å…¥ä¸€ä¸ªå…ƒç´ å’Œè¯¥å…ƒç´ çš„åˆ†æ•°ï¼Œå¦‚æœè¯¥å…ƒç´ å·²ç»å­˜åœ¨åˆ™ä¼šç”¨æ–°çš„åˆ†æ•°æ›¿æ¢åŸæœ‰çš„åˆ†æ•°ã€‚è¿”å›å€¼æ˜¯æ–°åŠ å…¥åˆ°é›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œä¸åŒ…å«ä¹‹å‰å·²ç»å­˜åœ¨çš„å…ƒç´ ã€‚ è¯­æ³•ï¼šzadd key score member [score member...]

```BASH
127.0.0.1:6379> zadd scoreboard 80 zhangsan 89 lisi 94 wangwu
(integer) 3
127.0.0.1:6379> zadd scoreboard 97 lisi
(integer) 0
```

#### 4.5.1.2 è·å–å…ƒç´ åˆ†æ•°

è¯­æ³•ï¼šzscore key member

```BASH
127.0.0.1:6379> zscore scoreboard lisi
"97"
```

#### 4.5.1.3 åˆ é™¤å…ƒç´ 

ç§»é™¤æœ‰åºé›†keyä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ï¼Œä¸å­˜åœ¨çš„æˆå‘˜å°†è¢«å¿½ç•¥ã€‚ å½“keyå­˜åœ¨ä½†ä¸æ˜¯æœ‰åºé›†ç±»å‹æ—¶ï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚

è¯­æ³•ï¼šzrem key member [member...]

```BASH
127.0.0.1:6379> zrem scoreboard lisi
(integer) 1
```

#### 4.5.1.4 è·å¾—æ’ååœ¨æŸä¸ªèŒƒå›´çš„å…ƒç´ åˆ—è¡¨

è·å¾—æ’ååœ¨æŸä¸ªèŒƒå›´çš„å…ƒç´ åˆ—è¡¨

- æŒ‰ç…§å…ƒç´ åˆ†æ•°ä»å°åˆ°å¤§çš„é¡ºåºè¿”å›ç´¢å¼•ä»startåˆ°stopä¹‹é—´çš„æ‰€æœ‰å…ƒç´ ï¼ˆåŒ…å«ä¸¤ç«¯çš„å…ƒç´ ï¼‰ è¯­æ³•ï¼šzrange key start stop [withscores]

  ```BASH
  127.0.0.1:6379> zrange scoreboard 0 2
  1) "zhangsan"
  2) "wangwu"
  ```

- æŒ‰ç…§å…ƒç´ åˆ†æ•°ä»å¤§åˆ°å°çš„é¡ºåºè¿”å›ç´¢å¼•ä»startåˆ°stopä¹‹é—´çš„æ‰€æœ‰å…ƒç´ ï¼ˆåŒ…å«ä¸¤ç«¯çš„å…ƒç´ ï¼‰ è¯­æ³•ï¼šzrevrange key start stop [withscores]

  ```BASH
  127.0.0.1:6379> zrevrange scoreboard 0 2
  1) "wangwu"
  2) "zhangsan"
  ```

  å¦‚æœéœ€è¦è·å¾—å…ƒç´ çš„åˆ†æ•°å¯ä»¥åœ¨å‘½ä»¤æœ«å°¾åŠ ä¸Š withscores å‚æ•° Â·Â·Â· 127.0.0.1:6379> zrevrange scoreboard 0 2 withscores

  1. "wangwu"
  2. "94"
  3. "zhangsan"
  4. "80" Â·Â·Â·

#### 4.5.1.5 è·å–å…ƒç´ çš„æ’å

- ä»å°åˆ°å¤§ è¯­æ³•ï¼šzrank key member

```BASH
127.0.0.1:6379> zrank scoreboard zhangsan
(integer) 0
```

- ä»å¤§åˆ°å° è¯­æ³•ï¼šzrevrank key member

```BASH
127.0.0.1:6379> zrevrank scoreboard zhangsan
(integer) 1
```

#### 4.5.1.6 è·å¾—æŒ‡å®šåˆ†æ•°èŒƒå›´çš„å…ƒç´ 

è¯­æ³•ï¼šzrangebyscore key min max [withscores][limit offset count]

```BASH
127.0.0.1:6379> ZRANGEBYSCORE scoreboard 90 97 WITHSCORES
1) "wangwu"
2) "94"
3) "lisi"
4) "97"
127.0.0.1:6379> ZRANGEBYSCORE scoreboard 70 100 limit 1 2
1) "wangwu"
2) "lisi"
```

#### 4.5.1.7 å¢åŠ æŸä¸ªå…ƒç´ çš„åˆ†æ•°

è¿”å›å€¼æ˜¯æ›´æ”¹åçš„åˆ†æ•° è¯­æ³•ï¼šzincrby key increment member

```BASH
127.0.0.1:6379> ZINCRBY scoreboard 4 lisi
"101â€œ
```

#### 4.5.1.8 è·å¾—é›†åˆä¸­å…ƒç´ çš„æ•°é‡

è¯­æ³•ï¼šzcard key

```BASH
127.0.0.1:6379> zcard scoreboard
(integer) 3
```

#### 4.5.1.9 è·å¾—æŒ‡å®šåˆ†æ•°èŒƒå›´å†…çš„å…ƒç´ ä¸ªæ•°

è¯­æ³•ï¼šzcount key min max

```bash
127.0.0.1:6379> zcount scoreboard 80 90
(integer) 1
```

#### 4.5.1.10 æŒ‰ç…§æ’åèŒƒå›´åˆ é™¤å…ƒç´ 

è¯­æ³•ï¼šzremrangebyrank key start stop

```bash
127.0.0.1:6379> zremrangebyrank scoreboard 0 1
(integer) 2
127.0.0.1:6379> zrange scoreboard 0 -1
1) "wangwu"
```

#### 4.5.1.11 æŒ‰ç…§åˆ†æ•°èŒƒå›´åˆ é™¤å…ƒç´ 

è¯­æ³•ï¼šzremrangebyscore key min max

```bash
127.0.0.1:6379> zadd scoreboard 84 zhangsan
(integer) 1
127.0.0.1:6379> ZREMRANGEBYSCORE scoreboard 80 100
(integer) 1
```

#### 4.5.1.12 åº”ç”¨

##### 4.5.1.13 å•†å“é”€å”®æ’è¡Œæ¦œ

éœ€æ±‚ï¼šæ ¹æ®å•†å“é”€å”®é‡å¯¹å•†å“è¿›è¡Œæ’è¡Œæ˜¾ç¤º æ€è·¯ï¼šå®šä¹‰å•†å“é”€å”®æ’è¡Œæ¦œï¼ˆsorted seté›†åˆï¼‰ï¼ŒKeyä¸ºitems:sellsortï¼Œåˆ†æ•°ä¸ºå•†å“é”€å”®é‡ã€‚

å†™å…¥å•†å“é”€å”®é‡ï¼š

- å•†å“ç¼–å·1001çš„é”€é‡æ˜¯9ï¼Œå•†å“ç¼–å·1002çš„é”€é‡æ˜¯10 192.168.101.3:7007> ZADD items:sellsort 9 1001 10 1002
- å•†å“ç¼–å·1001çš„é”€é‡åŠ 1 192.168.101.3:7001> ZINCRBY items:sellsort 1 1001
- å•†å“é”€é‡å‰10åï¼š 192.168.101.3:7001> ZRANGE items:sellsort 0 9 withscores

# 5. keys å‘½ä»¤

## 5.1 å¸¸ç”¨å‘½ä»¤

- keys è¿”å›æ»¡è¶³ç»™å®špattern çš„æ‰€æœ‰key redis 127.0.0.1:6379> keys mylist*
  1. "mylist"
  2. "mylist5"
  3. "mylist6"
  4. "mylist7"
  5. "mylist8"
- exists ç¡®è®¤ä¸€ä¸ªkey æ˜¯å¦å­˜åœ¨ ç¤ºä¾‹ï¼šä»ç»“æœæ¥çœ‹ï¼Œæ•°æ®åº“ä¸­ä¸å­˜åœ¨HongWan è¿™ä¸ªkeyï¼Œä½†æ˜¯age è¿™ä¸ªkey æ˜¯å­˜åœ¨çš„ redis 127.0.0.1:6379> exists HongWan (integer) 0 redis 127.0.0.1:6379> exists age (integer) 1 redis 127.0.0.1:6379>
- del åˆ é™¤ä¸€ä¸ªkey redis 127.0.0.1:6379> del age (integer) 1 redis 127.0.0.1:6379> exists age (integer) 0
- rename é‡å‘½åkey ç¤ºä¾‹ï¼šage æˆåŠŸçš„è¢«æˆ‘ä»¬æ”¹åä¸ºage_new äº† redis 127.0.0.1:6379[1]> keys *
  1. "age" redis 127.0.0.1:6379[1]> rename age age_new OK redis 127.0.0.1:6379[1]> keys *
  2. "age_new" redis 127.0.0.1:6379[1]>
- type è¿”å›å€¼çš„ç±»å‹ ç¤ºä¾‹ï¼šè¿™ä¸ªæ–¹æ³•å¯ä»¥éå¸¸ç®€å•çš„åˆ¤æ–­å‡ºå€¼çš„ç±»å‹ redis 127.0.0.1:6379> type addr string redis 127.0.0.1:6379> type myzset2 zset redis 127.0.0.1:6379> type mylist list redis 127.0.0.1:6379>

## 5.2 è®¾ç½® key çš„ç”Ÿå­˜æ—¶é—´

Redisåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­æ›´å¤šçš„ç”¨ä½œç¼“å­˜ï¼Œç„¶è€Œç¼“å­˜çš„æ•°æ®ä¸€èˆ¬éƒ½æ˜¯éœ€è¦è®¾ç½®ç”Ÿå­˜æ—¶é—´çš„ï¼Œå³ï¼šåˆ°æœŸåæ•°æ®é”€æ¯ã€‚

|                          |                                                      |
| ------------------------ | ---------------------------------------------------- |
| EXPIRE key seconds       | è®¾ç½®keyçš„ç”Ÿå­˜æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰keyåœ¨å¤šå°‘ç§’åä¼šè‡ªåŠ¨åˆ é™¤ |
| TTL key                  | æŸ¥çœ‹keyå‰©ä½™çš„ç”Ÿå­˜æ—¶é—´                                |
| PERSIST key              | æ¸…é™¤ç”Ÿå­˜æ—¶é—´                                         |
| PEXPIRE key milliseconds | ç”Ÿå­˜æ—¶é—´è®¾ç½®å•ä½ä¸ºï¼šæ¯«ç§’                             |

ä¾‹å­ï¼š

```BASH
192.168.101.3:7002> set test 1        è®¾ç½®testçš„å€¼ä¸º1
OK
192.168.101.3:7002> get test            è·å–testçš„å€¼
"1"
192.168.101.3:7002> EXPIRE test 5    è®¾ç½®testçš„ç”Ÿå­˜æ—¶é—´ä¸º5ç§’
(integer) 1
192.168.101.3:7002> TTL test            æŸ¥çœ‹testçš„ç”Ÿäºç”Ÿæˆæ—¶é—´è¿˜æœ‰1ç§’åˆ é™¤
(integer) 1
192.168.101.3:7002> TTL test
(integer) -2
192.168.101.3:7002> get test            è·å–testçš„å€¼ï¼Œå·²ç»åˆ é™¤
(nil)
```

# 6. Redis æŒä¹…åŒ–æ–¹æ¡ˆ

## 6.1 Rdb æ–¹å¼

Redis é»˜è®¤çš„æ–¹å¼ï¼Œredis é€šè¿‡å¿«ç…§æ–¹å¼å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚

### 6.1.1 è®¾ç½®æŒä¹…åŒ–å¿«ç…§çš„æ¡ä»¶

åœ¨ redis.conf ä¸­ä¿®æ”¹æŒä¹…åŒ–å¿«ç…§çš„æ¡ä»¶ï¼š

![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fe0a1ada1?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



### 6.1.2 æŒä¹…åŒ–æ–‡ä»¶çš„å­˜å‚¨ç›®å½•

åœ¨ redis.conf ä¸­å¯ä»¥æŒ‡å®šæŒä¹…åŒ–æ–‡ä»¶çš„å­˜å‚¨ç›®å½•

![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fe1863fc4?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



### 6.1.3 Rdb çš„é—®é¢˜

ä¸€æ—¦rediséæ³•å…³é—­ï¼Œé‚£ä¹ˆä¼šä¸¢å¤±æœ€åä¸€æ¬¡æŒä¹…åŒ–ä¹‹åçš„æ•°æ®ã€‚

å¦‚æœæ•°æ®ä¸é‡è¦ï¼Œåˆ™ä¸å¿…è¦å…³å¿ƒã€‚ å¦‚æœæ•°æ®ä¸èƒ½å…è®¸ä¸¢å¤±ï¼Œé‚£ä¹ˆè¦ä½¿ç”¨ aof æ–¹å¼ã€‚

## 6.2 Aof æ–¹å¼

Redis é»˜è®¤æ˜¯ä¸ä½¿ç”¨è¯¥æ–¹å¼æŒä¹…åŒ–çš„ã€‚Aof æ–¹å¼çš„æŒä¹…åŒ–ï¼Œæ˜¯æ“ä½œä¸€æ¬¡ redis æ•°æ®åº“ï¼Œåˆ™å°†æ“ä½œçš„è®°å½•å­˜å‚¨åˆ° aof æŒä¹…åŒ–æ–‡ä»¶ä¸­ã€‚

- ç¬¬ä¸€æ­¥ï¼šå¼€å¯ aof æ–¹å¼æŒä¹…åŒ–æ–¹æ¡ˆã€‚ å°†redis.confä¸­çš„appendonlyæ”¹ä¸ºyesï¼Œå³å¼€å¯aofæ–¹å¼çš„æŒä¹…åŒ–æ–¹æ¡ˆã€‚

  ![img](https://user-gold-cdn.xitu.io/2018/7/17/164a814fe9e43230?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

- Aofæ–‡ä»¶å­˜å‚¨çš„ç›®å½•å’Œrdbæ–¹å¼çš„ä¸€æ ·ã€‚ Aofæ–‡ä»¶å­˜å‚¨çš„åç§°

  ![img](https://user-gold-cdn.xitu.io/2018/7/17/164a815002bc38e1?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)


åœ¨ä½¿ç”¨aofå’Œrdbæ–¹å¼æ—¶ï¼Œå¦‚æœredisé‡å¯ï¼Œåˆ™æ•°æ®ä»aofæ–‡ä»¶åŠ è½½ã€‚

# 7. Redis çš„ä¸»ä»å¤åˆ¶

## 7.1 ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶

æŒä¹…åŒ–ä¿è¯äº†å³ä½¿redisæœåŠ¡é‡å¯ä¹Ÿä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œå› ä¸ºredisæœåŠ¡é‡å¯åä¼šå°†ç¡¬ç›˜ä¸ŠæŒä¹…åŒ–çš„æ•°æ®æ¢å¤åˆ°å†…å­˜ä¸­ï¼Œä½†æ˜¯å½“redisæœåŠ¡å™¨çš„ç¡¬ç›˜æŸåäº†å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œå¦‚æœé€šè¿‡redisçš„ä¸»ä»å¤åˆ¶æœºåˆ¶å°±å¯ä»¥é¿å…è¿™ç§å•ç‚¹æ•…éšœï¼Œå¦‚ä¸‹å›¾ï¼š

![img](https://user-gold-cdn.xitu.io/2018/7/17/164a81500462a9fe?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

 è¯´æ˜ï¼š



- ä¸»redisä¸­çš„æ•°æ®æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼ˆreplicationï¼‰å³ä»redis1å’Œä»redis2ï¼Œå³ä½¿ä¸€å°redisæœåŠ¡å™¨å®•æœºå…¶å®ƒä¸¤å°redisæœåŠ¡ä¹Ÿå¯ä»¥ç»§ç»­æä¾›æœåŠ¡ã€‚

- ä¸»redisä¸­çš„æ•°æ®å’Œä»redisä¸Šçš„æ•°æ®ä¿æŒå®æ—¶åŒæ­¥ï¼Œå½“ä¸»rediså†™å…¥æ•°æ®æ—¶é€šè¿‡ä¸»ä»å¤åˆ¶æœºåˆ¶ä¼šå¤åˆ¶åˆ°ä¸¤ä¸ªä»redisæœåŠ¡ä¸Šã€‚

- åªæœ‰ä¸€ä¸ªä¸»redisï¼Œå¯ä»¥æœ‰å¤šä¸ªä»redisã€‚

- ä¸»ä»å¤åˆ¶ä¸ä¼šé˜»å¡masterï¼Œåœ¨åŒæ­¥æ•°æ®æ—¶ï¼Œmaster å¯ä»¥ç»§ç»­å¤„ç†client è¯·æ±‚

- ä¸€ä¸ªrediså¯ä»¥å³æ˜¯ä¸»åˆæ˜¯ä»ï¼Œå¦‚ä¸‹å›¾ï¼š

  ![img](https://user-gold-cdn.xitu.io/2018/7/17/164a81500a27a479?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

## 7.2 ä¸»ä»å¤åˆ¶è®¾ç½®

### 7.2.1 ä¸»æœºé…ç½®

æ— éœ€é…ç½®

### 7.2.2 ä»æœºé…ç½®

- ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶å‡ºä¸€ä¸ªä»æœº `cp bin/ bin2 -r`

- ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ä»æœºçš„ redis.conf è¯­æ³•ï¼šslaveof masterip masterport slaveof 192.168.242.137 6379

  ![img](https://user-gold-cdn.xitu.io/2018/7/17/164a81500eb3446c?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

- ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹ä»æœºçš„ port åœ°å€ä¸º 6380

  ![img](https://user-gold-cdn.xitu.io/2018/7/17/164a815020992d63?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

- ç¬¬å››æ­¥ï¼šæ¸…é™¤ä»æœºçš„æŒä¹…åŒ–æ–‡ä»¶ `rm -rf appendonly.aof dump.rdb`

- ç¬¬äº”æ­¥ï¼šå¯åŠ¨ä»æœº `./redis-server redis.conf`

- ç¬¬å…­æ­¥ï¼šå¯åŠ¨6380çš„å®¢æˆ·ç«¯ `./redis-cli -p 6380`

*æ³¨æ„ï¼š* ä¸»æœºä¸€æ—¦å‘ç”Ÿå¢åˆ æ”¹æ“ä½œï¼Œé‚£ä¹ˆä»æœºä¼šå°†æ•°æ®åŒæ­¥åˆ°ä»æœºä¸­ ä»æœºä¸èƒ½æ‰§è¡Œå†™æ“ä½œ

# 8. Redis é›†ç¾¤

## 8.1 redis-cluster æ¶æ„å›¾



![img](https://user-gold-cdn.xitu.io/2018/7/17/164a8150227f25b1?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



æ¶æ„ç»†èŠ‚: (1)æ‰€æœ‰çš„redisèŠ‚ç‚¹å½¼æ­¤äº’è”(PING-PONGæœºåˆ¶),å†…éƒ¨ä½¿ç”¨äºŒè¿›åˆ¶åè®®ä¼˜åŒ–ä¼ è¾“é€Ÿåº¦å’Œå¸¦å®½. (2)èŠ‚ç‚¹çš„failæ˜¯é€šè¿‡é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹æ£€æµ‹å¤±æ•ˆæ—¶æ‰ç”Ÿæ•ˆ. (3)å®¢æˆ·ç«¯ä¸redisèŠ‚ç‚¹ç›´è¿,ä¸éœ€è¦ä¸­é—´proxyå±‚.å®¢æˆ·ç«¯ä¸éœ€è¦è¿æ¥é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹,è¿æ¥é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹å³å¯ (4)redis-clusteræŠŠæ‰€æœ‰çš„ç‰©ç†èŠ‚ç‚¹æ˜ å°„åˆ°[0-16383]slotä¸Š,cluster è´Ÿè´£ç»´æŠ¤node<->slot<->value Redis é›†ç¾¤ä¸­å†…ç½®äº† 16384 ä¸ªå“ˆå¸Œæ§½ï¼Œå½“éœ€è¦åœ¨ Redis é›†ç¾¤ä¸­æ”¾ç½®ä¸€ä¸ª key-value æ—¶ï¼Œredis å…ˆå¯¹ key ä½¿ç”¨ crc16 ç®—æ³•ç®—å‡ºä¸€ä¸ªç»“æœï¼Œç„¶åæŠŠç»“æœå¯¹ 16384 æ±‚ä½™æ•°ï¼Œè¿™æ ·æ¯ä¸ª key éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç¼–å·åœ¨ 0-16383 ä¹‹é—´çš„å“ˆå¸Œæ§½ï¼Œredis ä¼šæ ¹æ®èŠ‚ç‚¹æ•°é‡å¤§è‡´å‡ç­‰çš„å°†å“ˆå¸Œæ§½æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹.



![img](https://user-gold-cdn.xitu.io/2018/7/17/164a8150159e9a2c?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



## 8.2 redis-cluster æŠ•ç¥¨ å®¹é”™



![img](https://user-gold-cdn.xitu.io/2018/7/17/164a81502f173d74?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)



(1)é›†ç¾¤ä¸­æ‰€æœ‰masterå‚ä¸æŠ•ç¥¨,å¦‚æœåŠæ•°ä»¥ä¸ŠmasterèŠ‚ç‚¹ä¸å…¶ä¸­ä¸€ä¸ªmasterèŠ‚ç‚¹é€šä¿¡è¶…è¿‡(cluster-node-timeout),è®¤ä¸ºè¯¥masterèŠ‚ç‚¹æŒ‚æ‰. (2):ä»€ä¹ˆæ—¶å€™æ•´ä¸ªé›†ç¾¤ä¸å¯ç”¨(cluster_state:fail)?

- å¦‚æœé›†ç¾¤ä»»æ„masteræŒ‚æ‰,ä¸”å½“å‰masteræ²¡æœ‰slaveï¼Œåˆ™é›†ç¾¤è¿›å…¥failçŠ¶æ€ã€‚ä¹Ÿå¯ä»¥ç†è§£æˆé›†ç¾¤çš„[0-16383]slotæ˜ å°„ä¸å®Œå…¨æ—¶è¿›å…¥failçŠ¶æ€ã€‚
- å¦‚æœé›†ç¾¤è¶…è¿‡åŠæ•°ä»¥ä¸ŠmasteræŒ‚æ‰ï¼Œæ— è®ºæ˜¯å¦æœ‰slaveï¼Œé›†ç¾¤è¿›å…¥failçŠ¶æ€ã€‚

## 8.3 å®‰è£… Ruby

é›†ç¾¤ç®¡ç†å·¥å…·ï¼ˆredis-trib.rb)æ˜¯ä½¿ç”¨ ruby è„šæœ¬è¯­è¨€ç¼–å†™çš„ã€‚

- å®‰è£… ruby

```BASH
sudo apt-get install ruby
```

- ä¸Šä¼  redis-3.0.0.gem åˆ° linux
- å®‰è£… ruby å’Œ redis æ¥å£ `gem install redis-3.0.0.gem`
- å°† redis-3.0.0 åŒ…ä¸‹ src  ç›®å½•ä¸­çš„ä»¥ä¸‹æ–‡ä»¶æ‹·è´åˆ° redis/redis-cluster/

```BASH
cd /usr/local/redis/
mkdir redis-cluster
cd /root/redis-3.0.0/src/
cp redis-trib.rb /usr/local/redis/redis-cluster
```

## 8.4 æ­å»ºé›†ç¾¤

æ­å»ºé›†ç¾¤æœ€å°‘éœ€è¦ 3 å°ä¸»æœºï¼Œå¦‚æœæ¯å°ä¸»æœºå†é…ç½®ä¸€å°ä»æœºçš„è¯ï¼Œåˆ™æœ€å°‘éœ€è¦6å°æœºå™¨ã€‚ ç«¯å£è®¾è®¡ï¼š7001-7006

1. å¤åˆ¶å‡ºä¸€ä¸ª7001æœºå™¨ `cp bin ./redis-cluster/7001 -r`

2. å¦‚æœå­˜åœ¨æŒä¹…åŒ–æ–‡ä»¶ï¼Œåˆ™åˆ é™¤ `rm -rf appendonly.aof dump.rdb`

3. è®¾ç½®é›†ç¾¤å‚æ•°ï¼Œä¿®æ”¹redis.conf

   ![img](https://user-gold-cdn.xitu.io/2018/7/17/164a81503955b32e?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

4. ä¿®æ”¹ç«¯å£

   ![img](https://user-gold-cdn.xitu.io/2018/7/17/164a815042962114?imageView2/0/w/1280/h/960/format/jpeg/ignore-error/1)

5. å¤åˆ¶å‡º7002-7006æœºå™¨

```BASH
cp 7001/ 7002-r
cp 7001/ 7003-r
cp 7001/ 7004-r
cp 7001/ 7005-r
cp 7001/ 7006-r
```

1. ä¿®æ”¹7002-7006æœºå™¨ç«¯å£
2. åˆ›å»ºæ–‡ä»¶ start-all.sh

```BASH
cd 7001
./redis-server redis.conf
cd ..
cd 7002
./redis-server redis.conf
cd ..
cd 7003
./redis-server redis.conf
cd ..
cd 7004
./redis-server redis.conf
cd ..
cd 7005
./redis-server redis.conf
cd ..
cd 7006
./redis-server redis.conf
cd ..
```

1. ä¿®æ”¹æ–‡ä»¶æƒé™

```BASH
chmod u+x start-all.sh
```

1. æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨å…­å°æœºå™¨

```BASH
./start-all.sh
```

1. åˆ›å»ºé›†ç¾¤ `./redis-trib.rb create --replicas 1 192.168.126.128:7001 192.168.126.128:7002 192.168.126.128:7003 192.168.126.128:7004 192.168.126.128:7005 192.168.126.128:7006`

## 8.5 è¿æ¥é›†ç¾¤

```
root@ubuntu:/usr/local/redis/redis-cluster/7001# ./redis-cli -p 7001 -c

```

-c æŒ‡å®šé›†ç¾¤è¿æ¥

## 8.6 æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯

- æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯

  ```BASH
  192.168.126.128:7002> cluster info
  cluster_state:ok
  cluster_slots_assigned:16384
  cluster_slots_ok:16384
  cluster_slots_pfail:0
  cluster_slots_fail:0
  cluster_known_nodes:6
  cluster_size:3
  cluster_current_epoch:6
  cluster_my_epoch:2
  cluster_stats_messages_sent:260
  cluster_stats_messages_received:260
  ```

- æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹

  ```BASH
  192.168.126.128:7002> cluster nodes
  3a15e73dacb512745156535ae7f959acf65ae12e 192.168.126.128:7005 slave 23e173cdc0b7673dc28cae70efaabbc41308bfdc 0 1531452321139 5 connected
  2a58a53a5b10f7bd91af04128a6ed439d534c0ee 192.168.126.128:7001 master - 0 1531452322145 1 connected 0-5460
  d0808388485dd08f1a2ecdfe3d2b213742d0050d 192.168.126.128:7004 slave 2a58a53a5b10f7bd91af04128a6ed439d534c0ee 0 1531452318117 4 connected
  23e173cdc0b7673dc28cae70efaabbc41308bfdc 192.168.126.128:7002 myself,master - 0 0 2 connected 5461-10922
  2af2312acc56552f9f73470f90d9a51973fc74d3 192.168.126.128:7006 slave 78faf92cfdbd12e1b27b270fb0798e67017f4d0b 0 1531452320132 6 connected
  78faf92cfdbd12e1b27b270fb0798e67017f4d0b 192.168.126.128:7007 master - 0 1531452319123 3 connected 10923-16383
  ```

## 8.7 jedisè¿æ¥é›†ç¾¤

```Java
@Test
    public void jedisCluster() {
        // åˆ›å»ºjedisCluster
        Set<HostAndPort> nodes = new HashSet<>();
        nodes.add(new HostAndPort("192.168.242.137", 7001));
        nodes.add(new HostAndPort("192.168.242.137", 7002));
        nodes.add(new HostAndPort("192.168.242.137", 7003));
        nodes.add(new HostAndPort("192.168.242.137", 7004));
        nodes.add(new HostAndPort("192.168.242.137", 7005));
        nodes.add(new HostAndPort("192.168.242.137", 7006));
        nodes.add(new HostAndPort("192.168.242.137", 7007));

        JedisCluster cluster = new JedisCluster(nodes);

        cluster.set("s4", "444");

        String result = cluster.get("s4");
        System.out.println(result);

        cluster.close();
    }
```

## 8.8 ä½¿ç”¨ spring

é…ç½® applicationContext.xml

```XML
<!-- è¿æ¥æ± é…ç½® -->
<bean id="jedisPoolConfig" class="redis.clients.jedis.JedisPoolConfig">
    <!-- æœ€å¤§è¿æ¥æ•° -->
    <property name="maxTotal" value="30" />
    <!-- æœ€å¤§ç©ºé—²è¿æ¥æ•° -->
    <property name="maxIdle" value="10" />
    <!-- æ¯æ¬¡é‡Šæ”¾è¿æ¥çš„æœ€å¤§æ•°ç›® -->
    <property name="numTestsPerEvictionRun" value="1024" />
    <!-- é‡Šæ”¾è¿æ¥çš„æ‰«æé—´éš”ï¼ˆæ¯«ç§’ï¼‰ -->
    <property name="timeBetweenEvictionRunsMillis" value="30000" />
    <!-- è¿æ¥æœ€å°ç©ºé—²æ—¶é—´ -->
    <property name="minEvictableIdleTimeMillis" value="1800000" />
    <!-- è¿æ¥ç©ºé—²å¤šä¹…åé‡Šæ”¾, å½“ç©ºé—²æ—¶é—´>è¯¥å€¼ ä¸” ç©ºé—²è¿æ¥>æœ€å¤§ç©ºé—²è¿æ¥æ•° æ—¶ç›´æ¥é‡Šæ”¾ -->
    <property name="softMinEvictableIdleTimeMillis" value="10000" />
    <!-- è·å–è¿æ¥æ—¶çš„æœ€å¤§ç­‰å¾…æ¯«ç§’æ•°,å°äºé›¶:é˜»å¡ä¸ç¡®å®šçš„æ—¶é—´,é»˜è®¤-1 -->
    <property name="maxWaitMillis" value="1500" />
    <!-- åœ¨è·å–è¿æ¥çš„æ—¶å€™æ£€æŸ¥æœ‰æ•ˆæ€§, é»˜è®¤false -->
    <property name="testOnBorrow" value="true" />
    <!-- åœ¨ç©ºé—²æ—¶æ£€æŸ¥æœ‰æ•ˆæ€§, é»˜è®¤false -->
    <property name="testWhileIdle" value="true" />
    <!-- è¿æ¥è€—å°½æ—¶æ˜¯å¦é˜»å¡, falseæŠ¥å¼‚å¸¸,tureé˜»å¡ç›´åˆ°è¶…æ—¶, é»˜è®¤true -->
    <property name="blockWhenExhausted" value="false" />
</bean>
<!-- redisé›†ç¾¤ -->
<bean id="jedisCluster" class="redis.clients.jedis.JedisCluster">
    <constructor-arg index="0">
        <set>
            <bean class="redis.clients.jedis.HostAndPort">
                <constructor-arg index="0" value="192.168.101.3"></constructor-arg>
                <constructor-arg index="1" value="7001"></constructor-arg>
            </bean>
            <bean class="redis.clients.jedis.HostAndPort">
                <constructor-arg index="0" value="192.168.101.3"></constructor-arg>
                <constructor-arg index="1" value="7002"></constructor-arg>
            </bean>
            <bean class="redis.clients.jedis.HostAndPort">
                <constructor-arg index="0" value="192.168.101.3"></constructor-arg>
                <constructor-arg index="1" value="7003"></constructor-arg>
            </bean>
            <bean class="redis.clients.jedis.HostAndPort">
                <constructor-arg index="0" value="192.168.101.3"></constructor-arg>
                <constructor-arg index="1" value="7004"></constructor-arg>
            </bean>
            <bean class="redis.clients.jedis.HostAndPort">
                <constructor-arg index="0" value="192.168.101.3"></constructor-arg>
                <constructor-arg index="1" value="7005"></constructor-arg>
            </bean>
            <bean class="redis.clients.jedis.HostAndPort">
                <constructor-arg index="0" value="192.168.101.3"></constructor-arg>
                <constructor-arg index="1" value="7006"></constructor-arg>
            </bean>
        </set>
    </constructor-arg>
    <constructor-arg index="1" ref="jedisPoolConfig"></constructor-arg>
</bean>
```

æµ‹è¯•ä»£ç 

```Java
private ApplicationContext applicationContext;
    @Before
    public void init() {
        applicationContext = new ClassPathXmlApplicationContext(
                "classpath:applicationContext.xml");
    }

    // redisé›†ç¾¤
    @Test
    public void testJedisCluster() {
        JedisCluster jedisCluster = (JedisCluster) applicationContext
                .getBean("jedisCluster");

        jedisCluster.set("name", "zhangsan");
        String value = jedisCluster.get("name");
        System.out.println(value);
    }
```