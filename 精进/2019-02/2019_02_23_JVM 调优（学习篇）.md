title: JVM è°ƒä¼˜ï¼ˆå­¦ä¹ ç¯‡ï¼‰
date: 2019-02-23
tags:
categories: ç²¾è¿›
permalink: Fight/JVM-tuning-learning-article
author: SamåŒå­¦
from_url: https://juejin.im/post/59bf5da85188257e70532430
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://juejin.im/post/59bf5da85188257e70532430 ã€ŒSamåŒå­¦ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [-XX:AutoBoxCacheMax](http://www.iocoder.cn/Fight/JVM-tuning-learning-article/)
- [-XX:+AlwaysPreTouch](http://www.iocoder.cn/Fight/JVM-tuning-learning-article/)
- [CMSInitiatingOccupancyFraction](http://www.iocoder.cn/Fight/JVM-tuning-learning-article/)
- [MaxTenuringThreshold](http://www.iocoder.cn/Fight/JVM-tuning-learning-article/)
- [ExplicitGCInvokesConcurrent](http://www.iocoder.cn/Fight/JVM-tuning-learning-article/)
- [-Xmx, -Xms](http://www.iocoder.cn/Fight/JVM-tuning-learning-article/)
- [NewRatio](http://www.iocoder.cn/Fight/JVM-tuning-learning-article/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> æ¦‚è¿°

------

å…¬å¸çš„æ±Ÿå—ç™½è¡£å†™äº†ä¸€ç¯‡[å…³é”®ä¸šåŠ¡ç³»ç»Ÿçš„JVMå‚æ•°æ¨è(2016çƒ­å†¬ç‰ˆ)](https://link.juejin.im?target=http%3A%2F%2Fcalvin1978.blogcn.com%2Farticles%2Fjvmoption-2.html)çš„æ–‡ç« ,å¤§ç‰›çš„æ–‡ç« æ€»æ˜¯éœ€è¦ç»†ç»†å“è¯»ã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»å¤§é‡çš„JVMè°ƒä¼˜å‚æ•°,å†…å®¹ä¹Ÿæ¯”è¾ƒå¤š,æœ¬æ–‡åªæ˜¯åˆ—å‡ºæˆ‘è‡ªå·±èƒ½ç†è§£çš„ä¸€äº›å‚æ•°,æš‚æ—¶ç†è§£ä¸äº†çš„å‚æ•°å°±åªèƒ½ç­‰ä»¥åè‡ªå·±å®åŠ›åˆ°å®¶äº†,å†æ…¢æ…¢è¡¥å……ä¸Šæ¥ã€‚

------

> æ€§èƒ½è°ƒä¼˜å‚æ•°

------

# -XX:AutoBoxCacheMax

JAVAè¿›ç¨‹å¯åŠ¨çš„æ—¶å€™,ä¼šåŠ è½½rt.jarè¿™ä¸ªæ ¸å¿ƒåŒ…çš„,rt.jaråŒ…é‡Œçš„Integerè‡ªç„¶ä¹Ÿæ˜¯è¢«åŠ è½½åˆ°JVMä¸­,Integeré‡Œé¢æœ‰ä¸€ä¸ªIntegerCacheç¼“å­˜,å¦‚ä¸‹:

```Java
private static class IntegerCache {
        static final int low = -128;
        static final int high;
        static final Integer cache[];

        static {
            // high value may be configured by property
            int h = 127;
            String integerCacheHighPropValue =
                sun.misc.VM.getSavedProperty("java.lang.Integer.IntegerCache.high");
            if (integerCacheHighPropValue != null) {
                int i = parseInt(integerCacheHighPropValue);
                i = Math.max(i, 127);
                // Maximum array size is Integer.MAX_VALUE
                h = Math.min(i, Integer.MAX_VALUE - (-low) -1);
            }
            high = h;

            cache = new Integer[(high - low) + 1];
            int j = low;
            for(int k = 0; k < cache.length; k++)
                cache[k] = new Integer(j++);
        }

        private IntegerCache() {}
}
```

IntegerCacheæœ‰ä¸€ä¸ªé™æ€ä»£ç å—,JVMåœ¨åŠ è½½Integerè¿™ä¸ªç±»æ—¶,ä¼šä¼˜å…ˆåŠ è½½é™æ€çš„ä»£ç ã€‚å½“JVMè¿›ç¨‹å¯åŠ¨å®Œæ¯•å, -128 ~ +127 èŒƒå›´çš„æ•°å­—ä¼šè¢«ç¼“å­˜èµ·æ¥,è°ƒç”¨valueOfæ–¹æ³•çš„æ—¶å€™,å¦‚æœæ˜¯è¿™ä¸ªèŒƒå›´å†…çš„æ•°å­—,åˆ™ç›´æ¥ä»ç¼“å­˜å–å‡ºã€‚
è¶…è¿‡è¿™ä¸ªèŒƒå›´çš„,å°±åªèƒ½æ„é€ æ–°çš„Integerå¯¹è±¡äº†ã€‚

```Java
public static Integer valueOf(int i) {
        assert IntegerCache.high >= 127;
        if (i >= IntegerCache.low && i <= IntegerCache.high)
            return IntegerCache.cache[i + (-IntegerCache.low)];
        return new Integer(i);
}
```

å› æ­¤å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæŠŠAutoBoxCacheMaxçš„å€¼è®¾ç½®çš„å¤§å†™,æ¯”å¦‚æ±Ÿå—ç™½è¡£æ¨èçš„

```
-XX:AutoBoxCacheMax=20000
```

------

# -XX:+AlwaysPreTouch

JAVAè¿›ç¨‹å¯åŠ¨çš„æ—¶å€™,è™½ç„¶æˆ‘ä»¬å¯ä»¥ä¸ºJVMæŒ‡å®šåˆé€‚çš„å†…å­˜å¤§å°,ä½†æ˜¯è¿™äº›å†…å­˜æ“ä½œç³»ç»Ÿå¹¶æ²¡æœ‰çœŸæ­£çš„åˆ†é…ç»™JVM,è€Œæ˜¯ç­‰JVMè®¿é—®è¿™äº›å†…å­˜çš„æ—¶å€™,æ‰çœŸæ­£åˆ†é…,è¿™æ ·ä¼šé€ æˆä»¥ä¸‹é—®é¢˜ã€‚
1ã€GCçš„æ—¶å€™,æ–°ç”Ÿä»£çš„å¯¹è±¡è¦æ™‹å‡åˆ°è€å¹´ä»£çš„æ—¶å€™,éœ€è¦å†…å­˜,è¿™ä¸ªæ—¶å€™æ“ä½œç³»ç»Ÿæ‰çœŸæ­£åˆ†é…å†…å­˜,è¿™æ ·å°±ä¼šåŠ å¤§young gcçš„åœé¡¿æ—¶é—´;
2ã€å¯èƒ½å­˜åœ¨å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚

å¯ä»¥åœ¨JVMå¯åŠ¨çš„æ—¶å€™,é…ç½®

```
-XX:+AlwaysPreTouch
```

å‚æ•°,è¿™æ ·JVMå°±ä¼šå…ˆè®¿é—®æ‰€æœ‰åˆ†é…ç»™å®ƒçš„å†…å­˜,è®©æ“ä½œç³»ç»ŸæŠŠå†…å­˜çœŸæ­£çš„åˆ†é…ç»™JVM.åç»­JVMå°±å¯ä»¥é¡ºç•…çš„è®¿é—®å†…å­˜äº†ã€‚

------

> GCå‚æ•°

------

JAVA 1.7ç”¨çš„åƒåœ¾æ”¶é›†ç®—æ³•è¿˜æ˜¯CMS,ä¸‹æ–‡æåˆ°çš„å‚æ•°éƒ½æ˜¯é’ˆå¯¹CMSçš„ã€‚

------

# CMSInitiatingOccupancyFraction

ä¹‹å‰å†™è¿‡ä¸€ç¯‡[javaåƒåœ¾å›æ”¶ç®—æ³•ä¹‹-CMS(å¹¶å‘æ ‡è®°æ¸…é™¤)](https://link.juejin.im?target=http%3A%2F%2Fblog.csdn.net%2Flinsongbin1%2Farticle%2Fdetails%2F51686158),é‡Œé¢æåˆ°åƒåœ¾æ”¶é›†çº¿ç¨‹ä¼šè·Ÿåº”ç”¨çš„çº¿ç¨‹ä¸€èµ·å¹¶è¡Œçš„å·¥ä½œ,ä¸‡ä¸€åƒåœ¾æ”¶é›†çº¿ç¨‹åœ¨å·¥ä½œçš„æ—¶å€™,è€å¹´ä»£å†…å­˜ä¸è¶³æ€ä¹ˆåŠ?å› æ­¤æœ€å¥½è¿˜æ˜¯æå‰å¯åŠ¨CMSæ¥æ”¶é›†åƒåœ¾(CMS GC)ã€‚
å¯ä»¥é€šè¿‡è®¾ç½®

```
CMSInitiatingOccupancyFraction=75
```

é‚£ä¹ˆå½“è€å¹´ä»£å †ç©ºé—´çš„ä½¿ç”¨ç‡è¾¾åˆ°75%çš„æ—¶å€™å°±å¼€å§‹æ‰§è¡Œåƒåœ¾å›æ”¶,CMSInitiatingOccupancyFractioné»˜è®¤å€¼æ˜¯92%,è¿™ä¸ªå°±å¤ªå¤§äº†ã€‚
CMSInitiatingOccupancyFractionå‚æ•°å¿…é¡»è·Ÿä¸‹é¢ä¸¤ä¸ªå‚æ•°ä¸€èµ·ä½¿ç”¨æ‰èƒ½ç”Ÿæ•ˆçš„ã€‚

```
-XX:+UseConcMarkSweepGC
-XX:+UseCMSInitiatingOccupancyOnly
```

------

# MaxTenuringThreshold

æ–°ç”Ÿä»£æ˜¯ä½¿ç”¨copyç®—æ³•æ¥è¿›è¡Œåƒåœ¾å›æ”¶çš„,å¯ä»¥å‚çœ‹

> [javaåƒåœ¾å›æ”¶ç®—æ³•ä¹‹-copingå¤åˆ¶](https://link.juejin.im?target=http%3A%2F%2Fblog.csdn.net%2Flinsongbin1%2Farticle%2Fdetails%2F51668859%3FlocationNum%3D1%26fps%3D1)

é»˜è®¤æƒ…å†µä¸‹,å½“æ–°ç”Ÿä»£æ‰§è¡Œäº†15æ¬¡young gcå,å¦‚æœè¿˜æœ‰å¯¹è±¡å­˜æ´»åœ¨SurvivoråŒºä¸­,é‚£ä¹ˆå°±å¯ä»¥ç›´æ¥å°†è¿™äº›å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£,ä½†æ˜¯ç”±äºæ–°ç”Ÿä»£ä½¿ç”¨copyç®—æ³•,å¦‚æœSurvivoråŒºå­˜æ´»çš„å¯¹è±¡å¤ªä¹…çš„è¯,SurvivoråŒºå­˜æ´»çš„å¯¹è±¡å°±è¶Šå¤š,è¿™ä¸ªå°±ä¼šå½±å“copyç®—æ³•çš„æ€§èƒ½,ä½¿å¾—young gcåœé¡¿çš„æ—¶é—´åŠ é•¿,å»ºè®®è®¾ç½®æˆ6ã€‚

```
-XX:MaxTenuringThreshold=6
```

------

# ExplicitGCInvokesConcurrent

å¦‚æœç³»ç»Ÿä½¿ç”¨å †å¤–å†…å­˜,æ¯”å¦‚ç”¨åˆ°äº†Nettyçš„DirectByteBufferç±»,é‚£ä¹ˆå½“æƒ³å›æ”¶å †å¤–å†…å­˜çš„æ—¶å€™,éœ€è¦è°ƒç”¨

```Java
System.gc()
```

è€Œè¿™ä¸ªæ–¹æ³•å°†è¿›è¡Œfull gc,æ•´ä¸ªåº”ç”¨å°†ä¼šåœé¡¿,å¦‚æœæ˜¯ä½¿ç”¨CMSåƒåœ¾æ”¶é›†å™¨,é‚£ä¹ˆå¯ä»¥è®¾ç½®

```
-XX:+ExplicitGCInvokesConcurrent
```

è¿™ä¸ªå‚æ•°æ¥æ”¹å˜`System.gc()`çš„è¡Œä¸º,è®©å…¶ä»full gc --> CMS GC,CMS GCæ˜¯å¹¶å‘æ”¶é›†çš„,ä¸”ä¸­é—´æ‰§è¡Œçš„è¿‡ç¨‹ä¸­,åªæœ‰éƒ¨åˆ†é˜¶æ®µéœ€è¦stop the worldã€‚

æ³¨æ„:è®¾ç½®äº†ExplicitGCInvokesConcurrent,é‚£å°±ä¸è¦è®¾ç½®DisableExplicitGCå‚æ•°æ¥ç¦æ‰`System.gc()`ã€‚

------

> å†…å­˜å‚æ•°

------

# -Xmx, -Xms

è¿™ä¸¤ä¸ªä¸€èˆ¬éƒ½æ˜¯è®¾ç½®4ä¸ªg

------

# NewRatio

GCæœ€å¤šçš„è¿˜æ˜¯å‘ç”Ÿåœ¨æ–°ç”Ÿä»£çš„young gc,æ‰€ä»¥å¯ä»¥æé«˜ä¸€ä¸‹æ–°ç”Ÿä»£åœ¨æ•´ä¸ªå †çš„å ç”¨æ¯”ä¾‹,å»ºè®®è®¾ç½®ä¸ºå¯¹åŠåˆ†,å°½é‡é¿å…young gc

```
-XX:NewRatio=1
```