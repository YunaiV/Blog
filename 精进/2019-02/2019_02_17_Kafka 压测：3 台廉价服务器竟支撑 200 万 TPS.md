title: Kafka å‹æµ‹ï¼š3 å°å»‰ä»·æœåŠ¡å™¨ç«Ÿæ”¯æ’‘ 200 ä¸‡ TPS
date: 2019-02-17
tags:
categories: ç²¾è¿›
permalink: Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS
author: é£å“¥
from_url: https://www.jianshu.com/p/ba0642c2c328
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/ba0642c2c328 ã€Œé£å“¥ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [Kafka in 30 seconds](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [This Benchmark](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [The Setup](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [Producer Throughput](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Single producer thread, no replication](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Single producer thread, 3x async replication](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Single producer thread, 3x sync replication](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Three producers, 3x async replication](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Producer Throughput VS. Stored Data](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [Consumer Throughput](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Single Consumer](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Three Consumers](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [Producer and Consumer](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [Effect of Message Size](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [End-to-end Latency](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [Replicating this test](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
- [attachment](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [benchmark commands](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)
  - [server config](http://www.iocoder.cn/Fight/Kafka-stress-test-3-cheap-servers-support-2-million-TPS/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

è¿™ç¯‡æ–‡ç« æ˜¯å…³äºLinkedInå¦‚ä½•ç”¨kafkaä½œä¸ºä¸€ä¸ªä¸­å¤®å‘å¸ƒ-è®¢é˜…æ—¥å¿—ï¼Œåœ¨åº”ç”¨ç¨‹åºï¼Œæµå¤„ç†ï¼Œhadoopæ•°æ®æå–ä¹‹é—´é›†æˆæ•°æ®ã€‚æ— è®ºå¦‚ä½•ï¼Œkafkaæ—¥å¿—ä¸€ä¸ªå¥½å¤„å°±æ˜¯å»‰ä»·ã€‚ç™¾ä¸‡çº§åˆ«çš„TPSéƒ½ä¸æ˜¯å¾ˆå¤§çš„äº‹æƒ…ã€‚å› ä¸ºæ—¥å¿—æ¯”èµ·æ•°æ®åº“æˆ–è€…K-Vå­˜å‚¨æ˜¯æ›´ç®€å•çš„ä¸œè¥¿ã€‚æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒkafkaé›†ç¾¤æ¯å¤©æ¯ç§’å¤„ç†ä¸Šåƒä¸‡è¯»å†™è¯·æ±‚ï¼Œå¹¶ä¸”åªæ˜¯æ„å»ºåœ¨ä¸€ä¸ªéå¸¸æ™®é€šçš„ç¡¬ä»¶ä¸Šã€‚

æ¥ä¸‹æ¥è®©æˆ‘ä»¬åšä¸€äº›å‹æµ‹ï¼Œçœ‹çœ‹kafkaç©¶ç«Ÿå¤šä¹ˆç‰›é€¼ã€‚

# Kafka in 30 seconds

ä¸ºäº†å¸®åŠ©ç†è§£æ¥ä¸‹æ¥çš„å‹æµ‹ï¼Œé¦–å…ˆè®©æˆ‘ä»¬å¤§æ¦‚äº†è§£ä¸€ä¸‹kafkaæ˜¯ä»€ä¹ˆï¼Œä»¥åŠä¸€äº›kafkaå·¥ä½œçš„ç»†èŠ‚ã€‚kafkaæ˜¯LinkedInå¼€å‘ä¸€ä¸ªåˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼Œç°åœ¨æ˜¯ [Apache Software Foundation](https://www.apache.org/)çš„æˆå‘˜ä¹‹ä¸€ï¼Œå¹¶ä¸”éå¸¸å¤šçš„å…¬å¸åœ¨ä½¿ç”¨kafkaã€‚

ç”Ÿäº§è€…å°†è®°å½•å‘é€åˆ°kafkaé›†ç¾¤ï¼Œé›†ç¾¤ä¿ç•™è¿™äº›è®°å½•å¹¶å°†å…¶äº¤ç»™æ¶ˆè´¹è€…ï¼›



![01-producer_consumer.png](https:////upload-images.jianshu.io/upload_images/6918995-d66fe82a7fc097e8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/639/format/webp)



kafkaä¸€ä¸ªæœ€æ ¸å¿ƒçš„æ¦‚å¿µå°±æ˜¯topicï¼ˆç¬”è€…åœ¨è¿™é‡Œå¹¶ä¸æ‰“ç®—ç¿»è¯‘å®ƒï¼Œæ— è®ºç¿»è¯‘æˆä»€ä¹ˆéƒ½è§‰å¾—å˜å‘³äº†ï¼‰ã€‚ç”Ÿäº§è€…å‘å¸ƒè®°å½•åˆ°topicï¼Œæ¶ˆè´¹è€…è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªtopicã€‚kafkaçš„topicå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªåˆ†åŒºåçš„write-ahead logã€‚ç”Ÿäº§è€…æŠŠéœ€è¦å‘å¸ƒçš„è®°å½•è¿½åŠ åˆ°è¿™äº›æ—¥å¿—åé¢ã€‚æ¶ˆè´¹è€…è®¢é˜…å®ƒä»¬ã€‚æ¯ä¸€ä¸ªè®°å½•éƒ½æ˜¯ä¸€ä¸ªK-Vå¯¹ï¼Œkeyä¸»è¦ç”¨äºåˆ†é…è®°å½•åˆ°æ—¥å¿—åˆ†åŒºã€‚

ä¸‹å›¾æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å›¾ï¼Œç”Ÿäº§è€…å¦‚ä½•å†™è®°å½•åˆ°ä¸€ä¸ªæ‹¥æœ‰ä¸¤ä¸ªåˆ†åŒºçš„topicï¼Œä»¥åŠæ¶ˆè´¹è€…å¦‚ä½•è¯»è¿™ä¸ªtopic:



![02-partitioned_log_0.png](https:////upload-images.jianshu.io/upload_images/6918995-3c3fed6c69235401.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/943/format/webp)



ä¸Šå›¾å±•ç¤ºäº†ç”Ÿäº§è€…å¦‚ä½•è¿½åŠ æ—¥å¿—åˆ°ä¸¤ä¸ªåˆ†åŒºï¼Œä»¥åŠæ¶ˆè´¹è€…è¯»å–æ—¥å¿—ã€‚æ—¥å¿—ä¸­æ¯æ¡è®°å½•éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„æ¡ç›®ç¼–å·ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º**offset**ã€‚æ¶ˆè´¹è€…ä½¿ç”¨offsetæ¥æè¿°å…¶åœ¨æ¯ä¸ªæ—¥å¿—ä¸­çš„ä½ç½®ã€‚

è¿™äº›åˆ†åŒºåˆ†åŒºåœ¨é›†ç¾¤çš„å„ä¸ªæœåŠ¡å™¨ä¸Šã€‚

éœ€è¦æ³¨æ„kafkaä¸å¾ˆå¤šæ¶ˆæ¯ç³»ç»Ÿä¸ä¸€æ ·ï¼Œå®ƒçš„æ—¥å¿—æ€»æ˜¯æŒä¹…åŒ–ï¼Œå½“æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šç«‹å³å†™åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚æ¶ˆè´¹è€…è¯»æ¶ˆæ¯æ—¶æ¶ˆæ¯å¹¶ä¸ä¼šè¢«åˆ é™¤ã€‚å®ƒçš„ä¿ç•™ç­–ç•¥é€šè¿‡é…ç½®æ¥å†³å®šã€‚è¿™å°±å…è®¸åœ¨æ•°æ®ä½¿ç”¨è€…å¯èƒ½éœ€è¦é‡æ–°åŠ è½½æ•°æ®çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚å¹¶ä¸”ä¹Ÿèƒ½èŠ‚çœç©ºé—´ï¼Œæ— è®ºå¤šå°‘æ¶ˆè´¹è€…ï¼Œæ—¥å¿—å…±äº«ä¸€ä»½ã€‚

ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿï¼Œå¸¸å¸¸ä¸€ä¸ªæ¶ˆè´¹è€…ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå› æ­¤å¢åŠ æ¶ˆè´¹è€…ï¼Œæ•°æ®ç©ºé—´å°±ä¼šæˆå€å¢åŠ ã€‚è¿™ä½¿å¾—Kafkaéå¸¸é€‚åˆæ™®é€šæ¶ˆæ¯ä¼ é€’ç³»ç»Ÿä¹‹å¤–çš„äº‹ç‰©ï¼Œä¾‹å¦‚å……å½“ç¦»çº¿æ•°æ®ç³»ç»Ÿï¼ˆå¦‚Hadoopï¼‰çš„ç®¡é“ã€‚ è¿™äº›ç¦»çº¿ç³»ç»Ÿå¯èƒ½ä»…ä½œä¸ºå‘¨æœŸæ€§ETLå‘¨æœŸçš„ä¸€éƒ¨åˆ†åœ¨ä¸€å®šæ—¶é—´é—´éš”åŠ è½½ï¼Œæˆ–è€…å¯èƒ½ä¼šåœæœºå‡ ä¸ªå°æ—¶è¿›è¡Œç»´æŠ¤ï¼Œåœ¨æ­¤æœŸé—´ï¼Œå¦‚æœéœ€è¦ï¼ŒKafkaèƒ½å¤Ÿç¼“å†²ç”šè‡³TBé‡çº§çš„æœªæ¶ˆè€—æ•°æ®ã€‚

kafkaä¹Ÿå¤åˆ¶æ—¥å¿—åˆ°å¤šå°æœåŠ¡å™¨ä¸Šï¼Œä¸ºäº†å®¹é”™ã€‚å¤åˆ¶å®ç°æ˜¯kafkaä¸€ä¸ªéå¸¸é‡è¦çš„æ¶æ„ç‰¹æ€§ã€‚å’Œå…¶ä»–æ¶ˆæ¯ç³»ç»Ÿç›¸æ¯”ï¼Œå¤åˆ¶ä¸æ˜¯ä¸€ç§éœ€è¦å¤æ‚é…ç½®çš„å¼‚ä¹å¯»å¸¸çš„æ’ä»¶ï¼Œåªèƒ½åœ¨éå¸¸ç‰¹æ®Šçš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ ç›¸åï¼Œkafkaçš„æ¶æ„å¤åˆ¶è¢«å‡å®šä¸ºé»˜è®¤å€¼ï¼šæˆ‘ä»¬å°†æœªå¤åˆ¶çš„æ•°æ®è§†ä¸ºå¤åˆ¶å› å­æ°å¥½ä¸º1çš„ç‰¹æ®Šæƒ…å†µã€‚

ç”Ÿäº§è€…åœ¨å‘å¸ƒåŒ…å«è®°å½•åç§»é‡çš„æ¶ˆæ¯æ—¶ä¼šæ”¶åˆ°ç¡®è®¤ã€‚å‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºçš„ç¬¬ä¸€æ¡è®°å½•åˆ†é…çš„offsetä¸º0ï¼Œç¬¬äºŒæ¡æ˜¯1ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ¶ˆè´¹è€…é€šè¿‡offsetæŒ‡å®šçš„ä½ç½®æ¶ˆè´¹æ•°æ®ï¼Œå¹¶ä¸”æ¶ˆè´¹è€…é€šè¿‡å‘¨æœŸæ€§çš„æäº¤topicï¼ˆåä¸º`__consumer_offsets`ï¼‰ä»è€Œä¿å­˜ä»£è¡¨æ¶ˆæ¯ä½ç½®çš„offsetåˆ°æ—¥å¿—ä¸­ï¼Œè¾¾åˆ°æŒä¹…åŒ–çš„ç›®æ ‡ã€‚ä¿å­˜è¿™ä¸ªoffsetçš„ç›®çš„æ˜¯ä¸ºäº†æ¶ˆè´¹è€…å´©æºƒåï¼Œå…¶ä»–æ¶ˆè´¹è€…èƒ½ä»ä¿å­˜çš„ä½ç½®ç»§ç»­æ¶ˆè´¹æ¶ˆæ¯ã€‚

kafkaç®€å•ä»‹ç»åˆ°æ­¤ä¸ºæ­¢ï¼Œç³»ç»Ÿè¿™ä¸€åˆ‡éƒ½æœ‰æ„ä¹‰ã€‚

# This Benchmark

å¯¹äºæ­¤æ¬¡åŸºå‡†æµ‹è¯•ï¼Œæˆ‘å–œæ¬¢éµå¾ªæˆ‘ç§°ä¹‹ä¸ºâ€œæ‡’æƒ°åŸºå‡†æµ‹è¯•ï¼ˆlazy benchmarkingï¼‰â€çš„é£æ ¼ã€‚å½“æ‚¨ä½¿ç”¨ç³»ç»Ÿæ—¶ï¼Œæ‚¨é€šå¸¸æ‹¥æœ‰å°†å…¶è°ƒæ•´åˆ°ä»»ä½•ç‰¹å®šç”¨ä¾‹çš„å®Œç¾çš„ä¸“æœ‰æŠ€æœ¯ã€‚è¿™å¯¼è‡´äº†ä¸€ç§åŸºå‡†æµ‹è¯•ï¼Œæ‚¨å¯ä»¥å°†é…ç½®å¤§å¹…è°ƒæ•´åˆ°åŸºå‡†æµ‹è¯•ï¼Œæˆ–è€…æ›´ç³Ÿç³•çš„æ˜¯é’ˆå¯¹æ‚¨æµ‹è¯•çš„æ¯ä¸ªåœºæ™¯è¿›è¡Œä¸åŒçš„è°ƒæ•´ã€‚æˆ‘è®¤ä¸ºç³»ç»Ÿçš„çœŸæ­£æµ‹è¯•ä¸æ˜¯å®ƒåœ¨å®Œç¾è°ƒæ•´æ—¶çš„è¡¨ç°ï¼Œè€Œæ˜¯å®ƒå¦‚ä½•â€œç°æˆâ€æ‰§è¡Œã€‚å¯¹äºåœ¨å…·æœ‰æ•°åä¸ªæˆ–æ•°ç™¾ä¸ªç”¨ä¾‹çš„å¤šç§Ÿæˆ·è®¾ç½®ä¸­è¿è¡Œçš„ç³»ç»Ÿå°¤å…¶å¦‚æ­¤ï¼Œå…¶ä¸­é’ˆå¯¹æ¯ä¸ªç”¨ä¾‹çš„è°ƒä¼˜ä¸ä»…ä¸åˆ‡å®é™…è€Œä¸”ä¸å¯èƒ½ã€‚å› æ­¤ï¼Œæˆ‘å‡ ä¹åšæŒä½¿ç”¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„é»˜è®¤è®¾ç½®ã€‚æˆ‘å°†æŒ‡å‡ºæˆ‘æ€€ç–‘é€šè¿‡ä¸€ç‚¹è°ƒæ•´å¯ä»¥æ”¹å–„ç»“æœçš„åŒºåŸŸï¼Œä½†æˆ‘è¯•å›¾æŠµåˆ¶ä»»ä½•æ‘†å¼„è‡ªå·±ä»¥æ”¹å–„ç»“æœçš„è¯±æƒ‘ã€‚

é…ç½®å’Œå‹æµ‹å‘½ä»¤æ–‡æœ«ä¼šè´´å‡ºæ¥ï¼Œæ‰€ä»¥å¦‚æœä½ æ„Ÿå…´è¶£çš„è¯ï¼Œåœ¨ä½ ä»¬çš„æœåŠ¡å™¨ä¸Šä¹Ÿèƒ½é‡ç°æœ¬æ–‡çš„å‹æµ‹ç»“æœã€‚

# The Setup

æœ¬æ¬¡æµ‹è¯•ï¼Œæ€»è®¡6å°æœåŠ¡å™¨ï¼Œé…ç½®å¦‚ä¸‹ï¼š

- Intel Xeon 2.5 GHz processor with six cores
- Six 7200 RPM SATA drives
- 32GB of RAM
- 1Gb Ethernet

kafkaé›†ç¾¤å®‰è£…åœ¨å…¶ä¸­çš„3å°æœåŠ¡å™¨ä¸Šï¼Œ6å—ç¡¬ç›˜ç›´æ¥æŒ‚è½½ï¼Œæ²¡æœ‰RAIDã€‚å¦å¤–ä¸‰å°æœåŠ¡å™¨ç”¨äºZookeeperå’Œå‹åŠ›æµ‹è¯•ã€‚

3å°æœåŠ¡å™¨çš„é›†ç¾¤ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬åªæµ‹è¯•å¤åˆ¶å› å­ä¸º3ï¼Œæ‰€ä»¥ä¸‰å°æœåŠ¡å™¨é›†ç¾¤è¶³å¤Ÿã€‚æ˜¾è€Œæ˜“è§çš„æ˜¯ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡å¢åŠ æ›´å¤šçš„åˆ†åŒºï¼Œä¼ æ’­æ•°æ®åˆ°æ›´å¤šçš„æœåŠ¡å™¨ä¸Šæ¥æ°´å¹³æ‰©å±•æˆ‘ä»¬çš„é›†ç¾¤ã€‚

è¿™äº›ç¡¬ä»¶ä¸æ˜¯LinkedInå¹³å¸¸ä½¿ç”¨çš„kafkaç¡¬ä»¶ã€‚æˆ‘ä»¬çš„kafkaæœåŠ¡å™¨æœ‰é’ˆå¯¹æ€§çš„è°ƒä¼˜ï¼Œèƒ½æ›´å¥½çš„è¿è¡Œçš„è¿è¡Œkafkaã€‚è¿™æ¬¡æµ‹è¯•ï¼Œæˆ‘ä»Hadoopé›†ç¾¤ä¸­å€Ÿç”¨äº†è¿™å‡ å°æœåŠ¡å™¨ï¼Œè¿™äº›æœåŠ¡å™¨éƒ½æ˜¯æˆ‘ä»¬æŒä¹…åŒ–ç³»ç»Ÿä¸­æœ€ä¾¿å®œçš„è®¾å¤‡ã€‚ Hadoopçš„ä½¿ç”¨æ¨¡å¼ä¸Kafkaéå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä»¶åˆç†çš„äº‹æƒ…ã€‚

# Producer Throughput

æ¥ä¸‹æ¥çš„æµ‹è¯•æ˜¯å‹æµ‹ç”Ÿäº§è€…çš„ååé‡ï¼Œæµ‹è¯•è¿‡ç¨‹ä¸­æ²¡æœ‰æ¶ˆè´¹è€…è¿è¡Œï¼Œå› æ­¤æ‰€æœ‰æ¶ˆæ¯è¢«æŒä¹…åŒ–ï¼ˆç¨åä¼šæµ‹è¯•ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½å­˜åœ¨çš„åœºæ™¯ï¼‰ï¼Œä½†æ˜¯æ²¡æœ‰è¢«è¯»å–ã€‚

## Single producer thread, no replication

- 821,557 records/sec
- 78.3 MB/sec

è¿™ç¬¬ä¸€ä¸ªæµ‹è¯•åŸºäºçš„topicï¼š6ä¸ªåˆ†åŒºï¼Œæ²¡æœ‰å‰¯æœ¬ã€‚ç„¶åå•çº¿ç¨‹å°½å¯èƒ½å¿«çš„äº§ç”Ÿ5åƒä¸‡ä¸ªå°è®°å½•ï¼ˆ100byteï¼‰ã€‚åœ¨è¿™äº›æµ‹è¯•ä¸­å…³æ³¨å°è®°å½•çš„åŸå› æ˜¯å®ƒå¯¹äºæ¶ˆæ¯ç³»ç»Ÿæ¥è¯´æ˜¯æ›´éš¾çš„æƒ…å†µã€‚å¦‚æœæ¶ˆæ¯å¾ˆå¤§ï¼Œå¾ˆå®¹æ˜“ä»¥MB/ç§’è·å¾—è‰¯å¥½çš„ååé‡ï¼Œä½†æ˜¯å½“æ¶ˆæ¯å¾ˆå°æ—¶åè€Œå¾ˆéš¾è·å¾—è‰¯å¥½çš„ååé‡ï¼Œå› ä¸ºå¤„ç†æ¯ä¸ªæ¶ˆæ¯çš„å¼€é”€å ä¸»å¯¼åœ°ä½ã€‚

ä¸€ä¸ªç›´æ¥çš„è§‚å¯Ÿæ˜¯ï¼Œè¿™é‡Œçš„å‹æµ‹æ•°æ®è¿œé«˜äºäººä»¬çš„é¢„æœŸï¼Œç‰¹åˆ«æ˜¯å¯¹äºæŒä¹…å­˜å‚¨ç³»ç»Ÿã€‚ å¦‚æœæ‚¨ä¹ æƒ¯äºéšæœºè®¿é—®æ•°æ®ç³»ç»Ÿï¼ˆå¦‚æ•°æ®åº“æˆ–é”®å€¼å­˜å‚¨ï¼‰ï¼Œé€šå¸¸ä¼šäº§ç”Ÿå¤§çº¦5,000åˆ°50,000æ¬¡æŸ¥è¯¢çš„æœ€å¤§ååé‡ï¼Œè¿™æ¥è¿‘äºè‰¯å¥½çš„RPCå±‚å¯ä»¥æ‰§è¡Œçš„é€Ÿåº¦è¿œç¨‹è¯·æ±‚ã€‚ ç”±äºä¸¤ä¸ªå…³é”®è®¾è®¡åŸåˆ™ï¼Œæˆ‘ä»¬è¶…è¿‡äº†è¿™ä¸€ç‚¹ï¼š

1.  **æˆ‘ä»¬åŠªåŠ›ç¡®ä¿æˆ‘ä»¬è¿›è¡Œçº¿æ€§ç£ç›˜I/O**ã€‚è¿™äº›æœåŠ¡å™¨æä¾›çš„å…­å—å»‰ä»·ç£ç›˜çš„çº¿æ€§æ€»ååé‡ä¸º822 MB /ç§’ã€‚è®¸å¤šæ¶ˆæ¯ç³»ç»Ÿå°†æŒä¹…æ€§è§†ä¸ºæ˜‚è´µçš„é™„åŠ ç»„ä»¶ï¼Œè®¤ä¸ºå…¶ä¼šé™ä½æ€§èƒ½å¹¶ä¸”åº”è¯¥è°¨æ…ä½¿ç”¨ï¼Œä½†è¿™æ˜¯å› ä¸ºå®ƒä»¬æ²¡æœ‰è¿›è¡Œçº¿æ€§I/O.
2.  **åœ¨æ¯ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬éƒ½è‡´åŠ›äºå°†å°‘é‡æ•°æ®æ‰¹é‡åˆå¹¶åˆ°æ›´å¤§çš„ç½‘ç»œå’Œç£ç›˜I/Oæ“ä½œä¸­**ã€‚ ä¾‹å¦‚ï¼Œåœ¨æ–°ç”Ÿäº§è€…ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨â€œgroup commitâ€ç±»ä¼¼çš„æœºåˆ¶æ¥ç¡®ä¿åœ¨å¦ä¸€ä¸ªI/Oæ­£åœ¨è¿›è¡Œä¸­æ—¶å‘èµ·çš„ä»»ä½•è®°å½•è¢«ç»„åˆåœ¨ä¸€èµ·ã€‚ æœ‰å…³äº†è§£æ‰¹å¤„ç†é‡è¦æ€§çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…David Pattersonå†™çš„"Latency Lags Bandwidth"ã€‚

## Single producer thread, 3x async replication

- 786,980 records/sec
- 75.1 MB/sec

è¿™æ¬¡æµ‹è¯•å’Œå‰ä¸€æ¬¡çš„æµ‹è¯•å‡ ä¹ä¸€æ ·ï¼Œé™¤äº†æ¯ä¸ªåˆ†åŒºæœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼ˆå› æ­¤å†™åˆ°ç½‘ç»œæˆ–è€…ç£ç›˜çš„æ•°æ®æ˜¯å‰ä¸€æ¬¡çš„ä¸‰å€ï¼‰ã€‚æ¯ä¸ªæœåŠ¡å™¨éƒ½ä»ç”Ÿäº§è€…é‚£é‡Œä¸ºå®ƒä½œä¸ºleaderåˆ†åŒºæ‰§è¡Œå†™æ“ä½œï¼Œä»¥åŠä¸ºå…¶ä½œä¸ºfolloweråˆ†åŒºè·å–å’Œå†™å…¥æ•°æ®ã€‚

æœ¬æ¬¡æµ‹è¯•çš„å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œå³acks=0ã€‚æ¶ˆæ¯åªè¦å†™åˆ°æœ¬åœ°æ—¥å¿—å³å¯ï¼Œä¸éœ€è¦ç­‰å¾…è¿™ä¸ªåˆ†åŒºçš„å…¶ä»–å‰¯æœ¬æ”¶åˆ°æ¶ˆæ¯ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœleaderå´©æºƒï¼Œå¯èƒ½ä¼šä¸¢å¤±æœ€æ–°çš„ä¸€äº›è¿˜æœªåŒæ­¥åˆ°å‰¯æœ¬çš„æ¶ˆæ¯ã€‚

æˆ‘å¸Œæœ›äººä»¬èƒ½ä»ä¸­å¾—åˆ°çš„å…³é”®æ˜¯å¤åˆ¶å¯ä»¥æ›´å¿«ã€‚å¯¹åº”3xå¤åˆ¶ï¼Œé›†ç¾¤æ€»å†™å…¥èƒ½åŠ›æœ‰3å€çš„é€€åŒ–ï¼Œå› ä¸ºæ¯ä¸ªå†™æ“ä½œè¦åš3æ¬¡ã€‚ä½†æ˜¯æ¯ä¸ªå®¢æˆ·ç«¯çš„ååé‡ä¾ç„¶è¡¨ç°ä¸é”™ã€‚ é«˜æ€§èƒ½å¤åˆ¶åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæˆ‘ä»¬çš„æ¶ˆè´¹è€…çš„æ•ˆç‡ï¼Œåé¢ä¼šåœ¨æ¶ˆè´¹è€…éƒ¨åˆ†è®¨è®ºã€‚

## Single producer thread, 3x sync replication

- 421,823 records/sec
- 40.2 MB/sec

æ­¤æ¬¡æµ‹è¯•å’Œå‰é¢çš„æµ‹è¯•ä¸€æ ·ï¼Œé™¤äº†leaderéœ€è¦ç­‰å¾…æ‰€æœ‰in-sync replicasç¡®è®¤æ”¶åˆ°æ¶ˆæ¯æ‰ä¼šè¿”å›ç»“æœç»™ç”Ÿäº§è€…ã€‚å³acks=allæˆ–è€…acks=-1ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œåªè¦æœ‰ä¸€ä¸ªin-sync replicaå­˜åœ¨ï¼Œæ¶ˆæ¯å°±ä¸ä¼šä¸¢å¤±ã€‚

Kafkaä¸­çš„åŒæ­¥å¤åˆ¶ä¸å¼‚æ­¥å¤åˆ¶æ²¡æœ‰æ ¹æœ¬çš„ä¸åŒã€‚åˆ†åŒºleaderæ€»æ˜¯è·Ÿè¸ªfollowerå‰¯æœ¬è¿›åº¦ï¼Œç›‘æ§å®ƒä»¬æ˜¯å¦å­˜åœ¨ã€‚åœ¨æ‰€æœ‰in-sync replicasç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šå‘æ¶ˆè´¹è€…å‘å‡ºæ¶ˆæ¯ã€‚ä½¿ç”¨åŒæ­¥å¤åˆ¶ï¼Œæˆ‘ä»¬è¦ç­‰å¾…å“åº”ç»™ç”Ÿäº§è€…çš„è¯·æ±‚ï¼Œç›´åˆ°followerå‰¯æœ¬éƒ½å·²ç»å¤åˆ¶ã€‚

è¿™ç§é¢å¤–çš„å»¶è¿Ÿä¼¼ä¹ä¼šå½±å“æˆ‘ä»¬çš„ååé‡ã€‚ç”±äºæœåŠ¡å™¨ä¸Šçš„ä»£ç è·¯å¾„éå¸¸ç›¸ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´æ‰¹å¤„ç†æ¥æ›´å¥½åœ°æ”¹å–„è¿™ç§å½±å“ï¼Œå¹¶å…è®¸å®¢æˆ·ç«¯ç¼“å†²æ›´å¤šæœªå®Œæˆçš„è¯·æ±‚ã€‚ ä½†æ˜¯ï¼Œæœ¬ç€é¿å…ç‰¹æ®Šæƒ…å†µè°ƒæ•´çš„åŸåˆ™ï¼Œæˆ‘æ²¡æœ‰è¿™ä¹ˆåšã€‚

## Three producers, 3x async replication

- 2,024,032 records/sec
- 193.0 MB/sec

æˆ‘ä»¬çš„å•ä¸€ç”Ÿäº§è€…å¤„ç†æ˜¾ç„¶ä¸èƒ½å‹å‡ºä¸‰èŠ‚ç‚¹é›†ç¾¤çš„èƒ½åŠ›ä¸Šé™ã€‚ä¸ºäº†å¢åŠ è´Ÿè½½ï¼Œé‡å¤å‰é¢çš„å¼‚æ­¥å¤åˆ¶æ¨¡å¼æµ‹è¯•æµç¨‹ï¼Œä½†æ˜¯åœ¨ä¸‰å°ä¸åŒæœåŠ¡å™¨ä¸Šè¿è¡Œä¸‰ä¸ªä¸åŒçš„ç”Ÿäº§è€…ï¼ˆåœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œæ›´å¤šè¿›ç¨‹å°†æ— åŠ©äºæˆ‘ä»¬ä½¿NICé¥±å’Œï¼‰ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹è¿™ä¸‰ä¸ªç”Ÿäº§è€…çš„æ€»ååé‡ï¼Œä»¥æ›´å¥½åœ°äº†è§£ç¾¤é›†çš„æ€»å®¹é‡ã€‚

## Producer Throughput VS. Stored Data

è®¸å¤šæ¶ˆæ¯ç³»ç»Ÿä¸€ä¸ªéšè—çš„å±é™©æ˜¯ï¼Œåªæœ‰åœ¨ä»–ä»¬ä¿å­˜çš„æ•°æ®åœ¨å†…å­˜ä¸­æ‰ä¼šå·¥ä½œçš„å¾ˆå¥½ã€‚å½“æ•°æ®å¤‡ä»½ä¸èƒ½è¢«æ¶ˆè´¹æ—¶ï¼ˆæ•°æ®å°±éœ€è¦å­˜å‚¨åˆ°ç£ç›˜ä¸Šï¼‰ï¼Œååé‡ä¼šä¸‹é™å‡ ä¸ªç­‰çº§ï¼Œç”šè‡³æ›´å¤šã€‚è¿™å°±æ„å‘³ç€åªæœ‰åœ¨æ¶ˆè´¹è€…é€Ÿåº¦èƒ½è·Ÿä¸Šç”Ÿäº§è€…ï¼Œå¹¶ä¸”é˜Ÿåˆ—æ˜¯ç©ºçš„æƒ…å†µä¸‹ç³»ç»Ÿæ‰ä¼šè¿è¡Œè‰¯å¥½ã€‚ä¸€æ—¦æ¶ˆè´¹è€…è½åï¼Œæ²¡æœ‰æ¶ˆè´¹çš„æ¶ˆæ¯éœ€è¦å¤‡ä»½ï¼Œå¤‡ä»½å¯èƒ½ä¼šä½¿æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œè¿™å°±ä¼šå¼•èµ·æ€§èƒ½å¤§å¹…ä¸‹é™ã€‚è¿™æ„å‘³ç€æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿæ— æ³•è·Ÿä¸Šä¼ å…¥çš„æ•°æ®ã€‚è¿™ç§æƒ…å†µéå¸¸ä¸¥é‡ï¼Œæ¶ˆæ¯ç³»ç»Ÿåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåº”è¯¥èƒ½åšåˆ°å¹³å’Œçš„å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚

kafkaæ€»æ˜¯é‡‡ç”¨è¿½åŠ çš„æ–¹å¼æŒä¹…åŒ–æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯¹äºæ²¡æœ‰æ¶ˆè´¹çš„æ•°æ®ï¼ŒæŒä¹…åŒ–çš„çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ã€‚

è¿™æ¬¡å®éªŒæµ‹è¯•ï¼Œè®©æˆ‘ä»¬åœ¨ä¸€æ®µå»¶é•¿çš„æ—¶é—´å†…è¿è¡Œååé‡æµ‹è¯•ï¼Œå¹¶åœ¨å­˜å‚¨çš„æ•°æ®é›†å¢é•¿æ—¶ç»˜åˆ¶ç»“æœå›¾ï¼š



![03-throughput_vs_size_0.png](https:////upload-images.jianshu.io/upload_images/6918995-2c54d8582664947d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



å¦‚å›¾æ‰€ç¤ºï¼Œæ€§èƒ½å¹¶æ²¡æœ‰æ˜æ˜¾çš„å˜åŒ–ã€‚ä½†æ˜¯ç”±äºæ•°æ®å¤§å°æ‰€ä»¥æ²¡æœ‰å½±å“ï¼šæˆ‘ä»¬åœ¨å†™å…¥TBæ•°æ®ä¹‹åä¹Ÿè¡¨ç°å¾—åŒæ ·å¥½ï¼Œå°±åƒå‰å‡ ç™¾MBä¸€æ ·ã€‚

å›¾ä¸­çš„æ€§èƒ½æ³¢åŠ¨ä¸»è¦æ˜¯å› ä¸ºLinuxç³»ç»ŸI/Oç®¡ç†æ‰¹é‡å¤„ç†æ•°æ®ï¼Œå‘¨æœŸæ€§çš„æŠŠæ•°æ®flushåˆ°ç£ç›˜ã€‚LinkedInçš„kafkaç”Ÿäº§ç¯å¢ƒä¸Šé’ˆå¯¹è¿™ä¸ªæœ‰ä¸€äº›è°ƒä¼˜ã€‚å¯ä»¥å‚è€ƒ[kafka Hardware and OS](http://kafka.apache.org/documentation.html#hwandos)ã€‚

# Consumer Throughput

OKï¼Œç°åœ¨è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›è½¬ç§»åˆ°æ¶ˆè´¹è€…ååé‡ä¸Šæ¥ã€‚

è¯·æ³¨æ„ï¼Œå¤åˆ¶å› å­ä¸ä¼šå½±å“æ­¤æµ‹è¯•çš„ç»“æœã€‚å› ä¸ºä¸ç®¡å¤åˆ¶å› å­å¦‚ä½•ï¼Œæ¶ˆè´¹è€…åªèƒ½ä»ä¸€ä¸ªå‰¯æœ¬è¯»å–ã€‚ åŒæ ·ï¼Œç”Ÿäº§è€…çš„ç¡®è®¤çº§åˆ«ï¼ˆackså‚æ•°ï¼‰ä¹Ÿæ— å…³ç´§è¦ï¼Œå› ä¸ºæ¶ˆè´¹è€…åªè¯»å–å®Œå…¨ç¡®è®¤çš„æ¶ˆæ¯ï¼ˆæ‰€æœ‰In-Sync Replicaséƒ½å·²ç»åŒæ­¥çš„æ¶ˆæ¯æ‰èƒ½è¢«æ¶ˆè´¹ï¼‰ã€‚ è¿™æ˜¯ä¸ºäº†ç¡®ä¿æ¶ˆè´¹è€…çœ‹åˆ°çš„ä»»ä½•æ¶ˆæ¯åœ¨leaderåˆ‡æ¢åå§‹ç»ˆå­˜åœ¨ï¼ˆå¦‚æœå½“å‰leaderå‘ç”Ÿå¼‚å¸¸éœ€è¦é‡æ–°é€‰ä¸¾æ–°çš„leaderçš„è¯ï¼‰ã€‚

## Single Consumer

- 940,521 records/sec
- 89.7 MB/sec

ç¬¬ä¸€æ¬¡æµ‹è¯•ï¼šå°†åœ¨æœ‰6ä¸ªåˆ†åŒºï¼Œ3ä¸ªå‰¯æœ¬çš„topicä¸­å•çº¿ç¨‹æ¶ˆè´¹5åƒä¸‡æ¡æ¶ˆæ¯ã€‚

kafkaæ¶ˆè´¹è€…æ•ˆç‡å¾ˆé«˜ï¼Œå®ƒç›´æ¥ä»linuxæ–‡ä»¶ç³»ç»Ÿä¸­æŠ“å–æ—¥å¿—å—ã€‚å®ƒé€šè¿‡sendfileè¿™ä¸ªAPIï¼Œç›´æ¥é€šè¿‡æ“ä½œç³»ç»Ÿä¼ è¾“æ•°æ®ï¼Œæ‰€ä»¥æ²¡æœ‰é€šè¿‡åº”ç”¨ç¨‹åºå¤åˆ¶æ­¤æ•°æ®çš„å¼€é”€ã€‚

æœ¬æ¬¡æµ‹è¯•å®é™…ä¸Šä»æ—¥å¿—åˆå§‹ä½ç½®å¼€å§‹ï¼Œå› æ­¤å®ƒåœ¨åšçœŸæ­£çš„è¯»I/Oã€‚ä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ¶ˆè´¹è€…å‡ ä¹å®Œå…¨ä»OSé¡µé¢ç¼“å­˜ä¸­è¯»å–ï¼Œå› ä¸ºå®ƒæ­£åœ¨è¯»å–åˆšåˆšç”±æŸä¸ªç”Ÿäº§è€…äº§ç”Ÿçš„æ•°æ®ï¼ˆè¿™äº›æ•°æ®ä»ç„¶åœ¨ç¼“å­˜ä¸­ï¼‰ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæ‚¨åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šè¿è¡Œç›¸å…³å‘½ä»¤æŸ¥çœ‹I/O statï¼Œä¼šçœ‹åˆ°æ¶ˆè€—å¤§é‡æ•°æ®è¢«æ¶ˆè´¹ï¼Œä¹Ÿæ ¹æœ¬æ²¡æœ‰ç‰©ç†è¯»å–ã€‚

è®©æ¶ˆè´¹è€…å°½å¯èƒ½cheapï¼Œæ˜¯æˆ‘ä»¬å¸Œæœ›kafkaåšçš„ä¸€ä»¶éå¸¸é‡è¦çš„äº‹æƒ…ã€‚é¦–å…ˆï¼Œå‰¯æœ¬ä¹Ÿæ˜¯æ¶ˆè´¹è€…ã€‚æ‰€ä»¥ï¼Œè®©æ¶ˆè´¹è€…cheapï¼Œå‰¯æœ¬ä¹Ÿä¼šcheapã€‚å…¶æ¬¡ï¼Œè¿™æ ·ä¼šæ˜¯å¤„ç†æ•°æ®ä¸æ˜¯éå¸¸æ˜‚è´µçš„æ“ä½œã€‚å› æ­¤å‡ºäºå¯ä¼¸ç¼©æ€§çš„åŸå› ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸¥æ ¼æ§åˆ¶ã€‚

> cheapå­—é¢å«ä¹‰æ˜¯ä¾¿å®œï¼Œä½†æ˜¯åœ¨è¿™é‡Œçš„å«ä¹‰ï¼Œæˆ‘è§‰å¾—æ˜¯ä¸šåŠ¡é€»è¾‘ä¸è¦å¤ªå¤æ‚ã€‚

## Three Consumers

- 2,615,968 records/sec
- 249.5 MB/sec

é‡å¤ä¸Šé¢ç›¸åŒçš„æµ‹è¯•ï¼Œä¸åŒçš„æ˜¯æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…å¹¶è¡Œå¤„ç†ã€‚ä¸‰ä¸ªæ¶ˆè´¹è€…åˆ†å¸ƒåœ¨ä¸‰å°ä¸åŒæœåŠ¡å™¨ä¸Šã€‚è¿™ä¸‰ä¸ªæ¶ˆè´¹è€…å±äºåŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­çš„æˆå‘˜ï¼Œå³å®ƒä»¬æ¶ˆè´¹åŒæ ·çš„topicã€‚

å’Œæˆ‘ä»¬é¢„æœŸä¸€æ ·ï¼Œæˆ‘ä»¬çœ‹åˆ°æ¶ˆè´¹èƒ½åŠ›çº¿æ€§æ‰©å±•ï¼Œå‡ ä¹å°±æ˜¯å•ä¸ªæ¶ˆè´¹è€…ååé‡çš„3å€ï¼Œè¿™ä¸€ç‚¹éƒ½ä¸ä»¤äººæƒŠè®¶ã€‚

## Producer and Consumer

- 795,064 records/sec
- 75.8 MB/sec

ä¸Šé¢çš„æµ‹è¯•ä»…é™äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¿è¡Œåœ¨ä¸åŒæœåŠ¡å™¨ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æŠŠç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¿è¡Œåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯è¿™æ ·åšçš„ï¼Œå› ä¸ºè¿™æ ·çš„è¯ï¼Œå¤åˆ¶å·¥ä½œå°±æ˜¯è®©æœåŠ¡å™¨æœ¬èº«å……å½“æ¶ˆè´¹è€…ã€‚

å¯¹äºæ­¤æ¬¡æµ‹è¯•ï¼Œæˆ‘ä»¬å°†åŸºäº6ä¸ªåˆ†åŒºï¼Œ3ä¸ªå‰¯æœ¬çš„topicï¼Œåˆ†åˆ«è¿è¡Œ1ä¸ªç”Ÿäº§è€…å’Œ1ä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶ä¸”topicåˆå§‹ä¸ºç©ºã€‚ ç”Ÿäº§è€…å†æ¬¡ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ã€‚ æŠ¥å‘Šçš„ååé‡æ˜¯æ¶ˆè´¹è€…ååé‡ï¼ˆæ˜¾ç„¶ï¼Œæ˜¯ç”Ÿäº§è€…ååé‡çš„ä¸Šé™ï¼‰ã€‚

å’Œæˆ‘ä»¬é¢„æœŸä¸€æ ·ï¼Œå¾—åˆ°çš„ç»“æœå’Œåªæœ‰ç”Ÿäº§è€…æ—¶åŸºæœ¬ç›¸åŒï¼Œå‰ææ˜¯æ¶ˆè´¹è€…ç›¸å½“cheapã€‚

# Effect of Message Size

å‰é¢çš„æµ‹è¯•å·²ç»å±•ç¤ºäº†100å­—èŠ‚å¤§å°æ¶ˆæ¯kafkaçš„æ€§èƒ½ã€‚å¯¹äºæ¶ˆè´¹ç³»ç»Ÿæ¥è¯´ï¼Œæ›´å°çš„æ¶ˆæ¯æ˜¯æ›´å¤§çš„é—®é¢˜ã€‚å› ä¸ºå®ƒä»¬æ”¾å¤§äº†ç³»ç»Ÿè®°è´¦çš„å¼€é”€ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è®°å½•/ç§’å’ŒMB/ç§’ä¸¤è€…ä¸­ç»˜åˆ¶ååé‡æ¥æ˜¾ç¤ºè¿™ä¸€ç‚¹ï¼š



![04-size_vs_record_throughput.png](https:////upload-images.jianshu.io/upload_images/6918995-98bcb0b5dcbbd319.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



è¿™å¼ å›¾å’Œæˆ‘ä»¬é¢„æœŸä¸€æ ·ï¼Œéšç€æ¶ˆæ¯ä½“è¶Šæ¥è¶Šå¤§ï¼Œæ¯ç§’æˆ‘ä»¬èƒ½å‘é€çš„æ¶ˆæ¯æ•°é‡ä¹Ÿä¼šå‡å°‘ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çœ‹MB/ç§’æ€§èƒ½æŠ¥å‘Šï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å®é™…ç”¨æˆ·æ•°æ®çš„æ€»å­—èŠ‚ååé‡éšç€æ¶ˆæ¯å˜å¤§è€Œå¢åŠ ï¼š



![05-size_vs_mb_throughput.png](https:////upload-images.jianshu.io/upload_images/6918995-f6c2cbdcd8c64c97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)



> æ€»ç»“ï¼šæ¶ˆæ¯ä½“è¶Šå¤§ï¼Œæ¯ç§’èƒ½å¤„ç†çš„æ¶ˆæ¯æ•°é‡è¶Šå°‘ï¼Œä½†æ˜¯æ¯ç§’èƒ½å¤„ç†çš„æ¶ˆæ¯ä½“ç§¯è¶Šå¤§ï¼›æ¶ˆæ¯ä½“è¶Šå°ï¼Œæ¯ç§’èƒ½å¤„ç†çš„æ¶ˆæ¯æ•°é‡è¶Šå¤šï¼Œä½†æ˜¯æ¯ç§’èƒ½å¤„ç†çš„æ¶ˆæ¯ä½“ç§¯è¶Šå°ï¼›

å¦å¤–æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº10å­—èŠ‚çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å®é™…ä¸Šåªæ˜¯é€šè¿‡è·å–é”å¹¶å°†æ¶ˆæ¯æ’å…¥å‘é€æ¥é™åˆ¶CPU - æˆ‘ä»¬æ— æ³•å®é™…æœ€å¤§åŒ–ç½‘ç»œã€‚ ä½†æ˜¯ï¼Œä»100å­—èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬å®é™…ä¸Šçœ‹åˆ°ç½‘ç»œé¥±å’Œã€‚

# End-to-end Latency

- 2 ms (median)
- 3 ms (99th percentile)
- 14 ms (99.9th percentile)

åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬è®¨è®ºçš„éƒ½æ˜¯ååé‡ã€‚ä½†æ˜¯æ¶ˆæ¯ä¼ é€’çš„å»¶è¿Ÿæƒ…å†µå‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆæ¯ä¼ é€’åˆ°æ¶ˆè´¹è€…ï¼Œéœ€è¦å¤šé•¿çš„æ—¶é—´ã€‚æ­¤æ¬¡æµ‹è¯•ï¼Œæˆ‘ä»¬å°†åˆ›å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå¹¶é‡å¤è®¡ç®—ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°kafkaé›†ç¾¤ç„¶åç”±æˆ‘ä»¬çš„æ¶ˆè´¹è€…æ¥æ”¶æ‰€éœ€çš„æ—¶é—´ã€‚

è¯·æ³¨æ„ï¼ŒKafkaä»…åœ¨æ‰€æœ‰in-sync replicasç¡®è®¤æ¶ˆæ¯åæ‰å‘æ¶ˆè´¹è€…å‘å‡ºæ¶ˆæ¯ã€‚å› æ­¤ï¼Œæ— è®ºæˆ‘ä»¬ä½¿ç”¨åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œæ­¤æµ‹è¯•éƒ½ä¼šç»™å‡ºç›¸åŒçš„ç»“æœï¼Œå› ä¸ºè¯¥è®¾ç½®ä»…å½±å“å¯¹ç”Ÿäº§è€…çš„ç¡®è®¤ï¼Œè€Œæœ¬æ¬¡æµ‹è¯•æ˜¯ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ä¼ é€’åˆ°æ¶ˆè´¹è€…çš„æ—¶é—´ã€‚

# Replicating this test

å¦‚æœä½ æƒ³è¦åœ¨ä½ è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œè¿è¡Œè¿™äº›å‹åŠ›æµ‹è¯•ï¼Œå½“ç„¶æ²¡æœ‰é—®é¢˜ã€‚æ­£å¦‚æˆ‘æ‰€è¯´çš„ï¼Œæˆ‘å¤§éƒ¨åˆ†æƒ…å†µä¸‹åªæ˜¯ä½¿ç”¨æˆ‘ä»¬é¢„è£…çš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œè¿™äº›å·¥å…·éšKafkaå‘å¸ƒåŒ…ä¸€èµ·æä¾›ï¼Œå¹¶ä¸”æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¤§éƒ¨åˆ†éƒ½æ˜¯é»˜è®¤é…ç½®ã€‚

# attachment

ä¸‹é¢ç»™å‡ºæœ¬æ¬¡å‹æµ‹ä¸€äº›å‘½ä»¤ï¼Œä»¥åŠkafkaæœåŠ¡å™¨é…ç½®ã€‚

## benchmark commands

```Bash
 ###############################################################
å‹æµ‹è„šæœ¬ï¼ˆzké›†ç¾¤åœ°å€åçš„/afeiæ˜¯é…ç½®çš„chrootï¼‰:
--zookeeperï¼š10.0.1.1:2181,10.0.1.2:2181,10.0.1.2:2181/afei
--brokerï¼š   10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092
################################################################

åˆ›å»ºéœ€è¦çš„TOPICï¼š
bin/kafka-topics.sh --zookeeper 10.0.1.1:2181,10.0.1.2:2181,10.0.1.2:2181/afei --create --topic TPC-P6-R1 --partitions 6 --replication-factor 1
bin/kafka-topics.sh --zookeeper 10.0.1.1:2181,10.0.1.2:2181,10.0.1.2:2181/afei --create --topic TPC-P6-R3 --partitions 6 --replication-factor 3

1ä¸ªç”Ÿäº§è€…-å•çº¿ç¨‹&æ— å‰¯æœ¬ï¼š
bin/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance --topic TPC-P6-R1 --num-records 50000000 --record-size 128  --throughput -1 --producer-props acks=1 bootstrap.servers=10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092 buffer.memory=67108864 batch.size=8196

æ‰§è¡Œè„šæœ¬è¯´æ˜ï¼š
--num-recordsè¡¨ç¤ºå‘é€æ¶ˆæ¯çš„æ•°é‡ï¼Œå³5kwæ¡ï¼›
--record-sizeè¡¨ç¤ºæ¯æ¡æ¶ˆæ¯çš„å¤§å°ï¼Œå³128å­—èŠ‚ï¼›
--throughputè¡¨ç¤ºååé‡é™åˆ¶ï¼Œ-1æ²¡æœ‰é™åˆ¶ï¼›
--producer-propsåé¢çš„éƒ½æ˜¯ç”Ÿäº§è€…é…ç½®

1ä¸ªç”Ÿäº§è€…-å•çº¿ç¨‹&3ä¸ªå‰¯æœ¬å¼‚æ­¥å†™å…¥ï¼š
bin/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance --topic TPC-P6-R3 --num-records 50000000 --record-size 100  --throughput -1 --producer-props acks=1  bootstrap.servers=10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092 buffer.memory=67108864 batch.size=8196

1ä¸ªç”Ÿäº§è€…-å•çº¿ç¨‹&3ä¸ªå‰¯æœ¬åŒæ­¥å†™å…¥ï¼š
bin/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance --topic TPC-P6-R3 --num-records 50000000 --record-size 100  --throughput -1 --producer-props acks=-1  bootstrap.servers=10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092 buffer.memory=67108864 batch.size=8196

3ä¸ªç”Ÿäº§è€…-å•çº¿ç¨‹&3ä¸ªå‰¯æœ¬å¼‚æ­¥å†™å…¥ï¼š
bin/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance --topic TPC-P6-R3 --num-records 50000000 --record-size 100  --throughput -1 --producer-props acks=1  bootstrap.servers=10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092 buffer.memory=67108864 batch.size=8196

- å‘é€50äº¿æ¡100ä¸ªå­—èŠ‚å¤§å°çš„æ¶ˆæ¯
bin/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance --topic TPC-P6-R3 --num-records 5000000000 --record-size 100  --throughput -1 --producer-props acks=1  bootstrap.servers=10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092 buffer.memory=67108864 batch.size=8196

æ¶ˆè´¹å°ºå¯¸çš„å½±å“--åˆ†åˆ«å°è¯•å„ç§ä¸åŒå­—èŠ‚å¤§å°æ¶ˆæ¯
for i in 10 100 1000 10000 100000;
do
    echo ""
    echo $i
    bin/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance --topic TPC-P6-R3 --num-records $((1000*1024*1024/$i)) --record-size $i --throughput -1 --producer-props acks=1 bootstrap.servers=10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092 buffer.memory=67108864 batch.size=8196
done;

å•ä¸ªæ¶ˆè´¹è€…æ¶ˆæ¯èƒ½åŠ›ï¼š
bin/kafka-consumer-perf-test.sh --zookeeper 10.0.1.1:2181,10.0.1.2:2181,10.0.1.2:2181/afei --messages 50000000 --topic TPC-P6-R3 --threads 1

3ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹èƒ½åŠ›--åœ¨3å°æœåŠ¡å™¨ä¸Šè¿è¡Œ3ä¸ªæ¶ˆè´¹è€…:
bin/kafka-consumer-perf-test.sh --zookeeper 10.0.1.1:2181,10.0.1.2:2181,10.0.1.2:2181/afei --messages 50000000 --topic TPC-P6-R3 --threads 1

ç”Ÿäº§è€…&æ¶ˆè´¹è€…ï¼š
bin/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance --topic TPC-P6-R3 --num-records 50000000 --record-size 100 --throughput -1 --producer-props acks=1 bootstrap.servers=10.0.0.1:9092,10.0.0.2:9092,10.0.0.3:9092 buffer.memory=67108864 batch.size=8196
bin/kafka-consumer-perf-test.sh --zookeeper 10.0.1.1:2181,10.0.1.2:2181,10.0.1.2:2181/afei --messages 50000000 --topic TPC-P6-R3 --threads 1
```

## server config

```Properties
broker.id=0
port=9092
num.network.threads=4
num.io.threads=8
socket.send.buffer.bytes=1048576
socket.receive.buffer.bytes=1048576
socket.request.max.bytes=104857600
log.dirs=/grid/a/dfs-data/kafka-logs,/grid/b/dfs-data/kafka-logs,/grid/c/dfs-data/kafka-logs,/grid/d/dfs-data/kafka-logs,/grid/e/dfs-data/kafka-logs,/grid/f/dfs-data/kafka-logs
num.partitions=8
log.retention.hours=168
log.segment.bytes=536870912
log.cleanup.interval.mins=1
zookeeper.connect=10.0.0.1:2181
zookeeper.connection.timeout.ms=1000000
kafka.metrics.polling.interval.secs=5
kafka.metrics.reporters=kafka.metrics.KafkaCSVMetricsReporter
kafka.csv.metrics.dir=/tmp/kafka_metrics
kafka.csv.metrics.reporter.enabled=false
replica.lag.max.messages=10000000
```

**è‹±æ–‡åŸæ–‡åœ°å€**ï¼š<https://engineering.linkedin.com/kafka/benchmarking-apache-kafka-2-million-writes-second-three-cheap-machines>