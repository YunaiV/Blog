title: ä½¿ç”¨ JPA å®ç°ä¹è§‚é”
date: 2019-01-06
tags:
categories: ç²¾è¿›
permalink: Fight/jpa-OptimisticLock/
author: è€å¾
from_url: https://www.cnkirito.moe/jpa-OptimisticLock/
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247486008&idx=2&sn=b50c803622901b466ab494c4aec6c466&chksm=fa497589cd3efc9fe7b8766eac57d4da07cc8ea4a689711e9de839bb730983b99f6159d11850&token=933039983&lang=zh_CN#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnkirito.moe/jpa-OptimisticLock/ ã€Œè€å¾ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [ç¤ºä¾‹](http://www.iocoder.cn/Fight/jpa-OptimisticLock//)
- [æ€»ç»“](http://www.iocoder.cn/Fight/jpa-OptimisticLock//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä¹è§‚é”çš„æ¦‚å¿µå°±ä¸å†èµ˜è¿°äº†ï¼Œä¸äº†è§£çš„æœ‹å‹è¯·è‡ªè¡Œç™¾åº¦è°·æ­Œä¹‹ï¼Œä»Šå¤©ä¸»è¦è¯´çš„æ˜¯åœ¨é¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨ä¹è§‚é”ï¼Œåšæˆä¸€ä¸ªå°demoã€‚

æŒä¹…å±‚ä½¿ç”¨jpaæ—¶ï¼Œé»˜è®¤æä¾›äº†ä¸€ä¸ªæ³¨è§£`@Version`å…ˆçœ‹çœ‹æºç æ€ä¹ˆæè¿°è¿™ä¸ªæ³¨è§£çš„

```Java
@Target({ METHOD, FIELD })
@Retention(RUNTIME)
public @interface Version {
}
```

ç®€å•æ¥è¯´å°±æ˜¯ç”¨ä¸€ä¸ªversionå­—æ®µæ¥å……å½“ä¹è§‚é”çš„ä½œç”¨ã€‚

# ç¤ºä¾‹

å…ˆæ¥è®¾è®¡å®ä½“ç±»

```Java
/**
 * Created by xujingfeng on 2017/1/30.
 */
@Entity
@Table(name = "t_student")
public class Student {

    @Id
    @GenericGenerator(name = "PKUUID", strategy = "uuid2")
    @GeneratedValue(generator = "PKUUID")
    @Column(length = 36)
    private String id;

    @Version
    private int version;

    private String name;

    //getter()...
    //setter()...
}
```


Daoå±‚

```Java
/**
 * Created by xujingfeng on 2017/1/30.
 */
public interface StudentDao extends JpaRepository<Student,String>{

    @Query("update Student set name=?1 where id=?2")
    @Modifying
    @Transactional
    int updateNameById(String name,String id);
}
```

Controllerå±‚å……å½“å•å…ƒæµ‹è¯•çš„ä½œç”¨ï¼Œé€šè¿‡è®¿é—®ä¸€ä¸ªrequestMappingæ¥è§¦å‘æˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„æ–¹æ³•ã€‚

```Java
/**
 * Created by xujingfeng on 2017/1/30.
 */
@Controller
public class StudentController {

    @Autowired
    StudentDao studentDao;

    @RequestMapping("student.html")
    @ResponseBody
    public String student(){
        Student student = new Student();
        student.setName("xujingfeng");
        studentDao.save(student);
        return "student";
    }

    @RequestMapping("testVersion.html")
    @ResponseBody
    public String testVersion() throws InterruptedException {
        Student student = studentDao.findOne("6ed16acc-61df-4a66-add9-d17c88b69755");
        student.setName("xuxuan");
        new Thread(new Runnable() {
            @Override
            public void run() {
                studentDao.findOne("6ed16acc-61df-4a66-add9-d17c88b69755");
                student.setName("xuxuanInThread");
                studentDao.save(student);
            }
        }).start();
        Thread.sleep(1000);
        studentDao.save(student);
        return "testVersion";
    }


    @RequestMapping("updateNameById.html")
    @ResponseBody
    public String updateNameById(){
        studentDao.updateNameById("xuxuan2","6ed16acc-61df-4a66-add9-d17c88b69755");
        return "updateNameById";
    }


}
```

è¿™é‡Œé¢ä¸‰ä¸ªæ–¹æ³•ï¼Œä¸»è¦æ˜¯æˆ‘ä»¬æƒ³ç”¨æ¥æµ‹è¯•çš„ä¸‰ä¸ªæ³¨æ„ç‚¹ã€‚
ç¬¬ä¸€ä¸ªæ–¹æ³•`student.html`æˆ‘ä»¬æƒ³çœ‹çœ‹springdataå¦‚ä½•å¯¹versionå­—æ®µè¿›è¡Œå¢é•¿çš„ã€‚å°±ä¸è´´å›¾äº†ï¼Œç›´æ¥ç»™ç»“è®ºï¼Œå¯¹äºæ·»åŠ äº†`@Version`çš„æ³¨è§£ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨å»æ§åˆ¶ï¼Œæ¯ä¸€æ¬¡saveæ“ä½œä¼šåœ¨åŸæ¥çš„åŸºç¡€ä¸Š+1ï¼Œå¦‚æœåˆå§‹ä¸ºnullï¼Œåˆ™springdataè‡ªåŠ¨è®¾ç½®å…¶ä¸º0ã€‚
ç¬¬äºŒä¸ªæ–¹æ³•`testVersion.html`æ˜¯ä¹è§‚é”çš„æ ¸å¿ƒï¼Œå½“å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®åŒä¸€è¡Œè®°å½•æ—¶ï¼Œæ·»åŠ äº†`@Version`ä¹è§‚é”ä¹‹åï¼Œç¨‹åºä¼šè¿›è¡Œæ€ä¹ˆæ ·çš„æ§åˆ¶å‘¢ï¼Ÿ

```
org.hibernate.StaleObjectStateException: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect) : [com.example.jpa.Student#6ed16acc-61df-4a66-add9-d17c88b69755]
```

å¼‚å¸¸ä¿¡æ¯å¦‚ä¸Šï¼Œä¸»çº¿ç¨‹å’Œæ–°çº¿ç¨‹è·å–äº†åŒä¸€è¡Œè®°å½•ï¼Œå¹¶ä¸”æ–°çº¿ç¨‹ä¼˜å…ˆæäº¤äº†äº‹åŠ¡ï¼Œç‰ˆæœ¬å·ä¸€è‡´ï¼Œä¿®æ”¹æˆåŠŸã€‚ç­‰åˆ°äº†ä¸»çº¿ç¨‹å†æƒ³saveæäº¤äº‹åŠ¡æ—¶ï¼Œä¾¿å¾—åˆ°ä¸€ä¸ªç‰ˆæœ¬å·ä¸ä¸€è‡´çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆåœ¨é¡¹ç›®å¼€å‘ä¸­å°±åº”è¯¥è‡ªå·±æ•è·è¿™ä¸ªå¼‚å¸¸æ ¹æ®ä¸šåŠ¡å†…å®¹åšå¯¹åº”å¤„ç†ï¼Œæ˜¯é‡è¯•è¿˜æ˜¯æ”¾å¼ƒetcâ€¦

ç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼Œ`updateNameById.html`æ˜¯æƒ³å¼ºè°ƒä¸€ä¸‹ï¼Œ`@Query`ä¸­çš„`update`ï¼Œ`delete`æ“ä½œæ˜¯ä¸ä¼šè§¦å‘springdataçš„ç›¸å…³ä»£ç†æ“ä½œçš„ï¼Œè€Œæ˜¯è½¬åŒ–ä¸ºåŸç”Ÿsqlçš„æ–¹å¼ï¼Œæ‰€ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ—¶ä¹Ÿè¦æ³¨æ„è¿™ç‚¹ã€‚

# æ€»ç»“

ä¹è§‚é”ï¼Œç”¨åœ¨ä¸€äº›æ•æ„Ÿä¸šåŠ¡æ•°æ®ä¸Šï¼Œè€Œå…¶æœ¬èº«çš„ä¿®é¥°ï¼šä¹è§‚ï¼Œä»£è¡¨çš„å«ä¹‰ä¾¿æ˜¯ç›¸ä¿¡å¤§å¤šæ•°åœºæ™¯ä¸‹versionæ˜¯ä¸€è‡´çš„ã€‚ä½†æ˜¯ä»ä¸šåŠ¡è§’åº¦å‡ºå‘åˆè¦ä¿è¯æ•°æ®çš„ä¸¥æ ¼ä¸€è‡´æ€§ï¼Œé¿å…è„è¯»ç­‰é—®é¢˜ï¼Œä½¿ç”¨çš„åœºæ™¯éœ€è¦æ–Ÿé…Œã€‚è®°å¾—å‰é¢ä¸€ç‰‡åšæ–‡ç®€å•ä»‹ç»äº†ä¸€ä¸‹è¡Œçº§é”çš„æ¦‚å¿µï¼Œå…¶å®æœ¬è´¨ä¸Šå’Œä¹è§‚é”éƒ½æ˜¯æƒ³è¦å†æ•°æ®åº“å±‚é¢åŠ é”æ§åˆ¶å¹¶å‘ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™è¯¥ç”¨ä¹è§‚é”ï¼Œè¡Œçº§é”ï¼Œä»€ä¹ˆæ—¶å€™å¾—åœ¨ç¨‹åºçº§åˆ«åŠ åŒæ­¥é”ï¼Œåˆè¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯å»åˆ¤æ–­ã€‚æ‰¾åˆ°èƒ½å¤Ÿæ»¡è¶³è‡ªå·±é¡¹ç›®éœ€æ±‚çš„æ–¹æ¡ˆï¼Œæ‰¾åˆ°æ€§èƒ½å’Œå¯é æ€§çš„å¹³è¡¡ç‚¹ï¼Œæ‰æ˜¯ä¸€ä¸ªç¨‹åºå‘˜çš„ä»·å€¼æ‰€åœ¨ã€‚