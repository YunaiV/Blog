title: Apollo æºç è§£æ â€”â€” æœåŠ¡çš„æ³¨å†Œä¸å‘ç°
date: 2018-06-20
tags:
categories: Apollo
permalink: Apollo/service-register-discovery

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Apollo/service-register-discovery/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. æ¦‚è¿°](http://www.iocoder.cn/Apollo/service-register-discovery/)
- [2. Eureka Server](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [2.1 å¯åŠ¨ Eureka Server](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [2.2 æ³¨å†Œåˆ° Eureka Client](http://www.iocoder.cn/Apollo/service-register-discovery/)
- [3. Meta Service](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [3.1 ApolloMetaServiceConfig](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [3.2 ServiceController](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [3.3 DiscoveryService](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [3.4 é›†ç¾¤](http://www.iocoder.cn/Apollo/service-register-discovery/)
- [4. ConfigServiceLocator](http://www.iocoder.cn/Apollo/service-register-discovery/)
- [5. AdminServiceAddressLocator](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [5.1 MetaDomainConsts](http://www.iocoder.cn/Apollo/service-register-discovery/)
  - [5.2 Env](http://www.iocoder.cn/Apollo/service-register-discovery/)
- [666. å½©è›‹](http://www.iocoder.cn/Apollo/service-register-discovery/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# 1. æ¦‚è¿°

> è€è‰¿è‰¿ï¼šæœ¬ç³»åˆ—å‡å®šèƒ–å‹å·²ç»é˜…è¯»è¿‡ [ã€ŠApollo å®˜æ–¹ wiki æ–‡æ¡£ã€‹](https://github.com/ctripcorp/apollo/wiki/) ï¼Œç‰¹åˆ«æ˜¯ [ã€Šæ¶æ„æ¨¡å—ã€‹](https://github.com/ctripcorp/apollo/wiki/Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%AE%BE%E8%AE%A1#12-%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%9D%97) ã€‚

æœ¬æ–‡åˆ†äº« Apollo **æœåŠ¡çš„æ³¨å†Œä¸å‘ç°**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æœåŠ¡çš„æ³¨å†Œä¸å‘ç°](http://www.iocoder.cn/images/Apollo/2018_06_20/01.png)

* å„æœåŠ¡çš„ä»‹ç»ï¼Œè§ [ã€Šå„æ¨¡å—æ¦‚è¦ä»‹ç»ã€‹](https://github.com/ctripcorp/apollo/wiki/Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%AE%BE%E8%AE%A1#13-%E5%90%84%E6%A8%A1%E5%9D%97%E6%A6%82%E8%A6%81%E4%BB%8B%E7%BB%8D) ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼ŒConfig Serviceã€Meta Serviceã€Eureka Server **ç»Ÿä¸€**éƒ¨ç½²åœ¨ **Config Service** ä¸­ã€‚å¦‚æœæƒ³è¦ä½¿ç”¨**å•ç‹¬çš„ Eureka Server**ï¼Œå‚è§ [ã€Šå°† Config Service å’Œ Admin Service æ³¨å†Œåˆ°å•ç‹¬çš„ Eureka Server ä¸Šã€‹](https://github.com/ctripcorp/apollo/wiki/%E9%83%A8%E7%BD%B2&%E5%BC%80%E5%8F%91%E9%81%87%E5%88%B0%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98#8-%E5%B0%86config-service%E5%92%8Cadmin-service%E6%B3%A8%E5%86%8C%E5%88%B0%E5%8D%95%E7%8B%AC%E7%9A%84eureka-server%E4%B8%8A) ã€‚

# 2. Eureka Server 

## 2.1 å¯åŠ¨ Eureka Server

åœ¨ `apollo-configservice`  é¡¹ç›®ä¸­ï¼Œ`com.ctrip.framework.apollo.configservice.ConfigServiceApplication` ä¸­ï¼Œé€šè¿‡ `@EnableEurekaServer` æ³¨è§£å¯åŠ¨ Eureka Server ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
@EnableEurekaServer // å¯åŠ¨ Eureka Server
@EnableAspectJAutoProxy
@EnableAutoConfiguration // (exclude = EurekaClientConfigBean.class)
@Configuration
@EnableTransactionManagement
@PropertySource(value = {"classpath:configservice.properties"})
@ComponentScan(basePackageClasses = {ApolloCommonConfig.class,
        ApolloBizConfig.class,
        ConfigServiceApplication.class,
        ApolloMetaServiceConfig.class})
public class ConfigServiceApplication {

    public static void main(String[] args) throws Exception {
        ConfigurableApplicationContext context = new SpringApplicationBuilder(ConfigServiceApplication.class).run(args);
        context.addApplicationListener(new ApplicationPidFileWriter());
        context.addApplicationListener(new EmbeddedServerPortFileWriter());
    }

}
```

* ç¬¬ä¸€è¡Œçš„ `@EnableEurekaServer` æ³¨è§£ï¼Œå¯åŠ¨ Eureka Server ã€‚åŸºäº Spring Cloud Eureka ï¼Œéœ€è¦åœ¨ Maven çš„ `pom.xml` ä¸­ç”³æ˜å¦‚ä¸‹ä¾èµ–ï¼š

    ```XML
    <!-- eureka -->
    <dependency>
    	<groupId>org.springframework.cloud</groupId>
    	<artifactId>spring-cloud-starter-eureka-server</artifactId>
    	<exclusions>
    		<exclusion>
    			<artifactId>
                    spring-cloud-starter-archaius
                </artifactId>
    			<groupId>org.springframework.cloud</groupId>
    		</exclusion>
    		<exclusion>
    			<artifactId>spring-cloud-starter-ribbon</artifactId>
    			<groupId>org.springframework.cloud</groupId>
    		</exclusion>
    		<exclusion>
    			<artifactId>ribbon-eureka</artifactId>
    			<groupId>com.netflix.ribbon</groupId>
    		</exclusion>
    		<exclusion>
    			<artifactId>aws-java-sdk-core</artifactId>
    			<groupId>com.amazonaws</groupId>
    		</exclusion>
    		<exclusion>
    			<artifactId>aws-java-sdk-ec2</artifactId>
    			<groupId>com.amazonaws</groupId>
    		</exclusion>
    		<exclusion>
    			<artifactId>aws-java-sdk-autoscaling</artifactId>
    			<groupId>com.amazonaws</groupId>
    		</exclusion>
    		<exclusion>
    			<artifactId>aws-java-sdk-sts</artifactId>
    			<groupId>com.amazonaws</groupId>
    		</exclusion>
    		<exclusion>
    			<artifactId>aws-java-sdk-route53</artifactId>
    			<groupId>com.amazonaws</groupId>
    		</exclusion>
    		<!-- duplicated with spring-security-core -->
    		<exclusion>
    			<groupId>org.springframework.security</groupId>
    			<artifactId>spring-security-crypto</artifactId>
    		</exclusion>
    	</exclusions>
    </dependency>
    <!-- end of eureka -->
    ```

é‚£ä¹ˆ Eureka Server æ€ä¹ˆæ„å»ºæˆ**é›†ç¾¤**å‘¢ï¼Ÿç­”æ¡ˆåœ¨ [ã€Œ2.2 æ³¨å†Œåˆ° Eureka Clientã€](#)  ä¸­ã€‚

## 2.2 æ³¨å†Œåˆ° Eureka Client

åœ¨ `apollo-biz` é¡¹ç›®ä¸­ï¼Œ`com.ctrip.framework.apollo.biz.eureka.ApolloEurekaClientConfig` ä¸­ï¼Œ**å£°æ˜** Eureka çš„**é…ç½®**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
@Component
@Primary
public class ApolloEurekaClientConfig extends EurekaClientConfigBean {

    @Autowired
    private BizConfig bizConfig;

    /**
     * Assert only one zone: defaultZone, but multiple environments.
     */
    @Override
    public List<String> getEurekaServerServiceUrls(String myZone) {
        List<String> urls = bizConfig.eurekaServiceUrls();
        return CollectionUtils.isEmpty(urls) ? super.getEurekaServerServiceUrls(myZone) : urls;
    }

    @Override
    public boolean equals(Object o) {
        return super.equals(o);
    }

}
```

* `@Primary` æ³¨è§£ï¼Œä¿è¯**ä¼˜å…ˆçº§**ã€‚
* `#getEurekaServerServiceUrls(myZone)` æ–¹æ³•ï¼Œè°ƒç”¨ `BizConfig#eurekaServiceUrls()` æ–¹æ³•ï¼Œä» ServerConfig çš„ `"eureka.service.url"` é…ç½®é¡¹ï¼Œè·å¾— Eureka Server åœ°å€ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // è·å¾— Eureka æœåŠ¡å™¨åœ°å€çš„æ•°ç»„
    public List<String> eurekaServiceUrls() {
        // è·å¾—é…ç½®å€¼
        String configuration = getValue("eureka.service.url", "");
        // åˆ†éš”æˆ List
        if (Strings.isNullOrEmpty(configuration)) {
            return Collections.emptyList();
        }
        return splitter.splitToList(configuration);
    }
    ```
    * Eureka Server **å…±äº«**è¯¥é…ç½®ï¼Œä»è€Œå½¢æˆ Eureka Server **é›†ç¾¤**ã€‚
* åŸºäº Spring Cloud Eureka ï¼Œéœ€è¦åœ¨ Maven çš„ `pom.xml` ä¸­ç”³æ˜å¦‚ä¸‹ä¾èµ–ï¼š

    ```XML
    <!-- eureka -->
    <dependency>
    	<groupId>org.springframework.cloud</groupId>
    	<artifactId>spring-cloud-starter-eureka</artifactId>
    </dependency>
    <!-- end of eureka -->
    ```

`apollo-adminservice` å’Œ `apollo-configservice` é¡¹ç›®ï¼Œå¼•å…¥ `apollo-biz` é¡¹ç›®ï¼Œå¯åŠ¨ Eureka Client ï¼Œå‘ Eureka Server **æ³¨å†Œ**è‡ªå·±ä¸ºå®ä¾‹ã€‚é€šè¿‡ `.properties` é…ç½®**å®ä¾‹å**ï¼š

```Java
// FROM adminservice.properties
spring.application.name= apollo-adminservice

// FROM configservice.properties
spring.application.name= apollo-configservice
```

# 3. Meta Service

åœ¨ `apollo-configservice` é¡¹ç›®ä¸­ï¼Œ`metaservice` **åŒ…**ä¸‹ï¼Œçœ‹åˆ°æ‰€æœ‰ Meta Service çš„ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š![Meta Service](http://www.iocoder.cn/images/Apollo/2018_06_20/02.png)

## 3.1 ApolloMetaServiceConfig 

```Java
@EnableAutoConfiguration
@Configuration
@ComponentScan(basePackageClasses = ApolloMetaServiceConfig.class)
public class ApolloMetaServiceConfig {
}
```

## 3.2 ServiceController

```Java
@RestController
@RequestMapping("/services")
public class ServiceController {

    @Autowired
    private DiscoveryService discoveryService;

    @RequestMapping("/meta")
    public List<ServiceDTO> getMetaService() {
        List<InstanceInfo> instances = discoveryService.getMetaServiceInstances();
        List<ServiceDTO> result = instances.stream().map(new Function<InstanceInfo, ServiceDTO>() {

            @Override
            public ServiceDTO apply(InstanceInfo instance) {
                ServiceDTO service = new ServiceDTO();
                service.setAppName(instance.getAppName());
                service.setInstanceId(instance.getInstanceId());
                service.setHomepageUrl(instance.getHomePageUrl());
                return service;
            }

        }).collect(Collectors.toList());
        return result;
    }

    @RequestMapping("/config")
    public List<ServiceDTO> getConfigService(
            @RequestParam(value = "appId", defaultValue = "") String appId,
            @RequestParam(value = "ip", required = false) String clientIp) {
        List<InstanceInfo> instances = discoveryService.getConfigServiceInstances();
        List<ServiceDTO> result = instances.stream().map(new Function<InstanceInfo, ServiceDTO>() {

            @Override
            public ServiceDTO apply(InstanceInfo instance) {
                ServiceDTO service = new ServiceDTO();
                service.setAppName(instance.getAppName());
                service.setInstanceId(instance.getInstanceId());
                service.setHomepageUrl(instance.getHomePageUrl());
                return service;
            }

        }).collect(Collectors.toList());
        return result;
    }

    @RequestMapping("/admin")
    public List<ServiceDTO> getAdminService() {
        List<InstanceInfo> instances = discoveryService.getAdminServiceInstances();
        List<ServiceDTO> result = instances.stream().map(new Function<InstanceInfo, ServiceDTO>() {

            @Override
            public ServiceDTO apply(InstanceInfo instance) {
                ServiceDTO service = new ServiceDTO();
                service.setAppName(instance.getAppName());
                service.setInstanceId(instance.getInstanceId());
                service.setHomepageUrl(instance.getHomePageUrl());
                return service;
            }

        }).collect(Collectors.toList());
        return result;
    }

}
```

* æä¾›äº†**ä¸‰ä¸ª** API ï¼Œ`services/meta`ã€`services/config`ã€`services/admin` è·å¾— Meta Serviceã€Config Serviceã€Admin Service **é›†ç¾¤**åœ°å€ã€‚ğŸ˜ˆ å®é™…ä¸Šï¼Œ`services/meta` æš‚æ—¶æ˜¯ä¸å¯ç”¨çš„ï¼Œè·å–ä¸åˆ°å®ä¾‹ï¼Œå› ä¸º Meta Service ç›®å‰**å†…åµŒ**åœ¨ Config Service ä¸­ã€‚
* åœ¨**æ¯ä¸ª** API ä¸­ï¼Œè°ƒç”¨ DiscoveryService è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œè·å–æœåŠ¡é›†ç¾¤ã€‚
* `com.ctrip.framework.apollo.core.dto.ServiceDTO`  ï¼ŒæœåŠ¡ DTO ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    public class ServiceDTO {
    
        /**
         * åº”ç”¨å
         */
        private String appName;
        /**
         * å®ä¾‹ç¼–å·
         */
        private String instanceId;
        /**
         * Home URL
         */
        private String homepageUrl;
    }
    ```

## 3.3 DiscoveryService

```Java
@Service
public class DiscoveryService {

    @Autowired
    private EurekaClient eurekaClient;

    public List<InstanceInfo> getConfigServiceInstances() {
        Application application = eurekaClient.getApplication(ServiceNameConsts.APOLLO_CONFIGSERVICE);
        if (application == null) {
            Tracer.logEvent("Apollo.EurekaDiscovery.NotFound", ServiceNameConsts.APOLLO_CONFIGSERVICE);
        }
        return application != null ? application.getInstances() : Collections.emptyList();
    }

    public List<InstanceInfo> getMetaServiceInstances() {
        Application application = eurekaClient.getApplication(ServiceNameConsts.APOLLO_METASERVICE);
        if (application == null) {
            Tracer.logEvent("Apollo.EurekaDiscovery.NotFound", ServiceNameConsts.APOLLO_METASERVICE);
        }
        return application != null ? application.getInstances() : Collections.emptyList();
    }

    public List<InstanceInfo> getAdminServiceInstances() {
        Application application = eurekaClient.getApplication(ServiceNameConsts.APOLLO_ADMINSERVICE);
        if (application == null) {
            Tracer.logEvent("Apollo.EurekaDiscovery.NotFound", ServiceNameConsts.APOLLO_ADMINSERVICE);
        }
        return application != null ? application.getInstances() : Collections.emptyList();
    }

}
```

* **æ¯ä¸ª**æ–¹æ³•ï¼Œè°ƒç”¨ `EurekaClient#getApplication(appName)` æ–¹æ³•ï¼Œè·å¾—**æœåŠ¡**é›†ç¾¤ã€‚
* `com.ctrip.framework.apollo.core.ServiceNameConsts` ï¼Œæšä¸¾äº†æ‰€æœ‰æœåŠ¡çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    public interface ServiceNameConsts {
    
        String APOLLO_METASERVICE = "apollo-metaservice";
    
        String APOLLO_CONFIGSERVICE = "apollo-configservice";
    
        String APOLLO_ADMINSERVICE = "apollo-adminservice";
    
        String APOLLO_PORTAL = "apollo-portal";
    
    }
    ```

## 3.4 é›†ç¾¤

è€ƒè™‘åˆ°é«˜å¯ç”¨ï¼ŒMeta Service å¿…é¡»**é›†ç¾¤**ã€‚å› ä¸º Meta Service è‡ªèº«æ‰®æ¼”äº†**ç›®å½•æœåŠ¡**çš„è§’è‰²ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸å¾—ä¸å¼•å…¥ Proxy Server ã€‚ä»é€‰æ‹©ä¸Šï¼Œç¬”è€…æƒ³åˆ°çš„æ˜¯ï¼š

1. Nginx ï¼Œç›®å‰äº’è”ç½‘ä¸Šæœ€å¸¸ç”¨çš„ Proxy Server ã€‚
2. Zuul ï¼Œå¯ä»¥å’Œ Eureka æ‰“é€šï¼Œå®ç°æ³¨å†Œä¸å‘ç°ã€‚

å› ä¸º Meta Service ç›®å‰å¹¶æœªæ³¨å†Œåˆ° Zuul ä¸Šï¼Œæ‰€ä»¥ç›¸æ¯”æ¥è¯´ï¼ŒNginx ä¼šæ˜¯æ›´åˆé€‚çš„é€‰æ‹©ã€‚å½“ç„¶ï¼ŒğŸ˜ˆ Nginx è‡ªèº«ä¹Ÿæ˜¯è¦åšé«˜å¯ç”¨çš„ï¼Œå“ˆå“ˆå“ˆï¼Œè¿™å—èƒ–å‹è‡ªå·± Google ä¸‹è§£å†³æ–¹æ¡ˆã€‚

**åœ¨é«˜æ€§èƒ½ä¹‹å‰ï¼Œä¸€åˆ‡æœåŠ¡èŠ‚ç‚¹å¿…é¡»é«˜å¯ç”¨**ã€‚ä»»ä½•æœåŠ¡èŠ‚ç‚¹çš„æ¾æ‡ˆï¼ŒåŠ¿å¿…åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œç»™æˆ‘ä»¬æ¥ä¸€æ³¢æš´å‡»ï¼ï¼ï¼

# 4. ConfigServiceLocator

åœ¨ `apollo-client` é¡¹ç›®ä¸­ï¼Œ`com.ctrip.framework.apollo.internals.ConfigServiceLocator` ï¼ŒConfig Service å®šä½å™¨ã€‚

* åˆå§‹æ—¶ï¼Œä» Meta Service è·å– Config Service é›†ç¾¤åœ°å€è¿›è¡Œ**ç¼“å­˜**ã€‚
* å®šæ—¶ä»»åŠ¡ï¼Œæ¯ **5** åˆ†é’Ÿï¼Œä» Meta Service è·å– Config Service é›†ç¾¤åœ°å€åˆ·æ–°**ç¼“å­˜**ã€‚

ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
public class ConfigServiceLocator {

    private static final Logger logger = LoggerFactory.getLogger(ConfigServiceLocator.class);

    private static final Joiner.MapJoiner MAP_JOINER = Joiner.on("&").withKeyValueSeparator("=");
    private static final Escaper queryParamEscaper = UrlEscapers.urlFormParameterEscaper();

    private HttpUtil m_httpUtil;
    private ConfigUtil m_configUtil;
    /**
     * ServiceDTO æ•°ç»„çš„ç¼“å­˜
     */
    private AtomicReference<List<ServiceDTO>> m_configServices;
    private Type m_responseType;
    /**
     * å®šæ—¶ä»»åŠ¡ ExecutorService
     */
    private ScheduledExecutorService m_executorService;

    /**
     * Create a config service locator.
     */
    public ConfigServiceLocator() {
        List<ServiceDTO> initial = Lists.newArrayList();
        m_configServices = new AtomicReference<>(initial);
        m_responseType = new TypeToken<List<ServiceDTO>>() {}.getType();
        m_httpUtil = ApolloInjector.getInstance(HttpUtil.class);
        m_configUtil = ApolloInjector.getInstance(ConfigUtil.class);
        this.m_executorService = Executors.newScheduledThreadPool(1, ApolloThreadFactory.create("ConfigServiceLocator", true));
        // åˆå§‹æ‹‰å– Config Service åœ°å€
        this.tryUpdateConfigServices();
        // åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶æ‹‰å– Config Service åœ°å€
        this.schedulePeriodicRefresh();
    }

    /**
     * Get the config service info from remote meta server.
     *
     * @return the services dto
     */
    public List<ServiceDTO> getConfigServices() {
        // ç¼“å­˜ä¸ºç©ºï¼Œå¼ºåˆ¶æ‹‰å–
        if (m_configServices.get().isEmpty()) {
            updateConfigServices();
        }
        // è¿”å› ServiceDTO æ•°ç»„
        return m_configServices.get();
    }

    private boolean tryUpdateConfigServices() {
        try {
            updateConfigServices();
            return true;
        } catch (Throwable ex) {
            //ignore
        }
        return false;
    }

    private void schedulePeriodicRefresh() {
        this.m_executorService.scheduleAtFixedRate(new Runnable() {
            @Override
            public void run() {
                logger.debug("refresh config services");
                Tracer.logEvent("Apollo.MetaService", "periodicRefresh");
                // æ‹‰å– Config Service åœ°å€
                tryUpdateConfigServices();
            }
        }, m_configUtil.getRefreshInterval(), m_configUtil.getRefreshInterval(), m_configUtil.getRefreshIntervalTimeUnit());
    }

    private synchronized void updateConfigServices() {
        // æ‹¼æ¥è¯·æ±‚ Meta Service URL
        String url = assembleMetaServiceUrl();

        HttpRequest request = new HttpRequest(url);
        int maxRetries = 2; // é‡è¯•ä¸¤æ¬¡
        Throwable exception = null;

        // å¾ªç¯è¯·æ±‚ Meta Service ï¼Œè·å– Config Service åœ°å€
        for (int i = 0; i < maxRetries; i++) {
            Transaction transaction = Tracer.newTransaction("Apollo.MetaService", "getConfigService");
            transaction.addData("Url", url);
            try {
                // è¯·æ±‚
                HttpResponse<List<ServiceDTO>> response = m_httpUtil.doGet(request, m_responseType);
                transaction.setStatus(Transaction.SUCCESS);
                // è·å¾—ç»“æœ ServiceDTO æ•°ç»„
                List<ServiceDTO> services = response.getBody();
                // è·å¾—ç»“æœä¸ºç©ºï¼Œé‡æ–°è¯·æ±‚
                if (services == null || services.isEmpty()) {
                    logConfigService("Empty response!");
                    continue;
                }
                // æ›´æ–°ç¼“å­˜
                m_configServices.set(services);
                // æ‰“å°ç»“æœ ServiceDTO æ•°ç»„
                logConfigServices(services);
                return;
            } catch (Throwable ex) {
                Tracer.logEvent("ApolloConfigException", ExceptionUtil.getDetailMessage(ex));
                transaction.setStatus(ex);
                exception = ex;
            } finally {
                transaction.complete();
            }
            // è¯·æ±‚å¤±è´¥ï¼Œsleep ç­‰å¾…ä¸‹æ¬¡é‡è¯•
            try {
                m_configUtil.getOnErrorRetryIntervalTimeUnit().sleep(m_configUtil.getOnErrorRetryInterval());
            } catch (InterruptedException ex) {
                // ignore
            }
        }
        // è¯·æ±‚å…¨éƒ¨å¤±è´¥ï¼ŒæŠ›å‡º ApolloConfigException å¼‚å¸¸
        throw new ApolloConfigException(String.format("Get config services failed from %s", url), exception);
    }

    private String assembleMetaServiceUrl() {
        String domainName = m_configUtil.getMetaServerDomainName();
        String appId = m_configUtil.getAppId();
        String localIp = m_configUtil.getLocalIp();

        // å‚æ•°é›†åˆ
        Map<String, String> queryParams = Maps.newHashMap();
        queryParams.put("appId", queryParamEscaper.escape(appId));
        if (!Strings.isNullOrEmpty(localIp)) {
            queryParams.put("ip", queryParamEscaper.escape(localIp));
        }

        return domainName + "/services/config?" + MAP_JOINER.join(queryParams);
    }

    private void logConfigServices(List<ServiceDTO> serviceDtos) {
        for (ServiceDTO serviceDto : serviceDtos) {
            logConfigService(serviceDto.getHomepageUrl());
        }
    }

    private void logConfigService(String serviceUrl) {
        Tracer.logEvent("Apollo.Config.Services", serviceUrl);
    }
    
}
```

# 5. AdminServiceAddressLocator

åœ¨ `apollo-portal` é¡¹ç›®ä¸­ï¼Œ`com.ctrip.framework.apollo.portal.component.AdminServiceAddressLocator` ï¼ŒAdmin Service å®šä½å™¨ã€‚

* åˆå§‹æ—¶ï¼Œåˆ›å»ºå»¶è¿Ÿ **1 ç§’**çš„ä»»åŠ¡ï¼Œä» Meta Service è·å– Config Service é›†ç¾¤åœ°å€è¿›è¡Œ**ç¼“å­˜**ã€‚
* è·å–**æˆåŠŸ**æ—¶ï¼Œåˆ›å»ºå»¶è¿Ÿ **5 åˆ†é’Ÿ**çš„ä»»åŠ¡ï¼Œä» Meta Service è·å– Config Service é›†ç¾¤åœ°å€åˆ·æ–°**ç¼“å­˜**ã€‚
* è·å–**å¤±è´¥**æ—¶ï¼Œåˆ›å»ºå»¶è¿Ÿ **10 ç§’**çš„ä»»åŠ¡ï¼Œä» Meta Service è·å– Config Service é›†ç¾¤åœ°å€åˆ·æ–°**ç¼“å­˜**ã€‚

ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
@Component
public class AdminServiceAddressLocator {

    private static final Logger logger = LoggerFactory.getLogger(AdminServiceAddressLocator.class);

    private static final long NORMAL_REFRESH_INTERVAL = 5 * 60 * 1000;
    private static final long OFFLINE_REFRESH_INTERVAL = 10 * 1000;
    private static final int RETRY_TIMES = 3;
    private static final String ADMIN_SERVICE_URL_PATH = "/services/admin";

    /**
     * å®šæ—¶ä»»åŠ¡ ExecutorService
     */
    private ScheduledExecutorService refreshServiceAddressService;
    private RestTemplate restTemplate;
    /**
     * Env æ•°ç»„
     */
    private List<Env> allEnvs;
    /**
     * List<ServiceDTO ç¼“å­˜ Map
     *
     * KEYï¼šENV
     */
    private Map<Env, List<ServiceDTO>> cache = new ConcurrentHashMap<>();
    @Autowired
    private HttpMessageConverters httpMessageConverters; // æš‚æœªä½¿ç”¨
    @Autowired
    private PortalSettings portalSettings;
    @Autowired
    private RestTemplateFactory restTemplateFactory;

    @PostConstruct
    public void init() {
        // è·å¾— Env æ•°ç»„
        allEnvs = portalSettings.getAllEnvs();
        // init restTemplate
        restTemplate = restTemplateFactory.getObject();
        // åˆ›å»º ScheduledExecutorService
        refreshServiceAddressService = Executors.newScheduledThreadPool(1, ApolloThreadFactory.create("ServiceLocator", true));
        // åˆ›å»ºå»¶è¿Ÿä»»åŠ¡ï¼Œ1 ç§’åæ‹‰å– Admin Service åœ°å€
        refreshServiceAddressService.schedule(new RefreshAdminServerAddressTask(), 1, TimeUnit.MILLISECONDS);
    }

    public List<ServiceDTO> getServiceList(Env env) {
        // ä»ç¼“å­˜ä¸­è·å¾— ServiceDTO æ•°ç»„
        List<ServiceDTO> services = cache.get(env);
        // è‹¥ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›ç©ºæ•°ç»„ã€‚è¿™ç‚¹å’Œ ConfigServiceLocator ä¸åŒã€‚
        if (CollectionUtils.isEmpty(services)) {
            return Collections.emptyList();
        }
        // æ‰“ä¹± ServiceDTO æ•°ç»„ï¼Œè¿”å›ã€‚å®ç° Client çº§çš„è´Ÿè½½å‡è¡¡
        List<ServiceDTO> randomConfigServices = Lists.newArrayList(services);
        Collections.shuffle(randomConfigServices);
        return randomConfigServices;
    }

    // maintain admin server address
    private class RefreshAdminServerAddressTask implements Runnable {

        @Override
        public void run() {
            boolean refreshSuccess = true;
            // å¾ªç¯å¤šä¸ª Env ï¼Œè¯·æ±‚å¯¹åº”çš„ Meta Service ï¼Œè·å¾— Admin Service é›†ç¾¤åœ°å€
            // refresh fail if get any env address fail
            for (Env env : allEnvs) {
                boolean currentEnvRefreshResult = refreshServerAddressCache(env);
                refreshSuccess = refreshSuccess && currentEnvRefreshResult;
            }
            // è‹¥åˆ·æ–°æˆåŠŸï¼Œåˆ™åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œ5 åˆ†é’Ÿåæ‰§è¡Œ
            if (refreshSuccess) {
                refreshServiceAddressService.schedule(new RefreshAdminServerAddressTask(), NORMAL_REFRESH_INTERVAL, TimeUnit.MILLISECONDS);
            // è‹¥åˆ·æ–°å¤±è´¥ï¼Œåˆ™åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œ10 ç§’åæ‰§è¡Œ
            } else {
                refreshServiceAddressService.schedule(new RefreshAdminServerAddressTask(), OFFLINE_REFRESH_INTERVAL, TimeUnit.MILLISECONDS);
            }
        }
    }

    private boolean refreshServerAddressCache(Env env) {
        for (int i = 0; i < RETRY_TIMES; i++) {
            try {
                // è¯·æ±‚ Meta Service ï¼Œè·å¾— Admin Service é›†ç¾¤åœ°å€
                ServiceDTO[] services = getAdminServerAddress(env);
                // è·å¾—ç»“æœä¸ºç©ºï¼Œcontinue ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¬¡è¯·æ±‚
                if (services == null || services.length == 0) {
                    continue;
                }
                // æ›´æ–°ç¼“å­˜
                cache.put(env, Arrays.asList(services));
                // è¿”å›è·å–æˆåŠŸ
                return true;
            } catch (Throwable e) {
                logger.error(String.format("Get admin server address from meta server failed. env: %s, meta server address:%s", env, MetaDomainConsts.getDomain(env)), e);
                Tracer.logError(String.format("Get admin server address from meta server failed. env: %s, meta server address:%s", env, MetaDomainConsts.getDomain(env)), e);
            }
        }
        // è¿”å›è·å–å¤±è´¥
        return false;
    }

    private ServiceDTO[] getAdminServerAddress(Env env) {
        String domainName = MetaDomainConsts.getDomain(env); // MetaDomainConsts
        String url = domainName + ADMIN_SERVICE_URL_PATH;
        return restTemplate.getForObject(url, ServiceDTO[].class);
    }

}
```



## 5.1 MetaDomainConsts

`com.ctrip.framework.apollo.core.MetaDomainConsts` ï¼ŒMeta Service å¤š**ç¯å¢ƒ**çš„åœ°å€æšä¸¾ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
/**
 * The meta domain will load the meta server from System environment first, if not exist, will load
 * from apollo-env.properties. If neither exists, will load the default meta url.
 * <p>
 * Currently, apollo supports local/dev/fat/uat/lpt/pro environments.
 */
public class MetaDomainConsts {

    private static Map<Env, Object> domains = new HashMap<>();

    public static final String DEFAULT_META_URL = "http://config.local";

    static {
        // è¯»å–é…ç½®æ–‡ä»¶åˆ° Properties ä¸­
        Properties prop = new Properties();
        prop = ResourceUtils.readConfigFile("apollo-env.properties", prop);
        // è·å¾—ç³»ç»Ÿ Properties
        Properties env = System.getProperties();
        // æ·»åŠ åˆ° domains ä¸­
        // ä¼˜å…ˆçº§ï¼Œenv > prop
        domains.put(Env.LOCAL, env.getProperty("local_meta", prop.getProperty("local.meta", DEFAULT_META_URL)));
        domains.put(Env.DEV, env.getProperty("dev_meta", prop.getProperty("dev.meta", DEFAULT_META_URL)));
        domains.put(Env.FAT, env.getProperty("fat_meta", prop.getProperty("fat.meta", DEFAULT_META_URL)));
        domains.put(Env.UAT, env.getProperty("uat_meta", prop.getProperty("uat.meta", DEFAULT_META_URL)));
        domains.put(Env.LPT, env.getProperty("lpt_meta", prop.getProperty("lpt.meta", DEFAULT_META_URL)));
        domains.put(Env.PRO, env.getProperty("pro_meta", prop.getProperty("pro.meta", DEFAULT_META_URL)));
    }

    public static String getDomain(Env env) {
        return String.valueOf(domains.get(env));
    }

}
```

* å…·ä½“çš„è¯»å–**é¡ºåº**å’Œè¯´æ˜ï¼Œè§**è‹±æ–‡æ³¨é‡Š**è¯´æ˜ã€‚ğŸ™‚ è‹±è¯­å’Œæˆ‘ä¸€æ ·æœ‰éå¸¸å¤§çš„è¿›æ­¥ç©ºçš„åŒå­¦ï¼Œå¯ä»¥ä½¿ç”¨æœ‰é“è¯å…¸ç¿»è¯‘ã€‚

## 5.2 Env

`com.ctrip.framework.apollo.core.enums.Env` ï¼Œç¯å¢ƒ**æšä¸¾**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
/**
 * Here is the brief description for all the predefined environments:
 * <ul>
 * <li>LOCAL: Local Development environment, assume you are working at the beach with no network access</li>
 * <li>DEV: Development environment</li>
 * <li>FWS: Feature Web Service Test environment</li>
 * <li>FAT: Feature Acceptance Test environment</li>
 * <li>UAT: User Acceptance Test environment</li>
 * <li>LPT: Load and Performance Test environment</li>
 * <li>PRO: Production environment</li>
 * <li>TOOLS: Tooling environment, a special area in production environment which allows
 * access to test environment, e.g. Apollo Portal should be deployed in tools environment</li>
 * </ul>
 *
 * @author Jason Song(song_s@ctrip.com)
 */
public enum Env {

    LOCAL, DEV, FWS, FAT, UAT, LPT, PRO, TOOLS;

    public static Env fromString(String env) {
        Env environment = EnvUtils.transformEnv(env);
        Preconditions.checkArgument(environment != null, String.format("Env %s is invalid", env));
        return environment;
    }

}
```

ğŸ˜ å‰é¢ä¸€ç›´å¿˜è®°å¯¹ Env ä»‹ç»ï¼Œæ‰€ä»¥æœ‰äº›å¥‡æ€ªçš„æ”¾åœ¨è¿™ä¸ªä½ç½®ã€‚ä¸»è¦ç›®çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒæºç¨‹å¯¹**æœåŠ¡ç¯å¢ƒ**çš„å‘½åå’Œå®šä¹‰ã€‚

# 666. å½©è›‹

ğŸ˜ğŸ˜ğŸ˜ ç¬¬4ã€5 å°èŠ‚å†™çš„æ¯”è¾ƒç®€ç•¥ï¼Œå¦‚æœæœ‰ä¸ç†è§£çš„èƒ–å‹ï¼Œå¯ä»¥ç»™æˆ‘çš„å…¬ä¼—å·ç•™è¨€ã€‚å•¦å•¦å•¦ï¼Œæˆ‘å»åˆ·ã€Šå¤ä»‡è€…è”ç›Ÿ3ã€‹å•¦ï¼Œç¾æ»‹æ»‹ã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)


