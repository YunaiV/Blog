title: Kafka çš„ Lag è®¡ç®—è¯¯åŒºåŠæ­£ç¡®å®ç°
date: 2018-01-17
tag: 
categories: Kafka
permalink: Kafka/lag
author: æœ±å°å®
from_url: https://blog.csdn.net/u013256816/article/details/79955578
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://blog.csdn.net/u013256816/article/details/79955578 ã€Œæœ±å°å®ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [å‰è¨€](http://www.iocoder.cn/Kafka/lag)
- [æ­£æ–‡](http://www.iocoder.cn/Kafka/lag)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

## å‰è¨€

æ¶ˆæ¯å †ç§¯æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸€å¤§ç‰¹è‰²ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶çš„æµé‡å‰Šå³°ã€å†—ä½™å­˜å‚¨ç­‰åŠŸèƒ½æ­£æ˜¯å¾—ç›Šäºæ¶ˆæ¯ä¸­é—´ä»¶çš„æ¶ˆæ¯å †ç§¯èƒ½åŠ›ã€‚ç„¶è€Œæ¶ˆæ¯å †ç§¯å…¶å®æ˜¯ä¸€æŠŠäº¦æ­£äº¦é‚ªçš„åŒåˆƒå‰‘ï¼Œå¦‚æœåº”ç”¨åœºåˆä¸æ°å½“åè€Œä¼šå¯¹ä¸Šä¸‹æ¸¸çš„ä¸šåŠ¡é€ æˆä¸å¿…è¦çš„éº»çƒ¦ï¼Œæ¯”å¦‚æ¶ˆæ¯å †ç§¯åŠ¿å¿…ä¼šå½±å“ä¸Šä¸‹æ¸¸æ•´ä¸ªè°ƒç”¨é“¾çš„æ—¶æ•ˆæ€§ï¼Œæœ‰äº›ä¸­é—´ä»¶å¦‚RabbitMQåœ¨å‘ç”Ÿæ¶ˆæ¯å †ç§¯æ—¶åœ¨æŸäº›æƒ…å†µä¸‹è¿˜ä¼šå½±å“è‡ªèº«çš„æ€§èƒ½ã€‚å¯¹äºKafkaè€Œè¨€ï¼Œè™½ç„¶æ¶ˆæ¯å †ç§¯ä¸ä¼šå¯¹å…¶è‡ªèº«æ€§èƒ½å¸¦æ¥å¤šå¤§çš„å›°æ‰°ï¼Œä½†éš¾å…ä¸ä¼šå½±å“ä¸Šä¸‹æ¸¸çš„ä¸šåŠ¡ï¼Œå †ç§¯è¿‡å¤šæœ‰å¯èƒ½ä¼šé€ æˆç£ç›˜çˆ†æ»¡ï¼Œæˆ–è€…è§¦å‘æ—¥å¿—æ¸…é™¤ç­–ç•¥è€Œé€ æˆæ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€‚å¦‚ä½•åˆ©ç”¨å¥½æ¶ˆæ¯å †ç§¯è¿™æŠŠåŒåˆƒå‰‘ï¼Œç›‘æ§æ˜¯æœ€ä¸ºå…³é”®çš„ä¸€æ­¥ã€‚

## æ­£æ–‡

æ¶ˆæ¯å †ç§¯æ˜¯æ¶ˆè´¹æ»å(Lag)çš„ä¸€ç§è¡¨ç°å½¢å¼ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶æœåŠ¡ç«¯ä¸­æ‰€ç•™å­˜çš„æ¶ˆæ¯ä¸æ¶ˆè´¹æ‰çš„æ¶ˆæ¯ä¹‹é—´çš„å·®å€¼å³ä¸ºæ¶ˆæ¯å †ç§¯é‡ï¼Œä¹Ÿç§°ä¹‹ä¸ºæ¶ˆè´¹æ»å(Lag)é‡ã€‚å¯¹äºKafkaè€Œè¨€ï¼Œæ¶ˆæ¯è¢«å‘é€è‡³Topicä¸­ï¼Œè€ŒTopicåˆåˆ†æˆäº†å¤šä¸ªåˆ†åŒº(Partition)ï¼Œæ¯ä¸€ä¸ªPartitionéƒ½æœ‰ä¸€ä¸ªé¢„å†™å¼çš„æ—¥å¿—æ–‡ä»¶ï¼Œè™½ç„¶Partitionå¯ä»¥ç»§ç»­ç»†åˆ†ä¸ºè‹¥å¹²ä¸ªæ®µæ–‡ä»¶(Segment)ï¼Œä½†æ˜¯å¯¹äºä¸Šå±‚åº”ç”¨æ¥è¯´å¯ä»¥å°†Partitionçœ‹æˆæœ€å°çš„å­˜å‚¨å•å…ƒ(ä¸€ä¸ªç”±å¤šä¸ªSegmentæ–‡ä»¶æ‹¼æ¥çš„â€œå·¨å‹æ–‡ä»¶â€)ã€‚æ¯ä¸ªPartitionéƒ½ç”±ä¸€ç³»åˆ—æœ‰åºçš„ã€ä¸å¯å˜çš„æ¶ˆæ¯ç»„æˆï¼Œè¿™äº›æ¶ˆæ¯è¢«è¿ç»­çš„è¿½åŠ åˆ°Partitionä¸­ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å›¾ï¼Œå…¶å°±æ˜¯Partitionçš„ä¸€ä¸ªçœŸå®å†™ç…§ï¼š
![img](http://static.iocoder.cn/csdn/20180416011820831?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMyNTY4MTY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

ä¸Šå›¾ä¸­æœ‰å››ä¸ªæ¦‚å¿µï¼š

1. **LogStartOffset**ï¼šè¡¨ç¤ºä¸€ä¸ªPartitionçš„èµ·å§‹ä½ç§»ï¼Œåˆå§‹ä¸º0ï¼Œè™½ç„¶æ¶ˆæ¯çš„å¢åŠ ä»¥åŠæ—¥å¿—æ¸…é™¤ç­–ç•¥çš„å½±å“ï¼Œè¿™ä¸ªå€¼ä¼šé˜¶æ®µæ€§çš„å¢å¤§ã€‚
2. **ConsumerOffset**ï¼šæ¶ˆè´¹ä½ç§»ï¼Œè¡¨ç¤ºPartitionçš„æŸä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹åˆ°çš„ä½ç§»ä½ç½®ã€‚
3. **HighWatermark**ï¼šç®€ç§°HWï¼Œä»£è¡¨æ¶ˆè´¹ç«¯æ‰€èƒ½â€œè§‚å¯Ÿâ€åˆ°çš„Partitionçš„æœ€é«˜æ—¥å¿—ä½ç§»ï¼ŒHWå¤§äºç­‰äºConsumerOffsetçš„å€¼ã€‚
4. **LogEndOffset**ï¼šç®€ç§°LEO, ä»£è¡¨Partitionçš„æœ€é«˜æ—¥å¿—ä½ç§»ï¼Œå…¶å€¼å¯¹æ¶ˆè´¹è€…ä¸å¯è§ã€‚æ¯”å¦‚åœ¨ISRï¼ˆIn-Sync-Replicasï¼‰å‰¯æœ¬æ•°ç­‰äº3çš„æƒ…å†µä¸‹ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œæ¶ˆæ¯å‘é€åˆ°Leader Aä¹‹åä¼šæ›´æ–°LEOçš„å€¼ï¼ŒFollower Bå’ŒFollower Cä¹Ÿä¼šå®æ—¶æ‹‰å–Leader Aä¸­çš„æ¶ˆæ¯æ¥æ›´æ–°è‡ªå·±ï¼ŒHWå°±è¡¨ç¤ºAã€Bã€Cä¸‰è€…åŒæ—¶è¾¾åˆ°çš„æ—¥å¿—ä½ç§»ï¼Œä¹Ÿå°±æ˜¯Aã€Bã€Cä¸‰è€…ä¸­LEOæœ€å°çš„é‚£ä¸ªå€¼ã€‚ç”±äºBã€Cæ‹‰å–Aæ¶ˆæ¯ä¹‹é—´å»¶æ—¶é—®é¢˜ï¼Œæ‰€ä»¥HWå¿…ç„¶ä¸ä¼šä¸€ç›´ä¸Leaderçš„LEOç›¸ç­‰ï¼Œå³LEO>=HWã€‚
   ![img](http://static.iocoder.cn/csdn/20180416011835658?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMyNTY4MTY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

è¦è®¡ç®—Kafkaä¸­æŸä¸ªæ¶ˆè´¹è€…çš„æ»åé‡å¾ˆç®€å•ï¼Œé¦–å…ˆçœ‹çœ‹å…¶æ¶ˆè´¹äº†å‡ ä¸ªTopicï¼Œç„¶åé’ˆå¯¹æ¯ä¸ªTopicæ¥è®¡ç®—å…¶ä¸­æ¯ä¸ªPartitionçš„Lagï¼Œæ¯ä¸ªPartitionçš„Lagè®¡ç®—å°±æ˜¾å¾—éå¸¸çš„ç®€å•äº†ï¼Œå‚è€ƒä¸‹å›¾ï¼š

ç”±å›¾å¯çŸ¥æ¶ˆè´¹Lag=HW - ConsumerOffsetã€‚å¯¹äºè¿™é‡Œå¤§å®¶æœ‰å¯èƒ½æœ‰ä¸ªè¯¯åŒºï¼Œå°±æ˜¯è®¤ä¸ºLagåº”è¯¥æ˜¯LEOä¸ConsumerOffsetä¹‹é—´çš„å·®å€¼ï¼Œç¬”è€…åœ¨è¿™ä¹‹å‰ä¹ŸçŠ¯è¿‡è¿™æ ·çš„é”™è¯¯è®¤çŸ¥ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒã€Š[å¦‚ä½•ä½¿ç”¨JMXç›‘æ§Kafka](https://blog.csdn.net/u013256816/article/details/53524884)ã€‹ã€‚LEOæ˜¯å¯¹æ¶ˆè´¹è€…ä¸å¯è§çš„ï¼Œæ—¢ç„¶ä¸å¯è§ä½•æ¥æ¶ˆè´¹æ»åä¸€è¯´ã€‚

é‚£ä¹ˆè¿™é‡Œå°±å¼•å…¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼ŒHWå’ŒConsumerOffsetçš„å€¼å¦‚ä½•è·å–å‘¢ï¼Ÿ
![img](http://static.iocoder.cn/csdn/20180416011844356?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMyNTY4MTY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

é¦–å…ˆæ¥è¯´è¯´ConsumerOffsetï¼ŒKafkaä¸­æœ‰ä¸¤å¤„å¯ä»¥å­˜å‚¨ï¼Œä¸€ä¸ªæ˜¯Zookeeperï¼Œè€Œå¦ä¸€ä¸ªæ˜¯â€__consumer_offsetsè¿™ä¸ªå†…éƒ¨topicä¸­ï¼Œå‰è€…æ˜¯0.8.xç‰ˆæœ¬ä¸­çš„ä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯éšç€ç‰ˆæœ¬çš„è¿­ä»£æ›´æ–°ï¼Œç°åœ¨è¶Šæ¥è¶Šè¶‹å‘äºåè€…ã€‚å°±æ‹¿1.0.0ç‰ˆæœ¬æ¥è¯´ï¼Œè™½ç„¶é»˜è®¤æ˜¯å­˜å‚¨åœ¨â€__consumer_offsetsâ€ä¸­ï¼Œä½†æ˜¯ä¿ä¸é½ç”¨äºå°±å°†å…¶å­˜å‚¨åœ¨äº†Zookeeperä¸­äº†ã€‚è¿™ä¸ªé—®é¢˜å€’ä¹Ÿä¸éš¾è§£å†³ï¼Œé’ˆå¯¹ä¸¤ç§æ–¹å¼éƒ½å»æ‹‰å–ï¼Œç„¶åå“ªä¸ªæœ‰å€¼çš„å–å“ªä¸ªã€‚ä¸è¿‡è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¯¹äºæ¶ˆè´¹ä½ç§»æ¥è¯´ï¼Œå…¶ä¸€èˆ¬ä¸ä¼šå®æ—¶çš„æ›´æ–°ï¼Œè€Œæ›´å¤šçš„æ˜¯å®šæ—¶æ›´æ–°ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•´ä½“çš„æ€§èƒ½ã€‚é‚£ä¹ˆè¿™ä¸ªå®šæ—¶çš„æ—¶é—´é—´éš”å°±æ˜¯ConsumerOffsetçš„è¯¯å·®åŒºé—´ä¹‹ä¸€ã€‚

å†æ¥è¯´è¯´HWï¼Œå…¶ä¹Ÿæ˜¯Kafkaä¸­Partitionçš„ä¸€ä¸ªçŠ¶æ€ã€‚æœ‰å¯èƒ½ä½ ä¼šå¯Ÿè§‰åˆ°åœ¨Kafkaçš„JMXä¸­å¯ä»¥çœ‹åˆ°â€œkafka.log:type=Log,name=LogEndOffset,topic=[topic_name],partition=[partition_num]â€è¿™æ ·ä¸€ä¸ªå±æ€§ï¼Œä½†æ˜¯è¿™ä¸ªå€¼ä¸æ˜¯LEOè€Œæ˜¯HWã€‚

é‚£ä¹ˆæ€æ ·æ­£ç¡®çš„è®¡ç®—æ¶ˆè´¹çš„Lagå‘¢ï¼Ÿå¯¹Kafkaç†Ÿæ‚‰çš„åŒå­¦å¯èƒ½ä¼šæƒ³åˆ°Kafkaä¸­è‡ªå¸¦çš„kafka-consumer_groups.shè„šæœ¬ä¸­å°±æœ‰Lagçš„ä¿¡æ¯ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```shell
[root@node2 kafka_2.12-1.0.0]# bin/kafka-consumer-groups.sh --describe --bootstrap-server localhost:9092 --group CONSUMER_GROUP_ID
TOPIC                PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG        CONSUMER-ID                                       HOST                   CLIENT-ID
topic-test1          0          1648            1648            0          CLIENT_ID-e2d41f8d-dbd2-4f0e-9239-efacb55c6261    /192.168.92.1          CLIENT_ID
topic-test1          1          1648            1648            0          CLIENT_ID-e2d41f8d-dbd2-4f0e-9239-efacb55c6261    /192.168.92.1          CLIENT_ID
topic-test1          2          1648            1648            0          CLIENT_ID-e2d41f8d-dbd2-4f0e-9239-efacb55c6261    /192.168.92.1          CLIENT_ID
topic-test1          3          1648            1648            0          CLIENT_ID-e2d41f8d-dbd2-4f0e-9239-efacb55c6261    /192.168.92.1          CLIENT_ID
```

æˆ‘ä»¬æ·±ç©¶ä¸€ä¸‹kafka-consumer_groups.shè„šæœ¬ï¼Œå‘ç°åªæœ‰ä¸€å¥ä»£ç ï¼š

```shell
exec $(dirname $0)/kafka-run-class.sh kafka.admin.ConsumerGroupCommand "$@"
```

å…¶å«ä¹‰å°±æ˜¯æ‰§è¡Œkafka.admin.ConsumerGroupCommandè€Œå·²ã€‚è¿›ä¸€æ­¥æ·±ç©¶ï¼Œåœ¨ConsumerGroupCommandå†…éƒ¨æŠ“ä½äº†2å¥å…³é”®ä»£ç ï¼š

```java
val consumerGroupService = new KafkaConsumerGroupService(opts)
val (state, assignments) = consumerGroupService.describeGroup()
```

ä»£ç è¯¦è§£ï¼šconsumerGroupServiceçš„ç±»å‹æ˜¯ConsumerGroupServicesealed traitç±»å‹ï¼‰ï¼Œè€ŒKafkaConsumerGroupServiceåªæ˜¯ConsumerGroupServiceçš„ä¸€ç§å®ç°ï¼Œè¿˜æœ‰ä¸€ç§å®ç°æ˜¯ZkConsumerGroupServiceï¼Œåˆ†åˆ«å¯¹åº”æ–°ç‰ˆçš„æ¶ˆè´¹æ–¹å¼ï¼ˆæ¶ˆè´¹ä½ç§»å­˜å‚¨åœ¨__consumer_offsetsä¸­ï¼‰å’Œæ—§ç‰ˆçš„æ¶ˆè´¹æ–¹å¼ï¼ˆæ¶ˆè´¹ä½ç§»å­˜å‚¨åœ¨zkä¸­ï¼‰ï¼Œè¯¦ç»†è®¡ç®—æ­¥éª¤å‚è€ƒä¸‹ä¸€æ®µè½çš„å†…å®¹ã€‚optå‚æ•°æ˜¯æŒ‡â€œ â€“describe â€“bootstrap-server localhost:9092 â€“group CONSUMER_GROUP_IDâ€ç­‰å‚æ•°ã€‚ç¬¬2å¥ä»£ç æ˜¯è°ƒç”¨describeGroup()æ–¹æ³•æ¥è·å–å…·ä½“çš„ä¿¡æ¯ï¼Œå³äºŒå…ƒç»„ä¸­çš„assignmentsï¼Œè¿™ä¸ªassignmentsä¸­ä¿å­˜äº†ä¸Šé¢æ‰“å°ä¿¡æ¯ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚

> **Scalaå°çŸ¥è¯†ï¼š**
> åœ¨Scalaä¸­traitï¼ˆç‰¹å¾ï¼‰ç›¸å½“äºJavaçš„æ¥å£ï¼Œå®é™…ä¸Šå®ƒæ¯”æ¥å£æ›´å¤§å¼ºå¤§ã€‚ä¸Javaä¸­çš„æ¥å£ä¸åŒçš„æ˜¯ï¼Œå®ƒè¿˜å¯ä»¥å®šä¹‰å±æ€§å’Œæ–¹æ³•çš„å®ç°ï¼ˆJDK8èµ·çš„æ¥å£é»˜è®¤æ–¹æ³•ï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹Scalaä¸­çš„ç±»åªèƒ½ç»§æ‰¿å•ä¸€çˆ¶ç±»ï¼Œä½†æ˜¯å¦‚æœæ˜¯traitçš„è¯å°±å¯ä»¥ç»§æ‰¿å¤šä¸ªï¼Œä»ç»“æœæ¥çœ‹æ˜¯å®ç°äº†å¤šé‡ç»§æ‰¿ã€‚è¢«sealedå£°æ˜çš„traitä»…èƒ½è¢«åŒä¸€æ–‡ä»¶çš„ç±»ç»§æ‰¿ã€‚

ZkConsumerGroupServiceä¸­è®¡ç®—æ¶ˆè´¹lagçš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. é€šè¿‡zkè·å–ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¯¹åº”ä¸Šé¢æ‰“å°ä¿¡æ¯ä¸­çš„ï¼šTOPICã€PARTITIONã€CONSUMER-IDç­‰ï¼Œä¸è¿‡ä¸ä¼šæœ‰HOSTå’ŒCLIENT-IDã€‚
2. é€šè¿‡OffsetFetchRequestè¯·æ±‚è·å–æ¶ˆè´¹ä½ç§»ï¼ˆoffsetï¼‰ï¼Œå¦‚æœè·å–å¤±è´¥åˆ™åœ¨é€šè¿‡zkè·å–ã€‚
3. é€šè¿‡OffsetReuqestè¯·æ±‚è·å–åˆ†åŒºçš„LogEndOffsetï¼ˆç®€ç§°ä¸ºLEOï¼Œå¯è§çš„LEOï¼‰ã€‚
4. è®¡ç®—LogEndOffsetä¸æ¶ˆè´¹ä½ç§»çš„å·®å€¼æ¥è·å–lagã€‚

KafkaConsumerGroupServiceä¸­è®¡ç®—æ¶ˆè´¹lagçš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. é€šè¿‡DescibeGroupsRequestè¯·æ±‚è·å–ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œä¸ä»…åŒ…æ‹¬TOPICã€PARTITIONã€CONSUMER-IDï¼Œè¿˜æœ‰HOSTå’ŒCLIENT-IDã€‚å…¶å®è¿˜æœ‰é€šè¿‡
   FindCoordinatorRequestè¯·æ±‚æ¥è·å–coordinatorä¿¡æ¯ï¼Œå¦‚æœä¸äº†è§£coordinatoråœ¨è¿™é‡Œä¹Ÿæ²¡å½±å“ã€‚
2. é€šè¿‡OffsetFetchRequestè¯·æ±‚è·å–æ¶ˆè´¹ä½ç§»ã€‚
3. é€šè¿‡OffsetReuqestè¯·æ±‚è·å–åˆ†åŒºçš„LogEndOffsetï¼ˆç®€ç§°ä¸ºLEOï¼‰ã€‚
4. è®¡ç®—LogEndOffsetä¸æ¶ˆè´¹ä½ç§»çš„å·®å€¼æ¥è·å–lagã€‚

å¯ä»¥çœ‹åˆ°KafkaConsumerGroupServiceä¸ZkConsumerGroupServiceçš„è®¡ç®—Lagçš„æ–¹å¼éƒ½å·®ä¸å¤šï¼Œä½†æ˜¯KafkaConsumerGroupServiceèƒ½è·å–æ›´å¤šæ¶ˆè´¹è¯¦æƒ…ï¼Œå¹¶ä¸”ZkConsumerGroupServiceä¹Ÿè¢«æ ‡æ³¨ä¸º@Deprecatedçš„äº†ï¼Œåé¢å†…å®¹éƒ½é’ˆå¯¹KafkaConsumerGroupServiceæ¥åšè¯´æ˜ã€‚æ—¢ç„¶Kafkaå·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†çº¿ç¨‹çš„æ–¹æ³•æ¥è·å–Lagï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰ä½•å¿…å†é‡å¤é€ è½®å­ï¼Œè¿™é‡Œç¬”è€…å†™äº†ä¸€ä¸ªè°ƒç”¨çš„KafkaConsumerGroupServiceçš„ç¤ºä¾‹ï¼ˆKafkaConsumerGroupServiceæ˜¯ä½¿ç”¨Scalaè¯­è¨€ç¼–å†™çš„ï¼Œåœ¨Javaçš„ç¨‹åºé‡Œä½¿ç”¨ç±»ä¼¼scala.collection.Seqè¿™æ ·çš„å…¨åç§°ä»¥é˜²æ­¢æ··æ·†ï¼‰ï¼š

```java
String[] agrs = {"--describe", "--bootstrap-server", brokers, "--group", groupId};
ConsumerGroupCommand.ConsumerGroupCommandOptions opts =
        new ConsumerGroupCommand.ConsumerGroupCommandOptions(agrs);
ConsumerGroupCommand.KafkaConsumerGroupService kafkaConsumerGroupService =
        new ConsumerGroupCommand.KafkaConsumerGroupService(opts);
scala.Tuple2<scala.Option<String>, scala.Option<scala.collection.Seq<ConsumerGroupCommand
        .PartitionAssignmentState>>> res = kafkaConsumerGroupService.describeGroup();
scala.collection.Seq<ConsumerGroupCommand.PartitionAssignmentState> pasSeq = res._2.get();
scala.collection.Iterator<ConsumerGroupCommand.PartitionAssignmentState> iterable = pasSeq.iterator();
while (iterable.hasNext()) {
    ConsumerGroupCommand.PartitionAssignmentState pas = iterable.next();
    System.out.println(String.format("\n%-30s %-10s %-15s %-15s %-10s %-50s%-30s %s",
            pas.topic().get(), pas.partition().get(), pas.offset().get(),
            pas.logEndOffset().get(), pas.lag().get(), pas.consumerId().get(),
            pas.host().get(), pas.clientId().get()));
}
```

åœ¨ä½¿ç”¨æ—¶ï¼Œä½ å¯ä»¥å°è£…ä¸€ä¸‹è¿™æ®µä»£ç ç„¶åè¿”å›ä¸€ä¸ªç±»ä¼¼List<ConsumerGroupCommand.PartitionAssignmentState>çš„ä¸œè¥¿ç»™ä¸Šå±‚ä¸šåŠ¡ä»£ç åšè¿›ä¸€æ­¥çš„ä½¿ç”¨ã€‚ConsumerGroupCommand.PartitionAssignmentStateçš„ä»£ç å¦‚ä¸‹ï¼š

```java
  case class PartitionAssignmentState(
    group: String, coordinator: Option[Node], topic: Option[String],
    partition: Option[Int], offset: Option[Long], lag: Option[Long],
    consumerId: Option[String], host: Option[String],
    clientId: Option[String], logEndOffset: Option[Long])
```

> **Scalaå°çŸ¥è¯†ï¼š**
> å¯¹äºcase class, åœ¨è¿™é‡Œä½ å¯ä»¥ç®€å•çš„æŠŠå®ƒçœ‹æˆæ˜¯ä¸€ä¸ªJavaBeanï¼Œä½†æ˜¯å®ƒè¿œæ¯”JavaBeanå¼ºå¤§ï¼Œæ¯”å¦‚å®ƒä¼šè‡ªåŠ¨ç”Ÿæˆequalsã€hashCodeã€toStringã€copyã€ä¼´ç”Ÿå¯¹è±¡ã€applyã€unapplyç­‰ç­‰ä¸œè¥¿ã€‚åœ¨ scala ä¸­ï¼Œå¯¹ä¿æŠ¤ï¼ˆProtectedï¼‰æˆå‘˜çš„è®¿é—®æ¯” java æ›´ä¸¥æ ¼ä¸€äº›ã€‚å› ä¸ºå®ƒåªå…è®¸ä¿æŠ¤æˆå‘˜åœ¨å®šä¹‰äº†è¯¥æˆå‘˜çš„çš„ç±»çš„å­ç±»ä¸­è¢«è®¿é—®ã€‚è€Œåœ¨javaä¸­ï¼Œç”¨protectedå…³é”®å­—ä¿®é¥°çš„æˆå‘˜ï¼Œé™¤äº†å®šä¹‰äº†è¯¥æˆå‘˜çš„ç±»çš„å­ç±»å¯ä»¥è®¿é—®ï¼ŒåŒä¸€ä¸ªåŒ…é‡Œçš„å…¶ä»–ç±»ä¹Ÿå¯ä»¥è¿›è¡Œè®¿é—®ã€‚Scalaä¸­ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šä»»ä½•çš„ä¿®é¥°ç¬¦ï¼Œåˆ™é»˜è®¤ä¸º publicã€‚è¿™æ ·çš„æˆå‘˜åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è¢«è®¿é—®ã€‚

å¦‚æœä½ æ­£åœ¨è¯•ç€è¿è¡Œä¸Šé¢ä¸€æ®µç¨‹åºï¼Œä½ ä¼šå‘ç°ç¼–è¯‘å¤±è´¥ï¼ŒæŠ¥é”™ï¼šcannot access â€˜kafka.admin.ConsumerGroupCommand.PartitionAssignmentStateâ€™ in â€˜kafka.admin.ConsumerGroupCommandâ€˜ã€‚è¿™æ—¶å€™éœ€è¦å°†æ‰€å¼•å…¥çš„kafka.coreåŒ…ä¸­çš„kafka.admin.ConsumerGroupCommandä¸­çš„PartitionAssignmentStateç±»å‰é¢çš„protectedä¿®é¥°ç¬¦å»æ‰æ‰èƒ½ç¼–è¯‘é€šè¿‡ã€‚

ç°å®æƒ…å†µä¸‹ä½ å¯èƒ½å¹¶ä¸æƒ³å˜æ›´kafka-coreçš„ä»£ç ç„¶åå†é‡æ–°æ‰“åŒ…ï¼Œè€Œæ˜¯å¯»æ±‚ç›´æ¥èƒ½å¤Ÿè°ƒç”¨çš„ä¸œè¥¿ï¼Œè‡³äºåˆ°åº•æ€ä¹ˆå®ç°å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»ï¼Œå¦‚æœä½ æ¯”è¾ƒçŒ´æ€¥ï¼Œå¯ä»¥å…ˆé¢„è§ˆä¸€ä¸‹ä»£ç çš„å®ç°ï¼Œå…·ä½“å‚è§ï¼š<https://github.com/hiddenzzh/kafka/blob/master/src/main/java/com/hidden/custom/kafka/admin/KafkaConsumerGroupCustomService.java>ã€‚è¯¦ç»†çš„é€»è¾‘è§£ææ•¬è¯·æœŸå¾…â€¦.

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Kafka å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)