title: å†çœ‹ Kafka Lag
date: 2018-01-21
tag: 
categories: Kafka
permalink: Kafka/lag-2
author: æœ±å°å®
from_url: https://blog.csdn.net/u013256816/article/details/80032594
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://blog.csdn.net/u013256816/article/details/80032594 ã€Œæœ±å°å®ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

åœ¨ã€Š[Kafkaçš„Lagè®¡ç®—è¯¯åŒºåŠæ­£ç¡®å®ç°](https://blog.csdn.net/u013256816/article/details/79955578)ã€‹ä¸€æ–‡ä¸­æåŠäº†kafka.admin.ConsumerGroupCommand.PartitionAssignmentStateæ— æ³•è¢«å¤–éƒ¨è®¿é—®ï¼Œæ•…è¦ä¹ˆå°†PartitionAssignmentStateå‰çš„protectedä¿®é¥°ç¬¦å»æ‰ï¼Œè¦ä¹ˆåƒã€Š[ å¦‚ä½•è·å–Kafkaçš„æ¶ˆè´¹è€…è¯¦æƒ…](https://blog.csdn.net/u013256816/article/details/79968647)ã€‹å’Œã€Š[é›†ç¾¤ç®¡ç†å·¥å…·KafkaAdminClientâ€”â€”æ”¹é€ ](https://blog.csdn.net/u013256816/article/details/79996138)ã€‹è¿™ä¸¤ç¯‡è¿™æ ·æ¥å®ç°ï¼Œä½†æ˜¯çœŸçš„éœ€è¦è¿™æ ·å­åšä¹ˆï¼Ÿ

å¯ä»¥ç›´æ¥å°†describeGroupè¿”å›çš„ç»“æœè½¬æ¢æˆJSONç„¶åä¼ è‡³ç›‘æ§é¡µé¢ï¼ˆsupported by YANGliiN obaï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
String[] agrs = {"--describe", "--bootstrap-server", brokers, "--group", groupId};
ConsumerGroupCommand.ConsumerGroupCommandOptions options =
        new ConsumerGroupCommand.ConsumerGroupCommandOptions(agrs);
ConsumerGroupCommand.KafkaConsumerGroupService kafkaConsumerGroupService =
        new ConsumerGroupCommand.KafkaConsumerGroupService(options);
ObjectMapper mapper = new ObjectMapper();
//1. ä½¿ç”¨jackson-module-scala_2.12
mapper.registerModule(new DefaultScalaModule());
//2. ååºåˆ—åŒ–æ—¶å¿½ç•¥å¯¹è±¡ä¸å­˜åœ¨çš„å±æ€§
mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
//3. å°†Scalaå¯¹è±¡åºåˆ—åŒ–æˆJSONå­—ç¬¦ä¸²
String source = mapper.writeValueAsString(kafkaConsumerGroupService.describeGroup()._2.get());
```

è¿™é‡Œéœ€è¦é‡‡ç”¨çš„æ˜¯jackson-module-scalaçš„åŒ…å®ç°ï¼Œå¦‚æœç›´æ¥ç”¨æ™®é€šçš„JSONåºåˆ—åŒ–æ–¹å¼é‚£ä¹ˆä¼šè¾¾ä¸åˆ°æƒ³è¦çš„æ•ˆæœï¼Œjacksonä»¥åŠjackson-module-scalaå¯¹åº”çš„Mavenåº“å¦‚ä¸‹ï¼š

```XML
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-core</artifactId>
    <version>2.9.4</version>
</dependency>
<dependency>
    <groupId>com.fasterxml.jackson.module</groupId>
    <artifactId>jackson-module-scala_2.12</artifactId>
    <version>2.9.5</version>
</dependency>
```

æ³¨æ„å¦‚æœæœ¬åœ°å®‰è£…çš„Scalaç‰ˆæœ¬ä¸æ‰€é…ç½®çš„jackson-module-scalaç‰ˆæœ¬ä¸ä¸€è‡´çš„è¯ä¼šæŠ¥å‡ºä¸€äº›å¼‚å¸¸ã€‚å‘æ•£ä¸€ä¸‹æ€ç»´ï¼šæ—¢ç„¶å¯ä»¥åºåˆ—åŒ–ä¸ºJSONï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥é€šè¿‡JSONå†ååºåˆ—åŒ–ä¼šå¯¹è±¡ï¼Œåªä¸è¿‡é€šè¿‡JSONä½œä¸ºä¸­é—´åª’ä»‹ï¼Œå°†è®¿é—®å—é™çš„Scalaå¯¹è±¡è½¬å˜ä¸ºJavaå¯¹è±¡ï¼Œä¸Šé¢å‰©ä½™ä»£ç å¦‚ä¸‹ï¼š

```java
//4. å°†JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–æˆJavaå¯¹è±¡
List<PartitionAssignmentState> target = mapper.readValue(source,
        getCollectionType(mapper,List.class,PartitionAssignmentState.class));
//5. æ’åº
target.sort((o1, o2) -> o1.getPartition() - o2.getPartition());
//6. æ‰“å°
printPasList(target);
```

å¦‚æ­¤å°±å¯ä»¥è¾¾åˆ°ä¸å‰é¢å‡ ç¯‡æ–‡ç« ä¸­å…³äºè·å–æ¶ˆè´¹è€…è¯¦æƒ…åŠŸèƒ½åŒæ ·çš„æ•ˆæœã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªæ³¨æ„è¦ç‚¹ï¼š

1. PartitionAssignmentStateä¸­çš„coordinatoræ˜¯Nodeç±»å‹ï¼Œè¿™ä¸ªç±»å‹éœ€è¦è‡ªå®šä¹‰ï¼ŒKafkaåŸç”Ÿçš„ä¼šæŠ¥é”™ã€‚
2. ååºåˆ—åŒ–æ—¶Nodeä¼šæœ‰ä¸€ä¸ªemptyçš„å±æ€§ä¸è¯†åˆ«ï¼Œè§£å†³æ–¹æ¡ˆå‚è€ƒä»£ç ä¸­çš„æ­¥éª¤2.

ä»£ç æ›´å¤šç»†èŠ‚è¯·å‚è€ƒï¼š<https://github.com/hiddenzzh/kafka/blob/master/src/main/java/com/hidden/custom/kafka/admin/KafkaConsumerGroupScalaService.java>

é€šè¿‡JSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œå®ç°äº†åŸæœ¬ä¸èƒ½ä¸ºä¹‹çš„äº‹æƒ…ï¼Œé‚£ä¹ˆæ€ç»´å†å‘æ•£ä¸€ä¸‹ï¼Œä¹Ÿå¯ä»¥åºåˆ—åŒ–æˆå­—èŠ‚æµï¼Œæ¯”å¦‚é€šè¿‡ByteBufferè¿›è¡Œè½¬æ¢ï¼Œåªä¸è¿‡ç¼–ç¨‹é€»è¾‘å˜å¾—å¤æ‚äº†ã€‚

ä¸Šé¢è¿™æ®µé™ˆè¿°æœ‰å¯èƒ½ä¼šè®©äººè§‰å¾—Scalaä¸Javaä¹‹é—´çš„äº’æ“ä½œèµ·æ¥ä¸å®¹æ˜“ï¼Œå…¶å®ä¸ç„¶ï¼Œä¸Šé¢è¿™æ®µé™ˆè¿°åªæ˜¯ç”¨æ¥è¡¥å……ä¸€ä¸‹å¦‚ä½•è·å–æ¶ˆè´¹è€…è¯¦æƒ…çš„å¦ä¸€ç§æ–¹æ³•ï¼ŒScalaä¸Javaä¹‹é—´çš„äº’æ“ä½œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨å¯¹æ–¹çš„ç±»ã€‚å¯¹äºé›†åˆè€Œè¨€ï¼ŒScalaä¸­è¿˜æœ‰ç”¨äºScalaä¸Javaé›†åˆçš„äº’è½¬çš„scala.collection.JavaConvertersï¼ˆscala2.8.1å¼€å§‹å¼•å…¥ï¼‰ï¼Œä¸æ­¤é›·åŒçš„scala.collection.JavaConversionså·²è¢«æ ‡æ³¨ä¸º@Deprecatedï¼ˆsince 2.12.0ï¼‰ã€‚åœ¨scalaä»£ç ä¸­å¦‚æœéœ€è¦é›†åˆè½¬æ¢ï¼Œé¦–å…ˆå¼•å…¥scala.collection.JavaConverters._ï¼Œè¿›è€Œæ˜¾ç¤ºè°ƒç”¨asJavaæˆ–è€…asScalaæ–¹æ³•å®Œæˆè½¬å‹ã€‚å…³äºScalaä¸Javaé›†åˆäº’è½¬çš„ä»‹ç»ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å‘ˆç°ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Kafka å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)