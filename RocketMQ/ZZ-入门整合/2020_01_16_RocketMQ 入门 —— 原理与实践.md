title: RocketMQ å…¥é—¨ â€”â€” åŸç†ä¸å®è·µ
date: 2020-01-16
tags:
categories: RocketMQ
permalink: RocketMQ/start/Principle-and-practice
author: CHENå·
from_url: https://www.jianshu.com/p/453c6e7ff81c

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/453c6e7ff81c ã€ŒCHENå·ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [å…³é”®ç‰¹æ€§ä»¥åŠå…¶å®ç°åŸç†](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [ä¸€ã€é¡ºåºæ¶ˆæ¯](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [äºŒã€æ¶ˆæ¯é‡å¤](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [ä¸‰ã€äº‹åŠ¡æ¶ˆæ¯](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [å››ã€Producerå¦‚ä½•å‘é€æ¶ˆæ¯](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [äº”ã€æ¶ˆæ¯å­˜å‚¨](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [å…­ã€æ¶ˆæ¯è®¢é˜…](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [ä¸ƒã€RocketMQçš„å…¶ä»–ç‰¹æ€§](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
- [RocketMQæœ€ä½³å®è·µ](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [ä¸€ã€Produceræœ€ä½³å®è·µ](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [äºŒã€Consumeræœ€ä½³å®è·µ](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
  - [ä¸‰ã€å…¶ä»–é…ç½®](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
- [RocketMQè®¾è®¡ç›¸å…³](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)
- [å‚è€ƒèµ„æ–™](http://www.iocoder.cn/RocketMQ/start/Principle-and-practice/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

> è¿™ç¯‡æ–‡ç« å†™æˆè·ä»Š(201808)å·²ç»ä¸¤å¹´åŠäº†ï¼Œå…¶ä¸­çš„å†…å®¹æˆ‘å·²ç»ä¸èƒ½ä¿è¯æ˜¯å¦å·²ç»è¿‡æ—¶ï¼Œç”±äºå½“å‰çš„ä¸šåŠ¡ä¸­ä¹Ÿæ²¡æœ‰åœ¨ä½¿ç”¨RocketMQï¼Œå› æ­¤å¾ˆå°‘æœ‰æ—¶é—´å†å»åˆ¨ä»£ç ï¼Œå¾ˆå¤šå®è·µæ–¹é¢çš„é—®é¢˜ä¹Ÿä¸èƒ½å¾ˆå¥½çš„ä¸ºå¤§å®¶è§£å†³ã€‚å› æ­¤ï¼Œå»ºè®®å¤§å®¶æƒå½“å…¥é—¨æ–‡ç« çœ‹çœ‹ï¼Œå®è·µä¸­é‡åˆ°é—®é¢˜çš„è¯ï¼Œåœ¨æœ¬æœºè·‘ä¸€è·‘ä»£ç ä¸”è°ƒè¯•ä¸€ä¸‹ï¼Œæˆ–è€…å»ç¤¾åŒºé€›é€›ï¼Œæœ‰å¯èƒ½å¯¹ä½ è§£å†³é—®é¢˜çš„å¸®åŠ©ä¼šå¤§ä¸€äº›ã€‚å½“ç„¶ç®€å•çš„é—®é¢˜ï¼Œæˆ‘ä¼šå°½åŠ›å’Œå¤§å®¶äº¤æµï¼Œè°¢è°¢å¤§å®¶ã€‚

åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿä½œä¸ºå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿå¯æ‰©å±•ã€å¯ä¼¸ç¼©æ€§çš„å…³é”®ç»„ä»¶ï¼Œéœ€è¦å…·æœ‰é«˜ååé‡ã€é«˜å¯ç”¨ç­‰ç‰¹ç‚¹ã€‚è€Œè°ˆåˆ°æ¶ˆæ¯ç³»ç»Ÿçš„è®¾è®¡ï¼Œå°±å›é¿ä¸äº†ä¸¤ä¸ªé—®é¢˜ï¼š

> 1. æ¶ˆæ¯çš„é¡ºåºé—®é¢˜
> 2. æ¶ˆæ¯çš„é‡å¤é—®é¢˜

RocketMQä½œä¸ºé˜¿é‡Œå¼€æºçš„ä¸€æ¬¾é«˜æ€§èƒ½ã€é«˜ååé‡çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæ˜¯æ€æ ·æ¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜çš„ï¼ŸRocketMQ æœ‰å“ªäº›å…³é”®ç‰¹æ€§ï¼Ÿå…¶å®ç°åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ

# å…³é”®ç‰¹æ€§ä»¥åŠå…¶å®ç°åŸç†

## ä¸€ã€é¡ºåºæ¶ˆæ¯

æ¶ˆæ¯æœ‰åºæŒ‡çš„æ˜¯å¯ä»¥æŒ‰ç…§æ¶ˆæ¯çš„å‘é€é¡ºåºæ¥æ¶ˆè´¹ã€‚ä¾‹å¦‚ï¼šä¸€ç¬”è®¢å•äº§ç”Ÿäº† 3 æ¡æ¶ˆæ¯ï¼Œåˆ†åˆ«æ˜¯è®¢å•åˆ›å»ºã€è®¢å•ä»˜æ¬¾ã€è®¢å•å®Œæˆã€‚æ¶ˆè´¹æ—¶ï¼Œè¦æŒ‰ç…§é¡ºåºä¾æ¬¡æ¶ˆè´¹æ‰æœ‰æ„ä¹‰ã€‚ä¸æ­¤åŒæ—¶å¤šç¬”è®¢å•ä¹‹é—´åˆæ˜¯å¯ä»¥å¹¶è¡Œæ¶ˆè´¹çš„ã€‚é¦–å…ˆæ¥çœ‹å¦‚ä¸‹ç¤ºä¾‹ï¼š

å‡å¦‚ç”Ÿäº§è€…äº§ç”Ÿäº†2æ¡æ¶ˆæ¯ï¼šM1ã€M2ï¼Œè¦ä¿è¯è¿™ä¸¤æ¡æ¶ˆæ¯çš„é¡ºåºï¼Œåº”è¯¥æ€æ ·åšï¼Ÿä½ è„‘ä¸­æƒ³åˆ°çš„å¯èƒ½æ˜¯è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-303b6e1322576021.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/739/format/jpg)

ä½ å¯èƒ½ä¼šé‡‡ç”¨è¿™ç§æ–¹å¼ä¿è¯æ¶ˆæ¯é¡ºåº

å‡å®šM1å‘é€åˆ°S1ï¼ŒM2å‘é€åˆ°S2ï¼Œå¦‚æœè¦ä¿è¯M1å…ˆäºM2è¢«æ¶ˆè´¹ï¼Œé‚£ä¹ˆéœ€è¦M1åˆ°è¾¾æ¶ˆè´¹ç«¯è¢«æ¶ˆè´¹åï¼Œé€šçŸ¥S2ï¼Œç„¶åS2å†å°†M2å‘é€åˆ°æ¶ˆè´¹ç«¯ã€‚

è¿™ä¸ªæ¨¡å‹å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœM1å’ŒM2åˆ†åˆ«å‘é€åˆ°ä¸¤å°Serverä¸Šï¼Œå°±ä¸èƒ½ä¿è¯M1å…ˆè¾¾åˆ°MQé›†ç¾¤ï¼Œä¹Ÿä¸èƒ½ä¿è¯M1è¢«å…ˆæ¶ˆè´¹ã€‚æ¢ä¸ªè§’åº¦çœ‹ï¼Œå¦‚æœM2å…ˆäºM1è¾¾åˆ°MQé›†ç¾¤ï¼Œç”šè‡³M2è¢«æ¶ˆè´¹åï¼ŒM1æ‰è¾¾åˆ°æ¶ˆè´¹ç«¯ï¼Œè¿™æ—¶æ¶ˆæ¯ä¹Ÿå°±ä¹±åºäº†ï¼Œè¯´æ˜ä»¥ä¸Šæ¨¡å‹æ˜¯ä¸èƒ½ä¿è¯æ¶ˆæ¯çš„é¡ºåºçš„ã€‚å¦‚ä½•æ‰èƒ½åœ¨MQé›†ç¾¤ä¿è¯æ¶ˆæ¯çš„é¡ºåºï¼Ÿä¸€ç§ç®€å•çš„æ–¹å¼å°±æ˜¯å°†M1ã€M2å‘é€åˆ°åŒä¸€ä¸ªServerä¸Šï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-886b25d2ced8e641.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/746/format/jpg)

ä¿è¯æ¶ˆæ¯é¡ºåºï¼Œä½ æ”¹è¿›åçš„æ–¹æ³•

è¿™æ ·å¯ä»¥ä¿è¯M1å…ˆäºM2åˆ°è¾¾MQServerï¼ˆç”Ÿäº§è€…ç­‰å¾…M1å‘é€æˆåŠŸåå†å‘é€M2ï¼‰ï¼Œæ ¹æ®å…ˆè¾¾åˆ°å…ˆè¢«æ¶ˆè´¹çš„åŸåˆ™ï¼ŒM1ä¼šå…ˆäºM2è¢«æ¶ˆè´¹ï¼Œè¿™æ ·å°±ä¿è¯äº†æ¶ˆæ¯çš„é¡ºåºã€‚

è¿™ä¸ªæ¨¡å‹ä¹Ÿä»…ä»…æ˜¯ç†è®ºä¸Šå¯ä»¥ä¿è¯æ¶ˆæ¯çš„é¡ºåºï¼Œåœ¨å®é™…åœºæ™¯ä¸­å¯èƒ½ä¼šé‡åˆ°ä¸‹é¢çš„é—®é¢˜ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-34c5c00c2490136b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/742/format/jpg)

ç½‘ç»œå»¶è¿Ÿé—®é¢˜

åªè¦å°†æ¶ˆæ¯ä»ä¸€å°æœåŠ¡å™¨å‘å¾€å¦ä¸€å°æœåŠ¡å™¨ï¼Œå°±ä¼šå­˜åœ¨ç½‘ç»œå»¶è¿Ÿé—®é¢˜ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœå‘é€M1è€—æ—¶å¤§äºå‘é€M2çš„è€—æ—¶ï¼Œé‚£ä¹ˆM2å°±ä»å°†è¢«å…ˆæ¶ˆè´¹ï¼Œä»ç„¶ä¸èƒ½ä¿è¯æ¶ˆæ¯çš„é¡ºåºã€‚å³ä½¿M1å’ŒM2åŒæ—¶åˆ°è¾¾æ¶ˆè´¹ç«¯ï¼Œç”±äºä¸æ¸…æ¥šæ¶ˆè´¹ç«¯1å’Œæ¶ˆè´¹ç«¯2çš„è´Ÿè½½æƒ…å†µï¼Œä»ç„¶æœ‰å¯èƒ½å‡ºç°M2å…ˆäºM1è¢«æ¶ˆè´¹çš„æƒ…å†µã€‚

é‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿå°†M1å’ŒM2å‘å¾€åŒä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä¸”å‘é€M1åï¼Œéœ€è¦æ¶ˆè´¹ç«¯å“åº”æˆåŠŸåæ‰èƒ½å‘é€M2ã€‚

èªæ˜çš„ä½ å¯èƒ½å·²ç»æƒ³åˆ°å¦å¤–çš„é—®é¢˜ï¼šå¦‚æœM1è¢«å‘é€åˆ°æ¶ˆè´¹ç«¯åï¼Œæ¶ˆè´¹ç«¯1æ²¡æœ‰å“åº”ï¼Œé‚£æ˜¯ç»§ç»­å‘é€M2å‘¢ï¼Œè¿˜æ˜¯é‡æ–°å‘é€M1ï¼Ÿä¸€èˆ¬ä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸€å®šè¢«æ¶ˆè´¹ï¼Œè‚¯å®šä¼šé€‰æ‹©é‡å‘M1åˆ°å¦å¤–ä¸€ä¸ªæ¶ˆè´¹ç«¯2ï¼Œå°±å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚



![img](https:////upload-images.jianshu.io/upload_images/175724-78a8706b4614440e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/741/format/jpg)

ä¿è¯æ¶ˆæ¯é¡ºåºçš„æ­£ç¡®å§¿åŠ¿

è¿™æ ·çš„æ¨¡å‹å°±ä¸¥æ ¼ä¿è¯æ¶ˆæ¯çš„é¡ºåºï¼Œç»†å¿ƒçš„ä½ ä»ç„¶ä¼šå‘ç°é—®é¢˜ï¼Œæ¶ˆè´¹ç«¯1æ²¡æœ‰å“åº”Serveræ—¶æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯M1ç¡®å®æ²¡æœ‰åˆ°è¾¾(æ•°æ®åœ¨ç½‘ç»œä¼ é€ä¸­ä¸¢å¤±)ï¼Œå¦å¤–ä¸€ç§æ¶ˆè´¹ç«¯å·²ç»æ¶ˆè´¹M1ä¸”å·²ç»å‘é€å“åº”æ¶ˆæ¯ï¼Œåªæ˜¯MQ Serverç«¯æ²¡æœ‰æ”¶åˆ°ã€‚å¦‚æœæ˜¯ç¬¬äºŒç§æƒ…å†µï¼Œé‡å‘M1ï¼Œå°±ä¼šé€ æˆM1è¢«é‡å¤æ¶ˆè´¹ã€‚ä¹Ÿå°±å¼•å…¥äº†æˆ‘ä»¬è¦è¯´çš„ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæ¶ˆæ¯é‡å¤é—®é¢˜ï¼Œè¿™ä¸ªåæ–‡ä¼šè¯¦ç»†è®²è§£ã€‚

å›è¿‡å¤´æ¥çœ‹æ¶ˆæ¯é¡ºåºé—®é¢˜ï¼Œä¸¥æ ¼çš„é¡ºåºæ¶ˆæ¯éå¸¸å®¹æ˜“ç†è§£ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ–‡ä¸­æ‰€æè¿°çš„æ–¹å¼æ¥ç®€å•å¤„ç†ã€‚æ€»ç»“èµ·æ¥ï¼Œè¦å®ç°ä¸¥æ ¼çš„é¡ºåºæ¶ˆæ¯ï¼Œç®€å•ä¸”å¯è¡Œçš„åŠæ³•å°±æ˜¯ï¼š

> ä¿è¯`ç”Ÿäº§è€… - MQServer - æ¶ˆè´¹è€…`æ˜¯ä¸€å¯¹ä¸€å¯¹ä¸€çš„å…³ç³»

è¿™æ ·çš„è®¾è®¡è™½ç„¶ç®€å•æ˜“è¡Œï¼Œä½†ä¹Ÿä¼šå­˜åœ¨ä¸€äº›å¾ˆä¸¥é‡çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š

> 1. å¹¶è¡Œåº¦å°±ä¼šæˆä¸ºæ¶ˆæ¯ç³»ç»Ÿçš„ç“¶é¢ˆï¼ˆååé‡ä¸å¤Ÿï¼‰
> 2. æ›´å¤šçš„å¼‚å¸¸å¤„ç†ï¼Œæ¯”å¦‚ï¼šåªè¦æ¶ˆè´¹ç«¯å‡ºç°é—®é¢˜ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªå¤„ç†æµç¨‹é˜»å¡ï¼Œæˆ‘ä»¬ä¸å¾—ä¸èŠ±è´¹æ›´å¤šçš„ç²¾åŠ›æ¥è§£å†³é˜»å¡çš„é—®é¢˜ã€‚

ä½†æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯è¦é›†ç¾¤çš„é«˜å®¹é”™æ€§å’Œé«˜ååé‡ã€‚è¿™ä¼¼ä¹æ˜¯ä¸€å¯¹ä¸å¯è°ƒå’Œçš„çŸ›ç›¾ï¼Œé‚£ä¹ˆé˜¿é‡Œæ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ

> ä¸–ç•Œä¸Šè§£å†³ä¸€ä¸ªè®¡ç®—æœºé—®é¢˜æœ€ç®€å•çš„æ–¹æ³•ï¼šâ€œæ°å¥½â€ä¸éœ€è¦è§£å†³å®ƒï¼â€”â€” [æ²ˆè¯¢](http://i.youku.com/u/UMTcwMTg3NDc1Mg==?from=113-2-1-2)

æœ‰äº›é—®é¢˜ï¼Œçœ‹èµ·æ¥å¾ˆé‡è¦ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥é€šè¿‡**åˆç†çš„è®¾è®¡**æˆ–è€…**å°†é—®é¢˜åˆ†è§£**æ¥è§„é¿ã€‚å¦‚æœç¡¬è¦æŠŠæ—¶é—´èŠ±åœ¨è§£å†³é—®é¢˜æœ¬èº«ï¼Œå®é™…ä¸Šä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”ä¹Ÿæ˜¯ä¸€ç§æµªè´¹ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹æ¶ˆæ¯çš„é¡ºåºé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸¤ä¸ªç»“è®ºï¼š

> 1. ä¸å…³æ³¨ä¹±åºçš„åº”ç”¨å®é™…å¤§é‡å­˜åœ¨
> 2. é˜Ÿåˆ—æ— åºå¹¶ä¸æ„å‘³ç€æ¶ˆæ¯æ— åº

æ‰€ä»¥ä»ä¸šåŠ¡å±‚é¢æ¥ä¿è¯æ¶ˆæ¯çš„é¡ºåºè€Œä¸ä»…ä»…æ˜¯ä¾èµ–äºæ¶ˆæ¯ç³»ç»Ÿï¼Œæ˜¯ä¸æ˜¯æˆ‘ä»¬åº”è¯¥å¯»æ±‚çš„ä¸€ç§æ›´åˆç†çš„æ–¹å¼ï¼Ÿ

æœ€åæˆ‘ä»¬ä»æºç è§’åº¦åˆ†æRocketMQæ€ä¹ˆå®ç°å‘é€é¡ºåºæ¶ˆæ¯ã€‚

RocketMQé€šè¿‡è½®è¯¢æ‰€æœ‰é˜Ÿåˆ—çš„æ–¹å¼æ¥ç¡®å®šæ¶ˆæ¯è¢«å‘é€åˆ°å“ªä¸€ä¸ªé˜Ÿåˆ—ï¼ˆè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼‰ã€‚æ¯”å¦‚ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œè®¢å•å·ç›¸åŒçš„æ¶ˆæ¯ä¼šè¢«å…ˆåå‘é€åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼š

```Java
// RocketMQé€šè¿‡MessageQueueSelectorä¸­å®ç°çš„ç®—æ³•æ¥ç¡®å®šæ¶ˆæ¯å‘é€åˆ°å“ªä¸€ä¸ªé˜Ÿåˆ—ä¸Š
// RocketMQé»˜è®¤æä¾›äº†ä¸¤ç§MessageQueueSelectorå®ç°ï¼šéšæœº/Hash
// å½“ç„¶ä½ å¯ä»¥æ ¹æ®ä¸šåŠ¡å®ç°è‡ªå·±çš„MessageQueueSelectoræ¥å†³å®šæ¶ˆæ¯æŒ‰ç…§ä½•ç§ç­–ç•¥å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­
SendResult sendResult = producer.send(msg, new MessageQueueSelector() {
    @Override
    public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {
        Integer id = (Integer) arg;
        int index = id % mqs.size();
        return mqs.get(index);
    }
}, orderId);
```

åœ¨è·å–åˆ°è·¯ç”±ä¿¡æ¯ä»¥åï¼Œä¼šæ ¹æ®`MessageQueueSelector`å®ç°çš„ç®—æ³•æ¥é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€ä¸ªOrderIdè·å–åˆ°çš„è‚¯å®šæ˜¯åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚

```Java
private SendResult send()  {
    // è·å–topicè·¯ç”±ä¿¡æ¯
    TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());
    if (topicPublishInfo != null && topicPublishInfo.ok()) {
        MessageQueue mq = null;
        // æ ¹æ®æˆ‘ä»¬çš„ç®—æ³•ï¼Œé€‰æ‹©ä¸€ä¸ªå‘é€é˜Ÿåˆ—
        // è¿™é‡Œçš„arg = orderId
        mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);
        if (mq != null) {
            return this.sendKernelImpl(msg, mq, communicationMode, sendCallback, timeout);
        }
    }
}
```

## äºŒã€æ¶ˆæ¯é‡å¤

ä¸Šé¢åœ¨è§£å†³æ¶ˆæ¯é¡ºåºé—®é¢˜æ—¶ï¼Œå¼•å…¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå°±æ˜¯æ¶ˆæ¯é‡å¤ã€‚é‚£ä¹ˆRocketMQæ˜¯æ€æ ·è§£å†³æ¶ˆæ¯é‡å¤çš„é—®é¢˜å‘¢ï¼Ÿè¿˜æ˜¯â€œæ°å¥½â€ä¸è§£å†³ã€‚

é€ æˆæ¶ˆæ¯é‡å¤çš„æ ¹æœ¬åŸå› æ˜¯ï¼šç½‘ç»œä¸å¯è¾¾ã€‚åªè¦é€šè¿‡ç½‘ç»œäº¤æ¢æ•°æ®ï¼Œå°±æ— æ³•é¿å…è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±æ˜¯ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚é‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†ï¼šå¦‚æœæ¶ˆè´¹ç«¯æ”¶åˆ°ä¸¤æ¡ä¸€æ ·çš„æ¶ˆæ¯ï¼Œåº”è¯¥æ€æ ·å¤„ç†ï¼Ÿ

> 1. æ¶ˆè´¹ç«¯å¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘ä¿æŒå¹‚ç­‰æ€§
> 2. ä¿è¯æ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€ç¼–å·ä¸”ä¿è¯æ¶ˆæ¯å¤„ç†æˆåŠŸä¸å»é‡è¡¨çš„æ—¥å¿—åŒæ—¶å‡ºç°

ç¬¬1æ¡å¾ˆå¥½ç†è§£ï¼Œåªè¦ä¿æŒå¹‚ç­‰æ€§ï¼Œä¸ç®¡æ¥å¤šå°‘æ¡é‡å¤æ¶ˆæ¯ï¼Œæœ€åå¤„ç†çš„ç»“æœéƒ½ä¸€æ ·ã€‚ç¬¬2æ¡åŸç†å°±æ˜¯åˆ©ç”¨ä¸€å¼ æ—¥å¿—è¡¨æ¥è®°å½•å·²ç»å¤„ç†æˆåŠŸçš„æ¶ˆæ¯çš„IDï¼Œå¦‚æœæ–°åˆ°çš„æ¶ˆæ¯IDå·²ç»åœ¨æ—¥å¿—è¡¨ä¸­ï¼Œé‚£ä¹ˆå°±ä¸å†å¤„ç†è¿™æ¡æ¶ˆæ¯ã€‚

ç¬¬1æ¡è§£å†³æ–¹æ¡ˆï¼Œå¾ˆæ˜æ˜¾åº”è¯¥åœ¨æ¶ˆè´¹ç«¯å®ç°ï¼Œä¸å±äºæ¶ˆæ¯ç³»ç»Ÿè¦å®ç°çš„åŠŸèƒ½ã€‚ç¬¬2æ¡å¯ä»¥æ¶ˆæ¯ç³»ç»Ÿå®ç°ï¼Œä¹Ÿå¯ä»¥ä¸šåŠ¡ç«¯å®ç°ã€‚æ­£å¸¸æƒ…å†µä¸‹å‡ºç°é‡å¤æ¶ˆæ¯çš„æ¦‚ç‡å…¶å®å¾ˆå°ï¼Œå¦‚æœç”±æ¶ˆæ¯ç³»ç»Ÿæ¥å®ç°çš„è¯ï¼Œè‚¯å®šä¼šå¯¹æ¶ˆæ¯ç³»ç»Ÿçš„ååé‡å’Œé«˜å¯ç”¨æœ‰å½±å“ï¼Œæ‰€ä»¥æœ€å¥½è¿˜æ˜¯ç”±ä¸šåŠ¡ç«¯è‡ªå·±å¤„ç†æ¶ˆæ¯é‡å¤çš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯RocketMQä¸è§£å†³æ¶ˆæ¯é‡å¤çš„é—®é¢˜çš„åŸå› ã€‚

**RocketMQä¸ä¿è¯æ¶ˆæ¯ä¸é‡å¤ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡éœ€è¦ä¿è¯ä¸¥æ ¼çš„ä¸é‡å¤æ¶ˆæ¯ï¼Œéœ€è¦ä½ è‡ªå·±åœ¨ä¸šåŠ¡ç«¯å»é‡ã€‚**

## ä¸‰ã€äº‹åŠ¡æ¶ˆæ¯

RocketMQé™¤äº†æ”¯æŒæ™®é€šæ¶ˆæ¯ï¼Œé¡ºåºæ¶ˆæ¯ï¼Œå¦å¤–è¿˜æ”¯æŒäº‹åŠ¡æ¶ˆæ¯ã€‚é¦–å…ˆè®¨è®ºä¸€ä¸‹ä»€ä¹ˆæ˜¯äº‹åŠ¡æ¶ˆæ¯ä»¥åŠæ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„å¿…è¦æ€§ã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªè½¬å¸çš„åœºæ™¯ä¸ºä¾‹æ¥è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼šBobå‘Smithè½¬è´¦100å—ã€‚

åœ¨å•æœºç¯å¢ƒä¸‹ï¼Œæ‰§è¡Œäº‹åŠ¡çš„æƒ…å†µï¼Œå¤§æ¦‚æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-13a6d80b21345f45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/479/format/jpg)

å•æœºç¯å¢ƒä¸‹è½¬è´¦äº‹åŠ¡ç¤ºæ„å›¾

å½“ç”¨æˆ·å¢é•¿åˆ°ä¸€å®šç¨‹åº¦ï¼ŒBobå’ŒSmithçš„è´¦æˆ·åŠä½™é¢ä¿¡æ¯å·²ç»ä¸åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šäº†ï¼Œé‚£ä¹ˆä¸Šé¢çš„æµç¨‹å°±å˜æˆäº†è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-69101aad0122572b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/458/format/jpg)

é›†ç¾¤ç¯å¢ƒä¸‹è½¬è´¦äº‹åŠ¡ç¤ºæ„å›¾

è¿™æ—¶å€™ä½ ä¼šå‘ç°ï¼ŒåŒæ ·æ˜¯ä¸€ä¸ªè½¬è´¦çš„ä¸šåŠ¡ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œè€—æ—¶å±…ç„¶æˆå€çš„å¢é•¿ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸èƒ½å¤Ÿæ¥å—çš„ã€‚é‚£å¦‚ä½•æ¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼Ÿ

> **å¤§äº‹åŠ¡ = å°äº‹åŠ¡ + å¼‚æ­¥**

å°†å¤§äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°äº‹åŠ¡å¼‚æ­¥æ‰§è¡Œã€‚è¿™æ ·åŸºæœ¬ä¸Šèƒ½å¤Ÿå°†è·¨æœºäº‹åŠ¡çš„æ‰§è¡Œæ•ˆç‡ä¼˜åŒ–åˆ°ä¸å•æœºä¸€è‡´ã€‚è½¬è´¦çš„äº‹åŠ¡å°±å¯ä»¥åˆ†è§£æˆå¦‚ä¸‹ä¸¤ä¸ªå°äº‹åŠ¡ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-92abb226f288ff9c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/621/format/jpg)

å°äº‹åŠ¡+å¼‚æ­¥æ¶ˆæ¯

å›¾ä¸­æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆBobè´¦æˆ·æ‰£æ¬¾ï¼‰å’Œå‘é€å¼‚æ­¥æ¶ˆæ¯åº”è¯¥ä¿è¯åŒæ—¶æˆåŠŸæˆ–è€…åŒæ—¶å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯æ‰£æ¬¾æˆåŠŸäº†ï¼Œå‘é€æ¶ˆæ¯ä¸€å®šè¦æˆåŠŸï¼Œå¦‚æœæ‰£æ¬¾å¤±è´¥äº†ï¼Œå°±ä¸èƒ½å†å‘é€æ¶ˆæ¯ã€‚é‚£é—®é¢˜æ˜¯ï¼šæˆ‘ä»¬æ˜¯å…ˆæ‰£æ¬¾è¿˜æ˜¯å…ˆå‘é€æ¶ˆæ¯å‘¢ï¼Ÿ

é¦–å…ˆçœ‹ä¸‹å…ˆå‘é€æ¶ˆæ¯çš„æƒ…å†µï¼Œå¤§è‡´çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-1927b8f3d14ef823.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/618/format/jpg)

äº‹åŠ¡æ¶ˆæ¯ï¼šå…ˆå‘é€æ¶ˆæ¯

å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šå¦‚æœæ¶ˆæ¯å‘é€æˆåŠŸï¼Œä½†æ˜¯æ‰£æ¬¾å¤±è´¥ï¼Œæ¶ˆè´¹ç«¯å°±ä¼šæ¶ˆè´¹æ­¤æ¶ˆæ¯ï¼Œè¿›è€Œå‘Smithè´¦æˆ·åŠ é’±ã€‚

å…ˆå‘æ¶ˆæ¯ä¸è¡Œï¼Œé‚£å°±å…ˆæ‰£æ¬¾å§ï¼Œå¤§è‡´çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-367b5cf60cbdfa16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/619/format/jpg)

äº‹åŠ¡æ¶ˆæ¯-å…ˆæ‰£æ¬¾

å­˜åœ¨çš„é—®é¢˜è·Ÿä¸Šé¢ç±»ä¼¼ï¼šå¦‚æœæ‰£æ¬¾æˆåŠŸï¼Œå‘é€æ¶ˆæ¯å¤±è´¥ï¼Œå°±ä¼šå‡ºç°Bobæ‰£é’±äº†ï¼Œä½†æ˜¯Smithè´¦æˆ·æœªåŠ é’±ã€‚

å¯èƒ½å¤§å®¶ä¼šæœ‰å¾ˆå¤šçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ï¼šç›´æ¥å°†å‘æ¶ˆæ¯æ”¾åˆ°Bobæ‰£æ¬¾çš„äº‹åŠ¡ä¸­å»ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡å›æ»šã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼ä¹Ÿç¬¦åˆâ€œæ°å¥½â€ä¸éœ€è¦è§£å†³çš„åŸåˆ™ã€‚

> è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼šå¦‚æœä½¿ç”¨Springæ¥ç®¡ç†äº‹ç‰©çš„è¯ï¼Œå¤§å¯ä»¥å°†å‘é€æ¶ˆæ¯çš„é€»è¾‘æ”¾åˆ°æœ¬åœ°äº‹ç‰©ä¸­å»ï¼Œå‘é€æ¶ˆæ¯å¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼ŒSpringæ•æ‰åˆ°å¼‚å¸¸åå°±ä¼šå›æ»šæ­¤äº‹ç‰©ï¼Œä»¥æ­¤æ¥ä¿è¯æœ¬åœ°äº‹ç‰©ä¸å‘é€æ¶ˆæ¯çš„åŸå­æ€§ã€‚

RocketMQæ”¯æŒäº‹åŠ¡æ¶ˆæ¯ï¼Œä¸‹é¢æ¥çœ‹çœ‹RocketMQæ˜¯æ€æ ·æ¥å®ç°çš„ã€‚



![img](https:////upload-images.jianshu.io/upload_images/175724-ab0085543c6d02d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/621/format/jpg)

RocketMQå®ç°å‘é€äº‹åŠ¡æ¶ˆæ¯

RocketMQç¬¬ä¸€é˜¶æ®µå‘é€`Preparedæ¶ˆæ¯`æ—¶ï¼Œä¼šæ‹¿åˆ°æ¶ˆæ¯çš„åœ°å€ï¼Œç¬¬äºŒé˜¶æ®µæ‰§è¡Œæœ¬åœ°äº‹ç‰©ï¼Œç¬¬ä¸‰é˜¶æ®µé€šè¿‡ç¬¬ä¸€é˜¶æ®µæ‹¿åˆ°çš„åœ°å€å»è®¿é—®æ¶ˆæ¯ï¼Œå¹¶ä¿®æ”¹æ¶ˆæ¯çš„çŠ¶æ€ã€‚

ç»†å¿ƒçš„ä½ å¯èƒ½åˆå‘ç°é—®é¢˜äº†ï¼Œå¦‚æœç¡®è®¤æ¶ˆæ¯å‘é€å¤±è´¥äº†æ€ä¹ˆåŠï¼ŸRocketMQä¼šå®šæœŸæ‰«ææ¶ˆæ¯é›†ç¾¤ä¸­çš„äº‹ç‰©æ¶ˆæ¯ï¼Œå¦‚æœå‘ç°äº†`Preparedæ¶ˆæ¯`ï¼Œå®ƒä¼šå‘æ¶ˆæ¯å‘é€ç«¯(ç”Ÿäº§è€…)ç¡®è®¤ï¼ŒBobçš„é’±åˆ°åº•æ˜¯å‡äº†è¿˜æ˜¯æ²¡å‡å‘¢ï¼Ÿå¦‚æœå‡äº†æ˜¯å›æ»šè¿˜æ˜¯ç»§ç»­å‘é€ç¡®è®¤æ¶ˆæ¯å‘¢ï¼ŸRocketMQä¼šæ ¹æ®å‘é€ç«¯è®¾ç½®çš„ç­–ç•¥æ¥å†³å®šæ˜¯å›æ»šè¿˜æ˜¯ç»§ç»­å‘é€ç¡®è®¤æ¶ˆæ¯ã€‚è¿™æ ·å°±ä¿è¯äº†æ¶ˆæ¯å‘é€ä¸æœ¬åœ°äº‹åŠ¡åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥ã€‚

é‚£æˆ‘ä»¬æ¥çœ‹ä¸‹RocketMQæºç ï¼Œæ˜¯å¦‚ä½•å¤„ç†äº‹åŠ¡æ¶ˆæ¯çš„ã€‚å®¢æˆ·ç«¯å‘é€äº‹åŠ¡æ¶ˆæ¯çš„éƒ¨åˆ†ï¼ˆå®Œæ•´ä»£ç è¯·æŸ¥çœ‹ï¼š`rocketmq-example`å·¥ç¨‹ä¸‹çš„`com.alibaba.rocketmq.example.transaction.TransactionProducer`ï¼‰ï¼š

```Java
// =============================å‘é€äº‹åŠ¡æ¶ˆæ¯çš„ä¸€ç³»åˆ—å‡†å¤‡å·¥ä½œ========================================
// æœªå†³äº‹åŠ¡ï¼ŒMQæœåŠ¡å™¨å›æŸ¥å®¢æˆ·ç«¯
// ä¹Ÿå°±æ˜¯ä¸Šæ–‡æ‰€è¯´çš„ï¼Œå½“RocketMQå‘ç°`Preparedæ¶ˆæ¯`æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªListenerå®ç°çš„ç­–ç•¥æ¥å†³æ–­äº‹åŠ¡
TransactionCheckListener transactionCheckListener = new TransactionCheckListenerImpl();
// æ„é€ äº‹åŠ¡æ¶ˆæ¯çš„ç”Ÿäº§è€…
TransactionMQProducer producer = new TransactionMQProducer("groupName");
// è®¾ç½®äº‹åŠ¡å†³æ–­å¤„ç†ç±»
producer.setTransactionCheckListener(transactionCheckListener);
// æœ¬åœ°äº‹åŠ¡çš„å¤„ç†é€»è¾‘ï¼Œç›¸å½“äºç¤ºä¾‹ä¸­æ£€æŸ¥Bobè´¦æˆ·å¹¶æ‰£é’±çš„é€»è¾‘
TransactionExecuterImpl tranExecuter = new TransactionExecuterImpl();
producer.start()
// æ„é€ MSGï¼Œçœç•¥æ„é€ å‚æ•°
Message msg = new Message(......);
// å‘é€æ¶ˆæ¯
SendResult sendResult = producer.sendMessageInTransaction(msg, tranExecuter, null);
producer.shutdown();
```

æ¥ç€æŸ¥çœ‹`sendMessageInTransaction`æ–¹æ³•çš„æºç ï¼Œæ€»å…±åˆ†ä¸º3ä¸ªé˜¶æ®µï¼šå‘é€`Preparedæ¶ˆæ¯`ã€æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ã€å‘é€ç¡®è®¤æ¶ˆæ¯ã€‚

```Java
//  ================================äº‹åŠ¡æ¶ˆæ¯çš„å‘é€è¿‡ç¨‹=============================================
public TransactionSendResult sendMessageInTransaction(.....)  {
    // é€»è¾‘ä»£ç ï¼Œéå®é™…ä»£ç 
    // 1.å‘é€æ¶ˆæ¯
    sendResult = this.send(msg);
    // sendResult.getSendStatus() == SEND_OK
    // 2.å¦‚æœæ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¤„ç†ä¸æ¶ˆæ¯å…³è”çš„æœ¬åœ°äº‹åŠ¡å•å…ƒ
    LocalTransactionState localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);
    // 3.ç»“æŸäº‹åŠ¡
    this.endTransaction(sendResult, localTransactionState, localException);
}
```

`endTransaction`æ–¹æ³•ä¼šå°†è¯·æ±‚å‘å¾€`broker(mq server)`å»æ›´æ–°äº‹åŠ¡æ¶ˆæ¯çš„æœ€ç»ˆçŠ¶æ€ï¼š

1. æ ¹æ®`sendResult`æ‰¾åˆ°`Preparedæ¶ˆæ¯` ï¼Œ`sendResult`åŒ…å«äº‹åŠ¡æ¶ˆæ¯çš„ID
2. æ ¹æ®`localTransaction`æ›´æ–°æ¶ˆæ¯çš„æœ€ç»ˆçŠ¶æ€

å¦‚æœ`endTransaction`æ–¹æ³•æ‰§è¡Œå¤±è´¥ï¼Œæ•°æ®æ²¡æœ‰å‘é€åˆ°`broker`ï¼Œå¯¼è‡´äº‹åŠ¡æ¶ˆæ¯çš„ çŠ¶æ€æ›´æ–°å¤±è´¥ï¼Œ`broker`ä¼šæœ‰å›æŸ¥çº¿ç¨‹å®šæ—¶ï¼ˆé»˜è®¤1åˆ†é’Ÿï¼‰æ‰«ææ¯ä¸ªå­˜å‚¨äº‹åŠ¡çŠ¶æ€çš„è¡¨æ ¼æ–‡ä»¶ï¼Œå¦‚æœæ˜¯å·²ç»æäº¤æˆ–è€…å›æ»šçš„æ¶ˆæ¯ç›´æ¥è·³è¿‡ï¼Œå¦‚æœæ˜¯`preparedçŠ¶æ€`åˆ™ä¼šå‘`Producer`å‘èµ·`CheckTransaction`è¯·æ±‚ï¼Œ`Producer`ä¼šè°ƒç”¨`DefaultMQProducerImpl.checkTransactionState()`æ–¹æ³•æ¥å¤„ç†`broker`çš„å®šæ—¶å›è°ƒè¯·æ±‚ï¼Œè€Œ`checkTransactionState`ä¼šè°ƒç”¨æˆ‘ä»¬çš„äº‹åŠ¡è®¾ç½®çš„å†³æ–­æ–¹æ³•æ¥å†³å®šæ˜¯å›æ»šäº‹åŠ¡è¿˜æ˜¯ç»§ç»­æ‰§è¡Œï¼Œæœ€åè°ƒç”¨`endTransactionOneway`è®©`broker`æ¥æ›´æ–°æ¶ˆæ¯çš„æœ€ç»ˆçŠ¶æ€ã€‚

å†å›åˆ°è½¬è´¦çš„ä¾‹å­ï¼Œå¦‚æœBobçš„è´¦æˆ·çš„ä½™é¢å·²ç»å‡å°‘ï¼Œä¸”æ¶ˆæ¯å·²ç»å‘é€æˆåŠŸï¼ŒSmithç«¯å¼€å§‹æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°æ¶ˆè´¹å¤±è´¥å’Œæ¶ˆè´¹è¶…æ—¶ä¸¤ä¸ªé—®é¢˜ï¼Œè§£å†³è¶…æ—¶é—®é¢˜çš„æ€è·¯å°±æ˜¯ä¸€ç›´é‡è¯•ï¼Œç›´åˆ°æ¶ˆè´¹ç«¯æ¶ˆè´¹æ¶ˆæ¯æˆåŠŸï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­æœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯é‡å¤çš„é—®é¢˜ï¼ŒæŒ‰ç…§å‰é¢çš„æ€è·¯è§£å†³å³å¯ã€‚



![img](https:////upload-images.jianshu.io/upload_images/175724-1d9ba7bcd230e0dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/624/format/jpg)

æ¶ˆè´¹äº‹åŠ¡æ¶ˆæ¯

è¿™æ ·åŸºæœ¬ä¸Šå¯ä»¥è§£å†³æ¶ˆè´¹ç«¯è¶…æ—¶é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæ¶ˆè´¹å¤±è´¥æ€ä¹ˆåŠï¼Ÿé˜¿é‡Œæä¾›ç»™æˆ‘ä»¬çš„è§£å†³æ–¹æ³•æ˜¯ï¼š**äººå·¥è§£å†³**ã€‚å¤§å®¶å¯ä»¥è€ƒè™‘ä¸€ä¸‹ï¼ŒæŒ‰ç…§äº‹åŠ¡çš„æµç¨‹ï¼Œå› ä¸ºæŸç§åŸå› SmithåŠ æ¬¾å¤±è´¥ï¼Œé‚£ä¹ˆéœ€è¦å›æ»šæ•´ä¸ªæµç¨‹ã€‚å¦‚æœæ¶ˆæ¯ç³»ç»Ÿè¦å®ç°è¿™ä¸ªå›æ»šæµç¨‹çš„è¯ï¼Œç³»ç»Ÿå¤æ‚åº¦å°†å¤§å¤§æå‡ï¼Œä¸”å¾ˆå®¹æ˜“å‡ºç°Bugï¼Œä¼°è®¡å‡ºç°Bugçš„æ¦‚ç‡ä¼šæ¯”æ¶ˆè´¹å¤±è´¥çš„æ¦‚ç‡å¤§å¾ˆå¤šã€‚è¿™ä¹Ÿæ˜¯RocketMQç›®å‰æš‚æ—¶æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜çš„åŸå› ï¼Œåœ¨è®¾è®¡å®ç°æ¶ˆæ¯ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¡¡é‡æ˜¯å¦å€¼å¾—èŠ±è¿™ä¹ˆå¤§çš„ä»£ä»·æ¥è§£å†³è¿™æ ·ä¸€ä¸ªå‡ºç°æ¦‚ç‡éå¸¸å°çš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯å¤§å®¶åœ¨è§£å†³ç–‘éš¾é—®é¢˜æ—¶éœ€è¦å¤šå¤šæ€è€ƒçš„åœ°æ–¹ã€‚

> 20160321è¡¥å……ï¼šåœ¨3.2.6ç‰ˆæœ¬ä¸­ç§»é™¤äº†äº‹åŠ¡æ¶ˆæ¯çš„å®ç°ï¼Œæ‰€ä»¥æ­¤ç‰ˆæœ¬ä¸æ”¯æŒäº‹åŠ¡æ¶ˆæ¯ï¼Œå…·ä½“æƒ…å†µè¯·å‚è€ƒrocketmqçš„issues(å·²å¤±æ•ˆ)ï¼š
>  ~~https://github.com/alibaba/RocketMQ/issues/65~~
>  ~~https://github.com/alibaba/RocketMQ/issues/138~~
>  ~~https://github.com/alibaba/RocketMQ/issues/156~~

## å››ã€Producerå¦‚ä½•å‘é€æ¶ˆæ¯

`Producer`è½®è¯¢æŸtopicä¸‹çš„æ‰€æœ‰é˜Ÿåˆ—çš„æ–¹å¼æ¥å®ç°å‘é€æ–¹çš„è´Ÿè½½å‡è¡¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
 



![img](https:////upload-images.jianshu.io/upload_images/175724-9eac93e29d0e06ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/627/format/jpg)

producerå‘é€æ¶ˆæ¯è´Ÿè½½å‡è¡¡

 é¦–å…ˆåˆ†æä¸€ä¸‹RocketMQçš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯çš„æºç ï¼š



```Java
// æ„é€ Producer
DefaultMQProducer producer = new DefaultMQProducer("ProducerGroupName");
// åˆå§‹åŒ–Producerï¼Œæ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸå†…ï¼Œåªéœ€è¦åˆå§‹åŒ–1æ¬¡
producer.start();
// æ„é€ Message
Message msg = new Message("TopicTest1",// topic
                        "TagA",// tagï¼šç»™æ¶ˆæ¯æ‰“æ ‡ç­¾,ç”¨äºåŒºåˆ†ä¸€ç±»æ¶ˆæ¯ï¼Œå¯ä¸ºnull
                        "OrderID188",// keyï¼šè‡ªå®šä¹‰Keyï¼Œå¯ä»¥ç”¨äºå»é‡ï¼Œå¯ä¸ºnull
                        ("Hello MetaQ").getBytes());// bodyï¼šæ¶ˆæ¯å†…å®¹
// å‘é€æ¶ˆæ¯å¹¶è¿”å›ç»“æœ
SendResult sendResult = producer.send(msg);
// æ¸…ç†èµ„æºï¼Œå…³é—­ç½‘ç»œè¿æ¥ï¼Œæ³¨é”€è‡ªå·±
producer.shutdown();
```

åœ¨æ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸå†…ï¼Œç”Ÿäº§è€…éœ€è¦è°ƒç”¨ä¸€æ¬¡startæ–¹æ³•æ¥åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ä¸»è¦å®Œæˆçš„ä»»åŠ¡æœ‰ï¼š

> 1. å¦‚æœæ²¡æœ‰æŒ‡å®š`namesrv`åœ°å€ï¼Œå°†ä¼šè‡ªåŠ¨å¯»å€
> 2. å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼šæ›´æ–°namesrvåœ°å€ã€ä»namsrvæ›´æ–°topicè·¯ç”±ä¿¡æ¯ã€æ¸…ç†å·²ç»æŒ‚æ‰çš„brokerã€å‘æ‰€æœ‰brokerå‘é€å¿ƒè·³...
> 3. å¯åŠ¨è´Ÿè½½å‡è¡¡çš„æœåŠ¡

åˆå§‹åŒ–å®Œæˆåï¼Œå¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯çš„ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š

```Java
private SendResult sendDefaultImpl(Message msg,......) {
    // æ£€æŸ¥Producerçš„çŠ¶æ€æ˜¯å¦æ˜¯RUNNING
    this.makeSureStateOK();
    // æ£€æŸ¥msgæ˜¯å¦åˆæ³•ï¼šæ˜¯å¦ä¸ºnullã€topic,bodyæ˜¯å¦ä¸ºç©ºã€bodyæ˜¯å¦è¶…é•¿
    Validators.checkMessage(msg, this.defaultMQProducer);
    // è·å–topicè·¯ç”±ä¿¡æ¯
    TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());
    // ä»è·¯ç”±ä¿¡æ¯ä¸­é€‰æ‹©ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—
    MessageQueue mq = topicPublishInfo.selectOneMessageQueue(lastBrokerName);
    // å°†æ¶ˆæ¯å‘é€åˆ°è¯¥é˜Ÿåˆ—ä¸Šå»
    sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, timeout);
}
```

ä»£ç ä¸­éœ€è¦å…³æ³¨çš„ä¸¤ä¸ªæ–¹æ³•`tryToFindTopicPublishInfo`å’Œ`selectOneMessageQueue`ã€‚å‰é¢è¯´è¿‡åœ¨produceråˆå§‹åŒ–æ—¶ï¼Œä¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡è·å–è·¯ç”±ä¿¡æ¯å¹¶æ›´æ–°åˆ°æœ¬åœ°ç¼“å­˜ï¼Œæ‰€ä»¥`tryToFindTopicPublishInfo`ä¼šé¦–å…ˆä»ç¼“å­˜ä¸­è·å–topicè·¯ç”±ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™ä¼šè‡ªå·±å»`namesrv`è·å–è·¯ç”±ä¿¡æ¯ã€‚`selectOneMessageQueue`æ–¹æ³•é€šè¿‡è½®è¯¢çš„æ–¹å¼ï¼Œè¿”å›ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»¥è¾¾åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„ã€‚

å¦‚æœProducerå‘é€æ¶ˆæ¯å¤±è´¥ï¼Œä¼šè‡ªåŠ¨é‡è¯•ï¼Œé‡è¯•çš„ç­–ç•¥ï¼š

1. é‡è¯•æ¬¡æ•° < retryTimesWhenSendFailedï¼ˆå¯é…ç½®ï¼‰
2. æ€»çš„è€—æ—¶ï¼ˆåŒ…å«é‡è¯•næ¬¡çš„è€—æ—¶ï¼‰ < sendMsgTimeoutï¼ˆå‘é€æ¶ˆæ¯æ—¶ä¼ å…¥çš„å‚æ•°ï¼‰
3. åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶åï¼ŒProducerä¼šé€‰æ‹©å¦å¤–ä¸€ä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯

## äº”ã€æ¶ˆæ¯å­˜å‚¨

RocketMQçš„æ¶ˆæ¯å­˜å‚¨æ˜¯ç”±`consume queue`å’Œ`commit log`é…åˆå®Œæˆçš„ã€‚

### 1ã€Consume Queue

`consume queue`æ˜¯æ¶ˆæ¯çš„é€»è¾‘é˜Ÿåˆ—ï¼Œç›¸å½“äºå­—å…¸çš„ç›®å½•ï¼Œç”¨æ¥æŒ‡å®šæ¶ˆæ¯åœ¨ç‰©ç†æ–‡ä»¶`commit log`ä¸Šçš„ä½ç½®ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®ä¸­æŒ‡å®š`consumequeue`ä¸`commitlog`å­˜å‚¨çš„ç›®å½•
 æ¯ä¸ª`topic`ä¸‹çš„æ¯ä¸ª`queue`éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„`consumequeue`æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š

```Java
${rocketmq.home}/store/consumequeue/${topicName}/${queueId}/${fileName}
```

Consume Queueæ–‡ä»¶ç»„ç»‡ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-d1b4318d77a96950.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/247/format/jpg)

Consume Queueæ–‡ä»¶ç»„ç»‡ç¤ºæ„å›¾

1. æ ¹æ®`topic`å’Œ`queueId`æ¥ç»„ç»‡æ–‡ä»¶ï¼Œå›¾ä¸­TopicAæœ‰ä¸¤ä¸ªé˜Ÿåˆ—0,1ï¼Œé‚£ä¹ˆTopicAå’ŒQueueId=0ç»„æˆä¸€ä¸ªConsumeQueueï¼ŒTopicAå’ŒQueueId=1ç»„æˆå¦ä¸€ä¸ªConsumeQueueã€‚
2. æŒ‰ç…§æ¶ˆè´¹ç«¯çš„`GroupName`æ¥åˆ†ç»„é‡è¯•é˜Ÿåˆ—ï¼Œå¦‚æœæ¶ˆè´¹ç«¯æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯å°†è¢«å‘å¾€é‡è¯•é˜Ÿåˆ—ä¸­ï¼Œæ¯”å¦‚å›¾ä¸­çš„`%RETRY%ConsumerGroupA`ã€‚
3. æŒ‰ç…§æ¶ˆè´¹ç«¯çš„`GroupName`æ¥åˆ†ç»„æ­»ä¿¡é˜Ÿåˆ—ï¼Œå¦‚æœæ¶ˆè´¹ç«¯æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶é‡è¯•æŒ‡å®šæ¬¡æ•°åï¼Œä»ç„¶å¤±è´¥ï¼Œåˆ™å‘å¾€æ­»ä¿¡é˜Ÿåˆ—ï¼Œæ¯”å¦‚å›¾ä¸­çš„`%DLQ%ConsumerGroupA`ã€‚

> æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead Letter Queueï¼‰ä¸€èˆ¬ç”¨äºå­˜æ”¾ç”±äºæŸç§åŸå› æ— æ³•ä¼ é€’çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚å¤„ç†å¤±è´¥æˆ–è€…å·²ç»è¿‡æœŸçš„æ¶ˆæ¯ã€‚

Consume Queueä¸­å­˜å‚¨å•å…ƒæ˜¯ä¸€ä¸ª20å­—èŠ‚å®šé•¿çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œé¡ºåºå†™é¡ºåºè¯»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-7212acc81b91c086.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/720/format/jpg)

consumequeueæ–‡ä»¶å­˜å‚¨å•å…ƒæ ¼å¼

1. CommitLog Offsetæ˜¯æŒ‡è¿™æ¡æ¶ˆæ¯åœ¨Commit Logæ–‡ä»¶ä¸­çš„å®é™…åç§»é‡
2. Sizeå­˜å‚¨ä¸­æ¶ˆæ¯çš„å¤§å°
3. Message Tag HashCodeå­˜å‚¨æ¶ˆæ¯çš„Tagçš„å“ˆå¸Œå€¼ï¼šä¸»è¦ç”¨äºè®¢é˜…æ—¶æ¶ˆæ¯è¿‡æ»¤ï¼ˆè®¢é˜…æ—¶å¦‚æœæŒ‡å®šäº†Tagï¼Œä¼šæ ¹æ®HashCodeæ¥å¿«é€ŸæŸ¥æ‰¾åˆ°è®¢é˜…çš„æ¶ˆæ¯ï¼‰

### 2ã€Commit Log

CommitLogï¼šæ¶ˆæ¯å­˜æ”¾çš„ç‰©ç†æ–‡ä»¶ï¼Œæ¯å°`broker`ä¸Šçš„`commitlog`è¢«æœ¬æœºæ‰€æœ‰çš„`queue`å…±äº«ï¼Œä¸åšä»»ä½•åŒºåˆ†ã€‚
 æ–‡ä»¶çš„é»˜è®¤ä½ç½®å¦‚ä¸‹ï¼Œä»ç„¶å¯é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼š

```
${user.home} \store\${commitlog}\${fileName}
```

CommitLogçš„æ¶ˆæ¯å­˜å‚¨å•å…ƒé•¿åº¦ä¸å›ºå®šï¼Œæ–‡ä»¶é¡ºåºå†™ï¼Œéšæœºè¯»ã€‚æ¶ˆæ¯çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼ŒæŒ‰ç…§ç¼–å·é¡ºåºä»¥åŠç¼–å·å¯¹åº”çš„å†…å®¹ä¾æ¬¡å­˜å‚¨ã€‚



![img](https:////upload-images.jianshu.io/upload_images/175724-96ed677eb504abfe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/745/format/jpg)

Commit Logå­˜å‚¨å•å…ƒç»“æ„å›¾

### 3ã€æ¶ˆæ¯å­˜å‚¨å®ç°

æ¶ˆæ¯å­˜å‚¨å®ç°ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œä¹Ÿå€¼å¾—å¤§å®¶æ·±å…¥äº†è§£ï¼Œåé¢ä¼šå•ç‹¬æˆæ–‡æ¥åˆ†æ(ç›®å‰æ­£åœ¨æ”¶é›†ç´ æ)ï¼Œè¿™å°èŠ‚åªä»¥ä»£ç è¯´æ˜ä¸€ä¸‹å…·ä½“çš„æµç¨‹ã€‚

```Java
// Set the storage time
msg.setStoreTimestamp(System.currentTimeMillis());
// Set the message body BODY CRC (consider the most appropriate setting
msg.setBodyCRC(UtilAll.crc32(msg.getBody()));
StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();
synchronized (this) {
    long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();
    // Here settings are stored timestamp, in order to ensure an orderly global
    msg.setStoreTimestamp(beginLockTimestamp);
    // MapedFileï¼šæ“ä½œç‰©ç†æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„æ˜ å°„ä»¥åŠå°†å†…å­˜æ•°æ®æŒä¹…åŒ–åˆ°ç‰©ç†æ–‡ä»¶ä¸­
    MapedFile mapedFile = this.mapedFileQueue.getLastMapedFile();
    // å°†Messageè¿½åŠ åˆ°æ–‡ä»¶commitlog
    result = mapedFile.appendMessage(msg, this.appendMessageCallback);
    switch (result.getStatus()) {
    case PUT_OK:break;
    case END_OF_FILE:
         // Create a new file, re-write the message
         mapedFile = this.mapedFileQueue.getLastMapedFile();
         result = mapedFile.appendMessage(msg, this.appendMessageCallback);
     break;
     DispatchRequest dispatchRequest = new DispatchRequest(
                topic,// 1
                queueId,// 2
                result.getWroteOffset(),// 3
                result.getWroteBytes(),// 4
                tagsCode,// 5
                msg.getStoreTimestamp(),// 6
                result.getLogicsOffset(),// 7
                msg.getKeys(),// 8
                /**
                 * Transaction
                 */
                msg.getSysFlag(),// 9
                msg.getPreparedTransactionOffset());// 10
    // 1.åˆ†å‘æ¶ˆæ¯ä½ç½®åˆ°ConsumeQueue
    // 2.åˆ†å‘åˆ°IndexServiceå»ºç«‹ç´¢å¼•
    this.defaultMessageStore.putDispatchRequest(dispatchRequest);
}
```

### 4ã€æ¶ˆæ¯çš„ç´¢å¼•æ–‡ä»¶

å¦‚æœä¸€ä¸ªæ¶ˆæ¯åŒ…å«keyå€¼çš„è¯ï¼Œä¼šä½¿ç”¨IndexFileå­˜å‚¨æ¶ˆæ¯ç´¢å¼•ï¼Œæ–‡ä»¶çš„å†…å®¹ç»“æ„å¦‚å›¾ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-4deee0fb9d08e02d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/704/format/jpg)

æ¶ˆæ¯ç´¢å¼•

ç´¢å¼•æ–‡ä»¶ä¸»è¦ç”¨äºæ ¹æ®keyæ¥æŸ¥è¯¢æ¶ˆæ¯çš„ï¼Œæµç¨‹ä¸»è¦æ˜¯ï¼š

1. æ ¹æ®æŸ¥è¯¢çš„ key çš„ hashcode%slotNum å¾—åˆ°å…·ä½“çš„æ§½çš„ä½ç½®(slotNum æ˜¯ä¸€ä¸ªç´¢å¼•æ–‡ä»¶é‡Œé¢åŒ…å«çš„æœ€å¤§æ§½çš„æ•°ç›®ï¼Œä¾‹å¦‚å›¾ä¸­æ‰€ç¤º slotNum=5000000)
2. æ ¹æ® slotValue(slot ä½ç½®å¯¹åº”çš„å€¼)æŸ¥æ‰¾åˆ°ç´¢å¼•é¡¹åˆ—è¡¨çš„æœ€åä¸€é¡¹(å€’åºæ’åˆ—,slotValue æ€»æ˜¯æŒ‡å‘æœ€æ–°çš„ä¸€ä¸ªç´¢å¼•é¡¹)
3. éå†ç´¢å¼•é¡¹åˆ—è¡¨è¿”å›æŸ¥è¯¢æ—¶é—´èŒƒå›´å†…çš„ç»“æœé›†(é»˜è®¤ä¸€æ¬¡æœ€å¤§è¿”å›çš„ 32 æ¡è®°å½•)

## å…­ã€æ¶ˆæ¯è®¢é˜…

RocketMQæ¶ˆæ¯è®¢é˜…æœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯Pushæ¨¡å¼ï¼Œå³MQServerä¸»åŠ¨å‘æ¶ˆè´¹ç«¯æ¨é€ï¼›å¦å¤–ä¸€ç§æ˜¯Pullæ¨¡å¼ï¼Œå³æ¶ˆè´¹ç«¯åœ¨éœ€è¦æ—¶ï¼Œä¸»åŠ¨åˆ°MQServeræ‹‰å–ã€‚ä½†åœ¨å…·ä½“å®ç°æ—¶ï¼ŒPushå’ŒPullæ¨¡å¼éƒ½æ˜¯é‡‡ç”¨æ¶ˆè´¹ç«¯ä¸»åŠ¨æ‹‰å–çš„æ–¹å¼ã€‚

é¦–å…ˆçœ‹ä¸‹æ¶ˆè´¹ç«¯çš„è´Ÿè½½å‡è¡¡ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-fdbb184a5d9bd022.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/692/format/jpg)

æ¶ˆè´¹ç«¯è´Ÿè½½å‡è¡¡

æ¶ˆè´¹ç«¯ä¼šé€šè¿‡RebalanceServiceçº¿ç¨‹ï¼Œ10ç§’é’Ÿåšä¸€æ¬¡åŸºäºtopicä¸‹çš„æ‰€æœ‰é˜Ÿåˆ—è´Ÿè½½ï¼š

1. éå†Consumerä¸‹çš„æ‰€æœ‰topicï¼Œç„¶åæ ¹æ®topicè®¢é˜…æ‰€æœ‰çš„æ¶ˆæ¯
2. è·å–åŒä¸€topicå’ŒConsumer Groupä¸‹çš„æ‰€æœ‰Consumer
3. ç„¶åæ ¹æ®å…·ä½“çš„åˆ†é…ç­–ç•¥æ¥åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—ï¼Œåˆ†é…çš„ç­–ç•¥åŒ…å«ï¼šå¹³å‡åˆ†é…ã€æ¶ˆè´¹ç«¯é…ç½®ç­‰

å¦‚åŒä¸Šå›¾æ‰€ç¤ºï¼šå¦‚æœæœ‰ 5 ä¸ªé˜Ÿåˆ—ï¼Œ2 ä¸ª consumerï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ª Consumer æ¶ˆè´¹ 3 ä¸ªé˜Ÿåˆ—ï¼Œç¬¬äºŒ consumer æ¶ˆè´¹ 2 ä¸ªé˜Ÿåˆ—ã€‚è¿™é‡Œé‡‡ç”¨çš„å°±æ˜¯å¹³å‡åˆ†é…ç­–ç•¥ï¼Œå®ƒç±»ä¼¼äºåˆ†é¡µçš„è¿‡ç¨‹ï¼ŒTOPICä¸‹é¢çš„æ‰€æœ‰queueå°±æ˜¯è®°å½•ï¼ŒConsumerçš„ä¸ªæ•°å°±ç›¸å½“äºæ€»çš„é¡µæ•°ï¼Œé‚£ä¹ˆæ¯é¡µæœ‰å¤šå°‘æ¡è®°å½•ï¼Œå°±ç±»ä¼¼äºæŸä¸ªConsumerä¼šæ¶ˆè´¹å“ªäº›é˜Ÿåˆ—ã€‚

é€šè¿‡è¿™æ ·çš„ç­–ç•¥æ¥è¾¾åˆ°å¤§ä½“ä¸Šçš„å¹³å‡æ¶ˆè´¹ï¼Œè¿™æ ·çš„è®¾è®¡ä¹Ÿå¯ä»¥å¾ˆæ–¹é¢çš„æ°´å¹³æ‰©å±•Consumeræ¥æé«˜æ¶ˆè´¹èƒ½åŠ›ã€‚

æ¶ˆè´¹ç«¯çš„Pushæ¨¡å¼æ˜¯é€šè¿‡é•¿è½®è¯¢çš„æ¨¡å¼æ¥å®ç°çš„ï¼Œå°±å¦‚åŒä¸‹å›¾ï¼š



![img](https:////upload-images.jianshu.io/upload_images/175724-f2e2ee205d49a05f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/388/format/jpg)

Pushæ¨¡å¼ç¤ºæ„å›¾

Consumerç«¯æ¯éš”ä¸€æ®µæ—¶é—´ä¸»åŠ¨å‘brokerå‘é€æ‹‰æ¶ˆæ¯è¯·æ±‚ï¼Œbrokeråœ¨æ”¶åˆ°Pullè¯·æ±‚åï¼Œå¦‚æœæœ‰æ¶ˆæ¯å°±ç«‹å³è¿”å›æ•°æ®ï¼ŒConsumerç«¯æ”¶åˆ°è¿”å›çš„æ¶ˆæ¯åï¼Œå†å›è°ƒæ¶ˆè´¹è€…è®¾ç½®çš„Listeneræ–¹æ³•ã€‚å¦‚æœbrokeråœ¨æ”¶åˆ°Pullè¯·æ±‚æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—é‡Œæ²¡æœ‰æ•°æ®ï¼Œbrokerç«¯ä¼šé˜»å¡è¯·æ±‚ç›´åˆ°æœ‰æ•°æ®ä¼ é€’æˆ–è¶…æ—¶æ‰è¿”å›ã€‚

å½“ç„¶ï¼ŒConsumerç«¯æ˜¯é€šè¿‡ä¸€ä¸ªçº¿ç¨‹å°†é˜»å¡é˜Ÿåˆ—`LinkedBlockingQueue<PullRequest>`ä¸­çš„`PullRequest`å‘é€åˆ°brokeræ‹‰å–æ¶ˆæ¯ï¼Œä»¥é˜²æ­¢Consumerä¸€è‡´è¢«é˜»å¡ã€‚è€ŒBrokerç«¯ï¼Œåœ¨æ¥æ”¶åˆ°Consumerçš„`PullRequest`æ—¶ï¼Œå¦‚æœå‘ç°æ²¡æœ‰æ¶ˆæ¯ï¼Œå°±ä¼šæŠŠ`PullRequest`æ‰”åˆ°ConcurrentHashMapä¸­ç¼“å­˜èµ·æ¥ã€‚brokeråœ¨å¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä¸åœçš„ä»ConcurrentHashMapå–å‡º`PullRequest`æ£€æŸ¥ï¼Œç›´åˆ°æœ‰æ•°æ®è¿”å›ã€‚

## ä¸ƒã€RocketMQçš„å…¶ä»–ç‰¹æ€§

å‰é¢çš„6ä¸ªç‰¹æ€§éƒ½æ˜¯åŸºæœ¬ä¸Šéƒ½æ˜¯ç‚¹åˆ°ä¸ºæ­¢ï¼Œæƒ³è¦æ·±å…¥äº†è§£ï¼Œè¿˜éœ€è¦å¤§å®¶å¤šå¤šæŸ¥çœ‹æºç ï¼Œå¤šå¤šåœ¨å®é™…ä¸­è¿ç”¨ã€‚å½“ç„¶é™¤äº†å·²ç»æåˆ°çš„ç‰¹æ€§å¤–ï¼ŒRocketMQè¿˜æ”¯æŒï¼š

1. å®šæ—¶æ¶ˆæ¯
2. æ¶ˆæ¯çš„åˆ·ç›˜ç­–ç•¥
3. ä¸»åŠ¨åŒæ­¥ç­–ç•¥ï¼šåŒæ­¥åŒå†™ã€å¼‚æ­¥å¤åˆ¶
4. æµ·é‡æ¶ˆæ¯å †ç§¯èƒ½åŠ›
5. é«˜æ•ˆé€šä¿¡
6. .......

å…¶ä¸­æ¶‰åŠåˆ°çš„å¾ˆå¤šè®¾è®¡æ€è·¯å’Œè§£å†³æ–¹æ³•éƒ½å€¼å¾—æˆ‘ä»¬æ·±å…¥ç ”ç©¶ï¼š

1. æ¶ˆæ¯çš„å­˜å‚¨è®¾è®¡ï¼šæ—¢è¦æ»¡è¶³æµ·é‡æ¶ˆæ¯çš„å †ç§¯èƒ½åŠ›ï¼Œåˆè¦æ»¡è¶³æå¿«çš„æŸ¥è¯¢æ•ˆç‡ï¼Œè¿˜è¦ä¿è¯å†™å…¥çš„æ•ˆç‡ã€‚
2. é«˜æ•ˆçš„é€šä¿¡ç»„ä»¶è®¾è®¡ï¼šé«˜ååé‡ï¼Œæ¯«ç§’çº§çš„æ¶ˆæ¯æŠ•é€’èƒ½åŠ›éƒ½ç¦»ä¸å¼€é«˜æ•ˆçš„é€šä¿¡ã€‚
3. .......

# RocketMQæœ€ä½³å®è·µ

## ä¸€ã€Produceræœ€ä½³å®è·µ

1ã€ä¸€ä¸ªåº”ç”¨å°½å¯èƒ½ç”¨ä¸€ä¸ª Topicï¼Œæ¶ˆæ¯å­ç±»å‹ç”¨ tags æ¥æ ‡è¯†ï¼Œtags å¯ä»¥ç”±åº”ç”¨è‡ªç”±è®¾ç½®ã€‚åªæœ‰å‘é€æ¶ˆæ¯è®¾ç½®äº†tagsï¼Œæ¶ˆè´¹æ–¹åœ¨è®¢é˜…æ¶ˆæ¯æ—¶ï¼Œæ‰å¯ä»¥åˆ©ç”¨ tags åœ¨ broker åšæ¶ˆæ¯è¿‡æ»¤ã€‚
 2ã€æ¯ä¸ªæ¶ˆæ¯åœ¨ä¸šåŠ¡å±‚é¢çš„å”¯ä¸€æ ‡è¯†ç ï¼Œè¦è®¾ç½®åˆ° keys å­—æ®µï¼Œæ–¹ä¾¿å°†æ¥å®šä½æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ã€‚ç”±äºæ˜¯å“ˆå¸Œç´¢å¼•ï¼Œè¯·åŠ¡å¿…ä¿è¯ key å°½å¯èƒ½å”¯ä¸€ï¼Œè¿™æ ·å¯ä»¥é¿å…æ½œåœ¨çš„å“ˆå¸Œå†²çªã€‚
 3ã€æ¶ˆæ¯å‘é€æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œè¦æ‰“å°æ¶ˆæ¯æ—¥å¿—ï¼ŒåŠ¡å¿…è¦æ‰“å° sendresult å’Œ key å­—æ®µã€‚
 4ã€å¯¹äºæ¶ˆæ¯ä¸å¯ä¸¢å¤±åº”ç”¨ï¼ŒåŠ¡å¿…è¦æœ‰æ¶ˆæ¯é‡å‘æœºåˆ¶ã€‚ä¾‹å¦‚ï¼šæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“ï¼Œèƒ½æœ‰å®šæ—¶ç¨‹åºå°è¯•é‡å‘æˆ–è€…äººå·¥è§¦å‘é‡å‘ã€‚
 5ã€æŸäº›åº”ç”¨å¦‚æœä¸å…³æ³¨æ¶ˆæ¯æ˜¯å¦å‘é€æˆåŠŸï¼Œè¯·ç›´æ¥ä½¿ç”¨`sendOneWay`æ–¹æ³•å‘é€æ¶ˆæ¯ã€‚

## äºŒã€Consumeræœ€ä½³å®è·µ

1ã€æ¶ˆè´¹è¿‡ç¨‹è¦åšåˆ°å¹‚ç­‰ï¼ˆå³æ¶ˆè´¹ç«¯å»é‡ï¼‰
 2ã€å°½é‡ä½¿ç”¨æ‰¹é‡æ–¹å¼æ¶ˆè´¹æ–¹å¼ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜æ¶ˆè´¹ååé‡ã€‚
 3ã€ä¼˜åŒ–æ¯æ¡æ¶ˆæ¯æ¶ˆè´¹è¿‡ç¨‹

## ä¸‰ã€å…¶ä»–é…ç½®

çº¿ä¸Šåº”è¯¥å…³é—­`autoCreateTopicEnable`ï¼Œå³åœ¨é…ç½®æ–‡ä»¶ä¸­å°†å…¶è®¾ç½®ä¸º`false`ã€‚

RocketMQåœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šé¦–å…ˆè·å–è·¯ç”±ä¿¡æ¯ã€‚å¦‚æœæ˜¯æ–°çš„æ¶ˆæ¯ï¼Œç”±äºMQServerä¸Šé¢è¿˜æ²¡æœ‰åˆ›å»ºå¯¹åº”çš„`Topic`ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœä¸Šé¢çš„é…ç½®æ‰“å¼€çš„è¯ï¼Œä¼šè¿”å›é»˜è®¤TOPICçš„ï¼ˆRocketMQä¼šåœ¨æ¯å°`broker`ä¸Šé¢åˆ›å»ºåä¸º`TBW102`çš„TOPICï¼‰è·¯ç”±ä¿¡æ¯ï¼Œç„¶å`Producer`ä¼šé€‰æ‹©ä¸€å°`Broker`å‘é€æ¶ˆæ¯ï¼Œé€‰ä¸­çš„`broker`åœ¨å­˜å‚¨æ¶ˆæ¯æ—¶ï¼Œå‘ç°æ¶ˆæ¯çš„`topic`è¿˜æ²¡æœ‰åˆ›å»ºï¼Œå°±ä¼šè‡ªåŠ¨åˆ›å»º`topic`ã€‚åæœå°±æ˜¯ï¼šä»¥åæ‰€æœ‰è¯¥TOPICçš„æ¶ˆæ¯ï¼Œéƒ½å°†å‘é€åˆ°è¿™å°`broker`ä¸Šï¼Œè¾¾ä¸åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„ã€‚

æ‰€ä»¥åŸºäºç›®å‰RocketMQçš„è®¾è®¡ï¼Œå»ºè®®å…³é—­è‡ªåŠ¨åˆ›å»ºTOPICçš„åŠŸèƒ½ï¼Œç„¶åæ ¹æ®æ¶ˆæ¯é‡çš„å¤§å°ï¼Œæ‰‹åŠ¨åˆ›å»ºTOPICã€‚

# RocketMQè®¾è®¡ç›¸å…³

RocketMQçš„è®¾è®¡å‡å®šï¼š

> æ¯å°PCæœºå™¨éƒ½å¯èƒ½å®•æœºä¸å¯æœåŠ¡
>  ä»»æ„é›†ç¾¤éƒ½æœ‰å¯èƒ½å¤„ç†èƒ½åŠ›ä¸è¶³
>  æœ€åçš„æƒ…å†µä¸€å®šä¼šå‘ç”Ÿ
>  å†…ç½‘ç¯å¢ƒéœ€è¦ä½å»¶è¿Ÿæ¥æä¾›æœ€ä½³ç”¨æˆ·ä½“éªŒ

RocketMQçš„å…³é”®è®¾è®¡ï¼š

> åˆ†å¸ƒå¼é›†ç¾¤åŒ–
>  å¼ºæ•°æ®å®‰å…¨
>  æµ·é‡æ•°æ®å †ç§¯
>  æ¯«ç§’çº§æŠ•é€’å»¶è¿Ÿï¼ˆæ¨æ‹‰æ¨¡å¼ï¼‰

è¿™æ˜¯RocketMQåœ¨è®¾è®¡æ—¶çš„å‡å®šå‰æä»¥åŠéœ€è¦åˆ°è¾¾çš„æ•ˆæœã€‚æˆ‘æƒ³è¿™äº›å‡å®šé€‚ç”¨äºæ‰€æœ‰çš„ç³»ç»Ÿè®¾è®¡ã€‚éšç€æˆ‘ä»¬ç³»ç»Ÿçš„æœåŠ¡çš„å¢å¤šï¼Œæ¯ä½å¼€å‘è€…éƒ½è¦æ³¨æ„è‡ªå·±çš„ç¨‹åºæ˜¯å¦å­˜åœ¨å•ç‚¹æ•…éšœï¼Œå¦‚æœæŒ‚äº†åº”è¯¥æ€ä¹ˆæ¢å¤ã€èƒ½ä¸èƒ½å¾ˆå¥½çš„æ°´å¹³æ‰©å±•ã€å¯¹å¤–çš„æ¥å£æ˜¯å¦è¶³å¤Ÿé«˜æ•ˆã€è‡ªå·±ç®¡ç†çš„æ•°æ®æ˜¯å¦è¶³å¤Ÿå®‰å…¨...... å¤šå¤šè§„èŒƒè‡ªå·±çš„è®¾è®¡ï¼Œæ‰èƒ½å¼€å‘å‡ºé«˜æ•ˆå¥å£®çš„ç¨‹åºã€‚

# å‚è€ƒèµ„æ–™

1. [RocketMQç”¨æˆ·æŒ‡å—](http://pan.baidu.com/s/1kTWsE8J)
2. [RocketMQåŸç†ç®€ä»‹](http://pan.baidu.com/s/1bogcpgN)
3. [RocketMQæœ€ä½³å®è·µ](http://pan.baidu.com/s/1kTXE4PD)
4. [é˜¿é‡Œåˆ†å¸ƒå¼å¼€æ”¾æ¶ˆæ¯æœåŠ¡(ONS)åŸç†ä¸å®è·µ2](http://v.youku.com/v_show/id_XODY4ODE3OTY0.html?from=s1.8-1-1.2)
5. [é˜¿é‡Œåˆ†å¸ƒå¼å¼€æ”¾æ¶ˆæ¯æœåŠ¡(ONS)åŸç†ä¸å®è·µ3](http://v.youku.com/v_show/id_XODY5ODcxNjI0.html?from=s1.8-1-1.2)
6. [RocketMQåŸç†è§£æ](http://blog.csdn.net/column/details/learningrocketmq.html)