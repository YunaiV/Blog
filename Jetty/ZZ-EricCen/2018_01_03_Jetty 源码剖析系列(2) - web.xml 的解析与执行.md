title: Jetty æºç å‰–æç³»åˆ—(2) - web.xml çš„è§£æä¸æ‰§è¡Œ
date: 2018-01-03
tag: 
categories: Jetty
permalink: Jetty/EricCen/web-xmlde-jie-xi-yu-zhi-xing
author: Eric Cen
from_url: http://ericcenblog.com/2017/08/13/jettyyuan-ma-pou-xi-xi-lie-2-web-xmlde-jie-xi-yu-zhi-xing/
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://ericcenblog.com/2017/08/13/jettyyuan-ma-pou-xi-xi-lie-2-web-xmlde-jie-xi-yu-zhi-xing/ ã€ŒEric Cenã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------


å½“ç”¨Jettyæ¥å¯åŠ¨ä¸€ä¸ªwebé¡¹ç›®çš„æ—¶å€™ï¼Œ Jettyä¼šå»è¯»å–waråŒ…çš„WEB-INFOç›®å½•é‡Œé¢çš„web.xmlæ–‡ä»¶ï¼Œç„¶åè§£æè¿™ä¸ªweb.xmlã€‚é‚£è¿™ä¸€æ­¥æ˜¯ä»€ä¹ˆæ—¶å€™è¿›è¡Œå’Œæ•´ä¸ªè¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥åˆ†æä¸€ä¸‹ã€‚

ä»¥ç”¨Jetty Runneræ¥å¯åŠ¨ä¸€ä¸ªwaråŒ…ä¸ºä¾‹ï¼Œ åœ¨`org.eclipse.jetty.runner.Runner`ç±»çš„`configure`æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒå…ˆæ„å»ºå‡ºä¸€ä¸ª`WebAppContext`:![img](http://ericcenblog.com/content/images/2017/08/Jetty1.JPG)

ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬è¦æ³¨æ„`webapp.setConfigurationClasses(_plusConfigurationClasses)`è¿™ä¸€å¥ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹`_plusConfigurationClasses`æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty2.JPG)æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å°±æ˜¯ä¸€ä¸ªStringæ•°ç»„ï¼Œé‡Œé¢åŒ…å«äº†å„ç§Configurationç±»çš„ç±»åï¼Œè¿™é‡Œæˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯`WebXmlConfiguration`è¿™ä¸ªç±»ï¼Œä¸€çœ‹åå­—å°±çŸ¥é“æ˜¯è·Ÿweb.xmlæœ‰å…³çš„ï¼šï¼‰ã€‚æˆ‘ä»¬å†æ¥çœ‹setConfigurationClassesè¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty3.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty4.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty5.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty6.JPG)å¯ä»¥çœ‹åˆ°ä¼šæŠŠ`_plusConfigurationClasses`é‡Œé¢çš„æ‰€æœ‰ç±»éƒ½é€šè¿‡åå°„åˆ›å»ºå‡ºä¸€ä¸ªå®ä¾‹å¯¹è±¡æ¥ï¼Œå…¶ä¸­åŒ…æ‹¬äº†`WebXmlConfiguration`ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¦è·³å»çœ‹`WebAppContext`çš„`doStart`æ–¹æ³•â€”â€”â€”â€”è‡³äºæ˜¯æ€æ ·è°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘è¦å¦èµ·ä¸€ç¯‡æ–‡ç« æ¥å‰–æï¼Œç®€å•è¯´ä¸€ä¸‹ï¼Œå°±æ˜¯ï¼Œ`WebAppContext`æ˜¯å®ç°äº†`Handler`æ¥å£ï¼ŒåŒæ—¶ä¹Ÿå®ç°äº†`LifeCycle`æ¥å£ï¼Œè€Œæ¯ä¸ªHandleråˆæ˜¯è¢«å½“æˆ`org.eclipse.jetty.server.Server`(Jetty HTTP Servlet Server)çš„å†…éƒ¨ç®¡ç†çš„ä¸€ä¸ªBeanï¼Œå½“`Server` startçš„æ—¶å€™ï¼Œè¿™äº›Beanä¹Ÿä¼šè¢«startï¼Œç„¶åå†è°ƒç”¨æ¯ä¸ªbeançš„`doStart`æ–¹æ³•ã€‚ `WebAppContext.doStart()`ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty7.JPG)æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªè°ƒç”¨äº†`preConfigure`æ–¹æ³•ï¼Œæˆ‘ä»¬å¯¹å«è¿™ç§åå­—çš„æ–¹æ³•ä¸€å®šä¸èƒ½æ”¾è¿‡ï¼Œæˆ‘ä»¬å†è¿›å…¥`WebAppContext`çš„`preConfigure`æ–¹æ³•é‡Œï¼Œçœ‹åˆ°å®ƒå…ˆæ˜¯åšäº†ä¸€å¤§å †å·¥ä½œï¼Œæˆ‘ä»¬æš‚ä¸”ä¸ç®¡ï¼Œé‡è¦çš„æ˜¯å®ƒæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š`_configurations.preConfigure(this);` è¿™ä¸ªæ˜¯è°ƒç”¨äº†`Configurations`çš„`preConfigure`æ–¹æ³•:![img](http://ericcenblog.com/content/images/2017/08/Jetty8.JPG)å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯éå†äº†ä¸Šæ–‡ä¸­çš„`_plusConfigurationClasses`æ‰€æœ‰Configurationå®ä¾‹å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„`preConfigur`æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨WebXmlConfigurationçš„`preConfigure`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty9.JPG)çœ‹åˆ°ä¸Šé¢è°ƒç”¨çš„findWebXmlæ–¹æ³•æ²¡ï¼Ÿåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºæ‰¾åˆ°äº†Jettyæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å’Œå“ªé‡Œå»åŠ è½½web.xmlè¿™ä¸ªæ–‡ä»¶ï¼![img](http://ericcenblog.com/content/images/2017/08/Jetty10.JPG)è¿™é‡Œæˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯å®ƒè°ƒç”¨äº†`WebAppContext`çš„`getWebInf`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty11.JPG)æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¼šå»è°ƒç”¨`getBaseResource`æ–¹æ³•ï¼Œå¾—å‡ºä¸€ä¸ªè·¯å¾„ï¼Œç„¶åå†æ‹¼æ¥"WEB-INF"ç›®å½•ï¼Œé‚£ä¹ˆè¿™ä¸ª`BaseResource`åˆæ˜¯ä»€ä¹ˆæ—¶å€™è®¾ç½®çš„å‘¢ï¼Ÿå…¶å®å®ƒæ˜¯åœ¨å¦å¤–ä¸€ä¸ª`Configuration`ç±»ï¼Œ`WebInfConfiguration`çš„`preConfigure`æ–¹æ³•æ—¶è®¾ç½®çš„ï¼š `WebInfConfiguration.preConfigure()`:![img](http://ericcenblog.com/content/images/2017/08/Jetty12.JPG)åœ¨`WebInfConfiguration`çš„`preConfigure`æ–¹æ³•é‡Œï¼Œå®ƒä¼šåœ¨tmpåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œç„¶åå°†waråŒ…è§£å‹å‡ºæ¥ï¼Œè¿™ä¸ªè§£å‹å‡ºæ¥çš„ç›®å½•å°±ä¼šè¢«è®¾ç½®ä¸º`BaseResource`ã€‚ è¿™æ ·`WebXmlConfiguration`å°±ä¼šæŠŠæ‰¾å‡ºæ¥çš„`web.xml`è®¾ç½®ç»™`WebAppContext`çš„`MetaData`:![img](http://ericcenblog.com/content/images/2017/08/Jetty13.JPG)æˆ‘ä»¬ç»§ç»­çœ‹`WebAppContext`çš„`doStart`æ–¹æ³•ï¼Œæ‰§è¡Œå®Œ`preConfigure`æ–¹æ³•åï¼Œå®ƒå°±ä¼šè°ƒç”¨`super.doStart()`,è€Œå®é™…ä¸Šåœ¨`super.doStart`æ–¹æ³•é‡Œï¼Œåˆä¼šè°ƒç”¨å­ç±»çš„`startContext`æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹`WebAppContext`çš„`startContext`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty14.JPG)ç»ˆäºåˆ°äº†configureäº†ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty15.JPG)`Configurations.configure()`:![img](http://ericcenblog.com/content/images/2017/08/Jetty16.JPG)åŒæ ·æ˜¯éå†äº†æ‰€æœ‰`Configuration`ï¼Œç„¶åè°ƒç”¨å®ƒçš„`configure`æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ ·åªå…³æ³¨`WebXmlConfiguration`ï¼Œ `WebXmlConfiguration.configure()`:![img](http://ericcenblog.com/content/images/2017/08/Jetty17-1.JPG)æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒç»™`WebAppContext`çš„`MetaData`æ·»åŠ äº†ä¸€ä¸ªå«`StandardDescriptorProcessor`çš„`DescriptorProcessor`,é‚£æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª`StandardDescriptorProcessor`æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿:![img](http://ericcenblog.com/content/images/2017/08/Jetty1-1.JPG)![img](http://ericcenblog.com/content/images/2017/08/Capture1.JPG)![img](http://ericcenblog.com/content/images/2017/08/Capture2.JPG)

çœ‹åˆ°`listener`,`filter-mapping`,`servlet`,`servlet-mapping`è¿™äº›æ˜¯ä¸æ˜¯è§‰å¾—ä¼¼æ›¾ç›¸è¯†ï¼Ÿè¿™äº›ä¸å°±æ˜¯web.xmlæ–‡ä»¶é‡Œæˆ‘ä»¬å¸¸è§çš„æ ‡ç­¾å—ï¼Ÿï¼å†çœ‹`registerVisitor`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty18.JPG)çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœå‡ºå®ƒé‡Œé¢å®ç°çš„ä¸œè¥¿äº†ï¼Œå°±æ˜¯æ³¨å†Œäº†å½“è§£æåˆ°web.xmlé‡Œé¢çš„æŸä¸ªnodeæ—¶å€™ï¼Œåº”è¯¥è°ƒç”¨`StandardDescriptorProcessor`çš„æ–¹æ³•ï¼Œæ¯”å¦‚å½“è§£æåˆ°`listener`è¿™ä¸ªæ ‡ç­¾çš„æ—¶å€™ï¼Œåº”è¯¥è°ƒç”¨`visitListener`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty19.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty20.JPG)æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¼šä»`web.xml`é‡Œé¢ï¼Œè§£æå‡º`listener-class`,ç„¶åé€šè¿‡åå°„åˆ›å»ºå‡ºä¸€ä¸ª`listener`çš„å®ä¾‹ï¼Œç„¶åæŠŠå®ƒåŠ åˆ°`WebAppContext`çš„`EventListener`åˆ—è¡¨é‡Œã€‚è¿™äº›æ˜¯åœ¨`WebAppContext`çš„`startContext`æ–¹æ³•é‡Œæ‰§è¡Œå®Œ`configure`åï¼Œè°ƒç”¨äº†`MetaData`çš„`resolve`æ–¹æ³•æ¥è¿›è¡Œçš„ï¼Œ`MetaData.resolve()`:![img](http://ericcenblog.com/content/images/2017/08/Jetty21.JPG)`StandardDescriptorProcessor`è°ƒç”¨çš„æ˜¯å®ƒçš„çˆ¶ç±»`IterativeDescriptorProcessor`çš„`process`æ–¹æ³•![img](http://ericcenblog.com/content/images/2017/08/Jetty22.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty23.JPG)å—¯ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œå·²ç»è¯å®æˆ‘ä»¬å‰æ–‡çš„çŒœæµ‹ï¼Œè§£æåˆ°web.xmlçš„æŸä¸ªtagæ—¶ï¼Œå°±ä¼šé€šè¿‡åå°„è°ƒç”¨å‰æ–‡æ³¨å†Œçš„StandardDescriptorProcessorçš„ç›¸åº”æ–¹æ³•ï¼

åœ¨å›åˆ°å‰æ–‡ï¼ŒæŠŠåœ¨web.xmlä¸­è§£æå‡ºæ¥çš„`Listener`åŠ åˆ°EventListeneråˆ—è¡¨é‡Œåšä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å›è¿‡å¤´æ¥ç»§ç»­çœ‹`WebAppContext`çš„`startContext`æ–¹æ³•,åœ¨configureå®Œå’Œresolveå®Œmetadataåï¼Œå®ƒä¼šè°ƒç”¨`super.startContext()`,ä¹Ÿå°±æ˜¯å®ƒçš„çˆ¶ç±»`ServletContextHandler`çš„`startContext`æ–¹æ³•ï¼Œè€Œ`ServletContextHandler`åˆä¼šç»§ç»­è°ƒç”¨å®ƒè‡ªå·±çš„çˆ¶ç±»çš„`startContext()`æ–¹æ³•,ä¹Ÿå°±æ˜¯`ContextHandler`çš„`startContext()`æ–¹æ³•:![img](http://ericcenblog.com/content/images/2017/08/Jetty24.JPG)æˆ‘ä»¬è¿™æ—¶å¯ä»¥çœ‹åˆ°å®ƒä¼šéå†contexté‡Œçš„EventListeneråˆ—è¡¨é‡Œçš„Listenerï¼Œç„¶åè°ƒç”¨å®ƒçš„`contextInitialized`æ–¹æ³•:![img](http://ericcenblog.com/content/images/2017/08/Jetty25.JPG)ã€‚ å¦‚æœæˆ‘ä»¬åœ¨`web.xml`é‡Œé…ç½®äº†å¦‚ä¸‹`Listener`ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty26.JPG)é‚£æˆ‘ä»¬çœ‹çœ‹Springçš„è¿™ä¸ªå¸¸è§çš„ContextLoaderListenerçš„contextInitializedæ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty27.JPG)å®ƒè°ƒç”¨äº†çˆ¶ç±»`ContextLoader`çš„`initWebApplicationContext`æ–¹æ³•ï¼Œ `ContextLoader.initWebApplicationContext`:![img](http://ericcenblog.com/content/images/2017/08/Jetty28.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty29.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty30.JPG)æˆ‘ä»¬çœ‹åˆ°å®ƒå°è¯•å»ä»`ServletContext`(åœ¨æœ¬æ–‡æ˜¯æŒ‡WebAppContextè¿™ä¸ªå­ç±»)çš„`initParameter`ä¸­getåˆ°ä¸€ä¸ªkeyä¸º`CONTEXT_CLASS_PARAM`("contextClass")çš„å€¼ï¼Œè¿™äº›`initParameter`éƒ½æ˜¯åœ¨è§£æ`web.xml`æ—¶è®¾ç½®è¿›å»çš„ï¼Œå¦‚æœæˆ‘ä»¬åœ¨`web.xml`é‡Œé¢æ²¡æœ‰é…ç½®`contextClass`ï¼Œé‚£è¿™ä¸ª`contextClassName`å°±ä¸ºnullï¼Œæ¥ç€å®ƒå°±ä¼šå°è¯•å»`defaultStrategies`é‡Œé¢æ‰¾,![img](http://ericcenblog.com/content/images/2017/08/Jetty31.JPG)

`private static final String DEFAULT_STRATEGIES_PATH = "ContextLoader.properties"`;

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯åˆ°`classpath`é‡ŒæŸ¥æ‰¾ä¸€ä¸ªå«`ContextLoader.properties`çš„æ–‡ä»¶,åœ¨å®ƒçš„classpathçš„spring-web.jaré‡Œé¢æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œå®ƒé‡Œé¢å†…å®¹å¦‚ä¸‹ï¼š`org.springframework.web.context.WebApplicationContext=org.springframework.web.context.support.XmlWebApplicationContext`æ‰¾å‡ºè¿™ä¸ªdefaultçš„`XmlWebApplicationContext`çš„å…¨ç±»ååï¼Œå°±ä¼šåŠ è½½è¿™ä¸ªç±»ï¼Œç„¶åé€šè¿‡åå°„åˆ›å»ºè¿™ä¸ªç±»çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œ å†å›åˆ°`ContextLoader`çš„`initWebApplicationContext`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty32.JPG)å› ä¸º`XmlWebApplicationContext`æ˜¯`ConfigurableWebApplicationContext`çš„ä¸€ä¸ªå®ç°ç±»,æ‰€ä»¥æˆ‘ä»¬ä¼šè¿›å…¥`ContextLoader`çš„`configureAndRefreshWebApplicationContext`æ–¹æ³•ï¼Œ![img](http://ericcenblog.com/content/images/2017/08/Jetty33.JPG)![img](http://ericcenblog.com/content/images/2017/08/Jetty34.JPG)æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä¼šåˆ°`ServletContext`çš„`InitParameter`é‡Œé¢æ‰¾ä¸€ä¸ªkeyä¸º`contextConfigLocation`çš„å‚æ•°ï¼Œå®ƒåŒæ ·ä¹Ÿæ˜¯åœ¨è§£æ`web.xml`æ—¶å¾—åˆ°çš„ï¼Œå…¶å®å®ƒå°±æ˜¯è®¾ç½®äº†`spring`çš„`context`é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š![img](http://ericcenblog.com/content/images/2017/08/Jetty35.JPG)æ‰¾åˆ°è¿™ä¸ªé…ç½®æ–‡ä»¶çš„ä½ç½®åï¼Œå°±ä¼šå¼€å§‹`Spring`çš„`context`çš„åˆå§‹åŒ–ï¼

åˆ°æ­¤ï¼Œæœ¬æ–‡å‰–æäº†`Jetty`è§£æå’Œæ‰§è¡Œ`web.xml`çš„è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯åˆ†æäº†`listener`æ ‡ç­¾å’Œ`context-param`æ ‡ç­¾ï¼Œå…¶ä»–æ ‡ç­¾ï¼Œå¦‚`Servlet`ï¼Œ`servlet-mapping`,`filter`è¿™äº›æ ‡ç­¾ï¼Œä¹Ÿæœ‰ç€ç±»ä¼¼çš„è§£æè¿‡ç¨‹ï¼Œæˆ‘ä¹‹åç»§ç»­å¦èµ·æ–‡ç« å‰–æï¼