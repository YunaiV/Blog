title: Jetty æºç å‰–æç³»åˆ—(4) - Connector å¦‚ä½•æ¥æ”¶å¤„ç†ç½‘ç»œè¯·æ±‚
date: 2018-01-05
tag: 
categories: Jetty
permalink: Jetty/EricCen/connectorru-he-jie-shou-chu-li-wang-luo-qing-qiu
author: Eric Cen
from_url: http://ericcenblog.com/2017/12/01/jettyyuan-ma-pou-xi-xi-lie-4-connectorru-he-jie-shou-chu-li-wang-luo-qing-qiu/
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://ericcenblog.com/2017/12/01/jettyyuan-ma-pou-xi-xi-lie-4-connectorru-he-jie-shou-chu-li-wang-luo-qing-qiu/ ã€ŒEric Cenã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä¹¦æ¥[ä¸Šæ–‡](http://www.iocoder.cn/Jetty/EricCen/connectorru-he-jie-shou-wang-luo-qing-qiu/)ï¼Œä¸Šæ–‡åˆ†æåˆ°`ServerConnector`çš„`doStart`æ–¹æ³•ä¼šæ ¹æ®CPUçš„æ•°é‡åè°ƒå‡ºä¸€å®šæ•°é‡çš„`Acceptor`ï¼Œç„¶åå†æŠŠ`Acceptor`äº¤ç»™çº¿ç¨‹æ± å»æ‰§è¡Œï¼š`AbstractConnector.doStart()`:![img](http://ericcenblog.com/content/images/2017/12/----_20171201174203.png)`Acceptor`å®ç°äº†`Runnable`æ¥å£ï¼Œè¿›å»çœ‹å®ƒçš„`run`æ–¹æ³•:![img](http://ericcenblog.com/content/images/2017/12/1.png)![img](http://ericcenblog.com/content/images/2017/12/2.png)æˆ‘ä»¬æ³¨æ„åˆ°å®ƒåœ¨whileå¾ªç¯é‡Œé¢è°ƒç”¨äº†`accept`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ¥æ”¶ç½‘ç»œè¯·æ±‚çš„å…¥å£äº†ï¼š![img](http://ericcenblog.com/content/images/2017/12/3.png)ä»ä¸Šå›¾çš„`accept`æ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº†`ServerSocketChannel`çš„`accept`æ–¹æ³•ï¼Œæˆ‘ä»¬ç»ˆäºå›å½’åˆ°äº†`NIO`çš„åŸºæœ¬ï¼Œæ³¨æ„`ServerSocketChannel`çš„`accept`æ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œç›´åˆ°æ¥æ”¶åˆ°ä¸€ä¸ªå»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼Œå®ƒå°±ä¼šè¿”å›ä¸€ä¸ª`SocketChannel`ï¼Œç„¶åè°ƒç”¨`accepted`æ–¹æ³•ï¼Œç»§ç»­è¿›å…¥`accepted`æ–¹æ³•çœ‹çœ‹ï¼š![img](http://ericcenblog.com/content/images/2017/12/4.png)å…ˆæŠŠ`SocketChannel`è®¾ç½®ä¸º`nonBlocking`çš„ï¼Œç„¶åä»`SocketChannel`é‡Œæ‹¿å‡º`Socket`è®¾ç½®ä¸€äº›TCPå±æ€§ï¼š![img](http://ericcenblog.com/content/images/2017/12/5.png)æ¯”å¦‚ä¼šæŠŠè¯¥`socket`è®¾ç½®ä¸º`TCP_NODELAY`ï¼Œè¿™ä¸ªæ˜¯è¦disable [Nagle's algorithm](https://en.wikipedia.org/wiki/Nagle%27s_algorithm)ã€‚è®¾ç½®å®Œ`Socket`åï¼Œå°±ä¼šè°ƒç”¨`SelectorManager`çš„`accept`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/6.png)![img](http://ericcenblog.com/content/images/2017/12/7.png)åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†`ManagedSelector`è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿè€Œ`SelectManager`åˆæ˜¯å“ªæ¥çš„ï¼Ÿæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹ä¸€ä¸‹`ServerConnector`çš„æ„é€ æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/8.png)å¯ä»¥çœ‹åˆ°`_manager`æ˜¯åœ¨`ServerConnector`çš„æ„é€ æ–¹æ³•é‡Œé€šè¿‡è°ƒç”¨`newSelectorManager`æ–¹æ³•å¾—åˆ°çš„ï¼Œè€Œ`newSelectorManager`æ–¹æ³•é‡Œå®é™…å°±æ˜¯ç›´æ¥`new`å‡ºæ¥ï¼š![img](http://ericcenblog.com/content/images/2017/12/9.png)å†çœ‹å›`ServerConnector`çš„æ„é€ æ–¹æ³•é‡Œï¼Œ`_manager`ä¼šè¢«åŠ è¿›`ServerConnector`çš„`managedBean`é‡Œé¢ï¼Œåœ¨è°ƒç”¨`ServerConnector`çš„`doStart`æ–¹æ³•æ—¶ï¼Œå®ƒçš„`managedBean`ä¹Ÿä¼šè¢«å¯åŠ¨(è¢«è°ƒç”¨`start`æ–¹æ³•,è¿›è€Œè°ƒç”¨å®ƒçš„`doStart`æ–¹æ³•)ï¼Œ é‚£æˆ‘ä»¬å°±å†è¿›å»çœ‹ä¸€ä¸‹`SelectorManager`çš„`doStart`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/10.png)å®ƒå…ˆæ˜¯é€šè¿‡`newSelector`æ–¹æ³•åˆ›å»º`ManagedSelector`,`ManagedSelector`æ•°ç›®æ˜¯è·ŸCPUæ•°ç›®åè°ƒå‡ºæ¥çš„ï¼Œ ç„¶åå†æŠŠ`ManagedSelector`åŠ è¿›`SelectManager`çš„`managedBean`é‡Œé¢ï¼ŒåŒæ ·åœ¨å¯åŠ¨`SelectManager`çš„`doStart`æ–¹æ³•æ—¶ï¼Œ`ManagedSelector`çš„`doStart`æ–¹æ³•ä¹Ÿä¼šè¢«å¯åŠ¨ï¼š![img](http://ericcenblog.com/content/images/2017/12/11.png)`ManagedSelector`çš„`doStart`å…ˆé€šè¿‡`SelectorManager`çš„`newSelector`æ–¹æ³•åˆ›å»ºå‡ºä¸€ä¸ª`Selector`,è¿™ä¸ª`selector`å°±æ˜¯Java NIOé‡Œé¢çš„`Selector`ï¼š![img](http://ericcenblog.com/content/images/2017/12/12.png)ç„¶å`SelectorManager`ä¼šexecute`_strategy`çš„`produce`æ–¹æ³•(è¿™é‡Œç”¨çš„Java 8çš„è¯­æ³•)ï¼Œé‚£ä¹ˆ`_strategy`æ˜¯å•¥å‘¢ï¼Ÿæˆ‘ä»¬çœ‹å›`ManagedSelector`çš„æ„é€ æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/13.png)æˆ‘ä»¬çœ‹åˆ°`_strategy`æ˜¯`EatWhatYouKill`ï¼Ÿè¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿè¿™ä¸ªå‘½åå®åœ¨æ˜¯æœ‰æ„æ€ã€‚æˆ‘ä»¬æš‚ä¸”æŒ‰ä¸‹ä¸è¡¨ã€‚æˆ‘ä»¬çœ‹åˆ°`_strategy`åŒæ ·ä¼šè¢«åŠ è¿›`ManagedSelector`çš„`managedBean`é‡Œé¢ï¼Œé‚£å°±ä»£è¡¨å¯åŠ¨`ManagedSelector`çš„æ—¶å€™ï¼Œ`_strategy`çš„`doStart`æ–¹æ³•ä¹Ÿä¼šè¢«å¯åŠ¨ï¼Œè€Œ`EatWhatYouKill`å¹¶æ²¡æœ‰é‡å†™`ContainerLifeCycle`çš„`doStart`æ–¹æ³•ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹`EatWhatYouKill`çš„æ„é€ æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/14.png)æˆ‘ä»¬çœ‹åˆ°`Producer`è¢«åŠ è¿›`EatWhatYouKill`çš„`managedBean`é‡Œé¢äº†ï¼Œé‚£è¿™ä¸ª`Producer`åˆæ˜¯ä»€ä¹ˆé¬¼ï¼Ÿæˆ‘ä»¬å†å›åˆ°ManagedSelectorçš„æ„é€ æ–¹æ³•é‡Œï¼š![img](http://ericcenblog.com/content/images/2017/12/13-1.png)æˆ‘ä»¬çœ‹åˆ°`Producer`æ˜¯`SelectorProducer`ï¼Œ åœ¨å‰é¢`ManagedSelecto`rçš„`doStart`æ–¹æ³•é‡Œï¼Œ `selectorManager`æ‰§è¡Œ`EatWhaYouKill`çš„`produce`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/15.png)æˆ‘ä»¬å†çœ‹`EatWhatYouKill`çš„`doProduce`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/16.png)å¯ä»¥çœ‹åˆ°å®é™…è°ƒç”¨çš„`SelectorProduce`çš„`produce`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/17.png)å½“æˆ‘çœ‹åˆ°é‡Œé¢è°ƒç”¨çš„select()æ–¹æ³•æ—¶ï¼ŒçœŸçš„æœ‰ç§â€œç»ˆäºç­‰åˆ°ä½ ï¼Œè¿˜å¥½æˆ‘æ²¡æ”¾å¼ƒâ€çš„æ„Ÿè§‰ï¼šï¼‰![img](http://ericcenblog.com/content/images/2017/12/18.png)åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ— è®ºæ€ä¹ˆå†™ï¼Œæœ€ç»ˆè¿˜æ˜¯ç”¨åˆ°æœ€åŸºæœ¬çš„Java NIOã€‚ æˆ‘ä»¬å†å›å¤´çœ‹`SelectProducer`çš„`produce`æ–¹æ³•é‡Œè°ƒç”¨çš„`processSelected`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/19.png)å®ƒä»`key`é‡Œé¢æ‹¿å‡º`attachment`ï¼Œå¦‚æœ`attachment`æ˜¯`Selectable`çš„ï¼Œæ¯”å¦‚è¯´æ˜¯ä¸€ä¸ª`EndPoint`çš„è¯ï¼Œå®ƒå°±ä¼šè°ƒç”¨è¯¥`attachment`çš„`onSelected`æ–¹æ³•(è¿™é‡Œæœ‰ä¸ªå¼ºè½¬å‹)ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„`attachment`æ˜¯`SocketChannelEndPoint`ï¼Œé‚£æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„`onSelected`æ–¹æ³•(ä»`ChannelEndPoint`ç»§æ‰¿è€Œæ¥)ï¼š![img](http://ericcenblog.com/content/images/2017/12/20.png)å®ƒä¼šæ ¹æ®selectkeyçš„çŠ¶æ€è¿”å›ä¸åŒçš„Runnable Taskï¼Œ åˆ†åˆ«æœ‰`runCompleteWriteFillable`, `runFillable`å’Œ`runCompleteWrite`ä¸‰ç§ï¼Œ![img](http://ericcenblog.com/content/images/2017/12/21.png)![img](http://ericcenblog.com/content/images/2017/12/22.png)![img](http://ericcenblog.com/content/images/2017/12/23.png)`EatWhatYouKill`çš„`doProduce`æ–¹æ³•æ‹¿åˆ°è¿™ä¸ª`Runnable Task`åï¼Œå°†ä¼šæ‰§è¡Œå®ƒçš„`run`æ–¹æ³•ï¼Œæ¯”å¦‚`runFillable`çš„ï¼Œå®ƒä¼šè°ƒç”¨`FillInterest`çš„`fillable`æ–¹æ³•ï¼š![img](http://ericcenblog.com/content/images/2017/12/24.png)å¯ä»¥çœ‹åˆ°å®ƒå®é™…è°ƒç”¨çš„æ˜¯`Callback`çš„`succeeded`æ–¹æ³•ã€‚é‚£è¿™ä¸ª`Callback`åˆæ˜¯ä»€ä¹ˆï¼Ÿ

ä¸‹å›åˆ†è§£ï¼šï¼‰