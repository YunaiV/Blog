title: SOFA-Mosn æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»º
date: 2018-01-01
tags:
categories: SOFA Mosn
permalink: SOFA-Mosn/build-debugging-environment

---

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. æ¦‚è¿°](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [2. ä¾èµ–å·¥å…·](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [3. è·å–ä»£ç ](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [4. å¯¼å…¥IDE](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [5. å¯åŠ¨ Mosn](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [6. å¯åŠ¨ SOFA-Server](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [7. å¯åŠ¨ SOFA-Client](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [8. ç…ä¸€ç… config.json](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)
- [666. å½©è›‹](http://www.iocoder.cn/SOFA-Mosn/build-debugging-environment/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬å°†åŸºäº SOFA-Mosn æä¾›çš„ [sofarpc-sample](https://github.com/alipay/sofa-mosn/tree/34880fca45e71b170f06152ecadbe4c204d81401/examples/sofarpc-sample) ç¤ºä¾‹ï¼Œæ­å»ºä¸€ä¸ªèƒ½å¤Ÿ**æ–­ç‚¹**è°ƒè¯•çš„ç¯å¢ƒã€‚

[sofarpc-sample](https://github.com/alipay/sofa-mosn/tree/34880fca45e71b170f06152ecadbe4c204d81401/examples/sofarpc-sample) ç¤ºä¾‹çš„ç®€ä»‹å¦‚ä¸‹ï¼š

> FROM [ã€Šé…ç½® SOFARPC åè®® SOFAMeshã€‹](https://github.com/alipay/sofa-mosn/tree/34880fca45e71b170f06152ecadbe4c204d81401/examples/sofarpc-sample)
> 
> * è¯¥æ ·ä¾‹å·¥ç¨‹æ¼”ç¤ºäº†å¦‚ä½•é…ç½®ä½¿å¾— SOFAMesh ä½œä¸º SofaRpc ä»£ç†ã€‚
> * SOFAMesh ä¹‹é—´çš„åè®®æ˜¯ HTTP2 ã€‚
> * ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼ŒSOFAMesh ç›‘å¬ä¸¤ä¸ªç«¯å£,ä¸€ä¸ªè½¬å‘ Client çš„è¯·æ±‚ï¼Œä¸€ä¸ªæ”¶åˆ°è¯·æ±‚ä»¥åè½¬å‘ç»™ Server ã€‚

å¯èƒ½è¿™æ ·å­èƒ–å‹æœ‰ç‚¹æ‡µé€¼ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€å¼ å›¾ï¼š

![æˆ‘æ˜¯å›¾](http://www.iocoder.cn/images/SOFA-Mosn/2018_01_01/01.png)

ğŸ˜ˆ å¯èƒ½æœ‰èƒ–å‹åˆæ‡µé€¼äº†ï¼Œä¸æ˜¯ Service Mesh éœ€è¦ Istio ä¹ˆï¼Ÿåœ¨æœ¬æ–‡çš„æ­å»ºçš„ç¤ºä¾‹é‡Œï¼ŒIstio å¹¶éå¿…é¡»ã€‚

# 2. ä¾èµ–å·¥å…·

* Go ï¼š1.9.2+

    > ç¬”è€…æ˜¯ Mac ç¯å¢ƒï¼Œä½¿ç”¨ `brew install go` å®‰è£…çš„ Go ã€‚

* GoLand  

    > è‰¿è‰¿çš„æƒŠå¹ï¼šGoLand ç«Ÿç„¶å¯ä»¥ç›´æ¥è°ƒè¯• Go ä»£ç ï¼Œå®Œå…¨ä¸ç”¨é…ç½®ç¯å¢ƒï¼Œå¥½æ£’ï¼ï¼ï¼æ­¤å¤„æ˜¯ä¸æ˜¯åº”è¯¥è®© GoLand æ‰“ä¸€ç¬”å¹¿å‘Šè´¹åˆ°æˆ‘è´¦å¤´ä¸Šã€‚

# 3. è·å–ä»£ç 

```bash
# è¿›å…¥ GOPATH ä¸‹çš„ src ç›®å½•
cd $GOPATH/src
# åˆ›å»º github.com/alipay ç›®å½•
mkdir -p github.com/alipay
cd github.com/alipay

# clone mosn ä»£ç 
git clone git@github.com:alipay/sofa-mosn.git
cd sofa-mosn
```

æœ€ç»ˆ Mosn çš„æºä»£ç ä»£ç è·¯å¾„ä¸º `$GOPATH/src/github.com/alipay/sofa-mosn` ã€‚

# 4. å¯¼å…¥IDE

ä½¿ç”¨èŒèŒçš„ GoLand å¯¼å…¥ `$GOPATH/src/github.com/alipay/sofa-mosn` é¡¹ç›®ã€‚

# 5. å¯åŠ¨ Mosn

â‘  å³é”® `cmd/mosn/main` ç›®å½•ï¼Œ**Debug** è¿è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å³é”® Debug è¿è¡Œ](http://www.iocoder.cn/images/SOFA-Mosn/2018_01_01/02.png)

â‘¡ æ¯«æ— æ„å¤–ï¼Œæˆ‘ä»¬å‘ç°å¹¶æœª Debug æˆåŠŸè¿è¡Œï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š

```bash
API server listening at: 127.0.0.1:50592
NAME:
   mosn - MOSN is modular observable smart netstub.

USAGE:
   ___go_build_github_com_alipay_sofa_mosn_cmd_mosn_main [global options] command [command options] [arguments...]

VERSION:
   0.0.1

COMMANDS:
     start    start mosn proxy
     stop     stop mosn proxy
     reload   reconfiguration
     help, h  Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --help, -h     show help
   --version, -v  print the version

COPYRIGHT:
   (c) 2018 Ant Financial
```

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æ²¡æœ‰é…ç½® Mosn éœ€è¦çš„é…ç½®æ–‡ä»¶ã€‚ä¿®æ”¹ `go build github.com/alipay/sofa-mosn/cmd/mosn/main` çš„ **Run/Debug Configurations** ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![Run/Debug Configurations](http://www.iocoder.cn/images/SOFA-Mosn/2018_01_01/03.png)

* çº¢æ¡† Program arguments å¡«å…¥ `start -c /Users/yunai/Go/src/github.com/alipay/sofa-mosn/examples/sofarpc-sample/config.json` ã€‚å…¶ä¸­ï¼Œ`/Users/yunai/Go/src/github.com/alipay/sofa-mosn/examples/sofarpc-sample/config.json` ä¿®æ”¹æˆè‡ªå·±çš„ `/Users/yunai/Go` ä¿®æ”¹æˆè‡ªå·±çš„ `$GOPATH` ã€‚ 

ç„¶åï¼Œé‡æ–°ç‚¹å‡»å°è™«è™«ï¼Œè¿›å…¥è°ƒè¯•æ¨¡å¼ã€‚è¾“å…¥å¦‚ä¸‹æ—¥å¿—ï¼š

```bash
API server listening at: 127.0.0.1:50637
2018/09/06 22:52:05 load config from :  /Users/yunai/Go/src/github.com/alipay/sofa-mosn/examples/sofarpc-sample/config.json
2018/09/06 22:52:05 [INFO]start by config : &{Servers:[{ServerName: DefaultLogPath:stdout DefaultLogLevel: UseNetpollMode:false GracefulTimeout:0s Processor:0 Listeners:[{Name:serverListener Address:127.0.0.1:2046 BindToPort:true Inspector:false FilterChains:[{FilterChainMatch: TLS:{Status:false Type: ServerName: CACert: CertChain: PrivateKey: VerifyClient:false InsecureSkip:false CipherSuites: EcdhCurves: MinVersion: MaxVersion: ALPN: Ticket: ExtendVerify:map[]} Filters:[{Type:proxy Config:map[downstream_protocol:Http2 upstream_protocol:SofaRpc virtual_hosts:[map[name:serverHost domains:[*] routers:[map[match:map[headers:[map[name:service value:.*]]] route:map[cluster_name:serverCluster]]]]]]}]}] StreamFilters:[] LogPath:stdout LogLevel: HandOffRestoredDestinationConnections:false AccessLogs:[]} {Name:clientListener Address:127.0.0.1:2045 BindToPort:true Inspector:false FilterChains:[{FilterChainMatch: TLS:{Status:false Type: ServerName: CACert: CertChain: PrivateKey: VerifyClient:false InsecureSkip:false CipherSuites: EcdhCurves: MinVersion: MaxVersion: ALPN: Ticket: ExtendVerify:map[]} Filters:[{Type:proxy Config:map[downstream_protocol:SofaRpc upstream_protocol:Http2 virtual_hosts:[map[name:clientHost domains:[*] routers:[map[match:map[headers:[map[name:service value:.*]]] route:map[cluster_name:clientCluster]]]]]]}]}] StreamFilters:[] LogPath:stdout LogLevel: HandOffRestoredDestinationConnections:false AccessLogs:[]}]}] ClusterManager:{AutoDiscovery:false RegistryUseHealthCheck:false Clusters:[{Name:serverCluster Type:SIMPLE SubType: LbType:LB_RANDOM MaxRequestPerConn:1024 ConnBufferLimitBytes:32768 CircuitBreakers:[] HealthCheck:{Protocol: Timeout:0s Interval:0s IntervalJitter:0s HealthyThreshold:0 UnhealthyThreshold:0 CheckPath: ServiceName:} ClusterSpecConfig:{Subscribes:[]} Hosts:[{Address:127.0.0.1:8080 Hostname: Weight:0 MetaData:map[] TLSDisable:false}] LBSubsetConfig:{FallBackPolicy:0 DefaultSubset:map[] SubsetSelectors:[]} TLS:{Status:false Type: ServerName: CACert: CertChain: PrivateKey: VerifyClient:false InsecureSkip:false CipherSuites: EcdhCurves: MinVersion: MaxVersion: ALPN: Ticket: ExtendVerify:map[]}} {Name:clientCluster Type:SIMPLE SubType: LbType:LB_RANDOM MaxRequestPerConn:1024 ConnBufferLimitBytes:32768 CircuitBreakers:[] HealthCheck:{Protocol: Timeout:0s Interval:0s IntervalJitter:0s HealthyThreshold:0 UnhealthyThreshold:0 CheckPath: ServiceName:} ClusterSpecConfig:{Subscribes:[]} Hosts:[{Address:127.0.0.1:2046 Hostname: Weight:0 MetaData:map[] TLSDisable:false}] LBSubsetConfig:{FallBackPolicy:0 DefaultSubset:map[] SubsetSelectors:[]} TLS:{Status:false Type: ServerName: CACert: CertChain: PrivateKey: VerifyClient:false InsecureSkip:false CipherSuites: EcdhCurves: MinVersion: MaxVersion: ALPN: Ticket: ExtendVerify:map[]}}]} ServiceRegistry:{ServiceAppInfo:{AntShareCloud:false DataCenter: AppName:} ServicePubInfo:[]} RawDynamicResources:[] RawStaticResources:[]}
2018/09/06 22:52:05 [WARN]healthcheck for cluster is disabled
2018/09/06 22:52:05 [WARN]healthcheck for cluster is disabled
2018/09/06 22:52:05 [WARN]Mesh Doesn't Support Dynamic Router
2018/09/06 22:52:05 [WARN]Mesh Doesn't Support Dynamic Router
2018/09/06 22:52:05 [INFO]xds client start
2018/09/06 22:52:05 [ERROR]StaticResources is null
2018/09/06 22:52:05 [WARN]fail to init xds config, skip xds: null point exception
```

â‘¢ éªŒè¯ Mosn å¯åŠ¨æˆåŠŸ

ä½¿ç”¨ `telnet` è¿æ¥ 2045 ç«¯å£ã€‚å¦‚ä¸‹æ˜¯è‰¿è‰¿çš„ç¤ºä¾‹ï¼š

```bash
Yunai-Macbook:sofa-mosn yunai$ telnet 127.0.0.1 2045
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
```

è¿æ¥æˆåŠŸï¼Œè¡¨ç¤º Mosn å¯åŠ¨æˆåŠŸã€‚

# 6. å¯åŠ¨ SOFA-Server

â‘  å¯åŠ¨

æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œè¾“å…¥å‘½ä»¤ã€‚

```bash
# è·³åˆ°å®ä¾‹ç›®å½•
cd $GOPATH/src/github.com/alipay/sofa-mosn/examples/sofarpc-sample
# å¯åŠ¨ SOFA-Server
go run server.go
```

â‘¡ éªŒè¯

ä½¿ç”¨ `telnet` è¿æ¥ 8080 ç«¯å£ã€‚å¦‚ä¸‹æ˜¯è‰¿è‰¿çš„ç¤ºä¾‹ï¼š

```bash
Yunai-Macbook:sofa-mosn yunai$ telnet 127.0.0.1 8080
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
```

# 7. å¯åŠ¨ SOFA-Client

â‘  å¯åŠ¨

æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œè¾“å…¥å‘½ä»¤ã€‚

```bash
# è·³åˆ°å®ä¾‹ç›®å½•
cd $GOPATH/src/github.com/alipay/sofa-mosn/examples/sofarpc-sample
# å¯åŠ¨ SOFA-Client
go run client.go
```

â‘¡ æ—¥å¿—

**Client** çš„æ—¥å¿—å¦‚ä¸‹ï¼š

```bash
2018/09/06 23:02:08 [DEBUG]connect raw tcp, remote address = 127.0.0.1:2045 ,event = ConnectedFlag, error = <nil>
2018/09/06 23:02:08 [DEBUG]AddConnectionEventListener Success, cb = &{context:0xc000175020 Protocol:SofaRpc Connection:0xc00017e380 Host:<nil> Codec:0xc000316000 ActiveRequests:0xc000174ff0 AcrMux:{w:{state:0 sema:0} writerSem:0 readerSem:0 readerCount:0 readerWait:0} CodecCallbacks:<nil> CodecClientCallbacks:<nil> StreamConnectionCallbacks:<nil> ConnectedFlag:false RemoteCloseFlag:false}
2018/09/06 23:02:08 [INFO]AppendHeaders,request id = 1, direction = 0
2018/09/06 23:02:08 [DEBUG]Decoderprotocol code = 1, maybeProtocolVersion = 0
2018/09/06 23:02:08 [DEBUG]deserialize header map: map[querystring: service:testSofa accept-encoding:gzip host:127.0.0.1:2046 date:Thu, 06 Sep 2018 15:02:08 GMT path:/ user-agent:Go-http-client/2.0 content-length:0]
2018/09/06 23:02:08 [DEBUG]Response ClassName is: 
2018/09/06 23:02:08 [INFO]streamID=1,protocol=bolt
[RPC Client] Receive Data:1
Response Headers are: map[path:/ protocol:1 cmdtype:0 version:1 respstatus:0 classname: service:testSofa requestid:1 content-length:0 date:Thu, 06 Sep 2018 15:02:08 GMT resptimemills:1536246128878 x-mosn-endstream:yes x-mosn-streamid:1 accept-encoding:gzip host:127.0.0.1:2046 user-agent:Go-http-client/2.0 cmdcode:2 codec:1 classlen:0 headerlen:208 contentlen:0 querystring:]
```

**Server** çš„æ—¥å¿—å¦‚ä¸‹ï¼š

```bash
[RPC Server] get connection : 127.0.0.1:50802
[RPC Server] reponse connection: 127.0.0.1:50802, requestId: 1
```

**Mosn** çš„æ—¥å¿—å¦‚ä¸‹ï¼š

```bash
2018/09/06 23:04:47 [INFO]accept connection from:127.0.0.1:2045
2018/09/06 23:04:47 [INFO]OnReceiveHeaders, New stream detected, Request id = 1, StreamID = 3
2018/09/06 23:04:47 [INFO]AppendHeaders,request id = 3, direction = 0
2018/09/06 23:04:47 [INFO]AppendData,request id = 3, direction = 0
2018/09/06 23:04:47 [INFO]streamID=3,protocol=bolt
2018/09/06 23:04:47 [INFO]AppendHeaders,request id = 3, direction = 1
2018/09/06 23:04:47 [INFO]AppendData,request id = 3, direction = 1
2018/09/06 23:04:50 [ERROR]Error on read. Connection = 7, Remote Address = 127.0.0.1:50801, err = EOF
2018/09/06 23:05:51 [INFO]accept connection from:127.0.0.1:2045
2018/09/06 23:05:51 [INFO]OnReceiveHeaders, New stream detected, Request id = 1, StreamID = 5
2018/09/06 23:05:51 [INFO]AppendHeaders,request id = 5, direction = 0
2018/09/06 23:05:51 [INFO]AppendData,request id = 5, direction = 0
2018/09/06 23:05:51 [INFO]streamID=5,protocol=bolt
2018/09/06 23:05:51 [INFO]AppendHeaders,request id = 5, direction = 1
2018/09/06 23:05:51 [INFO]AppendData,request id = 5, direction = 1
```

-------

å¦‚æœèƒ–å‹å¸Œæœ› SOFA-Client æŒç»­å¯åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ `go run client.go -t` ï¼Œå®ƒå°†åƒæ¿€å…‰æªä¸€æ ·ï¼Œæ¯ 3 ç§’å‘å°„ä¸€æ¬¡è¯·æ±‚ã€‚biubiubiu~

# 8. ç…ä¸€ç… config.json 

å› ä¸ºç¬”è€…ä¹Ÿæ˜¯åˆšåˆšæ‰çœ‹äº† Istio ï¼Œæ‰€ä»¥å¯¹ `config.json` ä¸æ˜¯å¾ˆç†è§£ã€‚çæ¯”æ¯”è§£é‡Šä¸‹ï¼Œç›´æ¥æ¥çœ‹é…ç½®æ–‡ä»¶ï¼š

```JSON
{
    "servers": [ // <1>
        {
            "default_log_path": "stdout", 
            "listeners": [
                {
                    "name": "serverListener", 
                    "address": "127.0.0.1:2046", 
                    "bind_port": true, 
                    "log_path": "stdout", 
                    "filter_chains": [
                        {
                            "tls_context": { }, 
                            "filters": [
                                {
                                    "type": "proxy", 
                                    "config": {
                                        "downstream_protocol": "Http2", 
                                        "upstream_protocol": "SofaRpc", 
                                        "virtual_hosts": [
                                            {
                                                "name": "serverHost", 
                                                "domains": [
                                                    "*"
                                                ], 
                                                "routers": [
                                                    {
                                                        "match": {
                                                            "headers": [
                                                                {
                                                                    "name": "service", 
                                                                    "value": ".*"
                                                                }
                                                            ]
                                                        }, 
                                                        "route": {
                                                            "cluster_name": "serverCluster"
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                }, 
                {
                    "name": "clientListener", 
                    "address": "127.0.0.1:2045", 
                    "bind_port": true, 
                    "log_path": "stdout", 
                    "filter_chains": [
                        {
                            "tls_context": { }, 
                            "filters": [
                                {
                                    "type": "proxy", 
                                    "config": {
                                        "downstream_protocol": "SofaRpc", 
                                        "upstream_protocol": "Http2", 
                                        "virtual_hosts": [
                                            {
                                                "name": "clientHost", 
                                                "domains": [
                                                    "*"
                                                ], 
                                                "routers": [
                                                    {
                                                        "match": {
                                                            "headers": [
                                                                {
                                                                    "name": "service", 
                                                                    "value": ".*"
                                                                }
                                                            ]
                                                        }, 
                                                        "route": {
                                                            "cluster_name": "clientCluster" // <2>
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ], 
    "cluster_manager": {
        "clusters": [ // <3>
            {
                "Name": "serverCluster", 
                "type": "SIMPLE", 
                "lb_type": "LB_RANDOM", 
                "max_request_per_conn": 1024, 
                "conn_buffer_limit_bytes": 32768, 
                "hosts": [
                    {
                        "address": "127.0.0.1:8080"
                    }
                ]
            }, 
            {
                "Name": "clientCluster", 
                "type": "SIMPLE", 
                "lb_type": "LB_RANDOM", 
                "max_request_per_conn": 1024, 
                "conn_buffer_limit_bytes": 32768, 
                "hosts": [
                    {
                        "address": "127.0.0.1:2046"
                    }
                ]
            }
        ]
    }
}
```

* `<1>` å¤„çš„ `servers` ä¸­ï¼Œé…ç½®äº†ä¸¤ä¸ª `listeners` ï¼Œåˆ†åˆ«æ˜¯ï¼š
    * `clientListener` ï¼šç›‘å¬ 2045 ç«¯å£ã€‚
        * è¿™ä¹Ÿå°±ä¸ºä»€ä¹ˆåœ¨ [ã€Œ5. å¯åŠ¨ Mosnã€](#) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `telnet` è¿æ¥ 2045 çš„åŸå› ã€‚
        * å¦å¤–ï¼Œåœ¨ `examples/sofarpc-sample/client.go` ä¸­ï¼Œçœ‹åˆ° SOFA-Client è¯·æ±‚çš„ä¹Ÿæ˜¯ Mosn 2045 ç«¯å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

            ```Go
            func main() {
            	log.InitDefaultLogger("", log.DEBUG)
            	t := flag.Bool("t", false, "-t")
            	flag.Parse()
            	if client := NewClient("127.0.0.1:2045"); client != nil {
            		for {
            			client.Request()
            			time.Sleep(200 * time.Millisecond)
            			if !*t {
            				time.Sleep(3 * time.Second)
            				return
            			}
            		}
            	}
            }
            ```
            * è§ `"127.0.0.1:2045"` å¤„ã€‚
        * åœ¨ `<2>` å¤„ï¼Œé…ç½®è·¯ç”±è½¬å‘ç»™ `"clientCluster"` é›†ç¾¤ã€‚
        
    * `serverListener` ï¼šç›‘å¬ 2046 ç«¯å£ã€‚ğŸ˜ˆ è¿™é‡Œå…ˆè·³è¿‡ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚

* `<3>` å¤„çš„ `cluster_manager` ä¸­ï¼Œé…ç½®äº†ä¸¤ä¸ª `clusters` ï¼Œåˆ†åˆ«æ˜¯ï¼š
    * `clientCluster` ï¼š`hosts` åœ°å€åªæœ‰ä¸€ä¸ªæ˜¯ `"127.0.0.1:2046"` ã€‚å³ï¼Œè¯·æ±‚ä¼šè½¬å‘åˆ° `serverListener` ä¸Šï¼Œå› ä¸ºå®ƒç›‘å¬äº† 2046 ç«¯å£ã€‚
    * `clusters` ï¼š`hosts` åœ°å€åªæœ‰ä¸€ä¸ªæ˜¯ `"127.0.0.1:8080"` ï¼Œå³å¯¹åº”çš„ SOFA-Server çš„åœ°å€ã€‚ä¸ºä»€ä¹ˆæ˜¯ SOFA-Server çš„åœ°å€å‘¢ï¼Ÿç­”æ¡ˆåœ¨ `examples/sofarpc-sample/server.go` ï¼Œä»£ç å¦‚ä¸‹ï¼š

        ```Go
        func main() {
        	ln, err := net.Listen("tcp", "127.0.0.1:8080")
        	if err != nil {
        		fmt.Println(err)
        		return
        	}
        	server := &SofaRPCServer{ln}
        	server.Run()
        }
        ```
        * è§ `"127.0.0.1:8080"` å¤„ã€‚

OK ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹ `serverListener` ã€‚è™½ç„¶åœ¨ `sofarpc-sample` ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªå¯åŠ¨äº† Mosn ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯é€šè¿‡é…ç½®ä¸¤ä¸ª `listeners` æ¥æ¨¡æ‹Ÿä¸¤ä¸ª Mosn è¿›ç¨‹ï¼š

* `clientListener` æä¾›ç»™ SOFA-Client è¯·æ±‚ã€‚
* `serverListener` è½¬å‘è¯·æ±‚ç»™ SOFA-Server å¤„ç†ã€‚

è€Œ `clientListener` å’Œ `serverListener` ä¹‹é—´ï¼Œé€šè¿‡ HTTP2 åè®®ï¼Œ`clientListener` å°†è¯·æ±‚è½¬å‘åˆ°ç›‘å¬ 2046 ç«¯å£ä¸Šçš„ `serverListener` ã€‚

æ€»ç»“æ¥è¯´ï¼š

```
SOFA-Client => [2045] clientListener => serverCluster(serverListener) => serverCluster(SOFA-Server)
```

# 666. å½©è›‹

ä½œä¸ºè¿˜æ²¡å…¥é—¨ Istio å’Œ Go è¯­è¨€çš„å°èœé¸¡ï¼Œç°å¸¸ç´§å¼ çš„å†™å®Œäº†è¿™ç¯‡æ–‡ç« ã€‚å¦‚æœæœ‰ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œçƒ¦è¯·å¤§ä½¬æ·±åˆ»æ•™è‚²ï¼Œå°è‰¿è‰¿ä½å¤´å­¦ä¹ ã€‚

-------

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)
