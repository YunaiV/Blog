title: ã€è¿½å…‰è€…ç³»åˆ—ã€‘HikariCP ç‰©ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸä»‹ç»ï¼ˆæœ‰å¤§é‡å›¾ç‰‡å“¦ï½ï¼‰
date: 2018-01-17
tags:
categories: HikariCP
permalink: HikariCP/zhazhawangzi/lifecycle
author: æ¸£æ¸£ç‹å­
from_url: https://mp.weixin.qq.com/s/wn0CQ0MAogObhnKgFUXLxQ
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://mp.weixin.qq.com/s/wn0CQ0MAogObhnKgFUXLxQ ã€Œæ¸£æ¸£ç‹å­ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

HikariCPä¸­çš„è¿æ¥å–ç”¨æµç¨‹å¦‚ä¸‹ï¼š

![img](http://static.iocoder.cn/mp/mmbiz_png/a5BAX19eYnW9kE1HEQWniarxaQbfX3KWyJVy8mVJviaUoQUk31JYdVFTo0vr8R0TrdqoVBOAWvjUc3XKXOm3dMBg/640)

å…¶ä¸­HikariPoolè´Ÿè´£å¯¹èµ„æºè¿æ¥è¿›è¡Œç®¡ç†ï¼Œè€ŒConcurrentBagåˆ™æ˜¯ä½œä¸ºç‰©ç†è¿æ¥çš„å…±äº«èµ„æºç«™ï¼ŒPoolEntryåˆ™æ˜¯å¯¹ç‰©ç†è¿æ¥çš„1-1å°è£…ã€‚

PoolEntryé€šè¿‡borrowæ–¹æ³•ä»bagä¸­å–å‡ºï¼Œä¹‹åé€šè¿‡PoolEntry.createProxyConnectionè°ƒç”¨å·¥å‚ç±»ç”ŸæˆHikariProxyConnectionè¿”å›ã€‚

![img](http://static.iocoder.cn/mp/mmbiz_png/a5BAX19eYnW9kE1HEQWniarxaQbfX3KWy1MAxZltqpGUnjdR5EqaUCCmDwgAVgiaHgGvEE4BAyRhGuYu7Ypx0icEw/640)

HikariProxyConnectionè°ƒç”¨closeæ–¹æ³•æ—¶è°ƒç”¨äº†PooleEntryçš„recycleæ–¹æ³•ï¼Œä¹‹åé€šè¿‡HikariPoolè°ƒç”¨äº†ConcurrentBagçš„requiteæ”¾å›ã€‚ï¼ˆpoolEntryé€šè¿‡borrowä»bagä¸­å–å‡ºï¼Œå†é€šè¿‡requiteæ”¾å›ã€‚èµ„æºæˆåŠŸå›æ”¶ï¼‰ã€‚

HikariCPä¸­çš„è¿æ¥ç”Ÿæˆæµç¨‹å¦‚ä¸‹ï¼š

![img](http://static.iocoder.cn/mp/mmbiz_png/a5BAX19eYnW9kE1HEQWniarxaQbfX3KWymufRQ9ibhiaOWguyzeU8UkcrwxicvewVeiao0CtNh3VtB7rjOKnddUiabCg/640)

HikariCPä¸­é€šè¿‡ç‹¬ç«‹çš„çº¿ç¨‹æ± addConnectionExecutorè¿›è¡Œæ–°è¿æ¥çš„ç”Ÿæˆï¼Œè¿æ¥ç”Ÿæˆæ–¹æ³•ä¸ºPoolEntryCreatorã€‚

ç‰©ç†é“¾æ¥çš„ç”Ÿæˆåªç”±PoolBaseçš„newConnection()å®ç°ï¼Œä¹‹åå°è£…æˆPoolEntryï¼Œé€šè¿‡Bagçš„addæ–¹æ³•åŠ å…¥ConcurrentBagã€‚

å½“ConcurrentBagå­˜åœ¨ç­‰å¾…çº¿ç¨‹ï¼Œæˆ–è€…æœ‰è¿æ¥è¢«å…³é—­æ—¶ï¼Œä¼šè§¦å‘IBagItemListenerçš„addBagItem(wait)æ–¹æ³•ï¼Œè°ƒç”¨PoolEntryCreatorè¿›è¡Œæ–°è¿æ¥çš„ç”Ÿæˆã€‚

HikariCPä¸­çš„è¿æ¥å…³é—­æµç¨‹å¦‚ä¸‹ï¼š

![img](http://static.iocoder.cn/mp/mmbiz_png/a5BAX19eYnW9kE1HEQWniarxaQbfX3KWyCqOr4Hia1Gq51tVPg5ZHloibGcJAiaMaibKBCd1EXqOdvVes2J8l0aJ4QQ/640)

closeConnectionExecutorå…³é—­è¿æ¥åï¼Œä¼šè°ƒç”¨fillPool()æ–¹æ³•å¯¹è¿æ¥æ± è¿›è¡Œè¿æ¥å¡«å……ã€‚

åŒæ—¶HikariPoolæä¾›evictConnection(Connection)æ–¹æ³•å¯¹ç‰©ç†è¿æ¥è¿›è¡Œæ‰‹åŠ¨å…³é—­ã€‚

ä»¥ä¸‹æ˜¯ç®€è¦çš„æ•´ç†è¿æ¥å˜åŒ–å¯¼å‘å›¾ï¼š

![img](http://static.iocoder.cn/mp/mmbiz_png/a5BAX19eYnW9kE1HEQWniarxaQbfX3KWy1V2VxrM1M0mWJ56GyIhfkahbz2rOo9348pzyicmMtCHCMC1YAd44qzQ/640)

# 666. å½©è›‹

å¦‚æœä½ å¯¹ HikariCP æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)