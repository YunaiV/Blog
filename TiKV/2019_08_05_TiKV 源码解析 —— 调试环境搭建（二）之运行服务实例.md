title: TiKV æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»ºï¼ˆäºŒï¼‰ä¹‹è¿è¡ŒæœåŠ¡å®ä¾‹
date: 2019-08-05
tags:
categories:
permalink: TiKV/build-debugging-environment-second

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/TiKV/build-debugging-environment-second/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. å®‰è£… PD](http://www.iocoder.cn/TiKV/build-debugging-environment-second/)
- [2. å¯åŠ¨ TiKV](http://www.iocoder.cn/TiKV/build-debugging-environment-second/)
- [3. ä½¿ç”¨ TiKV](http://www.iocoder.cn/TiKV/build-debugging-environment-second/)
  - [3.1 TiDB](http://www.iocoder.cn/TiKV/build-debugging-environment-second/)
  - [3.2 tikv-client-lib-java](http://www.iocoder.cn/TiKV/build-debugging-environment-second/)
- [666. å½©è›‹](http://www.iocoder.cn/TiKV/build-debugging-environment-second/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

æœ¬æ–‡æ¥ [ã€ŠTiKV æºç è§£æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»ºï¼ˆä¸€ï¼‰ä¹‹è¿è¡Œå•å…ƒæµ‹è¯•ã€‹](http://www.iocoder.cn/TiKV/build-debugging-environment/?self) ï¼Œä¸»è¦åˆ†äº«å¦‚ä½•æ­å»º**è¿è¡ŒæœåŠ¡å®ä¾‹**çš„è°ƒè¯•ç¯å¢ƒã€‚

# 1. å®‰è£… PD

> FROM [https://github.com/pingcap/pd](https://github.com/pingcap/pd)  
> PD is the abbreviation for Placement Driver. It is used to manage and schedule the [TiKV](https://github.com/pingcap/tikv) cluster.  
> PD supports distribution and fault-tolerance by embedding [etcd](https://github.com/coreos/etcd).

å®‰è£…å‘½ä»¤å¦‚ä¸‹ ï¼š

```bash
git clone https://github.com/pingcap/pd
cd pd
make build
```

å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ ï¼š

```bash
cd bin
nohup ./pd-server --data-dir=pd --log-file=pd.log &
```

æµ‹è¯•å¯åŠ¨æ˜¯å¦æˆåŠŸå‘½ä»¤å¦‚ä¸‹ ï¼š

```bash
telnet 127.0.0.1 2379
```
* `2379` ä¸º PD æœåŠ¡çš„**é»˜è®¤**ç«¯å£ã€‚

# 2. å¯åŠ¨ TiKV

**å¦‚ä¸‹æ“ä½œå…¨éƒ¨åœ¨ IntelliJ IDEA ä¸­è¿›è¡Œ**ã€‚

-------

æ‰“å¼€ `src/bin/tikv-server.rs` æ–‡ä»¶ï¼Œå³é”® `RUN 'tikv-server'` è¿è¡Œã€‚æ­¤æ—¶ï¼Œ**è¿è¡ŒæŠ¥é”™**ã€‚åŸå› æ˜¯ `pd endpoints` **æœªé…ç½®**ã€‚ä¿®æ”¹ `Command` çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚æ“ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. å¤åˆ¶ `etc/config-template.toml` æ–‡ä»¶ï¼Œç”Ÿæˆ `etc/config.toml` æ–‡ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šä¿®æ”¹è¯¥æ–‡ä»¶**è‡ªå®šä¹‰é…ç½®**ã€‚

2. é…ç½® `--config` è·¯å¾„ï¼Œå¦‚ä¸‹å›¾ ï¼š![](http://www.iocoder.cn/images/TiKV/2019_08_05/01.png)
    * ç‚¹å‡» ã€**çº¢æ¡†éƒ¨åˆ†**ã€‘ï¼Œæ‰“å¼€ `Run/Debug Configurations` çª—å£ã€‚
    * ä¿®æ”¹ ã€**çº¢çº¿éƒ¨åˆ†**ã€‘ï¼Œ`-- --config=${path}` ï¼Œ**è¯·è®¾ç½®æˆä½ è‡ªå·±çš„ `etc/config.toml` æ–‡ä»¶æ‰€åœ¨è·¯å¾„å™¢**ã€‚
    * ä¿å­˜ã€‚

3. æ‰“å¼€ `src/bin/tikv-server.rs` æ–‡ä»¶ï¼Œå³é”® `RUN 'tikv-server'` è¿è¡Œã€‚
4. æ­¤æ—¶ï¼Œ**è¿è¡ŒæŠ¥é”™**ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥ï¼Œè§£å†³æ¯ä¸€ä¸ªæŠ¥é”™ã€‚

-------

é—®é¢˜ ï¼š`please specify pd.endpoints` ã€‚

ä¿®æ”¹ `etc/config.toml` æ–‡ä»¶ï¼Œé…ç½® `endpoints = ["127.0.0.1:2379"]` ã€‚

![](http://www.iocoder.cn/images/TiKV/2019_08_05/02.png)

å‚è€ƒæ–‡ç«  ï¼š[ã€ŠPassing program arguments through Cargoã€‹](https://stackoverflow.com/questions/32400231/passing-program-arguments-through-cargo)

-------

é—®é¢˜ ï¼š`the maximum number of open file descriptors is too small, got {}, expect greater or equal to {}` ã€‚

è§£å†³æ–‡ç«  ï¼š[ã€Šincrease-the-maximum-number-of-open-file-descriptors-in-snow-leopardã€‹](https://superuser.com/questions/302754/increase-the-maximum-number-of-open-file-descriptors-in-snow-leopard)

-------

é—®é¢˜ ï¼š`failed to create kv engine: "Invalid argument: Compression type ZSTD is not linked with the binary."` ã€‚

* æ–¹æ¡ˆä¸€ ï¼šä¸ä½¿ç”¨å‹ç¼©ã€‚

    ä¿®æ”¹ `etc/config.toml` æ–‡ä»¶ï¼Œé…ç½® `compression-per-level = ["no", "no", "no", "no", "no", "no", "no"]` ã€‚æœ‰å¤šå¤„ï¼Œå°å¿ƒåˆ«æ¼äº†ã€‚
    
    ![](http://www.iocoder.cn/images/TiKV/2019_08_05/03.png)

* æ–¹æ¡ˆäºŒ ï¼šTODO ã€3001ã€‘ç¼–è¯‘å®‰è£… zstd ã€‚https://github.com/facebook/zstd

-------

é—®é¢˜ ï¼š`invalid configuration: StringError("default rocksdb exist, buf raftdb not exist")` ã€‚

* ä¿®æ”¹ `etc/config.toml` æ–‡ä»¶ï¼Œé…ç½® `raftdb-path = "/Users/yunai/pingcap/debugger/raftdb"` ã€‚

    ![](http://www.iocoder.cn/images/TiKV/2019_08_05/04.png)

* ä¿®æ”¹ `etc/config.toml` æ–‡ä»¶ï¼Œé…ç½® `data-dir = "/Users/yunai/pingcap/debugger/data"` ã€‚

    ![](http://www.iocoder.cn/images/TiKV/2019_08_05/05.png)

-------

æ­¤æ—¶ï¼Œç¬”è€…è¿è¡Œ TiKV è¿è¡ŒæœåŠ¡å®ä¾‹**æˆåŠŸ**ï¼Œå¼€æ£®ï¼Œå¸Œæœ›èƒ–å‹ä¹Ÿé¡ºåˆ©ã€‚è¿è¡ŒæˆåŠŸæ—¥å¿—å¦‚ä¸‹ ï¼š

```bash
[INFO] TiKV is ready to serve
```

æµ‹è¯•å¯åŠ¨æ˜¯å¦æˆåŠŸå‘½ä»¤å¦‚ä¸‹ ï¼š

```bash
telnet 127.0.0.1 20160
```
* `20160` ä¸º TiKV æœåŠ¡çš„**é»˜è®¤**ç«¯å£ã€‚

# 3. ä½¿ç”¨ TiKV

ä¸‹é¢ï¼Œæˆ‘ä»¬è¦å°è¯• TiKV å­˜å‚¨æ•°æ®ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ ï¼š

* ç¬¬ä¸€ç§ï¼Œä½¿ç”¨ TiDB ã€‚
* ç¬¬äºŒç§ï¼Œä½¿ç”¨ `tikv-client-lib-java` ã€‚

ç¬”è€…ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§ï¼Œ**å¤±è´¥**ï¼Œå› æ­¤åé¢æ¢æˆäº†ç¬¬ä¸€ç§ï¼Œ**æˆåŠŸ**ã€‚

## 3.1 TiDB

å®‰è£…è¿‡ç¨‹å¦‚ä¸‹ ï¼š

1. å¦‚æœèƒ–å‹æœªé…ç½® `GOPATH` **ç¯å¢ƒå˜é‡**ï¼Œå‚è€ƒ [ã€Šä½¿ç”¨Homebrewå®‰è£…é…ç½®golangç¯å¢ƒã€‹](https://segmentfault.com/a/1190000008317179) ã€‚
2. å®‰è£…å‘½ä»¤å¦‚ä¸‹ ï¼š

    ```bash
    git clone https://github.com/pingcap/tidb.git $GOPATH/src/github.com/pingcap/tidb
    cd $GOPATH/src/github.com/pingcap/tidb
    make
    ```

å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ ï¼š

```bash
cd bin
nohup ./tidb-server --store=tikv  --path="127.0.0.1:2379"   --log-file=tidb.log &
```
* å‚è€ƒè‡ªæ–‡ç«  ï¼š[ã€Štidb â€”â€” Quick Startã€‹](https://github.com/pingcap/tidb/blob/master/docs/QUICKSTART.md#pre-requirement)

æµ‹è¯•å¯åŠ¨æ˜¯å¦æˆåŠŸå‘½ä»¤å¦‚ä¸‹ ï¼š

```bash
telnet 127.0.0.1 4000
```
* `4000` ä¸º TiDB æœåŠ¡çš„**é»˜è®¤**ç«¯å£ã€‚

è¿æ¥ TiDB Server ï¼Œç¬”è€…ä½¿ç”¨ MySQL å›¾å½¢å·¥å…· Navicat ï¼Œè¿æ¥é…ç½®å¦‚ä¸‹ ï¼š

![](http://www.iocoder.cn/images/TiKV/2019_08_05/06.png)

* è¯·æ„‰å¿«çš„ä½¿ç”¨ MySQL è¿›è¡Œæ“ä½œå§ã€‚

## 3.2 tikv-client-lib-java

1. å…‹éš†é¡¹ç›® `tikv-client-lib-java` ï¼Œåœ°å€ä¸º [https://github.com/pingcap/tikv-client-lib-java](https://github.com/pingcap/tikv-client-lib-java) ã€‚
2. å‘½ä»¤è¡Œè¾“å…¥ ï¼š`mvn package` ï¼Œæ‰“åŒ…å‡º `tikv-client-0.1.0-SNAPSHOT.jar` ã€‚
3. åˆ›å»ºæµ‹è¯•é¡¹ç›®ï¼Œå¯¼å…¥ `tikv-client-0.1.0-SNAPSHOT.jar` ï¼Œè¿è¡Œ [ã€Š How to use for now ã€‹](https://github.com/pingcap/tikv-client-lib-java#how-to-use-for-now) æä¾›çš„ç¤ºä¾‹ï¼ŒæŠ¥é”™å¦‚ä¸‹ ï¼š

    ```bash
    19:39:42.085 [main] INFO  com.pingcap.tikv.PDClient - Switched to new leader: com.pingcap.tikv.PDClient$LeaderWrapper@4961f6af
Exception in thread "main" java.lang.IndexOutOfBoundsException: Index: -1
	at java.util.Collections$EmptyList.get(Collections.java:4454)
	at com.pingcap.tikv.operation.ScanIterator.hasNext(ScanIterator.java:113)
	at com.pingcap.tikv.catalog.CatalogTransaction.hashGetFields(CatalogTransaction.java:115)
	at com.pingcap.tikv.catalog.CatalogTransaction.getDatabases(CatalogTransaction.java:137)
	at com.pingcap.tikv.catalog.Catalog$CatalogCache.loadDatabases(Catalog.java:106)
	at com.pingcap.tikv.catalog.Catalog$CatalogCache.<init>(Catalog.java:49)
	at com.pingcap.tikv.catalog.Catalog$CatalogCache.<init>(Catalog.java:46)
	at com.pingcap.tikv.catalog.Catalog.<init>(Catalog.java:115)
	at com.pingcap.tikv.TiSession.getCatalog(TiSession.java:82)
	at me.yunai.doraemon.tikv.Demo001.main(Demo001.java:22)
    ```

TODO ã€3002ã€‘tikv-client-lib-java

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

åˆæ˜¯è¢«ç‹™å‡»çš„ä¸€ä¸ªè¿‡ç¨‹ï¼ŒæŠ˜è…¾äº†ä¸€å¤©ï¼Œç»ˆäºå®Œç¨¿ï¼

å¥½å•¦ï¼Œèƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼


