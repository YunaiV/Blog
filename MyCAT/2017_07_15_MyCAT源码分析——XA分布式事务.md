title: MyCAT æºç åˆ†æ  â€”â€” XAåˆ†å¸ƒå¼äº‹åŠ¡
date: 2017-07-15
tags:
categories: MyCAT
permalink: MyCAT/xa-distributed-transaction

---

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

- [1. æ¦‚è¿°](#)
- [2. XA æ¦‚å¿µ](#)
- [3. MyCAT ä»£ç å®ç°](#)
	- [3.1 JDBC Demo ä»£ç ](#)
	- [3.2 MyCAT å¼€å¯ XA äº‹åŠ¡](#)
	- [3.3 MyCAT æ¥æ”¶ SQL](#)
	- [3.4 MySQL æ¥æ”¶ COMMIT](#)
		- [3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡](#)
		- [3.4.2 åè°ƒæ—¥å¿—](#)
		- [3.4.3 MultiNodeCoordinator](#)
	- [3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡](#)
- [4. MyCAT å®ç°ç¼ºé™·](#)
	- [4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½](#)
	- [4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT](#)
	- [4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡](#)
	- [4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—](#)
	- [4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†](#)
- [5. å½©è›‹](#)

-------

# 1. æ¦‚è¿°

æ•°æ®åº“æ‹†åˆ†åï¼Œä¸šåŠ¡ä¸Šä¼šç¢°åˆ°éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ã€‚MyCAT åŸºäº XA å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚å›½å†…ç›®å‰å¦å¤–ä¸€æ¬¾å¾ˆç«çš„æ•°æ®åº“ä¸­é—´ä»¶ Sharding-JDBC å‡†å¤‡åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

æœ¬æ–‡å†…å®¹åˆ†æˆä¸‰éƒ¨åˆ†ï¼š

1. XA æ¦‚å¿µç®€è¿°
2. MyCAT ä»£ç å¦‚ä½•å®ç° XA
3. MyCAT åœ¨å®ç° XA å­˜åœ¨çš„ä¸€äº›ç¼ºé™·

# 2. XA æ¦‚å¿µ

>
X/Open ç»„ç»‡ï¼ˆå³ç°åœ¨çš„ Open Group ï¼‰å®šä¹‰äº†åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ¨¡å‹ã€‚ X/Open DTP æ¨¡å‹ï¼ˆ 1994 ï¼‰åŒ…æ‹¬ï¼š  
1. åº”ç”¨ç¨‹åºï¼ˆ **AP** ï¼‰  
2. äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ **TM** ï¼‰  
3. èµ„æºç®¡ç†å™¨ï¼ˆ **RM** ï¼‰  
4. é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ **CRM** ï¼‰    
ä¸€èˆ¬ï¼Œå¸¸è§çš„äº‹åŠ¡ç®¡ç†å™¨ï¼ˆ TM ï¼‰æ˜¯äº¤æ˜“ä¸­é—´ä»¶ï¼Œå¸¸è§çš„èµ„æºç®¡ç†å™¨ï¼ˆ **RM** ï¼‰æ˜¯æ•°æ®åº“ï¼Œå¸¸è§çš„é€šä¿¡èµ„æºç®¡ç†å™¨ï¼ˆ **CRM** ï¼‰æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸‹å›¾æ˜¯X/Open DTPæ¨¡å‹ï¼š

![](http://www.iocoder.cn/images/MyCAT/2017_07_15/01.png)

> ä¸€èˆ¬çš„ç¼–ç¨‹æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š  
1. é…ç½® **TM** ï¼Œé€šè¿‡ **TM** æˆ–è€… **RM** æä¾›çš„æ–¹å¼ï¼ŒæŠŠ **RM** æ³¨å†Œåˆ° **TM**ã€‚å¯ä»¥ç†è§£ä¸ºç»™ **TM** æ³¨å†Œ **RM** ä½œä¸ºæ•°æ®æºã€‚ä¸€ä¸ª **TM** å¯ä»¥æ³¨å†Œå¤šä¸ª **RM**ã€‚  
2. **AP** ä» **TM** è·å–èµ„æºç®¡ç†å™¨çš„ä»£ç†ï¼ˆä¾‹å¦‚ï¼šä½¿ç”¨JTAæ¥å£ï¼Œä»TMç®¡ç†çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè·å–å‡ºè¿™ä¸ªTMæ‰€ç®¡ç†çš„RMçš„JDBCè¿æ¥æˆ–JMSè¿æ¥ï¼‰  
**AP** å‘ **TM** å‘èµ·ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚è¿™æ—¶ï¼Œ**TM** ä¼šé€šçŸ¥å„ä¸ª **RM**ã€‚**XID**ï¼ˆå…¨å±€äº‹åŠ¡IDï¼‰ä¼šé€šçŸ¥åˆ°å„ä¸ªRMã€‚  
3. **AP** é€šè¿‡ **TM** ä¸­è·å–çš„è¿æ¥ï¼Œ**é—´æ¥**æ“ä½œ **RM** è¿›è¡Œä¸šåŠ¡æ“ä½œã€‚è¿™æ—¶ï¼Œ**TM** åœ¨æ¯æ¬¡ **AP** æ“ä½œæ—¶æŠŠ **XID**(åŒ…æ‹¬æ‰€å±åˆ†æ”¯çš„ä¿¡æ¯)ä¼ é€’ç»™ **RM**ï¼Œ**RM** æ­£æ˜¯é€šè¿‡è¿™ä¸ª **XID** å…³è”æ¥æ“ä½œå’Œäº‹åŠ¡çš„å…³ç³»çš„ã€‚  
4. **AP** ç»“æŸå…¨å±€äº‹åŠ¡æ—¶ï¼Œ**TM** ä¼šé€šçŸ¥ **RM** å…¨å±€äº‹åŠ¡ç»“æŸã€‚å¼€å§‹äºŒæ®µæäº¤ï¼Œä¹Ÿå°±æ˜¯prepare - commitçš„è¿‡ç¨‹ã€‚

-------

> XAåè®®æŒ‡çš„æ˜¯TMï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å’ŒRMï¼ˆèµ„æºç®¡ç†å™¨ï¼‰ä¹‹é—´çš„æ¥å£ã€‚ç›®å‰ä¸»æµçš„å…³ç³»å‹æ•°æ®åº“äº§å“éƒ½æ˜¯å®ç°äº†XAæ¥å£çš„ã€‚JTA(Java Transaction API)æ˜¯ç¬¦åˆX/Open DTPæ¨¡å‹çš„ï¼Œäº‹åŠ¡ç®¡ç†å™¨å’Œèµ„æºç®¡ç†å™¨ä¹‹é—´ä¹Ÿä½¿ç”¨äº†XAåè®®ã€‚ æœ¬è´¨ä¸Šä¹Ÿæ˜¯å€ŸåŠ©ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œä¸‹é¢åˆ†åˆ«æ¥çœ‹çœ‹XAäº‹åŠ¡æˆåŠŸå’Œå¤±è´¥çš„æ¨¡å‹å›¾ï¼š

![æˆåŠŸ](http://www.iocoder.cn/images/MyCAT/2017_07_15/02.png)

![å¤±è´¥](http://www.iocoder.cn/images/MyCAT/2017_07_15/03.png)

-------

ğŸ˜ˆ çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰ç§é»‘äººé—®å·çš„æ„Ÿè§‰ï¼Ÿæ·¡å®šï¼æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ MyCAT ä»£ç å±‚é¢æ˜¯å¦‚ä½•å®ç° XA çš„ã€‚å¦å¤–ï¼Œæœ‰å…´è¶£å¯¹æ¦‚å¿µäº†è§£æ›´å¤šçš„ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹æ–‡ç« ï¼š

1. [ã€ŠXAäº‹åŠ¡å¤„ç†ã€‹](http://www.infoq.com/cn/articles/xa-transactions-handle)
2. [ã€ŠXA Transaction SQL Syntaxã€‹](https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html)
3. [ã€ŠMySQL XA äº‹åŠ¡æ”¯æŒè°ƒç ”ã€‹](http://www.voidcn.com/blog/gao1738/article/p-4554083.html)

# 3. MyCAT ä»£ç å®ç°

* MyCAT ï¼šTMï¼Œåè°ƒè€…ã€‚
* æ•°æ®èŠ‚ç‚¹ ï¼šRMï¼Œå‚ä¸è€…ã€‚

## 3.1 JDBC Demo ä»£ç 

```Java
public class MyCATXAClientDemo {

    public static void main(String[] args) throws ClassNotFoundException, SQLException {
        // 1. è·å¾—æ•°æ®åº“è¿æ¥
        Class.forName("com.mysql.jdbc.Driver");
        Connection conn = DriverManager.getConnection("jdbc:mysql://127.0.0.1:8066/dbtest", "root", "123456");
        conn.setAutoCommit(false);

        // 2. å¼€å¯ MyCAT XA äº‹åŠ¡
        conn.prepareStatement("set xa=on").execute();

        // 3. æ’å…¥ SQL
        // 3.1 SQL1 Aåº“
        long uid = Math.abs(new Random().nextLong());
        String username = UUID.randomUUID().toString();
        String password = UUID.randomUUID().toString();
        String sql1 = String.format("insert into t_user(id, username, password) VALUES (%d, '%s', '%s')",
                uid, username, password);
        conn.prepareStatement(sql1).execute();
        // 3.2 SQL2 Båº“
        long orderId = Math.abs(new Random().nextLong());
        String nickname = UUID.randomUUID().toString();
        String sql2 = String.format("insert into t_order(id, uid, nickname) VALUES(%d, %s, '%s')", orderId, uid, nickname);
        conn.prepareStatement(sql2).execute();

        // 4. æäº¤ XA äº‹åŠ¡
        conn.commit();
    }

}
```

* `set xa=on` MyCAT å¼€å¯ XA äº‹åŠ¡ã€‚
* `conn.commit` æäº¤ XA äº‹åŠ¡ã€‚ 

## 3.2 MyCAT å¼€å¯ XA äº‹åŠ¡

å½“ MyCAT æ¥æ”¶åˆ° `set xa = on` å‘½ä»¤æ—¶ï¼Œå¼€å¯ XA äº‹åŠ¡ï¼Œå¹¶ç”Ÿæˆ XA äº‹åŠ¡ç¼–å·ã€‚XA äº‹åŠ¡ç¼–å·ç”Ÿæˆç®—æ³•ä¸º UUIDã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
// SetHandler.java
public static void handle(String stmt, ServerConnection c, int offset) {
		int rs = ServerParseSet.parse(stmt, offset);
		switch (rs & 0xff) {
		// ... çœç•¥ä»£ç 
		case XA_FLAG_ON: {
			if (c.isAutocommit()) {
				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, "set xa cmd on can't used in autocommit connection ");
				return;
			}
			c.getSession2().setXATXEnabled(true);
			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));
			break;
		}
		case XA_FLAG_OFF: {
			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,
					"set xa cmd off not for external use ");
			return;
		}
		// ... çœç•¥ä»£ç 
	}
}
// NonBlockingSession.java
public void setXATXEnabled(boolean xaTXEnabled) {
   if (xaTXEnabled) {
       if (this.xaTXID == null) {
           xaTXID = genXATXID(); // ğŸ˜ˆğŸ˜ˆğŸ˜ˆè·å¾— XA äº‹åŠ¡ç¼–å·
       }
   } else {
       this.xaTXID = null;
   }
}
private String genXATXID() {
   return MycatServer.getInstance().getXATXIDGLOBAL();
}
// MycatServer.java
public String getXATXIDGLOBAL() {
   return "'" + getUUID() + "'";
}
public static String getUUID() { // ğŸ˜ˆğŸ˜ˆğŸ˜ˆ
   String s = UUID.randomUUID().toString();
   return s.substring(0, 8) + s.substring(9, 13) + s.substring(14, 18) + s.substring(19, 23) + s.substring(24);
}
```

## 3.3 MyCAT æ¥æ”¶ SQL

æ­¤å¤„ SQL æŒ‡çš„æ˜¯ `insert`ã€`update`ã€`delete` æ“ä½œã€‚

å½“å‘æŸä¸ªæ•°æ®èŠ‚ç‚¹**ç¬¬ä¸€æ¬¡**å‘èµ· SQL æ—¶ï¼Œä¼šåœ¨ SQL å‰é¢é™„åŠ  `XA START 'xaTranId'`ï¼Œå¹¶è®¾ç½®è¯¥æ•°æ®èŠ‚ç‚¹**è¿æ¥**äº‹åŠ¡çŠ¶æ€ä¸º `TxState.TX_STARTED_STATE`ï¼ˆ*åˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€ï¼Œä¸‹æ–‡ä¼šä¸“é—¨æ•´ç†*ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
// MySQLConnection.java
private void synAndDoExecute(String xaTxID, RouteResultsetNode rrn,
                                 int clientCharSetIndex, int clientTxIsoLation,
                                 boolean clientAutoCommit) {
   String xaCmd = null;
   boolean conAutoComit = this.autocommit;
   String conSchema = this.schema;
   // never executed modify sql,so auto commit
   boolean expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;
   if (expectAutocommit == false && xaTxID != null && xaStatus == TxState.TX_INITIALIZE_STATE) { // ğŸ˜ˆğŸ˜ˆğŸ˜ˆ
       xaCmd = "XA START " + xaTxID + ';';
       this.xaStatus = TxState.TX_STARTED_STATE;
   }
   // .... çœç•¥ä»£ç 
   StringBuilder sb = new StringBuilder();
   // .... çœç•¥ä»£ç 
   if (xaCmd != null) {
       sb.append(xaCmd);
   }
   // and our query sql to multi command at last
   sb.append(rrn.getStatement() + ";");
   // syn and execute others
   this.sendQueryCmd(sb.toString());
}
```

ä¸¾ä¸ª å˜é‡`sb` çš„ä¾‹å­ï¼š

```SQL
SET names utf8;SET autocommit=0;XA START '1f2da7353e8846e5833b8d8dd041cfb1','db2';insert into t_user(id, username, password) VALUES (3400, 'b7c5ec1f-11cc-4599-851c-06ad617fec42', 'd2694679-f6a2-4623-a339-48d4a868be90');
```

## 3.4 MySQL æ¥æ”¶ COMMIT

### 3.4.1 å•èŠ‚ç‚¹äº‹åŠ¡ or å¤šèŠ‚ç‚¹äº‹åŠ¡

`COMMIT` æ‰§è¡Œæ—¶ï¼ŒMyCAT ä¼šåˆ¤æ–­ XA äº‹åŠ¡é‡Œï¼Œæ¶‰åŠåˆ°çš„æ•°æ®åº“èŠ‚ç‚¹æ•°é‡ã€‚

* å¦‚æœèŠ‚ç‚¹æ•°é‡ä¸º 1ï¼Œå•èŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ `CommitNodeHandler` å¤„ç†ã€‚
* å¦‚æœèŠ‚ç‚¹æ•°é‡ > 1ï¼Œå¤šèŠ‚ç‚¹äº‹åŠ¡ï¼Œä½¿ç”¨ `MultiNodeCoordinator` å¤„ç†ã€‚

`CommitNodeHandler` ç›¸æ¯” `MultiNodeCoordinator` æ¥è¯´ï¼Œåªæœ‰ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¸éœ€è¦è¿›è¡Œå¤šèŠ‚ç‚¹åè°ƒï¼Œé€»è¾‘ä¼šç›¸å¯¹ç®€å•ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å¦å¤–çœ‹ã€‚æˆ‘ä»¬ä¸»è¦åˆ†æ `MultiNodeCoordinator`ã€‚

### 3.4.2 åè°ƒæ—¥å¿—

**åè°ƒæ—¥å¿—**ï¼Œè®°å½•åè°ƒè¿‡ç¨‹ä¸­å„æ•°æ®èŠ‚ç‚¹ XA äº‹åŠ¡çŠ¶æ€ï¼Œå¤„ç†**MyCATå¼‚å¸¸å¥”æºƒ**æˆ–è€…**æ•°æ®èŠ‚ç‚¹éƒ¨åˆ†XA COMMITï¼Œå¦å¤–éƒ¨åˆ† XA PREPARE**ä¸‹çš„çŠ¶æ€æ¢å¤ã€‚

**XA äº‹åŠ¡å…±æœ‰ç§**ï¼š

1. TX_INITIALIZE_STATE ï¼šäº‹åŠ¡åˆå§‹åŒ–
2. TX_STARTED_STATE ï¼šäº‹åŠ¡å¼€å§‹å®Œæˆ
3. TX_PREPARED_STATE ï¼šäº‹åŠ¡å‡†å¤‡å®Œæˆ
4. TX_COMMITED_STATE ï¼šäº‹åŠ¡æäº¤å®Œæˆ
5. TX_ROLLBACKED_STATE ï¼šäº‹åŠ¡å›æ»šå®Œæˆ

**çŠ¶æ€å˜æ›´æµ** ï¼šTX_INITIALIZE_STATE => TX_STARTED_STATE => TX_PREPARED_STATE => TX_COMMITED_STATE / TX_ROLLBACKED_STATE ã€‚

**åè°ƒæ—¥å¿—åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†**ï¼š

1. CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—
2. ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—ã€‚**æ­¤å¤„ï¼Œæ•°æ®èŠ‚ç‚¹æ‰®æ¼”å‚ä¸è€…çš„è§’è‰²ã€‚ä¸‹æ–‡ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å‚ä¸è€…ä¸æ•°æ®èŠ‚ç‚¹æ··ç”¨çš„æƒ…å†µï¼Œæœ›è§è°…ã€‚**

_ä¸€æ¬¡ XA äº‹åŠ¡ï¼Œå¯¹åº”ä¸€æ¡ `CoordinatorLogEntry`ã€‚ä¸€æ¡`CoordinatorLogEntry` åŒ…å« Næ¡`ParticipantLogEntry`_ã€‚ æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
// CoordinatorLogEntry ï¼šåè°ƒè€…æ—¥å¿—
public class CoordinatorLogEntry implements Serializable {

    /**
     * XA äº‹åŠ¡ç¼–å·
     */
    public final String id;
    /**
     * å‚ä¸è€…æ—¥å¿—æ•°ç»„
     */
    public final ParticipantLogEntry[] participants;
}
// ParticipantLogEntry ï¼šå‚ä¸è€…æ—¥å¿—
public class ParticipantLogEntry implements Serializable {

    /**
     * XA äº‹åŠ¡ç¼–å·
     */
    public String coordinatorId;
    /**
     * æ•°æ®åº“ uri
     */
    public String uri;
    /**
     * è¿‡æœŸæè¿°
     */
    public long expires;
    /**
     * XA äº‹åŠ¡çŠ¶æ€
     */
    public int txState;
    /**
     * å‚ä¸è€…åå­—
     */
    public String resourceName;
}
```

**MyCAT è®°å½•åè°ƒæ—¥å¿—ä»¥ JSONæ ¼å¼ åˆ°æ–‡ä»¶**ã€‚**æ¯è¡Œ**åŒ…å«ä¸€æ¡`CoordinatorLogEntry`ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

``` JSON
{"id":"'e827b3fe666c4d968961350d19adda31'","participants":[{"uri":"127.0.0.1","state":"3","expires":0,"resourceName":"db3"},{"uri":"127.0.0.1","state":"3","expires":0,"resourceName":"db1"}]}
{"id":"'f00b61fa17cb4ec5b8264a6d82f847d0'","participants":[{"uri":"127.0.0.1","state":"3","expires":0,"resourceName":"db2"},{"uri":"127.0.0.1","state":"3","expires":0,"resourceName":"db1"}]}
```

å®ç°ç±»ä¸ºï¼š

```Java
// XA åè°ƒè€…æ—¥å¿— å­˜å‚¨æ¥å£ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java
public interface Repository {}
// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java
public class FileSystemRepository implements Repository {}
// XA åè°ƒè€…æ—¥å¿— æ–‡ä»¶å­˜å‚¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java
public class InMemoryRepository implements Repository {}
```

ç›®å‰æ—¥å¿—æ–‡ä»¶å†™å…¥çš„æ–¹å¼æ€§èƒ½è¾ƒå·®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åšåˆ†æï¼Œåœ¨ã€4. MyCAT å®ç°ç¼ºé™·ã€‘é‡Œä¸€èµ·è®²ã€‚

### 3.4.3 MultiNodeCoordinator

æ•²æ•²æ•²ï¼Œè¿™é‡Œæ˜¯æœ¬æ–‡çš„é‡ç‚¹ä¹‹ä¸€å™¢ã€‚ğŸ˜ˆ

**ç¬¬ä¸€é˜¶æ®µï¼šå‘èµ· PREPAREã€‚**

```Java
public void executeBatchNodeCmd(SQLCtrlCommand cmdHandler) {
   this.cmdHandler = cmdHandler;
   final int initCount = session.getTargetCount();
   runningCount.set(initCount);
   nodeCount = initCount;
   failed.set(false);
   faileCount.set(0);
   //recovery nodes log
   ParticipantLogEntry[] participantLogEntry = new ParticipantLogEntry[initCount];
   // æ‰§è¡Œ
   int started = 0;
   for (RouteResultsetNode rrn : session.getTargetKeys()) {
       if (rrn == null) {
           continue;
       }
       final BackendConnection conn = session.getTarget(rrn);
       if (conn != null) {
           conn.setResponseHandler(this);
           //process the XA_END XA_PREPARE Command
           MySQLConnection mysqlCon = (MySQLConnection) conn;
           String xaTxId = null;
           if (session.getXaTXID() != null) {
               xaTxId = session.getXaTXID() + ",'" + mysqlCon.getSchema() + "'";
           }
           if (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) { // XA äº‹åŠ¡
               //recovery Log
               participantLogEntry[started] = new ParticipantLogEntry(xaTxId, conn.getHost(), 0, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());
               String[] cmds = new String[]{"XA END " + xaTxId, // XA END å‘½ä»¤
                       "XA PREPARE " + xaTxId}; // XA PREPARE å‘½ä»¤
               mysqlCon.execBatchCmd(cmds);
           } else { // é XA äº‹åŠ¡
               // recovery Log
               participantLogEntry[started] = new ParticipantLogEntry(xaTxId, conn.getHost(), 0, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());
               cmdHandler.sendCommand(session, conn);
           }
           ++started;
       }
   }
   // xa recovery log
   if (session.getXaTXID() != null) {
       CoordinatorLogEntry coordinatorLogEntry = new CoordinatorLogEntry(session.getXaTXID(), false, participantLogEntry);
       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);
       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());
   }
   if (started < nodeCount) { // TODO ç–‘é—®ï¼šå¦‚ä½•è§¦å‘
       runningCount.set(started);
       LOGGER.warn("some connection failed to execute " + (nodeCount - started));
       /**
        * assumption: only caused by front-end connection close. <br/>
        * Otherwise, packet must be returned to front-end
        */
       failed.set(true);
   }
}
```

* å‘å„æ•°æ®èŠ‚ç‚¹å‘é€ `XA END` + `XA PREPARE` æŒ‡ä»¤ã€‚ä¸¾ä¸ª å˜é‡`cmds` ä¾‹å­ï¼š

``` SQL
XA END '4cbb18214d0b47adbdb0658598666677','db3';XA PREPARE '4cbb18214d0b47adbdb0658598666677','db3';
```

* è®°å½•åè°ƒæ—¥å¿—ã€‚æ¯æ¡å‚ä¸è€…æ—¥å¿—çŠ¶æ€ä¸º `TxState.TX_STARTED_STATE`ã€‚

-------

**ç¬¬äºŒé˜¶æ®µï¼šå‘èµ· COMMITã€‚**

```Java
@Override
public void okResponse(byte[] ok, BackendConnection conn) {
   // process the XA Transatcion 2pc commit
   if (conn instanceof MySQLConnection) {
       MySQLConnection mysqlCon = (MySQLConnection) conn;
       switch (mysqlCon.getXaStatus()) {
           case TxState.TX_STARTED_STATE:
               //if there have many SQL execute wait the okResponse,will come to here one by one
               //should be wait all nodes ready ,then send xa commit to all nodes.
               if (mysqlCon.batchCmdFinished()) {
                   String xaTxId = session.getXaTXID();
                   String cmd = "XA COMMIT " + xaTxId + ",'" + mysqlCon.getSchema() + "'";
                   if (LOGGER.isDebugEnabled()) {
                       LOGGER.debug("Start execute the cmd :" + cmd + ",current host:" + mysqlCon.getHost() + ":" + mysqlCon.getPort());
                   }
                   // recovery log
                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);
                   for (int i = 0; i < coordinatorLogEntry.participants.length; i++) {
                       LOGGER.debug("[In Memory CoordinatorLogEntry]" + coordinatorLogEntry.participants[i]);
                       if (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) {
                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;
                       }
                   }
                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);
                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());
                   // send commit
                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);
                   mysqlCon.execCmd(cmd);
               }
               return;
           case TxState.TX_PREPARED_STATE: {
               // recovery log
               String xaTxId = session.getXaTXID();
               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);
               for (int i = 0; i < coordinatorLogEntry.participants.length; i++) {
                   if (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) {
                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;
                   }
               }
               inMemoryRepository.put(xaTxId, coordinatorLogEntry);
               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());
               // XA reset status now
               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);
               break;
           }
           default:
       }
   }
   // é‡Šæ”¾è¿æ¥
   if (this.cmdHandler.relaseConOnOK()) {
       session.releaseConnection(conn);
   } else {
       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), false);
   }
   // æ˜¯å¦æ‰€æœ‰èŠ‚ç‚¹éƒ½å®Œæˆcommitï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›Client æˆåŠŸ
   if (this.finished()) {
       cmdHandler.okResponse(session, ok);
       if (cmdHandler.isAutoClearSessionCons()) {
           session.clearResources(false);
       }
       /* 1.  äº‹åŠ¡æäº¤å,xa äº‹åŠ¡ç»“æŸ   */
       if (session.getXaTXID() != null) {
           session.setXATXEnabled(false);
       }
       /* 2. preAcStates ä¸ºtrue,äº‹åŠ¡ç»“æŸå,éœ€è¦è®¾ç½®ä¸ºtrueã€‚preAcStates ä¸ºacä¸Šä¸€ä¸ªçŠ¶æ€    */
       if (session.getSource().isPreAcStates()) {
           session.getSource().setAutocommit(true);
       }
   }
}
```

* `mysqlCon.batchCmdFinished()` æ¯ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œç¬¬ä¸€æ¬¡è¿”å›çš„æ˜¯ `XA END` æˆåŠŸï¼Œç¬¬äºŒæ¬¡è¿”å›çš„æ˜¯ `XA PREPARE`ã€‚åœ¨ `XA PREPARE` æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„**å‚ä¸è€…æ—¥å¿—**çŠ¶æ€ä¸º `TxState.TX_PREPARED_STATE`ã€‚ä¹‹åï¼Œå‘è¯¥æ•°æ®èŠ‚ç‚¹å‘èµ· `XA COMMIT` å‘½ä»¤ã€‚
* `XA COMMIT` è¿”å›æˆåŠŸåï¼Œè®°å½•è¯¥æ•°æ®èŠ‚ç‚¹çš„**äº‹åŠ¡å‚ä¸è€…æ—¥å¿—**çŠ¶æ€ä¸º `TxState.TX_COMMITED_STATE`ã€‚
* å½“æ‰€æœ‰æ•°æ®èŠ‚ç‚¹ï¼ˆå‚ä¸è€…ï¼‰éƒ½æ‰§è¡Œå®Œæˆ `XA COMMIT` è¿”å›ï¼Œå³ `this.finished() == true`ï¼Œè¿”å› MySQL Client XA äº‹åŠ¡æäº¤æˆåŠŸã€‚

[x] `XA PREPARE` å’Œ `XA COMMIT`ï¼Œæ•°æ®èŠ‚ç‚¹å¯èƒ½è¿”å›å¤±è´¥ï¼Œç›®å‰æš‚æ—¶æ²¡æ¨¡æ‹Ÿå‡ºæ¥ï¼Œå¯¹åº”æ–¹æ³•ä¸º `#errorResponse(....)`ã€‚ 

## 3.5 MyCAT å¯åŠ¨å›æ»š XAäº‹åŠ¡

MyCAT å¯åŠ¨æ—¶ï¼Œä¼š**å›æ»šå¤„äºTxState.TX_PREPARED_STATE**çš„ `ParticipantLogEntry` å¯¹åº”çš„æ•°æ®èŠ‚ç‚¹çš„ XA äº‹åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```Java
// MycatServer.java
private void performXARecoveryLog() {
   // fetch the recovery log
   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();
   for (int i = 0; i < coordinatorLogEntries.length; i++) {
       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];
       boolean needRollback = false;
       for (int j = 0; j < coordinatorLogEntry.participants.length; j++) {
           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];
           if (participantLogEntry.txState == TxState.TX_PREPARED_STATE) {
               needRollback = true;
               break;
           }
       }
       if (needRollback) {
           for (int j = 0; j < coordinatorLogEntry.participants.length; j++) {
               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];
               //XA rollback
               String xacmd = "XA ROLLBACK " + coordinatorLogEntry.id + ';';
               OneRawSQLQueryResultHandler resultHandler = new OneRawSQLQueryResultHandler(new String[0], new XARollbackCallback());
               outloop:
               for (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) {
                   for (TableConfig table : schema.getTables().values()) {
                       for (String dataNode : table.getDataNodes()) {
                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);
                           if (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)
                                   && dn.getDatabase().equals(participantLogEntry.resourceName)) {
                               //XA STATE ROLLBACK
                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;
                               SQLJob sqlJob = new SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());
                               sqlJob.run();
                               break outloop;
                           }
                       }
                   }
               }
           }
       }
   }
   // init into in memory cached
   for (int i = 0; i < coordinatorLogEntries.length; i++) {
  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);
   }
   // discard the recovery log
    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());
}
```

# 4. MyCAT å®ç°ç¼ºé™·

MyCAT 1.6.5 ç‰ˆæœ¬å®ç°å¼±XAäº‹åŠ¡ï¼Œç›¸å¯¹æ¥è¯´ï¼Œç¬”è€…è®¤ä¸ºè·ç¦»å®é™…ç”Ÿäº§ä½¿ç”¨å­˜åœ¨ä¸€äº›å·®è·ã€‚ä¸‹é¢ç½—åˆ—å¯èƒ½å­˜åœ¨çš„ç¼ºé™·ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œéº»çƒ¦æŒ‡å‡ºã€‚ğŸ™‚å¸Œæœ› MyCAT åœ¨åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸Šï¼Œèƒ½å¤Ÿè¶Šæ¥è¶Šç»™åŠ›ã€‚

## 4.1 åè°ƒæ—¥å¿—å†™å…¥æ€§èƒ½

1ã€`CoordinatorLogEntry`ã€`ParticipantLogEntry` åœ¨æ¯æ¬¡å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ˜¯å°†å†…å­˜ä¸­æ‰€æœ‰çš„æ—¥å¿—**å…¨éƒ¨é‡æ–°**å†™å…¥ï¼Œå¯¼è‡´å†™å…¥æ€§èƒ½éšç€ XA äº‹åŠ¡æ¬¡æ•°çš„å¢åŠ ï¼Œæ€§èƒ½ä¼šè¶Šæ¥è¶Šç³Ÿç³•ï¼Œå¯¼è‡´ XA äº‹åŠ¡æ•´ä½“æ€§èƒ½ä¼šéå¸¸å·®ã€‚å¦å¤–ï¼Œè¯¥æ–¹æ³•æ˜¯**åŒæ­¥**çš„ï¼Œä¹ŸåŠ å¤§äº†å†™å…¥çš„å»¶è¿Ÿã€‚

å»ºè®®ï¼šå…ˆè·å¾—å¯å†™å…¥æ–‡ä»¶çš„ OFFSETï¼Œå†™å…¥åè°ƒæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œå†…å­˜ç»´æŠ¤å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ï¼Œä»è€Œå®ç°**é¡ºåºå†™å…¥** + **å¹¶è¡Œå†™å…¥**ã€‚

2ã€å†…å­˜é‡Œç»´æŠ¤äº†æ‰€æœ‰çš„åè°ƒæ—¥å¿—ï¼Œå ç”¨å†…å­˜ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå¹¶ä¸”æ— é‡Šæ”¾æœºåˆ¶ã€‚å³ä½¿é‡å¯ï¼Œåè°ƒæ—¥å¿—ä¹Ÿä¼šé‡æ–°åŠ è½½åˆ°å†…å­˜ã€‚

å»ºè®®ï¼šå·²å®Œå…¨å›æ»šæˆ–è€…æäº¤çš„åè°ƒæ—¥å¿—ä¸æ”¾å…¥å†…å­˜ã€‚å¦å¤–æœ‰æ–‡ä»¶å­˜å‚¨å¥½ XAäº‹åŠ¡ç¼–å· ä¸ OFFSET çš„æ˜ å°„å…³ç³»ã€‚

3ã€åè°ƒæ—¥å¿—åªå†™å…¥å•ä¸ªæ–‡ä»¶ã€‚

å»ºè®®ï¼šåˆ†æ‹†åè°ƒæ—¥å¿—æ–‡ä»¶ã€‚

PSï¼šæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹ `RocketMQ` å¯¹ `CommitLog` çš„å­˜å‚¨ï¼Œæ€§èƒ½ä¸Šå¾ˆèµï¼

## 4.2 æ•°æ®èŠ‚ç‚¹æœªå…¨éƒ¨ PREPARE å°±è¿›è¡Œ COMMIT

XA äº‹åŠ¡å®šä¹‰ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰å‚ä¸è€…**å…¨éƒ¨** `XA PREPARE` æˆåŠŸå®Œæˆåå‘èµ· `XA COMMIT`ã€‚ç›®å‰ MyCAT æ˜¯æŸä¸ªæ•°æ®èŠ‚ç‚¹ `XA PREPARE` å®Œæˆå**ç«‹å³**è¿›è¡Œ `XA COMMIT`ã€‚æ¯”å¦‚è¯´ï¼šç¬¬ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹æäº¤äº† `XA END;XA PREPARE` æ—¶ï¼Œç¬¬äºŒä¸ªæ•°æ®èŠ‚åœ¨è¿›è¡Œ `XA END;XA PREAPRE;` å‰æŒ‚äº†ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¾ç„¶ä¼š `XA COMMIT` æˆåŠŸã€‚

å»ºè®®ï¼šæŒ‰ç…§ä¸¥æ ¼çš„ XA äº‹åŠ¡å®šä¹‰ã€‚

## 4.3 MyCAT å¯åŠ¨å›æ»š PREPARE çš„ XAäº‹åŠ¡

1ã€MyCAT å¯åŠ¨æ—¶ï¼Œå›æ»šæ‰€æœ‰çš„ `PREPARE` çš„ XA äº‹åŠ¡ï¼Œå¯èƒ½æŸä¸ª XA äº‹åŠ¡ï¼Œéƒ¨åˆ† `COMMIT`ï¼Œéƒ¨åˆ† `PREPARE`ã€‚æ­¤æ—¶ç›´æ¥å›æ»šï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

å»ºè®®ï¼šå½“åˆ¤æ–­åˆ°æŸä¸ª XA äº‹åŠ¡å­˜åœ¨ `PREPARE` çš„å‚ä¸è€…ï¼Œ**åŒæ—¶åˆ¤æ–­è¯¥ XA äº‹åŠ¡é‡Œå…¶ä»–å‚ä¸è€…çš„äº‹åŠ¡çŠ¶æ€**ä»¥åŠ**æ•°æ®èŠ‚ç‚¹é‡Œ XA äº‹åŠ¡çŠ¶æ€**ï¼Œæ¯”å¦‚å‚ä¸è€…ä¸º `MySQL`æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `XA RECOVER` æŸ¥è¯¢å¤„äº `PREPARE` æ‰€æœ‰çš„ XA äº‹åŠ¡ã€‚

2ã€å›æ»š `PREPARE` æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œåœ¨æœªè¿›è¡Œå®Œæˆæ—¶å·²ç»è®¾ç½®æ–‡ä»¶é‡Œå›æ»šæˆåŠŸã€‚å¦‚æœå¼‚æ­¥è¿‡ç¨‹ä¸­å¤±è´¥ï¼Œä¼šå¯¼è‡´ XA äº‹åŠ¡çŠ¶æ€ä¸ä¸€è‡´ã€‚

å»ºè®®ï¼šå›è°ƒæˆåŠŸåï¼Œæ›´æ–°è¯¥ XA äº‹åŠ¡çŠ¶æ€ã€‚

## 4.4 å•èŠ‚ç‚¹äº‹åŠ¡æœªè®°å½•åè°ƒæ—¥å¿—

è¯¥æƒ…å†µè¾ƒä¸ºæç«¯ã€‚å‘èµ· `XA PREPARE`å®Œåï¼ŒMyCAT æŒ‚äº†ã€‚é‡å¯åï¼Œè¯¥ XA äº‹åŠ¡åœ¨ MyCAT é‡Œå°±â€œæ¶ˆå¤±â€œäº†ï¼Œå‚ä¸è€…çš„è¯¥ XA äº‹åŠ¡ä¸€ç›´å¤„äº `PREPARE` çŠ¶æ€ã€‚ä»ç†è®ºä¸Šæ¥è¯´ï¼Œéœ€è¦å›æ»šè¯¥ XA äº‹åŠ¡ã€‚

å»ºè®®ï¼šè®°å½•åè°ƒæ—¥å¿—ã€‚

## 4.5 XA COMMIT éƒ¨åˆ†èŠ‚ç‚¹æŒ‚äº†é‡æ–°æ¢å¤åï¼Œæœªè¿›ä¸€æ­¥å¤„ç†

å½“ä¸€éƒ¨åˆ†èŠ‚ç‚¹ `XA COMMIT` å®Œæˆï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ­¤æ—¶æŒ‚äº†ã€‚åœ¨ç®¡ç†å‘˜é‡å¯æŒ‚æ‰çš„èŠ‚ç‚¹ï¼Œå…¶å¯¹åº”çš„ XA äº‹åŠ¡æœªè¿›ä¸€æ­¥å¤„ç†ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

å»ºè®®ï¼šğŸ˜ˆæœ¨æœ‰å»ºè®®ã€‚ä¹Ÿå¾ˆå¥½å¥‡ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„æƒ…å†µï¼Œå¦‚ä½•å¤„ç†è¾ƒä¸ºåˆé€‚ã€‚å¦‚æœ‰å¤§å¤§çŸ¥é“ï¼Œçƒ¦è¯·å‘ŠçŸ¥ä¸‹ã€‚

# 5. å½©è›‹

ä¾‹è¡Œâ€œå½©è›‹â€ï¼Ÿ

* [ã€ŠMycatæºç ç¯‡ : MyCatäº‹åŠ¡ç®¡ç†æœºåˆ¶åˆ†æã€‹](http://blog.csdn.net/d6619309/article/details/52330334) æ¥è‡ª MyCAT Committer çš„æ–‡ç« 
* [ã€ŠMySQL Â· æ‰è™«åŠ¨æ€ Â· è¿æ¥æ–­å¼€å¯¼è‡´XAäº‹åŠ¡ä¸¢å¤±ã€‹](http://mysql.taobao.org/monthly/2015/04/05/)
* [ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿäº‹åŠ¡ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆã€‹](http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency)
* [ã€ŠMySQLæ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡XAä¼˜ç¼ºç‚¹ä¸æ”¹è¿›æ–¹æ¡ˆã€‹](http://blog.csdn.net/fly2749/article/details/44998203)
* [ã€Šæ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„2PCå’Œ3PCã€‹](http://www.hollischuang.com/archives/1580)
* [ã€åˆ†å¸ƒå¼äº‹åŠ¡.xmindã€‘](https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind) ç¬”è€…æ‹™ä½œ 
* [ã€ŠRocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹](http://www.iocoder.cn/RocketMQ/message-transaction/?self) ç¬”è€…æ‹™ä½œ

