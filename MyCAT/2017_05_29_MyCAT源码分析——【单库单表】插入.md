title: MyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥
date: 2017-05-29
tags:
categories: MyCAT
permalink: MyCAT/single-db-single-table-insert

---

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

- [1. æ¦‚è¿°](#)
- [2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL](#)
- [3. è·å¾—è·¯ç”±ç»“æœ](#)
- [4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL](#)
- [5. å“åº”æ‰§è¡Œ SQL ç»“æœ](#)

# 1. æ¦‚è¿°

> å†…å®¹å½¢æ€ä»¥ é¡ºåºå›¾ + æ ¸å¿ƒä»£ç  ä¸ºä¸»ã€‚  
> å¦‚æœæœ‰åœ°æ–¹è¡¨è¿°ä¸é”™è¯¯æˆ–è€…ä¸æ¸…æ™°ï¼Œæ¬¢è¿ç•™è¨€ã€‚  
> å¯¹äºå†…å®¹å½¢æ€ï¼Œéå¸¸çº ç»“ï¼Œå¦‚æœæœ‰å»ºè®®ï¼Œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«æ¬¢è¿æ‚¨æå‡ºã€‚  
> å¾®ä¿¡å·ï¼šwangwenbin-serverã€‚

æœ¬æ–‡è®²è§£ ã€å•åº“å•è¡¨ã€‘æ’å…¥ æ‰€æ¶‰åŠåˆ°çš„ä»£ç ã€‚äº¤äº’å¦‚ä¸‹å›¾ï¼š

![å•åº“å•è¡¨æ’å…¥ç®€å›¾](http://www.iocoder.cn/images/MyCAT/2017_05_29/05.png)

æ•´ä¸ªè¿‡ç¨‹ï¼ŒMyCAT Server æµç¨‹å¦‚ä¸‹ï¼š

1. æ¥æ”¶ MySQL Client è¯·æ±‚ï¼Œè§£æ SQLã€‚
2. è·å¾—è·¯ç”±ç»“æœï¼Œè¿›è¡Œè·¯ç”±ã€‚
3. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQLã€‚
4. å“åº”æ‰§è¡Œç»“æœï¼Œå‘é€ç»“æœç»™ MySQL Clientã€‚

æˆ‘ä»¬é€ä¸ªæ­¥éª¤åˆ†æï¼Œä¸€èµ·æ¥çœ‹çœ‹æºç ã€‚

# 2. æ¥æ”¶è¯·æ±‚ï¼Œè§£æ SQL

![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ01ä¸»æµç¨‹ï¼‰](http://www.iocoder.cn/images/MyCAT/2017_05_29/01.png)

## ã€ 1 - 2 ã€‘

æ¥æ”¶**ä¸€æ¡** MySQL å‘½ä»¤ã€‚åœ¨ã€1ã€‘ä¹‹å‰ï¼Œè¿˜æœ‰è¯·æ±‚æ•°æ®è¯»å–ã€æ‹†æˆå•æ¡ MySQL SQLã€‚

## ã€ 3 ã€‘

ä¸åŒ MySQL å‘½ä»¤ï¼Œåˆ†å‘åˆ°ä¸åŒçš„æ–¹æ³•æ‰§è¡Œã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendCommandHandler.javaã€‘
  2: public class FrontendCommandHandler implements NIOHandler {
  3: 
  4:     @Override
  5:     public void handle(byte[] data) {
  6:     
  7:         // .... çœç•¥éƒ¨åˆ†ä»£ç 
  8:         switch (data[4]) // 
  9:         {
 10:             case MySQLPacket.COM_INIT_DB:
 11:                 commands.doInitDB();
 12:                 source.initDB(data);
 13:                 break;
 14:             case MySQLPacket.COM_QUERY: // æŸ¥è¯¢å‘½ä»¤
 15:                 // è®¡æ•°æŸ¥è¯¢å‘½ä»¤
 16:                 commands.doQuery();
 17:                 // æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤
 18:                 source.query(data);
 19:                 break;
 20:             case MySQLPacket.COM_PING:
 21:                 commands.doPing();
 22:                 source.ping();
 23:                 break;
 24:             // .... çœç•¥éƒ¨åˆ†case
 25:         }
 26:     }
 27: 
 28: }
```

`INSERT`/`SELECT`/`UPDATE`/`DELETE` ç­‰ SQL å½’å±äº `MySQLPacket.COM_QUERY`ï¼Œè¯¦ç»†å¯è§ï¼š[ã€ŠMySQLåè®®åˆ†æ#4.2 å®¢æˆ·ç«¯å‘½ä»¤è¯·æ±‚æŠ¥æ–‡ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡å™¨ï¼‰ã€‹](http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/#42-)ã€‚

##ã€ 4 ã€‘

å°† äºŒè¿›åˆ¶æ•°ç»„ è§£ææˆ SQLã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€FrontendConnection.javaã€‘
  2: public void query(byte[] data) {
  3: 	// å–å¾—è¯­å¥
  4: 	String sql = null;		
  5: 	try {
  6: 		MySQLMessage mm = new MySQLMessage(data);
  7: 		mm.position(5);
  8: 		sql = mm.readString(charset);
  9: 	} catch (UnsupportedEncodingException e) {
 10: 		writeErrMessage(ErrorCode.ER_UNKNOWN_CHARACTER_SET, "Unknown charset '" + charset + "'");
 11: 		return;
 12: 	}		
 13: 	// æ‰§è¡Œè¯­å¥
 14: 	this.query( sql );
 15: }
```

##ã€ 5 ã€‘

è§£æ SQL ç±»å‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerQueryHandler.javaã€‘
  2: @Override
  3: public void query(String sql) {
  4: 	// è§£æ SQL ç±»å‹
  5: 	int rs = ServerParse.parse(sql);
  6: 	int sqlType = rs & 0xff;
  7: 	
  8: 	switch (sqlType) {
  9: 	//explain sql
 10: 	case ServerParse.EXPLAIN:
 11: 		ExplainHandler.handle(sql, c, rs >>> 8);
 12: 		break;
 13: 	// .... çœç•¥éƒ¨åˆ†case
 14: 		break;
 15: 	case ServerParse.SELECT:
 16: 		SelectHandler.handle(sql, c, rs >>> 8);
 17: 		break;
 18: 	// .... çœç•¥éƒ¨åˆ†case
 19: 	default:
 20: 		if(readOnly){
 21: 			LOGGER.warn(new StringBuilder().append("User readonly:").append(sql).toString());
 22: 			c.writeErrMessage(ErrorCode.ER_USER_READ_ONLY, "User readonly");
 23: 			break;
 24: 		}
 25: 		c.execute(sql, rs & 0xff);
 26: 	}
 27: }
 28: 
 29:
 30: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerParse.javaã€‘
 31: public static int parse(String stmt) {
 32: 	int length = stmt.length();
 33: 	//FIX BUG FOR SQL SUCH AS /XXXX/SQL
 34: 	int rt = -1;
 35: 	for (int i = 0; i < length; ++i) {
 36: 		switch (stmt.charAt(i)) {
 37: 		// .... çœç•¥éƒ¨åˆ†case			case 'I':
 38: 		case 'i':
 39: 			rt = insertCheck(stmt, i);
 40: 			if (rt != OTHER) {
 41: 				return rt;
 42: 			}
 43: 			continue;
 44: 			// .... çœç•¥éƒ¨åˆ†case
 45: 		case 'S':
 46: 		case 's':
 47: 			rt = sCheck(stmt, i);
 48: 			if (rt != OTHER) {
 49: 				return rt;
 50: 			}
 51: 			continue;
 52: 			// .... çœç•¥éƒ¨åˆ†case
 53: 		default:
 54: 			continue;
 55: 		}
 56: 	}
 57: 	return OTHER;
 58: }
```

##ã€ 6 ã€‘

æ‰§è¡Œ SQLï¼Œè¯¦ç»†è§£æè§ä¸‹æ–‡ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ServerConnection.javaã€‘
  2: public class ServerConnection extends FrontendConnection {
  3: 	public void execute(String sql, int type) {
  4: 		// .... çœç•¥ä»£ç 
  5: 		SchemaConfig schema = MycatServer.getInstance().getConfig().getSchemas().get(db);
  6: 		if (schema == null) {
  7: 			writeErrMessage(ErrorCode.ERR_BAD_LOGICDB,
  8: 					"Unknown MyCAT Database '" + db + "'");
  9: 			return;
 10: 		}
 11: 
 12: 		// .... çœç•¥ä»£ç 
 13: 
 14: 		// è·¯ç”±åˆ°åç«¯æ•°æ®åº“ï¼Œæ‰§è¡Œ SQL
 15: 		routeEndExecuteSQL(sql, type, schema);
 16: 	}
 17: 	
 18:     public void routeEndExecuteSQL(String sql, final int type, final SchemaConfig schema) {
 19: 		// è·¯ç”±è®¡ç®—
 20: 		RouteResultset rrs = null;
 21: 		try {
 22: 			rrs = MycatServer
 23: 					.getInstance()
 24: 					.getRouterservice()
 25: 					.route(MycatServer.getInstance().getConfig().getSystem(),
 26: 							schema, type, sql, this.charset, this);
 27: 
 28: 		} catch (Exception e) {
 29: 			StringBuilder s = new StringBuilder();
 30: 			LOGGER.warn(s.append(this).append(sql).toString() + " err:" + e.toString(),e);
 31: 			String msg = e.getMessage();
 32: 			writeErrMessage(ErrorCode.ER_PARSE_ERROR, msg == null ? e.getClass().getSimpleName() : msg);
 33: 			return;
 34: 		}
 35: 
 36: 		// æ‰§è¡Œ SQL
 37: 		if (rrs != null) {
 38: 			// sessionæ‰§è¡Œ
 39: 			session.execute(rrs, rrs.isSelectForUpdate() ? ServerParse.UPDATE : type);
 40: 		}
 41: 		
 42:  	}
 43: 
 44: }
```

# 3. è·å¾—è·¯ç”±ç»“æœ

![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ02è·å–è·¯ç”±ï¼‰](http://www.iocoder.cn/images/MyCAT/2017_05_29/02.png)

## ã€ 1 - 2 ã€‘ã€ 12 ã€‘

è·å¾—è·¯ç”±ä¸»æµç¨‹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouteService.javaã€‘
  2: public RouteResultset route(SystemConfig sysconf, SchemaConfig schema,
  3: 		int sqlType, String stmt, String charset, ServerConnection sc)
  4: 		throws SQLNonTransientException {
  5: 	RouteResultset rrs = null;
  6: 	// .... çœç•¥ä»£ç 
  7: 	int hintLength = RouteService.isHintSql(stmt);
  8: 	if(hintLength != -1){ // TODO å¾…è¯»ï¼šhint
  9: 		// .... çœç•¥ä»£ç 
 10: 		}
 11: 	} else {
 12: 		stmt = stmt.trim();
 13: 		rrs = RouteStrategyFactory.getRouteStrategy().route(sysconf, schema, sqlType, stmt,
 14: 				charset, sc, tableId2DataNodeCache);
 15: 	}
 16: 
 17: 	// .... çœç•¥ä»£ç 		return rrs;
 18: }
 19: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘
 20: @Override
 21: public RouteResultset route(SystemConfig sysConfig, SchemaConfig schema, int sqlType, String origSQL,
 22: 		String charset, ServerConnection sc, LayerCachePool cachePool) throws SQLNonTransientException {
 23: 
 24: 	// .... çœç•¥ä»£ç 
 25: 
 26: 	// å¤„ç†ä¸€äº›è·¯ç”±ä¹‹å‰çš„é€»è¾‘;å…¨å±€åºåˆ—å·ï¼Œçˆ¶å­è¡¨æ’å…¥
 27: 	if (beforeRouteProcess(schema, sqlType, origSQL, sc) ) {
 28: 		return null;
 29: 	}
 30: 
 31: 	// .... çœç•¥ä»£ç 
 32: 
 33: 	// æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç‰‡
 34: 	if (schema.isNoSharding() && ServerParse.SHOW != sqlType) {
 35: 		rrs = RouterUtil.routeToSingleNode(rrs, schema.getDataNode(), stmt);
 36: 	} else {
 37: 		RouteResultset returnedSet = routeSystemInfo(schema, sqlType, stmt, rrs);
 38: 		if (returnedSet == null) {
 39: 			rrs = routeNormalSqlWithAST(schema, stmt, rrs, charset, cachePool,sqlType,sc);
 40: 		}
 41: 	}
 42: 
 43: 	return rrs;
 44: }
```

_**è·¯ç”±** è¯¦ç»†è§£æï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ã€æ’å…¥ã€‘æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚_

## ã€ 3 - 6 ã€‘

è·¯ç”±**å‰ç½®**å¤„ç†ã€‚å½“ç¬¦åˆå¦‚ä¸‹ä¸‰ç§æƒ…å†µä¸‹ï¼Œè¿›è¡Œå¤„ç†ï¼š  

{ 1 } ä½¿ç”¨**å…¨å±€åºåˆ—å·**ï¼š

```SQL
insert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')
```
 
{ 2 } ER å­è¡¨æ’å…¥  
{ 3 } ä¸»é”®ä½¿ç”¨è‡ªå¢ ID æ’å…¥ï¼š

```SQL
insert into table (name) values ('name')
===>
insert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')
```  

æƒ…å†µ { 1 } { 3 } æƒ…å†µç±»ä¼¼ï¼Œä½¿ç”¨å…¨å±€åºåˆ—å·ã€‚

æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€AbstractRouteStrategy.javaã€‘
  2: private boolean beforeRouteProcess(SchemaConfig schema, int sqlType, String origSQL, ServerConnection sc)
  3: 		throws SQLNonTransientException {
  4: 	return  // å¤„ç† id ä½¿ç”¨ å…¨å±€åºåˆ—å·
  5:             RouterUtil.processWithMycatSeq(schema, sqlType, origSQL, sc)
  6:             // å¤„ç† ER å­è¡¨
  7: 			|| (sqlType == ServerParse.INSERT && RouterUtil.processERChildTable(schema, origSQL, sc))
  8:             // å¤„ç† id è‡ªå¢é•¿
  9: 			|| (sqlType == ServerParse.INSERT && RouterUtil.processInsert(schema, sqlType, origSQL, sc));
 10: }
```

`RouterUtil.java` å¤„ç† SQL è€ƒè™‘æ€§èƒ½ï¼Œå®ç°ä¼šæ¯”è¾ƒ C-styleï¼Œä»£ç å’±å°±ä¸è´´äº†ï¼Œä¼ é€é—¨ï¼šhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/route/util/RouterUtil.javaã€‚ ï¼ˆğŸ˜ˆè¯¥ä»“åº“ä»å®˜æ–¹ Forkï¼Œé€æ­¥å®Œå–„ä¸­æ–‡æ³¨é‡Šï¼Œæ¬¢è¿ Starï¼‰

## ã€ 7 - 11 ã€‘

å½“**å‰ç½®**è·¯ç”±å¤„ç†**å…¨å±€åºåˆ—å·**æ—¶ï¼Œæ·»åŠ åˆ°å…¨å±€åºåˆ—å¤„ç†å™¨ï¼ˆ`MyCATSequnceProcessor`ï¼‰ã€‚è¯¥å¤„ç†å™¨ä¼šå¼‚æ­¥ç”Ÿæˆ IDï¼Œæ›¿æ¢ SQL å†…çš„ `NEXT VALUE FOR MYCATSEQ_` æ­£åˆ™ã€‚ä¾‹å¦‚ï¼š

```SQL
insert into table (id, name) values (NEXT VALUE FOR MYCATSEQ_ID, 'name')
===>
insert into table (id, name) values (868348974560579584, 'name')
```

å¼‚æ­¥å¤„ç†å®Œåï¼Œè°ƒç”¨ `ServerConnection#routeEndExecuteSQL(sql, type, schema)` æ–¹æ³•é‡æ–°æ‰§è¡Œ SQLã€‚

æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```Java
  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RouterUtil.javaã€‘
  2: public static void processSQL(ServerConnection sc,SchemaConfig schema,String sql,int sqlType){
  3: 	SessionSQLPair sessionSQLPair = new SessionSQLPair(sc.getSession2(), schema, sql, sqlType);
  4: 	MycatServer.getInstance().getSequnceProcessor().addNewSql(sessionSQLPair);
  5: }
  6: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€MyCATSequnceProcessor.javaã€‘
  7: public class MyCATSequnceProcessor {
  8: 	private LinkedBlockingQueue<SessionSQLPair> seqSQLQueue = new LinkedBlockingQueue<SessionSQLPair>();
  9: 	private volatile boolean running=true;
 10: 	
 11: 	public void addNewSql(SessionSQLPair pair) {
 12: 		seqSQLQueue.add(pair);
 13: 	}
 14: 
 15: 	private void executeSeq(SessionSQLPair pair) {
 16: 		try {
 17: 			
 18: 			// ä½¿ç”¨Druidè§£æå™¨å®ç°sequenceå¤„ç†  @å…µä¸´åŸä¸‹
 19: 			DruidSequenceHandler sequenceHandler = new DruidSequenceHandler(MycatServer
 20: 					.getInstance().getConfig().getSystem().getSequnceHandlerType());
 21: 
 22: 			// ç”Ÿæˆå¯æ‰§è¡Œ SQL ï¼šç›®å‰ä¸»è¦æ˜¯ç”Ÿæˆ id
 23: 			String charset = pair.session.getSource().getCharset();
 24: 			String executeSql = sequenceHandler.getExecuteSql(pair.sql,charset == null ? "utf-8":charset);
 25: 
 26: 			// æ‰§è¡Œ SQL
 27: 			pair.session.getSource().routeEndExecuteSQL(executeSql, pair.type,pair.schema);
 28: 		} catch (Exception e) {
 29: 			LOGGER.error("MyCATSequenceProcessor.executeSeq(SesionSQLPair)",e);
 30: 			pair.session.getSource().writeErrMessage(ErrorCode.ER_YES,"mycat sequnce err." + e);
 31: 			return;
 32: 		}
 33: 	}
 34: 	
 35: 	class ExecuteThread extends Thread {
 36: 		
 37: 		public ExecuteThread() {
 38: 			setDaemon(true); // è®¾ç½®ä¸ºåå°çº¿ç¨‹,é˜²æ­¢throw RuntimeExecptionè¿›ç¨‹ä»ç„¶å­˜åœ¨çš„é—®é¢˜
 39: 		}
 40: 		
 41: 		public void run() {
 42: 			while (running) {
 43: 				try {
 44: 					SessionSQLPair pair=seqSQLQueue.poll(100,TimeUnit.MILLISECONDS);
 45: 					if(pair!=null){
 46:                         executeSeq(pair);
 47: 					}
 48: 				} catch (Exception e) {
 49: 					LOGGER.warn("MyCATSequenceProcessor$ExecutorThread",e);
 50: 				}
 51: 			}
 52: 		}
 53: 	}
 54: }
```

â“æ­¤å¤„æœ‰ä¸ªç–‘é—®ï¼š`MyCATSequnceProcessor` æ˜¯å•çº¿ç¨‹ï¼Œä¼šä¸ä¼šæ’å…¥æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Ÿåç»­å’±åšä¸‹æ€§èƒ½æµ‹è¯•ã€‚

# 4. è·å¾— MySQL è¿æ¥ï¼Œæ‰§è¡Œ SQL

![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ03æ‰§è¡Œ SQLï¼‰](http://www.iocoder.cn/images/MyCAT/2017_05_29/03.png)

## ã€ 1 - 8 ã€‘

è·å¾— MySQL è¿æ¥ã€‚

* PhysicalDBNode ï¼šç‰©ç†æ•°æ®åº“èŠ‚ç‚¹ã€‚
* PhysicalDatasource ï¼šç‰©ç†æ•°æ®åº“æ•°æ®æºã€‚

## ã€ 9 - 13 ã€‘

å‘é€ SQL åˆ° MySQL Serverï¼Œæ‰§è¡Œ SQLã€‚

# 5. å“åº”æ‰§è¡Œ SQL ç»“æœ

![ã€å•åº“å•è¡¨ã€‘æ’å…¥ï¼ˆ04æ‰§è¡Œå“åº”ï¼‰](http://www.iocoder.cn/images/MyCAT/2017_05_29/04.png)

## ã€ 1 - 4 ã€‘

å¤„ç† MySQL Server å“åº”æ•°æ®åŒ…ã€‚

## ã€ 5 - 8 ã€‘

å‘é€æ’å…¥æˆåŠŸç»“æœç»™ MySQL Clientã€‚


