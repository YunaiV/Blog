title: MyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆä¸€ï¼‰
date: 2017-06-13
tags:
categories: MyCAT
permalink: MyCAT/sharding-result-merge-first

---

![](http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# 1. æ¦‚è¿°

ç›¸ä¿¡å¾ˆå¤šåŒå­¦çœ‹è¿‡ MySQL å„ç§ä¼˜åŒ–çš„æ–‡ç« ï¼Œé‡Œé¢ 99% ä¼šæåˆ°ï¼šå•è¡¨æ•°æ®é‡å¤§äº†ï¼Œéœ€è¦è¿›è¡Œåˆ†ç‰‡ï¼ˆæ°´å¹³æ‹†åˆ† or å‚ç›´æ‹†åˆ†ï¼‰ã€‚åˆ†ç‰‡ä¹‹åï¼Œä¸šåŠ¡ä¸Šå¿…ç„¶é¢ä¸´çš„åœºæ™¯ï¼šè·¨åˆ†ç‰‡çš„æ•°æ®åˆå¹¶ã€‚ä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥ç…ç… MyCAT æ˜¯å¦‚ä½•å®ç°**åˆ†ç‰‡ç»“æœåˆå¹¶**ã€‚

è·¨åˆ†ç‰‡æŸ¥è¯¢å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š

![flow](http://www.yunai.me/images/MyCAT/2017_06_13/flow.png)

å’Œ [ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹](http://www.yunai.me/Mycat/single-db-single-table-select/) ä¸åŒçš„ä¸¤ä¸ªè¿‡ç¨‹ï¼š

* ã€2ã€‘å¤šåˆ†ç‰‡æ‰§è¡Œ SQL
* ã€4ã€‘åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥é€æ¡è®²è§£è¿™ä¸¤ä¸ªè¿‡ç¨‹ã€‚

# 2. å¤šåˆ†ç‰‡æ‰§è¡Œ SQL

![execute_sql](http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png)

ç»è¿‡ SQL è§£æåï¼Œè®¡ç®—å‡ºéœ€è¦æ‰§è¡Œ SQL çš„**åˆ†ç‰‡èŠ‚ç‚¹**ï¼Œéå†**åˆ†ç‰‡èŠ‚ç‚¹**å‘é€ SQL è¿›è¡Œæ‰§è¡Œã€‚

**æ ¸å¿ƒä»£ç **ï¼š

* [MultiNodeQueryHandler.java#execute(...)](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java)

_**SQL è§£æ** è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ï¼Œé¿å…å†…å®¹è¿‡å¤šï¼Œå½±å“å¤§å®¶å¯¹ **åˆ†ç‰‡ç»“æœåˆå¹¶** æµç¨‹å’Œé€»è¾‘çš„ç†è§£ã€‚_

# 3. åˆå¹¶å¤šåˆ†ç‰‡ç»“æœ

![handle_response](http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png)

å’Œ [ã€Šã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹](http://www.yunai.me/Mycat/single-db-single-table-select/) ä¸åŒï¼Œå¤šä¸ª**åˆ†ç‰‡èŠ‚ç‚¹**éƒ½ä¼š**åˆ†åˆ«**å“åº” _è®°å½•å¤´(header)_ å’Œ _è®°å½•è¡Œ(row)_ ã€‚åœ¨å¼€å§‹åˆ†æ MyCAT æ˜¯æ€ä¹ˆåˆå¹¶å¤šåˆ†ç‰‡ç»“æœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›æƒ³ä¸‹ SQL çš„æ‰§è¡Œé¡ºåºã€‚

```SQL
FROM       // [1] é€‰æ‹©è¡¨
WHERE      // [2] è¿‡æ»¤è¡¨
GROUP BY   // [3] åˆ†ç»„
SELECT     // [4] æ™®é€šå­—æ®µï¼Œmax / min / avg / sum / count ç­‰å‡½æ•°ï¼Œdistinct
HAVING     // [5] å†è¿‡æ»¤è¡¨
ORDER BY   // [6] æ’åº
LIMIT      // [7] åˆ†é¡µ
```

## 3.1 è®°å½•å¤´(header)

å¤šä¸ª**åˆ†ç‰‡èŠ‚ç‚¹**å“åº”æ—¶ï¼Œä¼šå“åº”å¤šæ¬¡ _è®°å½•å¤´(header)_ ã€‚MyCAT åœ¨å®é™…å¤„ç†æ—¶ï¼Œåªå¤„ç†ç¬¬ä¸€ä¸ªè¿”å›çš„ _è®°å½•å¤´(header)_ ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨æ—¶è¦ä¿è¯è¡¨çš„ Schema ç›¸åŒã€‚

**åˆ†ç‰‡èŠ‚ç‚¹**å“åº”çš„ _è®°å½•å¤´(header)_ å¯ä»¥ç›´æ¥è¿”å› MySQL Client å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ã€‚`AVG`å‡½æ•° æ˜¯ç‰¹æ®Šæƒ…å†µï¼ŒMyCAT éœ€è¦å°† `AVG` æ‹†æˆ `SUM` + `COUNT` è¿›è¡Œè®¡ç®—ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```SQL
// [1] MySQL Client => MyCAT ï¼š
SELECT AVG(age) FROM student;

// [2] MyCAT => MySQL Server ï¼š
SELECT SUM(age) AS AVG0SUM, COUNT(age) AS AVG0COUNT FROM student;

// [3] æœ€ç»ˆï¼šAVG(age) = SUM(age) AS AVG0SUM / COUNT(age)
```

**æ ¸å¿ƒä»£ç **ï¼š

* [MultiNodeQueryHandler.java#fieldEofResponse(...)](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java)ã€‚

## 3.2 è®°å½•è¡Œ(row)

### 3.1 AbstractDataNodeMerge

MyCAT å¯¹åˆ†ç‰‡ç»“æœåˆå¹¶é€šè¿‡ `AbstractDataNodeMerge` å­ç±»æ¥å®Œæˆã€‚

![merge_service](http://www.yunai.me/images/MyCAT/2017_06_13/merge_service.png) 

`AbstractDataNodeMerge` ï¼š

* -packs ï¼šå¾…åˆå¹¶è®°å½•è¡Œ(row)é˜Ÿåˆ—ã€‚é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ `END_FLAG_PACK` è¡¨ç¤ºé˜Ÿåˆ—å·²ç»“æŸã€‚
* -running ï¼šåˆå¹¶é€»è¾‘æ˜¯å¦æ­£åœ¨æ‰§è¡Œä¸­çš„æ ‡è®°ã€‚
* ~onRowMetaData(...) ï¼šæ ¹æ®**è®°å½•åˆ—ä¿¡æ¯(ColMeta)**æ„å»ºå¯¹åº”çš„æ’åºç»„ä»¶å’Œèšåˆç»„ä»¶ã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚
* ~onNewRecord(...) ï¼šæ’å…¥è®°å½•è¡Œ(row) åˆ° `packs`ã€‚
* ~outputMergeResult(...) ï¼šæ’å…¥ `END_FLAG_PACK` åˆ° `packs`ã€‚
* ~run(...) ï¼šæ‰§è¡Œ**åˆå¹¶**åˆ†ç‰‡ç»“æœé€»è¾‘ï¼Œå¹¶å°†åˆå¹¶ç»“æœè¿”å›ç»™ MySQL Clientã€‚éœ€è¦å­ç±»è¿›è¡Œå®ç°ã€‚

![AbstractDataNodeMerge_run.png](http://www.yunai.me/images/MyCAT/2017_06_13/AbstractDataNodeMerge_run.png)

**é€šè¿‡ `running` æ ‡è®°ä¿è¯åŒä¸€æ¡ SQL åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰åˆ°æ¯ä¸ªåˆ†ç‰‡ç»“æœéƒ½è¿”å›å°±å¯ä»¥æ‰§è¡Œ*èšåˆ*é€»è¾‘ã€‚å½“ç„¶ï¼Œ*æ’åº*é€»è¾‘éœ€è¦ç­‰åˆ°æ‰€æœ‰åˆ†ç‰‡ç»“æœéƒ½è¿”å›æ‰å¯ä»¥æ‰§è¡Œã€‚**

**æ ¸å¿ƒä»£ç **ï¼š

* [AbstractDataNodeMerge.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/AbstractDataNodeMerge.java)
* [DataNodeMergeManager.java#run(...)](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java)

### 3.2 DataNodeMergeManager

`AbstractDataNodeMerge` æœ‰ä¸¤ç§å­ç±»å®ç°ï¼š

* `DataMergeService` ï¼šåŸºäº**å †å†…å†…å­˜**åˆå¹¶åˆ†ç‰‡ç»“æœã€‚
* `DataNodeMergeManager` ï¼šåŸºäº**å †å¤–å†…å­˜**åˆå¹¶åˆ†ç‰‡ç»“æœã€‚

ç›®å‰å®˜æ–¹é»˜è®¤é…ç½®ä½¿ç”¨ `DataNodeMergeManager`ã€‚ä¸»è¦æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

1. å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚å½“å¹¶å‘é‡å¤§æˆ–è€…æ•°æ®é‡å¤§æ—¶ï¼Œæ›´å¤§çš„å†…å­˜ç©ºé—´æ„å‘³ç€æ›´å¥½çš„æ€§èƒ½ã€‚
2. å‡å°‘ GC æš‚åœæ—¶é—´ã€‚è®°å½•è¡Œ(row)å¯¹è±¡å°ä¸”é‡ç”¨æ€§å¾ˆä½ï¼Œéœ€è¦èƒ½å¤Ÿè¿›è¡Œç±»ä¼¼ C / C++ çš„è‡ªä¸»å†…å­˜é‡Šæ”¾ã€‚
3. æ›´å¿«çš„å†…å­˜å¤åˆ¶å’Œè¯»å–é€Ÿåº¦ï¼Œå¯¹æ’åºå’Œèšåˆå¸¦æ¥å¾ˆå¥½çš„æé€Ÿã€‚

å¦‚æœå¯¹**å †å¤–å†…å­˜**ä¸å¤ªäº†è§£ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š

1. [ã€Šä»0åˆ°1èµ·æ­¥-è·Ÿæˆ‘è¿›å…¥å †å¤–å†…å­˜çš„å¥‡å¦™ä¸–ç•Œã€‹](http://www.jianshu.com/p/50be08b54bee)
2. [ã€Šå †å†…å†…å­˜è¿˜æ˜¯å †å¤–å†…å­˜ï¼Ÿã€‹](http://www.infoq.com/cn/news/2014/12/external-memory-heap-memory)
3. [ã€ŠJAVAå †å¤–å†…å­˜ã€‹](http://www.cnblogs.com/moonandstar08/p/5107648.html)
4. [ã€ŠJVMæºç åˆ†æä¹‹å †å¤–å†…å­˜å®Œå…¨è§£è¯»ã€‹](https://yq.aliyun.com/articles/2948?spm=5176.100239.blogcont62539.11.a3HdFE)

æœ¬æ–‡ä¸»è¦åˆ†æ `DataNodeMergeManager` å®ç°ï¼Œ`DataMergeService` å¯ä»¥è‡ªå·±é˜…è¯»æˆ–è€…ç­‰å¾…åç»­æ–‡ç« ï¼ˆğŸ˜ˆ**æ¬¢è¿è®¢é˜…æˆ‘çš„å…¬ä¼—å·å™¢**ï¼‰ã€‚

`DataNodeMergeManager` æœ‰ä¸‰ä¸ªç»„ä»¶ï¼š

* `globalSorter` ï¼š`UnsafeExternalRowSorter` => å®ç°è®°å½•è¡Œ(row)**åˆå¹¶å¹¶æ’åº**é€»è¾‘ã€‚
* `globalMergeResult` ï¼š`UnsafeExternalRowSorter` => å®ç°è®°å½•è¡Œ(row)**åˆå¹¶ä¸æ’åº**é€»è¾‘ã€‚
* `unsafeRowGrouper` ï¼š `UnsafeRowGrouper` => å®ç°è®°å½•è¡Œ(row)**èšåˆ**é€»è¾‘ã€‚

`DataNodeMergeManager#run(...)` é€»è¾‘å¦‚ä¸‹ï¼š

* [1] å†™å…¥è®°å½•è¡Œ(row)åˆ° `UnsafeRow`ã€‚
* [2] æ ¹æ®æƒ…å†µå°† `UnsafeRow` æ’å…¥å¯¹åº”ç»„ä»¶ã€‚
* [3] å½“æ‰€æœ‰ `UnsafeRow` æ’å…¥å®Œåï¼Œæ ¹æ®æƒ…å†µä½¿ç”¨ç»„ä»¶èšåˆã€æ’åºã€‚

| æ˜¯å¦æ’åº | æ˜¯å¦èšåˆ | ä¾èµ–ç»„ä»¶ | [2] | [3] |
| --- | --- | --- | --- | --- |
| å¦ | å¦ | `globalSorter` | æ’å…¥ `globalSorter` | ä½¿ç”¨ `globalSorter` åˆå¹¶å¹¶æ’åº |
| æ˜¯ | å¦ | `globalMergeResult` | æ’å…¥ `globalMergeResult` | ä½¿ç”¨ `globalMergeResult` åˆå¹¶ä¸æ’åº |
| å¦ | æ˜¯ | `unsafeRowGrouper` +Â `globalSorter` | æ’å…¥ `unsafeRowGrouper` è¿›è¡Œèšåˆ | ä½¿ç”¨ `globalSorter` åˆå¹¶å¹¶æ’åº |
| æ˜¯ | æ˜¯ | `unsafeRowGrouper` +Â `globalMergeResult` | æ’å…¥ `unsafeRowGrouper` è¿›è¡Œèšåˆ | ä½¿ç”¨ `globalMergeResult` åˆå¹¶ä¸æ’åº |

**æ ¸å¿ƒä»£ç **ï¼š

* [DataNodeMergeManager.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java)ã€‚

ğŸ™ƒçœ‹åˆ°è¿™é‡Œï¼Œå¯èƒ½å¾ˆå¤šåŒå­¦éƒ½æœ‰ç‚¹æ‡µé€¼ï¼Œé—®é¢˜ä¸å¤§ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹ç…ã€‚

### 3.3 UnsafeRow

![unsafe_row](http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row.png)

è®°å½•è¡Œ(row)å†™åˆ° `UnsafeRow` çš„ `baseObject` å±æ€§ï¼Œç»“æ„å¦‚ä¸‹ï¼š

![unsafe_row_object](http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_object.png)
![unsafe_row_2.png](http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_2.png)

* æ‹†åˆ†æˆä¸‰ä¸ªåŒºåŸŸï¼Œ**æ¯ä¸ªåŒºåŸŸæŒ‰ç…§æ ¼å­è®°å½•ä¿¡æ¯ï¼Œæ¯ä¸ªæ ¼å­ 64bits(8 Bytes)**ã€‚
* è®°å½•è¡Œ(row)æŒ‰ç…§å­—æ®µé¡ºåºä½ç½®è®°å½•åˆ° `baseObject`ã€‚
* [1] ç©ºæ ‡è®°ä½åŒºåŸŸ ï¼šæ ‡è®°å­—æ®µå¯¹åº”çš„å€¼æ˜¯å¦ä¸º NULLã€‚
    * å½“å­—æ®µå¯¹åº”çš„å€¼ä¸º NULL æ—¶ï¼Œå…¶å¯¹åº”çš„å­—æ®µé¡ºåºå¯¹åº”çš„ bit è®¾ç½®ä¸º 1ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç¬¬ 0 ä¸ªä½ç½®å­—æ®µä¸º NULLï¼Œåˆ™ç¬¬ä¸€ä¸ªæ ¼å­å¯¹åº”çš„ 64 bits ä»å³è¾¹ç¬¬ä¸€ä¸ª bit è®¾ç½®ä¸º 1ã€‚
    * å› ä¸ºæ¯ä¸ªæ ¼å­æ˜¯ 64 bitsï¼Œæ¯ 64 ä¸ªå­—æ®µå ç”¨ä¸€ä¸ªæ ¼å­ï¼Œä¸æ»¡ä¸€ä¸ªæ ¼å­ï¼ŒæŒ‰ç…§ä¸€ä¸ªæ ¼å­è®¡ç®—ã€‚å› æ­¤ï¼Œè¯¥åŒºåŸŸçš„é•¿åº¦(`bitSetWidthInBytes`) = å­—æ®µå ç”¨çš„æ ¼å­æ•° * 64 bitsã€‚
* [2] ä½ç½®é•¿åº¦åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼åœ¨`[3]åŒºåŸŸ`æ‰€åœ¨çš„ä½ç½®å’Œé•¿åº¦ã€‚
    * æ¯ä¸ªå­—æ®µè®°å½•`[2]åŒºåŸŸ`çš„ä½ç½® = `baseOffset` + `bitSetWidthInBytes` + 8 Bytes * å­—æ®µé¡ºåºã€‚
    * å ç”¨ä¸€ä¸ªæ ¼å­ï¼Œå‰ 32 bits ä¸º`[3]åŒºåŸŸ`çš„ä½ç½®ï¼Œå 32 bits ä¸ºå­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ã€‚
* [3] å€¼åŒºåŸŸ ï¼šè®°å½•å­—æ®µå¯¹åº”çš„å€¼ã€‚
    * æ¯ä¸ªå­—æ®µå¯¹åº”çš„å€¼å ç”¨æ ¼å­æ•° = å­—æ®µå¯¹åº”çš„å€¼é•¿åº¦ / 8 Byteï¼Œå¦‚æœæ— æ³•æ•´é™¤å† + 1ã€‚
    * å› ä¸ºå­—æ®µå¯¹åº”çš„å€¼å¯èƒ½æ— æ³•åˆšå¥½å æ»¡æ¯ä¸ªæ ¼å­ï¼Œæœªä½¿ç”¨çš„ bit ç”¨ 0 å ä½ã€‚

**å†™å…¥ `UnsafeRow`ï¼ŒMyCAT å¯ä»¥é¡ºåºè®¿é—®æ¯ä¸ªå­—æ®µï¼Œè€Œä¸éœ€è¦åœ¨è®°å½•è¡Œ(row)è¿›è¡Œéå†ã€‚**  

ğŸ™ƒæ—¥å¸¸å¼€å‘ä½¿ç”¨ä½æ“ä½œçš„æœºä¼šæ¯”è¾ƒå°‘ï¼Œå¯èƒ½è¾ƒä¸ºéš¾ç†è§£ï¼Œéœ€è¦åå¤ç†è§£ä¸‹ï¼Œç›¸ä¿¡ä¼šè·å¾—å¾ˆå¤§å¯å‘ã€‚æ©ï¼Œè¯¥éƒ¨åˆ†ä»£ç å¼•ç”¨è‡ªå¼€æºè¿ç®—æ¡†æ¶ `Spark`ï¼Œæ˜¯ä¸æ˜¯æ›´åŠ æœ‰åŠ¨åŠ›åˆ—ğŸ˜ˆã€‚

**æ ¸å¿ƒä»£ç **ï¼š

* [UnsafeRow.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRow.java)
* [BufferHolder.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/BufferHolder.java)
* [UnsafeRowWriter.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRowWriter.java)

### 3.4 UnsafeExternalRowSorter

å¦‚æœä½¿ç”¨ Java å®ç° `SELECT * FROM student ORDER BY age desc, nickname asc`ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š

```Java
Collections.sort(students, new Comparator<Comparable>() {
       @Override
       public int compare(Student o1, Student o2) {
           int cmp = compare(o2.age, o1.age);
           return cmp != 0 ? cmp : compare(o1.nickname, o2.nickname);
       }
   }
});
```

ä»åŠŸèƒ½ä¸Šï¼Œ`UnsafeExternalRowSorter` æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚

![sorter_write](http://www.yunai.me/images/MyCAT/2017_06_13/sorter_write.jpeg)

`UnsafeRow` ä¼šå†™å…¥åˆ°ä¸¤ä¸ªåœ°æ–¹ï¼š

1. `List<MemoryBlock>` ï¼šå†…å­˜å—æ•°ç»„ã€‚å½“å‰ `MemoryBlock` æ— æ³•å®¹çº³å†™å…¥çš„ `UnsafeRow` æ—¶ï¼Œç”Ÿæˆæ–°çš„ `MemoryBlock` æä¾›å†™å…¥ã€‚æ¯æ¡ `UnsafeRow` å­˜å‚¨åœ¨ `MemoryBlock` ç”± é•¿åº¦ + å­—èŠ‚å†…å®¹ ç»„æˆã€‚
2. `LongArray` ï¼šæ¯æ¡ `UnsafeRow` å­˜å‚¨åœ¨ `LongArray` ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šaddress + prefixã€‚
    * `address` ï¼š`UnsafeRow` å­˜å‚¨åœ¨ `List<MemoryBlock>` çš„ä½ç½®ã€‚å‰ 13 bits è®°å½•æ‰€åœ¨ `MemoryBlock` çš„ indexï¼Œå 51 bit è®°å½•åœ¨ `MemoryBlock` çš„ offsetã€‚
    * `prefix` ï¼š`UnsafeRow` ç¬¬ä¸€ä¸ªæ’åºå­—æ®µ**å€¼**å‰ 64 bits è®¡ç®—çš„å€¼ã€‚

**`UnsafeExternalRowSorter` æ’åºå®ç°æ–¹å¼** ï¼šæä¾› **[TimSort](http://blog.csdn.net/yangzhongblog/article/details/8184707)** å’Œ **RadixSort** ä¸¤ç§æ’åºç®—æ³•ï¼Œå‰è€…ä¸ºé»˜è®¤å®ç°ã€‚**TimSort** æŠ˜åŠæŸ¥æ‰¾æ—¶ï¼Œä½¿ç”¨ `LongArray`ï¼Œå…ˆæ¯”è¾ƒ `prefix`ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™é¡ºåºå¯¹æ¯”æ¯ä¸ªæ’åºå­—æ®µç›´åˆ°ä¸ç­‰ï¼Œæå‡è®¡ç®—æ•ˆç‡ã€‚æ’å…¥æ“ä½œåœ¨ `LongArray` æ“ä½œï¼Œ`List<MemoryBlock>` åªä½œä¸ºåŸå§‹æ•°æ®ã€‚

å¦å¤–ï¼Œå½“éœ€è¦æ’åºç‰¹åˆ«å¤§çš„æ•°æ®é‡æ—¶ï¼Œä¼šä½¿ç”¨å­˜å‚¨æ•°æ®åˆ°æ–‡ä»¶è¿›è¡Œæ’åºã€‚é™äºç¬”è€…æš‚æ—¶æœªé˜…è¯»è¯¥å¤„æºç ï¼Œåç»­ä¼šå¦å¼€æ–‡ç« åˆ†æã€‚ğŸ™‚

æ ¸å¿ƒæºç ï¼š

*  [UnsafeExternalRowSorter.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java)
*  [UnsafeExternalRowSorter.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java)
*  [TimSort.java](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/TimSort.java)

### 3.5 UnsafeRowGrouper

å¦‚æœä½¿ç”¨ Java å®ç° `SELECT nickname, COUNT(*) FROM student group by nickname`ï¼Œä¸è€ƒè™‘ç®—æ³•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å¦‚ä¸‹å®ç°ï¼š

```Java
Map<String, List<Object>> map = new HashMap<>();
// èšåˆ
for (student : students) {
    if (map.contains(student.nickname)) {
        map.put(student.nickname, map.get(student.nickname).get(1) + 1);
    } else {
        List<Object> value = new Array<>();
        value.add(nickname);
        value.add(1);
        map.put(student.nickname, value);
    }
}
// è¾“å‡º
for (value : map.values) {
    System.out.println(value);
}
```

ä»åŠŸèƒ½ä¸Šï¼Œ`UnsafeRowGrouper` æ˜¯è¿™ä¹ˆå®ç°æ’åºé€»è¾‘ã€‚å½“ç„¶è‚¯å®šçš„æ˜¯ï¼Œä¹Ÿä¸æ˜¯è¿™ä¹ˆâ€œç®€å•â€çš„å®ç°ã€‚

ğŸ˜ˆå…·ä½“æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬åœ¨ã€ŠMyCAT æºç è§£æ â€”â€” åˆ†ç‰‡ç»“æœåˆå¹¶ï¼ˆäºŒï¼‰ã€‹ç»§ç»­åˆ†æã€‚


# 4. æ•‘æŠ¤ä¸­å¿ƒ

çœ‹åˆ°æ­¤å¤„çš„åº”è¯¥æ˜¯çœŸçˆ±å§ï¼Ÿï¼å¦‚æœå†…å®¹ä¸Šæœ‰ä»€ä¹ˆé”™è¯¯æˆ–è€…éš¾æ‡‚çš„åœ°æ–¹ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä¼šå¾ˆè®¤çœŸçš„é€æ¡è§£ç­”çš„ã€‚â€œä¸‡ä¸€â€è§‰å¾—æœ¬æ–‡è¿˜å¯ä»¥ï¼Œå¸Œæœ›è½¬å‘åˆ°æœ‹å‹åœˆè®©æ›´å¤šçš„äººçœ‹åˆ°ã€‚

æœ€åçš„æœ€åï¼Œæ„Ÿè°¢è€å¿ƒé˜…è¯»æœ¬æ–‡çš„åŒå­¦ã€‚

![wechat_mp](http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg)


