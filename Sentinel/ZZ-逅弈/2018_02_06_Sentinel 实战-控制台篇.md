title: Sentinel å®æˆ˜-æ§åˆ¶å°ç¯‡
date: 2018-02-05
tags:
categories: Sentinel
permalink: Sentinel/houyi/The-console
author:  é€…å¼ˆ
from_url: https://www.jianshu.com/p/c47dfd25eeee
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/c47dfd25eeee ã€Œé€…å¼ˆã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [éƒ¨ç½²æ§åˆ¶å°](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [ä¸‹è½½å¯æ‰§è¡Œ jar åŒ…](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [ä¸‹è½½æºç æ„å»º](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [å¯åŠ¨æ§åˆ¶å°](http://www.iocoder.cn/Sentinel/houyi/The-console/)
- [æ¥å…¥æ§åˆ¶å°](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [å¼•å…¥ transport ä¾èµ–](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [é…ç½®åº”ç”¨å¯åŠ¨å‚æ•°](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [è§¦å‘å®¢æˆ·ç«¯è¿æ¥æ§åˆ¶å°](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [åŸ‹ç‚¹](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [è¿æ¥æ§åˆ¶å°](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [éªŒè¯æ•ˆæœ](http://www.iocoder.cn/Sentinel/houyi/The-console/)
- [åŸç†](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [CommandCenter](http://www.iocoder.cn/Sentinel/houyi/The-console/)
  - [HTTPæ¥å£](http://www.iocoder.cn/Sentinel/houyi/The-console/)
- [æŸ¥è¯¢è§„åˆ™](http://www.iocoder.cn/Sentinel/houyi/The-console/)
- [æ›´æ”¹è§„åˆ™](http://www.iocoder.cn/Sentinel/houyi/The-console/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

é€šè¿‡ sentinel çš„æ§åˆ¶å°ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è§„åˆ™è¿›è¡ŒæŸ¥è¯¢å’Œä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°å®æ—¶ç›‘æ§ï¼Œæœºå™¨åˆ—è¡¨ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ sentinel çš„æ§åˆ¶å°åšä¸ªå®Œæ•´çš„äº†è§£ã€‚

# éƒ¨ç½²æ§åˆ¶å°

é¦–å…ˆéœ€è¦å¯åŠ¨æ§åˆ¶å°ï¼Œ  sentinel çš„æ§åˆ¶å°æ˜¯ç”¨ spring boot å†™çš„ä¸€ä¸ªweb åº”ç”¨ï¼Œæˆ‘ä»¬æœ‰å‡ ç§æ–¹å¼æ¥è·å–æ§åˆ¶å°ï¼š

## ä¸‹è½½å¯æ‰§è¡Œ jar åŒ…

ä» [release é¡µé¢](https://github.com/alibaba/Sentinel/releases) ä¸‹è½½æˆªæ­¢ç›®å‰ä¸ºæ­¢æœ€æ–°ç‰ˆæœ¬çš„æ§åˆ¶å° jar åŒ…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-dashboard-release-jar-1.png](https:////upload-images.jianshu.io/upload_images/5417792-ba7c007c9172ba8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

## ä¸‹è½½æºç æ„å»º

é™¤äº†å¯ä»¥ä¸‹è½½é¢„å…ˆæ„å»ºå¥½çš„å¯æ‰§è¡Œ jar åŒ…ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŠŠæ§åˆ¶å°çš„å·¥ç¨‹ä¸‹è½½ä¸‹æ¥è‡ªè¡Œç”¨æºç æ„å»ºï¼Œsentinel æ˜¯ä¸€ä¸ªå¤š maven æ¨¡å—çš„é¡¹ç›®ï¼Œæ§åˆ¶å°æ˜¯å…¶ä¸­çš„ä¸€ä¸ªé¡¹ç›®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-dashboard-module-1.png](https:////upload-images.jianshu.io/upload_images/5417792-e508ddccf04ca33c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/736/format/jpeg)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥ä¸‹è½½å®Œæ•´çš„ sentinel çš„é¡¹ç›®ï¼Œç„¶åæ„å»ºå…¶ä¸­çš„ sentinel-dashboard æ¨¡å—ï¼Œä¹Ÿå¯ä»¥åªä¸‹è½½ sentinel-dashboard æ¨¡å—ç„¶åæ„å»ºã€‚

è¿™é‡Œæˆ‘é€‰æ‹©å°†å®Œæ•´çš„ sentinel å·¥ç¨‹ä¸‹è½½ä¸‹æ¥ï¼Œç„¶åæ„å»º sentinel-dashboard æ¨¡å—ï¼Œé¦–å…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š

```Bash
cd sentinel-dashboard
```

å°†ä¼šè¿›å…¥ dashboard æ¨¡å—ï¼Œç„¶ååœ¨ dashboard ç›®å½•ä¸‹æ‰§è¡Œï¼š

```Bash
mvn clean package
```

mavenå°†ä¼šæŠŠ sentinel-dashboard æ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªå¯æ‰§è¡Œçš„ fat jaråŒ…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-dashboard-module-2.png](https:////upload-images.jianshu.io/upload_images/5417792-b7fd862121aabb0b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

![sentinel-dashboard-module-3.png](https:////upload-images.jianshu.io/upload_images/5417792-1998f99b86bcff7c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

## å¯åŠ¨æ§åˆ¶å°

æ„å»ºæˆåŠŸåï¼Œå°±å¯ä»¥å¯åŠ¨æ§åˆ¶å°äº†ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```Bash
java -Dserver.port=8080 \
-Dcsp.sentinel.dashboard.server=localhost:8080 \
-jar target/sentinel-dashboard.jar
```

å…¶ä¸­ `-Dserver.port=8080` ç”¨äºæŒ‡å®š Sentinel æ§åˆ¶å°ç«¯å£ä¸º `8080`ã€‚

æ‰§è¡Œå®Œä¹‹åï¼Œä½ å°†çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š

![sentinel-dashboard-start-1.png](https:////upload-images.jianshu.io/upload_images/5417792-3e49e7208e91ff09.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

![sentinel-dashboard-start-2.png](https:////upload-images.jianshu.io/upload_images/5417792-e80184f34255d0b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

å½“çœ‹åˆ° `Started DashboardApplication in xx seconds` æ—¶ï¼Œè¯´æ˜ä½ çš„æ§åˆ¶å°å·²ç»å¯åŠ¨æˆåŠŸäº†ï¼Œè®¿é—® <http://localhost:8080/> å°±å¯ä»¥çœ‹åˆ°æ§åˆ¶å°çš„æ ·å­äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-dashboard-1.png](https:////upload-images.jianshu.io/upload_images/5417792-80728de654fa93b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

å¯ä»¥çœ‹åˆ°å½“å‰æ§åˆ¶å°ä¸­æ²¡æœ‰ä»»ä½•çš„åº”ç”¨ï¼Œå› ä¸ºè¿˜æ²¡æœ‰åº”ç”¨æ¥å…¥ã€‚

# æ¥å…¥æ§åˆ¶å°

è¦æƒ³åœ¨æ§åˆ¶å°ä¸­æ“ä½œæˆ‘ä»¬çš„åº”ç”¨ï¼Œé™¤äº†éœ€è¦éƒ¨ç½²ä¸€ä¸ªæ§åˆ¶å°çš„æœåŠ¡å¤–ï¼Œè¿˜éœ€è¦å°†æˆ‘ä»¬çš„åº”ç”¨æ¥å…¥åˆ°æ§åˆ¶å°ä¸­å»ã€‚

## å¼•å…¥ transport ä¾èµ–

é¦–å…ˆéœ€è¦åœ¨æˆ‘ä»¬ä½¿ç”¨ sentinel çš„æœåŠ¡ä¸­å¼•å…¥ sentinel-transport çš„ä¾èµ–ï¼Œå› ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ˜¯ä½œä¸ºå®¢æˆ·ç«¯ï¼Œé€šè¿‡transportæ¨¡å—ä¸æ§åˆ¶å°è¿›è¡Œé€šè®¯çš„ï¼Œä¾èµ–å¦‚ä¸‹æ‰€ç¤ºï¼š

```XML
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-transport-simple-http</artifactId>
    <version>x.y.z</version>
</dependency>
```

ç‰ˆæœ¬ä¾ç„¶é€‰æ‹©æœ€æ–°çš„ 1.4.0

## é…ç½®åº”ç”¨å¯åŠ¨å‚æ•°

å¼•å…¥äº†ä¾èµ–ä¹‹åï¼Œæ¥ç€å°±æ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­é…ç½® JVM å¯åŠ¨å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```Bash
-Dproject.name=xxx -Dcsp.sentinel.dashboard.server=consoleIp:port
```

å…¶ä¸­çš„consoleIpå’Œportå¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬éƒ¨ç½²çš„ sentinel dashboard çš„ipå’Œportï¼Œæˆ‘è¿™é‡Œå¯¹åº”çš„æ˜¯ 127.0.0.1 å’Œ 8080ï¼ŒæŒ‰ç…§å®é™…æƒ…å†µæ¥é…ç½® dashboard çš„ipå’Œportå°±å¥½äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-connection-properties.png](https:////upload-images.jianshu.io/upload_images/5417792-b860ab22c43d6a5a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°æˆ‘è®¾ç½®çš„å®¢æˆ·ç«¯çš„åº”ç”¨åä¸ºï¼šlememoï¼Œå½“å®¢æˆ·ç«¯è¿æ¥ä¸Šæ§åˆ¶å°åï¼Œä¼šæ˜¾ç¤ºè¯¥åº”ç”¨åã€‚

PSï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº†å¯é€šè¿‡ JVM -D å‚æ•°æŒ‡å®šä¹‹å¤–ï¼Œä¹Ÿå¯é€šè¿‡ properties æ–‡ä»¶æŒ‡å®šï¼Œé…ç½®æ–‡ä»¶çš„è·¯å¾„ä¸º `${user_home}/logs/csp/${project.name}.properties`ã€‚

é…ç½®æ–‡ä»¶ä¸­å‚æ•°çš„keyå’Œç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š

![sentinel-dashboard-properties.png](https:////upload-images.jianshu.io/upload_images/5417792-0edc5017ef6dac90.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

ä¼˜å…ˆçº§é¡ºåºï¼šJVM -D å‚æ•°çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œè‹¥ properties æ–‡ä»¶å’Œ JVM å‚æ•°ä¸­æœ‰ç›¸åŒé¡¹çš„é…ç½®ï¼Œä»¥ JVM -D å‚æ•°é…ç½®çš„ä¸ºå‡†ã€‚

## è§¦å‘å®¢æˆ·ç«¯è¿æ¥æ§åˆ¶å°

å®¢æˆ·ç«¯é…ç½®å¥½äº†ä¸æ§åˆ¶å°çš„è¿æ¥å‚æ•°ä¹‹åï¼Œå¹¶ä¸ä¼šä¸»åŠ¨è¿æ¥ä¸Šæ§åˆ¶å°ï¼Œéœ€è¦è§¦å‘ä¸€æ¬¡å®¢æˆ·ç«¯çš„è§„åˆ™æ‰ä¼šå¼€å§‹è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶å‘æ§åˆ¶å°å‘é€å¿ƒè·³å’Œå®¢æˆ·ç«¯è§„åˆ™ç­‰ä¿¡æ¯ã€‚

å®¢æˆ·ç«¯ä¸æ§åˆ¶å°çš„è¿æ¥åˆå§‹åŒ–æ˜¯åœ¨ Env çš„ç±»ä¸­è§¦å‘çš„ï¼Œå³ä¸‹é¢ä»£ç ä¸­çš„ `InitExecutor.doInit();`ï¼š

```Java
public class Env {
    public static final NodeBuilder nodeBuilder = new DefaultNodeBuilder();
    public static final Sph sph = new CtSph();

    static {
        // If init fails, the process will exit.
        InitExecutor.doInit();
    }
}
```

## åŸ‹ç‚¹

ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª UserService æ¥åšéªŒè¯ï¼Œæ­£å¸¸æ—¶ä¼šè¿”å›ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ï¼Œè¢«é™æµæ—¶è¿”å›ä¸€ä¸ªnullï¼Œä½†æ˜¯è¿™æ ·ä¸å¤ªç›´è§‚ï¼Œæœ¬ç¯‡æ–‡ç« æˆ‘æ¢ä¸€ä¸ªæ›´ç®€å•å’Œç›´è§‚çš„éªŒè¯æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```Java
@GetMapping("/testSentinel")
public @ResponseBody
String testSentinel() {
    String resourceName = "testSentinel";
    Entry entry = null;
    String retVal;
    try{
        entry = SphU.entry(resourceName,EntryType.IN);
        retVal = "passed";
    }catch(BlockException e){
        retVal = "blocked";
    }finally {
        if(entry!=null){
            entry.exit();
        }
    }
    return retVal;
}
```

**PSï¼šè¿™é‡Œæœ‰ä¸ªéœ€è¦æ³¨æ„çš„çŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯ SphU.entry æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° EntryType è¯´çš„æ˜¯è¿™æ¬¡è¯·æ±‚çš„æµé‡ç±»å‹ï¼Œå…±æœ‰ä¸¤ç§ç±»å‹ï¼šIN å’Œ OUT ã€‚**

**IN**ï¼šæ˜¯æŒ‡è¿›å…¥æˆ‘ä»¬ç³»ç»Ÿçš„å…¥å£æµé‡ï¼Œæ¯”å¦‚ http è¯·æ±‚æˆ–è€…æ˜¯å…¶ä»–çš„ rpc ä¹‹ç±»çš„è¯·æ±‚ã€‚

**OUT**ï¼šæ˜¯æŒ‡æˆ‘ä»¬ç³»ç»Ÿè°ƒç”¨å…¶ä»–ç¬¬ä¸‰æ–¹æœåŠ¡çš„å‡ºå£æµé‡ã€‚

å…¥å£ã€å‡ºå£æµé‡åªæœ‰åœ¨é…ç½®äº†ç³»ç»Ÿè§„åˆ™æ—¶æ‰æœ‰æ•ˆã€‚

è®¾ç½® Type ä¸º IN æ˜¯ä¸ºäº†ç»Ÿè®¡æ•´ä¸ªç³»ç»Ÿçš„æµé‡æ°´å¹³ï¼Œé˜²æ­¢ç³»ç»Ÿè¢«æ‰“å®ï¼Œç”¨ä»¥è‡ªæˆ‘ä¿æŠ¤çš„ä¸€ç§æ–¹å¼ã€‚

è®¾ç½® Type ä¸º OUT ä¸€æ–¹é¢æ˜¯ä¸ºäº†ä¿æŠ¤ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œæ¯”å¦‚æˆ‘ä»¬ç³»ç»Ÿä¾èµ–äº†ä¸€ä¸ªç”Ÿæˆè®¢å•å·çš„æ¥å£ï¼Œè€Œè¿™ä¸ªæ¥å£æ˜¯æ ¸å¿ƒæœåŠ¡ï¼Œå¦‚æœæˆ‘ä»¬çš„æœåŠ¡æ˜¯éæ ¸å¿ƒåº”ç”¨çš„è¯éœ€è¦å¯¹ä»–è¿›è¡Œé™æµä¿æŠ¤ï¼›å¦ä¸€æ–¹é¢ä¹Ÿå¯ä»¥ä¿æŠ¤è‡ªå·±çš„ç³»ç»Ÿï¼Œå‡è®¾æˆ‘ä»¬çš„æœåŠ¡æ˜¯æ ¸å¿ƒåº”ç”¨ï¼Œè€Œä¾èµ–çš„ç¬¬ä¸‰æ–¹åº”ç”¨è€æ˜¯è¶…æ—¶ï¼Œé‚£è¿™æ—¶å¯ä»¥é€šè¿‡è®¾ç½®ä¾èµ–çš„æœåŠ¡çš„ rt æ¥è¿›è¡Œé™çº§ï¼Œè¿™æ ·å°±ä¸è‡³äºè®©ç¬¬ä¸‰æ–¹æœåŠ¡æŠŠæˆ‘ä»¬çš„ç³»ç»Ÿæ‹–å®ã€‚

ä¸‹å›¾æè¿°äº†æµé‡çš„ç±»å‹å’Œç³»ç»Ÿä¹‹é—´çš„å…³ç³»ï¼š

![sentinel-entry-type.png](https:////upload-images.jianshu.io/upload_images/5417792-ae78d6da78d48b31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

## è¿æ¥æ§åˆ¶å°

åº”ç”¨æ¥å…¥ transport æ¨¡å—ä¹‹åï¼Œæˆ‘ä»¬ä¸»åŠ¨æ¥è®¿é—®ä¸€æ¬¡ `/testSentinel` æ¥å£ï¼Œé¡ºåˆ©çš„è¯ï¼Œå®¢æˆ·ç«¯ä¼šä¸»åŠ¨è¿æ¥ä¸Šæ§åˆ¶å°ï¼Œå¹¶å°†è‡ªå·±çš„ipç­‰ä¿¡æ¯å‘é€ç»™æ§åˆ¶å°ï¼Œå¹¶ä¸”ä¼šä¸æ§åˆ¶å°ç»´æŒä¸€ä¸ªå¿ƒè·³ã€‚

ç°åœ¨æˆ‘ä»¬åœ¨æ¥è®¿é—®ä¸‹æ§åˆ¶å°ï¼Œçœ‹åˆ°å®¢æˆ·ç«¯å·²ç»è¿æ¥ä¸Šæ¥äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-dashboard-2.png](https:////upload-images.jianshu.io/upload_images/5417792-2e7e0a6efe724338.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

å®¢æˆ·ç«¯è¿æ¥ä¸Šdashboardä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸ºæˆ‘ä»¬å®šä¹‰çš„èµ„æºé…ç½®è§„åˆ™äº†ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é…ç½®è§„åˆ™ï¼š

- åœ¨ã€**æµæ§è§„åˆ™**ã€‘é¡µé¢ä¸­æ–°å¢
- åœ¨ã€**ç°‡ç‚¹é“¾è·¯**ã€‘ä¸­æ·»åŠ 

æˆ‘ä»¬å¯ä»¥åœ¨ã€æµæ§è§„åˆ™ã€‘é¡µé¢ä¸­æ–°å¢ï¼Œç‚¹å‡»ã€æµæ§è§„åˆ™ã€‘è¿›å…¥é¡µé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-add-flow-rule-1.png](https:////upload-images.jianshu.io/upload_images/5417792-2a5f8aae21190515.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

åœ¨å¼¹å‡ºæ¡†ä¸­ï¼Œå¡«å†™èµ„æºåå’Œå•æœºé˜ˆå€¼ï¼Œå…¶ä»–çš„å±æ€§ä¿æŒé»˜è®¤è®¾ç½®å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-add-flow-rule-2.png](https:////upload-images.jianshu.io/upload_images/5417792-45492cb957f53bb2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

ç‚¹å‡»ã€æ–°å¢ã€‘åï¼Œè§„åˆ™å³ç”Ÿæ•ˆäº†ã€‚

ç¬¬äºŒç§æ–¹å¼å°±æ˜¯åœ¨ã€ç°‡ç‚¹é“¾è·¯ã€‘çš„é¡µé¢ä¸­æ‰¾åˆ°æˆ‘ä»¬åŸ‹ç‚¹çš„èµ„æºåï¼Œç„¶åç›´æ¥å¯¹è¯¥èµ„æºè¿›è¡Œå¢åŠ æµæ§è§„åˆ™çš„æ“ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-add-flow-rule-3.png](https:////upload-images.jianshu.io/upload_images/5417792-9da03475390bded4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

ä¸Šå›¾ä¸­å³ä¾§çš„ã€+æµæ§ã€‘çš„æŒ‰é’®ç‚¹å‡»åï¼Œå¼¹å‡ºæ¡†ä¸ç›´æ¥æ–°å¢è§„åˆ™æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ä¼šè‡ªåŠ¨å°†èµ„æºåå¡«å……è¿›å»ï¼Œçœå»äº†æˆ‘ä»¬è®¾ç½®çš„è¿™ä¸€æ­¥ã€‚

## éªŒè¯æ•ˆæœ

è§„åˆ™åˆ›å»ºå®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ã€æµæ§è§„åˆ™ã€‘é¡µé¢æŸ¥è¯¢åˆ°äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-flow-rule-list.png](https:////upload-images.jianshu.io/upload_images/5417792-fd7fcf286e1f2b56.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

æ¥ç€æˆ‘ä»¬å°±å¯ä»¥æ¥éªŒè¯æ•ˆæœäº†ï¼Œè®©æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­å¿«é€Ÿçš„åˆ·æ–°æ¥è¯·æ±‚ `/testSentinel` è¿™ä¸ªæ¥å£ï¼Œä¸å‡ºæ„å¤–ï¼Œåº”è¯¥ä¼šçœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æƒ…å†µï¼š

![sentinel-flow-rule-effect-1.png](https:////upload-images.jianshu.io/upload_images/5417792-096d0a0f4c6d3686.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/702/format/jpeg)

è¯´æ˜æˆ‘ä»¬è®¾ç½®çš„æµæ§è§„åˆ™ç”Ÿæ•ˆäº†ï¼Œè¯·æ±‚è¢« block äº†ã€‚

ç°åœ¨æˆ‘ä»¬å†åˆ°æ§åˆ¶å°çš„ã€å®æ—¶ç›‘æ§ã€‘é¡µé¢æŸ¥è¯¢ä¸‹ï¼Œåˆšåˆšæˆ‘ä»¬çš„ä¸€é¡¿ç–¯ç‹‚è¯·æ±‚åº”è¯¥æœ‰å¾ˆå¤šéƒ½è¢« block äº†ï¼Œé€šè¿‡çš„ qps åº”è¯¥ç»´æŒåœ¨2ä»¥ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![sentinel-flow-rule-effect-2.png](https:////upload-images.jianshu.io/upload_images/5417792-8c217932da93369d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

# åŸç†

æˆ‘ä»¬çŸ¥é“ sentinel çš„æ ¸å¿ƒå°±æ˜¯å›´ç»•ç€å‡ ä»¶äº‹ï¼šèµ„æºçš„å®šä¹‰ï¼Œè§„åˆ™çš„é…ç½®ï¼Œä»£ç ä¸­åŸ‹ç‚¹ã€‚

è€Œä¸”è¿™äº›äº‹åœ¨ sentinel-core ä¸­éƒ½æœ‰èƒ½åŠ›å®ç°ï¼Œä¹Ÿå¯¹å¤–æš´éœ²äº†ç›¸åº”çš„ http æ¥å£æ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹ sentinel ä¸­çš„ç›¸å…³æ•°æ®ã€‚

## CommandCenter

sentinel-core åœ¨ç¬¬ä¸€æ¬¡è§„åˆ™è¢«è§¦å‘çš„æ—¶å€™ï¼Œå¯åŠ¨äº†ä¸€ä¸ª CommandCenterï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¼•å…¥çš„ sentinel-transport-simple-http ä¾èµ–ä¸­è¢«å¼•å…¥çš„å®ç°ç±»ï¼šSimpleHttpCommandCenterã€‚

è¿™ä¸ª SimpleHttpCommandCenter ç±»ä¸­å¯åŠ¨äº†ä¸¤ä¸ªçº¿ç¨‹æ± ï¼šä¸»çº¿ç¨‹æ± å’Œä¸šåŠ¡çº¿ç¨‹æ± ã€‚

ä¸»çº¿ç¨‹æ± å¯åŠ¨äº†ä¸€ä¸ª ServerSocket æ¥ç›‘å¬é»˜è®¤çš„ 8719 ç«¯å£ï¼Œå¦‚æœç«¯å£è¢«å ç”¨ï¼Œä¼šè‡ªåŠ¨å°è¯•è·å–ä¸‹ä¸€ä¸ªç«¯å£ï¼Œå°è¯•3æ¬¡ã€‚

ä¸šåŠ¡çº¿ç¨‹æ± ä¸»è¦æ˜¯ç”¨æ¥å¤„ç† ServerSocket æ¥æ”¶åˆ°çš„æ•°æ®ã€‚

å°†ä¸é‡è¦çš„ä»£ç çœç•¥æ‰ä¹‹åï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```Java
public class SimpleHttpCommandCenter implements CommandCenter {
    // çœç•¥åˆå§‹åŒ–
    private ExecutorService executor;
    private ExecutorService bizExecutor;

    @Override
    public void start() throws Exception {

        Runnable serverInitTask = new Runnable() {
            int port;
            {
                try {
                    port = Integer.parseInt(TransportConfig.getPort());
                } catch (Exception e) {
                    port = DEFAULT_PORT;
                }
            }

            @Override
            public void run() {
                // è·å–å¯ç”¨çš„ç«¯å£ç”¨ä»¥åˆ›å»ºä¸€ä¸ªServerSocket
                ServerSocket serverSocket = getServerSocketFromBasePort(port);
                if (serverSocket != null) {
                    // åœ¨ä¸»çº¿ç¨‹ä¸­å¯åŠ¨ServerThreadç”¨ä»¥æ¥æ”¶socketè¯·æ±‚
                    executor.submit(new ServerThread(serverSocket));
                    // çœç•¥éƒ¨åˆ†ä»£ç 
                } else {
                    CommandCenterLog.info("[CommandCenter] chooses port fail, http command center will not work");
                }
                executor.shutdown();
            }
        };
        new Thread(serverInitTask).start();
    }

    class ServerThread extends Thread {
        private ServerSocket serverSocket;

        ServerThread(ServerSocket s) {
            this.serverSocket = s;
        }

        @Override
        public void run() {
            while (true) {
                Socket socket = null;
                try {
                    socket = this.serverSocket.accept();
                    setSocketSoTimeout(socket);
                    // å°†æ¥æ”¶åˆ°çš„socketå°è£…åˆ°HttpEventTaskä¸­ç”±ä¸šåŠ¡çº¿ç¨‹å»å¤„ç†
                    HttpEventTask eventTask = new HttpEventTask(socket);
                    bizExecutor.submit(eventTask);
                } catch (Exception e) {
                    // çœç•¥éƒ¨åˆ†ä»£ç 
                }
            }
        }
    }
}
```

å…·ä½“çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![command-center.png](https:////upload-images.jianshu.io/upload_images/5417792-56d71a783101902a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

## HTTPæ¥å£

SimpleHttpCommandCenter å¯åŠ¨äº†ä¸€ä¸ª ServerSocket æ¥ç›‘å¬8719ç«¯å£ï¼Œä¹Ÿå¯¹å¤–æä¾›äº†ä¸€äº› http æ¥å£ç”¨ä»¥æ“ä½œ sentinel-core ä¸­çš„æ•°æ®ï¼ŒåŒ…æ‹¬æŸ¥è¯¢|æ›´æ”¹è§„åˆ™ï¼ŒæŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€ç­‰ã€‚

**PSï¼šæ§åˆ¶å°ä¹Ÿæ˜¯é€šè¿‡è¿™äº›æ¥å£ä¸ sentinel-core è¿›è¡Œæ•°æ®äº¤äº’çš„ï¼**

æä¾›è¿™äº›æœåŠ¡çš„æ˜¯ä¸€äº› CommandHandler çš„å®ç°ç±»ï¼Œæ¯ä¸ªç±»æä¾›äº†ä¸€ç§èƒ½åŠ›ï¼Œè¿™äº›ç±»æ˜¯åœ¨ sentinel-transport-common ä¾èµ–ä¸­æä¾›çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![command-handler.png](https:////upload-images.jianshu.io/upload_images/5417792-db303c9bcec554b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

# æŸ¥è¯¢è§„åˆ™

è¿è¡Œä¸‹é¢å‘½ä»¤ï¼Œåˆ™ä¼šè¿”å›ç°æœ‰ç”Ÿæ•ˆçš„è§„åˆ™ï¼š

```Bash
curl http://localhost:8719/getRules?type=<XXXX>
```

å…¶ä¸­ï¼Œtypeæœ‰ä»¥ä¸‹å–å€¼ï¼š

-  `flow` ä»¥ JSON æ ¼å¼è¿”å›ç°æœ‰çš„é™æµè§„åˆ™ï¼›
-  `degrade` åˆ™è¿”å›ç°æœ‰ç”Ÿæ•ˆçš„é™çº§è§„åˆ™åˆ—è¡¨ï¼›
-  `system` åˆ™è¿”å›ç³»ç»Ÿä¿æŠ¤è§„åˆ™ã€‚

# æ›´æ”¹è§„åˆ™

åŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ¥ä¿®æ”¹å·²æœ‰è§„åˆ™ï¼š

```Bash
curl http://localhost:8719/setRules?type=<XXXX>&data=<DATA>
```

å…¶ä¸­ï¼Œtype å¯ä»¥è¾“å…¥ `flow`ã€`degrade` ç­‰æ–¹å¼æ¥åˆ¶å®šæ›´æ”¹çš„è§„åˆ™ç§ç±»ï¼Œ`data` åˆ™æ˜¯å¯¹åº”çš„ JSON æ ¼å¼çš„è§„åˆ™ã€‚

å…¶ä»–çš„æ¥å£ä¸å†ä¸€ä¸€è¯¦ç»†ä¸¾ä¾‹äº†ï¼Œæœ‰éœ€è¦çš„å¤§å®¶å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç äº†è§£ã€‚