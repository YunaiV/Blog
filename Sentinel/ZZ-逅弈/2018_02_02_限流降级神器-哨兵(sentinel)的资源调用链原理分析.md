title: é™æµé™çº§ç¥å™¨-å“¨å…µ(sentinel)çš„èµ„æºè°ƒç”¨é“¾åŸç†åˆ†æ
date: 2018-02-02
tags:
categories: Sentinel
permalink: Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel
author:  é€…å¼ˆ
from_url: https://www.jianshu.com/p/5a468b6a07fe
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/5a468b6a07fe ã€Œé€…å¼ˆã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [NodeSelectorSlot](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
  - [Contextçš„åˆ›å»ºä¸é”€æ¯](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
  - [è°ƒç”¨é“¾æ ‘](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
- [ClusterBuilderSlot](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
- [StatistcSlot](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
- [SystemSlot](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
- [AuthoritySlot](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
- [FlowSlot](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
- [DegradeSlot](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)
- [æ€»ç»“](http://www.iocoder.cn/Sentinel/houyi/Analysis-of-resource-call-chain-for-the-sentinel/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

æˆ‘ä»¬å·²ç»çŸ¥é“äº†sentinelå®ç°é™æµé™çº§çš„åŸç†ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯ä¸€å †Slotç»„æˆçš„è°ƒç”¨é“¾ã€‚

è¿™é‡Œå¤§æ¦‚çš„ä»‹ç»ä¸‹æ¯ç§Slotçš„åŠŸèƒ½èŒè´£ï¼š

-  `NodeSelectorSlot` è´Ÿè´£æ”¶é›†èµ„æºçš„è·¯å¾„ï¼Œå¹¶å°†è¿™äº›èµ„æºçš„è°ƒç”¨è·¯å¾„ï¼Œä»¥æ ‘çŠ¶ç»“æ„å­˜å‚¨èµ·æ¥ï¼Œç”¨äºæ ¹æ®è°ƒç”¨è·¯å¾„æ¥é™æµé™çº§ï¼›
-  `ClusterBuilderSlot` åˆ™ç”¨äºå­˜å‚¨èµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ä»¥åŠè°ƒç”¨è€…ä¿¡æ¯ï¼Œä¾‹å¦‚è¯¥èµ„æºçš„ RT, QPS, thread count ç­‰ç­‰ï¼Œè¿™äº›ä¿¡æ¯å°†ç”¨ä½œä¸ºå¤šç»´åº¦é™æµï¼Œé™çº§çš„ä¾æ®ï¼›
-  `StatisticsSlot` åˆ™ç”¨äºè®°å½•ï¼Œç»Ÿè®¡ä¸åŒç»´åº¦çš„ runtime ä¿¡æ¯ï¼›
-  `SystemSlot` åˆ™é€šè¿‡ç³»ç»Ÿçš„çŠ¶æ€ï¼Œä¾‹å¦‚ load1 ç­‰ï¼Œæ¥æ§åˆ¶æ€»çš„å…¥å£æµé‡ï¼›
-  `AuthoritySlot` åˆ™æ ¹æ®é»‘ç™½åå•ï¼Œæ¥åšé»‘ç™½åå•æ§åˆ¶ï¼›
-  `FlowSlot` åˆ™ç”¨äºæ ¹æ®é¢„è®¾çš„é™æµè§„åˆ™ï¼Œä»¥åŠå‰é¢ slot ç»Ÿè®¡çš„çŠ¶æ€ï¼Œæ¥è¿›è¡Œé™æµï¼›
-  `DegradeSlot` åˆ™é€šè¿‡ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥åŠé¢„è®¾çš„è§„åˆ™ï¼Œæ¥åšç†”æ–­é™çº§ï¼›

æ¯ä¸ªSlotæ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘å¤„ç†åï¼Œä¼šè°ƒç”¨fireEntry()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ä¼šè§¦å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„entryæ–¹æ³•ï¼Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹åˆä¼šè°ƒç”¨ä»–çš„fireEntryï¼Œä»¥æ­¤ç±»æ¨ç›´åˆ°æœ€åä¸€ä¸ªSlotï¼Œç”±æ­¤å°±å½¢æˆäº†sentinelçš„è´£ä»»é“¾ã€‚

ä¸‹é¢æˆ‘ä»¬å°±æ¥è¯¦ç»†ç ”ç©¶ä¸‹è¿™äº›Slotçš„åŸç†ã€‚

# NodeSelectorSlot

`NodeSelectorSlot` æ˜¯ç”¨æ¥æ„é€ è°ƒç”¨é“¾çš„ï¼Œå…·ä½“çš„æ˜¯å°†èµ„æºçš„è°ƒç”¨è·¯å¾„ï¼Œå°è£…æˆä¸€ä¸ªä¸€ä¸ªçš„èŠ‚ç‚¹ï¼Œå†ç»„æˆä¸€ä¸ªæ ‘çŠ¶çš„ç»“æ„æ¥å½¢æˆä¸€ä¸ªå®Œæ•´çš„è°ƒç”¨é“¾ï¼Œ`NodeSelectorSlot`æ˜¯æ‰€æœ‰Slotä¸­æœ€å…³é”®ä¹Ÿæ˜¯æœ€å¤æ‚çš„ä¸€ä¸ªSlotï¼Œè¿™é‡Œæ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼š

- Resource

èµ„æºæ˜¯ Sentinel çš„å…³é”®æ¦‚å¿µã€‚å®ƒå¯ä»¥æ˜¯ Java åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›çš„æœåŠ¡ï¼Œæˆ–ç”±åº”ç”¨ç¨‹åºè°ƒç”¨çš„å…¶å®ƒæœåŠ¡ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚

åªè¦é€šè¿‡ Sentinel API å®šä¹‰çš„ä»£ç ï¼Œå°±æ˜¯èµ„æºï¼Œèƒ½å¤Ÿè¢« Sentinel ä¿æŠ¤èµ·æ¥ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•ç­¾åï¼ŒURLï¼Œç”šè‡³æœåŠ¡åç§°ä½œä¸ºèµ„æºåæ¥æ ‡ç¤ºèµ„æºã€‚

ç®€å•æ¥è¯´ï¼Œèµ„æºå°±æ˜¯ Sentinel ç”¨æ¥ä¿æŠ¤ç³»ç»Ÿçš„ä¸€ä¸ªåª’ä»‹ã€‚æºç ä¸­ç”¨æ¥åŒ…è£…èµ„æºçš„ç±»æ˜¯ï¼š`com.alibaba.csp.sentinel.slotchain.ResourceWrapper`ï¼Œä»–æœ‰ä¸¤ä¸ªå­ç±»ï¼š`StringResourceWrapper` å’Œ `MethodResourceWrapper`ï¼Œé€šè¿‡åå­—å°±çŸ¥é“å¯ä»¥å°†ä¸€æ®µå­—ç¬¦ä¸²æˆ–ä¸€ä¸ªæ–¹æ³•åŒ…è£…ä¸ºä¸€ä¸ªèµ„æºã€‚

æ‰“ä¸ªæ¯”æ–¹ï¼Œæˆ‘æœ‰ä¸€ä¸ªæœåŠ¡Aï¼Œè¯·æ±‚éå¸¸å¤šï¼Œç»å¸¸ä¼šè¢«é™¡å¢çš„æµé‡å†²å®ï¼Œä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œç®€å•çš„åšæ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª Sentinel çš„èµ„æºï¼Œé€šè¿‡è¯¥èµ„æºæ¥å¯¹è¯·æ±‚è¿›è¡Œè°ƒæ•´ï¼Œä½¿å¾—å…è®¸é€šè¿‡çš„è¯·æ±‚ä¸ä¼šæŠŠæœåŠ¡Aæå´©æºƒã€‚



![img](https:////upload-images.jianshu.io/upload_images/5417792-996f01d2ad660bf7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

resource.png

æ¯ä¸ªèµ„æºçš„çŠ¶æ€ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œè¿™å–å†³äºèµ„æºåç«¯çš„æœåŠ¡ï¼Œæœ‰çš„èµ„æºå¯èƒ½æ¯”è¾ƒç¨³å®šï¼Œæœ‰çš„èµ„æºå¯èƒ½ä¸å¤ªç¨³å®šã€‚é‚£ä¹ˆåœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ï¼ŒSentinel éœ€è¦å¯¹ä¸ç¨³å®šèµ„æºè¿›è¡Œæ§åˆ¶ã€‚å½“è°ƒç”¨é“¾è·¯ä¸­æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šï¼Œä¾‹å¦‚ï¼Œè¡¨ç°ä¸º timeoutï¼Œæˆ–è€…å¼‚å¸¸æ¯”ä¾‹å‡é«˜çš„æ—¶å€™ï¼Œåˆ™å¯¹è¿™ä¸ªèµ„æºçš„è°ƒç”¨è¿›è¡Œé™åˆ¶ï¼Œå¹¶è®©è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å½±å“åˆ°å…¶å®ƒçš„èµ„æºï¼Œæœ€ç»ˆå¯¼è‡´é›ªå´©çš„åæœã€‚

- Context

ä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªç”¨æ¥ä¿å­˜è°ƒç”¨é“¾å½“å‰çŠ¶æ€çš„å…ƒæ•°æ®çš„ç±»ï¼Œæ¯æ¬¡è¿›å…¥ä¸€ä¸ªèµ„æºæ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ã€‚**ç›¸åŒçš„èµ„æºåå¯èƒ½ä¼šåˆ›å»ºå¤šä¸ªä¸Šä¸‹æ–‡ã€‚**ä¸€ä¸ªContextä¸­åŒ…å«äº†ä¸‰ä¸ªæ ¸å¿ƒçš„å¯¹è±¡ï¼š

1ï¼‰å½“å‰è°ƒç”¨é“¾çš„æ ¹èŠ‚ç‚¹ï¼šEntranceNode

2ï¼‰å½“å‰çš„å…¥å£ï¼šEntry

3ï¼‰å½“å‰å…¥å£æ‰€å…³è”çš„èŠ‚ç‚¹ï¼šNode

ä¸Šä¸‹æ–‡ä¸­åªä¼šä¿å­˜ä¸€ä¸ªå½“å‰æ­£åœ¨å¤„ç†çš„å…¥å£Entryï¼Œå¦å¤–è¿˜ä¼šä¿å­˜è°ƒç”¨é“¾çš„æ ¹èŠ‚ç‚¹ã€‚**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯æ¬¡è¿›å…¥ä¸€ä¸ªæ–°çš„èµ„æºæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ã€‚**

- Entry

æ¯æ¬¡è°ƒç”¨ `SphU#entry()` éƒ½ä¼šç”Ÿæˆä¸€ä¸ªEntryå…¥å£ï¼Œè¯¥å…¥å£ä¸­ä¼šä¿å­˜äº†ä»¥ä¸‹æ•°æ®ï¼šå…¥å£çš„åˆ›å»ºæ—¶é—´ï¼Œå½“å‰å…¥å£æ‰€å…³è”çš„èŠ‚ç‚¹ï¼Œå½“å‰å…¥å£æ‰€å…³è”çš„è°ƒç”¨æºå¯¹åº”çš„èŠ‚ç‚¹ã€‚Entryæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä»–åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œåœ¨CtSphä¸­çš„ä¸€ä¸ªé™æ€ç±»ï¼šCtEntry

- Node

èŠ‚ç‚¹æ˜¯ç”¨æ¥ä¿å­˜æŸä¸ªèµ„æºçš„å„ç§å®æ—¶ç»Ÿè®¡ä¿¡æ¯çš„ï¼Œä»–æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡è®¿é—®èŠ‚ç‚¹ï¼Œå°±å¯ä»¥è·å–åˆ°å¯¹åº”èµ„æºçš„å®æ—¶çŠ¶æ€ï¼Œä»¥æ­¤ä¸ºä¾æ®è¿›è¡Œé™æµå’Œé™çº§æ“ä½œã€‚

å¯èƒ½çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶è¿˜æ˜¯æ¯”è¾ƒæ‡µï¼Œè¿™ä¹ˆå¤šç±»åˆ°åº•æœ‰ä»€ä¹ˆç”¨ï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼ŒæŒ–æ˜ä¸€ä¸‹è¿™äº›ç±»çš„ä½œç”¨ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œæˆ‘å…ˆç»™å¤§å®¶å±•ç¤ºä¸€ä¸‹ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-0613113e6ab8fb0d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

relations.png

è¿™é‡ŒæŠŠå‡ ç§Nodeçš„ä½œç”¨å…ˆå¤§æ¦‚ä»‹ç»ä¸‹ï¼š

| èŠ‚ç‚¹          | ä½œç”¨                                                         |
| ------------- | ------------------------------------------------------------ |
| StatisticNode | æ‰§è¡Œå…·ä½“çš„èµ„æºç»Ÿè®¡æ“ä½œ                                       |
| DefaultNode   | è¯¥èŠ‚ç‚¹æŒæœ‰æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æŒ‡å®šèµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå½“åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å¤šæ¬¡è°ƒç”¨entryæ–¹æ³•æ—¶ï¼Œè¯¥èŠ‚ç‚¹å¯èƒ½ä¸‹ä¼šåˆ›å»ºæœ‰ä¸€ç³»åˆ—çš„å­èŠ‚ç‚¹ã€‚<br />å¦å¤–æ¯ä¸ªDefaultNodeä¸­ä¼šå…³è”ä¸€ä¸ªClusterNode |
| ClusterNode   | è¯¥èŠ‚ç‚¹ä¸­ä¿å­˜äº†èµ„æºçš„æ€»ä½“çš„è¿è¡Œæ—¶ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬rtï¼Œçº¿ç¨‹æ•°ï¼Œqpsç­‰ç­‰ï¼Œç›¸åŒçš„èµ„æºä¼šå…¨å±€å…±äº«åŒä¸€ä¸ªClusterNodeï¼Œä¸ç®¡ä»–å±äºå“ªä¸ªä¸Šä¸‹æ–‡ |
| EntranceNode  | è¯¥èŠ‚ç‚¹è¡¨ç¤ºä¸€æ£µè°ƒç”¨é“¾æ ‘çš„å…¥å£èŠ‚ç‚¹ï¼Œé€šè¿‡ä»–å¯ä»¥è·å–è°ƒç”¨é“¾æ ‘ä¸­æ‰€æœ‰çš„å­èŠ‚ç‚¹ |

## Contextçš„åˆ›å»ºä¸é”€æ¯

é¦–å…ˆæˆ‘ä»¬è¦æ¸…æ¥šçš„ä¸€ç‚¹å°±æ˜¯ï¼Œæ¯æ¬¡æ‰§è¡Œentry()æ–¹æ³•ï¼Œè¯•å›¾å†²ç ´ä¸€ä¸ªèµ„æºæ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ä¼šä¿å­˜ç€è°ƒç”¨é“¾çš„æ ¹èŠ‚ç‚¹å’Œå½“å‰çš„å…¥å£ã€‚

Contextæ˜¯é€šè¿‡ContextUtilåˆ›å»ºçš„ï¼Œå…·ä½“çš„æ–¹æ³•æ˜¯trueEntryï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
protected static Context trueEnter(String name, String origin) {
    // å…ˆä»ThreadLocalä¸­è·å–
    Context context = contextHolder.get();
    if (context == null) {
        // å¦‚æœThreadLocalä¸­è·å–ä¸åˆ°Context
        // åˆ™æ ¹æ®nameä»mapä¸­è·å–æ ¹èŠ‚ç‚¹ï¼Œåªè¦æ˜¯ç›¸åŒçš„èµ„æºåï¼Œå°±èƒ½ç›´æ¥ä»mapä¸­è·å–åˆ°node
        Map<String, DefaultNode> localCacheNameMap = contextNameNodeMap;
        DefaultNode node = localCacheNameMap.get(name);
        if (node == null) {
            // çœç•¥éƒ¨åˆ†ä»£ç 
            try {
                LOCK.lock();
                node = contextNameNodeMap.get(name);
                if (node == null) {
                    // çœç•¥éƒ¨åˆ†ä»£ç 
                    // åˆ›å»ºä¸€ä¸ªæ–°çš„å…¥å£èŠ‚ç‚¹
                    node = new EntranceNode(new StringResourceWrapper(name, EntryType.IN), null);
                    Constants.ROOT.addChild(node);
                    // çœç•¥éƒ¨åˆ†ä»£ç 
                }
            } finally {
                LOCK.unlock();
            }
        }
        // åˆ›å»ºä¸€ä¸ªæ–°çš„Contextï¼Œå¹¶è®¾ç½®Contextçš„æ ¹èŠ‚ç‚¹ï¼Œå³è®¾ç½®EntranceNode
        context = new Context(node, name);
        context.setOrigin(origin);
        // å°†è¯¥Contextä¿å­˜åˆ°ThreadLocalä¸­å»
        contextHolder.set(context);
    }
    return context;
}
```

ä¸Šé¢çš„ä»£ç ä¸­æˆ‘çœç•¥äº†éƒ¨åˆ†ä»£ç ï¼Œåªä¿ç•™äº†æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚ä»æºç ä¸­è¿˜æ˜¯å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„çœ‹å‡ºç”ŸæˆContextçš„è¿‡ç¨‹ï¼š

- 1.å…ˆä»ThreadLocalä¸­è·å–ï¼Œå¦‚æœèƒ½è·å–åˆ°ç›´æ¥è¿”å›ï¼Œå¦‚æœè·å–ä¸åˆ°åˆ™ç»§ç»­ç¬¬2æ­¥
- 2.ä»ä¸€ä¸ªstaticçš„mapä¸­æ ¹æ®ä¸Šä¸‹æ–‡çš„åç§°è·å–ï¼Œå¦‚æœèƒ½è·å–åˆ°åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ç»§ç»­ç¬¬3æ­¥
- 3.åŠ é”åè¿›è¡Œä¸€æ¬¡double checkï¼Œå¦‚æœè¿˜æ˜¯æ²¡èƒ½ä»mapä¸­è·å–åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªEntranceNodeï¼Œå¹¶æŠŠè¯¥EntranceNodeæ·»åŠ åˆ°ä¸€ä¸ªå…¨å±€çš„ROOTèŠ‚ç‚¹ä¸­å»ï¼Œç„¶åå°†è¯¥èŠ‚ç‚¹æ·»åŠ åˆ°mapä¸­å»(è¿™éƒ¨åˆ†ä»£ç åœ¨ä¸Šè¿°ä»£ç ä¸­çœç•¥äº†)
- 4.æ ¹æ®EntranceNodeåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå¹¶å°†è¯¥ä¸Šä¸‹æ–‡ä¿å­˜åˆ°ThreadLocalä¸­å»ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å¯ä»¥ç›´æ¥è·å–

é‚£ä¿å­˜åœ¨ThreadLocalä¸­çš„ä¸Šä¸‹æ–‡ä»€ä¹ˆæ—¶å€™ä¼šæ¸…é™¤å‘¢ï¼Ÿä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°å…·ä½“çš„æ¸…é™¤å·¥ä½œåœ¨ContextUtilçš„exitæ–¹æ³•ä¸­ï¼Œå½“æ‰§è¡Œè¯¥æ–¹æ³•æ—¶ï¼Œä¼šå°†ä¿å­˜åœ¨ThreadLocalä¸­çš„contextå¯¹è±¡æ¸…é™¤ï¼Œå…·ä½“çš„ä»£ç éå¸¸ç®€å•ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ã€‚

é‚£ContextUtil.exitæ–¹æ³•ä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨å‘¢ï¼Ÿæœ‰ä¸¤ç§æƒ…å†µï¼šä¸€æ˜¯ä¸»åŠ¨è°ƒç”¨ContextUtil.exitçš„æ—¶å€™ï¼ŒäºŒæ˜¯å½“ä¸€ä¸ªå…¥å£Entryè¦é€€å‡ºï¼Œæ‰§è¡Œè¯¥Entryçš„trueExitæ–¹æ³•çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¼šè§¦å‘ContextUtil.exitçš„æ–¹æ³•ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªå‰æï¼Œå°±æ˜¯å½“å‰Entryçš„çˆ¶Entryä¸ºnullæ—¶ï¼Œæ­¤æ—¶è¯´æ˜è¯¥Entryå·²ç»æ˜¯æœ€é¡¶å±‚çš„æ ¹èŠ‚ç‚¹äº†ï¼Œå¯ä»¥æ¸…é™¤contextã€‚

## è°ƒç”¨é“¾æ ‘

å½“åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å¤šæ¬¡è°ƒç”¨äº† SphU#entry() æ–¹æ³•æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸€æ£µè°ƒç”¨é“¾æ ‘ã€‚å…·ä½“çš„ä»£ç åœ¨entryæ–¹æ³•ä¸­åˆ›å»ºCtEntryå¯¹è±¡æ—¶ï¼š

```Java
CtEntry(ResourceWrapper resourceWrapper, ProcessorSlot<Object> chain, Context context) {
    super(resourceWrapper);
    this.chain = chain;
    this.context = context;
    // è·å–ã€Œä¸Šä¸‹æ–‡ã€ä¸­ä¸Šä¸€æ¬¡çš„å…¥å£
    parent = context.getCurEntry();
    if (parent != null) {
        // ç„¶åå°†å½“å‰å…¥å£è®¾ç½®ä¸ºä¸Šä¸€æ¬¡å…¥å£çš„å­èŠ‚ç‚¹
        ((CtEntry)parent).child = this;
    }
    // è®¾ç½®ã€Œä¸Šä¸‹æ–‡ã€çš„å½“å‰å…¥å£ä¸ºè¯¥ç±»æœ¬èº«
    context.setCurEntry(this);
}
```

è¿™é‡Œå¯èƒ½çœ‹ä»£ç æ²¡æœ‰é‚£ä¹ˆç›´è§‚ï¼Œå¯ä»¥ç”¨ä¸€äº›å›¾å½¢æ¥æè¿°ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚

### æ„é€ æ ‘å¹²

#### åˆ›å»ºcontext

contextçš„åˆ›å»ºåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ï¼Œcontextä¸­çš„curEntryå±æ€§æ˜¯æ²¡æœ‰å€¼çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-4943f374d82ee496.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

create-context.png

#### åˆ›å»ºEntry

æ¯åˆ›å»ºä¸€ä¸ªæ–°çš„Entryå¯¹è±¡æ—¶ï¼Œéƒ½ä¼šé‡æ–°è®¾ç½®contextçš„curEntryï¼Œå¹¶å°†contextåŸæ¥çš„curEntryè®¾ç½®ä¸ºè¯¥æ–°Entryå¯¹è±¡çš„çˆ¶èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-1e729b974994d264.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

new-entry.png

#### é€€å‡ºEntry

æŸä¸ªEntryé€€å‡ºæ—¶ï¼Œå°†ä¼šé‡æ–°è®¾ç½®contextçš„curEntryï¼Œå½“è¯¥Entryæ˜¯æœ€é¡¶å±‚çš„ä¸€ä¸ªå…¥å£æ—¶ï¼Œå°†ä¼šæŠŠThreadLocalä¸­ä¿å­˜çš„contextä¹Ÿæ¸…é™¤æ‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-ad797145c0055ba4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

entry-exit.png

### æ„é€ å¶å­èŠ‚ç‚¹

ä¸Šé¢çš„è¿‡ç¨‹æ˜¯æ„é€ äº†ä¸€æ£µè°ƒç”¨é“¾çš„æ ‘ï¼Œä½†æ˜¯è¿™æ£µæ ‘åªæœ‰æ ‘å¹²ï¼Œæ²¡æœ‰å¶å­ï¼Œé‚£å¶å­èŠ‚ç‚¹æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼ŸDefaultNodeå°±æ˜¯å¶å­èŠ‚ç‚¹ï¼Œåœ¨å¶å­èŠ‚ç‚¹ä¸­ä¿å­˜ç€ç›®æ ‡èµ„æºåœ¨å½“å‰çŠ¶æ€ä¸‹çš„ç»Ÿè®¡ä¿¡æ¯ã€‚é€šè¿‡åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº†å¶å­èŠ‚ç‚¹æ˜¯åœ¨NodeSelectorSlotçš„entryæ–¹æ³•ä¸­åˆ›å»ºçš„ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, Object obj, int count, Object... args) throws Throwable {
    // æ ¹æ®ã€Œä¸Šä¸‹æ–‡ã€çš„åç§°è·å–DefaultNode
    // å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªcontextï¼Œ
    // åªè¦èµ„æºåç›¸åŒï¼Œåˆ™contextçš„åç§°ä¹Ÿç›¸åŒï¼Œé‚£ä¹ˆè·å–åˆ°çš„èŠ‚ç‚¹å°±ç›¸åŒ
    DefaultNode node = map.get(context.getName());
    if (node == null) {
        synchronized (this) {
            node = map.get(context.getName());
            if (node == null) {
                // å¦‚æœå½“å‰ã€Œä¸Šä¸‹æ–‡ã€ä¸­æ²¡æœ‰è¯¥èŠ‚ç‚¹ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªDefaultNodeèŠ‚ç‚¹
                node = Env.nodeBuilder.buildTreeNode(resourceWrapper, null);
                // çœç•¥éƒ¨åˆ†ä»£ç 
            }
            // å°†å½“å‰nodeä½œä¸ºã€Œä¸Šä¸‹æ–‡ã€çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ·»åŠ è¿›å»
            // å¦‚æœcontextçš„curEntry.parent.curNodeä¸ºnullï¼Œåˆ™æ·»åŠ åˆ°entranceNodeä¸­å»
            // å¦åˆ™æ·»åŠ åˆ°contextçš„curEntry.parent.curNodeä¸­å»
            ((DefaultNode)context.getLastNode()).addChild(node);
        }
    }
    // å°†è¯¥èŠ‚ç‚¹è®¾ç½®ä¸ºã€Œä¸Šä¸‹æ–‡ã€ä¸­çš„å½“å‰èŠ‚ç‚¹
    // å®é™…æ˜¯å°†å½“å‰èŠ‚ç‚¹èµ‹å€¼ç»™contextä¸­curEntryçš„curNode
    // åœ¨Contextçš„getLastNodeä¸­ä¼šç”¨åˆ°åœ¨æ­¤å¤„è®¾ç½®çš„curNode
    context.setCurNode(node);
    fireEntry(context, resourceWrapper, node, count, args);
}
```

ä¸Šé¢çš„ä»£ç å¯ä»¥åˆ†è§£æˆä¸‹é¢è¿™äº›æ­¥éª¤ï¼š
 1ï¼‰è·å–å½“å‰ä¸Šä¸‹æ–‡å¯¹åº”çš„DefaultNodeï¼Œå¦‚æœæ²¡æœ‰çš„è¯ä¼šä¸ºå½“å‰çš„è°ƒç”¨æ–°ç”Ÿæˆä¸€ä¸ªDefaultNodeèŠ‚ç‚¹ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯¹èµ„æºè¿›è¡Œå„ç§ç»Ÿè®¡åº¦é‡ä»¥ä¾¿è¿›è¡Œæµæ§ï¼›
 2ï¼‰å°†æ–°åˆ›å»ºçš„DefaultNodeèŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°contextä¸­ï¼Œä½œä¸ºã€ŒentranceNodeã€æˆ–è€…ã€ŒcurEntry.parent.curNodeã€çš„å­èŠ‚ç‚¹ï¼›
 3ï¼‰å°†DefaultNodeèŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°contextä¸­ï¼Œä½œä¸ºã€ŒcurEntryã€çš„curNodeã€‚

ä¸Šé¢çš„ç¬¬2æ­¥ï¼Œä¸æ˜¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œã€‚æˆ‘ä»¬å…ˆçœ‹ç¬¬3æ­¥ï¼ŒæŠŠå½“å‰DefaultNodeè®¾ç½®ä¸ºcontextçš„curNodeï¼Œå®é™…ä¸Šæ˜¯æŠŠå½“å‰èŠ‚ç‚¹èµ‹å€¼ç»™contextä¸­curEntryçš„curNodeï¼Œç”¨å›¾å½¢è¡¨ç¤ºå°±æ˜¯è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-5aea0025fe6686a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

create-default-node.png

å¤šæ¬¡åˆ›å»ºä¸åŒçš„Entryï¼Œå¹¶ä¸”æ‰§è¡ŒNodeSelectorSlotçš„entryæ–¹æ³•åï¼Œå°±ä¼šå˜æˆè¿™æ ·ä¸€æ£µè°ƒç”¨é“¾æ ‘ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-e1cede566b38770d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

create-multi-default-node.png

**PSï¼šè¿™é‡Œå›¾ä¸­çš„node0ï¼Œnode1ï¼Œnode2å¯èƒ½æ˜¯ç›¸åŒçš„nodeï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªcontextä¸­ä»mapä¸­è·å–çš„nodeæ˜¯åŒä¸€ä¸ªï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†è¡¨è¿°çš„æ›´æ¸…æ¥šæ‰€ä»¥ç”¨äº†ä¸åŒçš„èŠ‚ç‚¹åã€‚**

#### ä¿å­˜å­èŠ‚ç‚¹

ä¸Šé¢å·²ç»åˆ†æäº†å¶å­èŠ‚ç‚¹çš„æ„é€ è¿‡ç¨‹ï¼Œå¶å­èŠ‚ç‚¹æ˜¯ä¿å­˜åœ¨å„ä¸ªEntryçš„curNodeå±æ€§ä¸­çš„ã€‚

æˆ‘ä»¬çŸ¥é“contextä¸­åªä¿å­˜äº†å…¥å£èŠ‚ç‚¹å’Œå½“å‰Entryï¼Œé‚£å­èŠ‚ç‚¹æ˜¯ä»€ä¹ˆæ—¶å€™ä¿å­˜çš„å‘¢ï¼Œå…¶å®å­èŠ‚ç‚¹å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„ç¬¬2æ­¥ä¸­ä¿å­˜çš„ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸Šé¢çš„ç¬¬2æ­¥çš„æƒ…å†µï¼š

ç¬¬ä¸€æ¬¡è°ƒç”¨NodeSelectorSlotçš„entryæ–¹æ³•æ—¶ï¼Œmapä¸­è‚¯å®šæ˜¯æ²¡æœ‰DefaultNodeçš„ï¼Œé‚£å°±ä¼šè¿›å…¥ç¬¬2æ­¥ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªnodeï¼Œåˆ›å»ºå®Œæˆåä¼šæŠŠè¯¥èŠ‚ç‚¹åŠ å…¥åˆ°contextçš„lastNodeçš„å­èŠ‚ç‚¹ä¸­å»ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹contextçš„getLastNodeæ–¹æ³•ï¼š

```Java
public Node getLastNode() {
    // å¦‚æœcurEntryä¸å­˜åœ¨æ—¶ï¼Œè¿”å›entranceNode
    // å¦åˆ™è¿”å›curEntryçš„lastNodeï¼Œ
    // éœ€è¦æ³¨æ„çš„æ˜¯curEntryçš„lastNodeæ˜¯è·å–çš„parentçš„curNodeï¼Œ
    // å¦‚æœæ¯æ¬¡è¿›å…¥çš„èµ„æºä¸åŒï¼Œå°±ä¼šæ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ªCtEntryï¼Œåˆ™parentä¸ºnullï¼Œ
    // æ‰€ä»¥curEntry.getLastNode()ä¹Ÿä¸ºnull
    if (curEntry != null && curEntry.getLastNode() != null) {
        return curEntry.getLastNode();
    } else {
        return entranceNode;
    }
}
```

ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒlastNodeçš„å€¼å¯èƒ½æ˜¯contextä¸­çš„entranceNodeä¹Ÿå¯èƒ½æ˜¯curEntry.parent.curNodeï¼Œä½†æ˜¯ä»–ä»¬éƒ½æ˜¯ã€ŒDefaultNodeã€ç±»å‹çš„èŠ‚ç‚¹ï¼ŒDefaultNodeçš„æ‰€æœ‰å­èŠ‚ç‚¹æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªHashSetä¸­çš„ã€‚

ç¬¬ä¸€æ¬¡è°ƒç”¨getLastNodeæ–¹æ³•æ—¶ï¼Œcontextä¸­curEntryæ˜¯nullï¼Œå› ä¸ºcurEntryæ˜¯åœ¨ç¬¬3æ­¥ä¸­æ‰èµ‹å€¼çš„ã€‚æ‰€ä»¥ï¼ŒlastNodeæœ€åˆçš„å€¼å°±æ˜¯contextçš„entranceNodeã€‚é‚£ä¹ˆå°†nodeæ·»åŠ åˆ°entranceNodeçš„å­èŠ‚ç‚¹ä¸­å»ä¹‹åå°±å˜æˆäº†ä¸‹é¢è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-95572600f828d66c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

add-child-1.png

ç´§æ¥ç€å†è¿›å…¥ä¸€æ¬¡ï¼Œèµ„æºåä¸åŒï¼Œä¼šå†æ¬¡ç”Ÿæˆä¸€ä¸ªæ–°çš„Entryï¼Œä¸Šé¢çš„å›¾å½¢å°±å˜æˆä¸‹å›¾è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-cac6ff4fa305ea5b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

add-child-2.png

æ­¤æ—¶å†æ¬¡è°ƒç”¨contextçš„getLastNodeæ–¹æ³•ï¼Œå› ä¸ºæ­¤æ—¶curEntryçš„parentä¸å†æ˜¯nulläº†ï¼Œæ‰€ä»¥è·å–åˆ°çš„lastNodeæ˜¯curEntry.parent.curNodeï¼Œåœ¨ä¸Šå›¾ä¸­å¯ä»¥å¾ˆæ–¹ä¾¿çš„çœ‹å‡ºï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯**node0**ã€‚é‚£ä¹ˆæŠŠå½“å‰èŠ‚ç‚¹node1æ·»åŠ åˆ°lastNodeçš„å­èŠ‚ç‚¹ä¸­å»ï¼Œä¸Šé¢çš„å›¾å½¢å°±å˜æˆä¸‹å›¾è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-08190a52fd8c9426.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

add-child-3.png

ç„¶åå°†å½“å‰nodeè®¾ç½®ç»™contextçš„curNodeï¼Œä¸Šé¢çš„å›¾å½¢å°±å˜æˆä¸‹å›¾è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-eebf7e7aeb8fa74c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

add-child-4.png

å‡å¦‚å†åˆ›å»ºä¸€ä¸ªEntryï¼Œç„¶åå†è¿›å…¥ä¸€æ¬¡ä¸åŒçš„èµ„æºåï¼Œä¸Šé¢çš„å›¾å°±å˜æˆä¸‹é¢è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-6720d932110a4366.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

add-child-5.png

è‡³æ­¤NodeSelectorSlotçš„åŸºæœ¬åŠŸèƒ½å·²ç»å¤§è‡´åˆ†ææ¸…æ¥šäº†ã€‚

**PSï¼šä»¥ä¸Šçš„åˆ†ææ˜¯åŸºäºæ¯æ¬¡æ‰§è¡ŒSphU.entry(name)æ—¶ï¼Œèµ„æºåéƒ½æ˜¯ä¸ä¸€æ ·çš„å‰æä¸‹ã€‚å¦‚æœèµ„æºåéƒ½ä¸€æ ·çš„è¯ï¼Œé‚£ä¹ˆç”Ÿæˆçš„nodeéƒ½ç›¸åŒï¼Œåˆ™åªä¼šå†ç¬¬ä¸€æ¬¡æŠŠnodeåŠ å…¥åˆ°entranceNodeçš„å­èŠ‚ç‚¹ä¸­å»ï¼Œå…¶ä»–çš„æ—¶å€™ï¼Œåªä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Entryï¼Œç„¶åæ›¿æ¢contextä¸­çš„curEntryçš„å€¼ã€‚**

# ClusterBuilderSlot

NodeSelectorSlotçš„entryæ–¹æ³•æ‰§è¡Œå®Œä¹‹åï¼Œä¼šè°ƒç”¨fireEntryæ–¹æ³•ï¼Œæ­¤æ—¶ä¼šè§¦å‘ClusterBuilderSlotçš„entryæ–¹æ³•ã€‚

ClusterBuilderSlotçš„entryæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {
    if (clusterNode == null) {
        synchronized (lock) {
            if (clusterNode == null) {
                // Create the cluster node.
                clusterNode = Env.nodeBuilder.buildClusterNode();
                // å°†clusterNodeä¿å­˜åˆ°å…¨å±€çš„mapä¸­å»
                HashMap<ResourceWrapper, ClusterNode> newMap = new HashMap<ResourceWrapper, ClusterNode>(16);
                newMap.putAll(clusterNodeMap);
                newMap.put(node.getId(), clusterNode);

                clusterNodeMap = newMap;
            }
        }
    }
    // å°†clusterNodeå¡åˆ°DefaultNodeä¸­å»
    node.setClusterNode(clusterNode);

    // çœç•¥éƒ¨åˆ†ä»£ç 

    fireEntry(context, resourceWrapper, node, count, args);
}
```

NodeSelectorSlotçš„èŒè´£æ¯”è¾ƒç®€å•ï¼Œä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š

ä¸€ã€ä¸ºæ¯ä¸ªèµ„æºåˆ›å»ºä¸€ä¸ªclusterNodeï¼Œç„¶åæŠŠclusterNodeå¡åˆ°DefaultNodeä¸­å»

äºŒã€å°†clusterNodeä¿æŒåˆ°å…¨å±€çš„mapä¸­å»ï¼Œç”¨èµ„æºä½œä¸ºmapçš„key

**PSï¼šä¸€ä¸ªèµ„æºåªæœ‰ä¸€ä¸ªClusterNodeï¼Œä½†æ˜¯å¯ä»¥æœ‰å¤šä¸ªDefaultNode**

# StatistcSlot

StatisticSlotè´Ÿè´£æ¥ç»Ÿè®¡èµ„æºçš„å®æ—¶çŠ¶æ€ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {
    try {
        // è§¦å‘ä¸‹ä¸€ä¸ªSlotçš„entryæ–¹æ³•
        fireEntry(context, resourceWrapper, node, count, args);
        // å¦‚æœèƒ½é€šè¿‡SlotChainä¸­åé¢çš„Slotçš„entryæ–¹æ³•ï¼Œè¯´æ˜æ²¡æœ‰è¢«é™æµæˆ–é™çº§
        // ç»Ÿè®¡ä¿¡æ¯
        node.increaseThreadNum();
        node.addPassRequest();
        // çœç•¥éƒ¨åˆ†ä»£ç 
    } catch (BlockException e) {
        context.getCurEntry().setError(e);
        // Add block count.
        node.increaseBlockedQps();
        // çœç•¥éƒ¨åˆ†ä»£ç 
        throw e;
    } catch (Throwable e) {
        context.getCurEntry().setError(e);
        // Should not happen
        node.increaseExceptionQps();
        // çœç•¥éƒ¨åˆ†ä»£ç 
        throw e;
    }
}

@Override
public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {
    DefaultNode node = (DefaultNode)context.getCurNode();
    if (context.getCurEntry().getError() == null) {
        long rt = TimeUtil.currentTimeMillis() - context.getCurEntry().getCreateTime();
        if (rt > Constants.TIME_DROP_VALVE) {
            rt = Constants.TIME_DROP_VALVE;
        }
        node.rt(rt);
        // çœç•¥éƒ¨åˆ†ä»£ç 
        node.decreaseThreadNum();
        // çœç•¥éƒ¨åˆ†ä»£ç 
    }
    fireExit(context, resourceWrapper, count);
}
```

ä»£ç åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯entryæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šè§¦å‘åç»­slotçš„entryæ–¹æ³•ï¼Œå³SystemSlotã€FlowSlotã€DegradeSlotç­‰çš„è§„åˆ™ï¼Œå¦‚æœè§„åˆ™ä¸é€šè¿‡ï¼Œå°±ä¼šæŠ›å‡ºBlockExceptionï¼Œåˆ™ä¼šåœ¨nodeä¸­ç»Ÿè®¡è¢«blockçš„æ•°é‡ã€‚åä¹‹ä¼šåœ¨nodeä¸­ç»Ÿè®¡é€šè¿‡çš„è¯·æ±‚æ•°å’Œçº¿ç¨‹æ•°ç­‰ä¿¡æ¯ã€‚ç¬¬äºŒéƒ¨åˆ†æ˜¯åœ¨exitæ–¹æ³•ä¸­ï¼Œå½“é€€å‡ºè¯¥Entryå…¥å£æ—¶ï¼Œä¼šç»Ÿè®¡rtçš„æ—¶é—´ï¼Œå¹¶å‡å°‘çº¿ç¨‹æ•°ã€‚

è¿™äº›ç»Ÿè®¡çš„å®æ—¶æ•°æ®ä¼šè¢«åç»­çš„æ ¡éªŒè§„åˆ™æ‰€ä½¿ç”¨ï¼Œå…·ä½“çš„ç»Ÿè®¡æ–¹å¼æ˜¯é€šè¿‡ `æ»‘åŠ¨çª—å£` æ¥å®ç°çš„ã€‚åé¢æˆ‘ä¼šè¯¦ç»†åˆ†ææ»‘åŠ¨çª—å£çš„åŸç†ã€‚

# SystemSlot

SystemSlotå°±æ˜¯æ ¹æ®æ€»çš„è¯·æ±‚ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¥åšæµæ§ï¼Œä¸»è¦æ˜¯é˜²æ­¢ç³»ç»Ÿè¢«æå®ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args)
    throws Throwable {
    SystemRuleManager.checkSystem(resourceWrapper);
    fireEntry(context, resourceWrapper, node, count, args);
}

public static void checkSystem(ResourceWrapper resourceWrapper) throws BlockException {
    // çœç•¥éƒ¨åˆ†ä»£ç 
    // total qps
    double currentQps = Constants.ENTRY_NODE.successQps();
    if (currentQps > qps) {
        throw new SystemBlockException(resourceWrapper.getName(), "qps");
    }
    // total thread
    int currentThread = Constants.ENTRY_NODE.curThreadNum();
    if (currentThread > maxThread) {
        throw new SystemBlockException(resourceWrapper.getName(), "thread");
    }
    double rt = Constants.ENTRY_NODE.avgRt();
    if (rt > maxRt) {
        throw new SystemBlockException(resourceWrapper.getName(), "rt");
    }
    // å®Œå…¨æŒ‰ç…§RT,BBRç®—æ³•æ¥
    if (highestSystemLoadIsSet && getCurrentSystemAvgLoad() > highestSystemLoad) {
        if (currentThread > 1 &&
            currentThread > Constants.ENTRY_NODE.maxSuccessQps() * Constants.ENTRY_NODE.minRt() / 1000) {
            throw new SystemBlockException(resourceWrapper.getName(), "load");
        }
    }
}
```

å…¶ä¸­çš„Constants.ENTRY_NODEæ˜¯ä¸€ä¸ªå…¨å±€çš„ClusterNodeï¼Œè¯¥èŠ‚ç‚¹çš„å€¼æ˜¯åœ¨StatisticsSlotä¸­è¿›è¡Œç»Ÿè®¡çš„ã€‚

# AuthoritySlot

AuthoritySlotåšçš„äº‹ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯æ ¹æ®é»‘ç™½åå•è¿›è¡Œè¿‡æ»¤ï¼Œåªè¦æœ‰ä¸€æ¡è§„åˆ™æ ¡éªŒä¸é€šè¿‡ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ã€‚

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {
    AuthorityRuleManager.checkAuthority(resourceWrapper, context, node, count);
    fireEntry(context, resourceWrapper, node, count, args);
}

public static void checkAuthority(ResourceWrapper resource, Context context, DefaultNode node, int count) throws BlockException {
    if (authorityRules == null) {
        return;
    }
    // æ ¹æ®èµ„æºåç§°è·å–ç›¸åº”çš„è§„åˆ™
    List<AuthorityRule> rules = authorityRules.get(resource.getName());
    if (rules == null) {
        return;
    }
    for (AuthorityRule rule : rules) {
        // åªè¦æœ‰ä¸€æ¡è§„åˆ™æ ¡éªŒä¸é€šè¿‡ï¼Œå°±æŠ›å‡ºAuthorityException
        if (!rule.passCheck(context, node, count)) {
            throw new AuthorityException(context.getOrigin());
        }
    }
}
```

# FlowSlot

FlowSlotä¸»è¦æ˜¯æ ¹æ®å‰é¢ç»Ÿè®¡å¥½çš„ä¿¡æ¯ï¼Œä¸è®¾ç½®çš„é™æµè§„åˆ™è¿›è¡ŒåŒ¹é…æ ¡éªŒï¼Œå¦‚æœè§„åˆ™æ ¡éªŒä¸é€šè¿‡åˆ™è¿›è¡Œé™æµï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {
    FlowRuleManager.checkFlow(resourceWrapper, context, node, count);
    fireEntry(context, resourceWrapper, node, count, args);
}

public static void checkFlow(ResourceWrapper resource, Context context, DefaultNode node, int count) throws BlockException {
    List<FlowRule> rules = flowRules.get(resource.getName());
    if (rules != null) {
        for (FlowRule rule : rules) {
            if (!rule.passCheck(context, node, count)) {
                throw new FlowException(rule.getLimitApp());
            }
        }
    }
}
```

# DegradeSlot

DegradeSlotä¸»è¦æ˜¯æ ¹æ®å‰é¢ç»Ÿè®¡å¥½çš„ä¿¡æ¯ï¼Œä¸è®¾ç½®çš„é™çº§è§„åˆ™è¿›è¡ŒåŒ¹é…æ ¡éªŒï¼Œå¦‚æœè§„åˆ™æ ¡éªŒä¸é€šè¿‡åˆ™è¿›è¡Œé™çº§ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {
    DegradeRuleManager.checkDegrade(resourceWrapper, context, node, count);
    fireEntry(context, resourceWrapper, node, count, args);
}

public static void checkDegrade(ResourceWrapper resource, Context context, DefaultNode node, int count) throws BlockException {
    List<DegradeRule> rules = degradeRules.get(resource.getName());
    if (rules != null) {
        for (DegradeRule rule : rules) {
            if (!rule.passCheck(context, node, count)) {
                throw new DegradeException(rule.getLimitApp());
            }
        }
    }
}
```

# æ€»ç»“

sentinelçš„é™æµé™çº§ç­‰åŠŸèƒ½ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªSlotChainå®ç°çš„ã€‚åœ¨é“¾å¼æ’æ§½ä¸­ï¼Œæœ‰7ä¸ªæ ¸å¿ƒçš„Slotï¼Œè¿™äº›Slotå„å¸å…¶èŒï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

ä¸€ã€è¿›è¡Œèµ„æºè°ƒç”¨è·¯å¾„æ„é€ çš„NodeSelectorSlotå’ŒClusterBuilderSlot

äºŒã€è¿›è¡Œèµ„æºçš„å®æ—¶çŠ¶æ€ç»Ÿè®¡çš„StatisticsSlot

ä¸‰ã€è¿›è¡Œç³»ç»Ÿä¿æŠ¤ï¼Œé™æµï¼Œé™çº§ç­‰è§„åˆ™æ ¡éªŒçš„SystemSlotã€AuthoritySlotã€FlowSlotã€DegradeSlot

åé¢å‡ ä¸ªSlotä¾èµ–äºå‰é¢å‡ ä¸ªSlotç»Ÿè®¡çš„ç»“æœã€‚è‡³æ­¤ï¼Œæ¯ç§Slotçš„åŠŸèƒ½å·²ç»åŸºæœ¬åˆ†ææ¸…æ¥šäº†ã€‚
