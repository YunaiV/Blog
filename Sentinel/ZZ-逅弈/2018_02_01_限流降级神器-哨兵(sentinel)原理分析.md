title: é™æµé™çº§ç¥å™¨-å“¨å…µ(sentinel)åŸç†åˆ†æ
date: 2018-02-01
tags:
categories: Sentinel
permalink: Sentinel/houyi/Analysis-of-the-principle-of-the-sentinel
author:  é€…å¼ˆ
from_url: https://www.jianshu.com/p/0e218ef7f505
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/0e218ef7f505 ã€Œé€…å¼ˆã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [é¡¹ç›®ç»“æ„](http://www.iocoder.cn/Sentinel//)
- [è¿è¡Œæ ·ä¾‹](http://www.iocoder.cn/Sentinel//)
- [æ·±å…¥åŸç†](http://www.iocoder.cn/Sentinel//)
  - [åˆ›å»ºSlotChain](http://www.iocoder.cn/Sentinel//)
  - [æ‰§è¡ŒSlotChainçš„entryæ–¹æ³•](http://www.iocoder.cn/Sentinel//)
  - [æ‰§è¡ŒSlotçš„entryæ–¹æ³•](http://www.iocoder.cn/Sentinel//)
- [Dashboardæ§åˆ¶å°](http://www.iocoder.cn/Sentinel//)
  - [1 å¯åŠ¨æ§åˆ¶å°](http://www.iocoder.cn/Sentinel//)
  - [2 å®¢æˆ·ç«¯æ¥å…¥æ§åˆ¶å°](http://www.iocoder.cn/Sentinel//)
  - [dashboard](http://www.iocoder.cn/Sentinel//)
  - [client](http://www.iocoder.cn/Sentinel//)
- [ä¸»æµæ¡†æ¶çš„é€‚é…](http://www.iocoder.cn/Sentinel//)
- [è§„åˆ™æŒä¹…åŒ–ï¼ŒåŠ¨æ€åŒ–](http://www.iocoder.cn/Sentinel//)
  - [DataSource æ‰©å±•](http://www.iocoder.cn/Sentinel//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

[Sentinel](https://github.com/alibaba/Sentinel) æ˜¯é˜¿é‡Œä¸­é—´ä»¶å›¢é˜Ÿå¼€æºçš„ï¼Œé¢å‘åˆ†å¸ƒå¼æœåŠ¡æ¶æ„çš„è½»é‡çº§é«˜å¯ç”¨æµé‡æ§åˆ¶ç»„ä»¶ï¼Œä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥å¸®åŠ©ç”¨æˆ·ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚

å¤§å®¶å¯èƒ½ä¼šé—®ï¼šSentinel å’Œä¹‹å‰å¸¸ç”¨çš„ç†”æ–­é™çº§åº“ [Netflix Hystrix](https://github.com/netflix/hystrix) æœ‰ä»€ä¹ˆå¼‚åŒå‘¢ï¼ŸSentinelå®˜ç½‘æœ‰ä¸€ä¸ªå¯¹æ¯”çš„æ–‡ç« ï¼Œè¿™é‡Œæ‘˜æŠ„ä¸€ä¸ªæ€»ç»“çš„è¡¨æ ¼ï¼Œå…·ä½“çš„å¯¹æ¯”å¯ä»¥ç‚¹æ­¤ [é“¾æ¥](https://github.com/alibaba/Sentinel/wiki/Sentinel-%E4%B8%8E-Hystrix-%E7%9A%84%E5%AF%B9%E6%AF%94) æŸ¥çœ‹ã€‚

| å¯¹æ¯”å†…å®¹       | Sentinel                                       | Hystrix                       |
| -------------- | ---------------------------------------------- | ----------------------------- |
| éš”ç¦»ç­–ç•¥       | ä¿¡å·é‡éš”ç¦»                                     | çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦»         |
| ç†”æ–­é™çº§ç­–ç•¥   | åŸºäºå“åº”æ—¶é—´æˆ–å¤±è´¥æ¯”ç‡                         | åŸºäºå¤±è´¥æ¯”ç‡                  |
| å®æ—¶æŒ‡æ ‡å®ç°   | æ»‘åŠ¨çª—å£                                       | æ»‘åŠ¨çª—å£ï¼ˆåŸºäº RxJavaï¼‰       |
| è§„åˆ™é…ç½®       | æ”¯æŒå¤šç§æ•°æ®æº                                 | æ”¯æŒå¤šç§æ•°æ®æº                |
| æ‰©å±•æ€§         | å¤šä¸ªæ‰©å±•ç‚¹                                     | æ’ä»¶çš„å½¢å¼                    |
| åŸºäºæ³¨è§£çš„æ”¯æŒ | æ”¯æŒ                                           | æ”¯æŒ                          |
| é™æµ           | åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ               | ä¸æ”¯æŒ                        |
| æµé‡æ•´å½¢       | æ”¯æŒæ…¢å¯åŠ¨ã€åŒ€é€Ÿå™¨æ¨¡å¼                         | ä¸æ”¯æŒ                        |
| ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤   | æ”¯æŒ                                           | ä¸æ”¯æŒ                        |
| æ§åˆ¶å°         | å¼€ç®±å³ç”¨ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰ | ä¸å®Œå–„                        |
| å¸¸è§æ¡†æ¶çš„é€‚é… | Servletã€Spring Cloudã€Dubboã€gRPC ç­‰          | Servletã€Spring Cloud Netflix |

ä»å¯¹æ¯”çš„è¡¨æ ¼å¯ä»¥çœ‹åˆ°ï¼ŒSentinelæ¯”Hystrixåœ¨åŠŸèƒ½æ€§ä¸Šè¿˜è¦å¼ºå¤§ä¸€äº›ï¼Œæœ¬æ–‡è®©æˆ‘ä»¬ä¸€èµ·æ¥äº†è§£ä¸‹Sentinelçš„æºç ï¼Œæ­å¼€Sentinelçš„ç¥ç§˜é¢çº±ã€‚

# é¡¹ç›®ç»“æ„

å°†Sentinelçš„æºç forkåˆ°è‡ªå·±çš„githubåº“ä¸­ï¼Œæ¥ç€æŠŠæºç cloneåˆ°æœ¬åœ°ï¼Œç„¶åå¼€å§‹æºç é˜…è¯»ä¹‹æ—…å§ã€‚

é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹Sentinelé¡¹ç›®çš„æ•´ä¸ªç»“æ„ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-77475492762e44a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

sentinel-project-structure.png

- sentinel-core æ ¸å¿ƒæ¨¡å—ï¼Œé™æµã€é™çº§ã€ç³»ç»Ÿä¿æŠ¤ç­‰éƒ½åœ¨è¿™é‡Œå®ç°
- sentinel-dashboard æ§åˆ¶å°æ¨¡å—ï¼Œå¯ä»¥å¯¹è¿æ¥ä¸Šçš„sentinelå®¢æˆ·ç«¯å®ç°å¯è§†åŒ–çš„ç®¡ç†
- sentinel-transport ä¼ è¾“æ¨¡å—ï¼Œæä¾›äº†åŸºæœ¬çš„ç›‘æ§æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„APIæ¥å£ï¼Œä»¥åŠä¸€äº›åŸºäºä¸åŒåº“çš„å®ç°
- sentinel-extension æ‰©å±•æ¨¡å—ï¼Œä¸»è¦å¯¹DataSourceè¿›è¡Œäº†éƒ¨åˆ†æ‰©å±•å®ç°
- sentinel-adapter é€‚é…å™¨æ¨¡å—ï¼Œä¸»è¦å®ç°äº†å¯¹ä¸€äº›å¸¸è§æ¡†æ¶çš„é€‚é…
- sentinel-demo æ ·ä¾‹æ¨¡å—ï¼Œå¯å‚è€ƒæ€ä¹ˆä½¿ç”¨sentinelè¿›è¡Œé™æµã€é™çº§ç­‰
- sentinel-benchmark åŸºå‡†æµ‹è¯•æ¨¡å—ï¼Œå¯¹æ ¸å¿ƒä»£ç çš„ç²¾ç¡®æ€§æä¾›åŸºå‡†æµ‹è¯•

# è¿è¡Œæ ·ä¾‹

åŸºæœ¬ä¸Šæ¯ä¸ªæ¡†æ¶éƒ½ä¼šå¸¦æœ‰æ ·ä¾‹æ¨¡å—ï¼Œæœ‰çš„å«exampleï¼Œæœ‰çš„å«demoï¼Œsentinelä¹Ÿä¸ä¾‹å¤–ã€‚

é‚£æˆ‘ä»¬ä»sentinelçš„demoä¸­æ‰¾ä¸€ä¸ªä¾‹å­è¿è¡Œä¸‹çœ‹çœ‹å¤§è‡´çš„æƒ…å†µå§ï¼Œä¸Šé¢è¯´è¿‡äº†sentinelä¸»è¦çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯åšé™æµã€é™çº§å’Œç³»ç»Ÿä¿æŠ¤ï¼Œé‚£æˆ‘ä»¬å°±ä»â€œé™æµâ€å¼€å§‹çœ‹sentinelçš„å®ç°åŸç†å§ã€‚



![img](https:////upload-images.jianshu.io/upload_images/5417792-872e83e2349f9760.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

sentinel-basic-demo-flow-qps.png

å¯ä»¥çœ‹åˆ°sentinel-demoæ¨¡å—ä¸­æœ‰å¾ˆå¤šä¸åŒçš„æ ·ä¾‹ï¼Œæˆ‘ä»¬æ‰¾åˆ°basicæ¨¡å—ä¸‹çš„flowåŒ…ï¼Œè¿™ä¸ªåŒ…ä¸‹é¢å°±æ˜¯å¯¹åº”çš„é™æµçš„æ ·ä¾‹ï¼Œä½†æ˜¯é™æµä¹Ÿæœ‰å¾ˆå¤šç§ç±»å‹çš„é™æµï¼Œæˆ‘ä»¬å°±æ‰¾æ ¹æ®qpsé™æµçš„ç±»çœ‹å§ï¼Œå…¶ä»–çš„é™æµæ–¹å¼åŸç†ä¸Šéƒ½å¤§å·®ä¸å·®ã€‚

```java
public class FlowQpsDemo {

    private static final String KEY = "abc";

    private static AtomicInteger pass = new AtomicInteger();
    private static AtomicInteger block = new AtomicInteger();
    private static AtomicInteger total = new AtomicInteger();

    private static volatile boolean stop = false;

    private static final int threadCount = 32;

    private static int seconds = 30;

    public static void main(String[] args) throws Exception {
        initFlowQpsRule();

        tick();
        // first make the system run on a very low condition
        simulateTraffic();

        System.out.println("===== begin to do flow control");
        System.out.println("only 20 requests per second can pass");

    }

    private static void initFlowQpsRule() {
        List<FlowRule> rules = new ArrayList<FlowRule>();
        FlowRule rule1 = new FlowRule();
        rule1.setResource(KEY);
        // set limit qps to 20
        rule1.setCount(20);
        // è®¾ç½®é™æµç±»å‹ï¼šæ ¹æ®qps
        rule1.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule1.setLimitApp("default");
        rules.add(rule1);
        // åŠ è½½é™æµçš„è§„åˆ™
        FlowRuleManager.loadRules(rules);
    }

    private static void simulateTraffic() {
        for (int i = 0; i < threadCount; i++) {
            Thread t = new Thread(new RunTask());
            t.setName("simulate-traffic-Task");
            t.start();
        }
    }

    private static void tick() {
        Thread timer = new Thread(new TimerTask());
        timer.setName("sentinel-timer-task");
        timer.start();
    }

    static class TimerTask implements Runnable {

        @Override
        public void run() {
            long start = System.currentTimeMillis();
            System.out.println("begin to statistic!!!");

            long oldTotal = 0;
            long oldPass = 0;
            long oldBlock = 0;
            while (!stop) {
                try {
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                }
                long globalTotal = total.get();
                long oneSecondTotal = globalTotal - oldTotal;
                oldTotal = globalTotal;

                long globalPass = pass.get();
                long oneSecondPass = globalPass - oldPass;
                oldPass = globalPass;

                long globalBlock = block.get();
                long oneSecondBlock = globalBlock - oldBlock;
                oldBlock = globalBlock;

                System.out.println(seconds + " send qps is: " + oneSecondTotal);
                System.out.println(TimeUtil.currentTimeMillis() + ", total:" + oneSecondTotal
                    + ", pass:" + oneSecondPass
                    + ", block:" + oneSecondBlock);

                if (seconds-- <= 0) {
                    stop = true;
                }
            }

            long cost = System.currentTimeMillis() - start;
            System.out.println("time cost: " + cost + " ms");
            System.out.println("total:" + total.get() + ", pass:" + pass.get()
                + ", block:" + block.get());
            System.exit(0);
        }
    }

    static class RunTask implements Runnable {
        @Override
        public void run() {
            while (!stop) {
                Entry entry = null;

                try {
                    entry = SphU.entry(KEY);
                    // token acquired, means pass
                    pass.addAndGet(1);
                } catch (BlockException e1) {
                    block.incrementAndGet();
                } catch (Exception e2) {
                    // biz exception
                } finally {
                    total.incrementAndGet();
                    if (entry != null) {
                        entry.exit();
                    }
                }

                Random random2 = new Random();
                try {
                    TimeUnit.MILLISECONDS.sleep(random2.nextInt(50));
                } catch (InterruptedException e) {
                    // ignore
                }
            }
        }
    }
}
```

æ‰§è¡Œä¸Šé¢çš„ä»£ç åï¼Œæ‰“å°å‡ºå¦‚ä¸‹çš„ç»“æœï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-c0052cc8af41eab2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/692/format/jpeg)

sentinel-basic-demo-flow-qps-result.png

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„ç»“æœä¸­ï¼Œpassçš„æ•°é‡å’Œæˆ‘ä»¬çš„é¢„æœŸå¹¶ä¸ç›¸åŒï¼Œæˆ‘ä»¬é¢„æœŸçš„æ˜¯æ¯ç§’å…è®¸passçš„è¯·æ±‚æ•°æ˜¯20ä¸ªï¼Œä½†æ˜¯ç›®å‰æœ‰å¾ˆå¤špassçš„è¯·æ±‚æ•°æ˜¯è¶…è¿‡20ä¸ªçš„ã€‚

åŸå› æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œæµ‹è¯•çš„ä»£ç ä½¿ç”¨äº†å¤šçº¿ç¨‹ï¼Œæ³¨æ„çœ‹ `threadCount` çš„å€¼ï¼Œä¸€å…±æœ‰32ä¸ªçº¿ç¨‹æ¥æ¨¡æ‹Ÿï¼Œ**è€Œåœ¨RunTaskçš„runæ–¹æ³•ä¸­æ‰§è¡Œèµ„æºä¿æŠ¤æ—¶ï¼Œå³åœ¨ SphU.entry çš„å†…éƒ¨æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œæ‰€ä»¥å°±ä¼šå¯¼è‡´åœ¨é«˜å¹¶å‘ä¸‹ï¼Œpassçš„æ•°é‡ä¼šé«˜äº20ã€‚**

å¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªæ¨¡å‹æ¥æè¿°ä¸‹ï¼Œæœ‰ä¸€ä¸ªTimeTickerçº¿ç¨‹åœ¨åšç»Ÿè®¡ï¼Œæ¯1ç§’é’Ÿåšä¸€æ¬¡ã€‚æœ‰Nä¸ªRunTaskçº¿ç¨‹åœ¨æ¨¡æ‹Ÿè¯·æ±‚ï¼Œè¢«è®¿é—®çš„business codeè¢«èµ„æºkeyä¿æŠ¤ç€ï¼Œæ ¹æ®è§„åˆ™ï¼Œæ¯ç§’åªå…è®¸20ä¸ªè¯·æ±‚é€šè¿‡ã€‚

ç”±äºpassã€blockã€totalç­‰è®¡æ•°å™¨æ˜¯å…¨å±€å…±äº«çš„ï¼Œè€Œå¤šä¸ªRunTaskçº¿ç¨‹åœ¨æ‰§è¡ŒSphU.entryç”³è¯·è·å–entryæ—¶ï¼Œå†…éƒ¨æ²¡æœ‰é”ä¿æŠ¤ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨passçš„ä¸ªæ•°è¶…è¿‡è®¾å®šçš„é˜ˆå€¼ã€‚



![img](https:////upload-images.jianshu.io/upload_images/5417792-ab5bf8449341da82.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

sentinel-basic-demo-flow-qps-module.png

é‚£ä¸ºäº†è¯æ˜åœ¨å•çº¿ç¨‹ä¸‹é™æµçš„æ­£ç¡®æ€§ä¸å¯é æ€§ï¼Œé‚£æˆ‘ä»¬çš„æ¨¡å‹å°±åº”è¯¥å˜æˆäº†è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-e25db20bbfca0e0d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

sentinel-basic-demo-flow-qps-single-thread-module.png

é‚£æ¥ä¸‹æ¥æˆ‘æŠŠ `threadCount` çš„å€¼æ”¹ä¸º1ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸‹å…·ä½“çš„é™æµç»“æœï¼Œæ‰§è¡Œä¸Šé¢çš„ä»£ç åæ‰“å°çš„ç»“æœå¦‚ä¸‹ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-1961c5b551bfdd51.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/678/format/jpeg)

sentinel-basic-demo-single-thread-flow-qps-result.png

å¯ä»¥çœ‹åˆ°passæ•°åŸºæœ¬ä¸Šç»´æŒåœ¨20ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡ç»Ÿè®¡çš„passå€¼è¿˜æ˜¯è¶…è¿‡äº†20ã€‚è¿™åˆæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„å‘¢ï¼Ÿ

å…¶å®ä»”ç»†çœ‹ä¸‹Demoä¸­çš„ä»£ç å¯ä»¥å‘ç°ï¼Œæ¨¡æ‹Ÿè¯·æ±‚æ˜¯ç”¨çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œç»Ÿè®¡ç»“æœæ˜¯ç”¨çš„å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œç»Ÿè®¡çº¿ç¨‹æ¯1ç§’é’Ÿç»Ÿè®¡ä¸€æ¬¡ç»“æœï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´æ˜¯æœ‰æ—¶é—´ä¸Šçš„è¯¯å·®çš„ã€‚ä»TimeTickerçº¿ç¨‹æ‰“å°å‡ºæ¥çš„æ—¶é—´æˆ³å¯ä»¥çœ‹å‡ºæ¥ï¼Œè™½ç„¶æ¯éš”ä¸€ç§’è¿›è¡Œç»Ÿè®¡ï¼Œä½†æ˜¯å½“å‰æ‰“å°æ—¶çš„æ—¶é—´å’Œä¸Šä¸€æ¬¡çš„æ—¶é—´è¿˜æ˜¯æœ‰è¯¯å·®çš„ï¼Œä¸å®Œå…¨æ˜¯1000msçš„é—´éš”ã€‚

è¦çœŸæ­£éªŒè¯æ¯ç§’é™åˆ¶20ä¸ªè¯·æ±‚ï¼Œä¿è¯æ•°æ®çš„ç²¾å‡†æ€§ï¼Œéœ€è¦åšåŸºå‡†æµ‹è¯•ï¼Œè¿™ä¸ªä¸æ˜¯æœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»äº†è§£ä¸‹jmhï¼Œsentinelä¸­çš„åŸºå‡†æµ‹è¯•ä¹Ÿæ˜¯é€šè¿‡jmhåšçš„ã€‚

# æ·±å…¥åŸç†

é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ç¨‹åºï¼Œæˆ‘ä»¬äº†è§£äº†sentinelå¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œé™æµï¼Œé™¤äº†é™æµå¤–ï¼Œè¿˜æœ‰é™çº§å’Œç³»ç»Ÿä¿æŠ¤ç­‰åŠŸèƒ½ã€‚é‚£ç°åœ¨æˆ‘ä»¬å°±æ‹¨å¼€äº‘é›¾ï¼Œæ·±å…¥æºç å†…éƒ¨å»ä¸€çª¥sentinelçš„å®ç°åŸç†å§ã€‚

é¦–å…ˆä»å…¥å£å¼€å§‹ï¼š`SphU.entry()`  ã€‚è¿™ä¸ªæ–¹æ³•ä¼šå»ç”³è¯·ä¸€ä¸ªentryï¼Œå¦‚æœèƒ½å¤Ÿç”³è¯·æˆåŠŸï¼Œåˆ™è¯´æ˜æ²¡æœ‰è¢«é™æµï¼Œå¦åˆ™ä¼šæŠ›å‡ºBlockExceptionï¼Œè¡¨é¢å·²ç»è¢«é™æµäº†ã€‚

ä» `SphU.entry()` æ–¹æ³•å¾€ä¸‹æ‰§è¡Œä¼šè¿›å…¥åˆ° `Sph.entry()` ï¼ŒSphçš„é»˜è®¤å®ç°ç±»æ˜¯ `CtSph` ï¼Œåœ¨CtSphä¸­æœ€ç»ˆä¼šæ‰§è¡Œåˆ° `entry(ResourceWrapper resourceWrapper, int count, Object... args) throws BlockException` è¿™ä¸ªæ–¹æ³•ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š

```Java
public Entry entry(ResourceWrapper resourceWrapper, int count, Object... args) throws BlockException {
    Context context = ContextUtil.getContext();
    if (context instanceof NullContext) {
        // Init the entry only. No rule checking will occur.
        return new CtEntry(resourceWrapper, null, context);
    }

    if (context == null) {
        context = MyContextUtil.myEnter(Constants.CONTEXT_DEFAULT_NAME, "", resourceWrapper.getType());
    }

    // Global switch is close, no rule checking will do.
    if (!Constants.ON) {
        return new CtEntry(resourceWrapper, null, context);
    }

    // è·å–è¯¥èµ„æºå¯¹åº”çš„SlotChain
    ProcessorSlot<Object> chain = lookProcessChain(resourceWrapper);

    /*
     * Means processor cache size exceeds {@link Constants.MAX_SLOT_CHAIN_SIZE}, so no
     * rule checking will be done.
     */
    if (chain == null) {
        return new CtEntry(resourceWrapper, null, context);
    }

    Entry e = new CtEntry(resourceWrapper, chain, context);
    try {
        // æ‰§è¡ŒSlotçš„entryæ–¹æ³•
        chain.entry(context, resourceWrapper, null, count, args);
    } catch (BlockException e1) {
        e.exit(count, args);
        // æŠ›å‡ºBlockExecption
        throw e1;
    } catch (Throwable e1) {
        RecordLog.info("Sentinel unexpected exception", e1);
    }
    return e;
}
```

è¿™ä¸ªæ–¹æ³•å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

- 1.å¯¹å‚æ•°å’Œå…¨å±€é…ç½®é¡¹åšæ£€æµ‹ï¼Œå¦‚æœä¸ç¬¦åˆè¦æ±‚å°±ç›´æ¥è¿”å›äº†ä¸€ä¸ªCtEntryå¯¹è±¡ï¼Œä¸ä¼šå†è¿›è¡Œåé¢çš„é™æµæ£€æµ‹ï¼Œå¦åˆ™è¿›å…¥ä¸‹é¢çš„æ£€æµ‹æµç¨‹ã€‚
- 2.æ ¹æ®åŒ…è£…è¿‡çš„èµ„æºå¯¹è±¡è·å–å¯¹åº”çš„SlotChain
- 3.æ‰§è¡ŒSlotChainçš„entryæ–¹æ³•
  - 3.1.å¦‚æœSlotChainçš„entryæ–¹æ³•æŠ›å‡ºäº†BlockExceptionï¼Œåˆ™å°†è¯¥å¼‚å¸¸ç»§ç»­å‘ä¸ŠæŠ›å‡º
  - 3.2.å¦‚æœSlotChainçš„entryæ–¹æ³•æ­£å¸¸æ‰§è¡Œäº†ï¼Œåˆ™æœ€åä¼šå°†è¯¥entryå¯¹è±¡è¿”å›
- 4.å¦‚æœä¸Šå±‚æ–¹æ³•æ•è·äº†BlockExceptionï¼Œåˆ™è¯´æ˜è¯·æ±‚è¢«é™æµäº†ï¼Œå¦åˆ™è¯·æ±‚èƒ½æ­£å¸¸æ‰§è¡Œ

å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ç¬¬2ã€3ä¸¤ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹è¿™ä¸¤ä¸ªæ­¥éª¤ã€‚

## åˆ›å»ºSlotChain

é¦–å…ˆçœ‹ä¸€ä¸‹lookProcessChainçš„æ–¹æ³•å®ç°ï¼š

```Java
private ProcessorSlot<Object> lookProcessChain(ResourceWrapper resourceWrapper) {
    ProcessorSlotChain chain = chainMap.get(resourceWrapper);
    if (chain == null) {
        synchronized (LOCK) {
            chain = chainMap.get(resourceWrapper);
            if (chain == null) {
                // Entry size limit.
                if (chainMap.size() >= Constants.MAX_SLOT_CHAIN_SIZE) {
                    return null;
                }

                // å…·ä½“æ„é€ chainçš„æ–¹æ³•
                chain = Env.slotsChainbuilder.build();
                Map<ResourceWrapper, ProcessorSlotChain> newMap = new HashMap<ResourceWrapper, ProcessorSlotChain>(chainMap.size() + 1);
                newMap.putAll(chainMap);
                newMap.put(resourceWrapper, chain);
                chainMap = newMap;
            }
        }
    }
    return chain;
}
```

è¯¥æ–¹æ³•ä½¿ç”¨äº†ä¸€ä¸ªHashMapåšäº†ç¼“å­˜ï¼Œkeyæ˜¯èµ„æºå¯¹è±¡ã€‚è¿™é‡ŒåŠ äº†é”ï¼Œå¹¶ä¸”åšäº† `double check` ã€‚å…·ä½“æ„é€ chainçš„æ–¹æ³•æ˜¯é€šè¿‡ï¼š `Env.slotsChainbuilder.build()` è¿™å¥ä»£ç åˆ›å»ºçš„ã€‚é‚£å°±è¿›å…¥è¿™ä¸ªæ–¹æ³•çœ‹çœ‹å§ã€‚

```Java
public ProcessorSlotChain build() {
    ProcessorSlotChain chain = new DefaultProcessorSlotChain();
    chain.addLast(new NodeSelectorSlot());
    chain.addLast(new ClusterBuilderSlot());
    chain.addLast(new LogSlot());
    chain.addLast(new StatisticSlot());
    chain.addLast(new SystemSlot());
    chain.addLast(new AuthoritySlot());
    chain.addLast(new FlowSlot());
    chain.addLast(new DegradeSlot());

    return chain;
}
```

Chainæ˜¯é“¾æ¡çš„æ„æ€ï¼Œä»buildçš„æ–¹æ³•å¯çœ‹å‡ºï¼ŒProcessorSlotChainæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé‡Œé¢æ·»åŠ äº†å¾ˆå¤šä¸ªSlotã€‚å…·ä½“çš„å®ç°éœ€è¦åˆ°DefaultProcessorSlotChainä¸­å»çœ‹ã€‚

```Java
public class DefaultProcessorSlotChain extends ProcessorSlotChain {

    AbstractLinkedProcessorSlot<?> first = new AbstractLinkedProcessorSlot<Object>() {
        @Override
        public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, Object... args)
            throws Throwable {
            super.fireEntry(context, resourceWrapper, t, count, args);
        }
        @Override
        public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {
            super.fireExit(context, resourceWrapper, count, args);
        }
    };

    AbstractLinkedProcessorSlot<?> end = first;

    @Override
    public void addFirst(AbstractLinkedProcessorSlot<?> protocolProcessor) {
        protocolProcessor.setNext(first.getNext());
        first.setNext(protocolProcessor);
        if (end == first) {
            end = protocolProcessor;
        }
    }

    @Override
    public void addLast(AbstractLinkedProcessorSlot<?> protocolProcessor) {
        end.setNext(protocolProcessor);
        end = protocolProcessor;
    }
}
```

DefaultProcessorSlotChainä¸­æœ‰ä¸¤ä¸ªAbstractLinkedProcessorSlotç±»å‹çš„å˜é‡ï¼šfirstå’Œendï¼Œè¿™å°±æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹ã€‚

åˆ›å»ºDefaultProcessorSlotChainå¯¹è±¡æ—¶ï¼Œé¦–å…ˆåˆ›å»ºäº†é¦–èŠ‚ç‚¹ï¼Œç„¶åæŠŠé¦–èŠ‚ç‚¹èµ‹å€¼ç»™äº†å°¾èŠ‚ç‚¹ï¼Œå¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-c7efcb50902a589e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600/format/jpeg)

slot-chain-1.png

å°†ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨ä¸­åï¼Œæ•´ä¸ªé“¾è¡¨çš„ç»“æ„å˜æˆäº†å¦‚ä¸‹å›¾è¿™æ ·ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-eefaa54516e0c7e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/750/format/jpeg)

slot-chain-2.png

å°†æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½åŠ å…¥åˆ°é“¾è¡¨ä¸­åï¼Œæ•´ä¸ªé“¾è¡¨çš„ç»“æ„å˜æˆäº†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-7dea3349435d9349.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

slot-chain-3.png

è¿™æ ·å°±å°†æ‰€æœ‰çš„Slotå¯¹è±¡æ·»åŠ åˆ°äº†é“¾è¡¨ä¸­å»äº†ï¼Œæ¯ä¸€ä¸ªSlotéƒ½æ˜¯ç»§æ‰¿è‡ªAbstractLinkedProcessorSlotã€‚è€ŒAbstractLinkedProcessorSlotæ˜¯ä¸€ç§è´£ä»»é“¾çš„è®¾è®¡ï¼Œæ¯ä¸ªå¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªnextå±æ€§ï¼ŒæŒ‡å‘çš„æ˜¯å¦ä¸€ä¸ªAbstractLinkedProcessorSlotå¯¹è±¡ã€‚å…¶å®è´£ä»»é“¾æ¨¡å¼åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½æœ‰ï¼Œæ¯”å¦‚Nettyä¸­æ˜¯é€šè¿‡pipelineæ¥å®ç°çš„ã€‚

çŸ¥é“äº†SlotChainæ˜¯å¦‚ä½•åˆ›å»ºçš„äº†ï¼Œé‚£æ¥ä¸‹æ¥å°±è¦çœ‹ä¸‹æ˜¯å¦‚ä½•æ‰§è¡ŒSlotçš„entryæ–¹æ³•çš„äº†ã€‚

## æ‰§è¡ŒSlotChainçš„entryæ–¹æ³•

lookProcessChainæ–¹æ³•è·å¾—çš„ProcessorSlotChainçš„å®ä¾‹æ˜¯DefaultProcessorSlotChainï¼Œé‚£ä¹ˆæ‰§è¡Œchain.entryæ–¹æ³•ï¼Œå°±ä¼šæ‰§è¡ŒDefaultProcessorSlotChainçš„entryæ–¹æ³•ï¼Œè€ŒDefaultProcessorSlotChainçš„entryæ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, Object... args)
    throws Throwable {
    first.transformEntry(context, resourceWrapper, t, count, args);
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼ŒDefaultProcessorSlotChainçš„entryå®é™…æ˜¯æ‰§è¡Œçš„firstå±æ€§çš„transformEntryæ–¹æ³•ã€‚

è€ŒtransformEntryæ–¹æ³•ä¼šæ‰§è¡Œå½“å‰èŠ‚ç‚¹çš„entryæ–¹æ³•ï¼Œåœ¨DefaultProcessorSlotChainä¸­firstèŠ‚ç‚¹é‡å†™äº†entryæ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, Object... args)
    throws Throwable {
    super.fireEntry(context, resourceWrapper, t, count, args);
}
```

firstèŠ‚ç‚¹çš„entryæ–¹æ³•ï¼Œå®é™…åˆæ˜¯æ‰§è¡Œçš„superçš„fireEntryæ–¹æ³•ï¼Œé‚£ç»§ç»­æŠŠç›®å…‰è½¬ç§»åˆ°fireEntryæ–¹æ³•ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

```Java
@Override
public void fireEntry(Context context, ResourceWrapper resourceWrapper, Object obj, int count, Object... args)
    throws Throwable {
    if (next != null) {
        next.transformEntry(context, resourceWrapper, obj, count, args);
    }
}
```

ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œä»fireEntryæ–¹æ³•ä¸­å°±å¼€å§‹ä¼ é€’æ‰§è¡Œentryäº†ï¼Œè¿™é‡Œä¼šæ‰§è¡Œå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹transformEntryæ–¹æ³•ï¼Œä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼ŒtransformEntryæ–¹æ³•ä¼šè§¦å‘å½“å‰èŠ‚ç‚¹çš„entryï¼Œä¹Ÿå°±æ˜¯è¯´fireEntryæ–¹æ³•å®é™…æ˜¯è§¦å‘äº†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„entryæ–¹æ³•ã€‚å…·ä½“çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-10ed952f45fe65aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

slot-chain-entry-process.png

ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä»æœ€åˆçš„è°ƒç”¨Chainçš„entry()æ–¹æ³•ï¼Œè½¬å˜æˆäº†è°ƒç”¨SlotChainä¸­Slotçš„entry()æ–¹æ³•ã€‚ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çŸ¥é“ï¼ŒSlotChainä¸­çš„ç¬¬ä¸€ä¸ªSlotèŠ‚ç‚¹æ˜¯NodeSelectorSlotã€‚

## æ‰§è¡ŒSlotçš„entryæ–¹æ³•

ç°åœ¨å¯ä»¥æŠŠç›®å…‰è½¬ç§»åˆ°SlotChainä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹NodeSelectorSlotçš„entryæ–¹æ³•ä¸­å»äº†ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, Object obj, int count, Object... args)
    throws Throwable {

    DefaultNode node = map.get(context.getName());
    if (node == null) {
        synchronized (this) {
            node = map.get(context.getName());
            if (node == null) {
                node = Env.nodeBuilder.buildTreeNode(resourceWrapper, null);
                HashMap<String, DefaultNode> cacheMap = new HashMap<String, DefaultNode>(map.size());
                cacheMap.putAll(map);
                cacheMap.put(context.getName(), node);
                map = cacheMap;
            }
            // Build invocation tree
            ((DefaultNode)context.getLastNode()).addChild(node);
        }
    }

    context.setCurNode(node);
    // ç”±æ­¤è§¦å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„entryæ–¹æ³•
    fireEntry(context, resourceWrapper, node, count, args);
}
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒNodeSelectorSlotèŠ‚ç‚¹åšäº†ä¸€äº›è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå…·ä½“çš„å¤§å®¶å¯ä»¥æ·±å…¥æºç ç»§ç»­è¿½è¸ªï¼Œè¿™é‡Œå¤§æ¦‚çš„ä»‹ç»ä¸‹æ¯ç§Slotçš„åŠŸèƒ½èŒè´£ï¼š

-  `NodeSelectorSlot` è´Ÿè´£æ”¶é›†èµ„æºçš„è·¯å¾„ï¼Œå¹¶å°†è¿™äº›èµ„æºçš„è°ƒç”¨è·¯å¾„ï¼Œä»¥æ ‘çŠ¶ç»“æ„å­˜å‚¨èµ·æ¥ï¼Œç”¨äºæ ¹æ®è°ƒç”¨è·¯å¾„æ¥é™æµé™çº§ï¼›
-  `ClusterBuilderSlot` åˆ™ç”¨äºå­˜å‚¨èµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ä»¥åŠè°ƒç”¨è€…ä¿¡æ¯ï¼Œä¾‹å¦‚è¯¥èµ„æºçš„ RT, QPS, thread count ç­‰ç­‰ï¼Œè¿™äº›ä¿¡æ¯å°†ç”¨ä½œä¸ºå¤šç»´åº¦é™æµï¼Œé™çº§çš„ä¾æ®ï¼›
-  `StatistcSlot` åˆ™ç”¨äºè®°å½•ï¼Œç»Ÿè®¡ä¸åŒçº¬åº¦çš„ runtime ä¿¡æ¯ï¼›
-  `FlowSlot` åˆ™ç”¨äºæ ¹æ®é¢„è®¾çš„é™æµè§„åˆ™ï¼Œä»¥åŠå‰é¢ slot ç»Ÿè®¡çš„çŠ¶æ€ï¼Œæ¥è¿›è¡Œé™æµï¼›
-  `AuthorizationSlot` åˆ™æ ¹æ®é»‘ç™½åå•ï¼Œæ¥åšé»‘ç™½åå•æ§åˆ¶ï¼›
-  `DegradeSlot` åˆ™é€šè¿‡ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥åŠé¢„è®¾çš„è§„åˆ™ï¼Œæ¥åšç†”æ–­é™çº§ï¼›
-  `SystemSlot` åˆ™é€šè¿‡ç³»ç»Ÿçš„çŠ¶æ€ï¼Œä¾‹å¦‚ load1 ç­‰ï¼Œæ¥æ§åˆ¶æ€»çš„å…¥å£æµé‡ï¼›

æ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘å¤„ç†åï¼Œè°ƒç”¨äº†fireEntry()æ–¹æ³•ï¼Œç”±æ­¤è§¦å‘äº†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„entryæ–¹æ³•ã€‚æ­¤æ—¶æˆ‘ä»¬å°±çŸ¥é“äº†sentinelçš„è´£ä»»é“¾å°±æ˜¯è¿™æ ·ä¼ é€’çš„ï¼šæ¯ä¸ªSlotèŠ‚ç‚¹æ‰§è¡Œå®Œè‡ªå·±çš„ä¸šåŠ¡åï¼Œä¼šè°ƒç”¨fireEntryæ¥è§¦å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„entryæ–¹æ³•ã€‚

æ‰€ä»¥å¯ä»¥å°†ä¸Šé¢çš„å›¾å®Œæ•´äº†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-99b6b8b6130ad903.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

slot-chain-entry-whole-process.png

è‡³æ­¤å°±é€šè¿‡SlotChainå®Œæˆäº†å¯¹æ¯ä¸ªèŠ‚ç‚¹çš„entry()æ–¹æ³•çš„è°ƒç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šæ ¹æ®åˆ›å»ºçš„è§„åˆ™ï¼Œè¿›è¡Œè‡ªå·±çš„é€»è¾‘å¤„ç†ï¼Œå½“ç»Ÿè®¡çš„ç»“æœè¾¾åˆ°è®¾ç½®çš„é˜ˆå€¼æ—¶ï¼Œå°±ä¼šè§¦å‘é™æµã€é™çº§ç­‰äº‹ä»¶ï¼Œå…·ä½“æ˜¯æŠ›å‡ºBlockExceptionå¼‚å¸¸ã€‚

### æ€»ç»“

sentinelä¸»è¦æ˜¯åŸºäº7ç§ä¸åŒçš„Slotå½¢æˆäº†ä¸€ä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªSlotéƒ½å„å¸å…¶èŒï¼Œè‡ªå·±åšå®Œåˆ†å†…çš„äº‹ä¹‹åï¼Œä¼šæŠŠè¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªSlotï¼Œç›´åˆ°åœ¨æŸä¸€ä¸ªSlotä¸­å‘½ä¸­è§„åˆ™åæŠ›å‡ºBlockExceptionè€Œç»ˆæ­¢ã€‚

å‰ä¸‰ä¸ªSlotè´Ÿè´£åšç»Ÿè®¡ï¼Œåé¢çš„Slotè´Ÿè´£æ ¹æ®ç»Ÿè®¡çš„ç»“æœç»“åˆé…ç½®çš„è§„åˆ™è¿›è¡Œå…·ä½“çš„æ§åˆ¶ï¼Œæ˜¯Blockè¯¥è¯·æ±‚è¿˜æ˜¯æ”¾è¡Œã€‚

æ§åˆ¶çš„ç±»å‹ä¹Ÿæœ‰å¾ˆå¤šå¯é€‰é¡¹ï¼šæ ¹æ®qpsã€çº¿ç¨‹æ•°ã€å†·å¯åŠ¨ç­‰ç­‰ã€‚

ç„¶ååŸºäºè¿™ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ï¼Œè¡ç”Ÿå‡ºäº†å¾ˆå¤šå…¶ä»–çš„åŠŸèƒ½ï¼š

- 1ã€dashboardæ§åˆ¶å°ï¼Œå¯ä»¥å¯è§†åŒ–çš„å¯¹æ¯ä¸ªè¿æ¥è¿‡æ¥çš„sentinelå®¢æˆ·ç«¯ (é€šè¿‡å‘é€heartbeatæ¶ˆæ¯)è¿›è¡Œæ§åˆ¶ï¼Œdashboardå’Œå®¢æˆ·ç«¯ä¹‹é—´é€šè¿‡httpåè®®è¿›è¡Œé€šè®¯ã€‚
- 2ã€è§„åˆ™çš„æŒä¹…åŒ–ï¼Œé€šè¿‡å®ç°DataSourceæ¥å£ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼å¯¹é…ç½®çš„è§„åˆ™è¿›è¡ŒæŒä¹…åŒ–ï¼Œé»˜è®¤è§„åˆ™æ˜¯åœ¨å†…å­˜ä¸­çš„
- 3ã€å¯¹ä¸»æµçš„æ¡†æ¶è¿›è¡Œé€‚é…ï¼ŒåŒ…æ‹¬servletï¼Œdubboï¼ŒrRpcç­‰

# Dashboardæ§åˆ¶å°

sentinel-dashboardæ˜¯ä¸€ä¸ªå•ç‹¬çš„åº”ç”¨ï¼Œé€šè¿‡spring-bootè¿›è¡Œå¯åŠ¨ï¼Œä¸»è¦æä¾›ä¸€ä¸ªè½»é‡çº§çš„æ§åˆ¶å°ï¼Œå®ƒæä¾›æœºå™¨å‘ç°ã€å•æœºèµ„æºå®æ—¶ç›‘æ§ã€é›†ç¾¤èµ„æºæ±‡æ€»ï¼Œä»¥åŠè§„åˆ™ç®¡ç†çš„åŠŸèƒ½ã€‚

æˆ‘ä»¬åªéœ€è¦å¯¹åº”ç”¨è¿›è¡Œç®€å•çš„é…ç½®ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚

## 1 å¯åŠ¨æ§åˆ¶å°

### 1.1 ä¸‹è½½ä»£ç å¹¶ç¼–è¯‘æ§åˆ¶å°

- ä¸‹è½½ [æ§åˆ¶å°](https://github.com/alibaba/Sentinel/tree/master/sentinel-dashboard) å·¥ç¨‹
- ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†ä»£ç æ‰“åŒ…æˆä¸€ä¸ª fat jar: `mvn clean package`

### 1.2 å¯åŠ¨

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ç¼–è¯‘åçš„æ§åˆ¶å°ï¼š

```Bash
$ java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -jar target/sentinel-dashboard.jar
```

ä¸Šè¿°å‘½ä»¤ä¸­æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªJVMå‚æ•°ï¼Œ`-Dserver.port=8080` ç”¨äºæŒ‡å®š Spring Boot å¯åŠ¨ç«¯å£ä¸º `8080`ã€‚

## 2 å®¢æˆ·ç«¯æ¥å…¥æ§åˆ¶å°

æ§åˆ¶å°å¯åŠ¨åï¼Œå®¢æˆ·ç«¯éœ€è¦æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥å…¥åˆ°æ§åˆ¶å°ã€‚

### 2.1 å¼•å…¥å®¢æˆ·ç«¯jaråŒ…

é€šè¿‡ `pom.xml` å¼•å…¥ jar åŒ…:

```XML
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-transport-simple-http</artifactId>
    <version>x.y.z</version>
</dependency>
```

### 2.2 é…ç½®å¯åŠ¨å‚æ•°

å¯åŠ¨æ—¶åŠ å…¥ JVM å‚æ•° `-Dcsp.sentinel.dashboard.server=consoleIp:port` æŒ‡å®šæ§åˆ¶å°åœ°å€å’Œç«¯å£ã€‚è‹¥å¯åŠ¨å¤šä¸ªåº”ç”¨ï¼Œåˆ™éœ€è¦é€šè¿‡ `-Dcsp.sentinel.api.port=xxxx` æŒ‡å®šå®¢æˆ·ç«¯ç›‘æ§ API çš„ç«¯å£ï¼ˆé»˜è®¤æ˜¯ 8719ï¼‰ã€‚

é™¤äº†ä¿®æ”¹ JVM å‚æ•°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å–å¾—åŒæ ·çš„æ•ˆæœã€‚æ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥å‚è€ƒ [å¯åŠ¨é…ç½®é¡¹](https://github.com/alibaba/Sentinel/wiki/%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E9%A1%B9)ã€‚

### 2.3 è§¦å‘å®¢æˆ·ç«¯åˆå§‹åŒ–

**ç¡®ä¿å®¢æˆ·ç«¯æœ‰è®¿é—®é‡**ï¼ŒSentinel ä¼šåœ¨**å®¢æˆ·ç«¯é¦–æ¬¡è°ƒç”¨çš„æ—¶å€™**è¿›è¡Œåˆå§‹åŒ–ï¼Œå¼€å§‹å‘æ§åˆ¶å°å‘é€å¿ƒè·³åŒ…ã€‚

sentinel-dashboardæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„webåº”ç”¨ï¼Œå¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œç„¶åä¸å®¢æˆ·ç«¯ä¹‹é—´è¿›è¡Œé€šè®¯ï¼Œä»–ä»¬ä¹‹é—´ä½¿ç”¨httpåè®®è¿›è¡Œé€šè®¯ã€‚ä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-008d26fbf36b7e1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

dashboard-client-transport.png

## dashboard

dashboardå¯åŠ¨åä¼šç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå…·ä½“çš„åšæ³•æ˜¯åœ¨ `MachineRegistryController` ä¸­æœ‰ä¸€ä¸ª `receiveHeartBeat` çš„æ–¹æ³•ï¼Œå®¢æˆ·ç«¯å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œå°±æ˜¯é€šè¿‡httpè¯·æ±‚è¿™ä¸ªæ–¹æ³•ã€‚

dashboardæ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å¿ƒè·³æ¶ˆæ¯åï¼Œä¼šæŠŠå®¢æˆ·ç«¯çš„ä¼ é€’è¿‡æ¥çš„ipã€portç­‰ä¿¡æ¯å°è£…æˆä¸€ä¸ª `MachineInfo` å¯¹è±¡ï¼Œç„¶åå°†è¯¥å¯¹è±¡é€šè¿‡ `MachineDiscovery` æ¥å£çš„ `addMachine` æ–¹æ³•æ·»åŠ åˆ°ä¸€ä¸ªConcurrentHashMapä¸­ä¿å­˜èµ·æ¥ã€‚

è¿™é‡Œä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºå®¢æˆ·ç«¯çš„ä¿¡æ¯æ˜¯ä¿å­˜åœ¨dashboardçš„å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥å½“dashboardåº”ç”¨é‡å¯åï¼Œä¹‹å‰å·²ç»å‘é€è¿‡æ¥çš„å®¢æˆ·ç«¯ä¿¡æ¯éƒ½ä¼šä¸¢å¤±æ‰ã€‚

## client

clientåœ¨å¯åŠ¨æ—¶ï¼Œä¼šé€šè¿‡CommandCenterInitFuncé€‰æ‹©ä¸€ä¸ªï¼Œå¹¶ä¸”åªé€‰æ‹©ä¸€ä¸ªCommandCenterè¿›è¡Œå¯åŠ¨ã€‚

å¯åŠ¨ä¹‹å‰ä¼šé€šè¿‡spiçš„æ–¹å¼æ‰«æè·å–åˆ°æ‰€æœ‰çš„CommandHandlerçš„å®ç°ç±»ï¼Œç„¶åå°†æ‰€æœ‰çš„CommandHandleræ³¨å†Œåˆ°ä¸€ä¸ªHashMapä¸­å»ï¼Œå¾…åæœŸä½¿ç”¨ã€‚

**PSï¼šè€ƒè™‘ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆCommandHandlerä¸éœ€è¦åšæŒä¹…åŒ–ï¼Œè€Œæ˜¯ç›´æ¥ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚**

æ³¨å†Œå®ŒCommandHandlerä¹‹åï¼Œç´§æ¥ç€å°±å¯åŠ¨CommandCenteräº†ï¼Œç›®å‰CommandCenteræœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š

- SimpleHttpCommandCenter é€šè¿‡ServerSocketå¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæ¥å—socketè¿æ¥
- NettyHttpCommandCenter é€šè¿‡Nettyå¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæ¥å—channelè¿æ¥

CommandCenterå¯åŠ¨åï¼Œå°±ç­‰å¾…dashboardå‘é€æ¶ˆæ¯è¿‡æ¥äº†ï¼Œå½“æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šæŠŠæ¶ˆæ¯é€šè¿‡å…·ä½“çš„CommandHandlerè¿›è¡Œå¤„ç†ï¼Œç„¶åå°†å¤„ç†çš„ç»“æœè¿”å›ç»™dashboardã€‚

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdashboardç»™clientå‘é€æ¶ˆæ¯æ˜¯é€šè¿‡å¼‚æ­¥çš„httpClientè¿›è¡Œå‘é€çš„ï¼Œåœ¨HttpHelperç±»ä¸­ã€‚

ä½†æ˜¯è¯¡å¼‚çš„æ˜¯ï¼Œæ—¢ç„¶é€šè¿‡å¼‚æ­¥å‘é€äº†ï¼Œåˆé€šè¿‡ä¸€ä¸ªCountDownLatchæ¥ç­‰å¾…æ¶ˆæ¯çš„è¿”å›ï¼Œç„¶åè·å–ç»“æœï¼Œé‚£è¿™æ ·ä¸å°±å¤±å»äº†å¼‚æ­¥çš„æ„ä¹‰çš„å—ï¼Ÿå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```java
private String httpGetContent(String url) {
    final HttpGet httpGet = new HttpGet(url);
    final CountDownLatch latch = new CountDownLatch(1);
    final AtomicReference<String> reference = new AtomicReference<>();
    httpclient.execute(httpGet, new FutureCallback<HttpResponse>() {
        @Override
        public void completed(final HttpResponse response) {
            try {
                reference.set(getBody(response));
            } catch (Exception e) {
                logger.info("httpGetContent " + url + " error:", e);
            } finally {
                latch.countDown();
            }
        }

        @Override
        public void failed(final Exception ex) {
            latch.countDown();
            logger.info("httpGetContent " + url + " failed:", ex);
        }

        @Override
        public void cancelled() {
            latch.countDown();
        }
    });
    try {
        latch.await(5, TimeUnit.SECONDS);
    } catch (Exception e) {
        logger.info("wait http client error:", e);
    }
    return reference.get();
}
```

# ä¸»æµæ¡†æ¶çš„é€‚é…

sentinelä¹Ÿå¯¹ä¸€äº›ä¸»æµçš„æ¡†æ¶è¿›è¡Œäº†é€‚é…ï¼Œä½¿å¾—åœ¨ä½¿ç”¨ä¸»æµæ¡†æ¶æ—¶ï¼Œä¹Ÿå¯ä»¥äº«å—åˆ°sentinelçš„ä¿æŠ¤ã€‚ç›®å‰å·²ç»æ”¯æŒçš„é€‚é…å™¨åŒ…æ‹¬ä»¥ä¸‹è¿™äº›ï¼š

- Web Servlet
- Dubbo
- Spring Boot / Spring Cloud
- gRPC
- Apache RocketMQ

å…¶å®åšé€‚é…å°±æ˜¯é€šè¿‡é‚£äº›ä¸»æµæ¡†æ¶çš„æ‰©å±•ç‚¹ï¼Œç„¶ååœ¨æ‰©å±•ç‚¹ä¸ŠåŠ å…¥sentinelé™æµé™çº§çš„ä»£ç å³å¯ã€‚æ‹¿Servletçš„é€‚é…ä»£ç çœ‹ä¸€ä¸‹ï¼Œå…·ä½“çš„ä»£ç æ˜¯ï¼š

```java
public class CommonFilter implements Filter {

    @Override
    public void init(FilterConfig filterConfig) {

    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
        throws IOException, ServletException {
        HttpServletRequest sRequest = (HttpServletRequest)request;
        Entry entry = null;

        try {
            // æ ¹æ®è¯·æ±‚ç”Ÿæˆçš„èµ„æº
            String target = FilterUtil.filterTarget(sRequest);
            target = WebCallbackManager.getUrlCleaner().clean(target);

            // â€œç”³è¯·â€è¯¥èµ„æº
            ContextUtil.enter(target);
            entry = SphU.entry(target, EntryType.IN);

            // å¦‚æœèƒ½æˆåŠŸâ€œç”³è¯·â€åˆ°èµ„æºï¼Œåˆ™è¯´æ˜æœªè¢«é™æµ
            // åˆ™å°†è¯·æ±‚æ”¾è¡Œ
            chain.doFilter(request, response);
        } catch (BlockException e) {
            // å¦åˆ™å¦‚æœæ•è·äº†BlockExceptionå¼‚å¸¸ï¼Œè¯´æ˜è¯·æ±‚è¢«é™æµäº†
            // åˆ™å°†è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªé»˜è®¤çš„é¡µé¢
            HttpServletResponse sResponse = (HttpServletResponse)response;
            WebCallbackManager.getUrlBlockHandler().blocked(sRequest, sResponse);
        } catch (IOException e2) {
            // çœç•¥éƒ¨åˆ†ä»£ç 
        } finally {
            if (entry != null) {
                entry.exit();
            }
            ContextUtil.exit();
        }
    }

    @Override
    public void destroy() {

    }
}
```

é€šè¿‡Servletçš„Filterè¿›è¡Œæ‰©å±•ï¼Œå®ç°ä¸€ä¸ªFilterï¼Œç„¶ååœ¨doFilteræ–¹æ³•ä¸­å¯¹è¯·æ±‚è¿›è¡Œé™æµæ§åˆ¶ï¼Œå¦‚æœè¯·æ±‚è¢«é™æµåˆ™å°†è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªé»˜è®¤é¡µé¢ï¼Œå¦åˆ™å°†è¯·æ±‚æ”¾è¡Œç»™ä¸‹ä¸€ä¸ªFilterã€‚

# è§„åˆ™æŒä¹…åŒ–ï¼ŒåŠ¨æ€åŒ–

Sentinel çš„ç†å¿µæ˜¯å¼€å‘è€…åªéœ€è¦å…³æ³¨èµ„æºçš„å®šä¹‰ï¼Œå½“èµ„æºå®šä¹‰æˆåŠŸï¼Œå¯ä»¥åŠ¨æ€å¢åŠ å„ç§æµæ§é™çº§è§„åˆ™ã€‚

Sentinel æä¾›ä¸¤ç§æ–¹å¼ä¿®æ”¹è§„åˆ™ï¼š

- é€šè¿‡ API ç›´æ¥ä¿®æ”¹ (`loadRules`)
- é€šè¿‡`DataSource`é€‚é…ä¸åŒæ•°æ®æºä¿®æ”¹

é€šè¿‡ API ä¿®æ”¹æ¯”è¾ƒç›´è§‚ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ª API ä¿®æ”¹ä¸åŒçš„è§„åˆ™ï¼š

```java
FlowRuleManager.loadRules(List<FlowRule> rules); // ä¿®æ”¹æµæ§è§„åˆ™
DegradeRuleManager.loadRules(List<DegradeRule> rules); // ä¿®æ”¹é™çº§è§„åˆ™
SystemRuleManager.loadRules(List<SystemRule> rules); // ä¿®æ”¹ç³»ç»Ÿè§„åˆ™
```

## DataSource æ‰©å±•

ä¸Šè¿° `loadRules()` æ–¹æ³•åªæ¥å—å†…å­˜æ€çš„è§„åˆ™å¯¹è±¡ï¼Œä½†åº”ç”¨é‡å¯åå†…å­˜ä¸­çš„è§„åˆ™å°±ä¼šä¸¢å¤±ï¼Œæ›´å¤šçš„æ—¶å€™è§„åˆ™æœ€å¥½èƒ½å¤Ÿå­˜å‚¨åœ¨æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…é…ç½®ä¸­å¿ƒä¸­ã€‚

`DataSource` æ¥å£ç»™æˆ‘ä»¬æä¾›äº†å¯¹æ¥ä»»æ„é…ç½®æºçš„èƒ½åŠ›ã€‚ç›¸æ¯”ç›´æ¥é€šè¿‡ API ä¿®æ”¹è§„åˆ™ï¼Œå®ç° `DataSource` æ¥å£æ˜¯æ›´åŠ å¯é çš„åšæ³•ã€‚

å®˜æ–¹**æ¨èé€šè¿‡æ§åˆ¶å°è®¾ç½®è§„åˆ™åå°†è§„åˆ™æ¨é€åˆ°ç»Ÿä¸€çš„è§„åˆ™ä¸­å¿ƒï¼Œç”¨æˆ·åªéœ€è¦å®ç° DataSource æ¥å£ï¼Œæ¥ç›‘å¬è§„åˆ™ä¸­å¿ƒçš„è§„åˆ™å˜åŒ–ï¼Œä»¥å®æ—¶è·å–å˜æ›´çš„è§„åˆ™**ã€‚

`DataSource` æ‹“å±•å¸¸è§çš„å®ç°æ–¹å¼æœ‰ï¼š

-  **æ‹‰æ¨¡å¼**ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨å‘æŸä¸ªè§„åˆ™ç®¡ç†ä¸­å¿ƒå®šæœŸè½®è¯¢æ‹‰å–è§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¸­å¿ƒå¯ä»¥æ˜¯ SQLã€æ–‡ä»¶ï¼Œç”šè‡³æ˜¯ VCS ç­‰ã€‚è¿™æ ·åšçš„æ–¹å¼æ˜¯ç®€å•ï¼Œç¼ºç‚¹æ˜¯æ— æ³•åŠæ—¶è·å–å˜æ›´ï¼›
-  **æ¨æ¨¡å¼**ï¼šè§„åˆ™ä¸­å¿ƒç»Ÿä¸€æ¨é€ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œç›‘å¬å™¨çš„æ–¹å¼æ—¶åˆ»ç›‘å¬å˜åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨ [Nacos](https://github.com/alibaba/nacos)ã€Zookeeper ç­‰é…ç½®ä¸­å¿ƒã€‚è¿™ç§æ–¹å¼æœ‰æ›´å¥½çš„å®æ—¶æ€§å’Œä¸€è‡´æ€§ä¿è¯ã€‚

è‡³æ­¤ï¼Œsentinelçš„åŸºæœ¬æƒ…å†µéƒ½å·²ç»åˆ†æäº†ï¼Œæ›´åŠ è¯¦ç»†çš„å†…å®¹ï¼Œå¯ä»¥ç»§ç»­é˜…è¯»æºç æ¥ç ”ç©¶ã€‚