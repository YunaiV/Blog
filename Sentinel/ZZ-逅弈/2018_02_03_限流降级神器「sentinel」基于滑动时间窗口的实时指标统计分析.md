title: é™æµé™çº§ç¥å™¨ã€Œsentinelã€åŸºäºæ»‘åŠ¨æ—¶é—´çª—å£çš„å®æ—¶æŒ‡æ ‡ç»Ÿè®¡åˆ†æ
date: 2018-02-03
tags:
categories: Sentinel
permalink: Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window
author:  é€…å¼ˆ
from_url: https://www.jianshu.com/p/6ee4b7bdb844
wechat_url:

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.jianshu.com/p/6ee4b7bdb844 ã€Œé€…å¼ˆã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [åŒ–æ•´ä¸ºé›¶](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
  - [DefaultNodeå’ŒClusterNode](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
  - [StatisticNode](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
  - [Metric](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
  - [LeapArrayå’ŒWindow](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
- [å®Œæ•´çš„æµç¨‹](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
- [ç»§ç»­æ·±å…¥](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
  - [è·å–å½“å‰Window](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)
  - [çœ‹å›¾ç†è§£](http://www.iocoder.cn/Sentinel/houyi/The-sentinel-is-based-on-the-statistics-analysis-of-the-real-time-index-of-the-sliding-time-window/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä¸Šç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†sentinelæ˜¯å¦‚ä½•æ„é€ èµ„æºè°ƒç”¨é“¾çš„ï¼Œä»¥åŠæ¯ç§Slotçš„å…·ä½“ä½œç”¨ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªSlotéStatisticSlotè«å±ï¼Œå› ä¸ºä»–åšçš„äº‹æ˜¯å…¶ä»–æ‰€æœ‰çš„Slotçš„åŸºç¡€ã€‚åŒ…æ‹¬å„ç§é™æµï¼Œç†”æ–­çš„è§„åˆ™ï¼Œéƒ½æ˜¯åŸºäºStatisticSlotç»Ÿè®¡å‡ºæ¥çš„ç»“æœè¿›è¡Œè§„åˆ™æ ¡éªŒçš„ã€‚æœ¬ç¯‡æ–‡ç« æˆ‘å°†æ·±å…¥ç ”ç©¶ä¸‹sentinelæ˜¯å¦‚ä½•è¿›è¡Œqpsç­‰æŒ‡æ ‡çš„ç»Ÿè®¡çš„ï¼Œé¦–å…ˆè¦ç¡®å®šçš„ä¸€ç‚¹æ˜¯ï¼Œsentinelæ˜¯åŸºäºæ»‘åŠ¨æ—¶é—´çª—å£æ¥å®ç°çš„ã€‚

# åŒ–æ•´ä¸ºé›¶

æˆ‘ä»¬å·²ç»çŸ¥é“äº†Slotæ˜¯ä»ç¬¬ä¸€ä¸ªå¾€åä¸€ç›´ä¼ é€’åˆ°æœ€åä¸€ä¸ªçš„ï¼Œä¸”å½“ä¿¡æ¯ä¼ é€’åˆ°StatisticSlotæ—¶ï¼Œè¿™é‡Œå°±å¼€å§‹è¿›è¡Œç»Ÿè®¡äº†ï¼Œç»Ÿè®¡çš„ç»“æœåˆä¼šè¢«åç»­çš„Slotæ‰€é‡‡ç”¨ï¼Œä½œä¸ºè§„åˆ™æ ¡éªŒçš„ä¾æ®ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µéå¸¸ç†Ÿæ‚‰çš„ä»£ç ï¼Œå°±æ˜¯StatisticSlotä¸­çš„entryæ–¹æ³•ï¼š

```Java
@Override
public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {
    try {
        // è§¦å‘ä¸‹ä¸€ä¸ªSlotçš„entryæ–¹æ³•
        fireEntry(context, resourceWrapper, node, count, args);
        // å¦‚æœèƒ½é€šè¿‡SlotChainä¸­åé¢çš„Slotçš„entryæ–¹æ³•ï¼Œè¯´æ˜æ²¡æœ‰è¢«é™æµæˆ–é™çº§
        // ç»Ÿè®¡ä¿¡æ¯
        node.increaseThreadNum();
        node.addPassRequest();
        // çœç•¥éƒ¨åˆ†ä»£ç 
    } catch (BlockException e) {
        context.getCurEntry().setError(e);
        // Add block count.
        node.increaseBlockedQps();
        // çœç•¥éƒ¨åˆ†ä»£ç 
        throw e;
    } catch (Throwable e) {
        context.getCurEntry().setError(e);
        // Should not happen
        node.increaseExceptionQps();
        // çœç•¥éƒ¨åˆ†ä»£ç 
        throw e;
    }
}
```

ä¸Šé¢çš„ä»£ç æ³¨é‡Šå†™çš„å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œç®€å•çš„æ¥è¯´ï¼ŒStatisticSlotä¸­å°±æ˜¯åšäº†ä¸‰ä»¶äº‹ï¼š

- 1.é€šè¿‡nodeä¸­çš„å½“å‰çš„å®æ—¶ç»Ÿè®¡æŒ‡æ ‡ä¿¡æ¯è¿›è¡Œè§„åˆ™æ ¡éªŒ
- 2.å¦‚æœé€šè¿‡äº†æ ¡éªŒï¼Œåˆ™é‡æ–°æ›´æ–°nodeä¸­çš„å®æ—¶æŒ‡æ ‡æ•°æ®
- 3.å¦‚æœè¢«blockæˆ–å‡ºç°äº†å¼‚å¸¸äº†ï¼Œåˆ™é‡æ–°æ›´æ–°nodeä¸­blockçš„æŒ‡æ ‡æˆ–å¼‚å¸¸æŒ‡æ ‡

ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ï¼Œæ‰€æœ‰çš„å®æ—¶æŒ‡æ ‡çš„ç»Ÿè®¡éƒ½æ˜¯åœ¨nodeä¸­è¿›è¡Œçš„ã€‚è¿™é‡Œæˆ‘ä»¬æ‹¿qpsçš„æŒ‡æ ‡è¿›è¡Œåˆ†æï¼Œçœ‹sentinelæ˜¯æ€ä¹ˆç»Ÿè®¡å‡ºqpsçš„ï¼Œè¿™é‡Œå¯ä»¥äº‹å…ˆé€éœ²ä¸‹ä»–æ˜¯é€šè¿‡æ»‘åŠ¨æ—¶é—´çª—å£æ¥ç»Ÿè®¡çš„ï¼Œè€Œæ»‘åŠ¨çª—å£å°±æ˜¯æœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹ã€‚

## DefaultNodeå’ŒClusterNode

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° `node.addPassRequest()` è¿™æ®µä»£ç æ˜¯åœ¨fireEntryæ‰§è¡Œä¹‹åæ‰§è¡Œçš„ï¼Œè¿™æ„å‘³ç€ï¼Œå½“å‰è¯·æ±‚é€šè¿‡äº†sentinelçš„æµæ§ç­‰è§„åˆ™ï¼Œæ­¤æ—¶éœ€è¦å°†å½“æ¬¡è¯·æ±‚è®°å½•ä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ  `node.addPassRequest()` è¿™è¡Œä»£ç ï¼Œç°åœ¨æˆ‘ä»¬è¿›å…¥è¿™ä¸ªä»£ç çœ‹çœ‹ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```Java
@Override
public void addPassRequest() {
    super.addPassRequest();
    this.clusterNode.addPassRequest();
}
```

é¦–å…ˆæˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„nodeæ˜¯ä¸€ä¸ª `DefaultNode` å®ä¾‹ï¼Œè¿™é‡Œç‰¹åˆ«è¡¥å……ä¸€ä¸ª `DefaultNode` å’Œ `ClusterNode` çš„åŒºåˆ«ï¼š

DefaultNodeï¼šä¿å­˜ç€æŸä¸ªresourceåœ¨æŸä¸ªcontextä¸­çš„å®æ—¶æŒ‡æ ‡ï¼Œæ¯ä¸ªDefaultNodeéƒ½æŒ‡å‘ä¸€ä¸ªClusterNode

ClusterNodeï¼šä¿å­˜ç€æŸä¸ªresourceåœ¨æ‰€æœ‰çš„contextä¸­å®æ—¶æŒ‡æ ‡çš„æ€»å’Œï¼ŒåŒæ ·çš„resourceä¼šå…±äº«åŒä¸€ä¸ªClusterNodeï¼Œä¸ç®¡ä»–åœ¨å“ªä¸ªcontextä¸­

## StatisticNode

å¥½äº†ï¼ŒçŸ¥é“äº†ä»–ä»¬çš„åŒºåˆ«åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸Šé¢çš„ä»£ç ï¼Œå…¶å®éƒ½æ˜¯æ‰§è¡Œçš„ `StatisticNode` å¯¹è±¡çš„ `addPassRequest` æ–¹æ³•ã€‚è¿›å…¥è¿™ä¸ªæ–¹æ³•ä¸­çœ‹ä¸‹å…·ä½“çš„ä»£ç ï¼š

```Java
private transient Metric rollingCounterInSecond = new ArrayMetric(1000 / SampleCountProperty.sampleCount, IntervalProperty.INTERVAL);

private transient Metric rollingCounterInMinute = new ArrayMetric(1000, 2 * 60);

@Override
public void addPassRequest() {
    rollingCounterInSecond.addPass();
    rollingCounterInMinute.addPass();
}
```

## Metric

ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…·ä½“çš„å¢åŠ passæŒ‡æ ‡æ˜¯é€šè¿‡ä¸€ä¸ªå« `Metric` çš„æ¥å£è¿›è¡Œæ“ä½œçš„ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡ `ArrayMetric` è¿™ç§å®ç°ç±»ï¼Œç°åœ¨æˆ‘ä»¬åœ¨è¿›å…¥ `ArrayMetric` ä¸­çœ‹ä¸€ä¸‹ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```Java
private final WindowLeapArray data;

public ArrayMetric(int windowLength, int interval) {
    this.data = new WindowLeapArray(windowLength, interval);
}

@Override
public void addPass() {
    WindowWrap<Window> wrap = data.currentWindow();
    wrap.value().addPass();
}
```

## LeapArrayå’ŒWindow

æœ¬ä»¥ä¸ºåœ¨ArrayMetricä¸­åº”è¯¥å¯ä»¥çœ‹åˆ°å…·ä½“çš„ç»Ÿè®¡æ“ä½œäº†ï¼Œè°çŸ¥é“åˆå‡ºç°äº†ä¸€ä¸ªå« `WindowLeapArray` çš„ç±»ï¼Œä¸è¿‡ä»åå­—ä¸Šçœ‹æœ‰ç‚¹ **ã€Œçª—å£ã€** çš„æ„æ€äº†ã€‚ç»§ç»­è·Ÿä»£ç ï¼Œå‘ç° `wrap.value().addPass()` æ˜¯æ‰§è¡Œçš„ `wrap` å¯¹è±¡æ‰€åŒ…è£…çš„ `Window` å¯¹è±¡çš„ `addPass` æ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯æœ€ç»ˆçš„å¢åŠ qpsä¸­qçš„å€¼çš„åœ°æ–¹äº†ã€‚è¿›å…¥ `Window` ç±»ä¸­çœ‹ä¸€ä¸‹ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```Java
private final LongAdder pass = new LongAdder();
private final LongAdder block = new LongAdder();
private final LongAdder exception = new LongAdder();
private final LongAdder rt = new LongAdder();
private final LongAdder success = new LongAdder();

public void addPass() {
    pass.add(1L);
}
public void addException() {
    exception.add(1L);
}
public void addBlock() {
    block.add(1L);
}
public void addSuccess() {
    success.add(1L);
}
public void addRT(long rt) {
    this.rt.add(rt);

    // Not thread-safe, but it's okay.
    if (rt < minRt) {
        minRt = rt;
    }
}
```

çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯å°±æ”¾å¿ƒäº†ï¼ŒåŸæ¥ `Window` æ˜¯é€šè¿‡ `LongAdder` æ¥ä¿å­˜å„ç§æŒ‡æ ‡çš„å€¼çš„ï¼Œçœ‹åˆ° `LongAdder` æ˜¯ä¸æ˜¯ç«‹åˆ»å°±æƒ³åˆ° `AtomicLong` äº†ï¼Ÿä½†æ˜¯è¿™é‡Œä¸ºä»€ä¹ˆä¸ç”¨ `AtomicLong` ï¼Œè€Œæ˜¯ç”¨ `LongAdder` å‘¢ï¼Ÿä¸»è¦æ˜¯ `LongAdder` åœ¨é«˜å¹¶å‘ä¸‹æœ‰æ›´å¥½çš„ååé‡ï¼Œä»£ä»·æ˜¯èŠ±è´¹äº†æ›´å¤šçš„ç©ºé—´ï¼Œå…¸å‹çš„ä»¥ç©ºé—´æ¢æ—¶é—´ã€‚

# å®Œæ•´çš„æµç¨‹

åˆ†æåˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»æŠŠæŒ‡æ ‡ç»Ÿè®¡çš„å®Œæ•´é“¾è·¯ç†æ¸…æ¥šäº†ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¥è¡¨ç¤ºæ•´ä¸ªè¿‡ç¨‹ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-53f26b63499ec56b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

add-pass-request.png

æœ‰äººå¯èƒ½ä¼šé—®äº†ï¼Œä½ ä¸æ˜¯è¦åˆ†ææ»‘åŠ¨çª—å£çš„å—ï¼Ÿæäº†åŠå¤©åªç”»äº†ä¸€å¼ å›¾ï¼Œè€Œä¸”å›¾ä¸Šè¿˜å¤šäº†ä¸€ä¸ª `timeId` ä¹‹ç±»çš„ä¸œè¥¿ï¼Œè¿™ä¸ªæ ¹æœ¬æ²¡åœ¨ä¸Šé¢å‡ºç°è¿‡ã€‚

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥æ¥åˆ†æå…·ä½“çš„æ»‘åŠ¨çª—å£äº†ï¼Œè¿™é‡Œçš„ `timeId` æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ä¸ª `WindowWrap` å¯¹è±¡çš„æ—¶é—´idã€‚ä¸ºä»€ä¹ˆè¦ç”¨ `timeId` æ¥è¡¨ç¤ºå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ª `WindowWrap` å¯¹è±¡ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š

-  **windowStart:** æ—¶é—´çª—å£çš„å¼€å§‹æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
-  **windowLength:** æ—¶é—´çª—å£çš„é•¿åº¦ï¼Œå•ä½æ˜¯æ¯«ç§’
-  **value:** æ—¶é—´çª—å£çš„å†…å®¹ï¼Œåœ¨ `WindowWrap` ä¸­æ˜¯ç”¨æ³›å‹è¡¨ç¤ºè¿™ä¸ªå€¼çš„ï¼Œä½†å®é™…ä¸Šå°±æ˜¯ `Window` ç±»

æˆ‘ä»¬å…ˆå¤§è‡´çš„äº†è§£ä¸‹æ—¶é—´çª—å£çš„æ„æˆï¼Œåé¢ä¼šå†æ¥åˆ†æ **timeId** çš„ä½œç”¨ã€‚é¦–å…ˆä¸€ä¸ªæ—¶é—´çª—å£æ˜¯ç”¨æ¥åœ¨æŸä¸ªå›ºå®šæ—¶é—´é•¿åº¦å†…ä¿å­˜ä¸€äº›ç»Ÿè®¡å€¼çš„è™šæ‹Ÿæ¦‚å¿µã€‚æœ‰äº†è¿™ä¸ªæ¦‚å¿µåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ—¶é—´çª—å£æ¥è®¡ç®—ç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…çš„è¯¸å¦‚ï¼šqpsï¼Œrtï¼ŒthreadNumç­‰æŒ‡æ ‡äº†ã€‚

# ç»§ç»­æ·±å…¥

æˆ‘ä»¬å†å›åˆ° `ArrayMetric` ä¸­çœ‹ä¸€ä¸‹ï¼š

```Java
private final WindowLeapArray data;

public ArrayMetric(int windowLength, int interval) {
    this.data = new WindowLeapArray(windowLength, interval);
}
```

é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª `WindowLeapArray` å¯¹è±¡ï¼Œçœ‹ä¸€ä¸‹  `WindowLeapArray`  ç±»çš„ä»£ç ï¼š

```Java
public class WindowLeapArray extends LeapArray<Window> {
    public WindowLeapArray(int windowLengthInMs, int intervalInSec) {
        super(windowLengthInMs, intervalInSec);
    }
}
```

è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼š

-  `windowLengthInMs` ï¼šä¸€ä¸ªç”¨æ¯«ç§’åšå•ä½çš„æ—¶é—´çª—å£çš„é•¿åº¦
-  `intervalInSec` ï¼Œä¸€ä¸ªç”¨ç§’åšå•ä½çš„æ—¶é—´é—´éš”ï¼Œè¿™ä¸ªæ—¶é—´é—´éš”å…·ä½“æ˜¯åšä»€ä¹ˆçš„ï¼Œä¸‹é¢ä¼šåˆ†æã€‚

ç„¶å `WindowLeapArray` ç»§æ‰¿è‡ª  `LeapArray` ï¼Œåœ¨åˆå§‹åŒ–  `WindowLeapArray`  çš„æ—¶å€™ï¼Œç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œå†æ¥çœ‹ä¸€ä¸‹çˆ¶ç±»  `LeapArray` çš„ä»£ç ï¼š

```Java
public abstract class LeapArray<T> {

    // æ—¶é—´çª—å£çš„é•¿åº¦
    protected int windowLength;
    // é‡‡æ ·çª—å£çš„ä¸ªæ•°
    protected int sampleCount;
    // ä»¥æ¯«ç§’ä¸ºå•ä½çš„æ—¶é—´é—´éš”
    protected int intervalInMs;

    // é‡‡æ ·çš„æ—¶é—´çª—å£æ•°ç»„
    protected AtomicReferenceArray<WindowWrap<T>> array;

    /**
     * LeapArrayå¯¹è±¡
     * @param windowLength æ—¶é—´çª—å£çš„é•¿åº¦ï¼Œå•ä½ï¼šæ¯«ç§’
     * @param intervalInSec ç»Ÿè®¡çš„é—´éš”ï¼Œå•ä½ï¼šç§’
     */
    public LeapArray(int windowLength, int intervalInSec) {
        this.windowLength = windowLength;
        // æ—¶é—´çª—å£çš„é‡‡æ ·ä¸ªæ•°ï¼Œé»˜è®¤ä¸º2ä¸ªé‡‡æ ·çª—å£
        this.sampleCount = intervalInSec * 1000 / windowLength;
        this.intervalInMs = intervalInSec * 1000;

        this.array = new AtomicReferenceArray<WindowWrap<T>>(sampleCount);
    }
}
```

å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹å‡ºæ¥åœ¨ `LeapArray` ä¸­åˆ›å»ºäº†ä¸€ä¸ª `AtomicReferenceArray` æ•°ç»„ï¼Œç”¨æ¥å¯¹æ—¶é—´çª—å£ä¸­çš„ç»Ÿè®¡å€¼è¿›è¡Œé‡‡æ ·ã€‚é€šè¿‡é‡‡æ ·çš„ç»Ÿè®¡å€¼å†è®¡ç®—å‡ºå¹³å‡å€¼ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æœ€ç»ˆçš„å®æ—¶æŒ‡æ ‡çš„å€¼äº†ã€‚

å¯ä»¥çœ‹åˆ°æˆ‘åœ¨ä¸Šé¢çš„ä»£ç ä¸­é€šè¿‡æ³¨é‡Šï¼Œæ ‡æ˜äº†é»˜è®¤é‡‡æ ·çš„æ—¶é—´çª—å£çš„ä¸ªæ•°æ˜¯2ä¸ªï¼Œè¿™ä¸ªå€¼æ˜¯æ€ä¹ˆå¾—åˆ°çš„å‘¢ï¼Ÿæˆ‘ä»¬å›å¿†ä¸€ä¸‹ `LeapArray` å¯¹è±¡åˆ›å»ºï¼Œæ˜¯é€šè¿‡åœ¨ `StatisticNode` ä¸­ï¼Œnewäº†ä¸€ä¸ª `ArrayMetric` ï¼Œç„¶åå°†å‚æ•°ä¸€è·¯å¾€ä¸Šä¼ é€’ååˆ›å»ºçš„ï¼š

```Java
private transient Metric rollingCounterInSecond = new ArrayMetric(1000 / SampleCountProperty.sampleCount,IntervalProperty.INTERVAL);
```

`SampleCountProperty.sampleCount` çš„é»˜è®¤å€¼æ˜¯2ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå‚æ•° `windowLengthInMs` çš„å€¼æ˜¯ 500msï¼Œé‚£ä¹ˆ1ç§’é’Ÿæ˜¯1000msï¼Œæ¯ä¸ªæ—¶é—´çª—å£çš„é•¿åº¦æ˜¯500msï¼Œä¹Ÿå°±æ˜¯è¯´æ€»å…±åˆ†äº†ä¸¤ä¸ªé‡‡æ ·çš„æ—¶é—´çª—å£ã€‚

ç°åœ¨ç»§ç»­å›åˆ° `ArrayMetric.addPass()` æ–¹æ³•ï¼š

```Java
@Override
public void addPass() {
    WindowWrap<Window> wrap = data.currentWindow();
    wrap.value().addPass();
}
```

## è·å–å½“å‰Window

æˆ‘ä»¬å·²ç»åˆ†æäº† `wrap.value().addPass()` ï¼Œç°åœ¨åªéœ€è¦åˆ†ææ¸…æ¥š `data.currentWindow()` å…·ä½“åšäº†ä»€ä¹ˆï¼Œæ‹¿åˆ°äº†å½“å‰æ—¶é—´çª—å£å°±å¯ä»¥ äº†ã€‚ç»§ç»­æ·±å…¥ä»£ç ï¼Œæœ€ç»ˆå®šä½åˆ°ä¸‹é¢çš„ä»£ç ï¼š

```Java
@Override
public WindowWrap<Window> currentWindow(long time) {
    long timeId = time / windowLength;
    // Calculate current index.
    int idx = (int)(timeId % array.length());

    // Cut the time to current window start.
    long time = time - time % windowLength;

    while (true) {
        WindowWrap<Window> old = array.get(idx);
        if (old == null) {
            WindowWrap<Window> window = new WindowWrap<Window>(windowLength, time, new Window());
            if (array.compareAndSet(idx, null, window)) {
                return window;
            } else {
                Thread.yield();
            }
        } else if (time == old.windowStart()) {
            return old;
        } else if (time > old.windowStart()) {
            if (addLock.tryLock()) {
                try {
                    // if (old is deprecated) then [LOCK] resetTo currentTime.
                    return resetWindowTo(old, time);
                } finally {
                    addLock.unlock();
                }
            } else {
                Thread.yield();
            }
        } else if (time < old.windowStart()) {
            // Cannot go through here.
            return new WindowWrap<Window>(windowLength, time, new Window());
        }
    }
}
```

åˆæ¬¡çœ‹åˆ°è¿™æ®µä»£ç æ—¶ï¼Œå¯èƒ½ä¼šè§‰å¾—æœ‰ç‚¹æ‡µï¼Œä½†æ˜¯ç»†ç»†çš„åˆ†æä¸€ä¸‹ï¼Œå®é™…å¯ä»¥æŠŠä»–åˆ†æˆä»¥ä¸‹å‡ æ­¥ï¼š

- 1.æ ¹æ®å½“å‰æ—¶é—´ï¼Œç®—å‡ºè¯¥æ—¶é—´çš„timeIdï¼Œå¹¶æ ¹æ®timeIdç®—å‡ºå½“å‰çª—å£åœ¨é‡‡æ ·çª—å£æ•°ç»„ä¸­çš„ç´¢å¼•idx
- 2.æ ¹æ®å½“å‰æ—¶é—´ç®—å‡ºå½“å‰çª—å£çš„åº”è¯¥å¯¹åº”çš„å¼€å§‹æ—¶é—´timeï¼Œä»¥æ¯«ç§’ä¸ºå•ä½
- 3.æ ¹æ®ç´¢å¼•idxï¼Œåœ¨é‡‡æ ·çª—å£æ•°ç»„ä¸­å–å¾—ä¸€ä¸ªæ—¶é—´çª—å£old
- 4.å¾ªç¯åˆ¤æ–­çŸ¥é“è·å–åˆ°ä¸€ä¸ªå½“å‰æ—¶é—´çª—å£
  - 4.1.å¦‚æœoldä¸ºç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ—¶é—´çª—å£ï¼Œå¹¶å°†å®ƒæ’å…¥åˆ°arrayçš„ç¬¬idxä¸ªä½ç½®ï¼Œarrayä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œæ˜¯ä¸€ä¸ª `AtomicReferenceArray`
  - 4.2.å¦‚æœå½“å‰çª—å£çš„å¼€å§‹æ—¶é—´timeä¸oldçš„å¼€å§‹æ—¶é—´ç›¸ç­‰ï¼Œé‚£ä¹ˆè¯´æ˜oldå°±æ˜¯å½“å‰æ—¶é—´çª—å£ï¼Œç›´æ¥è¿”å›old
  - 4.3.å¦‚æœå½“å‰çª—å£çš„å¼€å§‹æ—¶é—´timeå¤§äºoldçš„å¼€å§‹æ—¶é—´ï¼Œåˆ™è¯´æ˜oldçª—å£å·²ç»è¿‡æ—¶äº†ï¼Œå°†oldçš„å¼€å§‹æ—¶é—´æ›´æ–°ä¸ºæœ€æ–°å€¼ï¼štimeï¼Œä¸‹ä¸ªå¾ªç¯ä¸­ä¼šåœ¨æ­¥éª¤4.2ä¸­è¿”å›
  - 4.4.å¦‚æœå½“å‰çª—å£çš„å¼€å§‹æ—¶é—´timeå°äºoldçš„å¼€å§‹æ—¶é—´ï¼Œå®é™…ä¸Šè¿™ç§æƒ…å†µæ˜¯ä¸å¯èƒ½å­˜åœ¨çš„ï¼Œå› ä¸ºtimeæ˜¯å½“å‰æ—¶é—´ï¼Œoldæ˜¯è¿‡å»çš„ä¸€ä¸ªæ—¶é—´

ä¸Šé¢çš„ä»£ç æœ‰ä¸ªæ¯”è¾ƒå®¹æ˜“æ··æ·†çš„åœ°æ–¹ï¼Œå°±æ˜¯è®¡ç®—å‡ºæ¥çš„å½“å‰æ—¶é—´çª—å£çš„å¼€å§‹æ—¶é—´ï¼Œæ²¡æœ‰ä½¿ç”¨ä¸€ä¸ªæ–°çš„å˜é‡æ¥è¡¨ç¤ºï¼Œè€Œæ˜¯ç›´æ¥ç”¨timeæ¥è¡¨ç¤ºã€‚

å¦å¤–timeIdæ˜¯ä¼šéšç€æ—¶é—´çš„å¢é•¿è€Œå¢åŠ ï¼Œå½“å‰æ—¶é—´æ¯å¢é•¿ä¸€ä¸ªwindowLengthçš„é•¿åº¦ï¼ŒtimeIdå°±åŠ 1ã€‚ä½†æ˜¯idxä¸ä¼šå¢é•¿ï¼Œåªä¼šåœ¨0å’Œ1ä¹‹é—´å˜æ¢ï¼Œå› ä¸ºarrayæ•°ç»„çš„é•¿åº¦æ˜¯2ï¼Œåªæœ‰ä¸¤ä¸ªé‡‡æ ·æ—¶é—´çª—å£ã€‚è‡³äºä¸ºä»€ä¹ˆé»˜è®¤åªæœ‰ä¸¤ä¸ªé‡‡æ ·çª—å£ï¼Œä¸ªäººè§‰å¾—å› ä¸ºsentinelæ˜¯æ¯”è¾ƒè½»é‡çš„æ¡†æ¶ã€‚æ—¶é—´çª—å£ä¸­ä¿å­˜ç€å¾ˆå¤šç»Ÿè®¡æ•°æ®ï¼Œå¦‚æœæ—¶é—´çª—å£è¿‡å¤šçš„è¯ï¼Œä¸€æ–¹é¢ä¼šå ç”¨è¿‡å¤šå†…å­˜ï¼Œå¦ä¸€æ–¹é¢æ—¶é—´çª—å£è¿‡å¤šå°±æ„å‘³ç€æ—¶é—´çª—å£çš„é•¿åº¦ä¼šå˜å°ï¼Œå¦‚æœæ—¶é—´çª—å£é•¿åº¦å˜å°ï¼Œå°±ä¼šå¯¼è‡´æ—¶é—´çª—å£è¿‡äºé¢‘ç¹çš„æ»‘åŠ¨ã€‚

ç»è¿‡åˆ†æï¼ŒåŠ ä¸Šæ³¨é‡Šï¼Œå¹¶å°†è¡¨ç¤ºå½“å‰çª—å£å¼€å§‹æ—¶é—´çš„timeå˜é‡ï¼Œé‡å‘½åæˆå…¶ä»–å˜é‡ï¼Œä½¿å¾—ä»£ç æ›´å…·å¯è¯»æ€§ï¼Œè°ƒæ•´åçš„ä»£ç å¦‚ä¸‹ï¼š

```Java
@Override
public WindowWrap<Window> currentWindow(long time) {
    // timeæ¯å¢åŠ ä¸€ä¸ªwindowLengthçš„é•¿åº¦ï¼ŒtimeIdå°±ä¼šå¢åŠ 1ï¼Œæ—¶é—´çª—å£å°±ä¼šå¾€å‰æ»‘åŠ¨ä¸€ä¸ª
    long timeId = time / windowLength;
    // Calculate current index.
    // idxè¢«åˆ†æˆ[0,arrayLength-1]ä¸­çš„æŸä¸€ä¸ªæ•°ï¼Œä½œä¸ºarrayæ•°ç»„ä¸­çš„ç´¢å¼•
    int idx = (int)(timeId % array.length());

    // Cut the time to current window start.
    long currentWindowStart = time - time % windowLength;

    while (true) {
        // ä»é‡‡æ ·æ•°ç»„ä¸­æ ¹æ®ç´¢å¼•è·å–ç¼“å­˜çš„æ—¶é—´çª—å£
        WindowWrap<Window> old = array.get(idx);
        // arrayæ•°ç»„é•¿åº¦ä¸å®œè¿‡å¤§ï¼Œå¦åˆ™oldå¾ˆå¤šæƒ…å†µä¸‹éƒ½å‘½ä¸­ä¸äº†ï¼Œå°±ä¼šåˆ›å»ºå¾ˆå¤šä¸ªWindowWrapå¯¹è±¡
        if (old == null) {
            // å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„
            WindowWrap<Window> window = new WindowWrap<Window>(windowLength, currentWindowStart, new Window());
            // é€šè¿‡CASå°†æ–°çª—å£è®¾ç½®åˆ°æ•°ç»„ä¸­å»
            if (array.compareAndSet(idx, null, window)) {
                // å¦‚æœèƒ½è®¾ç½®æˆåŠŸï¼Œåˆ™å°†è¯¥çª—å£è¿”å›
                return window;
            } else {
                // å¦åˆ™å½“å‰çº¿ç¨‹è®©å‡ºæ—¶é—´ç‰‡ï¼Œç­‰å¾…
                Thread.yield();
            }
        // å¦‚æœå½“å‰çª—å£çš„å¼€å§‹æ—¶é—´ä¸oldçš„å¼€å§‹æ—¶é—´ç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¿”å›oldçª—å£
        } else if (currentWindowStart == old.windowStart()) {
            return old;
        // å¦‚æœå½“å‰æ—¶é—´çª—å£çš„å¼€å§‹æ—¶é—´å·²ç»è¶…è¿‡äº†oldçª—å£çš„å¼€å§‹æ—¶é—´ï¼Œåˆ™æ”¾å¼ƒoldçª—å£
        // å¹¶å°†timeè®¾ç½®ä¸ºæ–°çš„æ—¶é—´çª—å£çš„å¼€å§‹æ—¶é—´ï¼Œæ­¤æ—¶çª—å£å‘å‰æ»‘åŠ¨
        } else if (currentWindowStart > old.windowStart()) {
            if (addLock.tryLock()) {
                try {
                    // if (old is deprecated) then [LOCK] resetTo currentTime.
                    return resetWindowTo(old, currentWindowStart);
                } finally {
                    addLock.unlock();
                }
            } else {
                Thread.yield();
            }
        // è¿™ä¸ªæ¡ä»¶ä¸å¯èƒ½å­˜åœ¨
        } else if (currentWindowStart < old.windowStart()) {
            // Cannot go through here.
            return new WindowWrap<Window>(windowLength, currentWindowStart, new Window());
        }
    }
}
```

## çœ‹å›¾ç†è§£

ä¸ºäº†æ›´å¥½çš„ç†è§£ï¼Œä¸‹é¢æˆ‘ç”¨å‡ å¹…å›¾æ¥æè¿°ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚



![img](https:////upload-images.jianshu.io/upload_images/5417792-d9fc9d343a355a30.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/890/format/jpeg)

slide-window-1.png

åˆå§‹çš„æ—¶å€™arraysæ•°ç»„ä¸­åªæœ‰ä¸€ä¸ªçª—å£(å¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬äºŒä¸ª)ï¼Œæ¯ä¸ªæ—¶é—´çª—å£çš„é•¿åº¦æ˜¯500msï¼Œè¿™å°±æ„å‘³ç€åªè¦å½“å‰æ—¶é—´ä¸æ—¶é—´çª—å£çš„å·®å€¼åœ¨500msä¹‹å†…ï¼Œæ—¶é—´çª—å£å°±ä¸ä¼šå‘å‰æ»‘åŠ¨ã€‚ä¾‹å¦‚ï¼Œå‡å¦‚å½“å‰æ—¶é—´èµ°åˆ°300æˆ–è€…500æ—¶ï¼Œå½“å‰æ—¶é—´çª—å£ä»ç„¶æ˜¯ç›¸åŒçš„é‚£ä¸ªï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-e055ad59c219baeb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

slide-window-2.png

æ—¶é—´ç»§ç»­å¾€å‰èµ°ï¼Œå½“è¶…è¿‡500msæ—¶ï¼Œæ—¶é—´çª—å£å°±ä¼šå‘å‰æ»‘åŠ¨åˆ°ä¸‹ä¸€ä¸ªï¼Œè¿™æ—¶å°±ä¼šæ›´æ–°å½“å‰çª—å£çš„å¼€å§‹æ—¶é—´ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-a06b5361316c9575.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

slide-window-3.png

æ—¶é—´ç»§ç»­å¾€å‰èµ°ï¼Œåªè¦ä¸è¶…è¿‡1000msï¼Œåˆ™å½“å‰çª—å£ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-fffdfa18779298c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

slide-window-4.png

å½“æ—¶é—´ç»§ç»­å¾€å‰èµ°ï¼Œå½“å‰æ—¶é—´è¶…è¿‡1000msæ—¶ï¼Œå°±ä¼šå†æ¬¡è¿›å…¥ä¸‹ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œæ­¤æ—¶arraysæ•°ç»„ä¸­çš„çª—å£å°†ä¼šæœ‰ä¸€ä¸ªå¤±æ•ˆï¼Œä¼šæœ‰å¦ä¸€ä¸ªæ–°çš„çª—å£è¿›è¡Œæ›¿æ¢ï¼š



![img](https:////upload-images.jianshu.io/upload_images/5417792-3d7cc1919a4f40f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/jpeg)

slide-window-5.png

ä»¥æ­¤ç±»æ¨éšç€æ—¶é—´çš„æµé€ï¼Œæ—¶é—´çª—å£ä¹Ÿåœ¨å‘ç”Ÿå˜åŒ–ï¼Œåœ¨å½“å‰æ—¶é—´ç‚¹ä¸­è¿›å…¥çš„è¯·æ±‚ï¼Œä¼šè¢«ç»Ÿè®¡åˆ°å½“å‰æ—¶é—´å¯¹åº”çš„æ—¶é—´çª—å£ä¸­ã€‚è®¡ç®—qpsæ—¶ï¼Œä¼šç”¨å½“å‰é‡‡æ ·çš„æ—¶é—´çª—å£ä¸­å¯¹åº”çš„æŒ‡æ ‡ç»Ÿè®¡å€¼é™¤ä»¥æ—¶é—´é—´éš”ï¼Œå°±æ˜¯å…·ä½“çš„qpsã€‚å…·ä½“çš„ä»£ç åœ¨StatisticNodeä¸­ï¼š

```Java
@Override
public long totalQps() {
    return passQps() + blockedQps();
}

@Override
public long blockedQps() {
    return rollingCounterInSecond.block() / IntervalProperty.INTERVAL;
}

@Override
public long passQps() {
    return rollingCounterInSecond.pass() / IntervalProperty.INTERVAL;
}
```

åˆ°è¿™é‡Œå°±åŸºæœ¬ä¸ŠæŠŠæ»‘åŠ¨çª—å£çš„åŸç†åˆ†ææ¸…æ¥šäº†ï¼Œè¿˜æœ‰ä¸æ¸…æ¥šçš„åœ°æ–¹ï¼Œæœ€å¥½èƒ½å¤Ÿå€ŸåŠ©ä»£ç ç»§ç»­åˆ†æä¸‹ï¼Œæœ€å¥½çš„åšæ³•å°±æ˜¯debugï¼Œè¿™é‡Œè´´ä¸€ä¸‹ç¬”è€…åœ¨åˆ†æ `currentWindow` æ–¹æ³•æ—¶é‡‡å–çš„æµ‹è¯•ä»£ç ï¼š

```Java
public static void main(String[] args) throws InterruptedException {
    int windowLength = 500;
    int arrayLength = 2;
    calculate(windowLength,arrayLength);

    Thread.sleep(100);
    calculate(windowLength,arrayLength);

    Thread.sleep(200);
    calculate(windowLength,arrayLength);

    Thread.sleep(200);
    calculate(windowLength,arrayLength);

    Thread.sleep(500);
    calculate(windowLength,arrayLength);

    Thread.sleep(500);
    calculate(windowLength,arrayLength);

    Thread.sleep(500);
    calculate(windowLength,arrayLength);

    Thread.sleep(500);
    calculate(windowLength,arrayLength);

    Thread.sleep(500);
    calculate(windowLength,arrayLength);
}

private static void calculate(int windowLength,int arrayLength){
    long time = System.currentTimeMillis();
    long timeId = time/windowLength;
    long currentWindowStart = time - time % windowLength;
    int idx = (int)(timeId % arrayLength);
    System.out.println("time="+time+",currentWindowStart="+currentWindowStart+",timeId="+timeId+",idx="+idx);
}
```

è¿™é‡Œå‡è®¾æ—¶é—´çª—å£çš„é•¿åº¦ä¸º500msï¼Œæ•°ç»„çš„å¤§å°ä¸º2ï¼Œå½“å‰æ—¶é—´ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œè®¡ç®—å‡ºå½“å‰æ—¶é—´çª—å£çš„timeIdã€windowStartã€idxç­‰å€¼ã€‚æ‰§è¡Œä¸Šé¢çš„ä»£ç åï¼Œå°†æ‰“å°å‡ºå¦‚ä¸‹çš„ç»“æœï¼š

```
time=1540629334619,currentWindowStart=1540629334500,timeId=3081258669,idx=1
time=1540629334721,currentWindowStart=1540629334500,timeId=3081258669,idx=1
time=1540629334924,currentWindowStart=1540629334500,timeId=3081258669,idx=1
time=1540629335129,currentWindowStart=1540629335000,timeId=3081258670,idx=0
time=1540629335633,currentWindowStart=1540629335500,timeId=3081258671,idx=1
time=1540629336137,currentWindowStart=1540629336000,timeId=3081258672,idx=0
time=1540629336641,currentWindowStart=1540629336500,timeId=3081258673,idx=1
time=1540629337145,currentWindowStart=1540629337000,timeId=3081258674,idx=0
time=1540629337649,currentWindowStart=1540629337500,timeId=3081258675,idx=1
```

å¯ä»¥çœ‹å‡ºæ¥ï¼ŒwindowStartæ¯å¢åŠ 500msï¼ŒtimeIdå°±åŠ 1ï¼Œè¿™æ—¶å°±æ˜¯æ—¶é—´çª—å£å‘ç”Ÿæ»‘åŠ¨çš„æ—¶å€™ã€‚