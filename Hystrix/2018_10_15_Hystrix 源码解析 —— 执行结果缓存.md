title: Hystrix æºç è§£æ â€”â€” æ‰§è¡Œç»“æœç¼“å­˜
date: 2018-10-15
tags:
categories: Hystrix
permalink: Hystrix/command-execute-result-cache

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-result-cache/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬**  

- [1. æ¦‚è¿°](http://www.iocoder.cn/Hystrix/command-execute-result-cache/)
- [2. å¥½å¤„](http://www.iocoder.cn/Hystrix/command-execute-result-cache/)
- [3. Observable#defer(...)](http://www.iocoder.cn/Hystrix/command-execute-result-cache/)
- [4. AbstractCommand#toObservavle(...)](http://www.iocoder.cn/Hystrix/command-execute-result-cache/)
- [5. HystrixCachedObservable](http://www.iocoder.cn/Hystrix/command-execute-result-cache/)
- [6. HystrixCommandResponseFromCache](http://www.iocoder.cn/Hystrix/command-execute-result-cache/)
- [666. å½©è›‹](http://www.iocoder.cn/Hystrix/command-execute-result-cache/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---


# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Hystrix æ‰§è¡Œå‘½ä»¤çš„ç»“æœç¼“å­˜**ã€‚

å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚

Hystrix æ‰§è¡Œå‘½ä»¤æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š

> FROM [ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œæµç¨‹å›¾ã€](http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#æµç¨‹å›¾)  
> ![](http://www.iocoder.cn/images/Hystrix/2018_10_15/01.jpeg)

* çº¢åœˆ ï¼šåœ¨ [ã€ŠHystrix æºç è§£æ â€”â€” æ‰§è¡Œå‘½ä»¤æ–¹å¼ã€‹](http://www.iocoder.cn/Hystrix/command-execute-mode/?self) æœ‰è¯¦ç»†è§£æã€‚
* ç´«åœˆ ï¼šåœ¨ `#toObservable()` æ–¹æ³•é‡Œï¼Œå¦‚æœè¯·æ±‚ç»“æœç¼“å­˜è¿™ä¸ªç‰¹æ€§è¢«**å¯ç”¨**ï¼Œå¹¶ä¸”**ç¼“å­˜å‘½ä¸­**ï¼Œåˆ™ç¼“å­˜çš„å›åº”ä¼šç«‹å³é€šè¿‡ä¸€ä¸ª Observable å¯¹è±¡çš„å½¢å¼è¿”å›ï¼›å¦‚æœ**ç¼“å­˜æœªå‘½ä¸­**ï¼Œåˆ™è¿”å›ã€**è®¢é˜…äº†æ‰§è¡Œå‘½ä»¤çš„ Observable**ã€‘çš„ ReplySubject å¯¹è±¡ç¼“å­˜æ‰§è¡Œç»“æœã€‚
    * ReplySubject èƒ½å¤Ÿ**é‡æ”¾**æ‰§è¡Œç»“æœï¼Œä»è€Œå®ç°ç¼“å­˜çš„åŠŸæ•ˆã€‚æœ¬æ–‡ä¸å¯¹ ReplySubject åšå¤ªå¤šæ‹“å±•ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» [ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” Subjectã€‹](https://mcxiaoke.gitbooks.io/rxdocs/content/Subject.html) ã€‚

åœ¨å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ [CommandUsingRequestCache](https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandUsingRequestCache.java) è¿›è¡Œè°ƒè¯• ã€‚

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)
* ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚



# 2. å¥½å¤„

ç‚¹å‡» [ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œè¯·æ±‚ç¼“å­˜ã€](http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#è¯·æ±‚ç¼“å­˜) ï¼ŒæŸ¥çœ‹å¯¹**è¯·æ±‚ç¼“å­˜**çš„å¥½å¤„åˆ†äº«ï¼Œå†™çš„çœŸçš„å¾ˆèµã€‚

# 3. Observable#defer(...)

æœ¬å°èŠ‚ä¸º**æ‹“å±•å†…å®¹**ï¼Œæºç è§£æ RxJava ( é Hystrix ) çš„ `Observable#defer(...)` çš„æ–¹æ³•å®ç°ã€‚è€ƒè™‘åˆ° Hystrix å¤§é‡ä½¿ç”¨ï¼Œä¸ºäº†æ›´å¥½çš„ç†è§£ï¼Œè§£æä¸‹æºç ã€‚

[ã€ŠRxJava æºç è§£æ â€”â€” Observable#defer(...)ã€‹](http://www.iocoder.cn/RxJava/observable-defer/)

# 4. AbstractCommand#toObservavle(...)

`AbstractCommand#toObservavle(...)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: public Observable<R> toObservable() {
  2:     final AbstractCommand<R> _cmd = this;
  3: 
  4:     //doOnCompleted handler already did all of the SUCCESS work
  5:     //doOnError handler already did all of the FAILURE/TIMEOUT/REJECTION/BAD_REQUEST work
  6:     final Action0 terminateCommandCleanup = new Action0() {} // ... çœç•¥
  7: 
  8:     //mark the command as CANCELLED and store the latency (in addition to standard cleanup)
  9:     final Action0 unsubscribeCommandCleanup = new Action0() {} // ... çœç•¥
 10: 
 11:     final Func0<Observable<R>> applyHystrixSemantics = new Func0<Observable<R>>() {
 12:         @Override
 13:         public Observable<R> call() {
 14:             if (commandState.get().equals(CommandState.UNSUBSCRIBED)) {
 15:                 return Observable.never();
 16:             }
 17:             return applyHystrixSemantics(_cmd);
 18:         }
 19:     };
 20: 
 21:     final Func1<R, R> wrapWithAllOnNextHooks = new Func1<R, R>() {} // ... çœç•¥ 
 22: 
 23:     final Action0 fireOnCompletedHook = new Action0() {} // ... çœç•¥ 
 24: 
 25:     return Observable.defer(new Func0<Observable<R>>() {
 26:         @Override
 27:         public Observable<R> call() {
 28:             /* this is a stateful object so can only be used once */
 29:             if (!commandState.compareAndSet(CommandState.NOT_STARTED, CommandState.OBSERVABLE_CHAIN_CREATED)) {
 30:                 IllegalStateException ex = new IllegalStateException("This instance can only be executed once. Please instantiate a new instance.");
 31:                 //TODO make a new error type for this
 32:                 throw new HystrixRuntimeException(FailureType.BAD_REQUEST_EXCEPTION, _cmd.getClass(), getLogMessagePrefix() + " command executed multiple times - this is not permitted.", ex, null);
 33:             }
 34: 
 35:             // å‘½ä»¤å¼€å§‹æ—¶é—´æˆ³
 36:             commandStartTimestamp = System.currentTimeMillis();
 37: 
 38:             // TODOã€2001ã€‘ã€æ‰“å°æ—¥å¿—ã€‘
 39:             if (properties.requestLogEnabled().get()) {
 40:                 // log this command execution regardless of what happened
 41:                 if (currentRequestLog != null) {
 42:                     currentRequestLog.addExecutedCommand(_cmd);
 43:                 }
 44:             }
 45: 
 46:             // ç¼“å­˜å¼€å…³ã€ç¼“å­˜KEY
 47:             final boolean requestCacheEnabled = isRequestCachingEnabled();
 48:             final String cacheKey = getCacheKey();
 49: 
 50:             // ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–
 51:             /* try from cache first */
 52:             if (requestCacheEnabled) {
 53:                 HystrixCommandResponseFromCache<R> fromCache = (HystrixCommandResponseFromCache<R>) requestCache.get(cacheKey);
 54:                 if (fromCache != null) {
 55:                     isResponseFromCache = true; // æ ‡è®° ä»ç¼“å­˜ä¸­ç»“æœ
 56:                     return handleRequestCacheHitAndEmitValues(fromCache, _cmd);
 57:                 }
 58:             }
 59: 
 60:             // è·å¾— æ‰§è¡Œå‘½ä»¤Observable
 61:             Observable<R> hystrixObservable =
 62:                     Observable.defer(applyHystrixSemantics)
 63:                             .map(wrapWithAllOnNextHooks);
 64: 
 65:             // è·å¾— ç¼“å­˜Observable
 66:             Observable<R> afterCache;
 67:             // put in cache
 68:             if (requestCacheEnabled && cacheKey != null) {
 69:                 // wrap it for caching
 70:                 HystrixCachedObservable<R> toCache = HystrixCachedObservable.from(hystrixObservable, _cmd);
 71:                 // å¹¶å‘è‹¥ä¸å­˜åœ¨
 72:                 HystrixCommandResponseFromCache<R> fromCache = (HystrixCommandResponseFromCache<R>) requestCache.putIfAbsent(cacheKey, toCache);
 73:                 if (fromCache != null) { // æ·»åŠ å¤±è´¥
 74:                     // another thread beat us so we'll use the cached value instead
 75:                     toCache.unsubscribe();
 76:                     isResponseFromCache = true; // æ ‡è®° ä»ç¼“å­˜ä¸­ç»“æœ
 77:                     return handleRequestCacheHitAndEmitValues(fromCache, _cmd);
 78:                 } else { // æ·»åŠ æˆåŠŸ
 79:                     // we just created an ObservableCommand so we cast and return it
 80:                     afterCache = toCache.toObservable();
 81:                 }
 82:             } else {
 83:                 afterCache = hystrixObservable;
 84:             }
 85: 
 86:             //
 87:             return afterCache
 88:                     .doOnTerminate(terminateCommandCleanup)     // perform cleanup once (either on normal terminal state (this line), or unsubscribe (next line))
 89:                     .doOnUnsubscribe(unsubscribeCommandCleanup) // perform cleanup once
 90:                     .doOnCompleted(fireOnCompletedHook);
 91:         }
 92:     });
 93: }
```

* ç¬¬ 2 è¡Œ ï¼š`_cmd` æŒ‡å‘å½“å‰å‘½ä»¤å¯¹è±¡ï¼Œç”¨äºä¸‹é¢å®ç° FuncX ï¼ŒActionX å†…éƒ¨ç±»ä½¿ç”¨ã€‚
* ç¬¬ 11 è‡³ 19 è¡Œ ï¼šå½“ç¼“å­˜ç‰¹æ€§**æœªå¼€å¯**ï¼Œæˆ–è€…ç¼“å­˜**æœªå‘½ä¸­**æ—¶ï¼Œä½¿ç”¨ `applyHystrixSemantics` ä¼ å…¥ `Observable#defer(...)` æ–¹æ³•ï¼Œå£°æ˜**æ‰§è¡Œå‘½ä»¤**çš„ Observableã€‚
* ç¬¬ 25 è¡Œ ï¼šå£°æ˜ç¼“å­˜ Observable ã€‚Hystrix æ‰§è¡Œå‘½ä»¤çš„ Observable å£°æ˜å…³ç³»å¦‚ä¸‹ï¼š

    ![](http://www.iocoder.cn/images/Hystrix/2018_10_15/02.png)

* ç¬¬ 29 è‡³ 33 è¡Œ ï¼š**ä¸€æ¡å‘½ä»¤åªèƒ½æ‰§è¡Œä¸€æ¬¡**ã€‚
* ç¬¬ 36 è¡Œ ï¼šè®°å½•å‘½ä»¤**å¼€å§‹**æ—¶é—´æˆ³ã€‚
* ç¬¬ 38 è‡³ 44 è¡Œ ï¼šTODOã€2001ã€‘ã€æ‰“å°æ—¥å¿—ã€‘
* ç¬¬ 47 è‡³ 48 è¡Œ ï¼šç¼“å­˜å­˜å¼€å…³ã€KEY ã€‚
* ç¬¬ 52 è‡³ 58 è¡Œ ï¼šå¦‚æœè¯·æ±‚ç»“æœç¼“å­˜è¿™ä¸ªç‰¹æ€§è¢«**å¯ç”¨**ï¼Œå¹¶ä¸”**ç¼“å­˜å‘½ä¸­**ï¼Œåˆ™ç¼“å­˜çš„å›åº”ä¼šç«‹å³é€šè¿‡ä¸€ä¸ª Observable å¯¹è±¡çš„å½¢å¼è¿”å›ã€‚
    * ç¬¬ 53 è¡Œ ï¼š`requestCache` ç¼“å­˜ï¼Œåœ¨ [TODO ã€2008ã€‘ã€è¯·æ±‚ç¼“å­˜ã€‘](#) è¯¦ç»†è§£æã€‚
    * ç¬¬ 53 è¡Œ ï¼š[ã€Œ6. HystrixCommandResponseFromCacheã€](#) è¯¦ç»†è§£æã€‚
    * ç¬¬ 56 è¡Œ ï¼š`#handleRequestCacheHitAndEmitValues(...)` æ–¹æ³•ï¼Œåœ¨**ç¬¬ 78 è¡Œ**è¯¦ç»†è§£æã€‚
* ç¬¬ 61 è‡³ 63 è¡Œ ï¼šè·å–**æ‰§è¡Œå‘½ä»¤**çš„ Observable ã€‚åœ¨ [ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹](http://www.iocoder.cn/Hystrix/command-execute-first-run/?self) è¯¦ç»†è§£æã€‚
* ç¬¬ 68 è‡³ 81 è¡Œ ï¼šå½“ç¼“å­˜ç‰¹æ€§**å¼€å¯**ï¼Œå¹¶ä¸”ç¼“å­˜**æœªå‘½ä¸­**æ—¶ï¼Œåˆ›å»ºã€**è®¢é˜…äº†æ‰§è¡Œå‘½ä»¤çš„ Observable**ã€‘çš„ HystrixCommandResponseFromCache ã€‚
    * ç¬¬ 69 è‡³ 72 è¡Œ ï¼šåˆ›å»º HystrixCommandResponseFromCache ï¼Œå¹¶æ·»åŠ åˆ° `requestCache` ã€‚å“Ÿï¼Œ`HystrixRequestCache#putIfAbsent(...)` æ–¹æ³•ï¼Œ**å¤šä¸ªçº¿ç¨‹**æ·»åŠ æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ·»åŠ æˆåŠŸã€‚
    * ç¬¬ 73 è‡³ 77 è¡Œ ï¼šæ·»åŠ **å¤±è´¥**çš„çº¿ç¨‹( **ä»¬** )ï¼š
        * ç¬¬ 75 è¡Œ ï¼šè°ƒç”¨ `HystrixCommandResponseFromCache#unsubscribe()` æ–¹æ³•ï¼Œå–æ¶ˆ HystrixCommandResponseFromCache çš„è®¢é˜…ã€‚è¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œå› ä¸ºæˆ‘ä»¬**ä¸å¸Œæœ›ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹å»æ‰§è¡Œå‘½ä»¤ï¼Œæœ€å¥½æœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå‘½ä»¤**ã€‚åœ¨ [ã€Œ5. HystrixCachedObservableã€](#) è¯¦ç»†è§£æã€‚
        * ç¬¬ 77 è¡Œ ï¼š[ã€Œ6. HystrixCommandResponseFromCacheã€](#) è¯¦ç»†è§£æã€‚
   * ç¬¬ 80 è¡Œ ï¼šè°ƒç”¨ `HystrixCommandResponseFromCachetoObservable()` æ–¹æ³•ï¼Œè·å¾—ç¼“å­˜ Observable ã€‚
* ç¬¬ 82 è‡³ 84 è¡Œ ï¼šå½“ç¼“å­˜ç‰¹æ€§**æœªå¼€å¯**ï¼Œä½¿ç”¨æ‰§è¡Œå‘½ä»¤ Observable ã€‚
* ç¬¬ 87 è‡³ 91 è¡Œ ï¼šåœ¨è¿”å›çš„ Observable ä¸Šï¼Œè®¢é˜…ä¸€äº›æ¸…ç†çš„å¤„ç†é€»è¾‘ã€‚å¯¹è¿™å‡ ä¸ªæ–¹æ³•æœ‰ç–‘æƒ‘çš„åŒå­¦ï¼Œå¯ä»¥é˜…è¯» [ã€Šç»™ Android å¼€å‘è€…çš„ RxJava è¯¦è§£ã€‹ã€Œ 3) Subscribe (è®¢é˜…) ã€](http://gank.io/post/560e15be2dca930e00da1083#toc_10) ã€‚

# 5. HystrixCachedObservable

`com.netflix.hystrix.HystrixCachedObservable` ï¼Œç¼“å­˜ Observable ã€‚

HystrixCachedObservable **æ„é€ æ–¹æ³•**ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: public class HystrixCachedObservable<R> {
  2: /**
  3:  * è®¢é˜…
  4:  */
  5: protected final Subscription originalSubscription;
  6: /**
  7:  * ç¼“å­˜ cachedObservable
  8:  */
  9: protected final Observable<R> cachedObservable;
 10: /**
 11:  * TODO ã€2006ã€‘ã€outstandingSubscriptionsã€‘
 12:  */
 13: private volatile int outstandingSubscriptions = 0;
 14: //private AtomicInteger outstandingSubscriptions2 = new AtomicInteger(0);
 15: 
 16: protected HystrixCachedObservable(final Observable<R> originalObservable) {
 17:     ReplaySubject<R> replaySubject = ReplaySubject.create();
 18:     this.originalSubscription = originalObservable
 19:             .subscribe(replaySubject);
 20: 
 21:     this.cachedObservable = replaySubject
 22:             .doOnUnsubscribe(new Action0() {
 23:                 @Override
 24:                 public void call() {
 25:                     outstandingSubscriptions--;
 26:                     if (outstandingSubscriptions == 0) {
 27:                         originalSubscription.unsubscribe();
 28:                     }
 29:                 }
 30:             })
 31:             .doOnSubscribe(new Action0() {
 32:                 @Override
 33:                 public void call() {
 34:                     outstandingSubscriptions++;
 35:                 }
 36:             });
 37: }
```

* ç¬¬ 17 è‡³ 19 è¡Œ ï¼šå®é™…ä¸Šï¼Œ**HystrixCachedObservable ä¸æ˜¯ä¸€ä¸ª Observable çš„å­ç±»**ï¼Œè€Œæ˜¯å¯¹ä¼ å…¥çš„ Observable **å°è£…** ï¼šä½¿ç”¨ ReplaySubject å‘ä¼ å…¥çš„ Observable å‘èµ·è®¢é˜…ï¼Œé€šè¿‡ ReplaySubject èƒ½å¤Ÿ**é‡æ”¾**æ‰§è¡Œç»“æœï¼Œä»è€Œå®ç°ç¼“å­˜çš„åŠŸæ•ˆã€‚è¿™é‡Œæœ‰å‡ ä¸ªå¡åˆ°ç¬”è€…çš„å¹¶ä¸”å¾ˆæœ‰è¶£çš„ç‚¹ï¼Œæˆ‘ä»¬ä¸€ä¸€é“æ¥ ï¼šä»ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥çš„ `originalObservable` ä¸º `hystrixObservable` æ‰§è¡Œå‘½ä»¤ Observable ã€‚åœ¨ Hystrix é‡Œï¼Œæä¾›äº†ä¸¤ç§æ‰§è¡Œå‘½ä»¤çš„éš”ç¦»æ–¹å¼ ï¼šçº¿ç¨‹æ± ( `THREAD` ) å’Œä¿¡å·é‡( `SEMAPHORE` )ã€‚
    * å½“ä½¿ç”¨ `THREAD` éš”ç¦»æ—¶ï¼Œ`#subscribe(replaySubject)` è°ƒç”¨å®Œæˆæ—¶ï¼Œ**å®é™…å‘½ä»¤å¹¶æœªå¼€å§‹æ‰§è¡Œ**ï¼Œæˆ–è€…è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª**å¼‚æ­¥**çš„æ‰§è¡Œå‘½ä»¤çš„è¿‡ç¨‹ã€‚é‚£ä¹ˆï¼Œ**ä¼šä¸ä¼šå½±å“è¿”å›æ‰§è¡Œç»“æœå‘¢**ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯ä¸ä¼šï¼ŒBlockingObservable åœ¨å¾—åˆ°æ‰§è¡Œå®Œæˆæ‰ä¼š**ç»“æŸé˜»å¡**ï¼Œæ­¤æ—¶å·²ç»æœ‰æ‰§è¡Œç»“æœã€‚
    * å½“ä½¿ç”¨ `SEMAPHORE` éš”ç¦»æ—¶ï¼Œ`#subscribe(replaySubject)` è°ƒç”¨å®Œæˆæ—¶ï¼Œ**å®é™…å‘½ä»¤å·²ç»æ‰§è¡Œå®Œæˆ**ï¼Œæ‰€ä»¥å³ä½¿ `AbstractCommand#toObservavle(...)` çš„ç¬¬ 75 è¡Œ ï¼šè°ƒç”¨ `HystrixCommandResponseFromCache#unsubscribe()` æ–¹æ³•ï¼Œä¹Ÿä¼šæµªè´¹ï¼Œ**é‡å¤**æ‰§è¡Œå‘½ä»¤ã€‚è€Œå¯¹äº `THREAD` éš”ç¦»çš„æƒ…å†µï¼Œé€šè¿‡å–æ¶ˆè®¢é˜…çš„æ–¹å¼ï¼Œåªä¼šæ‰§è¡Œ**ä¸€æ¬¡**å‘½ä»¤ã€‚å½“ç„¶ï¼Œå¦‚æœâ€œæ¶æâ€ `THREAD` éš”ç¦»çš„æƒ…å†µï¼Œå¢åŠ  `sleep` çš„è°ƒç”¨å¦‚ä¸‹ï¼Œå°±èƒ½è¾¾åˆ°**é‡å¤**æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœã€‚

        ![](http://www.iocoder.cn/images/Hystrix/2018_10_15/03.png)

* ç¬¬ 21 è‡³ 36 è¡Œ ï¼šTODO ã€2006ã€‘ã€outstandingSubscriptionsã€‘åŸå­æ€§æ²¡é—®é¢˜ä¹ˆï¼Ÿå†å²ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯ AtomicInteger ã€‚

-------

HystrixCachedObservable çš„å…¶ä»–æ–¹æ³•ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCachedObservable.java) æŸ¥çœ‹ã€‚
    
# 6. HystrixCommandResponseFromCache

`com.netflix.hystrix.HystrixCommandResponseFromCache` ï¼Œæ˜¯ HystrixCachedObservable çš„å­ç±»ã€‚åœ¨çˆ¶ç±»çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å¯¹ `AbstractCommand.executionResult` çš„å…³æ³¨ã€‚

`HystrixCachedObservable#from(Observable, AbstractCommand)` æ–¹æ³•ï¼Œåˆ›å»º HystrixCommandResponseFromCache å¯¹è±¡ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCachedObservable.java#L36) æŸ¥çœ‹ã€‚

-------

`HystrixCommandResponseFromCache#toObservableWithStateCopiedInto(...)` æ–¹æ³•ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommandResponseFromCache.java#L17) æŸ¥çœ‹ã€‚

* é€šè¿‡ `completionLogicRun` å±æ€§ï¼Œä¿è¯ `#doOnError()` ï¼Œ`#doOnCompleted()` ï¼Œ`#doOnUnsubscribe()` æ–¹æ³•æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå…·ä½“é€»è¾‘ã€‚
    * `#doOnError()` ï¼Œ`#doOnCompleted()` æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ `#commandCompleted()` æ–¹æ³•ï¼Œä»ç¼“å­˜å‘½ä»¤( `HystrixCommandResponseFromCache.originalCommand` ) å¤åˆ¶ `executionResult` å±æ€§ç»™å½“å‰å‘½ä»¤( `commandToCopyStateInto` ) ã€‚
    * `#doOnUnsubscribe()` æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ `#commandUnsubscribed()` æ–¹æ³•ï¼Œä½¿ç”¨å½“å‰å‘½ä»¤( `commandToCopyStateInto` )**è‡ªå·±**çš„ `executionResult` ï¼Œä¸è¿›è¡Œå¤åˆ¶ã€‚
* TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

å¦‚é² åœ¨å–‰çš„æ„Ÿè§‰ï¼Œä»å‘¨å…­å¼€å§‹ç£¨äº†å››å¤©å¤šï¼Œä¸€ç›´æ²¡å†™åˆ°ä¸€ä¸ªæ¯”è¾ƒèˆ’æœçš„çŠ¶æ€ã€‚

å…ˆå‘ç°å‘ï¼Œå¦‚æœæœ‰ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œçƒ¦è¯·æŒ‡å‡ºï¼Œè°¢è°¢ã€‚

èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼


