title: Hystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥
date: 2018-10-25
tags:
categories: Hystrix
permalink: Hystrix/command-execute-second-isolation-strategy

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬**  

- [1. æ¦‚è¿°](http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/)
- [2. HystrixThreadPoolProperties](http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/)
- [3. HystrixThreadPoolKey](http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/)
- [4. HystrixConcurrencyStrategy](http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/)
- [5. HystrixThreadPool](http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/)
- [6. HystrixScheduler](http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/)
- [666. å½©è›‹](http://www.iocoder.cn/Hystrix/command-execute-second-isolation-strategy/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Hystrix å‘½ä»¤æ‰§è¡Œï¼ˆäºŒï¼‰ä¹‹æ‰§è¡Œéš”ç¦»ç­–ç•¥**ã€‚

å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚

Hystrix æä¾›ä¸¤ç§æ‰§è¡Œéš”ç¦»ç­–ç•¥( ExecutionIsolationStrategy ) ï¼š

* `SEMAPHORE` ï¼šä¿¡å·é‡ï¼Œå‘½ä»¤åœ¨**è°ƒç”¨çº¿ç¨‹**æ‰§è¡Œã€‚åœ¨[ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ3. TryableSemaphoreã€](http://www.iocoder.cn/Hystrix/command-execute-first-run/?self) å·²ç»è¯¦ç»†è§£æã€‚
* `THREAD` ï¼šçº¿ç¨‹æ± ï¼Œå‘½ä»¤åœ¨**çº¿ç¨‹æ± **æ‰§è¡Œã€‚åœ¨[ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ5. #executeCommandWithSpecifiedIsolation(...)ã€](http://www.iocoder.cn/Hystrix/command-execute-first-run/?self) çš„ `#executeCommandWithSpecifiedIsolation(...)` æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `Observable#subscribeOn(Scheduler)` æ–¹æ³•ï¼ŒæŒ‡å®šåœ¨ RxJava Scheduler æ‰§è¡Œã€‚
    * å¦‚æœä½ æš‚æ—¶ä¸äº†è§£ Scheduler ï¼Œå¯ä»¥é˜…è¯» [ã€ŠRxJava æºç è§£æ â€”â€” Schedulerã€‹](http://www.iocoder.cn/RxJava/scheduler/?self) ã€‚
    * å¦‚æœä½ æš‚æ—¶ä¸äº†è§£ `Observable#subscribeOn(Scheduler)` ï¼Œå¯ä»¥é˜…è¯» [ã€ŠRxJava æºç è§£æ â€”â€” Observable#subscribeOn(Scheduler)ã€‹](http://www.iocoder.cn/RxJava/observable-subscribe-on-scheduler/?self) ã€‚

ä¸¤ç§æ–¹å¼çš„**ä¼˜ç¼ºç‚¹æ¯”è¾ƒ**ï¼Œæ¨èé˜…è¯» [ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œä¾èµ–éš”ç¦»ã€](http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#ä¾èµ–éš”ç¦»)ã€‚

-------

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)
* ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚



# 2. HystrixThreadPoolProperties

`com.netflix.hystrix.HystrixThreadPoolProperties` ï¼ŒHystrix çº¿ç¨‹æ± å±æ€§é…ç½®**æŠ½è±¡ç±»**ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/ba86690747b365482c306ec3a0725e0be4bab739/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPoolProperties.java) æŸ¥çœ‹ï¼Œå·²æ·»åŠ ä¸­æ–‡æ³¨é‡Šè¯´æ˜ã€‚

`com.netflix.hystrix.strategy.properties.HystrixPropertiesThreadPoolDefault` ï¼ŒHystrix çº¿ç¨‹æ± é…ç½®**å®ç°ç±»**ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/ba86690747b365482c306ec3a0725e0be4bab739/hystrix-core/src/main/java/com/netflix/hystrix/strategy/properties/HystrixPropertiesThreadPoolDefault.java) æŸ¥çœ‹ã€‚å®é™…ä¸Šæ²¡ä»€ä¹ˆå†…å®¹ï¼Œå®˜æ–¹å¦‚æ˜¯è¯´ ï¼š

> Default implementation of {@link HystrixThreadPoolProperties} using Archaius (https://github.com/Netflix/archaius)

# 3. HystrixThreadPoolKey

`com.netflix.hystrix.HystrixThreadPoolKey` ï¼ŒHystrix çº¿ç¨‹æ± æ ‡è¯†**æ¥å£**ã€‚

> FROM HystrixThreadPoolKey æ¥å£æ³¨é‡Š  
> A key to represent a {@link HystrixThreadPool} for monitoring, metrics publishing, caching and other such uses.  
> This interface is intended to work natively with Enums so that implementing code can be an enum that implements this interface.

* ç›´ç™½çš„è¯´ ï¼Œå¸Œæœ›é€šè¿‡ç›¸åŒçš„ `name` ( æ ‡è¯† ) è·å¾—åŒ HystrixThreadPoolKey å¯¹è±¡ã€‚é€šè¿‡åœ¨å†…éƒ¨ç»´æŒä¸€ä¸ª `name` ä¸ HystrixThreadPoolKey å¯¹è±¡çš„æ˜ å°„ï¼Œä»¥è¾¾åˆ°**æšä¸¾**çš„æ•ˆæœã€‚

HystrixThreadPoolKey ä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: public interface HystrixThreadPoolKey extends HystrixKey {
  2:     class Factory {
  3:         private Factory() {
  4:         }
  5: 
  6:         // used to intern instances so we don't keep re-creating them millions of times for the same key
  7:         private static final InternMap<String, HystrixThreadPoolKey> intern
  8:                 = new InternMap<String, HystrixThreadPoolKey>(
  9:                 new InternMap.ValueConstructor<String, HystrixThreadPoolKey>() {
 10:                     @Override
 11:                     public HystrixThreadPoolKey create(String key) {
 12:                         return new HystrixThreadPoolKeyDefault(key);
 13:                     }
 14:                 });
 15: 
 16:         public static HystrixThreadPoolKey asKey(String name) {
 17:            return intern.interned(name);
 18:         }
 19: 
 20:         private static class HystrixThreadPoolKeyDefault extends HystrixKeyDefault implements HystrixThreadPoolKey {
 21:             public HystrixThreadPoolKeyDefault(String name) {
 22:                 super(name);
 23:             }
 24:         }
 25: 
 26:         /* package-private */ static int getThreadPoolCount() {
 27:             return intern.size();
 28:         }
 29:     }
 30: }
```

* HystrixThreadPoolKey å®ç° `com.netflix.hystrix.HystrixKey` **æ¥å£**ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/Netflix/Hystrix/blob/d838f4d1ba65ce55755ab1c73f74c980f04572bf/hystrix-core/src/main/java/com/netflix/hystrix/HystrixKey.java#L6) æŸ¥çœ‹ã€‚è¯¥æ¥å£å®šä¹‰çš„ `#name()` æ–¹æ³•ï¼Œå³æ˜¯ä¸Šæ–‡æˆ‘ä»¬æ‰€è¯´çš„æ ‡è¯†( Key )ã€‚
* `intern` å±æ€§ï¼Œ`name` ä¸ HystrixThreadPoolKey å¯¹è±¡çš„æ˜ å°„ï¼Œä»¥è¾¾åˆ°**æšä¸¾**çš„æ•ˆæœã€‚
    * `com.netflix.hystrix.util.InternMap` ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/util/InternMap.java) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ä»£ç ã€‚
* `#asKey(name)` æ–¹æ³•ï¼Œä» `intern` è·å¾— HystrixThreadPoolKey å¯¹è±¡ã€‚
* `#getThreadPoolCount()` æ–¹æ³•ï¼Œè·å¾— HystrixThreadPoolKey æ•°é‡ã€‚

-------

åœ¨ AbstractCommand **æ„é€ æ–¹æ³•**é‡Œï¼Œåˆå§‹åŒ–å‘½ä»¤çš„ `threadPoolKey` å±æ€§ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
protected final HystrixThreadPoolKey threadPoolKey;

protected AbstractCommand(HystrixCommandGroupKey group, HystrixCommandKey key, HystrixThreadPoolKey threadPoolKey, HystrixCircuitBreaker circuitBreaker, HystrixThreadPool threadPool,
       HystrixCommandProperties.Setter commandPropertiesDefaults, HystrixThreadPoolProperties.Setter threadPoolPropertiesDefaults,
       HystrixCommandMetrics metrics, TryableSemaphore fallbackSemaphore, TryableSemaphore executionSemaphore,
       HystrixPropertiesStrategy propertiesStrategy, HystrixCommandExecutionHook executionHook) {

   // ... çœç•¥æ— å…³ä»£ç 

   this.commandGroup = initGroupKey(group);
   this.commandKey = initCommandKey(key, getClass());
   this.properties = initCommandProperties(this.commandKey, propertiesStrategy, commandPropertiesDefaults);
   // åˆå§‹åŒ– threadPoolKey
   this.threadPoolKey = initThreadPoolKey(threadPoolKey, this.commandGroup, this.properties.executionIsolationThreadPoolKeyOverride().get());

}
```

* è°ƒç”¨ `#initThreadPoolKey(...)` æ–¹æ³•ï¼Œåˆ›å»ºæœ€ç»ˆçš„ `threadPoolKey` å±æ€§ã€‚ä»£ç å¦‚ä¸‹ ï¼š

    ```Java
    private static HystrixThreadPoolKey initThreadPoolKey(HystrixThreadPoolKey threadPoolKey, HystrixCommandGroupKey groupKey, String threadPoolKeyOverride) {
       if (threadPoolKeyOverride == null) {
           // we don't have a property overriding the value so use either HystrixThreadPoolKey or HystrixCommandGroup
           if (threadPoolKey == null) {
               /* use HystrixCommandGroup if HystrixThreadPoolKey is null */
               return HystrixThreadPoolKey.Factory.asKey(groupKey.name());
           } else {
               return threadPoolKey;
           }
       } else { // threadPoolKeyOverride å¯è¦†ç›–å±æ€§
           // we have a property defining the thread-pool so use it instead
           return HystrixThreadPoolKey.Factory.asKey(threadPoolKeyOverride);
       }
    }
    ```
    * ä¼˜å…ˆçº§ ï¼š`threadPoolKeyOverride` > `threadPoolKey` > `groupKey`

# 4. HystrixConcurrencyStrategy

`com.netflix.hystrix.strategy.concurrency.HystrixConcurrencyStrategy` ï¼ŒHystrix å¹¶å‘ç­–ç•¥**æŠ½è±¡ç±»**ã€‚

`HystrixConcurrencyStrategy#getThreadPool(...)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: public ThreadPoolExecutor getThreadPool(final HystrixThreadPoolKey threadPoolKey, HystrixThreadPoolProperties threadPoolProperties) {
  2:     final ThreadFactory threadFactory = getThreadFactory(threadPoolKey);
  3: 
  4:     final boolean allowMaximumSizeToDivergeFromCoreSize = threadPoolProperties.getAllowMaximumSizeToDivergeFromCoreSize().get();
  5:     final int dynamicCoreSize = threadPoolProperties.coreSize().get();
  6:     final int keepAliveTime = threadPoolProperties.keepAliveTimeMinutes().get();
  7:     final int maxQueueSize = threadPoolProperties.maxQueueSize().get();
  8: 
  9:     final BlockingQueue<Runnable> workQueue = getBlockingQueue(maxQueueSize);
 10: 
 11:     if (allowMaximumSizeToDivergeFromCoreSize) {
 12:         final int dynamicMaximumSize = threadPoolProperties.maximumSize().get();
 13:         if (dynamicCoreSize > dynamicMaximumSize) {
 14:             logger.error("Hystrix ThreadPool configuration at startup for : " + threadPoolKey.name() + " is trying to set coreSize = " +
 15:                     dynamicCoreSize + " and maximumSize = " + dynamicMaximumSize + ".  Maximum size will be set to " +
 16:                     dynamicCoreSize + ", the coreSize value, since it must be equal to or greater than the coreSize value");
 17:             return new ThreadPoolExecutor(dynamicCoreSize, dynamicCoreSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);
 18:         } else {
 19:             return new ThreadPoolExecutor(dynamicCoreSize, dynamicMaximumSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);
 20:         }
 21:     } else {
 22:         return new ThreadPoolExecutor(dynamicCoreSize, dynamicCoreSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory);
 23:     }
 24: }
```

* ç¬¬ 2 è¡Œ ï¼šè°ƒç”¨ `#getThreadFactory(...)` æ–¹æ³•ï¼Œè·å¾— ThreadFactory ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixConcurrencyStrategy.java#L118) æŸ¥çœ‹æ–¹æ³•ä»£ç ã€‚
    * `PlatformSpecific#getAppEngineThreadFactory()` æ–¹æ³•ï¼Œæ— éœ€ç»†çœ‹ï¼Œé€‚ç”¨äº Google App Engine åœºæ™¯ã€‚
* ç¬¬ 4 è‡³ 7 è¡Œ ï¼š[ã€Œ2. HystrixThreadPoolPropertiesã€](#) æœ‰è¯¦ç»†è§£æã€‚
* ç¬¬ 9 è¡Œ ï¼šè°ƒç”¨ `#getBlockingQueue()` æ–¹æ³•ï¼Œè·å¾—çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixConcurrencyStrategy.java#L150) æŸ¥çœ‹æ–¹æ³•ä»£ç ã€‚
    * å½“ `maxQueueSize <= 0` æ—¶( é»˜è®¤å€¼ ï¼š`-1` ) æ—¶ï¼Œä½¿ç”¨ SynchronousQueue ã€‚è¶…è¿‡çº¿ç¨‹æ± çš„ `maximumPoolSize` æ—¶ï¼Œæäº¤ä»»åŠ¡**è¢«æ‹’ç»**ã€‚
        * [ã€ŠJavaå¹¶å‘åŒ…ä¸­çš„åŒæ­¥é˜Ÿåˆ—SynchronousQueueå®ç°åŸç†ã€‹](http://ifeve.com/java-synchronousqueue/)
    * å½“ `SynchronousQueue > 0` æ—¶ï¼Œä½¿ç”¨ LinkedBlockingQueue ã€‚è¶…è¿‡çº¿ç¨‹æ± çš„ `maximumPoolSize` æ—¶ï¼Œä»»åŠ¡è¢«æ‹’ç»ã€‚è¶…è¿‡çº¿ç¨‹æ± çš„ `maximumPoolSize` + çº¿ç¨‹æ± é˜Ÿåˆ—çš„ `maxQueueSize` æ—¶ï¼Œæäº¤ä»»åŠ¡**è¢«é˜»å¡ç­‰å¾…**ã€‚
        * [ã€ŠJavaé˜»å¡é˜Ÿåˆ—ArrayBlockingQueueå’ŒLinkedBlockingQueueå®ç°åŸç†åˆ†æã€‹](https://fangjian0423.github.io/2016/05/10/java-arrayblockingqueue-linkedblockingqueue-analysis/) 
   * æ¨è ï¼š[ã€ŠèŠèŠå¹¶å‘ï¼ˆä¸‰ï¼‰â€”â€”JAVAçº¿ç¨‹æ± çš„åˆ†æå’Œä½¿ç”¨ã€‹](http://www.infoq.com/cn/articles/java-threadPool)
   * æ¨è ï¼š[ã€ŠèŠèŠå¹¶å‘ï¼ˆä¸ƒï¼‰â€”â€”Javaä¸­çš„é˜»å¡é˜Ÿåˆ—ã€‹](http://www.infoq.com/cn/articles/java-blocking-queue)
* ç¬¬ 11 è‡³ 23 è¡Œ ï¼šåˆ›å»º ThreadPoolExecutor ã€‚çœ‹èµ·æ¥ä»£ç æ¯”è¾ƒå¤šï¼Œæ ¹æ® `allowMaximumSizeToDivergeFromCoreSize` çš„æƒ…å†µï¼Œè®¡ç®—çº¿ç¨‹æ± çš„ `maximumPoolSize` å±æ€§ã€‚è®¡ç®—çš„æ–¹å¼å’Œ [`HystrixThreadPoolProperties#actualMaximumSize()`](https://github.com/Netflix/Hystrix/blob/1f64fced24289ea435f1e2d5a47a068bf7b79729/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPoolProperties.java#L138) æ–¹æ³•æ˜¯ä¸€è‡´çš„ã€‚ 

-------

`com.netflix.hystrix.strategy.concurrency.HystrixConcurrencyStrategyDefault` ï¼ŒHystrix å¹¶å‘ç­–ç•¥**å®ç°ç±»**ã€‚ä»£ç å¦‚ä¸‹( åŸºæœ¬æ²¡åšå•¥ ) ï¼š

```Java
public class HystrixConcurrencyStrategyDefault extends HystrixConcurrencyStrategy {

    /**
     * å•ä¾‹
     */
    private static HystrixConcurrencyStrategyDefault INSTANCE = new HystrixConcurrencyStrategyDefault();

    public static HystrixConcurrencyStrategy getInstance() {
        return INSTANCE;
    }

    private HystrixConcurrencyStrategyDefault() {
    }

}
```

-------

åœ¨ AbstractCommand **æ„é€ æ–¹æ³•**é‡Œï¼Œåˆå§‹åŒ–å‘½ä»¤çš„ `threadPoolKey` å±æ€§ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
protected final HystrixConcurrencyStrategy concurrencyStrategy;

protected AbstractCommand(HystrixCommandGroupKey group, HystrixCommandKey key, HystrixThreadPoolKey threadPoolKey, HystrixCircuitBreaker circuitBreaker, HystrixThreadPool threadPool,
       HystrixCommandProperties.Setter commandPropertiesDefaults, HystrixThreadPoolProperties.Setter threadPoolPropertiesDefaults,
       HystrixCommandMetrics metrics, TryableSemaphore fallbackSemaphore, TryableSemaphore executionSemaphore,
       HystrixPropertiesStrategy propertiesStrategy, HystrixCommandExecutionHook executionHook) {

    // ... çœç•¥æ— å…³ä»£ç 
   
    // åˆå§‹åŒ– å¹¶å‘ç­–ç•¥
    this.concurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();
   
}
```

* HystrixPlugins ï¼ŒHystrix **æ’ä»¶**ä½“ç³»ï¼Œ[https://github.com/Netflix/Hystrix/wiki/Plugins](https://github.com/Netflix/Hystrix/wiki/Plugins) æœ‰è¯¦ç»†è§£æã€‚
* è°ƒç”¨ `HystrixPlugins#getConcurrencyStrategy()` è·å¾— HystrixConcurrencyStrategy å¯¹è±¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ HystrixConcurrencyStrategyDefault ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å‚è€ƒ Hystrix æ’ä»¶ä½“ç³»ï¼Œå®ç°**è‡ªå®šä¹‰**çš„ HystrixConcurrencyStrategy å®ç°ï¼Œä»¥è¾¾åˆ°**è¦†å†™** `#getThreadPool()`ï¼Œ`#getBlockingQueue()` ç­‰æ–¹æ³•ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/HystrixPlugins.java#L164) æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚

# 5. HystrixThreadPool

`com.netflix.hystrix.HystrixThreadPool` ï¼ŒHystrix çº¿ç¨‹æ± **æ¥å£**ã€‚å½“ Hystrix å‘½ä»¤ä½¿ç”¨ `THREAD` æ‰§è¡Œéš”ç¦»ç­–ç•¥æ—¶ï¼Œ`HystrixCommand#run()` æ–¹æ³•åœ¨**çº¿ç¨‹æ± æ‰§è¡Œ**ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPool.java#L47) æŸ¥çœ‹ã€‚HystrixThreadPool å®šä¹‰æ¥å£å¦‚ä¸‹ ï¼š

* `#getExecutor()` ï¼šè·å¾— ExecutorService ã€‚
* `#getScheduler()` / `#getScheduler(Func0<Boolean>)` ï¼šè·å¾— RxJava Scheduler ã€‚
* `#isQueueSpaceAvailable()` ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—æ˜¯å¦æœ‰**ç©ºä½™**ã€‚
* `#markThreadExecution()` / `#markThreadCompletion()` / `#markThreadRejection()` ï¼šTODO ã€2002ã€‘ã€metricsã€‘

## 5.1 HystrixThreadPoolDefault

`com.netflix.hystrix.HystrixThreadPool.HystrixThreadPoolDefault` ï¼ŒHystrix çº¿ç¨‹æ± **å®ç°ç±»**ã€‚ 

**æ„é€ æ–¹æ³•**ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: private final HystrixThreadPoolProperties properties;
  2: private final BlockingQueue<Runnable> queue;
  3: private final ThreadPoolExecutor threadPool;
  4: private final HystrixThreadPoolMetrics metrics;
  5: private final int queueSize;
  6: 
  7: public HystrixThreadPoolDefault(HystrixThreadPoolKey threadPoolKey, HystrixThreadPoolProperties.Setter propertiesDefaults) {
  8:     // åˆå§‹åŒ– HystrixThreadPoolProperties
  9:     this.properties = HystrixPropertiesFactory.getThreadPoolProperties(threadPoolKey, propertiesDefaults);
 10:     // è·å¾— HystrixConcurrencyStrategy
 11:     HystrixConcurrencyStrategy concurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();
 12:     // é˜Ÿåˆ—å¤§å°
 13:     this.queueSize = properties.maxQueueSize().get();
 14: 
 15:     // TODO ã€2002ã€‘ã€metricsã€‘
 16:     this.metrics = HystrixThreadPoolMetrics.getInstance(threadPoolKey,
 17:             concurrencyStrategy.getThreadPool(threadPoolKey, properties), // åˆå§‹åŒ– ThreadPoolExecutor
 18:             properties);
 19: 
 20:     // è·å¾— ThreadPoolExecutor
 21:     this.threadPool = this.metrics.getThreadPool();
 22:     this.queue = this.threadPool.getQueue(); // é˜Ÿåˆ—
 23: 
 24:     // TODO ã€2002ã€‘ã€metricsã€‘
 25:     /* strategy: HystrixMetricsPublisherThreadPool */
 26:     HystrixMetricsPublisherFactory.createOrRetrievePublisherForThreadPool(threadPoolKey, this.metrics, this.properties);
 27: }
```
* ç¬¬ 9 è¡Œ ï¼šåˆå§‹åŒ– HystrixThreadPoolProperties ã€‚
* ç¬¬ 11 è¡Œ ï¼šåˆå§‹åŒ– HystrixConcurrencyStrategy ã€‚
* ç¬¬ 13 è¡Œ ï¼šåˆå§‹åŒ– `queueSize` ã€‚
* ç¬¬ 16 è‡³ 18 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘
    * ç¬¬ 17 è¡Œ ï¼šè°ƒç”¨ `HystrixConcurrencyStrategy#getThreadPool(...)` æ–¹æ³•ï¼Œåˆå§‹åŒ– ThreadPoolExecutor ã€‚
* ç¬¬ 21 è¡Œ ï¼š**è·å¾—** ThreadPoolExecutor ã€‚
* ç¬¬ 22 è¡Œ ï¼š**è·å¾—** ThreadPoolExecutor çš„é˜Ÿåˆ—ã€‚
* ç¬¬ 26 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘

-------

`#getExecutor()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
@Override
public ThreadPoolExecutor getExecutor() {
    touchConfig();
    return threadPool;
}
```

* è°ƒç”¨ `#touchConfig()` æ–¹æ³•ï¼Œ**åŠ¨æ€**è°ƒæ•´ `threadPool` çš„ `coreSize` / `maximumSize` / `keepAliveTime` å‚æ•°ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPool.java#L188) æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚

-------

`#getScheduler()` / `#getScheduler(Func0<Boolean>)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
@Override
public Scheduler getScheduler() {
    //by default, interrupt underlying threads on timeout
    return getScheduler(new Func0<Boolean>() {
        @Override
        public Boolean call() {
            return true;
        }
    });
}

@Override
public Scheduler getScheduler(Func0<Boolean> shouldInterruptThread) {
    touchConfig();
    return new HystrixContextScheduler(HystrixPlugins.getInstance().getConcurrencyStrategy(), this, shouldInterruptThread);
}
```

* HystrixContextScheduler å’Œ `shouldInterruptThread` éƒ½åœ¨ [ã€Œ6. HystrixContextSchedulerã€](#) è¯¦ç»†è§£æã€‚

-------

`#isQueueSpaceAvailable()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
@Override
public boolean isQueueSpaceAvailable() {
    if (queueSize <= 0) {
        // we don't have a queue so we won't look for space but instead
        // let the thread-pool reject or not
        return true;
    } else {
        return threadPool.getQueue().size() < properties.queueSizeRejectionThreshold().get();
    }
}
```

* ç”±äºçº¿ç¨‹æ± çš„é˜Ÿåˆ—å¤§å°ä¸èƒ½**åŠ¨æ€**è°ƒæ•´ï¼Œè¯¥æ–¹æ³•çš„**å®ç°**é€šè¿‡ [`HystrixThreadPoolProperties.queueSizeRejectionThreshold`](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPoolProperties.java#L85) å±æ€§æ§åˆ¶ã€‚
* æ³¨æ„ `queueSize` å±æ€§ï¼Œå†³å®šäº†çº¿ç¨‹æ± çš„é˜Ÿåˆ—ç±»å‹ã€‚
    * `queueSize <= 0` æ—¶ï¼Œ`#isQueueSpaceAvailable()` éƒ½è¿”å› `true` çš„åŸå› æ˜¯ï¼Œçº¿ç¨‹æ± ä½¿ç”¨ SynchronousQueue ä½œä¸ºé˜Ÿåˆ—ï¼Œä¸æ”¯æŒ**æ–°**ä»»åŠ¡æ’é˜Ÿï¼Œä»»åŠ¡è¶…è¿‡çº¿ç¨‹æ± çš„ `maximumPoolSize` æ—¶ï¼Œæ–°ä»»åŠ¡è¢«æ‹’ç»ã€‚
    * `queueSize > 0` æ—¶ï¼Œ`#isQueueSpaceAvailable()` æ ¹æ®æƒ…å†µ`true`/`false` çš„åŸå› æ˜¯ï¼Œçº¿ç¨‹æ± ä½¿ç”¨ LinkedBlockingQueue ä½œä¸ºé˜Ÿåˆ—ï¼Œæ”¯æŒ**ä¸€å®šæ•°é‡**çš„**é˜»å¡**æ’é˜Ÿï¼Œä½†æ˜¯è¿™ä¸ªæ•°é‡æ— æ³•è°ƒæ•´ã€‚é€šè¿‡ `#isQueueSpaceAvailable()` æ–¹æ³•çš„åˆ¤æ–­ï¼Œ**åŠ¨æ€**è°ƒæ•´ã€‚å¦å¤–ï¼Œåˆå§‹**é…ç½®**çš„ `queueSize` è¦**ç›¸å¯¹å¤§**ï¼Œå¦åˆ™å³ä½¿ `queueSizeRejectionThreshold` é…ç½®çš„å¤§äº `queueSize` ï¼Œå®é™…æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œä¹Ÿä¼šè¢«**æ‹’ç»**ã€‚

## 5.2 Factory

`com.netflix.hystrix.HystrixThreadPool.Factory` ï¼ŒHystrixThreadPool å·¥å‚ç±»ï¼Œä¸ä»…é™äº HystrixThreadPool çš„åˆ›å»ºï¼Œä¹Ÿæä¾›äº† HystrixThreadPool çš„ç®¡ç†( HystrixThreadPool çš„å®¹å™¨ )ã€‚


`threadPools` å±æ€§ï¼Œç»´æŠ¤åˆ›å»ºçš„ HystrixThreadPool å¯¹åº”çš„æ˜ å°„ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
final static ConcurrentHashMap<String, HystrixThreadPool> threadPools = new ConcurrentHashMap<String, HystrixThreadPool>();
```

* Key ä¸º `HystrixThreadPoolKey#name()` ï¼Œæ¯ä¸ª HystrixThreadPoolKey å¯¹åº”ä¸€ä¸ª HystrixThreadPool å¯¹è±¡ã€‚

-------

`#getInstance(...)` æ–¹æ³•ï¼Œè·å¾— HystrixThreadPool å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
/* package */static HystrixThreadPool getInstance(HystrixThreadPoolKey threadPoolKey, HystrixThreadPoolProperties.Setter propertiesBuilder) {
    // get the key to use instead of using the object itself so that if people forget to implement equals/hashcode things will still work
    String key = threadPoolKey.name();

    // this should find it for all but the first time
    HystrixThreadPool previouslyCached = threadPools.get(key);
    if (previouslyCached != null) {
         return previouslyCached;
     }

     // if we get here this is the first time so we need to initialize
     synchronized (HystrixThreadPool.class) {
        if (!threadPools.containsKey(key)) {
            threadPools.put(key, new HystrixThreadPoolDefault(threadPoolKey, propertiesBuilder));
       }
     }
     return threadPools.get(key);
}
```
* æ ¹æ® `threadPoolKey` å…ˆä» `threadPool` è·å–å·²åˆ›å»ºçš„ HystrixThreadPool ï¼›è·å–ä¸åˆ°ï¼Œåˆ›å»ºå¯¹åº”çš„ HystrixThreadPool è¿”å›ï¼Œå¹¶æ·»åŠ åˆ° `threadPool` ã€‚

-------

`#shutdown()` / `#shutdown(timeout, unit)` æ–¹æ³•ï¼Œæ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/HystrixThreadPool.java#L128) æŸ¥çœ‹ã€‚

## 5.3 åˆå§‹åŒ–

åœ¨ AbstractCommand **æ„é€ æ–¹æ³•**é‡Œï¼Œåˆå§‹åŒ–å‘½ä»¤çš„ `threadPool` å±æ€§ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
protected final HystrixThreadPool threadPool;

protected AbstractCommand(HystrixCommandGroupKey group, HystrixCommandKey key, HystrixThreadPoolKey threadPoolKey, HystrixCircuitBreaker circuitBreaker, HystrixThreadPool threadPool,
       HystrixCommandProperties.Setter commandPropertiesDefaults, HystrixThreadPoolProperties.Setter threadPoolPropertiesDefaults,
       HystrixCommandMetrics metrics, TryableSemaphore fallbackSemaphore, TryableSemaphore executionSemaphore,
       HystrixPropertiesStrategy propertiesStrategy, HystrixCommandExecutionHook executionHook) {

    // ... çœç•¥å…¶ä»–ä»£ç 

    // åˆå§‹åŒ– threadPoolKey
    this.threadPoolKey = initThreadPoolKey(threadPoolKey, this.commandGroup, this.properties.executionIsolationThreadPoolKeyOverride().get());
    // åˆå§‹åŒ– threadPool
    this.threadPool = initThreadPool(threadPool, this.threadPoolKey, threadPoolPropertiesDefaults);

}
```

* è°ƒç”¨ `#initThreadPool(...)` æ–¹æ³•ï¼Œè·å¾— HystrixThreadPool ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L286) æŸ¥çœ‹ã€‚

# 6. HystrixScheduler

Hystrix å®ç°äº†**è‡ªå®šä¹‰çš„** RxJava Scheduler ï¼Œæ•´ä½“ç±»å›¾å¦‚ä¸‹ ï¼š

![](http://www.iocoder.cn/images/Hystrix/2018_10_25/01.png)

* HystrixContextScheduler ( å®ç° RxJava Scheduler **æŠ½è±¡ç±»** )ï¼Œå†…åµŒç±»å‹ä¸º ThreadPoolScheduler ( å®ç° RxJava Scheduler **æŠ½è±¡ç±»** )çš„ `actualScheduler` å±æ€§ã€‚
* HystrixContextWorker ( å®ç° RxJava Worker **æŠ½è±¡ç±»** )ï¼Œå†…åµŒç±»å‹ä¸º ThreadPoolWorker ( å®ç° RxJava Worker **æŠ½è±¡ç±»** )çš„ `worker` å±æ€§ã€‚

## 6.1 HystrixContextScheduler

**æ„é€ æ–¹æ³•**ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
public class HystrixContextScheduler extends Scheduler {

    private final HystrixConcurrencyStrategy concurrencyStrategy;
    private final Scheduler actualScheduler;
    private final HystrixThreadPool threadPool;
    
    // ... çœç•¥æ— å…³ä»£ç 
    
    public HystrixContextScheduler(HystrixConcurrencyStrategy concurrencyStrategy, HystrixThreadPool threadPool, Func0<Boolean> shouldInterruptThread) {
        this.concurrencyStrategy = concurrencyStrategy;
        this.threadPool = threadPool;
        this.actualScheduler = new ThreadPoolScheduler(threadPool, shouldInterruptThread);
    }
}
```
* `actualScheduler` å±æ€§ï¼Œç±»å‹ä¸º ThreadPoolScheduler ã€‚

-------

`#createWorker()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
@Override
public Worker createWorker() {
    return new HystrixContextSchedulerWorker(actualScheduler.createWorker());
}
```
* ä½¿ç”¨ `actualScheduler` åˆ›å»º ThreadPoolWorker ï¼Œä¼ å‚ç»™ HystrixContextSchedulerWorker ã€‚

## 6.2 HystrixContextSchedulerWorker

**æ„é€ æ–¹æ³•**ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
private class HystrixContextSchedulerWorker extends Worker {

    private final Worker worker;

    // ... çœç•¥æ— å…³ä»£ç 

    private HystrixContextSchedulerWorker(Worker actualWorker) {
        this.worker = actualWorker;
    }
   
}
```

* `worker` å±æ€§ï¼Œç±»å‹ä¸º ThreadPoolWorker ã€‚

-------

`#schedule(Action0)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
@Override
public Subscription schedule(Action0 action) {
    if (threadPool != null) {
        if (!threadPool.isQueueSpaceAvailable()) {
            throw new RejectedExecutionException("Rejected command because thread-pool queueSize is at rejection threshold.");
        }
    }
    return worker.schedule(new HystrixContexSchedulerAction(concurrencyStrategy, action));
}
```
* è°ƒç”¨ `ThreadPool#isQueueSpaceAvailable()` æ–¹æ³•ï¼Œåˆ¤æ–­çº¿ç¨‹æ± é˜Ÿåˆ—æ˜¯å¦æœ‰**ç©ºä½™**ã€‚è¿™ä¸ªå°±æ˜¯ HystrixContextScheduler çš„**å®é™…**ç”¨é€”ã€‚

-------

`#unsubscribe()` / `#isUnsubscribed()` æ–¹æ³•ï¼Œä½¿ç”¨ `worker` åˆ¤æ–­ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixContextScheduler.java#L80)æŸ¥çœ‹ã€‚ 

## 6.3 ThreadPoolScheduler

ThreadPoolScheduler æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixContextScheduler.java#L111) æŸ¥çœ‹ã€‚

## 6.4 ThreadPoolWorker

**æ„é€ æ–¹æ³•**ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
private static class ThreadPoolWorker extends Worker {

    private final HystrixThreadPool threadPool;
    private final CompositeSubscription subscription = new CompositeSubscription();
    private final Func0<Boolean> shouldInterruptThread;

    // ... çœç•¥æ— å…³ä»£ç 

    public ThreadPoolWorker(HystrixThreadPool threadPool, Func0<Boolean> shouldInterruptThread) {
        this.threadPool = threadPool;
        this.shouldInterruptThread = shouldInterruptThread;
    }
}
```
* `subscription` å±æ€§ï¼Œè®¢é˜…ä¿¡æ¯ã€‚

-------

`#schedule(Action0)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: @Override
  2: public Subscription schedule(final Action0 action) {
  3:     // æœªè®¢é˜…ï¼Œè¿”å›
  4:     if (subscription.isUnsubscribed()) {
  5:         // don't schedule, we are unsubscribed
  6:         return Subscriptions.unsubscribed();
  7:     }
  8: 
  9:     // åˆ›å»º ScheduledAction
 10:     // This is internal RxJava API but it is too useful.
 11:     ScheduledAction sa = new ScheduledAction(action);
 12: 
 13:     // æ·»åŠ åˆ° è®¢é˜…
 14:     subscription.add(sa);
 15:     sa.addParent(subscription);
 16: 
 17:     // æäº¤ ä»»åŠ¡
 18:     ThreadPoolExecutor executor = (ThreadPoolExecutor) threadPool.getExecutor();
 19:     FutureTask<?> f = (FutureTask<?>) executor.submit(sa);
 20:     sa.add(new FutureCompleterWithConfigurableInterrupt(f, shouldInterruptThread, executor));
 21: 
 22:     return sa;
 23: }
```
* ç¬¬ 4 è‡³ 7 è¡Œ ï¼šæœªè®¢é˜…ï¼Œè¿”å›ã€‚
* ç¬¬ 11 è¡Œ ï¼š åˆ›å»º ScheduledAction ã€‚åœ¨ [TODO ã€2013ã€‘ã€ScheduledActionã€‘]() è¯¦ç»†è§£æã€‚
* ç¬¬ 14 è‡³ 15 è¡Œ ï¼šæ·»åŠ åˆ°è®¢é˜…( `subscription` )ã€‚
* ç¬¬ 18 è‡³ 20 è¡Œ ï¼šä½¿ç”¨ `threadPool` ï¼Œæäº¤ä»»åŠ¡ï¼Œå¹¶åˆ›å»º FutureCompleterWithConfigurableInterrupt æ·»åŠ åˆ°è®¢é˜…( `sa` )ã€‚
* ç¬¬ 22 è¡Œ ï¼šè¿”å›è®¢é˜…( `sa` )ã€‚æ•´ä½“è®¢é˜…å…³ç³»å¦‚ä¸‹ ï¼š![](http://www.iocoder.cn/images/Hystrix/2018_10_25/02.png)

-------

`#unsubscribe()` / `#isUnsubscribed()` æ–¹æ³•ï¼Œä½¿ç”¨ `subscription` åˆ¤æ–­ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/853258ce3f499e1f525130064f0d6cb055088b29/hystrix-core/src/main/java/com/netflix/hystrix/strategy/concurrency/HystrixContextScheduler.java#L149)æŸ¥çœ‹ã€‚

## 6.5 FutureCompleterWithConfigurableInterrupt

`com.netflix.hystrix.strategy.concurrency.HystrixContextScheduler.FutureCompleterWithConfigurableInterrupt` ï¼Œå®ç°ç±»ä¼¼ `rx.internal.schedulers.ScheduledAction.FutureCompleter` ï¼Œåœ¨å®ƒçš„åŸºç¡€ä¸Šï¼Œæ”¯æŒé…ç½® `FutureTask#cancel(Boolean)` æ˜¯å¦å¯**æ‰“æ–­**è¿è¡Œ( `mayInterruptIfRunning` )ã€‚

**æ„é€ æ–¹æ³•**ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
private static class FutureCompleterWithConfigurableInterrupt implements Subscription {
    private final FutureTask<?> f;
    private final Func0<Boolean> shouldInterruptThread;
    private final ThreadPoolExecutor executor;

    // ... çœç•¥æ— å…³ä»£ç 

    private FutureCompleterWithConfigurableInterrupt(FutureTask<?> f, Func0<Boolean> shouldInterruptThread, ThreadPoolExecutor executor) {
        this.f = f;
        this.shouldInterruptThread = shouldInterruptThread;
        this.executor = executor;
    }
}
```

-------

**å½“å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œæˆ–æ˜¯ä¸»åŠ¨å–æ¶ˆå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ `#unsubscribe()` æ–¹æ³•ï¼Œå–æ¶ˆæ‰§è¡Œ**ã€‚  
**å½“å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œæˆ–æ˜¯ä¸»åŠ¨å–æ¶ˆå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ `#unsubscribe()` æ–¹æ³•ï¼Œå–æ¶ˆæ‰§è¡Œ**ã€‚  
**å½“å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œæˆ–æ˜¯ä¸»åŠ¨å–æ¶ˆå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨ `#unsubscribe()` æ–¹æ³•ï¼Œå–æ¶ˆæ‰§è¡Œ**ã€‚  

`#unsubscribe()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
@Override
public void unsubscribe() {
    // ä» çº¿ç¨‹æ±  ç§»é™¤ ä»»åŠ¡
    executor.remove(f);
    // æ ¹æ® shouldInterruptThread é…ç½®ï¼Œæ˜¯å¦å¼ºåˆ¶å–æ¶ˆ
    if (shouldInterruptThread.call()) {
        f.cancel(true);
    } else {
        f.cancel(false);
    }
}
```
* æ ¹æ® `shouldInterruptThread` æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦**å¼ºåˆ¶**å–æ¶ˆã€‚
* `shouldInterruptThread` å¯¹åº”çš„æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ ï¼š

```Java
subscribeOn(threadPool.getScheduler(new Func0<Boolean>() {
    @Override
    public Boolean call() {
        return properties.executionIsolationThreadInterruptOnTimeout().get() && _cmd.isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT;
    }
}));
```
* å½“ `executionIsolationThreadInterruptOnTimeout = true` æ—¶ï¼Œå‘½ä»¤å¯æ‰§è¡Œ**è¶…æ—¶**ã€‚å½“å‘½ä»¤å¯æ‰§è¡Œ**è¶…æ—¶**æ—¶ï¼Œ**å¼ºåˆ¶**å–æ¶ˆã€‚
* å½“ä½¿ç”¨ `HystrixCommand.queue()` è¿”å›çš„ Future ï¼Œå¯ä»¥ä½¿ç”¨ `Future#cancel(Boolean)` å–æ¶ˆå‘½ä»¤æ‰§è¡Œã€‚ä» `shouldInterruptThread` å¯¹åº”çš„æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ­¤æ—¶ä¸æ»¡è¶³å‘½ä»¤æ‰§è¡Œ**è¶…æ—¶**çš„æ¡ä»¶ï¼Œå‘½ä»¤æ‰§è¡Œå–æ¶ˆçš„æ–¹å¼æ˜¯**éå¼ºåˆ¶**çš„ã€‚æ­¤æ—¶å½“ `executionIsolationThreadInterruptOnFutureCancel = true` æ—¶ï¼Œå¹¶ä¸”è°ƒç”¨ `Future#cancel(Boolean)` ä¼ é€’ `mayInterruptIfRunning = true` ï¼Œå¼ºåˆ¶å–æ¶ˆå‘½ä»¤æ‰§è¡Œã€‚
    * æ¨¡æ‹Ÿæµ‹è¯•ç”¨ä¾‹ ï¼š[`CommandHelloWorld#testAsynchronous3()`](https://github.com/YunaiV/Hystrix/blob/HEAD/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java#L118) 
    * `HystrixCommand#queue()` ï¼šç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/ba86690747b365482c306ec3a0725e0be4bab739/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommand.java#L378) æŸ¥çœ‹ `Future#cancel(Boolean)` æ–¹æ³•ã€‚

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

ä¸€è¾¹å†™ä¸€è¾¹æƒ³æ˜ç™½äº† RxJava çš„ä¸€äº›ä¸œè¥¿ï¼ŒæŒºèˆ’æœçš„èµ¶è„šã€‚

ç»§ç»­ Go On ~ å‘¨æœ«å—¨ä¸åœã€‚

èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼


