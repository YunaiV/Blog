title: Hystrix æºç è§£æ â€”â€” æ‰§è¡Œå‘½ä»¤æ–¹å¼
date: 2018-10-10
tags:
categories: Hystrix
permalink: Hystrix/command-execute-mode

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-mode/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬**  

- [1. æ¦‚è¿°](http://www.iocoder.cn/Hystrix/command-execute-mode/)
- [2. å®ç°](http://www.iocoder.cn/Hystrix/command-execute-mode/)
- [3. BlockingObservable](http://www.iocoder.cn/Hystrix/command-execute-mode/)
- [666. å½©è›‹](http://www.iocoder.cn/Hystrix/command-execute-mode/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)


> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Hystrix æ‰§è¡Œå‘½ä»¤æ–¹æ³•**ã€‚

å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚

åœ¨å®˜æ–¹æä¾›çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° [CommandHelloWorld](https://github.com/Netflix/Hystrix/blob/d838f4d1ba65ce55755ab1c73f74c980f04572bf/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java) é€šè¿‡ç»§æ‰¿ [HystrixCommand](https://github.com/Netflix/Hystrix/blob/d838f4d1ba65ce55755ab1c73f74c980f04572bf/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommand.java) æŠ½è±¡ç±»ï¼Œæœ‰å››ç§è°ƒç”¨æ–¹å¼ï¼š

| æ–¹æ³• |  |
| :--- | :--- |
| `#execute()` | **åŒæ­¥**è°ƒç”¨ï¼Œè¿”å›**ç›´æ¥**ç»“æœ |  |
| `#queue()` | **å¼‚æ­¥**è°ƒç”¨ï¼Œè¿”å› `java.util.concurrent.Future` |  |
| `#observe()` | **å¼‚æ­¥**è°ƒç”¨ï¼Œè¿”å› `rx.Observable` ã€‚å‘ Observable æ³¨å†Œ `rx.Subscriber` å¤„ç†ç»“æœ |  |
| `#toObservable()` | **æœªè°ƒç”¨**ï¼Œè¿”å› `rx.Observable` ã€‚å‘ Observable æ³¨å†Œ `rx.Subscriber` å¤„ç†ç»“æœ |  |

* ç¬¬å››ç§æ–¹å¼ï¼Œç‚¹å‡» [`#testToObservable()`](https://github.com/YunaiV/Hystrix/blob/master/hystrix-examples/src/main/java/com/netflix/hystrix/examples/basic/CommandHelloWorld.java#L165) æŸ¥çœ‹ç¬”è€…è¡¥å……çš„ç¤ºä¾‹ã€‚

![](http://www.iocoder.cn/images/Hystrix/2018_10_08/01.jpeg)

-------

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)
* ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚



# 2. å®ç°

```Java
// AbstractCommand.java
abstract class AbstractCommand<R> implements HystrixInvokableInfo<R>, HystrixObservable<R> {
    
    // ... çœç•¥æ— å…³å±æ€§ä¸æ–¹æ³•
    
    public Observable<R> toObservable() {
    
        return Observable.defer(new Func0<Observable<R>>() {
            @Override
            public Observable<R> call() {
                // ....
            }
        }
    
    }
    
    public Observable<R> observe() {
        // us a ReplaySubject to buffer the eagerly subscribed-to Observable
        ReplaySubject<R> subject = ReplaySubject.create();
        // eagerly kick off subscription
        final Subscription sourceSubscription = toObservable().subscribe(subject);
        // return the subject that can be subscribed to later while the execution has already started
        return subject.doOnUnsubscribe(new Action0() {
            @Override
            public void call() {
                sourceSubscription.unsubscribe();
            }
        });
    }

}

// HystrixCommand.java
public abstract class HystrixCommand<R> extends AbstractCommand<R> implements HystrixExecutable<R>, HystrixInvokableInfo<R>, HystrixObservable<R> {

    // ... çœç•¥æ— å…³å±æ€§ä¸æ–¹æ³•
    
    public Future<R> queue() {
        final Future<R> delegate = toObservable().toBlocking().toFuture();
        final Future<R> f = new Future<R>() {
            // ... åŒ…è£… delegate
        }
        // ...
        return f;
    }

    public R execute() {
        try {
            return queue().get();
        } catch (Exception e) {
            throw Exceptions.sneakyThrow(decomposeException(e));
        }
    }
    
    protected abstract R run() throws Exception;

}
```

* `#toObservable()` æ–¹æ³• ï¼š**æœª**åšè®¢é˜…ï¼Œè¿”å›å¹²å‡€çš„ Observable ã€‚**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šæ–‡è¯´â€œæœªè°ƒç”¨â€** ã€‚
* `#observe()` æ–¹æ³• ï¼šè°ƒç”¨ `#toObservable()` æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œå‘ Observable æ³¨å†Œ `rx.subjects.ReplaySubject` **å‘èµ·è®¢é˜…** ã€‚
    * ReplaySubject ä¼šå‘å°„æ‰€æœ‰æ¥è‡ªåŸå§‹ Observable çš„æ•°æ®ç»™è§‚å¯Ÿè€…ï¼Œæ— è®ºå®ƒä»¬æ˜¯ä½•æ—¶è®¢é˜…çš„ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» [ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” Subjectã€‹](https://mcxiaoke.gitbooks.io/rxdocs/content/Subject.html) ã€‚
* `#queue()` æ–¹æ³• ï¼šè°ƒç”¨ `#toObservable()` æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ï¼š
    * `Observable#toBlocking()` æ–¹æ³• ï¼šå°† Observable è½¬æ¢æˆ**é˜»å¡**çš„ `rx.observables.BlockingObservable` ã€‚
    * `BlockingObservable#toFuture()` æ–¹æ³• ï¼šè¿”å›å¯è·å¾— `#run()` **æŠ½è±¡æ–¹æ³•**æ‰§è¡Œç»“æœçš„ Future ã€‚
        * `#run()` æ–¹æ³• ï¼šå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œæ‰§è¡Œ**æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘**ã€‚
   * BlockingObservable åœ¨ [ã€Œ3. BlockingObservableã€](#) è¯¦ç»†è§£æã€‚
* `#execute()` æ–¹æ³• ï¼šè°ƒç”¨ `#queue()` æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ `Future#get()` æ–¹æ³•ï¼Œ**åŒæ­¥**è¿”å› `#run()` çš„æ‰§è¡Œç»“æœã€‚
* æ•´ç†å››ç§è°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š

    ![](http://www.iocoder.cn/images/Hystrix/2018_10_08/02.png)

    > FROM [ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹](http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#problem9)
    > ![](http://www.iocoder.cn/images/Hystrix/2018_10_08/03.png)

# 3. BlockingObservable

æœ¬å°èŠ‚ä¸º**æ‹“å±•å†…å®¹**ï¼Œæºç è§£æ RxJava ( é Hystrix ) çš„ `rx.observables.BlockingObservable` çš„å®ç°ï¼Œæ‰€ä»¥ä½ å¯ä»¥é€‰æ‹©ï¼š

* 1 ) è·³è¿‡æœ¬å°èŠ‚ï¼Œä¸å½±å“å¯¹æœ¬æ–‡çš„ç†è§£ã€‚
* 2 ) é€‰æ‹©é˜…è¯» [ã€ŠReactiveX/RxJavaæ–‡æ¡£ä¸­æ–‡ç‰ˆ â€”â€” é˜»å¡æ“ä½œã€‹](https://mcxiaoke.gitbooks.io/rxdocs/content/operators/Blocking-Observable-Operators.html) ï¼Œç†è§£ BlockingObservable çš„åŸç†ã€‚
* 3 ) é€‰æ‹©é˜…è¯»æœ¬å°èŠ‚ï¼Œç†è§£ BlockingObservable çš„åŸç†ä»¥åŠå®ç°ã€‚

[ã€ŠRxJava æºç è§£æ â€”â€” BlockingObservableã€‹](http://www.iocoder.cn/RxJava/blocking-observable/)

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

ç¬¬ä¸€ç¯‡ Hystrix æ­£å¼çš„æºç è§£æã€‚

æ¢³ç† Hystrix çš„æºç è¿˜æ˜¯è›®ç—›è‹¦çš„ï¼Œä¸»è¦æ˜¯å› ä¸ºå¯¹ RxJava ä¸å¤Ÿç†Ÿæ‚‰ã€‚

èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼

