title: Hystrix æºç è§£æ â€”â€” è¯·æ±‚æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘
date: 2018-10-31
tags:
categories: Hystrix
permalink: Hystrix/command-execute-fourth-fallback

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Hystrix 1.5.X ç‰ˆæœ¬**  

- [1. æ¦‚è¿°](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [2. handleFallback](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [3. #handleShortCircuitViaFallback()](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [4. #handleSemaphoreRejectionViaFallback()](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [5. #handleThreadPoolRejectionViaFallback()](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [6. #handleTimeoutViaFallback()](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [7. #handleFailureViaFallback()](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [8. #getFallbackOrThrowException(...)](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)
- [666. å½©è›‹](http://www.iocoder.cn/Hystrix/command-execute-fourth-fallback/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Hystrix å‘½ä»¤æ‰§è¡Œï¼ˆå››ï¼‰ä¹‹å¤±è´¥å›é€€é€»è¾‘**ã€‚

å»ºè®® ï¼šå¯¹ RxJava å·²ç»æœ‰ä¸€å®šçš„äº†è§£çš„åŸºç¡€ä¸Šé˜…è¯»æœ¬æ–‡ã€‚

Hystrix æ‰§è¡Œå‘½ä»¤æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š

> FROM [ã€Šã€ç¿»è¯‘ã€‘Hystrixæ–‡æ¡£-å®ç°åŸç†ã€‹ã€Œæµç¨‹å›¾ã€](http://youdang.github.io/2016/02/05/translate-hystrix-wiki-how-it-works/#æµç¨‹å›¾)  
> ![](http://www.iocoder.cn/images/Hystrix/2018_10_31/01.jpeg)

* **çº¢**åœˆ ï¼šHystrix å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæ‰§è¡Œå›é€€é€»è¾‘ã€‚**ä¹Ÿå°±æ˜¯å¤§å®¶ç»å¸¸åœ¨æ–‡ç« ä¸­çœ‹åˆ°çš„â€œæœåŠ¡é™çº§â€**ã€‚
* **ç»¿**åœˆ ï¼šå››ç§æƒ…å†µä¼šè§¦å‘å¤±è´¥å›é€€é€»è¾‘( fallback )ã€‚
    * ç¬¬ä¸€ç§ ï¼š`short-circuit` ï¼Œå¤„ç†**é“¾è·¯å¤„äºç†”æ–­**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ3. #handleShortCircuitViaFallback()ã€](#) è¯¦ç»†è§£æã€‚ 
    * ç¬¬äºŒç§ ï¼š`semaphore-rejection` ï¼Œå¤„ç†**ä¿¡å·é‡è·å¾—å¤±è´¥**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ4. #handleShortCircuitViaFallback()ã€](#) è¯¦ç»†è§£æã€‚ 
    * ç¬¬ä¸‰ç§ ï¼š`thread-pool-rejection` ï¼Œå¤„ç†**çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ5. #handleThreadPoolRejectionViaFallback()ã€](#) è¯¦ç»†è§£æã€‚ 
    * ç¬¬å››ç§ ï¼š`execution-timeout` ï¼Œå¤„ç†**å‘½ä»¤æ‰§è¡Œè¶…æ—¶**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ6. #handleTimeoutViaFallback()ã€](#) è¯¦ç»†è§£æã€‚
    * ç¬¬äº”ç§ ï¼š`execution-failure` ï¼Œå¤„ç†**å‘½ä»¤æ‰§è¡Œå¼‚å¸¸**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ7. #handleFailureViaFallback()ã€](#) è¯¦ç»†è§£æã€‚
    * ç¬¬å…­ç§ ï¼š`bad-request` ï¼ŒTODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘ï¼Œå’Œ `hystrix-javanica` å­é¡¹ç›®ç›¸å…³ã€‚

å¦å¤–ï¼Œ`#handleXXXX()` æ–¹æ³•ï¼Œæ•´ä½“ä»£ç æ¯”è¾ƒç±»ä¼¼ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ `#getFallbackOrThrowException()` æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ [ã€Œ8. #getFallbackOrThrowException(...)ã€](#) è¯¦ç»†è§£æã€‚

-------

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)
* ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚



# 2. handleFallback

åœ¨ [ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ4. #executeCommandAndObserve(...)ã€](http://www.iocoder.cn/Hystrix/command-execute-first-run/?self) ä¸­ï¼Œ`#executeCommandAndObserve(...)` çš„**ç¬¬ 82 è¡Œ** `onErrorResumeNext(handleFallback)` ä»£ç ï¼Œé€šè¿‡è°ƒç”¨ `Observable#onErrorResumeNext(...)` æ–¹æ³•ï¼Œå®ç°ã€æ‰§è¡Œå‘½ä»¤ Observableã€‘æ‰§è¡Œå¼‚å¸¸æ—¶ï¼Œè¿”å›ã€å›é€€é€»è¾‘ Observableã€‘ï¼Œæ‰§è¡Œå¤±è´¥å›é€€é€»è¾‘ã€‚

> FROM [ã€ŠReactiveXæ–‡æ¡£ä¸­æ–‡ç¿»è¯‘ã€‹ã€ŒonErrorResumeNextã€](https://mcxiaoke.gitbooks.io/rxdocs/content/operators/Catch.html#onerrorreturn)  
> onErrorResumeNext æ–¹æ³•è¿”å›ä¸€ä¸ªé•œåƒåŸæœ‰ Observable è¡Œä¸ºçš„æ–° Observable ï¼Œåè€…ä¼šå¿½ç•¥å‰è€…çš„ onError è°ƒç”¨ï¼Œä¸ä¼šå°†é”™è¯¯ä¼ é€’ç»™è§‚å¯Ÿè€…ï¼Œä½œä¸ºæ›¿ä»£ï¼Œå®ƒä¼šå¼€å§‹é•œåƒå¦ä¸€ä¸ªï¼Œå¤‡ç”¨çš„ Observable ã€‚
> 
> * Javadoc: [onErrorResumeNext(Func1))](http://reactivex.io/RxJava/javadoc/rx/Observable.html#onErrorResumeNext-rx.functions.Func1-)
> * Javadoc: [onErrorResumeNext(Observable))](http://reactivex.io/RxJava/javadoc/rx/Observable.html#onErrorResumeNext-rx.Observable-)

[`handleFallback`](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L602) å˜é‡ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: final Func1<Throwable, Observable<R>> handleFallback = new Func1<Throwable, Observable<R>>() {
  2:     @Override
  3:     public Observable<R> call(Throwable t) {
  4:         // æ ‡è®°å°è¯•æˆåŠŸ
  5:         circuitBreaker.markNonSuccess();
  6:         // æ ‡è®° executionResult æ‰§è¡Œå¼‚å¸¸
  7:         Exception e = getExceptionFromThrowable(t);
  8:         executionResult = executionResult.setExecutionException(e);
  9:         // è¿”å› ã€å›é€€é€»è¾‘ Observableã€‘
 10:         if (e instanceof RejectedExecutionException) { // çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»å¼‚å¸¸
 11:             return handleThreadPoolRejectionViaFallback(e);
 12:         } else if (t instanceof HystrixTimeoutException) { // æ‰§è¡Œå‘½ä»¤è¶…æ—¶å¼‚å¸¸
 13:             return handleTimeoutViaFallback();
 14:         } else if (t instanceof HystrixBadRequestException) { // TODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘
 15:             return handleBadRequestByEmittingError(e);
 16:         } else {
 17:             /*
 18:              * Treat HystrixBadRequestException from ExecutionHook like a plain HystrixBadRequestException.
 19:              */
 20:             if (e instanceof HystrixBadRequestException) { // TODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘
 21:                 eventNotifier.markEvent(HystrixEventType.BAD_REQUEST, commandKey);
 22:                 return Observable.error(e);
 23:             }
 24: 
 25:             return handleFailureViaFallback(e);
 26:         }
 27:     }
 28: };
```
* ç¬¬ 5 è¡Œ ï¼šæ ‡è®°æ–­è·¯å™¨å°è¯•æˆåŠŸã€‚åœ¨ [ã€ŠHystrix æºç è§£æ â€”â€” æ–­è·¯å™¨ HystrixCircuitBreakerã€‹](http://www.iocoder.cn/Hystrix/circuit-breaker/?self) æœ‰è¯¦ç»†è§£æã€‚
* ç¬¬ 7 è‡³ 8 è¡Œ ï¼šæ ‡è®° `executionResult` **æ‰§è¡Œå¼‚å¸¸**ã€‚
* ç¬¬ 10 è‡³ 11 è¡Œ ï¼š`thread-pool-rejection` ï¼Œå¤„ç†**çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ5. #handleThreadPoolRejectionViaFallback()ã€](#) è¯¦ç»†è§£æã€‚ 
* ç¬¬ 12 è‡³ 13 è¡Œ ï¼š`execution-timeout` ï¼Œå¤„ç†**å‘½ä»¤æ‰§è¡Œè¶…æ—¶**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ6. #handleTimeoutViaFallback()ã€]() è¯¦ç»†è§£æã€‚
* ç¬¬ 14 è‡³ 23 è¡Œ ï¼šï¼Œ`bad-request` ï¼ŒTODO ã€2014ã€‘ã€HystrixBadRequestExceptionã€‘ï¼Œå’Œ `hystrix-javanica` å­é¡¹ç›®ç›¸å…³ã€‚
* ç¬¬ 25 è¡Œ ï¼š`execution-failure` å¤„ç†**å‘½ä»¤æ‰§è¡Œå¼‚å¸¸**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [ã€Œ7. #handleFailureViaFallback()ã€](#) è¯¦ç»†è§£æã€‚

# 3. #handleShortCircuitViaFallback()

`#handleShortCircuitViaFallback()` æ–¹æ³•ï¼Œ`short-circuit` ï¼Œå¤„ç†**é“¾è·¯å¤„äºç†”æ–­**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [æ­¤å¤„](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L558) è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```
  1: private Observable<R> handleShortCircuitViaFallback() {
  2:     // TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
  3:     // record that we are returning a short-circuited fallback
  4:     eventNotifier.markEvent(HystrixEventType.SHORT_CIRCUITED, commandKey);
  5:     // æ ‡è®° executionResult æ‰§è¡Œå¼‚å¸¸
  6:     // short-circuit and go directly to fallback (or throw an exception if no fallback implemented)
  7:     Exception shortCircuitException = new RuntimeException("Hystrix circuit short-circuited and is OPEN");
  8:     executionResult = executionResult.setExecutionException(shortCircuitException);
  9:     try {
 10:         // è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘
 11:         return getFallbackOrThrowException(this, HystrixEventType.SHORT_CIRCUITED, FailureType.SHORTCIRCUIT,
 12:                 "short-circuited", shortCircuitException);
 13:     } catch (Exception e) {
 14:         return Observable.error(e);
 15:     }
 16: }
```
* ç¬¬ 4 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
* ç¬¬ 7 è‡³ 8 è¡Œ ï¼šæ ‡è®° `executionResult` **æ‰§è¡Œå¼‚å¸¸**ã€‚
* ç¬¬ 11 è‡³ 12 è¡Œ ï¼šè°ƒç”¨ `#getFallbackOrThrowException()` æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ [ã€Œ8. #getFallbackOrThrowException(...)ã€](#) è¯¦ç»†è§£æã€‚
* ç¬¬ 14 è¡Œ ï¼šè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚

# 4. #handleSemaphoreRejectionViaFallback()

`#handleSemaphoreRejectionViaFallback()` æ–¹æ³•ï¼Œ`semaphore-rejection` ï¼Œå¤„ç†**ä¿¡å·é‡è·å¾—å¤±è´¥**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [æ­¤å¤„](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L555) è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: private Observable<R> handleSemaphoreRejectionViaFallback() {
  2:     // æ ‡è®° executionResult æ‰§è¡Œå¼‚å¸¸
  3:     Exception semaphoreRejectionException = new RuntimeException("could not acquire a semaphore for execution");
  4:     executionResult = executionResult.setExecutionException(semaphoreRejectionException);
  5:     // TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
  6:     eventNotifier.markEvent(HystrixEventType.SEMAPHORE_REJECTED, commandKey);
  7:     logger.debug("HystrixCommand Execution Rejection by Semaphore."); // debug only since we're throwing the exception and someone higher will do something with it
  8:     // retrieve a fallback or throw an exception if no fallback available
  9:     // è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘
 10:     return getFallbackOrThrowException(this, HystrixEventType.SEMAPHORE_REJECTED, FailureType.REJECTED_SEMAPHORE_EXECUTION,
 11:             "could not acquire a semaphore for execution", semaphoreRejectionException);
 12: }
```
* ç¬¬ 3 è‡³ 4 è¡Œ ï¼šæ ‡è®° `executionResult` **æ‰§è¡Œå¼‚å¸¸**ã€‚
* ç¬¬ 6 è‡³ 7 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
* ç¬¬ 10 è‡³ 11 è¡Œ ï¼šè°ƒç”¨ `#getFallbackOrThrowException()` æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ [ã€Œ8. #getFallbackOrThrowException(...)ã€](#) è¯¦ç»†è§£æã€‚

# 5. #handleThreadPoolRejectionViaFallback()

`#handleThreadPoolRejectionViaFallback()` æ–¹æ³•ï¼Œ`thread-pool-rejection` ï¼Œå¤„ç†**çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‹’ç»**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [æ­¤å¤„](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L990) è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
  1: private Observable<R> handleThreadPoolRejectionViaFallback(Exception underlying) {
  2:     // TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
  3:     eventNotifier.markEvent(HystrixEventType.THREAD_POOL_REJECTED, commandKey);
  4:     // TODO ã€2002ã€‘ã€metricsã€‘
  5:     threadPool.markThreadRejection();
  6:     // è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘
  7:     // use a fallback instead (or throw exception if not implemented)
  8:     return getFallbackOrThrowException(this, HystrixEventType.THREAD_POOL_REJECTED, FailureType.REJECTED_THREAD_EXECUTION,
  9:             "could not be queued for execution", underlying);
 10: }
```
* ç¬¬ 3 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
* ç¬¬ 5 è¡Œ ï¼šTODO ã€2002ã€‘ã€metricsã€‘
* ç¬¬ 8 è‡³ 9 è¡Œ ï¼šè°ƒç”¨ `#getFallbackOrThrowException()` æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ [ã€Œ8. #getFallbackOrThrowException(...)ã€](#) è¯¦ç»†è§£æã€‚

# 6. #handleTimeoutViaFallback()

`#handleTimeoutViaFallback()` æ–¹æ³•ï¼Œ`execution-timeout` ï¼Œå¤„ç†**å‘½ä»¤æ‰§è¡Œè¶…æ—¶**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [æ­¤å¤„](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L611) è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
  1: private Observable<R> handleTimeoutViaFallback() {
  2:     // è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘
  3:     return getFallbackOrThrowException(this, HystrixEventType.TIMEOUT, FailureType.TIMEOUT,
  4:             "timed-out", new TimeoutException());
  5: }
```
* ç¬¬ 3 è‡³ 4 è¡Œ ï¼šè°ƒç”¨ `#getFallbackOrThrowException()` æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ [ã€Œ8. #getFallbackOrThrowException(...)ã€](#) è¯¦ç»†è§£æã€‚

# 7. #handleFailureViaFallback()

`#handleFailureViaFallback()` æ–¹æ³•ï¼Œ`execution-failure` ï¼Œå¤„ç†**å‘½ä»¤æ‰§è¡Œå¼‚å¸¸**çš„å›é€€é€»è¾‘ï¼Œåœ¨ [æ­¤å¤„](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L623) è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
  1: private Observable<R> handleFailureViaFallback(Exception underlying) {
  2:     // TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
  3:     /**
  4:      * All other error handling
  5:      */
  6:     logger.debug("Error executing HystrixCommand.run(). Proceeding to fallback logic ...", underlying);
  7: 
  8:     // report failure
  9:     eventNotifier.markEvent(HystrixEventType.FAILURE, commandKey);
 10: 
 11:     // æ ‡è®° executionResult å¼‚å¸¸ TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€” ä¸ºå•¥ä¸æ˜¯æ‰§è¡Œå¼‚å¸¸
 12:     // record the exception
 13:     executionResult = executionResult.setException(underlying);
 14:     // è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ æˆ–è€… ã€å¼‚å¸¸ Observableã€‘
 15:     return getFallbackOrThrowException(this, HystrixEventType.FAILURE, FailureType.COMMAND_EXCEPTION, "failed", underlying);
 16: }
```
* ç¬¬ 2 è‡³ 9 è¡Œ ï¼šTODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
* ç¬¬ 13 è¡Œ ï¼šæ ‡è®° `executionResult` **å¼‚å¸¸**ã€‚
* ç¬¬ 15 è¡Œ ï¼šè°ƒç”¨ `#getFallbackOrThrowException()` æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œåœ¨ [ã€Œ8. #getFallbackOrThrowException(...)ã€](#) è¯¦ç»†è§£æã€‚

# 8. #getFallbackOrThrowException(...)

`#getFallbackOrThrowException()` æ–¹æ³•ï¼Œè·å¾—ã€å›é€€é€»è¾‘ Observableã€‘æˆ–è€…ã€å¼‚å¸¸ Observableã€‘ï¼Œä»£ç å¦‚ä¸‹ ï¼š

```Java
  1: private Observable<R> getFallbackOrThrowException(final AbstractCommand<R> _cmd, final HystrixEventType eventType, final FailureType failureType, final String message, final Exception originalException) {
  2:     // è®°å½• HystrixRequestContext
  3:     final HystrixRequestContext requestContext = HystrixRequestContext.getContextForCurrentThread();
  4:     // æ ‡è®° executionResult æ·»åŠ ( è®°å½• )äº‹ä»¶
  5:     long latency = System.currentTimeMillis() - executionResult.getStartTimestamp();
  6:     // record the executionResult
  7:     // do this before executing fallback so it can be queried from within getFallback (see See https://github.com/Netflix/Hystrix/pull/144)
  8:     executionResult = executionResult.addEvent((int) latency, eventType);
  9: 
 10:     if (isUnrecoverable(originalException)) { // æ— æ³•æ¢å¤çš„å¼‚å¸¸
 11:         logger.error("Unrecoverable Error for HystrixCommand so will throw HystrixRuntimeException and not apply fallback. ", originalException);
 12: 
 13:         // TODO ã€2003ã€‘ã€HOOKã€‘
 14:         /* executionHook for all errors */
 15:         Exception e = wrapWithOnErrorHook(failureType, originalException);
 16:         // è¿”å› ã€å¼‚å¸¸ Observableã€‘
 17:         return Observable.error(new HystrixRuntimeException(failureType, this.getClass(), getLogMessagePrefix() + " " + message + " and encountered unrecoverable error.", e, null));
 18:     } else {
 19:         if (isRecoverableError(originalException)) { // å¯æ¢å¤çš„å¼‚å¸¸
 20:             logger.warn("Recovered from java.lang.Error by serving Hystrix fallback", originalException);
 21:         }
 22: 
 23:         if (properties.fallbackEnabled().get()) {
 24:             /* fallback behavior is permitted so attempt */
 25: 
 26:             // è®¾ç½® HystrixRequestContext çš„ Action
 27:             final Action1<Notification<? super R>> setRequestContext = new Action1<Notification<? super R>>() {
 28:                 @Override
 29:                 public void call(Notification<? super R> rNotification) {
 30:                     setRequestContextIfNeeded(requestContext);
 31:                 }
 32:             };
 33: 
 34:             // TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”
 35:             final Action1<R> markFallbackEmit = new Action1<R>() {
 36:                 @Override
 37:                 public void call(R r) {
 38:                     if (shouldOutputOnNextEvents()) {
 39:                         executionResult = executionResult.addEvent(HystrixEventType.FALLBACK_EMIT);
 40:                         eventNotifier.markEvent(HystrixEventType.FALLBACK_EMIT, commandKey);
 41:                     }
 42:                 }
 43:             };
 44: 
 45:             // TODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”
 46:             final Action0 markFallbackCompleted = new Action0() {
 47:                 @Override
 48:                 public void call() {
 49:                     long latency = System.currentTimeMillis() - executionResult.getStartTimestamp();
 50:                     eventNotifier.markEvent(HystrixEventType.FALLBACK_SUCCESS, commandKey);
 51:                     executionResult = executionResult.addEvent((int) latency, HystrixEventType.FALLBACK_SUCCESS);
 52:                 }
 53:             };
 54: 
 55:             // å¤„ç†å¼‚å¸¸ çš„ Func
 56:             final Func1<Throwable, Observable<R>> handleFallbackError = new Func1<Throwable, Observable<R>>() {
 57:                 @Override
 58:                 public Observable<R> call(Throwable t) {
 59:                     // TODO ã€2003ã€‘ã€HOOKã€‘
 60:                     /* executionHook for all errors */
 61:                     Exception e = wrapWithOnErrorHook(failureType, originalException);
 62:                     // è·å¾— Exception
 63:                     Exception fe = getExceptionFromThrowable(t);
 64: 
 65:                     long latency = System.currentTimeMillis() - executionResult.getStartTimestamp();
 66:                     Exception toEmit;
 67: 
 68:                     if (fe instanceof UnsupportedOperationException) {
 69:                         // TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
 70:                         logger.debug("No fallback for HystrixCommand. ", fe); // debug only since we're throwing the exception and someone higher will do something with it
 71:                         eventNotifier.markEvent(HystrixEventType.FALLBACK_MISSING, commandKey);
 72:                         // æ ‡è®° executionResult æ·»åŠ ( è®°å½• )äº‹ä»¶ HystrixEventType.FALLBACK_MISSING
 73:                         executionResult = executionResult.addEvent((int) latency, HystrixEventType.FALLBACK_MISSING);
 74: 
 75:                         // åˆ›å»º HystrixRuntimeException
 76:                         toEmit = new HystrixRuntimeException(failureType, _cmd.getClass(), getLogMessagePrefix() + " " + message + " and no fallback available.", e, fe);
 77:                     } else {
 78:                         // TODO ã€2011ã€‘ã€Hystrix äº‹ä»¶æœºåˆ¶ã€‘
 79:                         logger.debug("HystrixCommand execution " + failureType.name() + " and fallback failed.", fe);
 80:                         eventNotifier.markEvent(HystrixEventType.FALLBACK_FAILURE, commandKey);
 81:                         // æ ‡è®° executionResult æ·»åŠ ( è®°å½• )äº‹ä»¶ HystrixEventType.FALLBACK_FAILURE
 82:                         executionResult = executionResult.addEvent((int) latency, HystrixEventType.FALLBACK_FAILURE);
 83: 
 84:                         // åˆ›å»º HystrixRuntimeException
 85:                         toEmit = new HystrixRuntimeException(failureType, _cmd.getClass(), getLogMessagePrefix() + " " + message + " and fallback failed.", e, fe);
 86:                     }
 87: 
 88:                     // NOTE: we're suppressing fallback exception here
 89:                     if (shouldNotBeWrapped(originalException)) {
 90:                         return Observable.error(e);
 91:                     }
 92: 
 93:                     return Observable.error(toEmit);
 94:                 }
 95:             };
 96: 
 97:             // è·å¾— TryableSemaphore
 98:             final TryableSemaphore fallbackSemaphore = getFallbackSemaphore();
 99: 
100:             // ä¿¡å·é‡é‡Šæ”¾Action
101:             final AtomicBoolean semaphoreHasBeenReleased = new AtomicBoolean(false);
102:             final Action0 singleSemaphoreRelease = new Action0() {
103:                 @Override
104:                 public void call() {
105:                     if (semaphoreHasBeenReleased.compareAndSet(false, true)) {
106:                         fallbackSemaphore.release();
107:                     }
108:                 }
109:             };
110: 
111:             Observable<R> fallbackExecutionChain;
112: 
113:             // acquire a permit
114:             if (fallbackSemaphore.tryAcquire()) {
115:                 try {
116:                     if (isFallbackUserDefined()) {
117:                         executionHook.onFallbackStart(this);
118:                         fallbackExecutionChain = getFallbackObservable();
119:                     } else {
120:                         //same logic as above without the hook invocation
121:                         fallbackExecutionChain = getFallbackObservable();
122:                     }
123:                 } catch (Throwable ex) {
124:                     //If hook or user-fallback throws, then use that as the result of the fallback lookup
125:                     fallbackExecutionChain = Observable.error(ex);
126:                 }
127: 
128:                 // è·å¾— ã€å›é€€é€»è¾‘ Observableã€‘
129:                 return fallbackExecutionChain
130:                         .doOnEach(setRequestContext)
131:                         .lift(new FallbackHookApplication(_cmd)) // TODO ã€2003ã€‘ã€HOOKã€‘
132:                         .lift(new DeprecatedOnFallbackHookApplication(_cmd))
133:                         .doOnNext(markFallbackEmit)
134:                         .doOnCompleted(markFallbackCompleted)
135:                         .onErrorResumeNext(handleFallbackError) //
136:                         .doOnTerminate(singleSemaphoreRelease)
137:                         .doOnUnsubscribe(singleSemaphoreRelease);
138:             } else {
139:                return handleFallbackRejectionByEmittingError();
140:             }
141:         } else {
142:             return handleFallbackDisabledByEmittingError(originalException, failureType, message);
143:         }
144:     }
145: }
```
* è€å¿ƒï¼Œè¿™ä¸ªæ–¹æ³•çœ‹èµ·æ¥ç°å¸¸é•¿ï¼Œä¹Ÿä»…é™äºé•¿ï¼Œç†è§£æˆéš¾åº¦å¾ˆå°ã€‚
* ç¬¬ 3 è¡Œ ï¼šè®°å½• HystrixRequestContext ã€‚
* ç¬¬ 5 è‡³ 8 è¡Œ ï¼šæ ‡è®° `executionResult` æ·»åŠ ( è®°å½• )äº‹ä»¶ã€‚
* ç¬¬ 10 è‡³ 17 è¡Œ ï¼šè°ƒç”¨ `#isUnrecoverable(Exception)` æ–¹æ³•ï¼Œè‹¥å¼‚å¸¸**ä¸å¯æ¢å¤**ï¼Œç›´æ¥è¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1077) æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚
* ç¬¬ 19 è‡³ 21 è¡Œ ï¼šè°ƒç”¨ `#isRecoverableError(Exception)` æ–¹æ³•ï¼Œè‹¥å¼‚å¸¸**å¯æ¢å¤**ï¼Œæ‰“å° `WARN` æ—¥å¿—ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1093) æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚ä¸»è¦é’ˆå¯¹ `java.lang.Error` æƒ…å†µï¼Œæ‰“å° `#isUnrecoverable(Exception)` æ’é™¤æ‰çš„ Errorã€‚
* ã€*åå‘*ã€‘ç¬¬ 141 è‡³ 143 è¡Œ ï¼šå½“é…ç½® `HystrixCommandProperties.fallbackEnabled = false` ( é»˜è®¤å€¼ ï¼š`true` ) ï¼Œå³å¤±è´¥å›é€€åŠŸèƒ½**å…³é—­**ï¼Œè°ƒç”¨ `#handleFallbackDisabledByEmittingError()` ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1047) æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚
* ã€*åå‘*ã€‘ç¬¬ 138 è‡³ 140 è¡Œ ï¼š**å¤±è´¥å›é€€**ä¿¡å·é‡( TryableSemaphore )ã€æ³¨æ„ï¼Œä¸æ˜¯**æ­£å¸¸æ‰§è¡Œ**ä¿¡å·é‡ã€‘ä½¿ç”¨å¤±è´¥ï¼Œè°ƒç”¨ `#handleFallbackRejectionByEmittingError()` ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1038) æŸ¥çœ‹è¯¥æ–¹æ³•ã€‚
* ç¬¬ 23 è¡Œ ï¼šå½“é…ç½® `HystrixCommandProperties.fallbackEnabled = true` ( é»˜è®¤å€¼ ï¼š`true` ) ï¼Œå³å¤±è´¥å›é€€åŠŸèƒ½**å¼€å¯**ã€‚
* ç¬¬ 27 è‡³ 32 è¡Œ ï¼šè®¾ç½® HystrixRequestContext çš„ Action ï¼Œä½¿ç”¨**ç¬¬ 3 è¡Œ**è®°å½•çš„ HystrixRequestContext ã€‚
* ç¬¬ 35 è‡³ 43 è¡Œ ï¼šTODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”
* ç¬¬ 46 è‡³ 53 è¡Œ ï¼šTODO ã€2007ã€‘ã€executionResultã€‘ç”¨é€”
* ç¬¬ 56 è‡³ 95 è¡Œ ï¼šå¤„ç†å›é€€é€»è¾‘æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸çš„ Func1 ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚
    * ç¬¬ 61 è¡Œ ï¼šTODO ã€2003ã€‘ã€HOOKã€‘
    * ç¬¬ 63 è¡Œ ï¼šè°ƒç”¨ `#getExceptionFromThrowable(Throwable)` æ–¹æ³•ï¼Œè·å¾— Exception ã€‚è‹¥ `t` çš„**ç±»å‹**ä¸º Throwable æ—¶ï¼ŒåŒ…è£…æˆ Exception ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1978) æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚
    * ç¬¬ 68 è‡³ 76 è¡Œ ï¼šå½“ `fe` çš„**ç±»å‹**ä¸º UnsupportedOperationException æ—¶ï¼Œä½¿ç”¨ `e` + `fe` åˆ›å»º HystrixRuntimeException ã€‚è¯¥å¼‚å¸¸å‘ç”Ÿäº `HystrixCommand#getFallback()` **æŠ½è±¡æ–¹æ³•**æœªè¢«è¦†å†™ã€‚
    * ç¬¬ 77 è‡³ 86 è¡Œ ï¼šå½“ `fe` çš„**ç±»å‹**ä¸ºå…¶ä»–å¼‚å¸¸æ—¶ï¼Œä½¿ç”¨ `e` + `fe` åˆ›å»º HystrixRuntimeException ã€‚è¯¥å¼‚å¸¸å‘ç”Ÿäº `HystrixCommand#getFallback()` æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸ã€‚
    * ç¬¬ 89 è‡³ 91 è¡Œ ï¼šè°ƒç”¨ `#shouldNotBeWrapped()` æ–¹æ³•ï¼Œåˆ¤æ–­ `originalException` æ˜¯ ExceptionNotWrappedByHystrix çš„**å®ç°**æ—¶ï¼Œå³**è¦æ±‚**è¿”å›çš„ã€å¼‚å¸¸ Observableã€‘ä¸ä½¿ç”¨ HystrixRuntimeException åŒ…è£…ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1057) æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚
    * ç¬¬ 93 è¡Œ ï¼šè¿”å›ã€å¼‚å¸¸ Observableã€‘ï¼Œä½¿ç”¨ `toEmit` ( HystrixRuntimeException ) ä¸ºå¼‚å¸¸ã€‚

* ç¬¬ 98 è¡Œ ï¼šè°ƒç”¨ `#getFallbackSemaphore()` æ–¹æ³•ï¼Œè·å¾—**å¤±è´¥å›é€€**ä¿¡å·é‡( TryableSemaphore )å¯¹è±¡ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/AbstractCommand.java#L1241) æŸ¥çœ‹è¯¥æ–¹æ³•ä»£ç ã€‚TryableSemaphore åœ¨ [ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹ã€Œ3. TryableSemaphoreã€](http://www.iocoder.cn/Hystrix/command-execute-first-run/?self) æœ‰è¯¦ç»†è§£æã€‚
* ç¬¬ 100 è‡³ 109 è¡Œ ï¼šä¿¡å·é‡**é‡Šæ”¾**çš„ Actionã€‚
* ç¬¬ 114 è‡³ 137 è¡Œ ï¼š**å¤±è´¥å›é€€**ä¿¡å·é‡( TryableSemaphore )ä½¿ç”¨æˆåŠŸï¼Œè¿”å›ã€å›é€€é€»è¾‘ Observableã€‘ã€‚
    * ã€é‡è¦ã€‘ç¬¬ 116 è‡³ 122 è¡Œ ï¼šè°ƒç”¨ `#getFallbackObservable()` æ–¹æ³•ï¼Œåˆ›å»ºã€å›é€€é€»è¾‘ Observableã€‘ã€‚å°†å­ç±»å¯¹ `HystrixCommand#getFallback()` **æŠ½è±¡æ–¹æ³•**çš„æ‰§è¡Œç»“æœï¼Œä½¿ç”¨ `Observable#just(...)` åŒ…è£…è¿”å›ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/Hystrix/blob/2655a1323a7b77fc65f31de82b40331797dc018d/hystrix-core/src/main/java/com/netflix/hystrix/HystrixCommand.java#L314) æŸ¥çœ‹è¯¥æ–¹æ³•çš„ä»£ç ã€‚
        * ç¬¬ 116 è¡Œ ï¼šè°ƒç”¨ `#isFallbackUserDefined()` æ–¹æ³•ï¼Œè¿”å›**å‘½ä»¤å­ç±»**æ˜¯å¦å®ç° `HystrixCommand#getFallback()` **æŠ½è±¡æ–¹æ³•**ã€‚åªæœ‰å·²å®ç°( `true` ) çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ HOOK TODO ã€2003ã€‘ã€HOOKã€‘ã€‚
    * ç¬¬ 129 è‡³ 137 è¡Œ ï¼šè·å¾— ã€å›é€€é€»è¾‘ Observableã€‘ã€‚
        * ç¬¬ 131 è¡Œ ï¼š// TODO ã€2003ã€‘ã€HOOKã€‘
        * ç¬¬ 135 è¡Œ ï¼šè°ƒç”¨ `Observable#onErrorResumeNext(...)` æ–¹æ³•ï¼Œå®ç°ã€å¤±è´¥å›é€€ Observableã€‘æ‰§è¡Œå¼‚å¸¸æ—¶ï¼Œè¿”å›ã€å¼‚å¸¸ Observableã€‘ã€‚


-------

æœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹ï¼š

* å½“å‘½ä»¤æ‰§è¡Œ**è¶…æ—¶**æ—¶ï¼Œå¤±è´¥å›é€€é€»è¾‘ä½¿ç”¨çš„æ˜¯ **HystrixTimer çš„çº¿ç¨‹æ± **ã€‚
* å¤±è´¥å›é€€é€»è¾‘ï¼Œæ— è¶…æ—¶æ—¶é—´ï¼Œä½¿ç”¨è¦å°å¿ƒã€‚

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

æ¯”æƒ³è±¡ä¸­â€œè‡­é•¿â€çš„é€»è¾‘ã€‚

æ€»çš„æ¥è¯´ï¼Œé€»è¾‘å’Œ [ã€ŠHystrix æºç è§£æ â€”â€” å‘½ä»¤æ‰§è¡Œï¼ˆä¸€ï¼‰ä¹‹æ­£å¸¸æ‰§è¡Œé€»è¾‘ã€‹](http://www.iocoder.cn/Hystrix/command-execute-first-run/?self) æ˜¯å¾ˆç±»ä¼¼çš„ã€‚

èƒ–å‹ï¼Œåˆ†äº«ä¸€æ³¢æœ‹å‹åœˆå¯å¥½ï¼


