title: Ribbon æºç åˆ†æç³»åˆ—(ä¸€)
date: 2018-01-04
tag: 
categories: Ribbon
permalink: Ribbon/ligang/ribbon-1
author: æåˆš
from_url: http://www.spring4all.com/article/230
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.spring4all.com/article/230 ã€Œæåˆšã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [ç®€ä»‹](http://www.iocoder.cn/Ribbon/ligang/ribbon-1/)
- [æ€æ ·ä½¿ç”¨Spring cloud ribbon](http://www.iocoder.cn/Ribbon/ligang/ribbon-1/)
- [RibbonåŸç†æ¦‚è§ˆ](http://www.iocoder.cn/Ribbon/ligang/ribbon-1/)
- [æ€»ç»“](http://www.iocoder.cn/Ribbon/ligang/ribbon-1/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

## ç®€ä»‹

Spring cloud ribbonåœ¨spring cloudå¾®æœåŠ¡ä½“ç³»ä¸­å……å½“ç€è´Ÿè½½å‡è¡¡çš„è§’è‰²ã€‚è¿™ä¸ªè´Ÿè½½å‡è¡¡æŒ‡çš„æ˜¯å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ã€‚æœ¬æ–‡æ˜¯ribbonæºç åˆ†æç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š

- æ€æ ·ä½¿ç”¨spring cloud ribbon
- ribbonåŸç†æ¦‚è§ˆ

## æ€æ ·ä½¿ç”¨Spring cloud ribbon

æˆ‘ä»¬çŸ¥é“ribbonæ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç›¸åŒçš„æœåŠ¡é›†ç¾¤ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œç„¶åè¿›è¡Œè®¿é—®ï¼Œå¹¶ä»è¯¥æœåŠ¡è·å–åˆ°ç»“æœã€‚è¿™é‡Œé¢ä¼šå¼•ç”³å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ç›¸åŒæœåŠ¡é›†ç¾¤çš„æ¥æºã€‚ribbonæœ‰ä¸¤ç§æ–¹å¼è·å–ï¼Œç¬¬ä¸€ç§æ˜¯é€šè¿‡`Eureka`(æ³¨å†Œä¸­å¿ƒ)ï¼Œè¿™ç§æ–¹å¼éœ€è¦ä½¿ç”¨ribbonçš„å·¥ç¨‹æ˜¯ä¸€ä¸ªEureka Clientä¹Ÿå°±æ˜¯è¯´éœ€è¦åœ¨å·¥ç¨‹çš„ä¸»å‡½æ•°ä¸Šä½¿ç”¨(`@EnableDiscoveryClient`),ç¬¬äºŒç§æ–¹å¼æ˜¯é€šè¿‡`properties`è¿›è¡Œé…ç½®ã€‚
æœ¬æ–‡ä¸»è¦ä»‹ç»çš„æ˜¯ç¬¬äºŒç§ã€‚
ä¸‹é¢ç»“åˆä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š

### æ·»åŠ å¯¹åº”ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-ribbon</artifactId>
</dependency>
```

### å®šä¹‰é…ç½®ç±»

```java
@Configuration
public class RibbonConfig {

    @LoadBalanced
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

å¦‚ä¸Šå›¾æ‰€ç¤ºåœ¨è¯¥é…ç½®ç±»ä¸­åˆ›å»º`RestTemplate`ï¼Œå¹¶ä¸”ä½¿ç”¨`@LoadBalanced`æ³¨è§£ã€‚è¯¥æ³¨è§£ä½¿å¾—`RestTemplate`å…·æœ‰äº†å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚

### propertiesæ–‡ä»¶

```properties
spring.application.name=ribbon-client
users.ribbon.listOfServers=http://localhost:8081,http://localhost:8082
```

`users.ribbon.listOfServers`è¿™ä¸ªå‚æ•°å¾ˆå…³é”®ï¼Œå®ƒçš„å«ä¹‰æ˜¯æŒ‡å®šæœåŠ¡(é›†ç¾¤)çš„åœ°å€ï¼Œå…¶ä¸­`users`æ˜¯è‡ªå®šä¹‰çš„Keyã€‚æœ¬æ–‡ä¸­æœ‰ä¸¤ä¸ªç›¸åŒçš„æœåŠ¡ï¼Œå®ƒä»¬çš„åœ°å€åˆ†åˆ«ä¸º`http://localhost:8081`ä»¥åŠ`http://localhost:8082`

### å®šä¹‰ä¸€ä¸ªController(Ribbon-Clientç«¯)

```java
@RestController
public class DemoController {

    private static final String URL = "http://users/hello";

    @Autowired
    private RestTemplate restTemplate;

    @RequestMapping(value = "/ribbon")
    public String ribbon() {
        return this.restTemplate.getForObject(DemoController.URL, String.class);
    }

}
```

### åç«¯Serverä»£ç (8081ã€8082)

```java
@RequestMapping(value = "demo")
public String demo() {
   return "this is 8081 server...";
}
```

```java
@RequestMapping(value = "demo")
public String demo() {
   return "this is 8082 server...";
}
```

æ­¤æ—¶å½“æˆ‘ä»¬è®¿é—®[http://localhost:8080/ribbonå¹¶ä¸”ä¸æ–­åˆ·æ–°æµè§ˆå™¨(å¤šæ¬¡è®¿é—®è¯¥æ¥å£)ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`http://localhost:8081/hello`ã€`http://localhost:8082/hello`è¿™ä¸¤ä¸ªæ¥å£åå¤è¢«è°ƒç”¨ã€‚(äº¤æ›¿è¿”å›`this](http://localhost:8080/ribbon%E5%B9%B6%E4%B8%94%E4%B8%8D%E6%96%AD%E5%88%B7%E6%96%B0%E6%B5%8F%E8%A7%88%E5%99%A8(%E5%A4%9A%E6%AC%A1%E8%AE%BF%E9%97%AE%E8%AF%A5%E6%8E%A5%E5%8F%A3)%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%60http://localhost:8081/hello%60%E3%80%81%60http://localhost:8082/hello%60%E8%BF%99%E4%B8%A4%E4%B8%AA%E6%8E%A5%E5%8F%A3%E5%8F%8D%E5%A4%8D%E8%A2%AB%E8%B0%83%E7%94%A8%E3%80%82(%E4%BA%A4%E6%9B%BF%E8%BF%94%E5%9B%9E%60this) is 8081 serverâ€¦`å’Œ`this is 8082 serverâ€¦`)
è‡³æ­¤é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬å®Œæˆäº†ä½¿ç”¨ribbonæ¥å®Œæˆå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥é€šè¿‡æºç äº†è§£ä¸‹å…¶ä¸­çš„åŸç†ã€‚

## RibbonåŸç†æ¦‚è§ˆ

é€šè¿‡æºç åˆ†æï¼Œä¸ªäººè®¤ä¸ºå¯ä»¥æ‹†è§£ä¸ºå¦‚ä¸‹éƒ¨åˆ†ï¼š

- 1.è·å–`@LoadBalanced`æ³¨è§£æ ‡è®°çš„`RestTemplate`ã€‚
- 2.`RestTemplate`æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨(filter)ï¼Œå½“ä½¿ç”¨`RestTemplate`å‘èµ·httpè°ƒç”¨æ—¶è¿›è¡Œæ‹¦æˆªã€‚
- 3.åœ¨filteræ‹¦æˆªåˆ°è¯¥è¯·æ±‚æ—¶ï¼Œè·å–è¯¥æ¬¡è¯·æ±‚æœåŠ¡é›†ç¾¤çš„å…¨éƒ¨åˆ—è¡¨ä¿¡æ¯ã€‚
- 4.æ ¹æ®è§„åˆ™ä»é›†ç¾¤ä¸­é€‰å–ä¸€ä¸ªæœåŠ¡ä½œä¸ºæ­¤æ¬¡è¯·æ±‚è®¿é—®çš„ç›®æ ‡ã€‚
- 5.è®¿é—®è¯¥ç›®æ ‡ï¼Œå¹¶è·å–è¿”å›ç»“æœã€‚

### è·å–[@LoadBalanced](https://github.com/LoadBalanced)æ³¨è§£æ ‡è®°çš„RestTemplateã€‚

Ribbonå°†æ‰€æœ‰æ ‡è®°`@LoadBalanced`æ³¨è§£çš„`RestTemplate`ä¿å­˜åˆ°ä¸€ä¸ªListé›†åˆå½“ä¸­ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

```java
@LoadBalanced
@Autowired(required = false)
private List<RestTemplate> restTemplates = Collections.emptyList();
```

å…·ä½“æºç ä½ç½®æ˜¯åœ¨`LoadBalancerAutoConfiguration`ä¸­ã€‚

### RestTemplateæ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨(filter)

RestTemplateæ·»åŠ æ‹¦æˆªå™¨éœ€è¦æœ‰ä¸¤ä¸ªæ­¥éª¤ï¼Œé¦–å…ˆæ˜¯å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå…¶æ¬¡æ˜¯å°†å®šä¹‰çš„æ‹¦æˆªå™¨æ·»åŠ åˆ°RestTemplateä¸­ã€‚

#### å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨

å®ç°`ClientHttpRequestInterceptor`æ¥å£å°±å…·å¤‡äº†æ‹¦æˆªè¯·æ±‚çš„åŠŸèƒ½ï¼Œè¯¥æ¥å£æºç å¦‚ä¸‹ï¼š

```java
public interface ClientHttpRequestInterceptor {
    /**
     *å®ç°è¯¥æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•å†…å®Œæˆæ‹¦æˆªè¯·æ±‚åçš„é€»è¾‘å†…å®¹ã€‚
     *å¯¹äºribbonè€Œè¨€ï¼Œåœ¨è¯¥æ–¹æ³•å†…å®Œæˆäº†æ ¹æ®å…·ä½“è§„åˆ™ä»
     *æœåŠ¡é›†ç¾¤ä¸­é€‰å–ä¸€ä¸ªæœåŠ¡ï¼Œå¹¶å‘è¯¥æœåŠ¡å‘èµ·è¯·æ±‚çš„æ“ä½œã€‚
     */
   ClientHttpResponse intercept(HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException;

}
```

ribbonä¸­å¯¹åº”çš„å®ç°ç±»æ˜¯`LoadBalancerInterceptor`(ä¸ä½¿ç”¨`spring-retry`çš„æƒ…å†µä¸‹)å…·ä½“æºç å¦‚ä¸‹ï¼š

```java
public class LoadBalancerInterceptor implements ClientHttpRequestInterceptor {

   private LoadBalancerClient loadBalancer;
   private LoadBalancerRequestFactory requestFactory;

    //çœç•¥æ„é€ å™¨ä»£ç ...

   @Override
   public ClientHttpResponse intercept(final HttpRequest request, final byte[] body,
         final ClientHttpRequestExecution execution) throws IOException {
      final URI originalUri = request.getURI();
      String serviceName = originalUri.getHost();
      /**
       *æ‹¦æˆªè¯·æ±‚ï¼Œå¹¶è°ƒç”¨loadBalancer.execute()æ–¹æ³•
       *åœ¨è¯¥æ–¹æ³•å†…éƒ¨å®Œæˆserverçš„é€‰å–ã€‚å‘é€‰å–çš„server
       *å‘èµ·è¯·æ±‚ï¼Œå¹¶è·å¾—è¿”å›ç»“æœã€‚
       */
      return this.loadBalancer.execute(serviceName, requestFactory.createRequest(request, body, execution));
   }
}
```

#### å°†æ‹¦æˆªå™¨æ·»åŠ åˆ°RestTemplateä¸­

`RestTemplate`ç»§æ‰¿äº†`InterceptingHttpAccessor`ï¼Œåœ¨`InterceptingHttpAccessor`ä¸­æä¾›äº†è·å–ä»¥åŠæ·»åŠ æ‹¦æˆªå™¨çš„æ–¹æ³•ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

```java
public abstract class InterceptingHttpAccessor extends HttpAccessor {

    /**
     * æ‰€æœ‰çš„æ‹¦æˆªå™¨æ˜¯ä»¥ä¸€ä¸ªListé›†åˆå½¢å¼è¿›è¡Œä¿å­˜ã€‚
     */
   private List<ClientHttpRequestInterceptor> interceptors = new ArrayList<ClientHttpRequestInterceptor>();

   /**
    * è®¾ç½®æ‹¦æˆªå™¨ã€‚
    */
   public void setInterceptors(List<ClientHttpRequestInterceptor> interceptors) {
      this.interceptors = interceptors;
   }

   /**
    * è·å–å½“å‰çš„æ‹¦æˆªå™¨ã€‚
    */
   public List<ClientHttpRequestInterceptor> getInterceptors() {
      return interceptors;
   }

   //çœç•¥éƒ¨åˆ†ä»£ç ...
}
```

é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•æˆ‘ä»¬å°±å¯ä»¥å°†åˆšæ‰å®šä¹‰çš„`LoadBalancerInterceptor`æ·»åŠ åˆ°æœ‰`@LoadBalanced`æ³¨è§£æ ‡è¯†çš„`RestTemplate`ä¸­ã€‚å…·ä½“çš„æºç å¦‚ä¸‹(LoadBalancerAutoConfiguration)çœç•¥éƒ¨åˆ†ä»£ç ï¼š

```java
public class LoadBalancerAutoConfiguration {

    /**
      * è·å–æ‰€æœ‰å¸¦æœ‰@LoadBalancedæ³¨è§£çš„restTemplate
     */
   @LoadBalanced
   @Autowired(required = false)
   private List<RestTemplate> restTemplates = Collections.emptyList();

    /**
     * åˆ›å»ºSmartInitializingSingletonæ¥å£çš„å®ç°ç±»ã€‚Springä¼šåœ¨æ‰€æœ‰
     * å•ä¾‹Beanåˆå§‹åŒ–å®Œæˆåå›è°ƒè¯¥å®ç°ç±»çš„afterSingletonsInstantiated()
     * æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šä¸ºæ‰€æœ‰è¢«@LoadBalancedæ³¨è§£æ ‡è¯†çš„
     * RestTemplateæ·»åŠ ribbonçš„è‡ªå®šä¹‰æ‹¦æˆªå™¨LoadBalancerInterceptorã€‚
     */
   @Bean
   public SmartInitializingSingleton loadBalancedRestTemplateInitializer(
         final List<RestTemplateCustomizer> customizers) {
      return new SmartInitializingSingleton() {
         @Override
         public void afterSingletonsInstantiated() {
            for (RestTemplate restTemplate : LoadBalancerAutoConfiguration.this.restTemplates) {
               for (RestTemplateCustomizer customizer : customizers) {
                  customizer.customize(restTemplate);
               }
            }
         }
      };
   }
    /**
     * åˆ›å»ºRibbonè‡ªå®šä¹‰æ‹¦æˆªå™¨LoadBalancerInterceptor
     * åˆ›å»ºå‰ææ˜¯å½“å‰classpathä¸‹ä¸å­˜åœ¨spring-retryã€‚
     * æ‰€ä»¥LoadBalancerInterceptoræ˜¯é»˜è®¤çš„Ribbonæ‹¦æˆª
     * è¯·æ±‚çš„æ‹¦æˆªå™¨ã€‚
     */
    @Configuration
    @ConditionalOnMissingClass("org.springframework.retry.support.RetryTemplate")
   static class LoadBalancerInterceptorConfig {
      @Bean
      public LoadBalancerInterceptor ribbonInterceptor(
            LoadBalancerClient loadBalancerClient,
            LoadBalancerRequestFactory requestFactory) {
         return new LoadBalancerInterceptor(loadBalancerClient, requestFactory);
      }

      /**
       * æ·»åŠ æ‹¦æˆªå™¨å…·ä½“æ–¹æ³•ã€‚é¦–å…ˆè·å–å½“å‰æ‹¦æˆªå™¨é›†åˆ(List)
       * ç„¶åå°†loadBalancerInterceptoræ·»åŠ åˆ°å½“å‰é›†åˆä¸­
       * æœ€åå°†æ–°çš„é›†åˆæ”¾å›åˆ°restTemplateä¸­ã€‚
       */
      @Bean
      @ConditionalOnMissingBean
      public RestTemplateCustomizer restTemplateCustomizer(
            final LoadBalancerInterceptor loadBalancerInterceptor) {
         return new RestTemplateCustomizer() {
            @Override
            public void customize(RestTemplate restTemplate) {
               List<ClientHttpRequestInterceptor> list = new ArrayList<>(
                     restTemplate.getInterceptors());
               list.add(loadBalancerInterceptor);
               restTemplate.setInterceptors(list);
            }
         };
      }
   }
}
```

è‡³æ­¤çŸ¥é“äº†ribbonæ‹¦æˆªè¯·æ±‚çš„åŸºæœ¬åŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹Ribbonæ˜¯æ€æ ·é€‰å–serverçš„ã€‚

#### Ribboné€‰å–serveråŸç†æ¦‚è§ˆ

é€šè¿‡ä¸Šé¢çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“äº†å½“å‘èµ·è¯·æ±‚æ—¶ribbonä¼šç”¨`LoadBalancerInterceptor`è¿™ä¸ªæ‹¦æˆªå™¨è¿›è¡Œæ‹¦æˆªã€‚åœ¨è¯¥æ‹¦æˆªå™¨ä¸­ä¼šè°ƒç”¨`LoadBalancerClient.execute()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
public <T> T execute(String serviceId, LoadBalancerRequest<T> request) throws IOException {
  /**
   *åˆ›å»ºloadBalancerçš„è¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºç»„è£…é€‰å–æœåŠ¡çš„è§„åˆ™(IRule)ã€
   *æœåŠ¡é›†ç¾¤çš„åˆ—è¡¨(ServerList)ã€æ£€éªŒæœåŠ¡æ˜¯å¦å­˜æ´»(IPing)ç­‰ç‰¹æ€§
   *çš„è¿‡ç¨‹(åŠ è½½RibbonClientConfigurationè¿™ä¸ªé…ç½®ç±»)ï¼Œéœ€è¦æ³¨æ„
   *çš„æ˜¯è¿™ä¸ªè¿‡ç¨‹å¹¶ä¸æ˜¯åœ¨å¯åŠ¨æ—¶è¿›è¡Œçš„ï¼Œè€Œæ˜¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶æ‰ä¼šå¤„ç†ã€‚
   */
   ILoadBalancer loadBalancer = getLoadBalancer(serviceId);

   /**
    * æ ¹æ®ILoadBalanceræ¥é€‰å–å…·ä½“çš„ä¸€ä¸ªServerã€‚
    * é€‰å–çš„è¿‡ç¨‹æ˜¯æ ¹æ®IRuleã€IPingã€ServerList
    * ä½œä¸ºå‚ç…§ã€‚
    */
   Server server = getServer(loadBalancer);
   if (server == null) {
      throw new IllegalStateException("No instances available for " + serviceId);
   }
   RibbonServer ribbonServer = new RibbonServer(serviceId, server, isSecure(server,
         serviceId), serverIntrospector(serviceId).getMetadata(server));

   return execute(serviceId, ribbonServer, request);
}
```

é€šè¿‡ä»£ç æˆ‘ä»¬å¯çŸ¥ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ª`ILoadBalancer`ï¼Œè¿™ä¸ª`ILoadBalancer`æ˜¯Ribbonçš„æ ¸å¿ƒç±»ã€‚å¯ä»¥ç†è§£æˆå®ƒåŒ…å«äº†é€‰å–æœåŠ¡çš„è§„åˆ™(`IRule`)ã€æœåŠ¡é›†ç¾¤çš„åˆ—è¡¨(`ServerList`)ã€æ£€éªŒæœåŠ¡æ˜¯å¦å­˜æ´»(`IPing`)ç­‰ç‰¹æ€§ï¼ŒåŒæ—¶å®ƒä¹Ÿå…·æœ‰äº†æ ¹æ®è¿™äº›ç‰¹æ€§ä»æœåŠ¡é›†ç¾¤ä¸­é€‰å–å…·ä½“ä¸€ä¸ªæœåŠ¡çš„èƒ½åŠ›ã€‚
`Server server = getServer(loadBalancer);`è¿™è¡Œä»£ç å°±æ˜¯é€‰å–ä¸¾ä¸€ä¸ªå…·ä½“serverã€‚
æœ€ç»ˆè°ƒç”¨äº†å†…éƒ¨çš„`execute`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹(åªä¿ç•™äº†æ ¸å¿ƒä»£ç )ï¼š

```java
@Override
public <T> T execute(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest<T> request) throws IOException {
   try {
      //å‘èµ·è°ƒç”¨
      T returnVal = request.apply(serviceInstance);
      statsRecorder.recordStats(returnVal);
      return returnVal;
   }
   catch (IOException ex) {
      statsRecorder.recordStats(ex);
      throw ex;
   }
   catch (Exception ex) {
      statsRecorder.recordStats(ex);
      ReflectionUtils.rethrowRuntimeException(ex);
   }
   return null;
}
```

æ¥ä¸‹æ¥çœ‹ä¸‹`request.apply(serviceInstance)`æ–¹æ³•çš„å…·ä½“åšäº†é‚£äº›äº‹æƒ…(LoadBalancerRequestFactoryä¸­)ï¼š

```java
@Override
public ClientHttpResponse apply(final ServiceInstance instance)
      throws Exception {
   HttpRequest serviceRequest = new ServiceRequestWrapper(request, instance, loadBalancer);
   //çœç•¥éƒ¨åˆ†ä»£ç ...
   /**
    * å‘èµ·çœŸæ­£è¯·æ±‚ã€‚
    */
   return execution.execute(serviceRequest, body);
}
```

çœ‹åˆ°è¿™é‡Œæ•´ä½“æµç¨‹çš„åŸç†å°±è¯´å®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆä¸€å¼ å›¾æ¥å›é¡¾ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼š

![img](http://springforall.ufile.ucloud.com.cn/static/img/e9998448e095176c2454fafd66ea57ab1511332)

é¦–å…ˆè·å–æ‰€æœ‰æ ‡è¯†`@LoadBalanced`æ³¨è§£çš„`RestTemplate`(å¯ä»¥ç†è§£æˆè·å–é‚£äº›å¼€å¯äº†Ribbonè´Ÿè½½å‡è¡¡åŠŸèƒ½çš„`RestTemplate`)ï¼Œç„¶åå°†Ribboné»˜è®¤çš„æ‹¦æˆªå™¨`LoadBalancerInterceptor`æ·»åŠ åˆ°`RestTemplate`ä¸­ï¼Œè¿™æ ·å½“ä½¿ç”¨`RestTemplate`å‘èµ·httpè¯·æ±‚æ—¶å°±ä¼šèµ·åˆ°æ‹¦æˆªçš„ä½œç”¨ã€‚å½“æœ‰è¯·æ±‚å‘èµ·æ—¶ï¼Œribboné»˜è®¤çš„æ‹¦æˆªå™¨é¦–å…ˆä¼šåˆ›å»º`ILoadBalancer`(é‡Œé¢åŒ…å«äº†é€‰å–æœåŠ¡çš„è§„åˆ™(`IRule`)ã€æœåŠ¡é›†ç¾¤çš„åˆ—è¡¨(`ServerList`)ã€æ£€éªŒæœåŠ¡æ˜¯å¦å­˜æ´»(`IPing`)ç­‰ç‰¹æ€§)ã€‚åœ¨ä»£ç å±‚é¢çš„å«ä¹‰æ˜¯åŠ è½½`RibbonClientConfiguration`é…ç½®ç±»)ã€‚ç„¶åä½¿ç”¨`ILoadBalancer`ä»æœåŠ¡é›†ç¾¤ä¸­é€‰æ‹©ä¸€ä¸ªæœåŠ¡ï¼Œæœ€åå‘è¿™ä¸ªæœåŠ¡å‘é€è¯·æ±‚ã€‚

## æ€»ç»“

æœ¬æ–‡é¦–å…ˆä»¥ä¸€ä¸ªç®€å•ä¾‹å­ä»‹ç»äº†æ€æ ·ä½¿ç”¨ribbonå®Œæˆå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œç„¶åç»“åˆæºç ç®€æ˜çš„è¯´æ˜äº†ribbonè´Ÿè½½å‡è¡¡çš„å†…éƒ¨åŸç†ã€‚ä½†æ˜¯è‡³äºæ€æ ·åˆ›å»º`ILoadBalancer`ä»¥åŠ`IRule`ã€`IPing`ç­‰å…·ä½“å®ç°ç»†èŠ‚è¿˜æœ‰é€‰å–æœåŠ¡çš„å…·ä½“è¿‡ç¨‹æœ¬æ–‡æ²¡æœ‰è¯¦ç»†ä»‹ç»ï¼Œåç»­æ–‡ç« ä¼šé™†ç»­ä»‹ç»ã€‚

ç”±äºæ°´å¹³æœ‰é™å¯èƒ½æœ‰äº›é—®é¢˜æ²¡æœ‰é˜è¿°æ¸…æ¥šï¼Œè¿˜è¯·å¤§å®¶å¤šå¤šç•™è¨€è®¨è®ºã€‚
æœ€åæ„Ÿè°¢Spring4allç¤¾åŒºæä¾›è¿™ä¸ªå¹³å°ï¼Œèƒ½è®©å¤§å®¶äº¤æµå­¦ä¹ Springç›¸å…³çŸ¥è¯†ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Ribbon   æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)