title: Ribbon æºç é˜…è¯»
date: 2018-01-07
tag: 
categories: Ribbon
permalink: Ribbon/erdaoya/ribbon
author: äºŒé“æ¶¯
from_url: http://thoreauz.com/2017/08/11/language/java/spring%20cloud/Ribbon%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://thoreauz.com/2017/08/11/language/java/spring%20cloud/Ribbon%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/ ã€ŒäºŒé“æ¶¯ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [common åŒ…](http://www.iocoder.cn/Ribbon/erdaoya/ribbon/)
- [restTemplateæ•´åˆ](http://www.iocoder.cn/Ribbon/erdaoya/ribbon/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

Ribbonæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡è½¯ä»¶ï¼Œé€šè¿‡æ³¨å†Œåˆ°Eurekaä¸Šçš„æœåŠ¡åï¼Œè·å–æœåŠ¡åˆ—è¡¨ï¼Œç¼“å­˜åˆ°æœ¬åœ°ï¼Œé€‰æ‹©è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå‘é€httpè¯·æ±‚ã€‚
åœ¨spring cloudå¯ä»¥é€šè¿‡ç®€å•é…ç½®ï¼Œå³å¯å®Œæˆå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œç”¨æ³•å¦‚ä¸‹ï¼šé…ç½®ï¼Œæ³¨å…¥ï¼Œè¯·æ±‚

```java
 @Bean
@LoadBalanced
RestTemplate restTemplate() {
    return new RestTemplate();

}
@Autowired
private RestTemplate restTemplate;

public Object getUser(Long id) {
    return restTemplate.getForEntity("http://CLOUD-SERVICE-USER/user/persionalInfo?id=" + id, Object.class).getBody();
}
```

å¸¦ç€é—®é¢˜çœ‹æºç ï¼š

1. Ribbonæ€ä¹ˆå’ŒRestTemplateæ•´åˆ
2. æ€ä¹ˆæ ·è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç®—æ³•
3. åº•å±‚httpå®¢æˆ·ç«¯æ€ä¹ˆä¿®æ”¹

## common åŒ…

åœ¨spring-cloud-commonä¸­æä¾›äº†è¿™æ ·ä¸€ä¸ªæ¥å£`LoadBalancerClient`ï¼Œæ³¨é‡Šè¯´æ˜æ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ã€‚

```java
public interface LoadBalancerClient extends ServiceInstanceChooser {
	<T> T execute(String serviceId, LoadBalancerRequest<T> request) throws IOException;
	/**
	 * ä½¿ç”¨æ¥è‡ªLoadBalancerçš„ServiceInstanceï¼Œå¯¹èµ·æ‰§è¡Œè¯·æ±‚
	 * @param serviceId
	 * @param æœåŠ¡å®ä¾‹
	 * @param Requestã€‚å…è®¸åœ¨æ‰§è¡Œå‰åæ·»åŠ metric
	 * @return å›è°ƒç»“æœ
	 */
	<T> T execute(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest<T> request) throws IOException;
	/**
	 * åˆ›å»ºä¸€ä¸ªçœŸæ­£çš„URLåŒ…å«ä¸»æœºå’Œç«¯å£ï¼š
	 * http://myservice/path/to/service --> http://host:port/path/to/service
	 * @param æœåŠ¡å®ä¾‹
	 * @param æºurlï¼Œæ˜¯ä¸€ä¸ªåŒ…å«serviceIdæˆ–è€…dnsçš„URL
	 * @return é‡æ–°æ„é€ çš„URL
	 */
	URI reconstructURI(ServiceInstance instance, URI original);
}
```

æ­¤æ¥å£æä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œç»§æ‰¿ServiceInstanceChooserï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹è¿™ä¸ªæ¥å£ï¼š

```java
public interface ServiceInstanceChooser {
    ServiceInstance choose(String serviceId);
}
```

è¿™ä¸ªæ¥å£åªæä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼šé€šè¿‡serviceIdè·å–éœ€è¦è®¿é—®çš„å®ä¾‹ã€‚è€ŒRibbonåˆ™å®ç°äº†LoadBalancerClientã€‚

[![img](http://thoreauz.com/images/2017-08-11-00-34-40.jpg)](http://thoreauz.com/images/2017-08-11-00-34-40.jpg)

ä¸‹é¢åˆ†æè¿™ä¸ªç±»æ€ä¹ˆå…·ä½“å®ç°æ¥å£ä¸­çš„chooseæ–¹æ³•ï¼š

### chooseå®ç°

```java
@Override
public ServiceInstance choose(String serviceId) {
	Server server = getServer(serviceId);
	if (server == null) {
		return null;
	}
	return new RibbonServer(serviceId, server, isSecure(server, serviceId),
			serverIntrospector(serviceId).getMetadata(server));
}
```

ç¬¬ä¸€è¡Œè¿”å›ä¸€ä¸ªserverï¼ŒserveråŒ…å«äº†æœåŠ¡çš„åœ°å€ç«¯å£å’ŒçŠ¶æ€åŒºåŸŸç­‰ä¿¡æ¯ï¼Œé€šè¿‡serviceIdè·å–è¿™ä¸ªæœåŠ¡æ˜¯å…³é”®ã€‚

```java
Server{
	public static final String UNKNOWN_ZONE = "UNKNOWN";
    private String host;
    private int port = 80;
    private volatile String id;
    private volatile boolean isAliveFlag;
    private String zone = "UNKNOWN";
    private volatile boolean readyToServe = true;
}
```

å†çœ‹è·å–æœåŠ¡çš„æ–¹æ³•ï¼š

```java
protected Server getServer(String serviceId) {
	return getServer(getLoadBalancer(serviceId));
}
protected Server getServer(ILoadBalancer loadBalancer) {
	if (loadBalancer == null) {
		return null;
	}
	return loadBalancer.chooseServer("default"); // TODO: better handling of key
}
```

è·å–ILoadBalancerå¯¹è±¡ï¼Œå†ä¼ é€’ç»™å¦ä¸€ä¸ªåŒåæ–¹æ³•ã€‚ä¸‹é¢åˆ†æILoadBalanceråŠå…¶å®ç°æˆäº†é‡ç‚¹ã€‚

[![img](http://thoreauz.com/images/2017-08-11-10-42-59.jpg)](http://thoreauz.com/images/2017-08-11-10-42-59.jpg)

è¿½æŸ¥ILoadBalancerçš„å®ç°ï¼Œæœ€ç»ˆè½å®åˆ°DynamicServerListLoadBalancerï¼Œä¸‹é¢ä»æ¥å£å¼€å§‹åˆ†æè¿™ä¸ªå®ç°ç±»ã€‚
å…ˆçœ‹å‡ ä¸ªæŠ½è±¡ç±»å’Œæ¥å£ä¸­éœ€è¦å®ç°çš„æ–¹æ³•ï¼š

```java
public interface ILoadBalancer {
    void addServers(List<Server> var1); // åˆå§‹åŒ–æœåŠ¡åˆ—è¡¨
    Server chooseServer(Object var1);	// ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæœåŠ¡
    void markServerDown(Server var1);	// æ ‡è®°æœåŠ¡ä¸ºdown
    List<Server> getReachableServers();	// è·å–upå’Œreachableçš„æœåŠ¡
    List<Server> getAllServers();		//è·å–æ‰€æœ‰æœåŠ¡ï¼ˆreachable and unreachableï¼‰
}
 public abstract List<Server> getServerList(ServerGroup serverGroup);
 public abstract LoadBalancerStats getLoadBalancerStats();
 public void primeCompleted(Server s, Throwable lastException);
 public abstract void initWithNiwsConfig(IClientConfig clientConfig);
```

æ¥ç€å†çœ‹ä¸‹é¢è°ƒç”¨é“¾ï¼šä¸‹é¢åˆ—å‡ºçš„ä»£ç ä¸­çœç•¥äº†å¾ˆå¤šé€»è¾‘ã€‚

```java
public ILoadBalancer getLoadBalancer(String name) {
	return getInstance(name, ILoadBalancer.class);
}

//ç±»ï¼šDynamicServerListLoadBalancer
@Override
public <C> C getInstance(String name, Class<C> type) {
	C instance = super.getInstance(name, type);
	if (instance != null) {
		return instance;
	}
	IClientConfig config = getInstance(name, IClientConfig.class);
	return instantiateWithConfig(getContext(name), type, config);
}

//ç±»ï¼šDynamicServerListLoadBalancer
protected Server getServer(ILoadBalancer loadBalancer) {
	return loadBalancer.chooseServer("default");
	}

//ç±»ï¼šZoneAwareLoadBalancer
@Override
public Server chooseServer(Object key) {
    return zoneLoadBalancer.chooseServer(key);
}

//ç±»ï¼šBaseLoadBalancer
public Server chooseServer(Object key) {
    return rule.choose(key); // é‡è¦æ–¹æ³• rule = new RoundRobinRule()
}
```

æ€»ä¹‹ï¼Œé€»è¾‘æ˜¯è¿™æ ·çš„ï¼š

1. è·å–è´Ÿè½½å‡è¡¡å™¨(LoadBalancer)çš„å®ä¾‹(getInstance)ã€‚
2. è´Ÿè½½å‡è¡¡å™¨é€šè¿‡IRuleå®ç°çš„ç®—æ³•é€»è¾‘å®ç°é€‰æ‹©ã€‚
3. æœ€åè·å¾—ä¸€ä¸ªServer(æœåŠ¡)

è´Ÿè½½å‡è¡¡çš„ç®—æ³•ä¸»è¦é€šè¿‡ribbonæä¾›çš„ä¸€äº›åˆ—ç®—æ³•å®ç°IRuleï¼Œé»˜è®¤æ˜¯è½®è¯¢ã€‚
[![img](http://thoreauz.com/images/2017-08-11-18-04-51.jpg)](http://thoreauz.com/images/2017-08-11-18-04-51.jpg)
Ribbonæä¾›äº†ä¸€äº›å…¶ä»–ç®—æ³•ï¼š

- RetryRule:æ ¹æ®è½®è¯¢çš„æ–¹å¼é‡è¯•
- RandomRule: éšæœº
- WeightedResponseTimeRuleï¼šæ ¹æ®å“åº”æ—¶é—´å»åˆ†é…æƒé‡
- ZoneAvoidanceRuleï¼šåŒºåŸŸå¯ç”¨æ€§

è‡³äºåˆ‡æ¢ç®—æ³•çš„é…ç½®ï¼Œä¸»è¦é›†ä¸­åœ¨åˆå§‹åŒ–æ—¶çš„é…ç½®ç±»é‡Œé¢`IClientConfig`ï¼Œè€Œè¿™ä¸ªbeançš„ä¿¡æ¯é€šè¿‡å¯¹restTemplateæ·»åŠ æ³¨è§£@LoadBalancedå®Œæˆã€‚å…·ä½“çš„è´Ÿè½½å‡è¡¡ç®—æ³•å¯ä»¥é€šè¿‡beanæ³¨å…¥ï¼Œå¦‚ä¸‹ã€‚

```java
@Bean
public IRule ribbonRule() {
    return new RandomRule();//è¿™é‡Œé…ç½®ç­–ç•¥ï¼Œå’Œé…ç½®æ–‡ä»¶å¯¹åº”
}
```

è¿™å°±è§£å†³äº†æˆ‘åœ¨æ–‡ç« å¼€å¤´çš„ç¬¬äºŒä¸ªé—®é¢˜ã€‚å¦‚æœéœ€è¦è‡ªå®šä¹‰ç®—æ³•ï¼Œå®ç°IRuleï¼Œé€šè¿‡beançš„é…ç½®å®Œæˆæ³¨å…¥ã€‚è‡³äºæœåŠ¡åˆ—è¡¨ç»´æŠ¤ï¼Œæ­¤æ–‡è·³è¿‡ã€‚

## restTemplateæ•´åˆ

ä¸Šæ–‡æåˆ°é€šè¿‡æ³¨è§£å³å¯å¼€å¯restTemplateï¼Œé‚£æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿ

```java
@Configuration
@ConditionalOnClass(RestTemplate.class)
@ConditionalOnBean(LoadBalancerClient.class)
@EnableConfigurationProperties(LoadBalancerRetryProperties.class)
public class LoadBalancerAutoConfiguration {

	@LoadBalanced
	@Autowired(required = false)
	private List<RestTemplate> restTemplates = Collections.emptyList();

	@Bean
	public SmartInitializingSingleton loadBalancedRestTemplateInitializer(
			final List<RestTemplateCustomizer> customizers) {
		return new SmartInitializingSingleton() {
			@Override
			public void afterSingletonsInstantiated() {
				for (RestTemplate restTemplate : LoadBalancerAutoConfiguration.this.restTemplates) {
					for (RestTemplateCustomizer customizer : customizers) {
						customizer.customize(restTemplate);
					}
				}
			}
		};
	}
}
```

è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼Œé¦–å…ˆç»´æŠ¤äº†ä¸€ä¸ª`restTemplates`åˆ—è¡¨ï¼Œå¹¶é€šè¿‡`RestTemplateCustomizer`å¯¹è¿™äº›ä»–ä»¬æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¦‚ä¸‹ã€‚

```java
@Bean
@ConditionalOnMissingBean
public RestTemplateCustomizer restTemplateCustomizer(
		final LoadBalancerInterceptor loadBalancerInterceptor) {
	return new RestTemplateCustomizer() {
		@Override
		public void customize(RestTemplate restTemplate) {
			List<ClientHttpRequestInterceptor> list = new ArrayList<>(
					restTemplate.getInterceptors());
			list.add(loadBalancerInterceptor);
			restTemplate.setInterceptors(list);
		}
	};
}
```

è€Œæ‹¦æˆªå™¨çš„ä¸»è¦å°±æ˜¯æŠŠserviceIdå–å‡ºæ¥ï¼Œå†ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨å‘èµ·httpè¯·æ±‚ã€‚

```java
@Override
public ClientHttpResponse intercept(final HttpRequest request, final byte[] body,
		final ClientHttpRequestExecution execution) throws IOException {
	final URI originalUri = request.getURI();
	String serviceName = originalUri.getHost();
	Assert.state(serviceName != null, "Request URI does not contain a valid hostname: " + originalUri);
	return this.loadBalancer.execute(serviceName, requestFactory.createRequest(request, body, execution));
}
```

åˆå›åˆ°äº†commonä¸­æåˆ°çš„å››ä¸ªæ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªã€‚è‡³æ­¤ï¼Œå¾ˆæ˜äº†ï¼Œå°±æ˜¯é€šè¿‡æ³¨å…¥ç»™restTemplateæ³¨å…¥ä¸€ä¸ªæ‹¦æˆªå™¨è¾¾åˆ°ä½¿ç”¨loadBalancerçš„ç›®çš„ã€‚

RestTemplate æœ¬èº«å¹¶æ²¡æœ‰åš HTTP åº•å±‚çš„å®ç°ï¼Œè€Œæ˜¯åˆ©ç”¨äº†ç°æœ‰çš„ç¬¬ä¸‰æ–¹åº“ï¼š

1. HttpURLConnection
2. Apache httpclient
3. ok http
4. netty

ä¸åŒçš„åº•å±‚å®ç°ï¼Œåªéœ€è¦å®šä¹‰ç›´æ¥çš„RequestFactoryï¼Œå®ç°ClientHttpRequestFactoryã€‚åœ¨spring cloudç»™å‡ºäº†http clientåˆ‡æ¢æˆokhttpçš„é…ç½®ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Ribbon   æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)