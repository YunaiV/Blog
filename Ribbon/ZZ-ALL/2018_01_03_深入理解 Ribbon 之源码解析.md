title: æ·±å…¥ç†è§£ Ribbon ä¹‹æºç è§£æ
date: 2018-01-03
tag: 
categories: Ribbon
permalink: Ribbon/fangzhipeng/ribbon
author: æ–¹å¿—æœ‹
from_url: https://blog.csdn.net/forezp/article/details/74820899
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Ribbon// ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [ä»€ä¹ˆæ˜¯Ribbon](http://www.iocoder.cn/Ribbon/fangzhipeng/ribbon)
- [RestTemplateå’ŒRibbonç›¸ç»“åˆ](http://www.iocoder.cn/Ribbon/fangzhipeng/ribbon)
- [æ·±å…¥ç†è§£Ribbon](http://www.iocoder.cn/Ribbon/fangzhipeng/ribbon)
- [DynamicServerListLoadBalancer](http://www.iocoder.cn/Ribbon/fangzhipeng/ribbon)
- [RestTemplateæ˜¯å¦‚ä½•å’ŒRibbonç»“åˆçš„](http://www.iocoder.cn/Ribbon/fangzhipeng/ribbon)
- [æ€»ç»“](http://www.iocoder.cn/Ribbon/fangzhipeng/ribbon)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

## ä»€ä¹ˆæ˜¯Ribbon

Ribbonæ˜¯Netflixå…¬å¸å¼€æºçš„ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„é¡¹ç›®ï¼Œå®ƒå±äºä¸Šè¿°çš„ç¬¬äºŒç§ï¼Œæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ï¼Œè¿è¡Œåœ¨å®¢æˆ·ç«¯ä¸Šã€‚å®ƒæ˜¯ä¸€ä¸ªç»è¿‡äº†äº‘ç«¯æµ‹è¯•çš„IPCåº“ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ§åˆ¶HTTPå’ŒTCPå®¢æˆ·ç«¯çš„ä¸€äº›è¡Œä¸ºã€‚ Feignå·²ç»é»˜è®¤ä½¿ç”¨äº†Ribbonã€‚

- è´Ÿè½½å‡è¡¡
- å®¹é”™
- å¤šåè®®ï¼ˆHTTPï¼ŒTCPï¼ŒUDPï¼‰æ”¯æŒå¼‚æ­¥å’Œååº”æ¨¡å‹
- ç¼“å­˜å’Œæ‰¹å¤„ç†

## RestTemplateå’ŒRibbonç›¸ç»“åˆ

Ribbonåœ¨Netflixç»„ä»¶æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œåœ¨Zuulä¸­ä½¿ç”¨Ribbonåšè´Ÿè½½å‡è¡¡ï¼Œä»¥åŠFeignç»„ä»¶çš„ç»“åˆç­‰ã€‚åœ¨Spring Cloud ä¸­ï¼Œä½œä¸ºå¼€å‘ä¸­ï¼Œåšçš„æœ€å¤šçš„å¯èƒ½æ˜¯å°†RestTemplateå’ŒRibbonç›¸ç»“åˆï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å†™ï¼š

```java
@Configuration
public class RibbonConfig {
    @Bean
    @LoadBalanced
    RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

æ¶ˆè´¹å¦å¤–ä¸€ä¸ªçš„æœåŠ¡çš„æ¥å£ï¼Œå·®ä¸å¤šæ˜¯è¿™æ ·çš„ï¼š

```java
@Service
public class RibbonService {
    @Autowired
    RestTemplate restTemplate;
    public String hi(String name) {
        return restTemplate.getForObject("http://eureka-client/hi?name="+name,String.class);
    }
}
```

## æ·±å…¥ç†è§£Ribbon

### LoadBalancerClient

åœ¨Riibonä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ä¸ºLoadBalancerClientï¼Œå®ƒä½œä¸ºè´Ÿè½½å‡è¡¡çš„ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚å®ƒåœ¨spring-cloud-commonsåŒ…ä¸‹ï¼š
çš„LoadBalancerClientæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒç»§æ‰¿ServiceInstanceChooserï¼Œå®ƒçš„å®ç°ç±»æ˜¯RibbonLoadBalancerClientï¼Œè¿™ä¸‰è€…ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š

![image.png](http://upload-images.jianshu.io/upload_images/2279594-961a4933f2f92c68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å…¶ä¸­LoadBalancerClientæ¥å£ï¼Œæœ‰å¦‚ä¸‹ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­excute()ä¸ºæ‰§è¡Œè¯·æ±‚ï¼ŒreconstructURI()ç”¨æ¥é‡æ„urlï¼š

```
public interface LoadBalancerClient extends ServiceInstanceChooser {
  <T> T execute(String serviceId, LoadBalancerRequest<T> request) throws IOException;
  <T> T execute(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest<T> request) throws IOException;
  URI reconstructURI(ServiceInstance instance, URI original);

}
```

ServiceInstanceChooseræ¥å£ï¼Œä¸»è¦æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨æ¥æ ¹æ®serviceIdæ¥è·å–ServiceInstanceï¼Œä»£ç å¦‚ä¸‹:

```java
public interface ServiceInstanceChooser {

    ServiceInstance choose(String serviceId);
}
```

LoadBalancerClientçš„å®ç°ç±»ä¸ºRibbonLoadBalancerClientï¼Œè¿™ä¸ªç±»æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªç±»ï¼Œæœ€ç»ˆçš„è´Ÿè½½å‡è¡¡çš„è¯·æ±‚å¤„ç†ï¼Œç”±å®ƒæ¥æ‰§è¡Œã€‚å®ƒçš„éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š

```java
public class RibbonLoadBalancerClient implements LoadBalancerClient {

...//çœç•¥ä»£ç 

@Override
    public ServiceInstance choose(String serviceId) {
        Server server = getServer(serviceId);
        if (server == null) {
            return null;
        }
        return new RibbonServer(serviceId, server, isSecure(server, serviceId),
                serverIntrospector(serviceId).getMetadata(server));
    }



protected Server getServer(String serviceId) {
        return getServer(getLoadBalancer(serviceId));
   }


protected Server getServer(ILoadBalancer loadBalancer) {
        if (loadBalancer == null) {
            return null;
        }
        return loadBalancer.chooseServer("default"); // TODO: better handling of key
    }


protected ILoadBalancer getLoadBalancer(String serviceId) {
        return this.clientFactory.getLoadBalancer(serviceId);
    }

    ...//çœç•¥ä»£ç 
```

åœ¨RibbonLoadBalancerClientçš„æºç ä¸­ï¼Œå…¶ä¸­choose()æ–¹æ³•æ˜¯é€‰æ‹©å…·ä½“æœåŠ¡å®ä¾‹çš„ä¸€ä¸ªæ–¹æ³•ã€‚è¯¥æ–¹æ³•é€šè¿‡getServer()æ–¹æ³•å»è·å–å®ä¾‹ï¼Œç»è¿‡æºç è·Ÿè¸ªï¼Œæœ€ç»ˆäº¤ç»™äº†ILoadBalancerç±»å»é€‰æ‹©æœåŠ¡å®ä¾‹ã€‚

ILoadBalanceråœ¨ribbon-loadbalancerçš„jaråŒ…ä¸‹,å®ƒæ˜¯å®šä¹‰äº†å®ç°è½¯ä»¶è´Ÿè½½å‡è¡¡çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒéœ€è¦ä¸€ç»„å¯ä¾›é€‰æ‹©çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¿¡æ¯ï¼Œä»¥åŠæ ¹æ®ç‰¹å®šæ–¹æ³•å»é€‰æ‹©æœåŠ¡ï¼Œå®ƒçš„æºç å¦‚ä¸‹ ï¼š

```java
public interface ILoadBalancer {

    public void addServers(List<Server> newServers);
    public Server chooseServer(Object key);
    public void markServerDown(Server server);
    public List<Server> getReachableServers();
    public List<Server> getAllServers();
}
```

å…¶ä¸­ï¼ŒaddServers()æ–¹æ³•æ˜¯æ·»åŠ ä¸€ä¸ªServeré›†åˆï¼›chooseServer()æ–¹æ³•æ˜¯æ ¹æ®keyå»è·å–Serverï¼›markServerDown()æ–¹æ³•ç”¨æ¥æ ‡è®°æŸä¸ªæœåŠ¡ä¸‹çº¿ï¼›getReachableServers()è·å–å¯ç”¨çš„Serveré›†åˆï¼›getAllServers()è·å–æ‰€æœ‰çš„Serveré›†åˆã€‚

## DynamicServerListLoadBalancer

å®ƒçš„ç»§æ‰¿ç±»ä¸ºBaseLoadBalancerï¼Œå®ƒçš„å®ç°ç±»ä¸ºDynamicServerListLoadBalancerï¼Œè¿™ä¸‰è€…ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š

![image.png](http://upload-images.jianshu.io/upload_images/2279594-09ad9b1ece18a1a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æŸ¥çœ‹ä¸Šè¿°ä¸‰ä¸ªç±»çš„æºç ï¼Œå¯ç”¨å‘ç°ï¼Œé…ç½®ä»¥ä¸‹ä¿¡æ¯ï¼ŒIClientConfigã€IRuleã€IPingã€ServerListã€ServerListFilterå’ŒILoadBalancerï¼ŒæŸ¥çœ‹BaseLoadBalancerç±»ï¼Œå®ƒé»˜è®¤çš„æƒ…å†µä¸‹ï¼Œå®ç°äº†ä»¥ä¸‹é…ç½®ï¼š

- IClientConfig ribbonClientConfig: DefaultClientConfigImplé…ç½®
- IRule ribbonRule: RoundRobinRule è·¯ç”±ç­–ç•¥
- IPing ribbonPing: DummyPing
- ServerList ribbonServerList: ConfigurationBasedServerList
- ServerListFilter ribbonServerListFilter: ZonePreferenceServerListFilter
- ILoadBalancer ribbonLoadBalancer: ZoneAwareLoadBalancer

IClientConfig ç”¨äºå¯¹å®¢æˆ·ç«¯æˆ–è€…è´Ÿè½½å‡è¡¡çš„é…ç½®ï¼Œå®ƒçš„é»˜è®¤å®ç°ç±»ä¸ºDefaultClientConfigImplã€‚

IRuleç”¨äºå¤æ‚å‡è¡¡çš„ç­–ç•¥ï¼Œå®ƒæœ‰ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­choose()æ˜¯æ ¹æ®key æ¥è·å–server,setLoadBalancer()å’ŒgetLoadBalancer()æ˜¯ç”¨æ¥è®¾ç½®å’Œè·å–ILoadBalancerçš„ï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š

```java
public interface IRule{

    public Server choose(Object key);

    public void setLoadBalancer(ILoadBalancer lb);

    public ILoadBalancer getLoadBalancer();
}
```

IRuleæœ‰å¾ˆå¤šé»˜è®¤çš„å®ç°ç±»ï¼Œè¿™äº›å®ç°ç±»æ ¹æ®ä¸åŒçš„ç®—æ³•å’Œé€»è¾‘æ¥å¤„ç†è´Ÿè½½å‡è¡¡ã€‚Ribbonå®ç°çš„IRuleæœ‰ä¸€ä¸‹ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›é»˜è®¤çš„å®ç°ç±»æ˜¯å¯ä»¥æ»¡è¶³éœ€æ±‚çš„ï¼Œå¦‚æœæœ‰ç‰¹æ€§çš„éœ€æ±‚ï¼Œå¯ä»¥è‡ªå·±å®ç°ã€‚

- BestAvailableRule é€‰æ‹©æœ€å°è¯·æ±‚æ•°
- ClientConfigEnabledRoundRobinRule è½®è¯¢
- RandomRule éšæœºé€‰æ‹©ä¸€ä¸ªserver
- RoundRobinRule è½®è¯¢é€‰æ‹©server
- RetryRule æ ¹æ®è½®è¯¢çš„æ–¹å¼é‡è¯•
- WeightedResponseTimeRule æ ¹æ®å“åº”æ—¶é—´å»åˆ†é…ä¸€ä¸ªweight ï¼Œweightè¶Šä½ï¼Œè¢«é€‰æ‹©çš„å¯èƒ½æ€§å°±è¶Šä½
- ZoneAvoidanceRule æ ¹æ®serverçš„zoneåŒºåŸŸå’Œå¯ç”¨æ€§æ¥è½®è¯¢é€‰æ‹©

![image.png](http://upload-images.jianshu.io/upload_images/2279594-ce636f8c473f6e07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

IPingæ˜¯ç”¨æ¥æƒ³serverå‘ç”Ÿâ€pingâ€ï¼Œæ¥åˆ¤æ–­è¯¥serveræ˜¯å¦æœ‰å“åº”ï¼Œä»è€Œåˆ¤æ–­è¯¥serveræ˜¯å¦å¯ç”¨ã€‚å®ƒæœ‰ä¸€ä¸ªisAlive()æ–¹æ³•ï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š

```java
public interface IPing {
    public boolean isAlive(Server server);
}

```

IPingçš„å®ç°ç±»æœ‰PingUrlã€PingConstantã€NoOpPingã€DummyPingå’ŒNIWSDiscoveryPingã€‚å®ƒé—¨ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š

![image.png](http://upload-images.jianshu.io/upload_images/2279594-a2871eb4f4e82714.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

- PingUrl çœŸå®çš„å»ping æŸä¸ªurlï¼Œåˆ¤æ–­å…¶æ˜¯å¦alive
- PingConstant å›ºå®šè¿”å›æŸæœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œé»˜è®¤è¿”å›trueï¼Œå³å¯ç”¨
- NoOpPing ä¸å»ping,ç›´æ¥è¿”å›true,å³å¯ç”¨ã€‚
- DummyPing ç›´æ¥è¿”å›trueï¼Œå¹¶å®ç°äº†initWithNiwsConfigæ–¹æ³•ã€‚
- NIWSDiscoveryPingï¼Œæ ¹æ®DiscoveryEnabledServerçš„InstanceInfoçš„InstanceStatuså»åˆ¤æ–­ï¼Œå¦‚æœä¸ºInstanceStatus.UPï¼Œåˆ™ä¸ºå¯ç”¨ï¼Œå¦åˆ™ä¸å¯ç”¨ã€‚

ServerListæ˜¯å®šä¹‰è·å–æ‰€æœ‰çš„serverçš„æ³¨å†Œåˆ—è¡¨ä¿¡æ¯çš„æ¥å£ï¼Œå®ƒçš„ä»£ç å¦‚ä¸‹ï¼š

```java
public interface ServerList<T extends Server> {

    public List<T> getInitialListOfServers();
    public List<T> getUpdatedListOfServers();

}
```

ServerListFilteræ¥å£ï¼Œå®šäºäº†å¯æ ¹æ®é…ç½®å»è¿‡æ»¤æˆ–è€…æ ¹æ®ç‰¹æ€§åŠ¨æ€è·å–ç¬¦åˆæ¡ä»¶çš„serveråˆ—è¡¨çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
public interface ServerListFilter<T extends Server> {

    public List<T> getFilteredListOfServers(List<T> servers);

}
```

é˜…è¯»DynamicServerListLoadBalancerçš„æºç ï¼ŒDynamicServerListLoadBalancerçš„æ„é€ å‡½æ•°ä¸­æœ‰ä¸ªinitWithNiwsConfig()æ–¹æ³•ã€‚åœ¨æ”¹æ–¹æ³•ä¸­ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–é…ç½®ï¼Œæœ€ç»ˆæ‰§è¡Œäº†restOfInit()æ–¹æ³•ã€‚å…¶ä»£ç å¦‚ä¸‹ï¼š

```java
 public DynamicServerListLoadBalancer(IClientConfig clientConfig) {
        initWithNiwsConfig(clientConfig);
    }

    @Override
    public void initWithNiwsConfig(IClientConfig clientConfig) {
        try {
            super.initWithNiwsConfig(clientConfig);
            String niwsServerListClassName = clientConfig.getPropertyAsString(
                    CommonClientConfigKey.NIWSServerListClassName,
                    DefaultClientConfigImpl.DEFAULT_SEVER_LIST_CLASS);

            ServerList<T> niwsServerListImpl = (ServerList<T>) ClientFactory
                    .instantiateInstanceWithClientConfig(niwsServerListClassName, clientConfig);
            this.serverListImpl = niwsServerListImpl;

            if (niwsServerListImpl instanceof AbstractServerList) {
                AbstractServerListFilter<T> niwsFilter = ((AbstractServerList) niwsServerListImpl)
                        .getFilterImpl(clientConfig);
                niwsFilter.setLoadBalancerStats(getLoadBalancerStats());
                this.filter = niwsFilter;
            }

            String serverListUpdaterClassName = clientConfig.getPropertyAsString(
                    CommonClientConfigKey.ServerListUpdaterClassName,
                    DefaultClientConfigImpl.DEFAULT_SERVER_LIST_UPDATER_CLASS
            );

            this.serverListUpdater = (ServerListUpdater) ClientFactory
                    .instantiateInstanceWithClientConfig(serverListUpdaterClassName, clientConfig);

            restOfInit(clientConfig);
        } catch (Exception e) {
            throw new RuntimeException(
                    "Exception while initializing NIWSDiscoveryLoadBalancer:"
                            + clientConfig.getClientName()
                            + ", niwsClientConfig:" + clientConfig, e);
        }
    }

```

åœ¨restOfInit()æ–¹æ³•ä¸Šï¼Œæœ‰ä¸€ä¸ª updateListOfServers()çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ç”¨æ¥è·å–æ‰€æœ‰çš„ServerListçš„ã€‚

```java
 void restOfInit(IClientConfig clientConfig) {
        boolean primeConnection = this.isEnablePrimingConnections();
        // turn this off to avoid duplicated asynchronous priming done in BaseLoadBalancer.setServerList()
        this.setEnablePrimingConnections(false);
        enableAndInitLearnNewServersFeature();

        updateListOfServers();
        if (primeConnection && this.getPrimeConnections() != null) {
            this.getPrimeConnections()
                    .primeConnections(getReachableServers());
        }
        this.setEnablePrimingConnections(primeConnection);
        LOGGER.info("DynamicServerListLoadBalancer for client {} initialized: {}", clientConfig.getClientName(), this.toString());
    }

```

è¿›ä¸€æ­¥è·Ÿè¸ªupdateListOfServers()æ–¹æ³•çš„æºç ï¼Œæœ€ç»ˆç”±serverListImpl.getUpdatedListOfServers()è·å–æ‰€æœ‰çš„æœåŠ¡åˆ—è¡¨çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
   @VisibleForTesting
    public void updateListOfServers() {
        List<T> servers = new ArrayList<T>();
        if (serverListImpl != null) {
            servers = serverListImpl.getUpdatedListOfServers();
            LOGGER.debug("List of Servers for {} obtained from Discovery client: {}",
                    getIdentifier(), servers);

            if (filter != null) {
                servers = filter.getFilteredListOfServers(servers);
                LOGGER.debug("Filtered List of Servers for {} obtained from Discovery client: {}",
                        getIdentifier(), servers);
            }
        }
        updateAllServerList(servers);
    }

```

è€ŒserverListImplæ˜¯ServerListæ¥å£çš„å…·ä½“å®ç°ç±»ã€‚è·Ÿè¸ªä»£ç ï¼ŒServerListçš„å®ç°ç±»ä¸ºDiscoveryEnabledNIWSServerListï¼Œåœ¨ribbon-eureka.jarçš„com.netflix.niws.loadbalancerä¸‹ã€‚å…¶ä¸­DiscoveryEnabledNIWSServerListæœ‰ getInitialListOfServers()å’ŒgetUpdatedListOfServers()æ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
    public List<DiscoveryEnabledServer> getInitialListOfServers(){
        return obtainServersViaDiscovery();
    }

    @Override
    public List<DiscoveryEnabledServer> getUpdatedListOfServers(){
        return obtainServersViaDiscovery();
    }

```

ç»§ç»­è·Ÿè¸ªæºç ï¼ŒobtainServersViaDiscoveryï¼ˆï¼‰ï¼Œæ˜¯æ ¹æ®eurekaClientProvider.get()æ¥å›å»EurekaClientï¼Œå†æ ¹æ®EurekaClientæ¥è·å–æ³¨å†Œåˆ—è¡¨ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
 private List<DiscoveryEnabledServer> obtainServersViaDiscovery() {
        List<DiscoveryEnabledServer> serverList = new ArrayList<DiscoveryEnabledServer>();

        if (eurekaClientProvider == null || eurekaClientProvider.get() == null) {
            logger.warn("EurekaClient has not been initialized yet, returning an empty list");
            return new ArrayList<DiscoveryEnabledServer>();
        }

        EurekaClient eurekaClient = eurekaClientProvider.get();
        if (vipAddresses!=null){
            for (String vipAddress : vipAddresses.split(",")) {
                // if targetRegion is null, it will be interpreted as the same region of client
                List<InstanceInfo> listOfInstanceInfo = eurekaClient.getInstancesByVipAddress(vipAddress, isSecure, targetRegion);
                for (InstanceInfo ii : listOfInstanceInfo) {
                    if (ii.getStatus().equals(InstanceStatus.UP)) {

                        if(shouldUseOverridePort){
                            if(logger.isDebugEnabled()){
                                logger.debug("Overriding port on client name: " + clientName + " to " + overridePort);
                            }

                            // copy is necessary since the InstanceInfo builder just uses the original reference,
                            // and we don't want to corrupt the global eureka copy of the object which may be
                            // used by other clients in our system
                            InstanceInfo copy = new InstanceInfo(ii);

                            if(isSecure){
                                ii = new InstanceInfo.Builder(copy).setSecurePort(overridePort).build();
                            }else{
                                ii = new InstanceInfo.Builder(copy).setPort(overridePort).build();
                            }
                        }

                        DiscoveryEnabledServer des = new DiscoveryEnabledServer(ii, isSecure, shouldUseIpAddr);
                        des.setZone(DiscoveryClient.getZone(ii));
                        serverList.add(des);
                    }
                }
                if (serverList.size()>0 && prioritizeVipAddressBasedServers){
                    break; // if the current vipAddress has servers, we dont use subsequent vipAddress based servers
                }
            }
        }
        return serverList;
    }
```

å…¶ä¸­eurekaClientProviderçš„å®ç°ç±»æ˜¯LegacyEurekaClientProviderï¼Œå®ƒæ˜¯ä¸€ä¸ªè·å–eurekaClientç±»ï¼Œé€šè¿‡é™æ€çš„æ–¹æ³•å»è·å–eurekaClientï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š

```java
class LegacyEurekaClientProvider implements Provider<EurekaClient> {

    private volatile EurekaClient eurekaClient;

    @Override
    public synchronized EurekaClient get() {
        if (eurekaClient == null) {
            eurekaClient = DiscoveryManager.getInstance().getDiscoveryClient();
        }

        return eurekaClient;
    }
}

```

EurekaClientçš„å®ç°ç±»ä¸ºDiscoveryClientï¼Œåœ¨ä¹‹å‰å·²ç»åˆ†æäº†å®ƒå…·æœ‰æœåŠ¡æ³¨å†Œã€è·å–æœåŠ¡æ³¨å†Œåˆ—è¡¨ç­‰çš„å…¨éƒ¨åŠŸèƒ½ã€‚

ç”±æ­¤å¯è§ï¼Œè´Ÿè½½å‡è¡¡å™¨æ˜¯ä»EurekaClientè·å–æœåŠ¡ä¿¡æ¯ï¼Œå¹¶æ ¹æ®IRuleå»è·¯ç”±ï¼Œå¹¶ä¸”æ ¹æ®IPingå»åˆ¤æ–­æœåŠ¡çš„å¯ç”¨æ€§ã€‚

é‚£ä¹ˆç°åœ¨è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œè´Ÿè½½å‡è¡¡å™¨å¤šä¹…ä¸€æ¬¡å»è·å–ä¸€æ¬¡ä»Eureka Clientè·å–æ³¨å†Œä¿¡æ¯å‘¢ã€‚

åœ¨BaseLoadBalancerç±»ä¸‹ï¼ŒBaseLoadBalancerçš„æ„é€ å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°å¼€å¯äº†ä¸€ä¸ªPingTaskä»»åŠ¡ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
   public BaseLoadBalancer(String name, IRule rule, LoadBalancerStats stats,
            IPing ping, IPingStrategy pingStrategy) {
        ...//ä»£ç çœç•¥
        setupPingTask();
         ...//ä»£ç çœç•¥
    }

```

setupPingTask()çš„å…·ä½“ä»£ç é€»è¾‘ï¼Œå®ƒå¼€å¯äº†ShutdownEnabledTimeræ‰§è¡ŒPingTaskä»»åŠ¡ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹pingIntervalSecondsä¸º10ï¼Œå³æ¯10ç§’é’Ÿï¼Œæƒ³EurekaClientå‘é€ä¸€æ¬¡â€pingâ€ã€‚

```java
    void setupPingTask() {
        if (canSkipPing()) {
            return;
        }
        if (lbTimer != null) {
            lbTimer.cancel();
        }
        lbTimer = new ShutdownEnabledTimer("NFLoadBalancer-PingTimer-" + name,
                true);
        lbTimer.schedule(new PingTask(), 0, pingIntervalSeconds * 1000);
        forceQuickPing();
    }

```

PingTaskæºç ï¼Œå³newä¸€ä¸ªPingerå¯¹è±¡ï¼Œå¹¶æ‰§è¡ŒrunPinger()æ–¹æ³•ã€‚

```java
class PingTask extends TimerTask {
        public void run() {
            try {
                new Pinger(pingStrategy).runPinger();
            } catch (Exception e) {
                logger.error("LoadBalancer [{}]: Error pinging", name, e);
            }
        }
    }

```

æŸ¥çœ‹Pingerçš„runPinger()æ–¹æ³•ï¼Œæœ€ç»ˆæ ¹æ® pingerStrategy.pingServers(ping, allServers)æ¥è·å–æœåŠ¡çš„å¯ç”¨æ€§ï¼Œå¦‚æœè¯¥è¿”å›ç»“æœï¼Œå¦‚ä¹‹å‰ç›¸åŒï¼Œåˆ™ä¸å»å‘EurekaClientè·å–æ³¨å†Œåˆ—è¡¨ï¼Œå¦‚æœä¸åŒåˆ™é€šçŸ¥ServerStatusChangeListeneræˆ–è€…changeListenerså‘ç”Ÿäº†æ”¹å˜ï¼Œè¿›è¡Œæ›´æ–°æˆ–è€…é‡æ–°æ‹‰å–ã€‚

```java
  public void runPinger() throws Exception {
            if (!pingInProgress.compareAndSet(false, true)) {
                return; // Ping in progress - nothing to do
            }

            // we are "in" - we get to Ping

            Server[] allServers = null;
            boolean[] results = null;

            Lock allLock = null;
            Lock upLock = null;

            try {
                /*
                 * The readLock should be free unless an addServer operation is
                 * going on...
                 */
                allLock = allServerLock.readLock();
                allLock.lock();
                allServers = allServerList.toArray(new Server[allServerList.size()]);
                allLock.unlock();

                int numCandidates = allServers.length;
                results = pingerStrategy.pingServers(ping, allServers);

                final List<Server> newUpList = new ArrayList<Server>();
                final List<Server> changedServers = new ArrayList<Server>();

                for (int i = 0; i < numCandidates; i++) {
                    boolean isAlive = results[i];
                    Server svr = allServers[i];
                    boolean oldIsAlive = svr.isAlive();

                    svr.setAlive(isAlive);

                    if (oldIsAlive != isAlive) {
                        changedServers.add(svr);
                        logger.debug("LoadBalancer [{}]:  Server [{}] status changed to {}",
                            name, svr.getId(), (isAlive ? "ALIVE" : "DEAD"));
                    }

                    if (isAlive) {
                        newUpList.add(svr);
                    }
                }
                upLock = upServerLock.writeLock();
                upLock.lock();
                upServerList = newUpList;
                upLock.unlock();

                notifyServerStatusChangeListener(changedServers);
            } finally {
                pingInProgress.set(false);
            }
        }

```

ç”±æ­¤å¯è§ï¼ŒLoadBalancerClientæ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šå‘Eurekaå›å»æœåŠ¡æ³¨å†Œåˆ—è¡¨ï¼Œå¹¶ä¸”å‘é€šè¿‡10sä¸€æ¬¡å‘EurekaClientå‘é€â€œpingâ€ï¼Œæ¥åˆ¤æ–­æœåŠ¡çš„å¯ç”¨æ€§ï¼Œå¦‚æœæœåŠ¡çš„å¯ç”¨æ€§å‘ç”Ÿäº†æ”¹å˜æˆ–è€…æœåŠ¡æ•°é‡å’Œä¹‹å‰çš„ä¸ä¸€è‡´ï¼Œåˆ™æ›´æ–°æˆ–è€…é‡æ–°æ‹‰å–ã€‚LoadBalancerClientæœ‰äº†è¿™äº›æœåŠ¡æ³¨å†Œåˆ—è¡¨ï¼Œå°±å¯ä»¥æ ¹æ®å…·ä½“çš„IRuleæ¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚

## RestTemplateæ˜¯å¦‚ä½•å’ŒRibbonç»“åˆçš„

æœ€åï¼Œå›ç­”é—®é¢˜çš„æœ¬è´¨ï¼Œä¸ºä»€ä¹ˆåœ¨RestTemplateåŠ ä¸€ä¸ª@LoadBalanceæ³¨è§£å°±å¯å¯ä»¥å¼€å¯è´Ÿè½½å‡è¡¡å‘¢ï¼Ÿ

```java
 @LoadBalanced
    RestTemplate restTemplate() {
        return new RestTemplate();
    }
```

å…¨å±€æœç´¢ctr+shift+f @LoadBalancedæœ‰å“ªäº›ç±»ç”¨åˆ°äº†LoadBalancedæœ‰å“ªäº›ç±»ç”¨åˆ°äº†ï¼Œ å‘ç°LoadBalancerAutoConfigurationç±»ï¼Œå³LoadBalancerè‡ªåŠ¨é…ç½®ç±»ã€‚

```java
@Configuration
@ConditionalOnClass(RestTemplate.class)
@ConditionalOnBean(LoadBalancerClient.class)
@EnableConfigurationProperties(LoadBalancerRetryProperties.class)
public class LoadBalancerAutoConfiguration {

@LoadBalanced
    @Autowired(required = false)
    private List<RestTemplate> restTemplates = Collections.emptyList();
}
    @Bean
    public SmartInitializingSingleton loadBalancedRestTemplateInitializer(
            final List<RestTemplateCustomizer> customizers) {
        return new SmartInitializingSingleton() {
            @Override
            public void afterSingletonsInstantiated() {
                for (RestTemplate restTemplate : LoadBalancerAutoConfiguration.this.restTemplates) {
                    for (RestTemplateCustomizer customizer : customizers) {
                        customizer.customize(restTemplate);
                    }
                }
            }
        };
    }


    @Configuration
    @ConditionalOnMissingClass("org.springframework.retry.support.RetryTemplate")
    static class LoadBalancerInterceptorConfig {
        @Bean
        public LoadBalancerInterceptor ribbonInterceptor(
                LoadBalancerClient loadBalancerClient,
                LoadBalancerRequestFactory requestFactory) {
            return new LoadBalancerInterceptor(loadBalancerClient, requestFactory);
        }

        @Bean
        @ConditionalOnMissingBean
        public RestTemplateCustomizer restTemplateCustomizer(
                final LoadBalancerInterceptor loadBalancerInterceptor) {
            return new RestTemplateCustomizer() {
                @Override
                public void customize(RestTemplate restTemplate) {
                    List<ClientHttpRequestInterceptor> list = new ArrayList<>(
                            restTemplate.getInterceptors());
                    list.add(loadBalancerInterceptor);
                    restTemplate.setInterceptors(list);
                }
            };
        }
    }

}
```

åœ¨è¯¥ç±»ä¸­ï¼Œé¦–å…ˆç»´æŠ¤äº†ä¸€ä¸ªè¢«@LoadBalancedä¿®é¥°çš„RestTemplateå¯¹è±¡çš„Listï¼Œåœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è°ƒç”¨customizer.customize(restTemplate)æ–¹æ³•æ¥ç»™RestTemplateå¢åŠ æ‹¦æˆªå™¨LoadBalancerInterceptorã€‚

è€ŒLoadBalancerInterceptorï¼Œç”¨äºå®æ—¶æ‹¦æˆªï¼Œåœ¨LoadBalancerInterceptorè¿™é‡Œå®ç°æ¥è´Ÿè½½å‡è¡¡ã€‚LoadBalancerInterceptorçš„æ‹¦æˆªæ–¹æ³•å¦‚ä¸‹ï¼š

```java
@Override
    public ClientHttpResponse intercept(final HttpRequest request, final byte[] body,
            final ClientHttpRequestExecution execution) throws IOException {
        final URI originalUri = request.getURI();
        String serviceName = originalUri.getHost();
        Assert.state(serviceName != null, "Request URI does not contain a valid hostname: " + originalUri);
        return this.loadBalancer.execute(serviceName, requestFactory.createRequest(request, body, execution));
    }
```

## æ€»ç»“

ç»¼ä¸Šæ‰€è¿°ï¼ŒRibbonçš„è´Ÿè½½å‡è¡¡ï¼Œä¸»è¦é€šè¿‡LoadBalancerClientæ¥å®ç°çš„ï¼Œè€ŒLoadBalancerClientå…·ä½“äº¤ç»™äº†ILoadBalanceræ¥å¤„ç†ï¼ŒILoadBalanceré€šè¿‡é…ç½®IRuleã€IPingç­‰ä¿¡æ¯ï¼Œå¹¶å‘EurekaClientè·å–æ³¨å†Œåˆ—è¡¨çš„ä¿¡æ¯ï¼Œå¹¶é»˜è®¤10ç§’ä¸€æ¬¡å‘EurekaClientå‘é€â€œpingâ€,è¿›è€Œæ£€æŸ¥æ˜¯å¦æ›´æ–°æœåŠ¡åˆ—è¡¨ï¼Œæœ€åï¼Œå¾—åˆ°æ³¨å†Œåˆ—è¡¨åï¼ŒILoadBalanceræ ¹æ®IRuleçš„ç­–ç•¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚

è€ŒRestTemplate è¢«@LoadBalanceæ³¨è§£åï¼Œèƒ½è¿‡ç”¨è´Ÿè½½å‡è¡¡ï¼Œä¸»è¦æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªè¢«@LoadBalanceæ³¨è§£çš„RestTemplateåˆ—è¡¨ï¼Œå¹¶ç»™åˆ—è¡¨ä¸­çš„RestTemplateæ·»åŠ æ‹¦æˆªå™¨ï¼Œè¿›è€Œäº¤ç»™è´Ÿè½½å‡è¡¡å™¨å»å¤„ç†ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Ribbon   æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)