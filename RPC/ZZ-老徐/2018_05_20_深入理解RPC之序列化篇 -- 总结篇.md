title: æ·±å…¥ç†è§£ RPC ä¹‹åºåˆ—åŒ–ç¯‡ -- æ€»ç»“ç¯‡
date: 2018-05-20
tags:
categories:
permalink: RPC/laoxu/rpc-serialize-2/
author: è€å¾
from_url: https://www.cnkirito.moe/rpc-serialize-2/
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484483&idx=1&sn=b58e64b13743d3f40b8c9c3ee7ec885e&chksm=fa497bf2cd3ef2e47851b447801ec54bb8be29c81cdf450df2a257b3a2d4d97e264f9ca8586e#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnkirito.moe/rpc-serialize-2/ ã€Œè€å¾ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [å®šä¹‰æŠ½è±¡æ¥å£](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-2//)
  - [Kryoå®ç°](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-2//)
  - [Hessianå®ç°](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-2//)
  - [Protostuffå®ç°](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-2//)
  - [Fastjsonå®ç°](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-2//)
  - [åºåˆ—åŒ–å¯¹æ¯”](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-2//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä¸Šä¸€ç¯‡[ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡â€“Kryoã€‹](https://www.cnkirito.moe/2017/11/28/kryo-1/),ä»‹ç»äº†åºåˆ—åŒ–çš„åŸºç¡€æ¦‚å¿µï¼Œå¹¶ä¸”è¯¦ç»†ä»‹ç»äº†Kryoçš„ä¸€ç³»åˆ—ç‰¹æ€§ï¼Œåœ¨è¿™ä¸€ç¯‡ä¸­ï¼Œç®€ç•¥çš„ä»‹ç»å…¶ä»–å¸¸ç”¨çš„åºåˆ—åŒ–å™¨ï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œä¸€äº›æ¯”è¾ƒã€‚åºåˆ—åŒ–ç¯‡ä»…ä»…ç”±Kryoç¯‡å’Œæ€»ç»“ç¯‡æ„æˆå¯èƒ½æœ‰ç‚¹çªå…€ï¼Œç­‰å¾…åç»­æœ‰æ—¶é—´ä¼šè¡¥å……è¯¦ç»†çš„æ¢è®¨ã€‚

## å®šä¹‰æŠ½è±¡æ¥å£

```Java
public interface Serialization {

   byte[] serialize(Object obj) throws IOException;

   <T> T deserialize(byte[] bytes, Class<T> clz) throws IOException;
}
```

RPCæ¡†æ¶ä¸­çš„åºåˆ—åŒ–å®ç°è‡ªç„¶æ˜¯ç§ç±»å¤šæ ·ï¼Œä½†å®ƒä»¬å¿…é¡»éµå¾ªç»Ÿä¸€çš„è§„èŒƒï¼Œäºæ˜¯æˆ‘ä»¬ä½¿ç”¨ `Serialization` ä½œä¸ºåºåˆ—åŒ–çš„ç»Ÿä¸€æ¥å£ï¼Œæ— è®ºä½•ç§æ–¹æ¡ˆéƒ½éœ€è¦å®ç°è¯¥æ¥å£ã€‚

## Kryoå®ç°

Kryoç¯‡å·²ç»ç»™å‡ºäº†å®ç°ä»£ç ã€‚

```Java
public class KryoSerialization implements Serialization {

    @Override
    public byte[] serialize(Object obj) {
        Kryo kryo = kryoLocal.get();
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        Output output = new Output(byteArrayOutputStream);
        kryo.writeObject(output, obj);
        output.close();
        return byteArrayOutputStream.toByteArray();
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> clz) {
        Kryo kryo = kryoLocal.get();
        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);
        Input input = new Input(byteArrayInputStream);
        input.close();
        return (T) kryo.readObject(input, clz);
    }

    private static final ThreadLocal<Kryo> kryoLocal = new ThreadLocal<Kryo>() {
        @Override
        protected Kryo initialValue() {
            Kryo kryo = new Kryo();
            kryo.setReferences(true);
            kryo.setRegistrationRequired(false);
            return kryo;
        }
    };

}
```

æ‰€éœ€ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>com.esotericsoftware</groupId>
    <artifactId>kryo</artifactId>
    <version>4.0.1</version>
</dependency>
```

## Hessianå®ç°

```Java
public class Hessian2Serialization implements Serialization {

    @Override
    public byte[] serialize(Object data) throws IOException {
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        Hessian2Output out = new Hessian2Output(bos);
        out.writeObject(data);
        out.flush();
        return bos.toByteArray();
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> clz) throws IOException {
        Hessian2Input input = new Hessian2Input(new ByteArrayInputStream(bytes));
        return (T) input.readObject(clz);
    }
}
```

æ‰€éœ€ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>com.caucho</groupId>
    <artifactId>hessian</artifactId>
    <version>4.0.51</version>
</dependency>
```

å¤§åé¼é¼çš„ Hessian åºåˆ—åŒ–æ–¹æ¡ˆç»å¸¸è¢«RPCæ¡†æ¶ç”¨æ¥ä½œä¸ºé»˜è®¤çš„åºåˆ—åŒ–æ–¹æ¡ˆï¼Œå¯è§å…¶å¿…ç„¶å…·å¤‡ä¸€å®šçš„ä¼˜åŠ¿ã€‚å…¶å…·ä½“çš„ä¼˜åŠ£æˆ‘ä»¬æ”¾åˆ°æ–‡æœ«çš„æ€»ç»“å¯¹æ¯”ä¸­ä¸å…¶ä»–åºåˆ—åŒ–æ–¹æ¡ˆä¸€èµ·è®¨è®ºã€‚è€Œåœ¨æ­¤ï¼Œç€é‡æä¸€ç‚¹Hessianä½¿ç”¨æ—¶çš„å‘ç‚¹ã€‚

**BigDecimalçš„ååºåˆ—åŒ–**

ä½¿ç”¨ Hessian åºåˆ—åŒ–åŒ…å« BigDecimal å­—æ®µçš„å¯¹è±¡æ—¶ä¼šå¯¼è‡´å…¶å€¼ä¸€ç›´ä¸º0ï¼Œä¸æ³¨æ„è¿™ä¸ªbugä¼šå¯¼è‡´å¾ˆå¤§çš„é—®é¢˜ï¼Œåœ¨æœ€æ–°çš„4.0.51ç‰ˆæœ¬ä»ç„¶å¯ä»¥å¤ç°ã€‚è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼ŒæŒ‡å®š BigDecimal çš„åºåˆ—åŒ–å™¨å³å¯ï¼Œé€šè¿‡æ·»åŠ ä¸¤ä¸ªæ–‡ä»¶è§£å†³è¿™ä¸ªbugï¼š

**resources\META-INF\hessian\serializers**

```
java.math.BigDecimal=com.caucho.hessian.io.StringValueSerializer
```

**resources\META-INF\hessian\deserializers**

```
java.math.BigDecimal=com.caucho.hessian.io.BigDecimalDeserializer
```

## Protostuffå®ç°

```Java
public class ProtostuffSerialization implements Serialization {

    @Override
    public byte[] serialize(Object obj) throws IOException {
        Class clz = obj.getClass();
        LinkedBuffer buffer = LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);
        try {
            Schema schema = RuntimeSchema.createFrom(clz);
            return ProtostuffIOUtil.toByteArray(obj, schema, buffer);
        } catch (Exception e) {
            throw e;
        } finally {
            buffer.clear();
        }
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> clz) throws IOException {
        T message = objenesis.newInstance(clz); // <1>
        Schema<T> schema = RuntimeSchema.createFrom(clz);
        ProtostuffIOUtil.mergeFrom(bytes, message, schema);
        return message;
    }

    private Objenesis objenesis = new ObjenesisStd(); // <2>


}
```

æ‰€éœ€ä¾èµ–ï¼š

```XML
<!-- Protostuff -->
<dependency>
    <groupId>com.dyuproject.protostuff</groupId>
    <artifactId>protostuff-core</artifactId>
    <version>1.0.9</version>
</dependency>
<dependency>
    <groupId>com.dyuproject.protostuff</groupId>
    <artifactId>protostuff-runtime</artifactId>
    <version>1.0.9</version>
</dependency>
<!-- Objenesis -->
<dependency>
    <groupId>org.objenesis</groupId>
    <artifactId>objenesis</artifactId>
    <version>2.5</version>
</dependency>
```

Protostuff å¯ä»¥ç†è§£ä¸º google protobuf åºåˆ—åŒ–çš„å‡çº§ç‰ˆæœ¬ï¼Œprotostuff-runtime æ— éœ€é™æ€ç¼–è¯‘ï¼Œè¿™æ¯”è¾ƒé€‚åˆRPCé€šä¿¡æ—¶çš„ç‰¹æ€§ï¼Œå¾ˆå°‘è§åˆ°æœ‰äººç›´æ¥æ‹¿ protobuf ä½œä¸ºRPCçš„åºåˆ—åŒ–å™¨ï¼Œè€Œ protostuff-runtime ä»ç„¶å æ®ä¸€å¸­ä¹‹åœ°ã€‚

`<1>` ä½¿ç”¨ Protostuff çš„ä¸€ä¸ªå‘ç‚¹åœ¨äºå…¶ååºåˆ—åŒ–æ—¶éœ€ç”¨æˆ·è‡ªå·±å®ä¾‹åŒ–åºåˆ—åŒ–åçš„å¯¹è±¡ï¼Œæ‰€ä»¥æ‰æœ‰äº† `T message = objenesis.newInstance(clz);` è¿™è¡Œä»£ç ã€‚ä½¿ç”¨ objenesis å·¥å…·å®ä¾‹åŒ–ä¸€ä¸ªéœ€è¦çš„å¯¹è±¡ï¼Œè€Œåä½¿ç”¨ `ProtostuffIOUtil` å®Œæˆèµ‹å€¼æ“ä½œã€‚

`<2>` ä¸Šè¿°çš„ `objenesis.newInstance(clz)` å¯ä»¥ç”± `clz.newInstance()` ä»£æ›¿ï¼Œåè€…ä¹Ÿå¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œä½†å¦‚æœå¯¹è±¡ç¼ºå°‘æ— å‚æ„é€ å‡½æ•°ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚å€ŸåŠ©äº`objenesis` å¯ä»¥ç»•å¼€æ— å‚æ„é€ å™¨å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œä¸”æ€§èƒ½ä¼˜äºç›´æ¥åå°„åˆ›å»ºã€‚æ‰€ä»¥ä¸€èˆ¬åœ¨é€‰æ‹© Protostuff ä½œä¸ºåºåˆ—åŒ–å™¨æ—¶ï¼Œä¸€èˆ¬é…åˆ objenesis ä½¿ç”¨ã€‚

## Fastjsonå®ç°

```Java
public class FastJsonSerialization implements Serialization {
    static final String charsetName = "UTF-8";
    @Override
    public byte[] serialize(Object data) throws IOException {
        SerializeWriter out = new SerializeWriter();
        JSONSerializer serializer = new JSONSerializer(out);
        serializer.config(SerializerFeature.WriteEnumUsingToString, true);//<1>
        serializer.config(SerializerFeature.WriteClassName, true);//<1>
        serializer.write(data);
        return out.toBytes(charsetName);
    }

    @Override
    public <T> T deserialize(byte[] data, Class<T> clz) throws IOException {
        return JSON.parseObject(new String(data), clz);
    }
}
```

æ‰€éœ€ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.28</version>
</dependency>
```

`<1>` JSONåºåˆ—åŒ–æ³¨æ„å¯¹æšä¸¾ç±»å‹çš„ç‰¹æ®Šå¤„ç†ï¼›é¢å¤–è¡¥å……ç±»åå¯ä»¥åœ¨ååºåˆ—åŒ–æ—¶è·å¾—æ›´ä¸°å¯Œçš„ä¿¡æ¯ã€‚

## åºåˆ—åŒ–å¯¹æ¯”

åœ¨æˆ‘çš„PCä¸Šå¯¹ä¸Šè¿°åºåˆ—åŒ–æ–¹æ¡ˆè¿›è¡Œæµ‹è¯•ï¼š

**æµ‹è¯•ç”¨ä¾‹ï¼šå¯¹ä¸€ä¸ªç®€å•POJOå¯¹è±¡åºåˆ—åŒ–/ååºåˆ—åŒ–100Wæ¬¡**

|            | serialize/ms | deserialize/ms |
| ---------- | ------------ | -------------- |
| Fastjson   | 2832         | 2242           |
| Kryo       | 2975         | 1987           |
| Hessian    | 4598         | 3631           |
| Protostuff | 2944         | 2541           |

**æµ‹è¯•ç”¨ä¾‹ï¼šåºåˆ—åŒ–åŒ…å«1000ä¸ªç®€å•å¯¹è±¡çš„Listï¼Œå¾ªç¯1000æ¬¡**

|            | serialize/ms | deserialize/ms |
| ---------- | ------------ | -------------- |
| Fastjson   | 2551         | 2821           |
| Kryo       | 1951         | 1342           |
| Hessian    | 1828         | 2213           |
| Protostuff | 1409         | 2813           |

å¯¹äºè€—æ—¶ç±»å‹çš„æµ‹è¯•éœ€è¦åšåˆ°é¢„çƒ­+å¹³å‡å€¼ç­‰æ¡ä»¶ï¼Œæµ‹è¯•åæ•ˆæœå…¶å®å¹¶ä¸å¦‚äººæ„ï¼Œä»æˆ‘ä¸å¤ªä¸¥è°¨çš„æµ‹è¯•æ¥çœ‹ï¼Œå¹¶ä¸èƒ½æ˜æ˜¾åœ°åŒºåˆ†å‡ºä»–ä»¬çš„æ€§èƒ½ã€‚å¦å¤–ï¼ŒKryoå…³é—­Referenceå¯ä»¥åŠ é€Ÿï¼ŒProtostuffæ”¯æŒé™æ€ç¼–è¯‘åŠ é€Ÿï¼ŒSchemaç¼“å­˜ç­‰ç‰¹æ€§ï¼Œæ¯ä¸ªåºåˆ—åŒ–æ–¹æ¡ˆéƒ½æœ‰è‡ªèº«çš„ç‰¹æ®Šæ€§ï¼Œå¯ç”¨è¿™äº›ç‰¹æ€§ä¼šä¼´éšä¸€äº›é™åˆ¶ã€‚ä½†åœ¨RPCå®é™…åœ°åºåˆ—åŒ–ä½¿ç”¨ä¸­ä¸ä¼šåˆ©ç”¨åˆ°è¿™äº›ç‰¹æ€§ï¼Œæ‰€ä»¥åœ¨æµ‹è¯•æ—¶å¹¶æ²¡æœ‰ç‰¹åˆ«å…³ç…§å®ƒä»¬ã€‚

**åºåˆ—åŒ–åŒ…å«1000ä¸ªç®€å•å¯¹è±¡çš„Listï¼ŒæŸ¥çœ‹å­—èŠ‚æ•°**

|            | å­—èŠ‚æ•°/byte |
| ---------- | ----------- |
| Fastjson   | 120157      |
| Kryo       | 39134       |
| Hessian    | 86166       |
| Protostuff | 86084       |

å­—èŠ‚æ•°è¿™ä¸ªæŒ‡æ ‡è¿˜æ˜¯å¾ˆç›´è§‚çš„ï¼ŒKryoæ‹¥æœ‰ç»å¯¹çš„ä¼˜åŠ¿ï¼Œåªæœ‰Hessianï¼ŒProtostuffçš„ä¸€åŠï¼Œè€ŒFastjsonä½œä¸ºä¸€ä¸ªæ–‡æœ¬ç±»å‹çš„åºåˆ—åŒ–æ–¹æ¡ˆï¼Œè‡ªç„¶æ— æ³•å’Œå­—èŠ‚ç±»å‹çš„åºåˆ—åŒ–æ–¹æ¡ˆæ¯”è¾ƒã€‚è€Œå­—èŠ‚æœ€ç»ˆå°†ç”¨äºç½‘ç»œä¼ è¾“ï¼Œæ˜¯RPCæ¡†æ¶éå¸¸åœ¨æ„çš„ä¸€ä¸ªæ€§èƒ½ç‚¹ã€‚

**ç»¼åˆè¯„ä»·**

ç»è¿‡ä¸ªäººæµ‹è¯•ï¼Œä»¥åŠä¸€äº›å®˜æ–¹çš„æµ‹è¯•ç»“æœï¼Œæˆ‘è§‰å¾—åœ¨ RPC åœºæ™¯ä¸‹ï¼Œåºåˆ—åŒ–çš„é€Ÿåº¦å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¤§è€ƒé‡æ ‡å‡†ï¼Œå› ä¸ºå„ä¸ªåºåˆ—åŒ–æ–¹æ¡ˆéƒ½åœ¨æœ‰æ„ä¼˜åŒ–é€Ÿåº¦ï¼Œåªè¦ä¸æ˜¯ jdk åºåˆ—åŒ–ï¼Œé€Ÿåº¦å°±ä¸ä¼šå¤ªæ…¢ã€‚

Kryoï¼šä¸“ä¸º JAVA å®šåˆ¶çš„åºåˆ—åŒ–åè®®ï¼Œåºåˆ—åŒ–åå­—èŠ‚æ•°å°‘ï¼Œåˆ©äºç½‘ç»œä¼ è¾“ã€‚ä½†ä¸æ”¯æŒè·¨è¯­è¨€ï¼ˆæˆ–æ”¯æŒçš„ä»£ä»·æ¯”è¾ƒå¤§ï¼‰ã€‚dubbox æ‰©å±•ä¸­æ”¯æŒäº† kryo åºåˆ—åŒ–åè®®ã€‚github 3018 starã€‚

Hessianï¼šæ”¯æŒè·¨è¯­è¨€ï¼Œåºåˆ—åŒ–åå­—èŠ‚æ•°é€‚ä¸­ï¼ŒAPI æ˜“ç”¨ã€‚æ˜¯å›½å†…ä¸»æµ rpc æ¡†æ¶ï¼šdubboï¼Œmotan çš„é»˜è®¤åºåˆ—åŒ–åè®®ã€‚[hessian.caucho.com](http://hessian.caucho.com/) æœªæ‰˜ç®¡åœ¨github

Protostuffï¼šæèµ· Protostuff ä¸å¾—ä¸è¯´åˆ° Protobufã€‚Protobufå¯èƒ½æ›´å‡ºåä¸€äº›ï¼Œå› ä¸ºå…¶æ˜¯googleçš„äº²å„¿å­ï¼Œgrpcæ¡†æ¶ä¾¿æ˜¯ä½¿ç”¨protobufä½œä¸ºåºåˆ—åŒ–åè®®ï¼Œè™½ç„¶protobufä¸è¯­è¨€æ— å…³å¹³å°æ— å…³ï¼Œä½†éœ€è¦ä½¿ç”¨ç‰¹å®šçš„è¯­æ³•ç¼–å†™ `.prpto` æ–‡ä»¶ï¼Œç„¶åé™æ€ç¼–è¯‘ï¼Œè¿™å¸¦äº†ä¸€äº›å¤æ‚æ€§ã€‚è€Œ protostuff å®é™…æ˜¯å¯¹ protobuf çš„æ‰©å±•ï¼Œprotostuff-runtime æ¨¡å—ç»§æ‰¿äº†protobuf æ€§èƒ½ï¼Œä¸”ä¸éœ€è¦é¢„ç¼–è¯‘æ–‡ä»¶ï¼Œä½†ä¸æ­¤åŒæ—¶ï¼Œä¹Ÿå¤±å»äº†è·¨è¯­è¨€çš„ç‰¹æ€§ã€‚æ‰€ä»¥ protostuff çš„å®šä½æ˜¯ä¸€ä¸ª JAVA åºåˆ—åŒ–æ¡†æ¶ï¼Œå…¶æ€§èƒ½ç•¥ä¼˜äº Hessianã€‚tip ï¼šprotostuff ååºåˆ—åŒ–æ—¶éœ€ç”¨æˆ·è‡ªå·±åˆå§‹åŒ–åºåˆ—åŒ–åçš„å¯¹è±¡ï¼Œå…¶åªè´Ÿè´£å°†è¯¥å¯¹è±¡è¿›è¡Œèµ‹å€¼ã€‚github 719 starã€‚

Fastjsonï¼šä½œä¸ºä¸€ä¸ª json å·¥å…·ï¼Œè¢«æ‹‰åˆ° RPC çš„åºåˆ—åŒ–æ–¹æ¡ˆä¸­ä¼¼ä¹æœ‰ç‚¹ä¸å¦¥ï¼Œä½† motan è¯¥ RPC æ¡†æ¶é™¤äº†æ”¯æŒ hessian ä¹‹å¤–ï¼Œè¿˜æ”¯æŒäº† fastjson çš„åºåˆ—åŒ–ã€‚å¯ä»¥å°†å…¶ä½œä¸ºä¸€ä¸ªè·¨è¯­è¨€åºåˆ—åŒ–çš„ç®€æ˜“å®ç°æ–¹æ¡ˆã€‚github 11.8k starã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ RPC å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)