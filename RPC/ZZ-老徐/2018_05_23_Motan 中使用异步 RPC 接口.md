title: Motan ä¸­ä½¿ç”¨å¼‚æ­¥ RPC æ¥å£
date: 2018-05-23
tags:
categories:
permalink: RPC/laoxu/motan-async/
author: è€å¾
from_url: https://www.cnkirito.moe/motan-async/
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484569&idx=1&sn=93668dca2c192cddf1371a7402ed2508&chksm=fa497b28cd3ef23ef7d145ecd99fdf7e0194273b42900397e5b9a237f20c909d4c879332cb2f#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnkirito.moe/motan-async/ ã€Œè€å¾ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [ä¸ºä»€ä¹ˆæ…¢ï¼Ÿ](http://www.iocoder.cn/RPC/laoxu/motan-async//)
  - [å¤šçº¿ç¨‹åŠ é€Ÿ](http://www.iocoder.cn/RPC/laoxu/motan-async//)
  - [å¼‚æ­¥è°ƒç”¨](http://www.iocoder.cn/RPC/laoxu/motan-async//)
  - [RPC å¼‚æ­¥è°ƒç”¨](http://www.iocoder.cn/RPC/laoxu/motan-async//)
  - [æ€»ç»“](http://www.iocoder.cn/RPC/laoxu/motan-async//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

è¿™å‘¨å…­å‚åŠ äº†ä¸€ä¸ªç¾å›¢ç‚¹è¯„çš„æŠ€æœ¯æ²™é¾™ï¼Œå…¶ä¸­ä¸€ä½è€å¸ˆåœ¨ä»‹ç»ä»–ä»¬è‡ªç ”çš„ RPC æ¡†æ¶æ—¶æåˆ°ä¸€ç‚¹ï¼šRPC è¯·æ±‚åˆ†ä¸º syncï¼Œfutureï¼Œcallbackï¼Œonewayï¼Œå¹¶ä¸”éœ€è¦éµå¾ªä¸€ä¸ªåŸåˆ™ï¼šèƒ½å¤Ÿå¼‚æ­¥çš„åœ°æ–¹å°±ä¸è¦ä½¿ç”¨åŒæ­¥ã€‚æ­£å¥½æœ€è¿‘åœ¨ä¼˜åŒ–ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼šåœ¨ä¸€æ¬¡é¡µé¢å±•ç¤ºä¸­ï¼Œéœ€è¦è°ƒç”¨ 5 ä¸ª RPC æ¥å£ï¼Œå¯¼è‡´é¡µé¢å“åº”å¾ˆæ…¢ã€‚æ­£å¥½å¯å‘äº†æˆ‘ã€‚

## ä¸ºä»€ä¹ˆæ…¢ï¼Ÿ

å¤§å¤šæ•°å¼€æºçš„ RPC æ¡†æ¶å®ç°è¿œç¨‹è°ƒç”¨çš„æ–¹å¼éƒ½æ˜¯åŒæ­¥çš„ï¼Œå‡è®¾ [ æ¥å£1ï¼Œâ€¦ï¼Œæ¥å£5]çš„æ¯ä¸€æ¬¡è°ƒç”¨è€—æ—¶ä¸º 200ms ï¼ˆå…¶ä¸­æ¥å£2ä¾èµ–æ¥å£1ï¼Œæ¥å£5ä¾èµ–æ¥å£3ï¼Œæ¥å£4ï¼‰ï¼Œé‚£ä¹ˆæ€»è€—æ—¶ä¸º 1sï¼Œè¿™æ•´ä¸ªæ˜¯ä¸€ä¸ªä¸²è¡Œçš„è¿‡ç¨‹ã€‚

## å¤šçº¿ç¨‹åŠ é€Ÿ

ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯å¤šçº¿ç¨‹ï¼Œé‚£ä¹ˆ[1=>2]ç¼–ä¸ºä¸€ç»„ï¼Œ[[3,4]=>5]ç¼–ä¸ºä¸€ç»„ï¼Œä¸¤ç»„å¹¶å‘æ‰§è¡Œï¼Œ[1=>2]ä¸²è¡Œæ‰§è¡Œè€—æ—¶400msï¼Œ[3,4]å¹¶å‘æ‰§è¡Œè€—æ—¶200msï¼Œ[[3,4]=>5]æ€»è€—æ—¶400ms ï¼Œæœ€ç»ˆ[[1=>2],[[3,4]=>5]]æ€»è€—æ—¶400msï¼ˆç†è®ºè€—æ—¶ï¼‰ã€‚ç›¸æ¯”è¾ƒäºåŸæ¥çš„1sï¼Œçš„ç¡®å¿«äº†ä¸å°‘ï¼Œä½†å®é™…ç¼–å†™æ¥å£èŠ±äº†ä¸å°‘åŠŸå¤«ï¼Œåˆ›å»ºçº¿ç¨‹æ± ï¼Œç®¡ç†èµ„æºï¼Œåˆ†æä¾èµ–å…³ç³»â€¦æ€»ä¹‹ä»£ç ä¸æ˜¯å¾ˆä¼˜é›…ã€‚

RPCä¸­ï¼Œå¤šçº¿ç¨‹ç€é‡è€ƒè™‘çš„ç‚¹æ˜¯åœ¨å®¢æˆ·ç«¯ä¼˜åŒ–ä»£ç ï¼Œè¿™ç»™å®¢æˆ·ç«¯å¸¦æ¥äº†ä¸€å®šçš„å¤æ‚æ€§ï¼Œå¹¶ä¸”ç¼–å†™å¹¶å‘ä»£ç å¯¹ç¨‹åºå‘˜çš„è¦æ±‚æ›´é«˜ï¼Œä¸”ä¸åˆ©äºè°ƒè¯•ã€‚

## å¼‚æ­¥è°ƒç”¨

å¦‚æœæœ‰ä¸€ç§æ—¢èƒ½ä¿è¯é€Ÿåº¦ï¼Œåˆèƒ½åƒåŒæ­¥ RPC è°ƒç”¨é‚£æ ·æ–¹ä¾¿ï¼Œå²‚ä¸ç¾å“‰ï¼Ÿäºæ˜¯å¼•å‡ºäº† RPC ä¸­çš„å¼‚æ­¥è°ƒç”¨ã€‚

åœ¨ RPC å¼‚æ­¥è°ƒç”¨ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹ `java.util.concurrent` ä¸­çš„åŸºç¡€çŸ¥è¯†ï¼š`Callable` å’Œ `Future`

```Java
public class Main {

    public static void main(String[] args) throws Exception{

        final ExecutorService executorService = Executors.newFixedThreadPool(10);
        long start = System.currentTimeMillis();
        Future<Integer> resultFuture1 = executorService.submit(new Callable<Integer>() {
            @Override
            public Integer call() throws Exception {
                return method1() + method2();
            }
        });
        Future<Integer> resultFuture2 = executorService.submit(new Callable<Integer>() {
            @Override
            public Integer call() throws Exception {
                Future<Integer> resultFuture3 = executorService.submit(new Callable<Integer>() {
                    @Override
                    public Integer call() throws Exception {
                        return method3();
                    }
                });
                Future<Integer> resultFuture4 = executorService.submit(new Callable<Integer>() {
                    @Override
                    public Integer call() throws Exception {
                        return method4();
                    }
                });
                return method5()+resultFuture3.get()+resultFuture4.get();
            }
        });
        int result = resultFuture1.get() + resultFuture2.get();

        System.out.println("result = "+result+", total cost "+(System.currentTimeMillis()-start)+" ms");

      	executorService.shutdown();
    }

    static int method1(){
        delay200ms();
        return 1;
    }
    static int method2(){
        delay200ms();
        return 2;
    }
    static int method3(){
        delay200ms();
        return 3;
    }
    static int method4(){
        delay200ms();
        return 4;
    }
    static int method5(){
        delay200ms();
        return 5;
    }

    static void delay200ms(){
        try{
            Thread.sleep(200);
        }catch (Exception e){
            e.printStackTrace();
        }
    }

}
```

æœ€ç»ˆæ§åˆ¶å°æ‰“å°ï¼š

**result = 15, total cost 413 ms**

äº”ä¸ªæ¥å£ï¼Œå¦‚æœåŒæ­¥è°ƒç”¨ï¼Œä¾¿æ˜¯ä¸²è¡Œçš„æ•ˆæœï¼Œæœ€ç»ˆè€—æ—¶å¿…å®šåœ¨ 1s ä¹‹ä¸Šï¼Œè€Œå¼‚æ­¥è°ƒç”¨çš„ä¼˜åŠ¿ä¾¿æ˜¯ï¼Œsubmitä»»åŠ¡ä¹‹åç«‹åˆ»è¿”å›ï¼Œåªæœ‰åœ¨è°ƒç”¨ `future.get()` æ–¹æ³•æ—¶æ‰ä¼šé˜»å¡ï¼Œè€Œè¿™æœŸé—´å¤šä¸ªå¼‚æ­¥æ–¹æ³•ä¾¿å¯ä»¥å¹¶å‘çš„æ‰§è¡Œã€‚

## RPC å¼‚æ­¥è°ƒç”¨

æˆ‘ä»¬çš„é¡¹ç›®ä½¿ç”¨äº† Motan ä½œä¸º RPC æ¡†æ¶ï¼ŒæŸ¥çœ‹å…¶ changeLog ï¼Œ[0.3.0](https://github.com/weibocom/motan/tree/0.3.0) (2017-03-09) è¯¥ç‰ˆæœ¬å·²ç»æ”¯æŒäº† async ç‰¹æ€§ã€‚å¯ä»¥è®©å¼€å‘è€…å¾ˆæ–¹ä¾¿åœ°å®ç° RPC å¼‚æ­¥è°ƒç”¨ã€‚

**1 ä¸ºæ¥å£å¢åŠ  @MotanAsync æ³¨è§£**

```Java
@MotanAsync
public interface DemoApi {
    DemoDto randomDemo(String id);
}
```

**2 æ·»åŠ  Maven æ’ä»¶**

```XML
<build>
    <plugins>
        <plugin>
            <groupId>org.codehaus.mojo</groupId>
            <artifactId>build-helper-maven-plugin</artifactId>
            <version>1.10</version>
            <executions>
                <execution>
                    <phase>generate-sources</phase>
                    <goals>
                        <goal>add-source</goal>
                    </goals>
                    <configuration>
                        <sources>
                            <source>${project.build.directory}/generated-sources/annotations</source>
                        </sources>
                    </configuration>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

å®‰è£…æ’ä»¶åï¼Œå¯ä»¥å€ŸåŠ©å®ƒç”Ÿæˆä¸€ä¸ªå’Œ DemoApi å…³è”çš„å¼‚æ­¥æ¥å£ DemoApiAsync ã€‚

```Java
public interface DemoApiAsync extends DemoApi {
  ResponseFuture randomDemoAsync(String id);
}
```

**3 æ³¨å…¥æ¥å£å³å¯è°ƒç”¨**

```Java
@Service
public class DemoService {

    @MotanReferer
    DemoApi demoApi;

    @MotanReferer
    DemoApiAsync demoApiAsync;//<1>

    public DemoDto randomDemo(String id){
        DemoDto demoDto = demoApi.randomDemo(id);
        return demoDto;
    }

    public DemoDto randomDemoAsync(String id){
        ResponseFuture responseFuture = demoApiAsync.randomDemoAsync(id);//<2>
        DemoDto demoDto = (DemoDto) responseFuture.getValue();
        return demoDto;
    }

}
```

`<1>` DemoApiAsync å¦‚ä½•ç”Ÿæˆçš„å·²ç»ä»‹ç»è¿‡ï¼Œå®ƒå’Œ DemoApi å¹¶æ²¡æœ‰åŠŸèƒ½æ€§çš„åŒºåˆ«ï¼Œä»…ä»…æ˜¯åŒæ­¥å¼‚æ­¥è°ƒç”¨çš„å·®è·ï¼Œè€Œ DemoApiAsync å®ç°çš„çš„å¤æ‚æ€§å®Œå…¨ç”± RPC æ¡†æ¶å¸®åŠ©æˆ‘ä»¬å®Œæˆï¼Œå¼€å‘è€…æ— éœ€ç¼–å†™ Callable æ¥å£ã€‚

`<2>` ResponseFuture æ˜¯ RPC ä¸­ Future çš„æŠ½è±¡ï¼Œå…¶æœ¬èº«ä¹Ÿæ˜¯ juc ä¸­ Future çš„å­ç±»ï¼Œå½“ responseFuture.getValue() è°ƒç”¨æ—¶ä¼šé˜»å¡ã€‚

## æ€»ç»“

åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œå¦‚æœå‘èµ·ä¸€æ¬¡å¼‚æ­¥è°ƒç”¨åï¼Œç«‹åˆ»ä½¿ç”¨ future.get() ï¼Œåˆ™å¤§è‡´å’ŒåŒæ­¥è°ƒç”¨ç­‰åŒã€‚å…¶çœŸæ­£çš„ä¼˜åŠ¿æ˜¯åœ¨submit å’Œ future.get() ä¹‹é—´å¯ä»¥æ··æ‚ä¸€äº›éä¾èµ–æ€§çš„è€—æ—¶æ“ä½œï¼Œè€Œä¸æ˜¯åŒæ­¥ç­‰å¾…ï¼Œä»è€Œå……åˆ†åˆ©ç”¨æ—¶é—´ç‰‡ã€‚

å¦å¤–éœ€è¦æ³¨æ„ï¼Œå¦‚æœå¼‚æ­¥è°ƒç”¨æ¶‰åŠåˆ°æ•°æ®çš„ä¿®æ”¹ï¼Œåˆ™å¤šä¸ªå¼‚æ­¥æ“ä½œç›´æ¥ä¸èƒ½ä¿è¯ happens-before åŸåˆ™ï¼Œè¿™å±äºå¹¶å‘æ§åˆ¶çš„èŒƒç•´äº†ï¼Œè°¨æ…ä½¿ç”¨ã€‚æŸ¥è¯¢æ“ä½œåˆ™å¤§å¤šæ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚

åœ¨èƒ½ä½¿ç”¨å¹¶å‘çš„åœ°æ–¹ä½¿ç”¨å¹¶å‘ï¼Œä¸èƒ½ä½¿ç”¨çš„åœ°æ–¹æ‰é€‰æ‹©åŒæ­¥ï¼Œè¿™éœ€è¦æˆ‘ä»¬æ€è€ƒæ›´å¤šç»†èŠ‚ï¼Œä½†å¯ä»¥æœ€å¤§é™åº¦çš„æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ RPC å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)