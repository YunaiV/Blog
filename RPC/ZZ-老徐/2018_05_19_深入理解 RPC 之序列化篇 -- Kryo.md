title: æ·±å…¥ç†è§£ RPC ä¹‹åºåˆ—åŒ–ç¯‡ -- Kryo
date: 2018-05-19
tags:
categories:
permalink: RPC/laoxu/rpc-serialize-1/
author: è€å¾
from_url: https://www.cnkirito.moe/rpc-serialize-1/
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484459&idx=1&sn=935a1a599d4e1d87658b65ad355792bb&chksm=fa497b9acd3ef28cc3e7b74d58c47599b79dcc435bcfb254b5440e0c7ab6f62e424b1af6dabb#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnkirito.moe/rpc-serialize-1/ ã€Œè€å¾ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [åºåˆ—åŒ–æ¦‚è¿°](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-1//)
  - [JDKåºåˆ—åŒ–](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-1//)
  - [Kryoå…¥é—¨](http://www.iocoder.cn/RPC/laoxu/rpc-serialize-1//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä¸€å¹´å‰ï¼Œç¬”è€…åˆšåˆšæ¥è§¦RPCæ¡†æ¶ï¼Œä»å•ä½“å¼åº”ç”¨å‘åˆ†å¸ƒå¼åº”ç”¨çš„å˜é©æ— ç–‘æ˜¯è®©äººå…´å¥‹çš„ï¼ŒåŒæ—¶ä¹Ÿå¯¹RPCèƒŒååˆ°åº•åšäº†å“ªäº›å·¥ä½œäº§ç”Ÿäº†å…´è¶£ï¼Œä½†å…¶åº•å±‚çš„è®¾è®¡å¯¹æ–°æ‰‹è€Œè¨€å¹¶ä¸æ˜¯å¾ˆå‹å¥½ï¼Œå…¶æ¶‰åŠçš„ä¸€äº›å¸¸ç”¨æŠ€æœ¯ç‚¹éƒ½æœ‰ä¸€å®šçš„é—¨æ§›ã€‚å¦‚ä¼ è¾“å±‚å¸¸å¸¸ä½¿ç”¨çš„nettyï¼Œä¹‹å‰å®Œå…¨æ²¡å¬è¿‡ï¼Œæƒ³è¦å­¦ä¹ å®ƒï¼Œéœ€è¦æŒæ¡å‰ç½®çŸ¥è¯†ç‚¹nioï¼›åè®®å±‚ï¼ŒåŒ…æ‹¬äº†å¾ˆå¤šè‡ªå®šä¹‰çš„åè®®ï¼Œè€Œæ¯ä¸ªRPCæ¡†æ¶çš„å®ç°éƒ½æœ‰å·®å¼‚ï¼›ä»£ç†å±‚çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œå¦‚jdkåŠ¨æ€ä»£ç†ï¼Œè™½ç„¶å®æˆ˜ç»éªŒä¸å¤šï¼Œä½†è‡³å°‘è¿˜ç®—ä¼šç”¨ï¼Œè€Œcglibåˆ™åˆæœ‰ä¸€ä¸ªç›²åŒºï¼›åºåˆ—åŒ–å±‚å€’è¿˜ç®—æ˜¯ä¼—å¤šå±‚æ¬¡ä¸­ç›¸å¯¹ç®€å•çš„ä¸€ç¯ï¼Œä½†RPCä¸ºäº†è¿½æ±‚å¯æ‰©å±•æ€§ï¼Œæ€§èƒ½ç­‰è¯¸å¤šå› ç´ ï¼Œé€šå¸¸ä¼šæ”¯æŒå¤šç§åºåˆ—åŒ–æ–¹å¼ä»¥ä¾›ä½¿ç”¨è€…æ’æ‹”ä½¿ç”¨ï¼Œä¸€äº›å¸¸ç”¨çš„åºåˆ—åŒ–æ–¹æ¡ˆhessianï¼Œkryoï¼ŒProtobufåˆå¾—ç†ŸçŸ¥â€¦

è¿™ä¸ªç³»åˆ—æ‰“ç®—å°±RPCæ¡†æ¶æ¶‰åŠåˆ°çš„ä¸€äº›çŸ¥è¯†ç‚¹è¿›è¡Œæ¢è®¨ï¼Œæœ¬ç¯‡å…ˆä»åºåˆ—åŒ–å±‚çš„ä¸€ç§é€‰æ‹©â€“kryoå¼€å§‹è¿›è¡Œä»‹ç»ã€‚

## åºåˆ—åŒ–æ¦‚è¿°

å¤§ç™½è¯ä»‹ç»ä¸‹RPCä¸­åºåˆ—åŒ–çš„æ¦‚å¿µï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå¯¹è±¡â€“>å­—èŠ‚çš„è¿‡ç¨‹ï¼ŒåŒç†ï¼Œååºåˆ—åŒ–åˆ™æ˜¯ç›¸åçš„è¿‡ç¨‹ã€‚ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–ï¼Ÿå› ä¸ºç½‘ç»œä¼ è¾“åªè®¤å­—èŠ‚ã€‚æ‰€ä»¥äº’ä¿¡çš„è¿‡ç¨‹ä¾èµ–äºåºåˆ—åŒ–ã€‚æœ‰äººä¼šé—®ï¼ŒFastJsonè½¬æ¢æˆå­—ç¬¦ä¸²ç®—ä¸ç®—åºåˆ—åŒ–ï¼Ÿå¯¹è±¡æŒä¹…åŒ–åˆ°æ•°æ®åº“ç®—ä¸ç®—åºåˆ—åŒ–ï¼Ÿæ²¡å¿…è¦è¾ƒçœŸï¼Œå¹¿ä¹‰ä¸Šç†è§£å³å¯ã€‚

## JDKåºåˆ—åŒ–

å¯èƒ½ä½ æ²¡ç”¨è¿‡kryoï¼Œæ²¡ç”¨è¿‡hessianï¼Œä½†ä½ ä¸€å®šç”¨è¿‡jdkåºåˆ—åŒ–ã€‚æˆ‘æœ€æ—©æ¥è§¦jdkåºåˆ—åŒ–ï¼Œæ˜¯åœ¨å¤§äºŒçš„JAVAå¤§ä½œä¸šä¸­ï¼Œã€ŠXXç®¡ç†ç³»ç»Ÿã€‹éœ€è¦æŠŠå¯¹è±¡ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼ˆé‚£æ—¶è¿˜æ²¡å­¦æ•°æ®åº“ï¼‰ï¼ŒjdkåŸç”Ÿæ”¯æŒçš„åºåˆ—åŒ–æ–¹å¼ç”¨èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚

```Java
class Student implements Serializable{
   private String name;
}
class Main{
   public static void main(String[] args) throws Exception{
      // create a Student
      Student st = new Student("kirito");
     // serialize the st to student.db file
     ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("student.db"));
     oos.writeObject(st);
     oos.close();
     // deserialize the object from student.db
     ObjectInputStream ois = new ObjectInputStream(new FileInputStream("student.db"));
     Student kirito = (Student) ois.readObject();
     ois.close();
    // assert
    assert "kirito".equals(kirito.getName());
   }
}
```

Studentå®ä½“ç±»éœ€è¦å®ç°Serializableæ¥å£ï¼Œä»¥å‘ŠçŸ¥å…¶å¯è¢«åºåˆ—åŒ–ã€‚

åºåˆ—åŒ–åè®®çš„é€‰æ‹©é€šå¸¸æœ‰ä¸‹åˆ—ä¸€äº›å¸¸ç”¨çš„æŒ‡æ ‡ï¼š

1. é€šç”¨æ€§ã€‚æ˜¯å¦åªèƒ½ç”¨äºjavaé—´åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œæ˜¯å¦è·¨è¯­è¨€ï¼Œè·¨å¹³å°ã€‚
2. æ€§èƒ½ã€‚åˆ†ä¸ºç©ºé—´å¼€é”€å’Œæ—¶é—´å¼€é”€ã€‚åºåˆ—åŒ–åçš„æ•°æ®ä¸€èˆ¬ç”¨äºå­˜å‚¨æˆ–ç½‘ç»œä¼ è¾“ï¼Œå…¶å¤§å°æ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªå‚æ•°ï¼›è§£æçš„æ—¶é—´ä¹Ÿå½±å“äº†åºåˆ—åŒ–åè®®çš„é€‰æ‹©ï¼Œå¦‚ä»Šçš„ç³»ç»Ÿéƒ½åœ¨è¿½æ±‚æè‡´çš„æ€§èƒ½ã€‚
3. å¯æ‰©å±•æ€§ã€‚ç³»ç»Ÿå‡çº§ä¸å¯é¿å…ï¼ŒæŸä¸€å®ä½“çš„å±æ€§å˜æ›´ï¼Œä¼šä¸ä¼šå¯¼è‡´ååºåˆ—åŒ–å¼‚å¸¸ï¼Œä¹Ÿåº”è¯¥çº³å…¥åºåˆ—åŒ–åè®®çš„è€ƒé‡èŒƒå›´ã€‚
4. æ˜“ç”¨æ€§ã€‚APIä½¿ç”¨æ˜¯å¦å¤æ‚ï¼Œä¼šå½±å“å¼€å‘æ•ˆç‡ã€‚

å®¹æ˜“ç”¨çš„æ¨¡å‹é€šå¸¸æ€§èƒ½ä¸å¥½ï¼Œæ€§èƒ½å¥½çš„æ¨¡å‹é€šå¸¸ç”¨èµ·æ¥éƒ½æ¯”è¾ƒéº»çƒ¦ã€‚æ˜¾ç„¶ï¼ŒJDKåºåˆ—åŒ–å±äºå‰è€…ã€‚æˆ‘ä»¬ä¸è¿‡å¤šä»‹ç»å®ƒï¼Œç›´æ¥å¼•å…¥ä»Šå¤©çš„ä¸»è§’kryoä½œä¸ºå®ƒçš„æ›¿ä»£å“ã€‚

## Kryoå…¥é—¨

### å¼•å…¥ä¾èµ–

```XML
<dependency>
    <groupId>com.esotericsoftware</groupId>
    <artifactId>kryo</artifactId>
    <version>4.0.1</version>
</dependency>
```

ç”±äºå…¶åº•å±‚ä¾èµ–äºASMæŠ€æœ¯ï¼Œä¸Springç­‰æ¡†æ¶å¯èƒ½ä¼šå‘ç”ŸASMä¾èµ–çš„ç‰ˆæœ¬å†²çªï¼ˆæ–‡æ¡£ä¸­è¡¨ç¤ºè¿™ä¸ªå†²çªè¿˜æŒºå®¹æ˜“å‡ºç°ï¼‰æ‰€ä»¥æä¾›äº†å¦å¤–ä¸€ä¸ªä¾èµ–ä»¥ä¾›è§£å†³æ­¤é—®é¢˜

```XML
<dependency>
    <groupId>com.esotericsoftware</groupId>
    <artifactId>kryo-shaded</artifactId>
    <version>4.0.1</version>
</dependency>
```

### å¿«é€Ÿå…¥é—¨

```Java
class Student implements Serializable{
   private String name;
}
public class Main {
    public static void main(String[] args) throws Exception{
        Kryo kryo = new Kryo();
        Output output = new Output(new FileOutputStream("student.db"));
        Student kirito = new Student("kirito");
        kryo.writeObject(output, kirito);
        output.close();
        Input input = new Input(new FileInputStream("student.db"));
        Student kiritoBak = kryo.readObject(input, Student.class);
        input.close();
        assert "kirito".equals(kiritoBak.getName());
    }
}
```

ä¸éœ€è¦æ³¨é‡Šä¹Ÿèƒ½ç†è§£å®ƒçš„æ‰§è¡Œæµç¨‹ï¼Œå’Œjdkåºåˆ—åŒ–å·®è·å¹¶ä¸æ˜¯å¾ˆå¤§ã€‚

### ä¸‰ç§è¯»å†™æ–¹å¼

Kryoå…±æ”¯æŒä¸‰ç§è¯»å†™æ–¹å¼

1. å¦‚æœçŸ¥é“classå­—èŠ‚ç ï¼Œå¹¶ä¸”å¯¹è±¡ä¸ä¸ºç©º

```Java
kryo.writeObject(output, someObject);
// ...
SomeClass someObject = kryo.readObject(input, SomeClass.class);
```

å¿«é€Ÿå…¥é—¨ä¸­çš„åºåˆ—åŒ–/ååºåˆ—åŒ–çš„æ–¹å¼ä¾¿æ˜¯è¿™ä¸€ç§ã€‚è€ŒKryoè€ƒè™‘åˆ°someObjectå¯èƒ½ä¸ºnullï¼Œä¹Ÿä¼šå¯¼è‡´è¿”å›çš„ç»“æœä¸ºnullï¼Œæ‰€ä»¥æä¾›äº†ç¬¬äºŒå¥—è¯»å†™æ–¹å¼ã€‚

1. å¦‚æœçŸ¥é“classå­—èŠ‚ç ï¼Œå¹¶ä¸”å¯¹è±¡å¯èƒ½ä¸ºç©º

```Java
kryo.writeObjectOrNull(output, someObject);
// ...
SomeClass someObject = kryo.readObjectOrNull(input, SomeClass.class);
```

ä½†è¿™ä¸¤ç§æ–¹æ³•ä¼¼ä¹éƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œåœ¨RPCè°ƒç”¨ä¸­ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–åˆ†å¸ƒåœ¨ä¸åŒçš„ç«¯ç‚¹ï¼Œå¯¹è±¡çš„ç±»å‹ç¡®å®šï¼Œæˆ‘ä»¬ä¸æƒ³ä¾èµ–äºæ‰‹åŠ¨æŒ‡å®šå‚æ•°ï¼Œæœ€å¥½æ˜¯â€¦emmmmmâ€¦å°†å­—èŠ‚ç çš„ä¿¡æ¯ç›´æ¥å­˜æ”¾åˆ°åºåˆ—åŒ–ç»“æœä¸­ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è‡ªè¡Œè¯»å–å­—èŠ‚ç ä¿¡æ¯ã€‚Kryoè€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œäºæ˜¯æä¾›äº†ç¬¬ä¸‰ç§æ–¹å¼ã€‚

1. å¦‚æœå®ç°ç±»çš„å­—èŠ‚ç æœªçŸ¥ï¼Œå¹¶ä¸”å¯¹è±¡å¯èƒ½ä¸ºnull

```Java
kryo.writeClassAndObject(output, object);
// ...
Object object = kryo.readClassAndObject(input);
if (object instanceof SomeClass) {
   // ...
}
```

æˆ‘ä»¬ç‰ºç‰²äº†ä¸€äº›ç©ºé—´ä¸€äº›æ€§èƒ½å»å­˜æ”¾å­—èŠ‚ç ä¿¡æ¯ï¼Œä½†è¿™ç§æ–¹å¼æ˜¯æˆ‘ä»¬åœ¨RPCä¸­åº”å½“ä½¿ç”¨çš„æ–¹å¼ã€‚

### æˆ‘ä»¬å…³å¿ƒçš„é—®é¢˜

ç»§ç»­ä»‹ç»Kryoç‰¹æ€§ä¹‹å‰ï¼Œä¸å¦¨è®©æˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸‹ï¼Œä¸€ä¸ªåºåˆ—åŒ–å·¥å…·æˆ–è€…ä¸€ä¸ªåºåˆ—åŒ–åè®®ï¼Œåº”å½“éœ€è¦è€ƒè™‘å“ªäº›é—®é¢˜ã€‚æ¯”å¦‚ï¼Œæ”¯æŒå“ªäº›ç±»å‹çš„åºåˆ—åŒ–ï¼Ÿå¾ªç¯å¼•ç”¨ä¼šä¸ä¼šå‡ºç°é—®é¢˜ï¼Ÿåœ¨æŸä¸ªç±»å¢åˆ å­—æ®µä¹‹åååºåˆ—åŒ–ä¼šæŠ¥é”™å—ï¼Ÿç­‰ç­‰ç­‰ç­‰â€¦.

å¸¦ç€æˆ‘ä»¬è€ƒè™‘åˆ°çš„è¿™äº›ç–‘æƒ‘ï¼Œä»¥åŠæˆ‘ä»¬æš‚æ—¶æ²¡è€ƒè™‘åˆ°çš„ï¼Œä½†Kryoå¸®æˆ‘ä»¬è€ƒè™‘åˆ°çš„ï¼Œæ¥çœ‹çœ‹Kryoåˆ°åº•æ”¯æŒå“ªäº›ç‰¹æ€§ã€‚

### æ”¯æŒçš„åºåˆ—åŒ–ç±»å‹

| boolean       | Boolean  | byte                      | Byte                     | char             |
| ------------- | -------- | ------------------------- | ------------------------ | ---------------- |
| Character     | short    | Short                     | int                      | Integer          |
| long          | Long     | float                     | Float                    | double           |
| Double        | byte[]   | String                    | BigInteger               | BigDecimal       |
| Collection    | Date     | Collections.emptyList     | Collections.singleton    | Map              |
| StringBuilder | TreeMap  | Collections.emptyMap      | Collections.emptySet     | KryoSerializable |
| StringBuffer  | Class    | Collections.singletonList | Collections.singletonMap | Currency         |
| Calendar      | TimeZone | Enum                      | EnumSet                  |                  |

è¡¨æ ¼ä¸­æ”¯æŒçš„ç±»å‹ä¸€è§ˆæ— ä½™ï¼Œè¿™éƒ½æ˜¯å…¶é»˜è®¤æ”¯æŒçš„ã€‚

```Java
Kryo kryo = new Kryo();
kryo.addDefaultSerializer(SomeClass.class, SomeSerializer.class);
```

è¿™æ ·çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä¸ºä¸€ä¸ªKryoå®ä¾‹æ‰©å±•åºåˆ—åŒ–å™¨ã€‚

æ€»ä½“è€Œè¨€ï¼ŒKryoæ”¯æŒä»¥ä¸‹çš„ç±»å‹ï¼š

- æšä¸¾
- é›†åˆã€æ•°ç»„
- å­ç±»/å¤šæ€
- å¾ªç¯å¼•ç”¨
- å†…éƒ¨ç±»
- æ³›å‹

ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**Kryoä¸æ”¯æŒBeanä¸­å¢åˆ å­—æ®µ**ã€‚å¦‚æœä½¿ç”¨Kryoåºåˆ—åŒ–äº†ä¸€ä¸ªç±»ï¼Œå­˜å…¥äº†Redisï¼Œå¯¹ç±»è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¼šå¯¼è‡´ååºåˆ—åŒ–çš„å¼‚å¸¸ã€‚

å¦å¤–éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ä½¿ç”¨åå°„åˆ›å»ºçš„ä¸€äº›ç±»åºåˆ—åŒ–çš„æ”¯æŒã€‚å¦‚ä½¿ç”¨Arrays.asList();åˆ›å»ºçš„Listå¯¹è±¡ï¼Œä¼šå¼•èµ·åºåˆ—åŒ–å¼‚å¸¸ã€‚

```SHELL
Exception in thread "main" com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): java.util.Arrays$ArrayList
```

ä½†new ArrayList()åˆ›å»ºçš„Listå¯¹è±¡åˆ™ä¸ä¼šï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“å¯¹Kryoè¿›è¡Œåºåˆ—åŒ–ç±»å‹çš„æ‰©å±•ã€‚å¦‚[https://github.com/magro/kryo-serializersæ‰€æä¾›çš„ã€‚](https://github.com/magro/kryo-serializers%E6%89%80%E6%8F%90%E4%BE%9B%E7%9A%84%E3%80%82)

**ä¸æ”¯æŒåŒ…å«æ— å‚æ„é€ å™¨ç±»çš„ååºåˆ—åŒ–**ï¼Œå°è¯•ååºåˆ—åŒ–ä¸€ä¸ªä¸åŒ…å«æ— å‚æ„é€ å™¨çš„ç±»å°†ä¼šå¾—åˆ°ä»¥ä¸‹çš„å¼‚å¸¸ï¼š

```SHELL
Exception in thread "main" com.esotericsoftware.kryo.KryoException: Class cannot be created (missing no-arg constructor): moe.cnkirito.Xxx
```

ä¿è¯æ¯ä¸ªç±»å…·æœ‰æ— å‚æ„é€ å™¨æ˜¯åº”å½“éµå®ˆçš„ç¼–ç¨‹è§„èŒƒï¼Œä½†å®é™…å¼€å‘ä¸­ä¸€äº›ç¬¬ä¸‰åº“çš„ç›¸å…³ç±»ä¸åŒ…å«æ— å‚æ„é€ ï¼Œçš„ç¡®æ˜¯æœ‰ç‚¹éº»çƒ¦ã€‚

### çº¿ç¨‹å®‰å…¨

Kryoæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ„å‘³ç€æ¯å½“éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶éƒ½éœ€è¦å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œæˆ–è€…å€ŸåŠ©ThreadLocalæ¥ç»´æŠ¤ä»¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ã€‚

```Java
private static final ThreadLocal<Kryo> kryos = new ThreadLocal<Kryo>() {
	protected Kryo initialValue() {
		Kryo kryo = new Kryo();
		// configure kryo instance, customize settings
		return kryo;
	};
};

// Somewhere else, use Kryo
Kryo k = kryos.get();
...
```

### Kryoç›¸å…³é…ç½®å‚æ•°è¯¦è§£

æ¯ä¸ªKryoå®ä¾‹éƒ½å¯ä»¥æ‹¥æœ‰ä¸¤ä¸ªé…ç½®å‚æ•°ï¼Œè¿™å€¼å¾—è¢«æ‹‰å‡ºæ¥å•ç‹¬èŠä¸€èŠã€‚

```Java
kryo.setRegistrationRequired(false);//å…³é—­æ³¨å†Œè¡Œä¸º
kryo.setReferences(true);//æ”¯æŒå¾ªç¯å¼•ç”¨
```

Kryoæ”¯æŒå¯¹æ³¨å†Œè¡Œä¸ºï¼Œå¦‚`kryo.register(SomeClazz.class);`,è¿™ä¼šèµ‹äºˆè¯¥Classä¸€ä¸ªä»0å¼€å§‹çš„ç¼–å·ï¼Œä½†Kryoä½¿ç”¨æ³¨å†Œè¡Œä¸ºæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œå…¶ä¸ä¿è¯åŒä¸€ä¸ªClassæ¯ä¸€æ¬¡æ³¨å†Œçš„å·ç æƒ³ç”¨ï¼Œè¿™ä¸æ³¨å†Œçš„é¡ºåºæœ‰å…³ï¼Œä¹Ÿå°±æ„å‘³ç€åœ¨ä¸åŒçš„æœºå™¨ã€åŒä¸€ä¸ªæœºå™¨é‡å¯å‰åéƒ½æœ‰å¯èƒ½æ‹¥æœ‰ä¸åŒçš„ç¼–å·ï¼Œè¿™ä¼šå¯¼è‡´åºåˆ—åŒ–äº§ç”Ÿé—®é¢˜ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œä¸€èˆ¬å…³é—­æ³¨å†Œè¡Œä¸ºã€‚

ç¬¬äºŒä¸ªæ³¨æ„ç‚¹åœ¨äºå¾ªç¯å¼•ç”¨ï¼ŒKryoä¸ºäº†è¿½æ±‚é«˜æ€§èƒ½ï¼Œå¯ä»¥å…³é—­å¾ªç¯å¼•ç”¨çš„æ”¯æŒã€‚ä¸è¿‡æˆ‘å¹¶ä¸è®¤ä¸ºå…³é—­å®ƒæ˜¯ä¸€ä»¶å¥½çš„é€‰æ‹©ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¯·ä¿æŒ`kryo.setReferences(true)`ã€‚

### å¸¸ç”¨Kryoå·¥å…·ç±»

```Java
public class KryoSerializer {
    public byte[] serialize(Object obj) {
        Kryo kryo = kryoLocal.get();
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        Output output = new Output(byteArrayOutputStream);//<1>
        kryo.writeClassAndObject(output, obj);//<2>
        output.close();
        return byteArrayOutputStream.toByteArray();
    }

    public <T> T deserialize(byte[] bytes) {
        Kryo kryo = kryoLocal.get();
        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);
        Input input = new Input(byteArrayInputStream);// <1>
        input.close();
        return (T) kryo.readClassAndObject(input);//<2>
    }

    private static final ThreadLocal<Kryo> kryoLocal = new ThreadLocal<Kryo>() {//<3>
        @Override
        protected Kryo initialValue() {
            Kryo kryo = new Kryo();
            kryo.setReferences(true);//é»˜è®¤å€¼ä¸ºtrue,å¼ºè°ƒä½œç”¨
            kryo.setRegistrationRequired(false);//é»˜è®¤å€¼ä¸ºfalse,å¼ºè°ƒä½œç”¨
            return kryo;
        }
    };

}
```

`<1>` Kryoçš„Inputå’ŒOutputæ¥æ”¶ä¸€ä¸ªInputStreamå’ŒOutputStreamï¼ŒKryoé€šå¸¸å®Œæˆå­—èŠ‚æ•°ç»„å’Œå¯¹è±¡çš„è½¬æ¢ï¼Œæ‰€ä»¥å¸¸ç”¨çš„è¾“å…¥è¾“å‡ºæµå®ç°ä¸ºByteArrayInputStream/ByteArrayOutputStreamã€‚

`<2>` writeClassAndObjectå’ŒreadClassAndObjecté…å¯¹ä½¿ç”¨åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹æ˜¯æœ€å¸¸è§çš„ï¼Œåºåˆ—åŒ–æ—¶å°†å­—èŠ‚ç å­˜å…¥åºåˆ—åŒ–ç»“æœä¸­ï¼Œä¾¿å¯ä»¥åœ¨ååºåˆ—åŒ–æ—¶ä¸å¿…è¦ä¼ å…¥å­—èŠ‚ç ä¿¡æ¯ã€‚

`<3>` ä½¿ç”¨ThreadLocalç»´æŠ¤Kryoå®ä¾‹ï¼Œè¿™æ ·å‡å°‘äº†æ¯æ¬¡ä½¿ç”¨éƒ½å®ä¾‹åŒ–ä¸€æ¬¡Kryoçš„å¼€é”€åˆå¯ä»¥ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ã€‚

### å‚è€ƒæ–‡ç« 

<https://github.com/EsotericSoftware/kryo>

[Kryo ä½¿ç”¨æŒ‡å—](http://www.cnblogs.com/hntyzgn/p/7122709.html)

[åºåˆ—åŒ–ä¸ååºåˆ—åŒ–](https://kb.cnblogs.com/page/515982/)

------

æ›´å¤šçš„åºåˆ—åŒ–æ–¹æ¡ˆï¼Œå’ŒRPCå…¶ä»–å±‚æ¬¡ä¸­ä¼šæ¶‰åŠåˆ°çš„æŠ€æœ¯ï¼Œåœ¨åç»­çš„æ–‡ç« ä¸­è¿›è¡Œé€æ­¥ä»‹ç»ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ RPC å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)