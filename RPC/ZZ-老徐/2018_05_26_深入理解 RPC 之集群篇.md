title: æ·±å…¥ç†è§£ RPC ä¹‹é›†ç¾¤ç¯‡
date: 2018-05-26
tags:
categories:
permalink: RPC/laoxu/rpc-cluster/
author: è€å¾
from_url: https://www.cnkirito.moe/rpc-cluster/
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484697&idx=1&sn=3c3dfe8677b15e4bfbe07b54a7906452&chksm=fa497aa8cd3ef3be7fd23a7d08f86ce9ba8543d87710615569084435df809389ddea3e214eb1#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnkirito.moe/rpc-cluster/ ã€Œè€å¾ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [é›†ç¾¤æ¦‚è¿°](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)
  - [è´Ÿè½½å‡è¡¡](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)
  - [è´Ÿè½½å‡è¡¡æ¥å£åˆ†æ](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)
  - [å‡ ç§è´Ÿè½½å‡è¡¡ç®—æ³•](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)
  - [é«˜å¯ç”¨ç­–ç•¥](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)
  - [é«˜å¯ç”¨æ¥å£åˆ†æ](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)
  - [å…¶ä»–é›†ç¾¤ç›¸å…³çš„çŸ¥è¯†ç‚¹](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)
  - [å‚è€ƒèµ„æ–™](http://www.iocoder.cn/RPC/laoxu/rpc-cluster//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

ä¸Šä¸€ç¯‡æ–‡ç« åˆ†æäº†æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ï¼Œè¿™ä¸€ç¯‡æ–‡ç« ç€é‡åˆ†æä¸‹ RPC æ¡†æ¶éƒ½ä¼šç”¨åˆ°çš„é›†ç¾¤çš„ç›¸å…³çŸ¥è¯†ã€‚

é›†ç¾¤(Cluster)æœ¬èº«å¹¶ä¸å…·å¤‡å¤ªå¤šçŸ¥è¯†ç‚¹ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé›†ç¾¤ä¸€èˆ¬æ¶µç›–äº†è´Ÿè½½å‡è¡¡ï¼ˆLoadBalanceï¼‰ï¼Œé«˜å¯ç”¨ï¼ˆHAï¼‰ï¼Œè·¯ç”±ï¼ˆRouteï¼‰ç­‰ç­‰æ¦‚å¿µï¼Œæ¯ä¸ª RPC æ¡†æ¶å¯¹é›†ç¾¤æ”¯æŒçš„ç¨‹åº¦ä¸åŒï¼Œæœ¬æ–‡ç€é‡åˆ†æå‰ä¸¤è€…â€“è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ã€‚

##é›†ç¾¤æ¦‚è¿°

åœ¨æ­¤ä¹‹å‰çš„ã€Šæ·±å…¥ç†è§£ RPCã€‹ç³»åˆ—æ–‡ç« ï¼Œå¯¹ RPC çš„åˆ†æç€é‡è¿˜æ˜¯æ”¾åœ¨æœåŠ¡ä¹‹é—´çš„ç‚¹å¯¹ç‚¹è°ƒç”¨ï¼Œè€Œåˆ†å¸ƒå¼æœåŠ¡ä¸­æ¯ä¸ªæœåŠ¡å¿…ç„¶ä¸æ­¢ä¸€ä¸ªå®ä¾‹ï¼Œä¸åŒæœåŠ¡çš„å®ä¾‹å’Œç›¸åŒæœåŠ¡çš„å¤šä¸ªå®ä¾‹æ„æˆäº†ä¸€ä¸ªé”™ç»¼å¤æ‚çš„åˆ†å¸ƒå¼ç¯å¢ƒï¼Œåœ¨æœåŠ¡æ²»ç†æ¡†æ¶ä¸­æ­£æ˜¯å€ŸåŠ©äº† Cluster è¿™ä¸€å±‚æ¥åº”å¯¹è¿™ä¸€éš¾é¢˜ã€‚è¿˜æ˜¯ä»¥åšä¸»è¾ƒä¸ºç†Ÿæ‚‰çš„ motan è¿™ä¸ªæ¡†æ¶æ¥ä»‹ç» Cluster çš„ä½œç”¨ã€‚

å…ˆæ¥çœ‹çœ‹ Cluster çš„é¡¶å±‚æ¥å£ï¼š

```Java
@Spi(scope = Scope.PROTOTYPE)
public interface Cluster<T> extends Caller<T> {
    @Override
    void init();
    void setUrl(URL url);
    void setLoadBalance(LoadBalance<T> loadBalance);//<1>
    void setHaStrategy(HaStrategy<T> haStrategy);//<2>
    void onRefresh(List<Referer<T>> referers);
    List<Referer<T>> getReferers();
    LoadBalance<T> getLoadBalance();
}
```

åœ¨æ¦‚è¿°ä¸­ï¼Œæˆ‘ä»¬åªå…³å¿ƒ Cluster æ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ƒæ­ç¤ºäº† Cluster åœ¨æœåŠ¡æ²»ç†ä¸­çš„åœ°ä½

`<1>` æŒ‡å®šè´Ÿè½½å‡è¡¡ç®—æ³•

`<2>` æŒ‡å®šé«˜å¯ç”¨ç­–ç•¥ï¼ˆå®¹é”™æœºåˆ¶ï¼‰

[![http://kirito.iocoder.cn/TIM%E5%9B%BE%E7%89%8720180227151838.png](http://kirito.iocoder.cn/TIM%E5%9B%BE%E7%89%8720180227151838.png)](http://kirito.iocoder.cn/TIM%E5%9B%BE%E7%89%8720180227151838.png)http://kirito.iocoder.cn/TIM%E5%9B%BE%E7%89%8720180227151838.png

æˆ‘ä»¬éœ€è¦å¯¹æ‰€è°“çš„è´Ÿè½½å‡è¡¡ç­–ç•¥å’Œé«˜å¯ç”¨ç­–ç•¥æœ‰ä¸€å®šçš„ç†è§£ï¼Œæ‰èƒ½å¤Ÿææ¸…æ¥šé›†ç¾¤æ˜¯å¦‚ä½•è¿ä½œçš„ã€‚

## è´Ÿè½½å‡è¡¡

è¯´åˆ°è´Ÿè½½å‡è¡¡ï¼Œå¤§å¤šæ•°äººå¯èƒ½ç«‹åˆ»è”æƒ³åˆ°äº† nginxã€‚è´Ÿè½½å‡è¡¡å¯ä»¥åˆ†ä¸ºæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡å’Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œè€ŒæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡åˆæŒ‰ç…§å®ç°æ–¹å¼çš„ä¸åŒå¯ä»¥åˆ’åˆ†ä¸ºè½¯ä»¶è´Ÿè½½å‡è¡¡å’Œç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼Œnginx ä¾¿æ˜¯å…¸å‹çš„è½¯ä»¶è´Ÿè½½å‡è¡¡ã€‚è€Œæˆ‘ä»¬ä»Šå¤©æ‰€è¦ä»‹ç»çš„ RPC ä¸­çš„è´Ÿè½½å‡è¡¡åˆ™ä¸»è¦æ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ã€‚å¦‚ä½•åŒºåˆ†ä¹Ÿå¾ˆç®€å•ï¼Œç”¨ç¬”è€…è‡ªå·±çš„è¯æ¥æè¿°ä¸‹

> åœ¨ RPC è°ƒç”¨ä¸­ï¼Œå®¢æˆ·ç«¯æŒæœ‰æ‰€æœ‰çš„æœåŠ¡ç«¯èŠ‚ç‚¹å¼•ç”¨ï¼Œè‡ªè¡Œé€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè®¿é—®ï¼Œè¿™ä¾¿æ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ã€‚

å®¢æˆ·ç«¯å¦‚ä½•è·å–åˆ°æ‰€æœ‰çš„æœåŠ¡ç«¯èŠ‚ç‚¹å¼•ç”¨å‘¢ï¼Ÿä¸€èˆ¬æ˜¯é€šè¿‡é…ç½®çš„æ–¹å¼ï¼Œæˆ–è€…æ˜¯ä»ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ç»„ä»¶ä¸­è·å–ã€‚

## è´Ÿè½½å‡è¡¡æ¥å£åˆ†æ

motan ä¸­çš„è´Ÿè½½å‡è¡¡æŠ½è±¡ï¼š

```Java
@Spi(scope = Scope.PROTOTYPE)
public interface LoadBalance<T> {
    void onRefresh(List<Referer<T>> referers);
    Referer<T> select(Request request);//<1>
    void selectToHolder(Request request, List<Referer<T>> refersHolder);
    void setWeightString(String weightString);
}
```

ribbon ä¸­çš„è´Ÿè½½å‡è¡¡æŠ½è±¡ï¼š

```Java
public interface IRule{
    public Server choose(Object key);//<1>
    public void setLoadBalancer(ILoadBalancer lb);
    public ILoadBalancer getLoadBalancer();
}
```

`<1>` å¯¹æ¯”ä¸‹ä¸¤ä¸ª RPC æ¡†æ¶å¯¹è´Ÿè½½å‡è¡¡çš„æŠ½è±¡å¯ä»¥å‘ç°ï¼Œå…¶å®è´Ÿè½½å‡è¡¡ç­–ç•¥å¹²çš„äº‹å¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ®è¯·æ±‚è¿”å›ä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ã€‚åœ¨ motan ä¸­å¯¹æœåŠ¡ç«¯çš„ç‚¹å¯¹ç‚¹è°ƒç”¨æŠ½è±¡æˆäº† Refererï¼Œè€Œåœ¨ ribbon ä¸­åˆ™æ˜¯ Serverã€‚

## å‡ ç§è´Ÿè½½å‡è¡¡ç®—æ³•

è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å‡ ç§ç»å…¸å®ç°ï¼Œå·²ç»æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œæ€»ç»“åä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š

1. è½®è¯¢ï¼ˆRound Robinï¼‰
2. åŠ æƒè½®è¯¢ï¼ˆWeight Round Robinï¼‰
3. éšæœºï¼ˆRandomï¼‰
4. åŠ æƒéšæœºï¼ˆWeight Randomï¼‰
5. æºåœ°å€å“ˆå¸Œï¼ˆHashï¼‰
6. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistentHashï¼‰
7. æœ€å°è¿æ¥æ•°ï¼ˆLeast Connectionsï¼‰
8. ä½å¹¶å‘ä¼˜å…ˆï¼ˆActive Weightï¼‰

æ¯ä¸ªæ¡†æ¶æ”¯æŒçš„å®ç°éƒ½ä¸å¤ªä¸€æ ·ï¼Œå¦‚ **ribbon æ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥**ï¼š

| ç­–ç•¥å                    | ç­–ç•¥æè¿°                                                     | å®ç°è¯´æ˜                                                     |
| ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| BestAvailableRule         | é€‰æ‹©ä¸€ä¸ªæœ€å°å¹¶å‘è¯·æ±‚çš„ server                                | é€ä¸ªè€ƒå¯Ÿ Serverï¼Œå¦‚æœ Server è¢« tripped äº†ï¼Œåˆ™å¿½ç•¥ï¼Œåœ¨é€‰æ‹©å…¶ä¸­ ActiveRequestsCount æœ€å°çš„ server |
| AvailabilityFilteringRule | è¿‡æ»¤æ‰é‚£äº›å› ä¸ºä¸€ç›´è¿æ¥å¤±è´¥çš„è¢«æ ‡è®°ä¸º circuit tripped çš„åç«¯ serverï¼Œå¹¶è¿‡æ»¤æ‰é‚£äº›é«˜å¹¶å‘çš„çš„åç«¯ serverï¼ˆactive connections è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼‰ | ä½¿ç”¨ä¸€ä¸ª AvailabilityPredicate æ¥åŒ…å«è¿‡æ»¤ server çš„é€»è¾‘ï¼Œå…¶å®å°±å°±æ˜¯æ£€æŸ¥ status é‡Œè®°å½•çš„å„ä¸ª server çš„è¿è¡ŒçŠ¶æ€ |
| WeightedResponseTimeRule  | æ ¹æ®å“åº”æ—¶é—´åˆ†é…ä¸€ä¸ª weightï¼Œå“åº”æ—¶é—´è¶Šé•¿ï¼Œweight è¶Šå°ï¼Œè¢«é€‰ä¸­çš„å¯èƒ½æ€§è¶Šä½ã€‚ | ä¸€ä¸ªåå°çº¿ç¨‹å®šæœŸçš„ä» status é‡Œé¢è¯»å–è¯„ä»·å“åº”æ—¶é—´ï¼Œä¸ºæ¯ä¸ª server è®¡ç®—ä¸€ä¸ª weightã€‚Weight çš„è®¡ç®—ä¹Ÿæ¯”è¾ƒç®€å• responsetime å‡å»æ¯ä¸ª server è‡ªå·±å¹³å‡çš„ responsetime æ˜¯ server çš„æƒé‡ã€‚å½“åˆšå¼€å§‹è¿è¡Œï¼Œæ²¡æœ‰å½¢æˆ status æ—¶ï¼Œä½¿ç”¨ RoundRobinRule ç­–ç•¥é€‰æ‹© serverã€‚ |
| RetryRule                 | å¯¹é€‰å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœºä¸Šé‡è¯•æœºåˆ¶ã€‚                           | åœ¨ä¸€ä¸ªé…ç½®æ—¶é—´æ®µå†…å½“é€‰æ‹© server ä¸æˆåŠŸï¼Œåˆ™ä¸€ç›´å°è¯•ä½¿ç”¨ subRule çš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„server |
| RoundRobinRule            | roundRobin æ–¹å¼è½®è¯¢é€‰æ‹© server                               | è½®è¯¢ indexï¼Œé€‰æ‹© index å¯¹åº”ä½ç½®çš„ server                     |
| RandomRule                | éšæœºé€‰æ‹©ä¸€ä¸ª server                                          | åœ¨ index ä¸Šéšæœºï¼Œé€‰æ‹© index å¯¹åº”ä½ç½®çš„ server                |
| ZoneAvoidanceRule         | å¤åˆåˆ¤æ–­ server æ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œ server çš„å¯ç”¨æ€§é€‰æ‹© server  | ä½¿ç”¨ ZoneAvoidancePredicate å’Œ AvailabilityPredicate æ¥åˆ¤æ–­æ˜¯å¦é€‰æ‹©æŸä¸ªserverï¼Œå‰ä¸€ä¸ªåˆ¤æ–­åˆ¤å®šä¸€ä¸ª zone çš„è¿è¡Œæ€§èƒ½æ˜¯å¦å¯ç”¨ï¼Œå‰”é™¤ä¸å¯ç”¨çš„ zoneï¼ˆçš„æ‰€æœ‰ serverï¼‰ï¼ŒAvailabilityPredicate ç”¨äºè¿‡æ»¤æ‰è¿æ¥æ•°è¿‡å¤šçš„ Serverã€‚ |

**motan æ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥**ï¼š

| ç­–ç•¥å             | ç­–ç•¥æè¿°                                                     |
| ------------------ | ------------------------------------------------------------ |
| Random             | éšæœºé€‰æ‹©ä¸€ä¸ª server                                          |
| RoundRobin         | roundRobin æ–¹å¼è½®è¯¢é€‰æ‹© server                               |
| ConsistentHash     | ä¸€è‡´æ€§ Hashï¼Œä¿è¯åŒä¸€æºåœ°å€çš„è¯·æ±‚è½åˆ°åŒä¸€ä¸ªæœåŠ¡ç«¯ï¼Œèƒ½å¤Ÿåº”å¯¹æœåŠ¡ç«¯æœºå™¨çš„åŠ¨æ€ä¸Šä¸‹çº¿(å®é™…ä¸Šå¹¶æ²¡æœ‰ä¸¥æ ¼åšåˆ°ä¸€è‡´æ€§ hashï¼Œmotan çš„å®ç°åªèƒ½æ»¡è¶³ç²˜æ» hashï¼Œåªä¿è¯ server èŠ‚ç‚¹å˜æ›´å‘¨æœŸå†…ç›¸åŒå¯¹è¯·æ±‚è½åœ¨ç›¸åŒçš„ server ä¸Šï¼Œæ¯”è¾ƒé€‚åˆç”¨åœ¨äºŒçº§ç¼“å­˜åœºæ™¯) |
| LocalFirst         | å½“ server åˆ—è¡¨ä¸­åŒ…å«æœ¬åœ°æš´éœ²çš„å¯ç”¨æœåŠ¡æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨æ­¤æœåŠ¡ã€‚å¦åˆ™ä½¿ç”¨ä½å¹¶å‘ä¼˜å…ˆ ActiveWeight è´Ÿè½½å‡è¡¡ç­–ç•¥ |
| ActiveWeight       | å¹¶å‘é‡è¶Šå°çš„ serverï¼Œä¼˜å…ˆçº§è¶Šé«˜                              |
| ConfigurableWeight | åŠ æƒéšæœº                                                     |

ç®—æ³•å¾ˆå¤šï¼Œæœ‰äº›è´Ÿè½½å‡è¡¡ç®—æ³•çš„å®ç°å¤æ‚åº¦ä¹Ÿå¾ˆé«˜ï¼Œè¯·æ•™äº†ä¸€äº›æœ‹å‹ï¼Œå‘ç°ç”¨çš„æœ€å¤šè¿˜æ˜¯ RoundRobinï¼ŒRandom è¿™ä¸¤ç§ã€‚å¯èƒ½å’Œä»–ä»¬å®ç°èµ·æ¥å¾ˆç®€å•æœ‰å…³ï¼Œå¾ˆå¤šè¿ç”¨åˆ° RPC æ¡†æ¶çš„é¡¹ç›®ä¹Ÿéƒ½æ˜¯ä¿æŒäº†é»˜è®¤é…ç½®ã€‚

è€Œè¿™ä¸¤ç§ç»å…¸å¤æ‚å‡è¡¡ç®—æ³•å®ç°èµ·æ¥æ˜¯å¾ˆç®€å•çš„ï¼Œåœ¨æ­¤ç»™å‡ºç½‘ä¸Šçš„ç®€æ˜“å®ç°ï¼Œæ–¹ä¾¿å¤§å®¶æ›´ç›´è§‚çš„äº†è§£ã€‚

**æœåŠ¡åˆ—è¡¨**

```Java
public class IpMap
{
    // å¾…è·¯ç”±çš„Ipåˆ—è¡¨ï¼ŒKeyä»£è¡¨Ipï¼ŒValueä»£è¡¨è¯¥Ipçš„æƒé‡
    public static HashMap<String, Integer> serverWeightMap =
            new HashMap<String, Integer>();
    static
    {
        serverWeightMap.put("192.168.1.100", 1);
        serverWeightMap.put("192.168.1.101", 1);
        // æƒé‡ä¸º4
        serverWeightMap.put("192.168.1.102", 4);
        serverWeightMap.put("192.168.1.103", 1);
        serverWeightMap.put("192.168.1.104", 1);
        // æƒé‡ä¸º3
        serverWeightMap.put("192.168.1.105", 3);
        serverWeightMap.put("192.168.1.106", 1);
        // æƒé‡ä¸º2
        serverWeightMap.put("192.168.1.107", 2);
        serverWeightMap.put("192.168.1.108", 1);
        serverWeightMap.put("192.168.1.109", 1);
        serverWeightMap.put("192.168.1.110", 1);
    }
}
```

**è½®è¯¢ï¼ˆRound Robinï¼‰**

```Java
public class RoundRobin
{
    private static Integer pos = 0;

    public static String getServer()
    {
        // é‡å»ºä¸€ä¸ªMapï¼Œé¿å…æœåŠ¡å™¨çš„ä¸Šä¸‹çº¿å¯¼è‡´çš„å¹¶å‘é—®é¢˜
        Map<String, Integer> serverMap =
                new HashMap<String, Integer>();
        serverMap.putAll(IpMap.serverWeightMap);

        // å–å¾—Ipåœ°å€List
        Set<String> keySet = serverMap.keySet();
        ArrayList<String> keyList = new ArrayList<String>();
        keyList.addAll(keySet);

        String server = null;
        synchronized (pos)
        {
            if (pos > keySet.size())
                pos = 0;
            server = keyList.get(pos);
            pos ++;
        }

        return server;
    }
}
```

**éšæœºï¼ˆRandomï¼‰**

```Java
public class Random
{
    public static String getServer()
    {
        // é‡å»ºä¸€ä¸ªMapï¼Œé¿å…æœåŠ¡å™¨çš„ä¸Šä¸‹çº¿å¯¼è‡´çš„å¹¶å‘é—®é¢˜
        Map<String, Integer> serverMap =
                new HashMap<String, Integer>();
        serverMap.putAll(IpMap.serverWeightMap);

        // å–å¾—Ipåœ°å€List
        Set<String> keySet = serverMap.keySet();
        ArrayList<String> keyList = new ArrayList<String>();
        keyList.addAll(keySet);

        java.util.Random random = new java.util.Random();
        int randomPos = random.nextInt(keyList.size());

        return keyList.get(randomPos);
    }
}
```

## é«˜å¯ç”¨ç­–ç•¥

é«˜å¯ç”¨ï¼ˆHAï¼‰ç­–ç•¥ä¸€èˆ¬ä¹Ÿè¢«ç§°ä½œå®¹é”™æœºåˆ¶ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å‡ºé”™æ˜¯å¸¸æ€ï¼Œä½†æœåŠ¡å´ä¸èƒ½åœæ­¢å“åº”ï¼Œ6ä¸ª9ä¸€ç›´æ˜¯å„ä¸ªå…¬å¸çš„åŠªåŠ›æ–¹å‘ã€‚å½“ä¸€æ¬¡è¯·æ±‚å¤±è´¥ä¹‹åï¼Œæ˜¯é‡è¯•å‘¢ï¼Ÿè¿˜æ˜¯ç»§ç»­è¯·æ±‚å…¶ä»–æœºå™¨ï¼ŸæŠ‘æˆ–æ˜¯è®°å½•ä¸‹è¿™æ¬¡å¤±è´¥ï¼Ÿä¸‹é¢æ˜¯é›†ç¾¤ä¸­çš„å‡ ç§å¸¸ç”¨é«˜å¯ç”¨ç­–ç•¥ï¼š

1. å¤±æ•ˆè½¬ç§»ï¼ˆfailoverï¼‰

   å½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶ä»–æœåŠ¡å™¨ï¼Œé€šå¸¸ç”¨äºè¯»æ“ä½œç­‰å¹‚ç­‰è¡Œä¸ºï¼Œé‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚è¯¥é«˜å¯ç”¨ç­–ç•¥ä¼šå—åˆ°è´Ÿè½½å‡è¡¡ç®—æ³•çš„é™åˆ¶ï¼Œæ¯”å¦‚å¤±æ•ˆè½¬ç§»å¼ºè°ƒéœ€è¦é‡è¯•å…¶ä»–æœºå™¨ï¼Œä½†ä¸€è‡´æ€§ Hash è¿™ç±»è´Ÿè½½å‡è¡¡ç®—æ³•ä¾¿ä¼šä¸å…¶å­˜åœ¨å†²çªï¼ˆä¸ªäººè®¤ä¸ºä¸€è‡´æ€§ Hash åœ¨ RPC çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ä¸­æ„ä¹‰ä¸æ˜¯å¾ˆå¤§ï¼‰

2. å¿«é€Ÿå¤±è´¥ï¼ˆfailfastï¼‰

   åªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥ç«‹å³æŠ¥é”™ï¼Œé€šå¸¸ç”¨äºéå¹‚ç­‰æ€§çš„å†™æ“ä½œã€‚

   å¦‚æœåœ¨ motanï¼Œdubbo ç­‰é…ç½®ä¸­è®¾ç½®äº†é‡è¯•æ¬¡æ•°>0ï¼Œåˆé…ç½®äº†è¯¥é«˜å¯ç”¨ç­–ç•¥ï¼Œåˆ™é‡è¯•æ•ˆæœä¹Ÿä¸ä¼šç”Ÿæ•ˆï¼Œç”±æ­¤å¯è§é›†ç¾¤ä¸­çš„å„ä¸ªé…ç½®å¯èƒ½æ˜¯ä¼šç›¸äº’å½±å“çš„ã€‚

3. å¤±æ•ˆå®‰å…¨ï¼ˆfailsafeï¼‰

   å‡ºç°å¼‚å¸¸æ—¶å¿½ç•¥ï¼Œä½†è®°å½•è¿™ä¸€æ¬¡å¤±è´¥ï¼Œå­˜å…¥æ—¥å¿—ä¸­ã€‚

4. å¤±æ•ˆè‡ªåŠ¨æ¢å¤ï¼ˆfailbackï¼‰

   åå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œã€‚

5. å¹¶è¡Œè°ƒç”¨ï¼ˆforkingï¼‰

   åªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ï¼Œé€šå¸¸ç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œã€‚éœ€è¦ç‰ºç‰²ä¸€å®šçš„æœåŠ¡èµ„æºã€‚

6. å¹¿æ’­ï¼ˆbroadcastï¼‰

   å¹¿æ’­è°ƒç”¨ï¼Œæ‰€æœ‰æä¾›é€ä¸ªè°ƒç”¨ï¼Œä»»æ„ä¸€å°æŠ¥é”™åˆ™æŠ¥é”™ã€‚é€šå¸¸ç”¨äºæ›´æ–°æä¾›æ–¹æœ¬åœ°çŠ¶æ€ï¼Œé€Ÿåº¦æ…¢ï¼Œä»»æ„ä¸€å°æŠ¥é”™åˆ™æŠ¥é”™ã€‚

## é«˜å¯ç”¨æ¥å£åˆ†æ

ä»¥ motan çš„ HaStrategy ä¸ºä¾‹æ¥ä»‹ç»é«˜å¯ç”¨åœ¨é›†ç¾¤ä¸­çš„å®ç°ç»†èŠ‚

```Java
@Spi(scope = Scope.PROTOTYPE)
public interface HaStrategy<T> {
    void setUrl(URL url);
    Response call(Request request, LoadBalance<T> loadBalance);//<1>
}
```

`<1>` å¦‚æˆ‘ä¹‹å‰æ‰€è¿°ï¼Œé«˜å¯ç”¨ç­–ç•¥ä¾èµ–äºè¯·æ±‚å’Œä¸€ä¸ªç‰¹å®šçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œè¿”å›ä¸€ä¸ªå“åº”ã€‚

**å¿«é€Ÿå¤±è´¥ï¼ˆfailfastï¼‰**

```Java
@SpiMeta(name = "failfast")
public class FailfastHaStrategy<T> extends AbstractHaStrategy<T> {

    @Override
    public Response call(Request request, LoadBalance<T> loadBalance) {
        Referer<T> refer = loadBalance.select(request);
        return refer.call(request);
    }
}
```

motan å®ç°äº†ä¸¤ä¸ªé«˜å¯ç”¨ç­–ç•¥ï¼Œå…¶ä¸€ä¾¿æ˜¯ failfastï¼Œéå¸¸ç®€å•ï¼Œåªè¿›è¡Œä¸€æ¬¡è´Ÿè½½å‡è¡¡èŠ‚ç‚¹çš„é€‰å–ï¼Œæ¥ç€å‘èµ·ç‚¹å¯¹ç‚¹çš„è°ƒç”¨ã€‚

**å¤±æ•ˆè½¬ç§»ï¼ˆfailoverï¼‰**

```Java
@SpiMeta(name = "failover")
public class FailoverHaStrategy<T> extends AbstractHaStrategy<T> {

    protected ThreadLocal<List<Referer<T>>> referersHolder = new ThreadLocal<List<Referer<T>>>() {
        @Override
        protected java.util.List<com.weibo.api.motan.rpc.Referer<T>> initialValue() {
            return new ArrayList<Referer<T>>();
        }
    };

    @Override
    public Response call(Request request, LoadBalance<T> loadBalance) {

        List<Referer<T>> referers = selectReferers(request, loadBalance);
        if (referers.isEmpty()) {
            throw new MotanServiceException(String.format("FailoverHaStrategy No referers for request:%s, loadbalance:%s", request,
                    loadBalance));
        }
        URL refUrl = referers.get(0).getUrl();
        // å…ˆä½¿ç”¨methodçš„é…ç½®
        int tryCount =
                refUrl.getMethodParameter(request.getMethodName(), request.getParamtersDesc(), URLParamType.retries.getName(),
                        URLParamType.retries.getIntValue());
        // å¦‚æœæœ‰é—®é¢˜ï¼Œåˆ™è®¾ç½®ä¸ºä¸é‡è¯•
        if (tryCount < 0) {
            tryCount = 0;
        }
	   // åªæœ‰ failover ç­–ç•¥æ‰ä¼šæœ‰é‡è¯•
        for (int i = 0; i <= tryCount; i++) {
            Referer<T> refer = referers.get(i % referers.size());
            try {
                request.setRetries(i);
                return refer.call(request);
            } catch (RuntimeException e) {
                // å¯¹äºä¸šåŠ¡å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
                if (ExceptionUtil.isBizException(e)) {
                    throw e;
                } else if (i >= tryCount) {
                    throw e;
                }
                LoggerUtil.warn(String.format("FailoverHaStrategy Call false for request:%s error=%s", request, e.getMessage()));
            }
        }

        throw new MotanFrameworkException("FailoverHaStrategy.call should not come here!");
    }

    protected List<Referer<T>> selectReferers(Request request, LoadBalance<T> loadBalance) {
        List<Referer<T>> referers = referersHolder.get();
        referers.clear();
        loadBalance.selectToHolder(request, referers);
        return referers;
    }

}
```

å…¶äºŒçš„é«˜å¯ç”¨ç­–ç•¥æ˜¯ failoverï¼Œå®ç°ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œå®¹å¿åœ¨é‡è¯•æ¬¡æ•°å†…çš„å¤±è´¥è°ƒç”¨ã€‚è¿™ä¹Ÿæ˜¯ motan æä¾›çš„é»˜è®¤ç­–ç•¥ã€‚

## å…¶ä»–é›†ç¾¤ç›¸å…³çš„çŸ¥è¯†ç‚¹

åœ¨ Dubbo ä¸­ä¹Ÿæœ‰ cluster è¿™ä¸€åˆ†å±‚ï¼Œé™¤äº† loadbalance å’Œ ha è¿™ä¸¤å±‚ä¹‹å¤–è¿˜åŒ…å«äº†è·¯ç”±ï¼ˆRouterï¼‰ç”¨æ¥åšè¯»å†™åˆ†ç¦»ï¼Œåº”ç”¨éš”ç¦»ï¼›åˆå¹¶ç»“æœï¼ˆMergerï¼‰ç”¨æ¥åšå“åº”ç»“æœçš„åˆ†ç»„èšåˆã€‚

åœ¨ SpringCloud-Netflix ä¸­æ•´åˆäº† Zuul æ¥åšæœåŠ¡ç«¯çš„è´Ÿè½½å‡è¡¡

## å‚è€ƒèµ„æ–™

1. [å‡ ç§ç®€å•çš„è´Ÿè½½å‡è¡¡ç®—æ³•åŠå…¶Javaä»£ç å®ç°](http://www.cnblogs.com/xrq730/p/5154340.html)
2. [æœç´¢ä¸šåŠ¡å’ŒæŠ€æœ¯ä»‹ç»åŠå®¹é”™æœºåˆ¶](https://www.cnblogs.com/xiexj/p/7071939.html)

# 666. å½©è›‹

å¦‚æœä½ å¯¹ RPC å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)