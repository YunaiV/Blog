title: ç®€å•äº†è§£ RPC å®ç°åŸç†
date: 2018-05-18
tags:
categories:
permalink: RPC/laoxu/easy-know-rpc/
author: è€å¾
from_url: https://www.cnkirito.moe/easy-know-rpc/
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484428&idx=1&sn=fd62058327384aa2a90b98a04b447451&chksm=fa497bbdcd3ef2abd9603a2ff16d96fbcb1eccb8a51c73a3e08650dd4fdda2f77cd157903674#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnkirito.moe/easy-know-rpc/ ã€Œè€å¾ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [æ ¸å¿ƒæ¡†æ¶ç±»](http://www.iocoder.cn/RPC/laoxu/easy-know-rpc//)
  - [å®šä¹‰æœåŠ¡æ¥å£](http://www.iocoder.cn/RPC/laoxu/easy-know-rpc//)
  - [å®ç°æœåŠ¡](http://www.iocoder.cn/RPC/laoxu/easy-know-rpc//)
  - [æš´éœ²æœåŠ¡](http://www.iocoder.cn/RPC/laoxu/easy-know-rpc//)
  - [å¼•ç”¨æœåŠ¡](http://www.iocoder.cn/RPC/laoxu/easy-know-rpc//)
  - [æ€»ç»“](http://www.iocoder.cn/RPC/laoxu/easy-know-rpc//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

æ—¶ä¸‹å¾ˆå¤šä¼ä¸šåº”ç”¨æ›´æ–°æ¢ä»£åˆ°åˆ†å¸ƒå¼ï¼Œä¸€ç¯‡æ–‡ç« äº†è§£ä»€ä¹ˆæ˜¯RPCã€‚
åŸä½œè€…æ¢é£ï¼Œåœ¨æ­¤è®°å½•ä¸‹ä»–éå¸¸ç®€æ´çš„rpcå®ç°æ€è·¯ã€‚

## æ ¸å¿ƒæ¡†æ¶ç±»

```Java
/*
 * Copyright 2011 Alibaba.com All right reserved. This software is the
 * confidential and proprietary information of Alibaba.com ("Confidential
 * Information"). You shall not disclose such Confidential Information and shall
 * use it only in accordance with the terms of the license agreement you entered
 * into with Alibaba.com.
 */
package com.alibaba.study.rpc.framework;

import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.net.ServerSocket;
import java.net.Socket;

/**
 * RpcFramework
 *
 * @author william.liangf
 */
public class RpcFramework {

    /**
     * æš´éœ²æœåŠ¡
     *
     * @param service æœåŠ¡å®ç°
     * @param port æœåŠ¡ç«¯å£
     * @throws Exception
     */
    public static void export(final Object service, int port) throws Exception {
        if (service == null)
            throw new IllegalArgumentException("service instance == null");
        if (port <= 0 || port > 65535)
            throw new IllegalArgumentException("Invalid port " + port);
        System.out.println("Export service " + service.getClass().getName() + " on port " + port);
        ServerSocket server = new ServerSocket(port);
        for(;;) {
            try {
                final Socket socket = server.accept();
                new Thread(new Runnable() {
                    @Override
                    public void run() {
                        try {
                            try {
                                ObjectInputStream input = new ObjectInputStream(socket.getInputStream());
                                try {
                                    String methodName = input.readUTF();
                                    Class<?>[] parameterTypes = (Class<?>[])input.readObject();
                                    Object[] arguments = (Object[])input.readObject();
                                    ObjectOutputStream output = new ObjectOutputStream(socket.getOutputStream());
                                    try {
                                        Method method = service.getClass().getMethod(methodName, parameterTypes);
                                        Object result = method.invoke(service, arguments);
                                        output.writeObject(result);
                                    } catch (Throwable t) {
                                        output.writeObject(t);
                                    } finally {
                                        output.close();
                                    }
                                } finally {
                                    input.close();
                                }
                            } finally {
                                socket.close();
                            }
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                }).start();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    /**
     * å¼•ç”¨æœåŠ¡
     *
     * @param <T> æ¥å£æ³›å‹
     * @param interfaceClass æ¥å£ç±»å‹
     * @param host æœåŠ¡å™¨ä¸»æœºå
     * @param port æœåŠ¡å™¨ç«¯å£
     * @return è¿œç¨‹æœåŠ¡
     * @throws Exception
     */
    @SuppressWarnings("unchecked")
    public static <T> T refer(final Class<T> interfaceClass, final String host, final int port) throws Exception {
        if (interfaceClass == null)
            throw new IllegalArgumentException("Interface class == null");
        if (! interfaceClass.isInterface())
            throw new IllegalArgumentException("The " + interfaceClass.getName() + " must be interface class!");
        if (host == null || host.length() == 0)
            throw new IllegalArgumentException("Host == null!");
        if (port <= 0 || port > 65535)
            throw new IllegalArgumentException("Invalid port " + port);
        System.out.println("Get remote service " + interfaceClass.getName() + " from server " + host + ":" + port);
        return (T) Proxy.newProxyInstance(interfaceClass.getClassLoader(), new Class<?>[] {interfaceClass}, new InvocationHandler() {
            public Object invoke(Object proxy, Method method, Object[] arguments) throws Throwable {
                Socket socket = new Socket(host, port);
                try {
                    ObjectOutputStream output = new ObjectOutputStream(socket.getOutputStream());
                    try {
                        output.writeUTF(method.getName());
                        output.writeObject(method.getParameterTypes());
                        output.writeObject(arguments);
                        ObjectInputStream input = new ObjectInputStream(socket.getInputStream());
                        try {
                            Object result = input.readObject();
                            if (result instanceof Throwable) {
                                throw (Throwable) result;
                            }
                            return result;
                        } finally {
                            input.close();
                        }
                    } finally {
                        output.close();
                    }
                } finally {
                    socket.close();
                }
            }
        });
    }

}
```

## å®šä¹‰æœåŠ¡æ¥å£

```Java
/*
 * Copyright 2011 Alibaba.com All right reserved. This software is the
 * confidential and proprietary information of Alibaba.com ("Confidential
 * Information"). You shall not disclose such Confidential Information and shall
 * use it only in accordance with the terms of the license agreement you entered
 * into with Alibaba.com.
 */
package com.alibaba.study.rpc.test;

/**
 * HelloService
 *
 * @author william.liangf
 */
public interface HelloService {

    String hello(String name);

}
```

## å®ç°æœåŠ¡

```Java
/*
 * Copyright 2011 Alibaba.com All right reserved. This software is the
 * confidential and proprietary information of Alibaba.com ("Confidential
 * Information"). You shall not disclose such Confidential Information and shall
 * use it only in accordance with the terms of the license agreement you entered
 * into with Alibaba.com.
 */
package com.alibaba.study.rpc.test;

/**
 * HelloServiceImpl
 *
 * @author william.liangf
 */
public class HelloServiceImpl implements HelloService {

    public String hello(String name) {
        return "Hello " + name;
    }

}
```

## æš´éœ²æœåŠ¡

```Java
/*
 * Copyright 2011 Alibaba.com All right reserved. This software is the
 * confidential and proprietary information of Alibaba.com ("Confidential
 * Information"). You shall not disclose such Confidential Information and shall
 * use it only in accordance with the terms of the license agreement you entered
 * into with Alibaba.com.
 */
package com.alibaba.study.rpc.test;

import com.alibaba.study.rpc.framework.RpcFramework;

/**
 * RpcProvider
 *
 * @author william.liangf
 */
public class RpcProvider {

    public static void main(String[] args) throws Exception {
        HelloService service = new HelloServiceImpl();
        RpcFramework.export(service, 1234);
    }

}
```

## å¼•ç”¨æœåŠ¡

```Java
/*
 * Copyright 2011 Alibaba.com All right reserved. This software is the
 * confidential and proprietary information of Alibaba.com ("Confidential
 * Information"). You shall not disclose such Confidential Information and shall
 * use it only in accordance with the terms of the license agreement you entered
 * into with Alibaba.com.
 */
package com.alibaba.study.rpc.test;

import com.alibaba.study.rpc.framework.RpcFramework;

/**
 * RpcConsumer
 *
 * @author william.liangf
 */
public class RpcConsumer {

    public static void main(String[] args) throws Exception {
        HelloService service = RpcFramework.refer(HelloService.class, "127.0.0.1", 1234);
        for (int i = 0; i < Integer.MAX_VALUE; i ++) {
            String hello = service.hello("World" + i);
            System.out.println(hello);
            Thread.sleep(1000);
        }
    }

}
```

## æ€»ç»“

è¿™ä¸ªç®€å•çš„ä¾‹å­çš„å®ç°æ€è·¯æ˜¯ä½¿ç”¨é˜»å¡çš„socket IOæµæ¥è¿›è¡Œserverå’Œclientçš„é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯rpcåº”ç”¨ä¸­æœåŠ¡æä¾›æ–¹å’ŒæœåŠ¡æ¶ˆè´¹æ–¹ã€‚å¹¶ä¸”æ˜¯ç«¯å¯¹ç«¯çš„ï¼Œç”¨ç«¯å£å·æ¥ç›´æ¥è¿›è¡Œé€šä¿¡ã€‚æ–¹æ³•çš„è¿œç¨‹è°ƒç”¨ä½¿ç”¨çš„æ˜¯jdkçš„åŠ¨æ€ä»£ç†ï¼Œå‚æ•°çš„åºåˆ—åŒ–ä¹Ÿæ˜¯ä½¿ç”¨çš„æœ€ç®€å•çš„objectStreamã€‚

çœŸå®çš„rpcæ¡†æ¶ä¼šå¯¹ä¸Šé¢çš„å®ç°æ–¹å¼è¿›è¡Œæ›¿æ¢ï¼Œé‡‡ç”¨æ›´å¿«æ›´ç¨³å®šï¼Œæ›´é«˜å¯ç”¨æ˜“æ‰©å±•ï¼Œæ›´é€‚å®œåˆ†å¸ƒå¼åœºæ™¯çš„ä¸­é—´ä»¶ï¼ŒæŠ€æœ¯æ¥æ›¿æ¢ã€‚ä¾‹å¦‚ä½¿ç”¨nettyçš„nioç‰¹æ€§è¾¾åˆ°éé˜»å¡çš„é€šä¿¡ï¼Œä½¿ç”¨zookeeperç»Ÿä¸€ç®¡ç†æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Œè§£å†³äº†ç«¯å¯¹ç«¯ä¸çµæ´»çš„åŠ£åŠ¿ã€‚ä»£ç†æ–¹å¼æœ‰cglibå­—èŠ‚ç æŠ€æœ¯ã€‚åºåˆ—åŒ–æ–¹å¼æœ‰hession2ï¼Œfastjsonç­‰ç­‰ã€‚ä¸è¿‡æ¢é£å¤§å¤§çš„åšå®¢ä½¿ç”¨åŸç”Ÿçš„jdk apiå°±å±•ç°ç»™å„ä½è¯»è€…ä¸€ä¸ªç”ŸåŠ¨å½¢è±¡çš„rpc demoï¼Œå®åœ¨æ˜¯å¼ºã€‚rpcæ¡†æ¶è§£å†³çš„ä¸ä»…ä»…æ˜¯æŠ€æœ¯å±‚é¢çš„å®ç°ï¼Œè¿˜è€ƒè™‘åˆ°äº†rpcè°ƒç”¨ä¸­çš„è¯¸å¤šé—®é¢˜ï¼Œé‡è¯•æœºåˆ¶ï¼Œè¶…æ—¶é…ç½®â€¦è¿™äº›å°±éœ€è¦å»äº†è§£æˆç†Ÿçš„rpcæ¡†æ¶æ˜¯å¦‚æœè€ƒè™‘è¿™äº›é—®é¢˜çš„äº†ã€‚

æ¨èä¸€ä¸ªè½»é‡çº§çš„rpcæ¡†æ¶ï¼šmotanã€‚weiboå›¢é˜Ÿåœ¨githubå¼€æºçš„ä¸€ä¸ªrpcæ¡†æ¶ï¼Œæœ‰ç›¸åº”çš„æ–‡æ¡£ï¼Œç”¨èµ·æ¥æ„Ÿè§‰æ¯”dubboè¦è½»é‡çº§ï¼Œæ˜“ä¸Šæ‰‹ã€‚

# 666. å½©è›‹

å¦‚æœä½ å¯¹ RPC å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)