title: æ·±å…¥ç†è§£ RPC ä¹‹åŠ¨æ€ä»£ç†ç¯‡
date: 2018-05-21
tags:
categories:
permalink: RPC/laoxu/rpc-dynamic-proxy/
author: è€å¾
from_url: https://www.cnkirito.moe/rpc-dynamic-proxy/
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484541&idx=1&sn=d5b3415ffb63652de284104aacc6a156&chksm=fa497bcccd3ef2dae4c705c8735e2453693cfb3db6c5b458e37723c2070a73eae00645205666#rd

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://www.cnkirito.moe/rpc-dynamic-proxy/ ã€Œè€å¾ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

  - [RpcRequest å’Œ RpcResponse](http://www.iocoder.cn/RPC/laoxu/rpc-dynamic-proxy//)
  - [Socketä¼ è¾“](http://www.iocoder.cn/RPC/laoxu/rpc-dynamic-proxy//)
  - [Netty ä¼ è¾“](http://www.iocoder.cn/RPC/laoxu/rpc-dynamic-proxy//)
  - [åŒæ­¥ä¸å¼‚æ­¥ é˜»å¡ä¸éé˜»å¡](http://www.iocoder.cn/RPC/laoxu/rpc-dynamic-proxy//)
  - [æ€»ç»“](http://www.iocoder.cn/RPC/laoxu/rpc-dynamic-proxy//)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

æåˆ° JAVA ä¸­çš„åŠ¨æ€ä»£ç†ï¼Œå¤§å¤šæ•°äººéƒ½ä¸ä¼šå¯¹ JDK åŠ¨æ€ä»£ç†æ„Ÿåˆ°é™Œç”Ÿï¼ŒProxyï¼ŒInvocationHandler ç­‰ç±»éƒ½æ˜¯ J2SE ä¸­çš„åŸºç¡€æ¦‚å¿µã€‚åŠ¨æ€ä»£ç†å‘ç”Ÿåœ¨æœåŠ¡è°ƒç”¨æ–¹/å®¢æˆ·ç«¯ï¼ŒRPC æ¡†æ¶éœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šåƒè°ƒç”¨æœ¬åœ°æ¥å£ä¸€æ ·è°ƒç”¨è¿œç¨‹çš„æ¥å£ã€‚äºæ˜¯å¦‚ä½•ç»„è£…æ•°æ®æŠ¥æ–‡ï¼Œç»è¿‡ç½‘ç»œä¼ è¾“å‘é€è‡³æœåŠ¡æä¾›æ–¹ï¼Œå±è”½è¿œç¨‹æ¥å£è°ƒç”¨çš„ç»†èŠ‚ï¼Œä¾¿æ˜¯åŠ¨æ€ä»£ç†éœ€è¦åšçš„å·¥ä½œäº†ã€‚RPC æ¡†æ¶ä¸­çš„ä»£ç†å±‚å¾€å¾€æ˜¯å•ç‹¬çš„ä¸€å±‚ï¼Œä»¥æ–¹ä¾¿æ›¿æ¢ä»£ç†æ–¹å¼ï¼ˆå¦‚ motan ä»£ç†å±‚ä½äº`com.weibo.api.motan.proxy` ï¼Œdubboä»£ç†å±‚ä½äº `com.alibaba.dubbo.common.bytecode` ï¼‰ã€‚

å®ç°åŠ¨æ€ä»£ç†çš„æ–¹æ¡ˆæœ‰ä¸‹åˆ—å‡ ç§ï¼š

- jdk åŠ¨æ€ä»£ç†
- cglib åŠ¨æ€ä»£ç†
- javassist åŠ¨æ€ä»£ç†
- ASM å­—èŠ‚ç 
- javassist å­—èŠ‚ç 

å…¶ä¸­ cglib åº•å±‚å®ç°ä¾èµ–äº ASMï¼Œjavassist è‡ªæˆä¸€æ´¾ã€‚ç”±äº ASM å’Œ javassist éœ€è¦ç¨‹åºå‘˜ç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Œå¯¼è‡´ä½¿ç”¨é—¨æ§›ç›¸å¯¹è¾ƒé«˜ï¼Œä½†å®é™…ä¸Šä»–ä»¬çš„åº”ç”¨æ˜¯éå¸¸å¹¿æ³›çš„ï¼Œå¦‚ Hibernate åº•å±‚ä½¿ç”¨äº† javassistï¼ˆé»˜è®¤ï¼‰å’Œ cglibï¼ŒSpring ä½¿ç”¨äº† cglib å’Œ jdk åŠ¨æ€ä»£ç†ã€‚

RPC æ¡†æ¶æ— è®ºé€‰æ‹©ä½•ç§ä»£ç†æŠ€æœ¯ï¼Œæ‰€éœ€è¦å®Œæˆçš„ä»»åŠ¡å…¶å®æ˜¯å›ºå®šçš„ï¼Œä¸å¤–ä¹â€˜æ•´ç†æŠ¥æ–‡â€™ï¼Œâ€˜ç¡®è®¤ç½‘ç»œä½ç½®â€™ï¼Œâ€˜åºåˆ—åŒ–â€™,â€™ç½‘ç»œä¼ è¾“â€™ï¼Œâ€˜ååºåˆ—åŒ–â€™ï¼Œâ€™è¿”å›ç»“æœâ€™â€¦

## æŠ€æœ¯é€‰å‹çš„å½±å“å› ç´ 

æ¡†æ¶ä¸­ä½¿ç”¨ä½•ç§åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œå½±å“å› ç´ ä¹Ÿä¸å°‘ã€‚

### æ€§èƒ½

ä»æ—©æœŸ dubbo çš„ä½œè€…æ¢é£çš„åšå®¢ <http://javatar.iteye.com/blog/814426> ä¸­å¯ä»¥å¾—çŸ¥ dubbo é€‰æ‹©ä½¿ç”¨ javassist ä½œä¸ºåŠ¨æ€ä»£ç†æ–¹æ¡ˆä¸»è¦è€ƒè™‘çš„å› ç´ æ˜¯**æ€§èƒ½**ã€‚

ä»å…¶åšå®¢çš„æµ‹è¯•ç»“æœæ¥çœ‹ javassist > cglib > jdk ã€‚ä½†å®é™…ä¸Šä»–çš„æµ‹è¯•è¿‡ç¨‹ç¨å¾®æœ‰ç‚¹ç‘•ç–µï¼šåœ¨ cglib å’Œ jdk ä»£ç†å¯¹è±¡è°ƒç”¨æ—¶ï¼Œèµ°çš„æ˜¯åå°„è°ƒç”¨ï¼Œè€Œåœ¨ javassist ç”Ÿæˆçš„ä»£ç†å¯¹è±¡è°ƒç”¨æ—¶ï¼Œèµ°çš„æ˜¯ç›´æ¥è°ƒç”¨ï¼ˆå¯ä»¥å…ˆé˜…è¯»ä¸‹æ¢é£å¤§å¤§çš„åšå®¢ï¼‰ã€‚è¿™æ„å‘³ç€ cglib å’Œ jdk æ…¢çš„åŸå› å¹¶ä¸æ˜¯ç”±åŠ¨æ€ä»£ç†äº§ç”Ÿçš„ï¼Œè€Œæ˜¯ç”±åå°„è°ƒç”¨äº§ç”Ÿçš„ï¼ˆé¡ºå¸¦ä¸€æï¼Œå¾ˆå¤šäººè®¤ä¸º jdk åŠ¨æ€ä»£ç†çš„åŸç†æ˜¯åå°„ï¼Œå…¶å®å®ƒçš„åº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨çš„å­—èŠ‚ç æŠ€æœ¯ï¼‰ã€‚è€Œæœ€ç»ˆæˆ‘çš„æµ‹è¯•ç»“æœï¼Œç»“è®ºå¦‚ä¸‹ï¼š javassist â‰ˆ cglib > jdk ã€‚javassist å’Œ cglib çš„æ•ˆç‡åŸºæœ¬æŒå¹³ ï¼Œè€Œä»–ä»¬ä¸¤è€…çš„æ‰§è¡Œæ•ˆç‡åŸºæœ¬å¯ä»¥è¾¾åˆ° jdk åŠ¨æ€ä»£ç†çš„2å€ï¼ˆè¿™å–å†³äºæµ‹è¯•çš„æœºå™¨ä»¥åŠ jdk çš„ç‰ˆæœ¬ï¼Œjdk1.8 ç›¸è¾ƒäº jdk1.6 åŠ¨æ€ä»£ç†æŠ€æœ¯æœ‰äº†è´¨çš„æå‡ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯ä¼ é—»ä¸­çš„é‚£æ ·ï¼šcglib æ¯” jdk å¿« 10å€ï¼‰ã€‚æ–‡æœ«ä¼šç»™å‡ºæˆ‘çš„æµ‹è¯•ä»£ç ã€‚

### ä¾èµ–

> motané»˜è®¤çš„å®ç°æ˜¯jdkåŠ¨æ€ä»£ç†ï¼Œä»£ç†æ–¹æ¡ˆæ”¯æŒSPIæ‰©å±•ï¼Œå¯ä»¥è‡ªè¡Œæ‰©å±•å…¶ä»–å®ç°æ–¹å¼ã€‚
>
> ä½¿ç”¨jdkåšä¸ºé»˜è®¤ï¼Œä¸»è¦æ˜¯å‡å°‘coreåŒ…ä¾èµ–ï¼Œæ€§èƒ½ä¸æ˜¯å”¯ä¸€è€ƒè™‘å› ç´ ã€‚å¦å¤–ä½¿ç”¨å­—èŠ‚ç æ–¹å¼javaassistæ€§èƒ½æ¯”è¾ƒä¼˜ç§€ï¼ŒåŠ¨æ€ä»£ç†æ¨¡å¼ä¸‹jdkæ€§èƒ½ä¹Ÿä¸ä¼šå·®å¤šå°‘ã€‚
>
> â€“ **rayzhang0603**(motanè´¡çŒ®è€…)

motan é€‰æ‹©ä½¿ç”¨ jdk åŠ¨æ€ä»£ç†ï¼ŒåŸå› ä¸»è¦æœ‰ä¸¤ä¸ªï¼šå‡å°‘ motan-core çš„ä¾èµ–ï¼Œæ–¹ä¾¿ã€‚è‡³äºæ‰©å±•æ€§ï¼Œdubbo å¹¶æ²¡æœ‰é¢„ç•™å‡ºåŠ¨æ€ä»£ç†çš„æ‰©å±•æ¥å£ï¼Œè€Œæ˜¯å†™æ­»äº† bytecode ï¼Œè¿™ç‚¹ä¸Š motan åšçš„è¾ƒå¥½ã€‚

### æ˜“ç”¨æ€§

ä» dubbo å’Œ motan çš„æºç ä¸­ä¾¿å¯ä»¥ç›´è§‚çš„çœ‹å‡ºä¸¤è€…çš„å·®è·äº†ï¼Œdubbo ä¸ºäº†ä½¿ç”¨ javassist æŠ€æœ¯èŠ±è´¹ä¸å°‘çš„ç²¾åŠ›ï¼Œè€Œ motan ä½¿ç”¨ jdk åŠ¨æ€ä»£ç†åªç”¨äº†ä¸€ä¸ªç±»ã€‚dubbo çš„è®¾è®¡è€…ä¸ºäº†è¿½æ±‚æè‡´çš„æ€§èƒ½è€Œåšå‡ºçš„å·¥ä½œæ˜¯å€¼å¾—è‚¯å®šçš„ï¼Œmotan ä¹Ÿé¢„ç•™äº†æ‰©å±•æœºåˆ¶ï¼Œä¸¤è€…å„æœ‰åƒç§‹ã€‚

## åŠ¨æ€ä»£ç†å…¥é—¨æŒ‡å—

ä¸ºäº†æ–¹ä¾¿å¯¹æ¯”å‡ ç§åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œå…ˆå‡†å¤‡ä¸€ä¸ªç»Ÿä¸€æ¥å£ã€‚

```Java
public interface BookApi {
    void sell();
}
```

### JDKåŠ¨æ€ä»£ç†

```Java
private static BookApi createJdkDynamicProxy(final BookApi delegate) {
        BookApi jdkProxy = (BookApi) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),
                new Class[]{BookApi.class}, new JdkHandler(delegate));
        return jdkProxy;
}

private static class JdkHandler implements InvocationHandler {

        final Object delegate;

        JdkHandler(Object delegate) {
            this.delegate = delegate;
        }

        @Override
        public Object invoke(Object object, Method method, Object[] objects)
                throws Throwable {
            //æ·»åŠ ä»£ç†é€»è¾‘<1>
            if(method.getName().equals("sell")){
                System.out.print("");
            }
            return null;
//            return method.invoke(delegate, objects);
        }
```

`<1>` åœ¨çœŸæ­£çš„ RPC è°ƒç”¨ä¸­ ï¼Œéœ€è¦å¡«å……â€˜æ•´ç†æŠ¥æ–‡â€™ï¼Œâ€˜ç¡®è®¤ç½‘ç»œä½ç½®â€™ï¼Œâ€˜åºåˆ—åŒ–â€™,â€™ç½‘ç»œä¼ è¾“â€™ï¼Œâ€˜ååºåˆ—åŒ–â€™ï¼Œâ€™è¿”å›ç»“æœâ€™ç­‰é€»è¾‘ã€‚

### CglibåŠ¨æ€ä»£ç†

```Java
private static BookApi createCglibDynamicProxy(final BookApi delegate) throws Exception {
        Enhancer enhancer = new Enhancer();
        enhancer.setCallback(new CglibInterceptor(delegate));
        enhancer.setInterfaces(new Class[]{BookApi.class});
        BookApi cglibProxy = (BookApi) enhancer.create();
        return cglibProxy;
    }

    private static class CglibInterceptor implements MethodInterceptor {

        final Object delegate;

        CglibInterceptor(Object delegate) {
            this.delegate = delegate;
        }

        @Override
        public Object intercept(Object object, Method method, Object[] objects,
                                MethodProxy methodProxy) throws Throwable {
            //æ·»åŠ ä»£ç†é€»è¾‘
            if(method.getName().equals("sell")) {
                System.out.print("");
            }
            return null;
//            return methodProxy.invoke(delegate, objects);
        }
    }
```

å’Œ JDK åŠ¨æ€ä»£ç†çš„æ“ä½œæ­¥éª¤æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œåªä¸è¿‡æ˜¯æ›¿æ¢äº† cglib çš„APIè€Œå·²ã€‚

éœ€è¦å¼•å…¥ cglib ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>cglib</groupId>
    <artifactId>cglib</artifactId>
    <version>3.2.5</version>
</dependency>
```

### Javassistå­—èŠ‚ç 

åˆ°äº† javassistï¼Œç¨å¾®æœ‰ç‚¹ä¸åŒäº†ã€‚å› ä¸ºå®ƒæ˜¯é€šè¿‡ç›´æ¥æ“ä½œå­—èŠ‚ç æ¥ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚

```Java
private static BookApi createJavassistBytecodeDynamicProxy() throws Exception {
    ClassPool mPool = new ClassPool(true);
    CtClass mCtc = mPool.makeClass(BookApi.class.getName() + "JavaassistProxy");
    mCtc.addInterface(mPool.get(BookApi.class.getName()));
    mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));
    mCtc.addMethod(CtNewMethod.make(
            "public void sell() { System.out.print(\"\") ; }", mCtc));
    Class<?> pc = mCtc.toClass();
    BookApi bytecodeProxy = (BookApi) pc.newInstance();
    return bytecodeProxy;
}
```

éœ€è¦å¼•å…¥ javassist ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>org.javassist</groupId>
    <artifactId>javassist</artifactId>
    <version>3.21.0-GA</version>
</dependency>
```

## åŠ¨æ€ä»£ç†æµ‹è¯•

æµ‹è¯•ç¯å¢ƒï¼šwindow i5 8g jdk1.8 cglib3.2.5 javassist3.21.0-GA

åŠ¨æ€ä»£ç†å…¶å®åˆ†æˆäº†ä¸¤æ­¥ï¼šä»£ç†å¯¹è±¡çš„åˆ›å»ºï¼Œä»£ç†å¯¹è±¡çš„è°ƒç”¨ã€‚åŠé—´æµä¼ çš„åŠ¨æ€ä»£ç†æ€§èƒ½å¯¹æ¯”ä¸»è¦æŒ‡çš„æ˜¯åè€…ï¼›å‰è€…ä¸€èˆ¬ä¸è¢«å¤§å®¶è€ƒè™‘ï¼Œå¦‚æœè¿œç¨‹Referçš„å¯¹è±¡æ˜¯å•ä¾‹çš„ï¼Œå…¶åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ï¼Œè€Œå¦‚æœæ˜¯åŸå‹æ¨¡å¼ï¼Œå¤šä¾‹å¯¹è±¡çš„åˆ›å»ºå…¶å®ä¹Ÿæ˜¯æ€§èƒ½æŸè€—çš„ä¸€ä¸ªè€ƒè™‘å› ç´ ï¼ˆåªä¸è¿‡è¿œæ²¡æœ‰è°ƒç”¨å æ¯”å¤§ï¼‰ã€‚

> Create JDK Proxy: 21 ms
>
> Create CGLIB Proxy: 342 ms
>
> Create Javassist Bytecode Proxy: 419 ms

å¯èƒ½å‡ºä¹å¤§å®¶çš„æ„æ–™ï¼ŒJDK åˆ›å»ºåŠ¨æ€ä»£ç†çš„é€Ÿåº¦æ¯”åä¸¤è€…è¦å¿«10å€å·¦å³ã€‚

ä¸‹é¢æ˜¯è°ƒç”¨é€Ÿåº¦çš„æµ‹è¯•ï¼š

> case 1:
>
> JDK Proxy invoke cost 1912 ms
>
> CGLIB Proxy invoke cost 1015 ms
>
> JavassistBytecode Proxy invoke cost 1280 ms

> case 2:
>
> JDK Proxy invoke cost 1747 ms
>
> CGLIB Proxy invoke cost 1234 ms
>
> JavassistBytecode Proxy invoke cost 1175 ms

> case 3:
>
> JDK Proxy invoke cost 2616 ms
>
> CGLIB Proxy invoke cost 1373 ms
>
> JavassistBytecode Proxy invoke cost 1335 ms

Jdk çš„æ‰§è¡Œé€Ÿåº¦ä¸€å®šä¼šæ…¢äº Cglib å’Œ Javassistï¼Œä½†æœ€æ…¢ä¹Ÿå°±2å€ï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°æ•°é‡çº§çš„å·®è·ï¼›Cglib å’Œ Javassistä¸ç›¸ä¸Šä¸‹ï¼Œå·®è·ä¸å¤§ï¼ˆæµ‹è¯•ä¸­å¶å°”å‘ç°Cglibå®è¡Œé€Ÿåº¦ä¼šæ¯”å¹³æ—¶æ…¢10å€ï¼Œä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆåŸå› ï¼‰

æ‰€ä»¥å‡ºäºæ˜“ç”¨æ€§å’Œæ€§èƒ½ï¼Œç§ä»¥ä¸ºä½¿ç”¨ Cglib æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼ˆæ€§èƒ½å’Œ Javassist æŒå¹³ï¼Œæ˜“ç”¨æ€§å’Œ Jdk æŒå¹³ï¼‰ã€‚

## åå°„è°ƒç”¨

æ—¢ç„¶æåˆ°äº†åŠ¨æ€ä»£ç†å’Œ cglib ï¼Œé¡ºå¸¦æä¸€ä¸‹åå°„è°ƒç”¨å¦‚ä½•åŠ é€Ÿçš„é—®é¢˜ã€‚RPC æ¡†æ¶ä¸­åœ¨ Provider æœåŠ¡ç«¯éœ€è¦æ ¹æ®å®¢æˆ·ç«¯ä¼ é€’æ¥çš„ className + method + param æ¥æ‰¾åˆ°å®¹å™¨ä¸­çš„å®é™…æ–¹æ³•æ‰§è¡Œåå°„è°ƒç”¨ã€‚é™¤äº†åå°„è°ƒç”¨å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Cglib æ¥åŠ é€Ÿã€‚

### JDKåå°„è°ƒç”¨

```Java
Method method = serviceClass.getMethod(methodName, new Class[]{});
method.invoke(delegate, new Object[]{});
```

### Cglibè°ƒç”¨

```Java
FastClass serviceFastClass = FastClass.create(serviceClass);
FastMethod serviceFastMethod = serviceFastClass.getMethod(methodName, new Class[]{});
serviceFastMethod.invoke(delegate, new Object[]{});
```

ä½†å®æµ‹æ•ˆæœå‘ç° Cglib å¹¶ä¸ä¸€å®šæ¯” JDK åå°„æ‰§è¡Œé€Ÿåº¦å¿«ï¼Œè¿˜ä¼šè·Ÿå…·ä½“çš„æ–¹æ³•å®ç°æœ‰å…³(å¤§é›¾)ã€‚

## æµ‹è¯•ä»£ç 

ç•¥é•¿â€¦

```Java
public class Main {

    public static void main(String[] args) throws Exception {

        BookApi delegate = new BookApiImpl();
        long time = System.currentTimeMillis();
        BookApi jdkProxy = createJdkDynamicProxy(delegate);
        time = System.currentTimeMillis() - time;
        System.out.println("Create JDK Proxy: " + time + " ms");

        time = System.currentTimeMillis();
        BookApi cglibProxy = createCglibDynamicProxy(delegate);
        time = System.currentTimeMillis() - time;
        System.out.println("Create CGLIB Proxy: " + time + " ms");

        time = System.currentTimeMillis();
        BookApi javassistBytecodeProxy = createJavassistBytecodeDynamicProxy();
        time = System.currentTimeMillis() - time;
        System.out.println("Create JavassistBytecode Proxy: " + time + " ms");

        for (int i = 0; i < 10; i++) {
            jdkProxy.sell();//warm
        }
        long start = System.currentTimeMillis();
        for (int i = 0; i < 10000000; i++) {
            jdkProxy.sell();
        }
        System.out.println("JDK Proxy invoke cost " + (System.currentTimeMillis() - start) + " ms");

        for (int i = 0; i < 10; i++) {
            cglibProxy.sell();//warm
        }
        start = System.currentTimeMillis();
        for (int i = 0; i < 10000000; i++) {
            cglibProxy.sell();
        }
        System.out.println("CGLIB Proxy invoke cost " + (System.currentTimeMillis() - start) + " ms");

        for (int i = 0; i < 10; i++) {
            javassistBytecodeProxy.sell();//warm
        }
        start = System.currentTimeMillis();
        for (int i = 0; i < 10000000; i++) {
            javassistBytecodeProxy.sell();
        }
        System.out.println("JavassistBytecode Proxy invoke cost " + (System.currentTimeMillis() - start) + " ms");

        Class<?> serviceClass = delegate.getClass();
        String methodName = "sell";
        for (int i = 0; i < 10; i++) {
            cglibProxy.sell();//warm
        }
        // æ‰§è¡Œåå°„è°ƒç”¨
        for (int i = 0; i < 10; i++) {//warm
            Method method = serviceClass.getMethod(methodName, new Class[]{});
            method.invoke(delegate, new Object[]{});
        }
        start = System.currentTimeMillis();
        for (int i = 0; i < 10000000; i++) {
            Method method = serviceClass.getMethod(methodName, new Class[]{});
            method.invoke(delegate, new Object[]{});
        }
        System.out.println("åå°„ invoke cost " + (System.currentTimeMillis() - start) + " ms");

        // ä½¿ç”¨ CGLib æ‰§è¡Œåå°„è°ƒç”¨
        for (int i = 0; i < 10; i++) {//warm
            FastClass serviceFastClass = FastClass.create(serviceClass);
            FastMethod serviceFastMethod = serviceFastClass.getMethod(methodName, new Class[]{});
            serviceFastMethod.invoke(delegate, new Object[]{});
        }
        start = System.currentTimeMillis();
        for (int i = 0; i < 10000000; i++) {
            FastClass serviceFastClass = FastClass.create(serviceClass);
            FastMethod serviceFastMethod = serviceFastClass.getMethod(methodName, new Class[]{});
            serviceFastMethod.invoke(delegate, new Object[]{});
        }
        System.out.println("CGLIB invoke cost " + (System.currentTimeMillis() - start) + " ms");

    }

    private static BookApi createJdkDynamicProxy(final BookApi delegate) {
        BookApi jdkProxy = (BookApi) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),
                new Class[]{BookApi.class}, new JdkHandler(delegate));
        return jdkProxy;
    }

    private static class JdkHandler implements InvocationHandler {

        final Object delegate;

        JdkHandler(Object delegate) {
            this.delegate = delegate;
        }

        @Override
        public Object invoke(Object object, Method method, Object[] objects)
                throws Throwable {
            //æ·»åŠ ä»£ç†é€»è¾‘
            if(method.getName().equals("sell")){
                System.out.print("");
            }
            return null;
//            return method.invoke(delegate, objects);
        }
    }

    private static BookApi createCglibDynamicProxy(final BookApi delegate) throws Exception {
        Enhancer enhancer = new Enhancer();
        enhancer.setCallback(new CglibInterceptor(delegate));
        enhancer.setInterfaces(new Class[]{BookApi.class});
        BookApi cglibProxy = (BookApi) enhancer.create();
        return cglibProxy;
    }

    private static class CglibInterceptor implements MethodInterceptor {

        final Object delegate;

        CglibInterceptor(Object delegate) {
            this.delegate = delegate;
        }

        @Override
        public Object intercept(Object object, Method method, Object[] objects,
                                MethodProxy methodProxy) throws Throwable {
            //æ·»åŠ ä»£ç†é€»è¾‘
            if(method.getName().equals("sell")) {
                System.out.print("");
            }
            return null;
//            return methodProxy.invoke(delegate, objects);
        }
    }

    private static BookApi createJavassistBytecodeDynamicProxy() throws Exception {
        ClassPool mPool = new ClassPool(true);
        CtClass mCtc = mPool.makeClass(BookApi.class.getName() + "JavaassistProxy");
        mCtc.addInterface(mPool.get(BookApi.class.getName()));
        mCtc.addConstructor(CtNewConstructor.defaultConstructor(mCtc));
        mCtc.addMethod(CtNewMethod.make(
                "public void sell() { System.out.print(\"\") ; }", mCtc));
        Class<?> pc = mCtc.toClass();
        BookApi bytecodeProxy = (BookApi) pc.newInstance();
        return bytecodeProxy;
    }

}
```

# 666. å½©è›‹

å¦‚æœä½ å¯¹ RPC å¹¶å‘æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†ä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)