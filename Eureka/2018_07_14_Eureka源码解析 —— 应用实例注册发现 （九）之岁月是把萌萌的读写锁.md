title: Eureka æºç è§£æ â€”â€” Eurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”
date: 2018-07-14
tags:
categories: Eureka
permalink: Eureka/instance-registry-read-write-lock
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484700&idx=1&sn=2f352c36c594f3b31985c636afe6036a&chksm=fa497aadcd3ef3bba70b6447c4f7a02a087e3675eb5e6bcbf0089882789b1578a7aac0eef12e#rd

---

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

- [1. æ¦‚è¿°](http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/)
- [2. è¯»å†™é”](http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/)
- [666. å½©è›‹](http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Eureka æ³¨å†Œä¸­å¿ƒçš„é‚£æŠŠè¯»å†™é”**ï¼Œè®©æˆ‘ç˜™ç—’éš¾è€ï¼Œå´ä¸å¾—å…¶è§£ã€‚åœ¨æŸæ¬¡æ„å¤–çš„æŠ è„šçš„ä¸€åˆ»( ç¬”è€…ä¸æŠ½çƒŸï¼Œå¦‚æœæŠ½çƒŸçš„è¯ï¼Œæ­¤å¤„åº”è¯¥å°±ä¸æ˜¯æŠ è„šäº† )ï¼Œçªç„¶é¡¿æ‚Ÿï¼Œçˆ½ï¼Œè¿™å¥½æ¯”... æ¯”å–»æœ‰ç‚¹çŒ¥çï¼Œç¬”è€…å°±çœç•¥ 100 å­—ã€‚

ä¸çæ¯”æ¯”ï¼Œä¸Šä»£ç ï¼š

```Java
public abstract class AbstractInstanceRegistry implements InstanceRegistry {

    private final ReentrantReadWriteLock readWriteLock = new ReentrantReadWriteLock();
    private final Lock read = readWriteLock.readLock();
    private final Lock write = readWriteLock.writeLock();

    // ... çœç•¥å…¶ä»–ä»£ç 

}
```

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)
* ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚

**æ¨è Spring Cloud è§†é¢‘**ï¼š

* [Java å¾®æœåŠ¡å®è·µ - Spring Boot](https://segmentfault.com/ls/1650000011063780?r=bPN0Ir)
* [Java å¾®æœåŠ¡å®è·µ - Spring Cloud](https://segmentfault.com/ls/1650000011386794?r=bPN0Ir)
* [Java å¾®æœåŠ¡å®è·µ - Spring Boot / Spring Cloud](https://segmentfault.com/ls/1650000011387052?r=bPN0Ir)

# 2. è¯»å†™é”

æˆ‘ä»¬æŠŠè®¾è®¡åˆ°è¯»å†™é”çš„æ–¹æ³•æ•´ç†å¦‚ä¸‹ï¼š


| æ–¹æ³• | è¯»é” | å†™é” | ä¸ä½¿ç”¨ |
| --- | --- | --- | --- |
| `#register(...)`  | âˆš |  |  |
| `#cancel(...)`  | âˆš |  |  |
| `#evict(...)`  | âˆš |  |  |
| `#renew(...)`  |  |  |  âˆš |
| `#statusUpdate(...)`  | âˆš |  |  |
| `#deleteStatusOverride(...)`  | âˆš |  |  |
| `#getApplicationDeltasFromMultipleRegions(...)`  |  | âˆš |  |
| `#getApplicationsFromMultipleRegions(...)`  |  |  | âˆš |

æ˜¯å¦çœ‹åˆ°è¿™è¯»å†™æ„Ÿåˆ°å‡ ä¸è¯¡å¼‚çš„å‘³é“ï¼ŸOKï¼Œæˆ‘ä»¬æŠŠé—®é¢˜æ¢³ç†å¦‚ä¸‹ï¼š

* A. ä¸ºä»€ä¹ˆ `#register(...)` / `#cancel(...)` / `#evict(...)` / `#statusUpdate(...)` / `#deleteStatusOverride(...)` ç­‰**å†™æ“ä½œ**ä½¿ç”¨**è¯»é”**
* B. ä¸ºä»€ä¹ˆ `#renew(...)` **å†™æ“ä½œ**ä¸ä½¿ç”¨**é”**
* C. ä¸ºä»€ä¹ˆ `#getApplicationDeltasFromMultipleRegions(...)` **è¯»æ“ä½œ**ä½¿ç”¨**å†™é”**
* D. ä¸ºä»€ä¹ˆ `getApplicationsFromMultipleRegions(...)` **è¯»æ“ä½œ**ä¸ä½¿ç”¨**é”**

-------

**å…ˆè§£é‡Š A + C** ï¼š

æˆ‘ä»¬æ¥å›æƒ³ä¸‹ï¼Œåœ¨ Eureka åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç çš„å…¬å¼ï¼š`appsHashCode = ${status}_${count}_` ã€‚( ä¸äº†è§£çš„åŒå­¦å¯ä»¥åŠ è½½ä¸‹ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹ã€Œ 2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç  ã€](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/) )

~~åº”ç”¨å®ä¾‹çš„æ•°é‡å’ŒçŠ¶æ€éƒ½ä¼šå½±å“**å“ˆå¸Œç **çš„è®¡ç®—ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šè¿°**å‰å…­ä¸ª**( åŒ…æ‹¬ä¸ä½¿ç”¨é”çš„ `#renew(...)` æ–¹æ³• )æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šå½±å“å“ˆå¸Œç ã€‚~~

æˆ‘ä»¬æŠŠç›®å…‰ç§»å‘å”¯ä¸€ä½¿ç”¨**å†™é”**çš„ `#getApplicationDeltasFromMultipleRegions(...)` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¿è¯ `recentlyChangedQueue` å’Œ `registry` å…±äº«å˜é‡çš„**åº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸€è‡´**ï¼Œä¸ç„¶è¿”å›çš„å¢é‡åº”ç”¨å®ä¾‹é›†åˆçš„çŠ¶æ€æ˜¯ä¸å‡†ç¡®çš„ã€‚æ­¤æ—¶èƒ½å¤Ÿè¾¾åˆ°è¯¥æ•ˆæœï¼Œå¿…é¡»è®© `#getApplicationDeltasFromMultipleRegions(...)` å’Œå‰å…­ä¸ªæ–¹æ³•**äº’æ–¥**ã€‚æ–¹æ¡ˆå¦‚ä¸‹ï¼š

* a. å…¨éƒ¨ `synchronized`
* b. `#getApplicationDeltasFromMultipleRegions(...)` ä½¿ç”¨**è¯»é”**ï¼Œå‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨**å†™é”**
* c. `#getApplicationDeltasFromMultipleRegions(...)` ä½¿ç”¨**å†™é”**ï¼Œå‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨**è¯»é”**

Eureka é€‰æ‹©äº†**æ–¹æ¡ˆc**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

* a. æ€§èƒ½å¤ªå·®
* b. å‰å…­ä¸ªæ–¹æ³•ä½¿ç”¨**å†™é”**ï¼ŒåŠ¿å¿…å†²çªå¤ªå¤§ï¼Œè™½ç„¶è¯»è‚¯å®šæ¯”å†™å¤šã€‚
* c. `#getApplicationDeltasFromMultipleRegions(...)` ä½¿ç”¨**å†™é”**ï¼Œé…åˆ ResponseCache ï¼Œå³å‡å°‘äº†**å†™é”**ä½¿ç”¨çš„é¢‘ç‡ï¼Œæ¯æ¬¡ç¼“å­˜è¿‡æœŸæ‰ä½¿ç”¨ï¼Œåˆé¿å…äº†å‰å…­ä¸ªæ–¹æ³•å› ä¸º**æ–¹æ¡ˆb**ä¸­çš„**å†™é”**å¯¼è‡´äº’æ–¥ã€‚( ä¸äº†è§£ ResponseCache çš„åŒå­¦å¯ä»¥åŠ è½½ä¸‹ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ 3.2 å“åº”ç¼“å­˜ ResponseCache ã€](hhttp://www.iocoder.cn/Eureka/instance-registry-fetch-all/) )

-------

**å†è§£é‡Š D**

`#getApplicationsFromMultipleRegions(...)` æ–¹æ³•çš„é€»è¾‘ï¼Œåªä¾èµ– `registry` å…±äº«å˜é‡ï¼Œä¸å­˜åœ¨åº”ç”¨å®ä¾‹çš„çŠ¶æ€ä¸€è‡´çš„å›°æ‰°ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨é”ã€‚

-------

**æœ€åè§£é‡Š B**

`#renew(...)` æ–¹æ³•çš„é€»è¾‘ï¼Œè™½ç„¶ä¼šå½±å“åº”ç”¨å®ä¾‹çš„çŠ¶æ€ï¼Œä½†æ˜¯æ˜¯æå°æ¦‚ç‡ï¼Œè€ƒè™‘åˆ°å®ƒè°ƒç”¨çš„æ¯”è¾ƒé¢‘ç¹ï¼Œæ¯”èµ·å› ä¸ºé”ç»™è¿™ä¸ªæ–¹æ³•å¸¦æ¥çš„æ€§èƒ½é™ä½ï¼Œä¸å¦‚è¿”å›çš„ç»“æœæš‚æ—¶ä¸å¤Ÿå‡†ç¡®ã€‚( æƒ³äº†è§£æå°æ¦‚ç‡å‘ç”ŸåŸå› çš„åŒå­¦å¯ä»¥åŠ è½½ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹ã€Œ 4.3 ç»­ç§Ÿåœºæ™¯ ã€](http://www.iocoder.cn/Eureka/instance-registry-override-status/?self) )

-------

TODO [0029] è¯»å†™é”

ç¬”è€…è·¯ä¸Šçªç„¶åˆæƒ³äº†é—®é¢˜ï¼Œå¯èƒ½ä¸æ˜¯ä¸Šè¿°åŸå› ï¼Œå¯èƒ½å’Œ ResponseCache æœ‰å…³ç³»ï¼Œå‚è§ `#invalidateCache(...)` æ–¹æ³•çš„æ¯æ¬¡è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯»å†™é”æ˜¯é’ˆå¯¹ ResponseCache çš„è¯»å†™é”ã€‚

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

å¼€æ£® ï¼

æœ¬æ¥ä»¥ä¸ºéœ€è¦è·Ÿ Eureka å®˜æ–¹æäº¤ issue æé—®ï¼Œå¹¶ä¸”åšå¥½äº†è·å¾—ä¸åˆ°ç­”æ¡ˆçš„å‡†å¤‡ï¼Œç»“æœæ— æ„ä¸­çš„æŠ è„š( è¯·å…è®¸æˆ‘çƒ­çˆ±æŠ è„šç»™æˆ‘å¸¦æ¥çš„çµæ„Ÿ )è§£ç­”äº†è‡ªå·±çš„ç–‘æƒ‘ã€‚

å²æœˆæ˜¯æŠŠçº ç»“è€ŒåˆèŒèŒå“’çš„é”ï¼Œä½ ä¸çŸ¥é“ä½ çš„å›°æ‰°ï¼Œå“ªå¤©ä¸ç»æ„çš„è¢«æ‰“å¼€ã€‚

æ„¿å¤§å–œå¤§æ‚²ï¼Œä¸æ‰ä»…çŸ¥çš„è¿™ä¸€ç”Ÿã€‚



