title: Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–
date: 2018-07-03
tags:
categories: Eureka
permalink: Eureka/instance-registry-fetch-delta

---

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬** 

- [1. æ¦‚è¿°](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
- [2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç ](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
  - [2.1 è®¡ç®—å…¬å¼](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
  - [2.2 åˆç†æ€§](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
- [3. Eureka-Client å‘èµ·å¢é‡è·å–](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
  - [3.1 åˆå¹¶åº”ç”¨é›†åˆ](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
- [4. Eureka-Server æ¥æ”¶å…¨é‡è·å–](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
  - [3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
  - [3.2 æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
  - [3.3 ç¼“å­˜è¯»å–](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)
- [666. å½©è›‹](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/)

---

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Eureka-Client å‘ Eureka-Server è·å–å¢é‡æ³¨å†Œä¿¡æ¯çš„è¿‡ç¨‹**ã€‚

å‰ç½®é˜…è¯»ï¼š[ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹](http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self)

> FROM [ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹](ã€Šhttp://techshow.ctrip.com/archives/1699.htmlã€‹)    
> ![](http://www.iocoder.cn/images/Eureka/2018_06_29/01.png)

Eureka-Client è·å–æ³¨å†Œä¿¡æ¯ï¼Œåˆ†æˆ**å…¨é‡è·å–**å’Œ**å¢é‡è·å–**ã€‚é»˜è®¤é…ç½®ä¸‹ï¼ŒEureka-Client å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œä¸€æ¬¡**å…¨é‡**è·å–è¿›è¡Œ**æœ¬åœ°ç¼“å­˜**æ³¨å†Œä¿¡æ¯ï¼Œè€Œåæ¯ **30** ç§’**å¢é‡**è·å–åˆ·æ–°**æœ¬åœ°ç¼“å­˜**( éâ€œ**æ­£å¸¸**â€æƒ…å†µä¸‹ä¼šæ˜¯å…¨é‡è·å– )ã€‚

æœ¬æ–‡é‡ç‚¹åœ¨äº**å¢é‡è·å–**ã€‚

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)
* ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚



# 2. åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç 

`Applications.appsHashCode` ï¼Œåº”ç”¨é›†åˆ**ä¸€è‡´æ€§å“ˆå¸Œç **ã€‚

**å¢é‡**è·å–æ³¨å†Œçš„åº”ç”¨é›†åˆ( Applications ) æ—¶ï¼ŒEureka-Client ä¼šè·å–åˆ°ï¼š

1. Eureka-Server è¿‘æœŸå˜åŒ–( æ³¨å†Œã€ä¸‹çº¿ )çš„åº”ç”¨é›†åˆ
2. Eureka-Server åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç 

Eureka-Client å°†**å˜åŒ–**çš„åº”ç”¨é›†åˆå’Œ**æœ¬åœ°ç¼“å­˜**çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶åè¿›è¡Œè®¡ç®—æœ¬åœ°çš„åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç ã€‚è‹¥ä¸¤ä¸ª**å“ˆå¸Œç **ç›¸ç­‰ï¼Œæ„å‘³ç€å¢é‡è·å–æˆåŠŸï¼›è‹¥ä¸ç›¸ç­‰ï¼Œæ„å‘³ç€å¢é‡è·å–å¤±è´¥ï¼ŒEureka-Client é‡æ–°å’Œ Eureka-Server **å…¨é‡**è·å–åº”ç”¨é›†åˆã€‚

Eureka æ¯”è¾ƒåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç ï¼Œå’Œæ—¥å¸¸æˆ‘ä»¬é€šè¿‡å“ˆå¸Œç æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ç±»ä¼¼ã€‚

## 2.1 è®¡ç®—å…¬å¼

`appsHashCode = ${status}_${count}_`

* ä½¿ç”¨æ¯ä¸ªåº”ç”¨å®ä¾‹çŠ¶æ€( `status` ) + æ•°é‡( `count` )æ‹¼æ¥å‡ºä¸€è‡´æ€§å“ˆå¸Œç ã€‚è‹¥æ•°é‡ä¸º 0 ï¼Œè¯¥åº”ç”¨å®ä¾‹çŠ¶æ€ä¸è¿›è¡Œæ‹¼æ¥ã€‚**çŠ¶æ€ä»¥å­—ç¬¦ä¸²å¤§å°æ’åº**ã€‚
* ä¸¾ä¸ªä¾‹å­ï¼Œ8 ä¸ª UP ï¼Œ0 ä¸ª DOWN ï¼Œåˆ™ `appsHashCode = UP_8_` ã€‚8 ä¸ª UP ï¼Œ2 ä¸ª DOWN ï¼Œåˆ™ `appsHashCode = DOWN_2_UP_8_` ã€‚
* å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // Applications.java
    public String getReconcileHashCode() {
       // è®¡æ•°é›†åˆ keyï¼šåº”ç”¨å®ä¾‹çŠ¶æ€
       TreeMap<String, AtomicInteger> instanceCountMap = new TreeMap<String, AtomicInteger>();
       populateInstanceCountMap(instanceCountMap);
       // è®¡ç®— hashcode
       return getReconcileHashCode(instanceCountMap);
    }
    ```
    * è°ƒç”¨ `#populateInstanceCountMap()` æ–¹æ³•ï¼Œè®¡ç®—æ¯ä¸ªåº”ç”¨å®ä¾‹çŠ¶æ€çš„æ•°é‡ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

        ```Java
        // Applications.java
        public void populateInstanceCountMap(Map<String, AtomicInteger> instanceCountMap) {
           for (Application app : this.getRegisteredApplications()) {
               for (InstanceInfo info : app.getInstancesAsIsFromEureka()) {
                   // è®¡æ•°
                   AtomicInteger instanceCount = instanceCountMap.computeIfAbsent(info.getStatus().name(),
                           k -> new AtomicInteger(0));
                   instanceCount.incrementAndGet();
               }
           }
        }
        
        public List<Application> getRegisteredApplications() {
           return new ArrayList<Application>(this.applications);
        }
        
        // Applications.java
        public List<InstanceInfo> getInstancesAsIsFromEureka() {
           synchronized (instances) {
              return new ArrayList<InstanceInfo>(this.instances);
           }
        }
        ```
        * è®¡æ•°é‚£å—ä»£ç ï¼Œä½¿ç”¨ Integer å³å¯ï¼Œæ— éœ€ä½¿ç”¨ AtomicInteger ã€‚
* è°ƒç”¨ `#getReconcileHashCode()` æ–¹æ³•ï¼Œè®¡ç®— `hashcode` ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    public static String getReconcileHashCode(Map<String, AtomicInteger> instanceCountMap) {
       StringBuilder reconcileHashCode = new StringBuilder(75);
       for (Map.Entry<String, AtomicInteger> mapEntry : instanceCountMap.entrySet()) {
           reconcileHashCode.append(mapEntry.getKey()).append(STATUS_DELIMITER) // status
                   .append(mapEntry.getValue().get()).append(STATUS_DELIMITER); // count
       }
       return reconcileHashCode.toString();
    }
    ```

## 2.2 åˆç†æ€§

**æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„**  
**æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„**  
**æœ¬å°èŠ‚ï¼Œå»ºè®®ä½ ç†è§£å®Œå…¨æ–‡åï¼Œå†å›åˆ°æ­¤å¤„**  

ç¬”è€…åˆšçœ‹å®Œåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è®¡ç®—å…¬å¼ï¼Œå¤„äºä¸€è„¸æ‡µé€¼çš„çŠ¶æ€ã€‚è¿™ä¹ˆç²¾ç®€çš„æ–¹å¼çœŸçš„èƒ½å¤Ÿæ ¡éªŒå‡ºæ•°æ®çš„ä¸€è‡´æ€§ä¹ˆï¼Ÿä¸æ™“å¾—æœ‰å¤šå°‘è¯»è€…è·Ÿç¬”è€…æœ‰ä¸€æ ·çš„ç–‘æƒ‘ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è®ºè¯è¯¥ç®—æ³•çš„åˆç†æ€§( ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“ )ã€‚

ä¸€è‡´æ€§å“ˆå¸Œå€¼é€šè¿‡**çŠ¶æ€ + æ•°é‡**æ¥è®¡ç®—ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯èƒ½çŠ¶æ€æ€»æ•°æ˜¯ä¸€æ ·å¤šï¼Œå®é™…åˆ†å¸ƒåœ¨ä¸åŒçš„åº”ç”¨ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬åˆ—ä¸¾æ¨¡å‹å¦‚ä¸‹ï¼š

|  | UP |
| --- | --- |
| åº”ç”¨A | m |
| åº”ç”¨B | n |

å¦‚æœæ­¤æ—¶åº”ç”¨A ä¸‹çº¿äº† c ä¸ªåŸåº”ç”¨å®ä¾‹ï¼Œåº”ç”¨B æ³¨å†Œäº† c ä¸ªä¿¡åº”ç”¨å®ä¾‹ï¼Œé‚£ä¹ˆå¤„äº UP çŠ¶æ€çš„æ•°é‡ä»ç„¶æ˜¯ m + n ä¸ªã€‚

* æ­£å¸¸æƒ…å†µä¸‹ï¼ŒEureka-Client ä» Eureka-Server è·å–åˆ°**å®Œæ•´çš„å¢é‡å˜åŒ–**å¹¶åˆå¹¶ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…æ˜¯ä¸€è‡´çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•**åˆç†**ã€‚

|  | UP (server) | UP (client) | 
| --- | --- | --- |
| åº”ç”¨A | m - c |  m - c |
| åº”ç”¨B | n + c | n + c |

* å¼‚å¸¸æƒ…å†µä¸‹ã€1ã€‘ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—å…¨éƒ¨è¿‡æœŸã€‚é‚£ Eureka-Client ä» Eureka-Server è·å–åˆ°**ç©ºçš„å¢é‡å˜åŒ–**å¹¶åˆå¹¶ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œ ä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•**ä¸åˆç†**ã€‚

|  | UP (server) | UP (client) | 
| --- | --- | --- |
| åº”ç”¨A | m - c |  m |
| åº”ç”¨B | n + c | n  |

* å¼‚å¸¸æƒ…å†µä¸‹ã€2ã€‘ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—éƒ¨åˆ†è¿‡æœŸï¼Œä¾‹å¦‚åº”ç”¨A å’Œ åº”ç”¨B éƒ½å‰©ä½™ w æ¡å˜æ›´è®°å½•ã€‚é‚£ Eureka-Client ä» Eureka-Server è·å–åˆ°**éƒ¨åˆ†çš„å¢é‡å˜åŒ–**å¹¶åˆå¹¶ï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œæ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•**ä¸åˆç†**ã€‚

|  | UP (server) | UP (client) | 
| --- | --- | --- |
| åº”ç”¨A | m - c |  m - w |
| åº”ç”¨B | n + c | n + w  |

What ï¼Ÿ ä»å¼‚å¸¸æƒ…å†µã€1ã€‘ã€2ã€‘å¯ä»¥çœ‹åˆ°ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ç«Ÿç„¶æ˜¯**ä¸åˆç†**çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰‹åŠ¨æ¥åšä¸€æ¬¡æœ€ç²¾ç®€çš„å®éªŒã€‚å®éªŒå¦‚ä¸‹ï¼š

* æ¨¡æ‹Ÿåœºæ™¯ï¼šå¼‚å¸¸æƒ…å†µã€1ã€‘ï¼Œm = n = c = 1 ã€‚ç®€å•ç²—æš´ã€‚
* ç‰¹åˆ«é…ç½®
    * `eureka.retentionTimeInMSInDeltaQueue = 1` ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—æ¯æ¡è®°å½•å­˜æ´»æ—¶é•¿ 1 msã€‚ç”¨ä»¥å®ç° Eureka-Client è¯·æ±‚ä¸åˆ°å®Œæ•´çš„å¢é‡å˜åŒ–ã€‚
    * `eureka.deltaRetentionTimerIntervalInMs = 1` ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—æ¯æ¡è®°å½•è¿‡æœŸå®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ 1 msã€‚ç”¨ä»¥å®ç° Eureka-Client è¯·æ±‚ä¸åˆ°å®Œæ•´çš„å¢é‡å˜åŒ–ã€‚
    * `eureka.shouldUseReadOnlyResponseCache = false` ï¼Œç¦ç”¨å“åº”ç¼“å­˜çš„åªè¯»ç¼“å­˜ã€‚ç”¨ä»¥é¿å…ç­‰å¾…ç¼“å­˜åˆ·æ–°ã€‚
    * `eureka.waitTimeInMsWhenSyncEmpty = 1` ï¼Œ
* å®éªŒè¿‡ç¨‹
    1. 00:00 å¯åŠ¨ Eureka-Server
    2. 00:30 å¯åŠ¨åº”ç”¨A ï¼Œå‘ Eureka-Server æ³¨å†Œ
    3. 01:00 å¯åŠ¨ Eureka-Client ï¼Œå‘ Eureka-Server è·å–æ³¨å†Œä¿¡æ¯ï¼Œç­‰å¾…è·å–åˆ°åº”ç”¨A
    4. 01:30 å…³é—­åº”ç”¨A ã€‚ç«‹å³å¯åŠ¨åº”ç”¨B ï¼Œå‘ Eureka-Server æ³¨å†Œ
    5. ç­‰å¾… 5 åˆ†é’Ÿï¼ŒEureka-Client æ— æ³•è·å–åˆ°åº”ç”¨B 
    6. æ­¤æ—¶åº”ç”¨æƒ…å†µå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼Œä¸¤è€…åº”ç”¨æ˜¯ä¸ç›¸åŒçš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œå€¼å´æ˜¯ç›¸ç­‰çš„ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•**ä¸åˆç†ã€‚**

|  | UP (server) | UP (client) | 
| --- | --- | --- |
| åº”ç”¨A | 0 |  1 |
| åº”ç”¨B | 1 | 0  |

ğŸ™‚**ç»“è®º**ğŸ™‚

å½“ç„¶æ’é™¤æ‰ç‰¹åˆ«æç«¯çš„åœºæ™¯ï¼ŒEureka-Client ä» Eureka-Server å› ä¸ºç½‘ç»œå¼‚å¸¸å¯¼è‡´ä¸€ç›´åŒæ­¥ä¸åˆ°å¢é‡å˜åŒ–ï¼Œåˆæ°å¥½åº”ç”¨å…³é—­å’Œå¼€å¯æ»¡è¶³çŠ¶æ€ç»Ÿè®¡æ•°é‡ã€‚å¦å¤–ï¼Œå˜æ›´è®°å½•é˜Ÿåˆ—è®°å½•è¿‡æœŸæ—¶é•¿ä¸º 300 ç§’ï¼Œå¢é‡è·å–é¢‘ç‡ä¸º 30 ç§’ï¼Œè·å–çš„æ¬¡æ•°æœ‰ 10 æ¬¡å·¦å³ã€‚**æ‰€ä»¥ï¼Œåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç åœ¨ç»å¤§å¤šæ•°åœºæ™¯æ˜¯åˆç†çš„**ã€‚**ç¬”è€…çš„YY**ï¼Œè§£å†³è¿™ä¸ªæå°åœºæ™¯æœ‰å¦‚ä¸‹æ–¹å¼ï¼š

* ç¬¬ä¸€ç§ï¼Œä¿®æ”¹è®¡ç®—å…¬å¼ `appsHashCode = MD5(${app_name}_${instance_id}_${status}_${count}_)` ï¼Œå¢åŠ å¯¹åº”ç”¨åå’Œåº”ç”¨å®ä¾‹ç¼–å·æ•æ„Ÿã€‚
* ç¬¬äºŒç§ï¼Œæ¯ N åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ã€‚

ps ï¼šç¬”è€…æ€€ç€å¿å¿‘çš„å¿ƒå†™å®Œäº†è¿™ä¸ªå°èŠ‚ï¼Œå¦‚æœæœ‰ä¸åˆç†çš„åœ°æ–¹ï¼Œåˆæˆ–è€…æœ‰ä¸åŒè§‚ç‚¹çš„èƒ–å‹ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨ã€‚è°¢è°¢ã€‚

TODO[0027][åæ€]ï¼šåº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚

# 3. Eureka-Client å‘èµ·å¢é‡è·å–

åœ¨ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4 å‘èµ·è·å–æ³¨å†Œä¿¡æ¯ã€](http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self) é‡Œï¼Œè°ƒç”¨ `DiscoveryClient#getAndUpdateDelta(...)` æ–¹æ³•ï¼Œ**å¢é‡**è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶**åˆ·æ–°**æœ¬åœ°ç¼“å­˜ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
  1: private void getAndUpdateDelta(Applications applications) throws Throwable {
  2:     long currentUpdateGeneration = fetchRegistryGeneration.get();
  3: 
  4:     // å¢é‡è·å–æ³¨å†Œä¿¡æ¯
  5:     Applications delta = null;
  6:     EurekaHttpResponse<Applications> httpResponse = eurekaTransport.queryClient.getDelta(remoteRegionsRef.get());
  7:     if (httpResponse.getStatusCode() == Status.OK.getStatusCode()) {
  8:         delta = httpResponse.getEntity();
  9:     }
 10: 
 11:     if (delta == null) {
 12:         // å¢é‡è·å–ä¸ºç©ºï¼Œå…¨é‡è·å–
 13:         logger.warn("The server does not allow the delta revision to be applied because it is not safe. "
 14:                 + "Hence got the full registry.");
 15:         getAndStoreFullRegistry();
 16:     } else if (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + 1)) {
 17:         logger.debug("Got delta update with apps hashcode {}", delta.getAppsHashCode());
 18:         String reconcileHashCode = "";
 19:         if (fetchRegistryUpdateLock.tryLock()) {
 20:             try {
 21:                 // å°†å˜åŒ–çš„åº”ç”¨é›†åˆå’Œæœ¬åœ°ç¼“å­˜çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶
 22:                 updateDelta(delta);
 23:                 // è®¡ç®—æœ¬åœ°çš„åº”ç”¨é›†åˆä¸€è‡´æ€§å“ˆå¸Œç 
 24:                 reconcileHashCode = getReconcileHashCode(applications);
 25:             } finally {
 26:                 fetchRegistryUpdateLock.unlock();
 27:             }
 28:         } else {
 29:             logger.warn("Cannot acquire update lock, aborting getAndUpdateDelta");
 30:         }
 31:         // There is a diff in number of instances for some reason
 32:         if (!reconcileHashCode.equals(delta.getAppsHashCode()) // ä¸€è‡´æ€§å“ˆå¸Œå€¼ä¸ç›¸ç­‰
 33:                 || clientConfig.shouldLogDeltaDiff()) { //
 34:             reconcileAndLogDifference(delta, reconcileHashCode);  // this makes a remoteCall
 35:         }
 36:     } else {
 37:         logger.warn("Not updating application delta as another thread is updating it already");
 38:         logger.debug("Ignoring delta update with apps hashcode {}, as another thread is updating it already", delta.getAppsHashCode());
 39:     }
 40: }
```

* ç¬¬ 4 è‡³ 9 è¡Œ ï¼šè¯·æ±‚**å¢é‡**è·å–æ³¨å†Œä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // AbstractJerseyEurekaHttpClient.java
    @Override
    public EurekaHttpResponse<Applications> getDelta(String... regions) {
       return getApplicationsInternal("apps/delta", regions);
    }
    ```
    * è°ƒç”¨ `AbstractJerseyEurekaHttpClient#getApplicationsInternal(...)` æ–¹æ³•ï¼ŒGET è¯·æ±‚ Eureka-Server çš„ `apps/detla` æ¥å£ï¼Œå‚æ•°ä¸º `regions` ï¼Œè¿”å›æ ¼å¼ä¸º JSON ï¼Œå®ç°å¢é‡è·å–æ³¨å†Œä¿¡æ¯ã€‚

* ç¬¬ 11 è‡³ 15 è¡Œ ï¼š**å¢é‡**è·å–å¤±è´¥ï¼Œè°ƒç”¨ `#getAndStoreFullRegistry()` æ–¹æ³•ï¼Œ**å…¨é‡**è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€‚è¯¥æ–¹æ³•åœ¨ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ2.4.1 å…¨é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ã€](http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self) æœ‰è¯¦ç»†è§£æã€‚
* ç¬¬ 16 è‡³ 35 è¡Œ ï¼šå¤„ç†**å¢é‡**è·å–çš„ç»“æœã€‚
    * ç¬¬ 16 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ
    * ç¬¬ 19 è¡Œ ï¼šTODO[0025] ï¼šå¹¶å‘æ›´æ–°çš„æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ
    * ç¬¬ 21 è¡Œ ï¼šè°ƒç”¨ `#updateDelta(...)` æ–¹æ³•ï¼Œå°†**å˜åŒ–**çš„åº”ç”¨é›†åˆå’Œ**æœ¬åœ°ç¼“å­˜**çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶ã€‚
    * ç¬¬ 31 è‡³ 35 è¡Œ ï¼šä¸€è‡´æ€§å“ˆå¸Œå€¼ä¸ç›¸ç­‰ï¼Œè°ƒç”¨ `#reconcileAndLogDifference()` æ–¹æ³•ï¼Œ**å…¨é‡**è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶è®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ï¼Œå’Œ `#getAndStoreFullRegistry()` åŸºæœ¬ç±»ä¼¼ã€‚
        * ç¬¬ 33 è¡Œ ï¼šé…ç½® `eureka.printDeltaFullDiff` ï¼Œæ˜¯å¦æ‰“å°å¢é‡å’Œå…¨é‡å·®å¼‚ã€‚é»˜è®¤å€¼ ï¼š`false` ã€‚ä»ç›®å‰ä»£ç å®ç°ä¸Šæ¥çœ‹ï¼Œæš‚æ—¶æ²¡æœ‰ç”Ÿæ•ˆã€‚**æ³¨æ„** ï¼šå¼€å¯è¯¥å‚æ•°ä¼šå¯¼è‡´æ¯æ¬¡**å¢é‡**è·å–ååˆå‘èµ·**å…¨é‡**è·å–ï¼Œä¸è¦å¼€å¯ã€‚

## 3.1 åˆå¹¶åº”ç”¨é›†åˆ

è°ƒç”¨ `#updateDelta(...)` æ–¹æ³•ï¼Œå°†**å˜åŒ–**çš„åº”ç”¨é›†åˆå’Œ**æœ¬åœ°ç¼“å­˜**çš„åº”ç”¨é›†åˆè¿›è¡Œåˆå¹¶ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
  1: private void updateDelta(Applications delta) {
  2:     int deltaCount = 0;
  3:     for (Application app : delta.getRegisteredApplications()) { // å¾ªç¯å¢é‡ï¼ˆå˜åŒ–ï¼‰åº”ç”¨é›†åˆ
  4:         for (InstanceInfo instance : app.getInstances()) {
  5:             Applications applications = getApplications();
  6:             // TODO[0009]ï¼šRemoteRegionRegistry
  7:             String instanceRegion = instanceRegionChecker.getInstanceRegion(instance);
  8:             if (!instanceRegionChecker.isLocalRegion(instanceRegion)) {
  9:                 Applications remoteApps = remoteRegionVsApps.get(instanceRegion);
 10:                 if (null == remoteApps) {
 11:                     remoteApps = new Applications();
 12:                     remoteRegionVsApps.put(instanceRegion, remoteApps);
 13:                 }
 14:                 applications = remoteApps;
 15:             }
 16: 
 17:             ++deltaCount;
 18:             if (ActionType.ADDED.equals(instance.getActionType())) { // æ·»åŠ 
 19:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());
 20:                 if (existingApp == null) {
 21:                     applications.addApplication(app);
 22:                 }
 23:                 logger.debug("Added instance {} to the existing apps in region {}", instance.getId(), instanceRegion);
 24:                 applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);
 25:             } else if (ActionType.MODIFIED.equals(instance.getActionType())) { // ä¿®æ”¹
 26:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());
 27:                 if (existingApp == null) {
 28:                     applications.addApplication(app);
 29:                 }
 30:                 logger.debug("Modified instance {} to the existing apps ", instance.getId());
 31: 
 32:                 applications.getRegisteredApplications(instance.getAppName()).addInstance(instance);
 33:             } else if (ActionType.DELETED.equals(instance.getActionType())) { // åˆ é™¤
 34:                 Application existingApp = applications.getRegisteredApplications(instance.getAppName());
 35:                 if (existingApp == null) {
 36:                     applications.addApplication(app);
 37:                 }
 38:                 logger.debug("Deleted instance {} to the existing apps ", instance.getId());
 39:                 applications.getRegisteredApplications(instance.getAppName()).removeInstance(instance);
 40:             }
 41:         }
 42:     }
 43:     logger.debug("The total number of instances fetched by the delta processor : {}", deltaCount);
 44: 
 45:     getApplications().setVersion(delta.getVersion());
 46:     // è¿‡æ»¤ã€æ‰“ä¹±åº”ç”¨é›†åˆ
 47:     getApplications().shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());
 48: 
 49:     // TODO[0009]ï¼šRemoteRegionRegistry
 50:     for (Applications applications : remoteRegionVsApps.values()) {
 51:         applications.setVersion(delta.getVersion());
 52:         applications.shuffleInstances(clientConfig.shouldFilterOnlyUpInstances());
 53:     }
 54: }
```

* ç¬¬ 6 è‡³ 15 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry
* ç¬¬ 18 è‡³ 24 è¡Œ ï¼šæ·»åŠ ( ADDED )åº”ç”¨å®ä¾‹æ—¶ï¼Œè°ƒç”¨ `Application#addInstance(...)` æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // Application.java
    public void addInstance(InstanceInfo i) {
       // æ·»åŠ åˆ° åº”ç”¨å®ä¾‹æ˜ å°„
       instancesMap.put(i.getId(), i);
       synchronized (instances) {
           // ç§»é™¤åŸæœ‰å®ä¾‹
           instances.remove(i);
           // æ·»åŠ æ–°å®ä¾‹
           instances.add(i);
           // è®¾ç½® isDirty ï¼Œç›®å‰åªç”¨äº `#toString()` æ–¹æ³•æ‰“å°ï¼Œæ— ä¸šåŠ¡é€»è¾‘
           isDirty = true;
       }
    }
    
    // InstanceInfo.java
    @Override
    public int hashCode() { // åªä½¿ç”¨ ID è®¡ç®— hashcode
       String id = getId();
       return (id == null) ? 31 : (id.hashCode() + 31);
    }
    
    @Override
    public boolean equals(Object obj) { // åªå¯¹æ¯” ID
       if (this == obj) {
           return true;
       }
       if (obj == null) {
           return false;
       }
       if (getClass() != obj.getClass()) {
           return false;
       }
       InstanceInfo other = (InstanceInfo) obj;
       String id = getId();
       if (id == null) {
           if (other.getId() != null) {
               return false;
           }
       } else if (!id.equals(other.getId())) {
           return false;
       }
       return true;
    }
    ```

* ç¬¬ 25 è‡³ 32 è¡Œ ï¼šä¿®æ”¹( MODIFIED )åº”ç”¨å®ä¾‹æ—¶ï¼Œ**åŒæ ·**è°ƒç”¨ `Application#addInstance(...)` æ–¹æ³•ã€‚

* ç¬¬ 33 è‡³ 40 è¡Œ ï¼šåˆ é™¤( DELETED )åº”ç”¨å®ä¾‹æ—¶ï¼Œè°ƒç”¨ `Application#removeInstance(...)` æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    public void removeInstance(InstanceInfo i) {
        removeInstance(i, true);
    }
    
    private void removeInstance(InstanceInfo i, boolean markAsDirty) {
        // ç§»é™¤ åº”ç”¨å®ä¾‹æ˜ å°„
        instancesMap.remove(i.getId());
        synchronized (instances) {
            // ç§»é™¤ åº”ç”¨å®ä¾‹
            instances.remove(i);
            if (markAsDirty) {
                // è®¾ç½® isDirty ï¼Œç›®å‰åªç”¨äº `#toString()` æ–¹æ³•æ‰“å°ï¼Œæ— ä¸šåŠ¡é€»è¾‘
                isDirty = true;
            }
        }
    }
    ```

* ç¬¬ 47 è¡Œ ï¼šè°ƒç”¨ `Applications#shuffleInstances(...)` æ–¹æ³•ï¼Œæ ¹æ®é…ç½® `eureka.shouldFilterOnlyUpInstances = true` ( é»˜è®¤å€¼ ï¼š`true` ) è¿‡æ»¤åªä¿ç•™çŠ¶æ€ä¸ºå¼€å¯( UP )çš„åº”ç”¨å®ä¾‹ï¼Œå¹¶**éšæœºæ‰“ä¹±**åº”ç”¨å®ä¾‹é¡ºåºã€‚æ‰“ä¹±åï¼Œå®ç°è°ƒç”¨åº”ç”¨æœåŠ¡çš„éšæœºæ€§ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»[é“¾æ¥](https://github.com/YunaiV/eureka/blob/512697015ef081233c5cb7c472250bca6b779ab4/eureka-client/src/main/java/com/netflix/discovery/shared/Applications.java#L286)æŸ¥çœ‹æ–¹æ³•å®ç°ã€‚
* ç¬¬ 49 è‡³ 53 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry

# 4. Eureka-Server æ¥æ”¶å…¨é‡è·å–

## 3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚

`com.netflix.eureka.resources.ApplicationsResource`ï¼Œå¤„ç†**æ‰€æœ‰**åº”ç”¨çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚

æ¥æ”¶å¢é‡è·å–è¯·æ±‚ï¼Œæ˜ å°„ `ApplicationsResource#getContainers()` æ–¹æ³•ã€‚

* å’Œ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.1 æ¥æ”¶å…¨é‡è·å–è¯·æ±‚ã€](http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self) ç±»ä¼¼ï¼Œå°±ä¸é‡å¤å•°å—¦å•¦ã€‚
* ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/225a81d9818d355503ad802363448eb29c374b6f/eureka-core/src/main/java/com/netflix/eureka/resources/ApplicationsResource.java#L190) æŸ¥çœ‹è¯¥æ–¹æ³•çš„**å¸¦ä¸­æ–‡æ³¨é‡Š**ä»£ç ã€‚

## 3.2 æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—

`AbstractInstanceRegistry.recentlyChangedQueue`ï¼Œæœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// AbstractInstanceRegistry.java
/**
* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—
*/
private ConcurrentLinkedQueue<RecentlyChangedItem> recentlyChangedQueue = new ConcurrentLinkedQueue<RecentlyChangedItem>();

/**
* æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•
*/
private static final class RecentlyChangedItem {
   /**
    * æœ€åæ›´æ–°æ—¶é—´æˆ³
    */
   private long lastUpdateTime;
   /**
    * ç§Ÿçº¦
    */
   private Lease<InstanceInfo> leaseInfo;

   public RecentlyChangedItem(Lease<InstanceInfo> lease) {
       this.leaseInfo = lease;
       lastUpdateTime = System.currentTimeMillis();
   }

   public long getLastUpdateTime() {
       return this.lastUpdateTime;
   }

   public Lease<InstanceInfo> getLeaseInfo() {
       return this.leaseInfo;
   }
}
```
* å½“åº”ç”¨å®ä¾‹æ³¨å†Œã€ä¸‹çº¿ã€çŠ¶æ€å˜æ›´æ—¶ï¼Œåˆ›å»ºæœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•( RecentlyChangedItem ) åˆ°é˜Ÿåˆ—ã€‚
* åå°ä»»åŠ¡å®šæ—¶**é¡ºåº**æ‰«æé˜Ÿåˆ—ï¼Œå½“ `lastUpdateTime` è¶…è¿‡ä¸€å®šæ—¶é•¿åè¿›è¡Œç§»é™¤ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // AbstractInstanceRegistry.java
    this.deltaRetentionTimer.schedule(getDeltaRetentionTask(),
                    serverConfig.getDeltaRetentionTimerIntervalInMs(),
                    serverConfig.getDeltaRetentionTimerIntervalInMs());
                    
    private TimerTask getDeltaRetentionTask() {
       return new TimerTask() {
    
           @Override
           public void run() {
               Iterator<RecentlyChangedItem> it = recentlyChangedQueue.iterator();
               while (it.hasNext()) {
                   if (it.next().getLastUpdateTime() < System.currentTimeMillis() - serverConfig.getRetentionTimeInMSInDeltaQueue()) {
                       it.remove();
                   } else {
                       break;
                   }
               }
           }
    
       };
    }
    ```
    * é…ç½® `eureka.deltaRetentionTimerIntervalInMs`ï¼Œ ç§»é™¤é˜Ÿåˆ—é‡Œè¿‡æœŸçš„ç§Ÿçº¦å˜æ›´è®°å½•çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š30 * 1000 æ¯«ç§’ã€‚
    * é…ç½® `eureka.retentionTimeInMSInDeltaQueue`ï¼Œç§Ÿçº¦å˜æ›´è®°å½•è¿‡æœŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤å€¼ ï¼š 3 * 60 * 1000 æ¯«ç§’ã€‚

## 3.3 ç¼“å­˜è¯»å–

åœ¨ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.3 ç¼“å­˜è¯»å–ã€](http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self) é‡Œï¼Œåœ¨ `#generatePayload()` æ–¹æ³•é‡Œï¼Œè°ƒç”¨ `AbstractInstanceRegistry#getApplicationDeltas(...)` æ–¹æ³•ï¼Œè·å–è¿‘æœŸå˜åŒ–çš„åº”ç”¨é›†åˆï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// AbstractInstanceRegistry.java
  1: public Applications getApplicationDeltas() {
  2:     // æ·»åŠ  å¢é‡è·å–æ¬¡æ•° åˆ° ç›‘æ§
  3:     GET_ALL_CACHE_MISS_DELTA.increment();
  4:     // åˆå§‹åŒ– å˜åŒ–çš„åº”ç”¨é›†åˆ
  5:     Applications apps = new Applications();
  6:     apps.setVersion(responseCache.getVersionDelta().get());
  7:     Map<String, Application> applicationInstancesMap = new HashMap<String, Application>();
  8:     try {
  9:         // è·å–å†™é”
 10:         write.lock();
 11:         // è·å– æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—
 12:         Iterator<RecentlyChangedItem> iter = this.recentlyChangedQueue.iterator();
 13:         logger.debug("The number of elements in the delta queue is :" + this.recentlyChangedQueue.size());
 14:         // æ‹¼è£… å˜åŒ–çš„åº”ç”¨é›†åˆ
 15:         while (iter.hasNext()) {
 16:             Lease<InstanceInfo> lease = iter.next().getLeaseInfo();
 17:             InstanceInfo instanceInfo = lease.getHolder();
 18:             Object[] args = {instanceInfo.getId(), instanceInfo.getStatus().name(), instanceInfo.getActionType().name()};
 19:             logger.debug("The instance id %s is found with status %s and actiontype %s", args);
 20:             Application app = applicationInstancesMap.get(instanceInfo.getAppName());
 21:             if (app == null) {
 22:                 app = new Application(instanceInfo.getAppName());
 23:                 applicationInstancesMap.put(instanceInfo.getAppName(), app);
 24:                 apps.addApplication(app);
 25:             }
 26:             app.addInstance(decorateInstanceInfo(lease));
 27:         }
 28: 
 29:         // TODO[0009]ï¼šRemoteRegionRegistry
 30:         boolean disableTransparentFallback = serverConfig.disableTransparentFallbackToOtherRegion();
 31:         if (!disableTransparentFallback) {
 32:             Applications allAppsInLocalRegion = getApplications(false);
 33: 
 34:             for (RemoteRegionRegistry remoteRegistry : this.regionNameVSRemoteRegistry.values()) {
 35:                 Applications applications = remoteRegistry.getApplicationDeltas();
 36:                 for (Application application : applications.getRegisteredApplications()) {
 37:                     Application appInLocalRegistry =
 38:                             allAppsInLocalRegion.getRegisteredApplications(application.getName());
 39:                     if (appInLocalRegistry == null) {
 40:                         apps.addApplication(application);
 41:                     }
 42:                 }
 43:             }
 44:         }
 45: 
 46:         // è·å–å…¨é‡åº”ç”¨é›†åˆï¼Œé€šè¿‡å®ƒè®¡ç®—ä¸€è‡´æ€§å“ˆå¸Œå€¼
 47:         Applications allApps = getApplications(!disableTransparentFallback);
 48:         apps.setAppsHashCode(allApps.getReconcileHashCode());
 49:         return apps;
 50:     } finally {
 51:         write.unlock();
 52:     }
 53: }
```

* ç¬¬ 2 è‡³ 3 è¡Œ ï¼šæ·»åŠ å¢é‡è·å–æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ [Netflix Servo](https://github.com/Netflix/servo) å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚
* ç¬¬ 4 è¡Œ ï¼šåˆå§‹åŒ–å˜åŒ–( å¢é‡ )çš„åº”ç”¨é›†åˆ( `apps` )ã€‚
* ç¬¬ 9 è¡Œ ï¼šè·å–å†™é”ã€‚åœ¨ [ã€ŠEurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”ã€‹](http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/?self) è¯¦ç»†è§£æã€‚
* ç¬¬ 11 è‡³ 13 è¡Œ ï¼šè·å–æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( `æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—` )ã€‚
* ç¬¬ 14 è‡³ 27 è¡Œ ï¼šæ‹¼è£…å˜åŒ–çš„åº”ç”¨é›†åˆ( `apps` )ã€‚
* ç¬¬ 29 è‡³ 44 è¡Œ ï¼šTODO[0009]ï¼šRemoteRegionRegistry
* ç¬¬ 46 è‡³ 48 è¡Œ ï¼šè°ƒç”¨ `#getApplications(...)` æ–¹æ³•ï¼Œè·å–**å…¨é‡**åº”ç”¨é›†åˆ( `allApps` )ï¼Œåœ¨ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹ã€Œ3.3.1 è·å¾—æ³¨å†Œçš„åº”ç”¨é›†åˆã€](http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self) æœ‰è¯¦ç»†è§£æã€‚åé€šè¿‡ `allApps` è®¡ç®—ä¸€è‡´æ€§å“ˆå¸Œå€¼ã€‚é€šè¿‡è¿™ä¸ªå…¨é‡åº”ç”¨é›†åˆçš„å“ˆå¸Œå€¼ï¼ŒEureka-Client è·å–åˆ°å¢é‡åº”ç”¨é›†åˆå¹¶åˆå¹¶åï¼Œå°±å¯ä»¥æ¯”å¯¹å•¦ã€‚
* ç¬¬ 51 è¡Œ ï¼šé‡Šæ”¾å†™é”ã€‚

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

åœ¨æ±‰å ¡ç‹å†™å®Œè¿™ç¯‡çƒ­æƒ…çš„åšå®¢ã€‚ä¸ºä»€ä¹ˆç”¨â€œçƒ­æƒ…â€è¿™ä¸ªå­—çœ¼å‘¢ï¼Ÿå¤§å¤å¤©çš„ï¼Œç«Ÿç„¶ä¸å¼€ç©ºè°ƒçš„ï¼å¯¹çš„ï¼Œæ²¡æœ‰å¼€ç©ºè°ƒï¼Œç®€ç›´æ˜¯ä¸ªå°ç«ç‚‰ã€‚æ©ï¼Œä¸è¿‡é™å¿ƒå†™å®Œè¿™ç¯‡æ–‡ç« ï¼Œè®©æˆ‘è¿˜æ˜¯æŒºå—¨çš®çš„ã€‚

èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( **èŠ‹é“æºç ** ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ


