title: Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆä¸‰ï¼‰ä¹‹ä¸‹çº¿
date: 2018-06-08
tags:
categories: Eureka
permalink: Eureka/instance-registry-cancel

---

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-cancel/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬** 

- [1. æ¦‚è¿°](http://www.iocoder.cn/Eureka/instance-registry-cancel/)
- [2. Eureka-Client å‘èµ·ä¸‹çº¿](http://www.iocoder.cn/Eureka/instance-registry-cancel/)
- [3. Eureka-Server æ¥æ”¶ä¸‹çº¿](http://www.iocoder.cn/Eureka/instance-registry-cancel/)
  - [3.1 æ¥æ”¶ä¸‹çº¿è¯·æ±‚](http://www.iocoder.cn/Eureka/instance-registry-cancel/)
  - [3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯](http://www.iocoder.cn/Eureka/instance-registry-cancel/)
- [666. å½©è›‹](http://www.iocoder.cn/Eureka/instance-registry-cancel/)

---

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Eureka-Client å‘ Eureka-Server ä¸‹çº¿åº”ç”¨å®ä¾‹çš„è¿‡ç¨‹**ã€‚

> FROM [ã€Šæ·±åº¦å‰–ææœåŠ¡å‘ç°ç»„ä»¶Netflix Eurekaã€‹](ã€Šhttp://techshow.ctrip.com/archives/1699.htmlã€‹) äºŒæ¬¡ç¼–è¾‘    
> ![](http://www.iocoder.cn/images/Eureka/2018_06_08/01.jpeg)

* **è“æ¡†**éƒ¨åˆ†ï¼Œä¸ºæœ¬æ–‡é‡ç‚¹ã€‚
* é**è“æ¡†**éƒ¨åˆ†ï¼ŒEureka-Server é›†ç¾¤é—´å¤åˆ¶æ³¨å†Œçš„åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œä¸åœ¨æœ¬æ–‡å†…å®¹èŒƒç•´ã€‚

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)



# 2. Eureka-Client å‘èµ·ä¸‹çº¿

åº”ç”¨å®ä¾‹å…³é—­æ—¶ï¼ŒEureka-Client å‘ Eureka-Server å‘èµ·ä¸‹çº¿åº”ç”¨å®ä¾‹ã€‚éœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶æ‰å¯å‘èµ·ï¼š

* é…ç½® `eureka.registration.enabled = true` ï¼Œåº”ç”¨å®ä¾‹å¼€å¯æ³¨å†Œå¼€å…³ã€‚é»˜è®¤ä¸º `false` ã€‚
* é…ç½® `eureka.shouldUnregisterOnShutdown = true` ï¼Œåº”ç”¨å®ä¾‹å¼€å¯å…³é—­æ—¶ä¸‹çº¿å¼€å…³ã€‚é»˜è®¤ä¸º `true` ã€‚

å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// DiscoveryClient.java
public synchronized void shutdown() {

    // ... çœç•¥æ— å…³ä»£ç 

    // If APPINFO was registered
    if (applicationInfoManager != null
         && clientConfig.shouldRegisterWithEureka() // eureka.registration.enabled = true
         && clientConfig.shouldUnregisterOnShutdown()) { // eureka.shouldUnregisterOnShutdown = true
        applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);
        unregister();
    }
}
```

* è°ƒç”¨ `ApplicationInfoManager#setInstanceStatus(...)` æ–¹æ³•ï¼Œè®¾ç½®åº”ç”¨å®ä¾‹ä¸ºå…³é—­( DOWN )ã€‚
* è°ƒç”¨ `#unregister()` æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // DiscoveryClient.java
    void unregister() {
       // It can be null if shouldRegisterWithEureka == false
       if(eurekaTransport != null && eurekaTransport.registrationClient != null) {
           try {
               logger.info("Unregistering ...");
               EurekaHttpResponse<Void> httpResponse = eurekaTransport.registrationClient.cancel(instanceInfo.getAppName(), instanceInfo.getId());
               logger.info(PREFIX + appPathIdentifier + " - deregister  status: " + httpResponse.getStatusCode());
           } catch (Exception e) {
               logger.error(PREFIX + appPathIdentifier + " - de-registration failed" + e.getMessage(), e);
           }
       }
    }
    
    // AbstractJerseyEurekaHttpClient.java
    @Override
    public EurekaHttpResponse<Void> cancel(String appName, String id) {
        String urlPath = "apps/" + appName + '/' + id;
        ClientResponse response = null;
        try {
            Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();
            addExtraHeaders(resourceBuilder);
            response = resourceBuilder.delete(ClientResponse.class);
            return anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();
        } finally {
            if (logger.isDebugEnabled()) {
                logger.debug("Jersey HTTP DELETE {}/{}; statusCode={}", serviceUrl, urlPath, response == null ? "N/A" : response.getStatus());
            }
            if (response != null) {
                response.close();
            }
        }
    }
    ```
    * è°ƒç”¨ `AbstractJerseyEurekaHttpClient#cancel(...)` æ–¹æ³•ï¼Œ`DELETE` è¯·æ±‚ Eureka-Server çš„ `apps/${APP_NAME}/${INSTANCE_INFO_ID}` æ¥å£ï¼Œå®ç°åº”ç”¨å®ä¾‹ä¿¡æ¯çš„ä¸‹çº¿ã€‚

# 3. Eureka-Server æ¥æ”¶ä¸‹çº¿

## 3.1 æ¥æ”¶ä¸‹çº¿è¯·æ±‚

`com.netflix.eureka.resources.InstanceResource`ï¼Œå¤„ç†**å•ä¸ª**åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚æ“ä½œçš„ Resource ( Controller )ã€‚

ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯çš„è¯·æ±‚ï¼Œæ˜ å°„ `InstanceResource#cancelLease()` æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
@DELETE
public Response cancelLease(
       @HeaderParam(PeerEurekaNode.HEADER_REPLICATION) String isReplication) {
   // ä¸‹çº¿
   boolean isSuccess = registry.cancel(app.getName(), id, "true".equals(isReplication));

   if (isSuccess) { // ä¸‹çº¿æˆåŠŸ
       logger.debug("Found (Cancel): " + app.getName() + " - " + id);
       return Response.ok().build();
   } else { // ä¸‹çº¿æˆåŠŸ
       logger.info("Not Found (Cancel): " + app.getName() + " - " + id);
       return Response.status(Status.NOT_FOUND).build();
   }
}
```

* è°ƒç”¨ `PeerAwareInstanceRegistryImpl#cancel(...)` æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
      1: @Override
      2: public boolean cancel(final String appName, final String id,
      3:                       final boolean isReplication) {
      4:     if (super.cancel(appName, id, isReplication)) { // ä¸‹çº¿
      5:         // Eureka-Server å¤åˆ¶
      6:         replicateToPeers(Action.Cancel, appName, id, null, null, isReplication);
      7:         // å‡å°‘ `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`
      8:         synchronized (lock) {
      9:             if (this.expectedNumberOfRenewsPerMin > 0) {
     10:                 // Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)
     11:                 this.expectedNumberOfRenewsPerMin = this.expectedNumberOfRenewsPerMin - 2;
     12:                 this.numberOfRenewsPerMinThreshold = (int) (this.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());
     13:             }
     14:         }
     15:         return true;
     16:     }
     17:     return false;
     18: }
    ```
    * ç¬¬ 4 è¡Œ ï¼šè°ƒç”¨çˆ¶ç±» `AbstractInstanceRegistry#cancel(...)` æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ã€‚
    * ç¬¬ 6 è¡Œ ï¼šEureka-Server å¤åˆ¶ä¸‹çº¿æ“ä½œï¼Œåœ¨ [ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹](http://www.iocoder.cn/Eureka/server-cluster/?self) æœ‰è¯¦ç»†è§£æã€‚
    * ç¬¬ 7 è‡³ 14 è¡Œ ï¼šå‡å°‘ `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`ï¼Œè‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ç›¸å…³ï¼Œåœ¨ [ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/?self) æœ‰è¯¦ç»†è§£æã€‚

## 3.2 ä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯

è°ƒç”¨ `AbstractInstanceRegistry#cancel(...)` æ–¹æ³•ï¼Œä¸‹çº¿åº”ç”¨å®ä¾‹ä¿¡æ¯ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
  1: @Override
  2: public boolean cancel(String appName, String id, boolean isReplication) {
  3:     return internalCancel(appName, id, isReplication);
  4: }
  5: 
  6: protected boolean internalCancel(String appName, String id, boolean isReplication) {
  7:     try {
  8:         // è·å¾—è¯»é”
  9:         read.lock();
 10:         // å¢åŠ  å–æ¶ˆæ³¨å†Œæ¬¡æ•° åˆ° ç›‘æ§
 11:         CANCEL.increment(isReplication);
 12:         // ç§»é™¤ ç§Ÿçº¦æ˜ å°„
 13:         Map<String, Lease<InstanceInfo>> gMap = registry.get(appName);
 14:         Lease<InstanceInfo> leaseToCancel = null;
 15:         if (gMap != null) {
 16:             leaseToCancel = gMap.remove(id);
 17:         }
 18:         // æ·»åŠ åˆ° æœ€è¿‘å–æ¶ˆæ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—
 19:         synchronized (recentCanceledQueue) {
 20:             recentCanceledQueue.add(new Pair<Long, String>(System.currentTimeMillis(), appName + "(" + id + ")"));
 21:         }
 22:         // ç§»é™¤ åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„
 23:         InstanceStatus instanceStatus = overriddenInstanceStatusMap.remove(id);
 24:         if (instanceStatus != null) {
 25:             logger.debug("Removed instance id {} from the overridden map which has value {}", id, instanceStatus.name());
 26:         }
 27:         // ç§Ÿçº¦ä¸å­˜åœ¨
 28:         if (leaseToCancel == null) {
 29:             CANCEL_NOT_FOUND.increment(isReplication); // æ·»åŠ  å–æ¶ˆæ³¨å†Œä¸å­˜åœ¨ åˆ° ç›‘æ§
 30:             logger.warn("DS: Registry: cancel failed because Lease is not registered for: {}/{}", appName, id);
 31:             return false; // å¤±è´¥
 32:         } else {
 33:             // è®¾ç½® ç§Ÿçº¦çš„å–æ¶ˆæ³¨å†Œæ—¶é—´æˆ³
 34:             leaseToCancel.cancel();
 35:             // æ·»åŠ åˆ° æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—
 36:             InstanceInfo instanceInfo = leaseToCancel.getHolder();
 37:             String vip = null;
 38:             String svip = null;
 39:             if (instanceInfo != null) {
 40:                 instanceInfo.setActionType(ActionType.DELETED);
 41:                 recentlyChangedQueue.add(new RecentlyChangedItem(leaseToCancel));
 42:                 instanceInfo.setLastUpdatedTimestamp();
 43:                 vip = instanceInfo.getVIPAddress();
 44:                 svip = instanceInfo.getSecureVipAddress();
 45:             }
 46:             // è®¾ç½® å“åº”ç¼“å­˜ è¿‡æœŸ
 47:             invalidateCache(appName, vip, svip);
 48:             logger.info("Cancelled instance {}/{} (replication={})", appName, id, isReplication);
 49:             return true; // æˆåŠŸ
 50:         }
 51:     } finally {
 52:         // é‡Šæ”¾é”
 53:         read.unlock();
 54:     }
 55: }
```

* ç¬¬ 9 è¡Œ ï¼šè·å–è¯»é”ã€‚åœ¨ [ã€ŠEurekaæºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¹ï¼‰ä¹‹å²æœˆæ˜¯æŠŠèŒèŒçš„è¯»å†™é”ã€‹](http://www.iocoder.cn/Eureka/instance-registry-read-write-lock/?self) è¯¦ç»†è§£æã€‚
* ç¬¬ 10 è‡³ 11 è¡Œ ï¼šå¢åŠ ä¸‹çº¿æ¬¡æ•°åˆ°ç›‘æ§ã€‚é…åˆ [Netflix Servo](https://github.com/Netflix/servo) å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚
* ç¬¬ 12 è‡³ 17 è¡Œ ï¼šç§»é™¤ç§Ÿçº¦æ˜ å°„( `registry` )ã€‚
* ç¬¬ 18 è‡³ 21 è¡Œ ï¼šæ·»åŠ åˆ°æœ€è¿‘ä¸‹çº¿çš„**è°ƒè¯•**é˜Ÿåˆ—( `recentCanceledQueue` )ï¼Œç”¨äº Eureka-Server è¿ç»´ç•Œé¢çš„æ˜¾ç¤ºï¼Œæ— å®é™…ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    /**
    * æœ€è¿‘å–æ¶ˆæ³¨å†Œçš„è°ƒè¯•é˜Ÿåˆ—
    * key ï¼šæ·»åŠ æ—¶çš„æ—¶é—´æˆ³
    * value ï¼šå­—ç¬¦ä¸² = åº”ç”¨å(åº”ç”¨å®ä¾‹ä¿¡æ¯ç¼–å·)
    */
    private final CircularQueue<Pair<Long, String>> recentCanceledQueue;
    ```

* ç¬¬ 22 è‡³ 26 è¡Œ ï¼šç§»é™¤åº”ç”¨å®ä¾‹è¦†ç›–çŠ¶æ€æ˜ å°„ã€‚åœ¨[ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…«ï¼‰ä¹‹è¦†ç›–çŠ¶æ€ã€‹](http://www.iocoder.cn/Eureka/instance-registry-override-status/?self)è¯¦ç»†è§£æã€‚
* ç¬¬ 27 è‡³ 31 è¡Œ ï¼šç§Ÿçº¦ä¸å­˜åœ¨ï¼Œè¿”å›ä¸‹çº¿å¤±è´¥( `false` )ã€‚
* ç¬¬ 34 è¡Œ ï¼šè°ƒç”¨ `Lease#cancel()` æ–¹æ³•ï¼Œå–æ¶ˆç§Ÿçº¦ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // Lease.java
    public void cancel() {
       if (evictionTimestamp <= 0) {
           evictionTimestamp = System.currentTimeMillis();
       }
    }
    ```

* ç¬¬ 35 è‡³ 45 è¡Œ ï¼šè®¾ç½®åº”ç”¨å®ä¾‹ä¿¡æ¯çš„**æ“ä½œç±»å‹ä¸ºæ·»åŠ **ï¼Œå¹¶æ·»åŠ åˆ°æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—( `recentlyChangedQueue` )ã€‚`recentlyChangedQueue` ç”¨äºæ³¨å†Œä¿¡æ¯çš„**å¢é‡**è·å–ï¼Œåœ¨[ã€Šåº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆä¸ƒï¼‰ä¹‹å¢é‡è·å–ã€‹](http://www.iocoder.cn/Eureka/instance-registry-fetch-delta/?self)è¯¦ç»†è§£æã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    /**
    * æœ€è¿‘ç§Ÿçº¦å˜æ›´è®°å½•é˜Ÿåˆ—
    */
    private ConcurrentLinkedQueue<RecentlyChangedItem> recentlyChangedQueue = new ConcurrentLinkedQueue<RecentlyChangedItem>();
    ```

* ç¬¬ 47 è¡Œ ï¼šè®¾ç½®å“åº”ç¼“å­˜( ResponseCache )è¿‡æœŸï¼Œåœ¨[ã€ŠEureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç° ï¼ˆå…­ï¼‰ä¹‹å…¨é‡è·å–ã€‹](http://www.iocoder.cn/Eureka/instance-registry-fetch-all/?self)è¯¦ç»†è§£æã€‚
* ç¬¬ 49 è¡Œ ï¼šè¿”å›ä¸‹çº¿å¤±è´¥( `false` )ã€‚
* ç¬¬ 53 è¡Œ ï¼šé‡Šæ”¾é”ã€‚

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

æ°´æ›´ä¸€ç¯‡ï¼Œä¸‹ä¸€ç¯‡**ç§Ÿçº¦è¿‡æœŸ**ï¼èµ°èµ·ã€‚

èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( **èŠ‹é“æºç ** ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ


