title: Eureka æºç è§£æ â€”â€” ç½‘ç»œé€šä¿¡
date: 2018-07-31
tags:
categories: Eureka
permalink: Eureka/transport
wechat_url: https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247484850&idx=2&sn=de455f3fa1f1e72f1e555f8c15b496b4&chksm=fa497a03cd3ef315f056c34370d137c6c571630efc06a28e2c4af707028c8b498a9ef2e7bb79#rd

---

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/transport/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬**

- [1. æ¦‚è¿°](http://www.iocoder.cn/Eureka/transport/)
- [2. EurekaHttpClient](http://www.iocoder.cn/Eureka/transport/)
  - [2.1 EurekaJerseyClientImpl](http://www.iocoder.cn/Eureka/transport/)
  - [2.2 EurekaJerseyClientBuilder](http://www.iocoder.cn/Eureka/transport/)
- [3. EurekaHttpClient](http://www.iocoder.cn/Eureka/transport/)
  - [3.1 EurekaHttpResponse](http://www.iocoder.cn/Eureka/transport/)
  - [3.2 TransportClientFactory](http://www.iocoder.cn/Eureka/transport/)
- [4. AbstractJerseyEurekaHttpClient](http://www.iocoder.cn/Eureka/transport/)
  - [4.1 JerseyApplicationClient](http://www.iocoder.cn/Eureka/transport/)
  - [4.2 JerseyReplicationClient](http://www.iocoder.cn/Eureka/transport/)
- [5. EurekaHttpClientDecorator](http://www.iocoder.cn/Eureka/transport/)
  - [5.1 MetricsCollectingEurekaHttpClient](http://www.iocoder.cn/Eureka/transport/)
  - [5.2 RedirectingEurekaHttpClient](http://www.iocoder.cn/Eureka/transport/)
  - [5.3 RetryableEurekaHttpClient](http://www.iocoder.cn/Eureka/transport/)
  - [5.4 SessionedEurekaHttpClient](http://www.iocoder.cn/Eureka/transport/)
- [6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯](http://www.iocoder.cn/Eureka/transport/)
- [666. å½©è›‹](http://www.iocoder.cn/Eureka/transport/)

-------

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **Eureka çš„ç½‘ç»œé€šä¿¡éƒ¨åˆ†**ã€‚åœ¨ä¸è€ƒè™‘ Eureka 2.x çš„å…¼å®¹çš„æƒ…å†µä¸‹ï¼ŒEureka 1.x ä¸»è¦ä¸¤éƒ¨åˆ†çš„ç½‘ç»œé€šä¿¡ï¼š

* Eureka-Client è¯·æ±‚ Eureka-Server çš„ç½‘ç»œé€šä¿¡
* Eureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ **å…¶å®ƒçš„Eureka-Server** çš„ç½‘ç»œé€šä¿¡

æœ¬æ–‡æ¶‰åŠç±»åœ¨ `com.netflix.discovery.shared.transport` åŒ…ä¸‹ï¼Œæ¶‰åŠåˆ°ä¸»ä½“ç±»çš„ç±»å›¾å¦‚ä¸‹( [æ‰“å¼€å¤§å›¾](http://www.iocoder.cn/images/Eureka/2018_07_31/01.png) )ï¼š

![](http://www.iocoder.cn/images/Eureka/2018_07_31/01.png)

* ç²‰è‰²éƒ¨åˆ† â€”â€” EurekaJerseyClient ï¼Œå¯¹åŸºäº Jersey Server çš„ Eureka-Server çš„ Jersey å®¢æˆ·ç«¯å°è£…ã€‚
* ç»¿è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient ï¼ŒEureka-Server HTTP è®¿é—®å®¢æˆ·ç«¯ï¼Œå®šä¹‰äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚å¦‚æœæŠŠ DiscoveryClient ç±»æ¯”æˆ Service ï¼Œé‚£ä¹ˆ EurekaHttpClient å¯ä»¥ç±»æ¯”åŸ Dao ã€‚
* ç»¼è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient å®ç°ç±»ï¼Œ**çœŸæ­£**å®ç°äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚
* çº¢è‰²éƒ¨åˆ† â€”â€” EurekaHttpClient å§”æ‰˜ç±»ï¼Œæä¾›äº†**ä¼šè¯ã€é‡è¯•ã€é‡å®šå‘ã€ç›‘æ§æŒ‡æ ‡æ”¶é›†**ç­‰ç‰¹æ€§ã€‚
* é»„è‰²éƒ¨åˆ† â€”â€” EurekaHttpClientFactoryï¼Œç”¨äºåˆ›å»º EurekaHttpClient ã€‚

ç±»å›¾çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œæ•´ä½“è°ƒç”¨å…³ç³»å¦‚ä¸‹( [æ‰“å¼€å¤§å›¾](http://www.iocoder.cn/images/Eureka/2018_07_31/02.png) )ï¼š

![](http://www.iocoder.cn/images/Eureka/2018_07_31/02.png)

OK ï¼Œæˆ‘ä»¬é€å±‚è§£æï¼Œå—¨èµ·æ¥ã€‚

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)
* ä¸¤ä¹¦é½ä¹°ï¼Œäº¬ä¸œåŒ…é‚®ã€‚



# 2. EurekaHttpClient

`com.netflix.discovery.shared.transport.jersey.EurekaJerseyClient` ï¼ŒEurekaHttpClient **æ¥å£**ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š

```Java
public interface EurekaJerseyClient {

    ApacheHttpClient4 getClient();
    
    void destroyResources();
}
```

* `com.sun.jersey.client.apache4.ApacheHttpClient4` ï¼ŒåŸºäº Apache HttpClient4 å®ç°çš„ Jersey Client ã€‚

## 2.1 EurekaJerseyClientImpl

`com.netflix.discovery.shared.transport.jersey.EurekaJerseyClientImpl` ï¼ŒEurekaHttpClient **å®ç°ç±»**ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
public class EurekaJerseyClientImpl implements EurekaJerseyClient {

    /**
     * åŸºäº Apache HttpClient4 å®ç°çš„ Jersey Client
     */
    private final ApacheHttpClient4 apacheHttpClient;
    /**
     * Apache HttpClient ç©ºé—²è¿æ¥æ¸…ç†å™¨
     */
    private final ApacheHttpClientConnectionCleaner apacheHttpClientConnectionCleaner;

    /**
     * Jersey Client é…ç½®
     */
    ClientConfig jerseyClientConfig;

    public EurekaJerseyClientImpl(int connectionTimeout, int readTimeout, final int connectionIdleTimeout,
                                  ClientConfig clientConfig) {
        try {
            jerseyClientConfig = clientConfig;
            // åˆ›å»º  ApacheHttpClient
            apacheHttpClient = ApacheHttpClient4.create(jerseyClientConfig);

            // è®¾ç½® è¿æ¥å‚æ•°
            HttpParams params = apacheHttpClient.getClientHandler().getHttpClient().getParams();
            HttpConnectionParams.setConnectionTimeout(params, connectionTimeout);
            HttpConnectionParams.setSoTimeout(params, readTimeout);

            // åˆ›å»º ApacheHttpClientConnectionCleaner
            this.apacheHttpClientConnectionCleaner = new ApacheHttpClientConnectionCleaner(apacheHttpClient, connectionIdleTimeout);
        } catch (Throwable e) {
            throw new RuntimeException("Cannot create Jersey client", e);
        }
    }

    @Override
    public ApacheHttpClient4 getClient() {
        return apacheHttpClient;
    }

    @Override
    public void destroyResources() {
        apacheHttpClientConnectionCleaner.shutdown();
        apacheHttpClient.destroy();
    }
}
```

* `com.netflix.discovery.shared.transport.jersey.ApacheHttpClientConnectionCleaner` ï¼ŒApache HttpClient ç©ºé—²è¿æ¥æ¸…ç†å™¨ï¼Œè´Ÿè´£**å‘¨æœŸæ€§**å…³é—­å¤„äº `half-close` çŠ¶æ€çš„ç©ºé—²è¿æ¥ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/ApacheHttpClientConnectionCleaner.java) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ ApacheHttpClientConnectionCleanerã€‚æ¨èé˜…è¯»ï¼š[ã€ŠHttpClientå®¹æ˜“å¿½è§†çš„ç»†èŠ‚â€”â€”è¿æ¥å…³é—­ã€‹](http://seanhe.iteye.com/blog/234759) ã€‚

## 2.2 EurekaJerseyClientBuilder

EurekaJerseyClientBuilder ï¼ŒEurekaJerseyClientImpl **å†…éƒ¨ç±»**ï¼Œç”¨äºåˆ›å»º EurekaJerseyClientImpl ã€‚

è°ƒç”¨ `#build()` æ–¹æ³•ï¼Œåˆ›å»º EurekaJerseyClientImpl ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// EurekaJerseyClientBuilder.java
public EurekaJerseyClient build() {
    MyDefaultApacheHttpClient4Config config = new MyDefaultApacheHttpClient4Config();
    try {
        return new EurekaJerseyClientImpl(connectionTimeout, readTimeout, connectionIdleTimeout, config);
    } catch (Throwable e) {
        throw new RuntimeException("Cannot create Jersey client ", e);
    }
}
```
* MyDefaultApacheHttpClient4Config ï¼Œç»§æ‰¿è‡ª `com.sun.jersey.client.apache4.config.DefaultApacheHttpClient4Config` ï¼Œå®ç°**è‡ªå®šä¹‰é…ç½®**ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/EurekaJerseyClientImpl.java#L199) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ MyDefaultApacheHttpClient4Configã€‚ä¾‹å¦‚ ï¼š
    * è‡ªå®šä¹‰çš„**è¯·æ±‚ã€å“åº”çš„ç¼–è§£ç å™¨** `com.netflix.discovery.provider.DiscoveryJerseyProvider` ã€‚
    * ç¦ç”¨**é‡å®šå‘**ï¼Œä½¿ç”¨ RedirectingEurekaHttpClient å®ç°è¯¥ç‰¹æ€§ã€‚
    * è‡ªå®šä¹‰ UserAgent ã€‚
    * è‡ªå®šä¹‰ Http Proxy ã€‚
    * SSL åŠŸèƒ½çš„å¢å¼ºã€‚ApacheHttpClient4 ä½¿ç”¨çš„æ˜¯ Apache HttpClient 4.1.1 ç‰ˆæœ¬ï¼Œ`com.netflix.discovery.shared.transport.jersey.SSLSocketFactoryAdapter` å°† Apache HttpClient 4.3.4 å¯¹ SSL åŠŸèƒ½çš„å¢å¼ºé€‚é…åˆ°è€ç‰ˆæœ¬ API ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/SSLSocketFactoryAdapter.java) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ SSLSocketFactoryAdapterã€‚

# 3. EurekaHttpClient

`com.netflix.discovery.shared.transport.EurekaHttpClient` ï¼ŒEureka-Server HTTP è®¿é—®å®¢æˆ·ç«¯ï¼Œå®šä¹‰äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³• ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/045686e7461ddac93384161eb342e89c3249dc69/eureka-client/src/main/java/com/netflix/discovery/shared/transport/EurekaHttpClient.java) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ EurekaHttpClientã€‚

## 3.1 EurekaHttpResponse

`com.netflix.discovery.shared.transport.EurekaHttpResponse` ï¼Œè¯·æ±‚å“åº”å¯¹è±¡ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
public class EurekaHttpResponse<T> {

    /**
     * è¿”å›çŠ¶æ€ç 
     */
    private final int statusCode;
    /**
     * è¿”å›å¯¹è±¡( Entity )
     */
    private final T entity;
    /**
     * è¿”å› header
     */
    private final Map<String, String> headers;
    /**
     * é‡å®šå‘åœ°å€
     */
    private final URI location;
    
    // ... çœç•¥ setting / getting å’Œ Builder
}
```

## 3.2 TransportClientFactory

`com.netflix.discovery.shared.transport.TransportClientFactory` ï¼Œåˆ›å»º EurekaHttpClient çš„å·¥å‚**æ¥å£**ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š

```Java
public interface TransportClientFactory {

    /**
     * åˆ›å»º EurekaHttpClient
     *
     * @param serviceUrl Eureka-Server åœ°å€
     * @return EurekaHttpClient
     */
    EurekaHttpClient newClient(EurekaEndpoint serviceUrl);

    /**
     * å…³é—­å·¥å‚
     */
    void shutdown();

}
```

**å¤§å¤šæ•° EurekaHttpClient å®ç°ç±»éƒ½æœ‰å…¶å¯¹åº”çš„å·¥å‚å®ç°ç±»**ã€‚



# 4. AbstractJerseyEurekaHttpClient

`com.netflix.discovery.shared.transport.jersey.AbstractJerseyEurekaHttpClient` ï¼Œå®ç° EurekaHttpClient çš„**æŠ½è±¡ç±»**ï¼Œ**çœŸæ­£**å®ç°äº†å…·ä½“çš„ Eureka-Server API è°ƒç”¨æ–¹æ³•ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
  1: public abstract class AbstractJerseyEurekaHttpClient implements EurekaHttpClient {
  2: 
  3: private static final Logger logger = LoggerFactory.getLogger(AbstractJerseyEurekaHttpClient.class);
  4: 
  5: /**
  6:  * Jersey Client
  7:  */
  8: protected final Client jerseyClient;
  9: /**
 10:  * è¯·æ±‚çš„ Eureka-Server åœ°å€
 11:  */
 12: protected final String serviceUrl;
 13: 
 14: protected AbstractJerseyEurekaHttpClient(Client jerseyClient, String serviceUrl) {
 15:     this.jerseyClient = jerseyClient;
 16:     this.serviceUrl = serviceUrl;
 17:     logger.debug("Created client for url: {}", serviceUrl);
 18: }
 19: 
 20: @Override
 21: public EurekaHttpResponse<Void> register(InstanceInfo info) {
 22:     // è®¾ç½® è¯·æ±‚åœ°å€
 23:     String urlPath = "apps/" + info.getAppName();
 24:     ClientResponse response = null;
 25:     try {
 26:         Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();
 27:         // è®¾ç½® è¯·æ±‚å¤´
 28:         addExtraHeaders(resourceBuilder);
 29:         // è¯·æ±‚ Eureka-Server
 30:         response = resourceBuilder
 31:                 .header("Accept-Encoding", "gzip") // GZIP
 32:                 .type(MediaType.APPLICATION_JSON_TYPE) // è¯·æ±‚å‚æ•°æ ¼å¼ JSON
 33:                 .accept(MediaType.APPLICATION_JSON) // å“åº”ç»“æœæ ¼å¼ JSON
 34:                 .post(ClientResponse.class, info); // è¯·æ±‚å‚æ•°
 35:         // åˆ›å»º EurekaHttpResponse
 36:         return anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();
 37:     } finally {
 38:         if (logger.isDebugEnabled()) {
 39:             logger.debug("Jersey HTTP POST {}/{} with instance {}; statusCode={}", serviceUrl, urlPath, info.getId(),
 40:                     response == null ? "N/A" : response.getStatus());
 41:         }
 42:         if (response != null) {
 43:             response.close();
 44:         }
 45:     }
 46: }
```

* `jerseyClient` å±æ€§ï¼ŒJersey Client ï¼Œä½¿ç”¨ä¸Šæ–‡çš„ `EurekaHttpClient#getClient(...)` æ–¹æ³•ï¼Œè·å– ApacheHttpClient4 ã€‚
* `serviceUrl` å±æ€§ï¼Œè¯·æ±‚çš„ Eureka-Server åœ°å€ã€‚
* `#register()` æ–¹æ³•ï¼Œå®ç°å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹ã€‚**å…¶ä»–æ–¹æ³•ä»£ç ç±»ä¼¼**ã€‚
    * ç¬¬ 22 è‡³ 26 è¡Œ ï¼šè®¾ç½®è¯·æ±‚åœ°å€ã€‚
    * ç¬¬ 28 è¡Œ ï¼šè°ƒç”¨ `#addExtraHeaders(...)` æ–¹æ³•ï¼Œè®¾ç½®è¯·æ±‚å¤´( header  )ã€‚è¯¥æ–¹æ³•æ˜¯**æŠ½è±¡æ–¹æ³•**ï¼Œæä¾›å­ç±»å®ç°è‡ªå®šä¹‰çš„è¯·æ±‚å¤´ã€‚ä»£ç å¦‚ä¸‹ï¼š

        ```Java
        protected abstract void addExtraHeaders(Builder webResource);
        ```
        * x
   * ç¬¬ 29 è‡³ 34 è¡Œ ï¼šè¯·æ±‚ Eureka-Server ã€‚
   * ç¬¬ 35 è‡³ 36 è¡Œ ï¼šè§£æå“åº”ç»“æœï¼Œåˆ›å»º EurekaHttpResponse ã€‚

## 4.1 JerseyApplicationClient

`com.netflix.discovery.shared.transport.jersey.JerseyApplicationClient` ï¼Œå®ç° Eureka-Client è¯·æ±‚ Eureka-Server çš„ç½‘ç»œé€šä¿¡ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/69993ad1e80d45c43ac8585921eca4efb88b09b9/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/JerseyApplicationClient.java) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ JerseyApplicationClientã€‚

### 4.1.1 JerseyEurekaHttpClientFactory

`com.netflix.discovery.shared.transport.jersey.JerseyEurekaHttpClientFactory` ï¼Œåˆ›å»º JerseyApplicationClient çš„**å·¥å‚ç±»**ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
public class JerseyEurekaHttpClientFactory implements TransportClientFactory {
    
    private final EurekaJerseyClient jerseyClient;
    private final ApacheHttpClient4 apacheClient;
    private final ApacheHttpClientConnectionCleaner cleaner;
    private final Map<String, String> additionalHeaders;
    
    public JerseyEurekaHttpClientFactory(ApacheHttpClient4 apacheClient, long connectionIdleTimeout, Map<String, String> additionalHeaders) {
        this(null, apacheClient, connectionIdleTimeout, additionalHeaders);
    }

    private JerseyEurekaHttpClientFactory(EurekaJerseyClient jerseyClient,
                                          ApacheHttpClient4 apacheClient,
                                          long connectionIdleTimeout,
                                          Map<String, String> additionalHeaders) {
        this.jerseyClient = jerseyClient;
        this.apacheClient = jerseyClient != null ? jerseyClient.getClient() : apacheClient;
        this.additionalHeaders = additionalHeaders;
        this.cleaner = new ApacheHttpClientConnectionCleaner(this.apacheClient, connectionIdleTimeout);
    }
    
    @Override
    public EurekaHttpClient newClient(EurekaEndpoint endpoint) {
        return new JerseyApplicationClient(apacheClient, endpoint.getServiceUrl(), additionalHeaders);
    }

    @Override
    public void shutdown() {
        cleaner.shutdown();
        if (jerseyClient != null) {
            jerseyClient.destroyResources();
        } else {
            apacheClient.destroy();
        }
    }
}
```

### 4.1.2 JerseyEurekaHttpClientFactoryBuilder

JerseyEurekaHttpClientFactoryBuilder ï¼ŒJerseyEurekaHttpClientFactory **å†…éƒ¨ç±»**ï¼Œç”¨äºåˆ›å»º JerseyEurekaHttpClientFactory ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/ff48fa728c7085ad8116517ede88398b0fd693c7/eureka-client/src/main/java/com/netflix/discovery/shared/transport/jersey/JerseyEurekaHttpClientFactory.java#L152) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ JerseyEurekaHttpClientFactoryã€‚

è°ƒç”¨ `JerseyEurekaHttpClientFactory#create(...)` æ–¹æ³•ï¼Œåˆ›å»º JerseyEurekaHttpClientFactory ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
public static JerseyEurekaHttpClientFactory create(EurekaClientConfig clientConfig,
                                                  Collection<ClientFilter> additionalFilters,
                                                  InstanceInfo myInstanceInfo,
                                                  AbstractEurekaIdentity clientIdentity) {
   JerseyEurekaHttpClientFactoryBuilder clientBuilder = newBuilder()
           .withAdditionalFilters(additionalFilters) // å®¢æˆ·ç«¯é™„åŠ è¿‡æ»¤å™¨
           .withMyInstanceInfo(myInstanceInfo) // åº”ç”¨å®ä¾‹
           .withUserAgent("Java-EurekaClient") // UA
           .withClientConfig(clientConfig)
           .withClientIdentity(clientIdentity);

   // è®¾ç½® Client Name
   if ("true".equals(System.getProperty("com.netflix.eureka.shouldSSLConnectionsUseSystemSocketFactory"))) {
       clientBuilder.withClientName("DiscoveryClient-HTTPClient-System").withSystemSSLConfiguration();
   } else if (clientConfig.getProxyHost() != null && clientConfig.getProxyPort() != null) {
       clientBuilder.withClientName("Proxy-DiscoveryClient-HTTPClient")
               .withProxy(
                       clientConfig.getProxyHost(), Integer.parseInt(clientConfig.getProxyPort()),
                       clientConfig.getProxyUserName(), clientConfig.getProxyPassword()
               ); // http proxy
   } else {
       clientBuilder.withClientName("DiscoveryClient-HTTPClient");
   }

   return clientBuilder.build();
}

public static JerseyEurekaHttpClientFactoryBuilder newBuilder() {
   return new JerseyEurekaHttpClientFactoryBuilder().withExperimental(false);
}
```

## 4.2 JerseyReplicationClient

`com.netflix.eureka.transport.JerseyReplicationClient` ï¼ŒEureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ **å…¶å®ƒçš„Eureka-Server** çš„ç½‘ç»œé€šä¿¡ã€‚

* å®ç° `AbstractJerseyEurekaHttpClient#addExtraHeaders()` æ–¹æ³•ï¼Œæ·»åŠ è‡ªå®šä¹‰å¤´ `x-netflix-discovery-replication=true` ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```Java
    @Override
    protected void addExtraHeaders(Builder webResource) {
       webResource.header(PeerEurekaNode.HEADER_REPLICATION, "true");
    }
    ```

* é‡å†™äº† `#sendHeartBeat(...)` æ–¹æ³•ï¼Œåœ¨ [ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹](http://www.iocoder.cn/Eureka/server-cluster/?self) æœ‰è¯¦ç»†è§£æã€‚
* å®ç° `com.netflix.eureka.cluster.HttpReplicationClient` æ¥å£ï¼Œå®ç°äº† `#submitBatchUpdates(...)` æ–¹æ³•ï¼Œåœ¨ [ã€ŠEureka æºç è§£æ â€”â€” Eureka-Server é›†ç¾¤åŒæ­¥ã€‹](http://www.iocoder.cn/Eureka/server-cluster/?self) æœ‰è¯¦ç»†è§£æã€‚

### 4.2.1 æ²¡æœ‰å·¥å‚

JerseyReplicationClient **æ²¡æœ‰ä¸“å±çš„å·¥å‚**ã€‚

è°ƒç”¨ `JerseyReplicationClient#createReplicationClient(...)` **é™æ€æ–¹æ³•**ï¼Œåˆ›å»º JerseyReplicationClient ã€‚ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-core/src/main/java/com/netflix/eureka/transport/JerseyReplicationClient.java#L135) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„æ–¹æ³•ä»£ç ã€‚

# 5. EurekaHttpClientDecorator

`com.netflix.discovery.shared.transport.decorator.EurekaHttpClientDecorator`ï¼ŒEurekaHttpClient å§”æ‰˜è€…**æŠ½è±¡ç±»**ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
public abstract class EurekaHttpClientDecorator implements EurekaHttpClient {

    /**
     * æ‰§è¡Œè¯·æ±‚
     *
     * @param requestExecutor è¯·æ±‚æ‰§è¡Œå™¨
     * @param <R> è¯·æ±‚æ³›å‹
     * @return å“åº”
     */
    protected abstract <R> EurekaHttpResponse<R> execute(RequestExecutor<R> requestExecutor);
    
    @Override
    public EurekaHttpResponse<Void> register(final InstanceInfo info) {
        return execute(new RequestExecutor<Void>() {
            @Override
            public EurekaHttpResponse<Void> execute(EurekaHttpClient delegate) {
                return delegate.register(info);
            }

            @Override
            public RequestType getRequestType() {
                return RequestType.Register;
            }
        });
    }

}
```

* `#execute(...)` **æŠ½è±¡æ–¹æ³•**ï¼Œå­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œå®ç°è‡ªå·±çš„ç‰¹æ€§ã€‚
* `#register()` æ–¹æ³•ï¼Œå®ç°å‘ Eureka-Server æ³¨å†Œåº”ç”¨å®ä¾‹ã€‚**å…¶ä»–æ–¹æ³•ä»£ç ç±»ä¼¼**ã€‚
    * è°ƒç”¨ `#execute(...)` æ–¹æ³•ï¼Œå¹¶å°†åŸæœ‰çš„æ³¨å†Œå®ç°é€šè¿‡ RequestExecutor ä¼ é€’è¿›å»ã€‚
    * å­ç±»åœ¨å®ç°çš„ `#execute(...)` æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ `RequestExecutor#execute(...)` æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡ŒåŸæœ‰é€»è¾‘ã€‚
    * å‚è€ƒè®¾è®¡æ¨¡å¼ï¼š[ã€Šè®¾è®¡æ¨¡å¼ ( åä¹ ) æ¨¡æ¿æ–¹æ³•æ¨¡å¼Template methodï¼ˆç±»è¡Œä¸ºå‹ï¼‰ã€‹](http://blog.csdn.net/hguisu/article/details/7564039) ã€‚
* RequestType ï¼Œè¯·æ±‚ç±»å‹**æšä¸¾ç±»**ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // EurekaHttpClientDecorator.java
    public enum RequestType {
       Register,
       Cancel,
       SendHeartBeat,
       StatusUpdate,
       DeleteStatusOverride,
       GetApplications,
       GetDelta,
       GetVip,
       GetSecureVip,
       GetApplication,
       GetInstance,
       GetApplicationInstance
    }
    ```

* RequestExecutor ï¼Œè¯·æ±‚æ‰§è¡Œå™¨**æ¥å£**ã€‚æ¥å£ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // EurekaHttpClientDecorator.java
    public interface RequestExecutor<R> {
    
       /**
        * æ‰§è¡Œè¯·æ±‚
        *
        * @param delegate å§”æ‰˜çš„ EurekaHttpClient
        * @return å“åº”
        */
       EurekaHttpResponse<R> execute(EurekaHttpClient delegate);
    
       /**
        * @return è¯·æ±‚ç±»å‹
        */
       RequestType getRequestType();
    }
    ```

-------

EurekaHttpClientDecorator çš„**æ¯ä¸ªå®ç°ç±»å®ç°ä¸€ä¸ªç‰¹æ€§**ï¼Œä»£ç éå¸¸éå¸¸éå¸¸æ¸…æ™°ã€‚

> FROM [ã€Šå§”æ‰˜æ¨¡å¼ã€‹](https://zh.wikipedia.org/wiki/%E5%A7%94%E6%89%98%E6%A8%A1%E5%BC%8F)  
> å§”æ‰˜æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡æ¨¡å¼ä¸­çš„ä¸€é¡¹åŸºæœ¬æŠ€å·§ã€‚åœ¨å§”æ‰˜æ¨¡å¼ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¯¹è±¡å‚ä¸å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ¥å—è¯·æ±‚çš„å¯¹è±¡å°†è¯·æ±‚å§”æ‰˜ç»™å¦ä¸€ä¸ªå¯¹è±¡æ¥å¤„ç†ã€‚å§”æ‰˜æ¨¡å¼æ˜¯ä¸€é¡¹åŸºæœ¬æŠ€å·§ï¼Œè®¸å¤šå…¶ä»–çš„æ¨¡å¼ï¼Œå¦‚çŠ¶æ€æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼æœ¬è´¨ä¸Šæ˜¯åœ¨æ›´ç‰¹æ®Šçš„åœºåˆé‡‡ç”¨äº†å§”æ‰˜æ¨¡å¼ã€‚å§”æ‰˜æ¨¡å¼ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨èšåˆæ¥æ›¿ä»£ç»§æ‰¿ï¼Œå®ƒè¿˜ä½¿æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿmixinã€‚

æˆ‘ä»¬åœ¨ä¸Šå›¾çš„åŸºç¡€ä¸Šï¼Œ**å¢åŠ å§”æ‰˜çš„å…³ç³»**ï¼Œå¦‚ä¸‹å›¾( [æ‰“å¼€å¤§å›¾](http://www.iocoder.cn/images/Eureka/2018_07_31/03.jpeg) )ï¼š

![](http://www.iocoder.cn/images/Eureka/2018_07_31/03.jpeg)

* è¯·æ³¨æ„ï¼Œæ¯ä¸ªå§”æ‰˜ç€å®ç°ç±»ï¼Œä¸Šé¢å¯èƒ½æœ‰ç±»å‹ä¸º EurekaHttpClientFactory çš„å±æ€§ï¼Œç”¨äºåˆ›å»ºå…¶å§”æ‰˜çš„ EurekaHttpClient ã€‚**ä¸ºä»€ä¹ˆä¼šæœ‰ Factory** ï¼Ÿä¾‹å¦‚ï¼ŒRetryableEurekaHttpClient é‡è¯•è¯·æ±‚å¤šä¸ª Eureka-Server åœ°å€æ—¶ï¼Œæ¯ä¸ª Eureka-Server åœ°å€ä¼šåˆ›å»ºä¸€ä¸ª EurekaHttpClient ã€‚æ‰€ä»¥ï¼Œä¸‹æ–‡æ¶‰åŠåˆ° EurekaHttpClientFactory å’Œ**å§”æ‰˜çš„** EurekaHttpClient çš„åœ°æ–¹ï¼Œä½ éƒ½éœ€è¦ä»”ç»†ç†è§£ã€‚

## 5.1 MetricsCollectingEurekaHttpClient

`com.netflix.discovery.shared.transport.decorator.MetricsCollectingEurekaHttpClient` ï¼Œç›‘æ§æŒ‡æ ‡æ”¶é›† EurekaHttpClient ï¼Œé…åˆ [Netflix Servo](https://github.com/Netflix/servo) å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›†ã€‚

`#execute()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
  1: @Override
  2: protected <R> EurekaHttpResponse<R> execute(RequestExecutor<R> requestExecutor) {
  3:     // è·å¾— è¯·æ±‚ç±»å‹ çš„ è¯·æ±‚æŒ‡æ ‡
  4:     EurekaHttpClientRequestMetrics requestMetrics = metricsByRequestType.get(requestExecutor.getRequestType());
  5:     Stopwatch stopwatch = requestMetrics.latencyTimer.start();
  6:     try {
  7:         // æ‰§è¡Œè¯·æ±‚
  8:         EurekaHttpResponse<R> httpResponse = requestExecutor.execute(delegate);
  9:         // å¢åŠ  è¯·æ±‚æŒ‡æ ‡
 10:         requestMetrics.countersByStatus.get(mappedStatus(httpResponse)).increment();
 11:         return httpResponse;
 12:     } catch (Exception e) {
 13:         requestMetrics.connectionErrors.increment();
 14:         exceptionsMetric.count(e);
 15:         throw e;
 16:     } finally {
 17:         stopwatch.stop();
 18:     }
 19: }
```

* ç¬¬ 10 è¡Œ ï¼šè°ƒç”¨ `RequestExecutor#execute(...)` æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œè¯·æ±‚ã€‚
    * `delegate` å±æ€§ï¼Œå¯¹åº” JerseyApplicationClient ã€‚

## 5.2 RedirectingEurekaHttpClient

`com.netflix.discovery.shared.transport.decorator.RedirectingEurekaHttpClient` ï¼Œ**å¯»æ‰¾é 302 é‡å®šå‘**çš„ Eureka-Server çš„ EurekaHttpClient ã€‚

`#execute()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
  1: @Override
  2: protected <R> EurekaHttpResponse<R> execute(RequestExecutor<R> requestExecutor) {
  3:     EurekaHttpClient currentEurekaClient = delegateRef.get();
  4:     if (currentEurekaClient == null) { // æœªæ‰¾åˆ°é 302 çš„ Eureka-Server
  5:         AtomicReference<EurekaHttpClient> currentEurekaClientRef = new AtomicReference<>(factory.newClient(serviceEndpoint));
  6:         try {
  7:             EurekaHttpResponse<R> response = executeOnNewServer(requestExecutor, currentEurekaClientRef);
  8:             // å…³é—­åŸæœ‰çš„å§”æ‰˜ EurekaHttpClient ï¼Œå¹¶è®¾ç½®å½“å‰æˆåŠŸé 302 è¯·æ±‚çš„ EurekaHttpClient
  9:             TransportUtils.shutdown(delegateRef.getAndSet(currentEurekaClientRef.get()));
 10:             return response;
 11:         } catch (Exception e) {
 12:             logger.error("Request execution error", e);
 13:             TransportUtils.shutdown(currentEurekaClientRef.get());
 14:             throw e;
 15:         }
 16:     } else { // å·²ç»æ‰¾åˆ°é 302 çš„ Eureka-Server
 17:         try {
 18:             return requestExecutor.execute(currentEurekaClient);
 19:         } catch (Exception e) {
 20:             logger.error("Request execution error", e);
 21:             delegateRef.compareAndSet(currentEurekaClient, null);
 22:             currentEurekaClient.shutdown();
 23:             throw e;
 24:         }
 25:     }
 26: }
```

* **æ³¨æ„**ï¼šå’Œæˆ‘ä»¬ç†è§£çš„å¸¸è§„çš„ 302 çŠ¶æ€è¿”å›å¤„ç†ä¸åŒï¼ï¼ï¼
* æ•´ä¸ªåˆ†æˆä¸¤éƒ¨åˆ†ï¼šã€ç¬¬ 4 è‡³ 15 è¡Œã€‘ã€ã€ç¬¬ 16 è‡³ 24 è¡Œã€‘ã€‚
    * å‰è€…ï¼Œæ„å‘³ç€æœªæ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œæ­¤æ—¶é€šè¿‡åœ¨åŸå§‹ä¼ é€’è¿›æ¥çš„ `serviceUrls` æ‰§è¡Œè¯·æ±‚ï¼Œå¯»æ‰¾é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Serverã€‚
        * å½“è¿”å›é 302 çŠ¶æ€ç æ—¶ï¼Œæ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ã€‚
        * å½“è¿”å› 302 çŠ¶æ€ç æ—¶ï¼Œå‘æ–°çš„é‡å®šå‘çš„ Eureka-Server æ‰§è¡Œè¯·æ±‚ç›´åˆ°æˆåŠŸæ‰¾åˆ°æˆ–è¶…è¿‡æœ€å¤§æ¬¡æ•°ã€‚
   * åè€…ï¼Œæ„å‘³ç€å½“å‰å·²ç»æ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œç›´æ¥æ‰§è¡Œè¯·æ±‚ã€‚**æ³¨æ„** ï¼šæ­¤æ—¶ Eureka-Server å†è¿”å› 302 çŠ¶æ€ç ï¼Œä¸å†å¤„ç†ã€‚
   * ç›®å‰ Eureka 1.x çš„ Eureka-Server ä¸å­˜åœ¨è¿”å› 302 çŠ¶æ€ç ï¼ŒçŒœæµ‹å’Œ Eureka 2.X TODO[0028]ï¼šå†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤ æœ‰å…³ã€‚
* ã€å‰è€…ã€‘ç¬¬ 5 è¡Œ ï¼šä½¿ç”¨åˆå§‹çš„ `serviceEndpoint` ( ç›¸å½“äº `serviceUrls` ) åˆ›å»º**å§”æ‰˜** EurekaHttpClient ã€‚
* ã€å‰è€…ã€‘ç¬¬ 7 è¡Œ ï¼šè°ƒç”¨ `#executeOnNewServer(...)` æ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œè¯·æ±‚çš„æ–¹å¼ï¼Œå¯»æ‰¾é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Serverã€‚å®ç°ä»£ç ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/ed9a4241e60e3b558f939754f71188d3063771e2/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RedirectingEurekaHttpClient.java#L111) æŸ¥çœ‹å¸¦ä¸­æ–‡æ³¨é‡Šçš„ä»£ç å®ç°ã€‚
* ã€å‰è€…ã€‘ã€å‰è€…ã€‘ç¬¬ 9 è¡Œ ï¼šå…³é—­åŸæœ‰çš„ `delegateRef` ( å› ä¸ºæ­¤å¤„å¯èƒ½å­˜åœ¨å¹¶å‘ï¼Œå¤šä¸ªçº¿ç¨‹éƒ½æ‰¾åˆ°é 302 çŠ¶æ€ç è¿”å›çš„ Eureka-Server )ï¼Œå¹¶è®¾ç½®å½“å‰æˆåŠŸé 302 è¯·æ±‚çš„ EurekaHttpClient åˆ° `delegateRef`ã€‚
* ã€å‰è€…ã€‘ç¬¬ 13 è¡Œ ï¼šå…³é—­ `currentEurekaClientRef` ï¼Œå½“è¯·æ±‚å‘ç”Ÿå¼‚å¸¸æˆ–è€…è¶…è¿‡æœ€å¤§é‡å®šå‘æ¬¡æ•°ã€‚
* ã€åè€…ã€‘ç¬¬ 18 è¡Œ ï¼šæ„å‘³ç€å½“å‰å·²ç»æ‰¾åˆ°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ï¼Œç›´æ¥æ‰§è¡Œè¯·æ±‚ã€‚
* ã€åè€…ã€‘ç¬¬ 21 è‡³ 22 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚å‘ç”Ÿå¼‚å¸¸ï¼Œå…³é—­ `currentEurekaClient` ï¼Œåé¢è¦é‡æ–°éè¿”å› 302 çŠ¶æ€ç çš„ Eureka-Server ã€‚

### 5.2.1 å·¥å‚

RedirectingEurekaHttpClient æä¾› `#createFactory(...)` **é™æ€æ–¹æ³•**è·å¾—åˆ›å»ºå…¶çš„å·¥å‚ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/ed9a4241e60e3b558f939754f71188d3063771e2/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RedirectingEurekaHttpClient.java#L96) æŸ¥çœ‹ã€‚

## 5.3 RetryableEurekaHttpClient

`com.netflix.discovery.shared.transport.decorator.RetryableEurekaHttpClient` ï¼Œæ”¯æŒå‘å¤šä¸ª Eureka-Server è¯·æ±‚é‡è¯•çš„ EurekaHttpClient ã€‚

`#execute()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
  1: @Override
  2: protected <R> EurekaHttpResponse<R> execute(RequestExecutor<R> requestExecutor) {
  3:     List<EurekaEndpoint> candidateHosts = null;
  4:     int endpointIdx = 0;
  5:     for (int retry = 0; retry < numberOfRetries; retry++) {
  6:         EurekaHttpClient currentHttpClient = delegate.get();
  7:         EurekaEndpoint currentEndpoint = null;
  8: 
  9:         // å½“å‰å§”æ‰˜çš„ EurekaHttpClient ä¸å­˜åœ¨
 10:         if (currentHttpClient == null) {
 11:             // è·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„
 12:             if (candidateHosts == null) {
 13:                 candidateHosts = getHostCandidates();
 14:                 if (candidateHosts.isEmpty()) {
 15:                     throw new TransportException("There is no known eureka server; cluster server list is empty");
 16:                 }
 17:             }
 18: 
 19:             // è¶…è¿‡å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„ä¸Šé™
 20:             if (endpointIdx >= candidateHosts.size()) {
 21:                 throw new TransportException("Cannot execute request on any known server");
 22:             }
 23: 
 24:             // åˆ›å»ºå€™é€‰çš„ EurekaHttpClient
 25:             currentEndpoint = candidateHosts.get(endpointIdx++);
 26:             currentHttpClient = clientFactory.newClient(currentEndpoint);
 27:         }
 28: 
 29:         try {
 30:             // æ‰§è¡Œè¯·æ±‚
 31:             EurekaHttpResponse<R> response = requestExecutor.execute(currentHttpClient);
 32:             // åˆ¤æ–­æ˜¯å¦ä¸ºå¯æ¥å—çš„ç›¸åº”ï¼Œè‹¥æ˜¯ï¼Œè¿”å›ã€‚
 33:             if (serverStatusEvaluator.accept(response.getStatusCode(), requestExecutor.getRequestType())) {
 34:                 delegate.set(currentHttpClient);
 35:                 if (retry > 0) {
 36:                     logger.info("Request execution succeeded on retry #{}", retry);
 37:                 }
 38:                 return response;
 39:             }
 40:             logger.warn("Request execution failure with status code {}; retrying on another server if available", response.getStatusCode());
 41:         } catch (Exception e) {
 42:             logger.warn("Request execution failed with message: {}", e.getMessage());  // just log message as the underlying client should log the stacktrace
 43:         }
 44: 
 45:         // è¯·æ±‚å¤±è´¥ï¼Œè‹¥æ˜¯ currentHttpClient ï¼Œæ¸…é™¤ delegate
 46:         // Connection error or 5xx from the server that must be retried on another server
 47:         delegate.compareAndSet(currentHttpClient, null);
 48: 
 49:         // è¯·æ±‚å¤±è´¥ï¼Œå°† currentEndpoint æ·»åŠ åˆ°éš”ç¦»é›†åˆ
 50:         if (currentEndpoint != null) {
 51:             quarantineSet.add(currentEndpoint);
 52:         }
 53:     }
 54:     throw new TransportException("Retry limit reached; giving up on completing the request");
 55: }
```

* ç¬¬ 10 è¡Œ ï¼šå½“å‰ `currentHttpClient` ä¸å­˜åœ¨ï¼Œæ„å‘³ç€åŸæœ‰ `delegate` ä¸å­˜åœ¨å‘ Eureka-Server æˆåŠŸè¯·æ±‚çš„ EurekaHttpClient ã€‚
    * æ­¤æ—¶éœ€è¦ä»é…ç½®ä¸­çš„ Eureka-Server æ•°ç»„é‡è¯•è¯·æ±‚ï¼Œè·å¾—å¯ä»¥è¯·æ±‚çš„ Eureka-Server ã€‚
    * å¦‚æœå·²ç»å­˜åœ¨è¯·æ±‚æˆåŠŸçš„ `delegate` ï¼Œç›´æ¥ä½¿ç”¨å®ƒè¿›è¡Œæ‰§è¡Œè¯·æ±‚ã€‚
* ç¬¬ 11 è‡³ 17 è¡Œ ï¼šè°ƒç”¨ `#getHostCandidates()` æ–¹æ³•ï¼Œè·å¾—å€™é€‰çš„ Eureka-Server `serviceUrls` æ•°ç»„ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
      1: private List<EurekaEndpoint> getHostCandidates() {
      2:     // è·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„
      3:     List<EurekaEndpoint> candidateHosts = clusterResolver.getClusterEndpoints();
      4: 
      5:     // ä¿ç•™äº¤é›†ï¼ˆç§»é™¤ quarantineSet ä¸åœ¨ candidateHosts çš„å…ƒç´ ï¼‰
      6:     quarantineSet.retainAll(candidateHosts);
      7: 
      8:     // åœ¨ä¿è¯æœ€å°å¯ç”¨çš„å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„ï¼Œç§»é™¤åœ¨éš”ç¦»é›†åˆå†…çš„å…ƒç´ 
      9:     // If enough hosts are bad, we have no choice but start over again
     10:     int threshold = (int) (candidateHosts.size() * transportConfig.getRetryableClientQuarantineRefreshPercentage()); // 0.66
     11:     if (quarantineSet.isEmpty()) {
     12:         // no-op
     13:     } else if (quarantineSet.size() >= threshold) {
     14:         logger.debug("Clearing quarantined list of size {}", quarantineSet.size());
     15:         quarantineSet.clear();
     16:     } else {
     17:         List<EurekaEndpoint> remainingHosts = new ArrayList<>(candidateHosts.size());
     18:         for (EurekaEndpoint endpoint : candidateHosts) {
     19:             if (!quarantineSet.contains(endpoint)) {
     20:                 remainingHosts.add(endpoint);
     21:             }
     22:         }
     23:         candidateHosts = remainingHosts;
     24:     }
     25: 
     26:     return candidateHosts;
     27: }
    ```
    * ç¬¬ 3 è¡Œ ï¼šè°ƒç”¨ `ClusterResolver#getClusterEndpoints()` æ–¹æ³•ï¼Œè·å¾—å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„( `candidateHosts` )ã€‚**æ³¨æ„**ï¼šè¯¥æ–¹æ³•è¿”å›çš„ Eureka-Server åœ°å€æ•°ç»„ï¼Œä½¿ç”¨ä»¥æœ¬æœº IP ä¸º**éšæœºç§å­**ï¼Œè¾¾åˆ°ä¸åŒ IP çš„åº”ç”¨å®ä¾‹è·å¾—çš„æ•°ç»„é¡ºåºä¸åŒï¼Œè€Œç›¸åŒ IP çš„åº”ç”¨å®ä¾‹è·å¾—çš„æ•°ç»„é¡ºåºä¸€è‡´ï¼Œ**æ•ˆæœç±»ä¼¼åŸºäº IP HASH çš„è´Ÿè½½å‡è¡¡ç®—æ³•**ã€‚å®ç°è¯¥åŠŸèƒ½çš„ä»£ç ï¼Œåœ¨ [ã€ŠEureka æºç è§£æ â€”â€” EndPoint ä¸ è§£æå™¨ã€‹æœç´¢å…³é”®å­—ã€ResolverUtils#randomize(...)ã€‘](http://www.iocoder.cn/Eureka/end-point-and-resolver/?self) è¯¦ç»†è§£æã€‚
    * ç¬¬ 6 è¡Œ ï¼šè°ƒç”¨ `Set#retainAll()` æ–¹æ³•ï¼Œç§»é™¤éš”ç¦»çš„æ•…éšœ Eureka-Server åœ°å€æ•°ç»„( `quarantineSet` ) ä¸­ä¸åœ¨ `candidateHosts` çš„å…ƒç´ ã€‚
    * ç¬¬ 8 è‡³ 24 è¡Œ ï¼šåœ¨ä¿è¯æœ€å°å¯ç”¨çš„ `candidateHosts`ï¼Œç§»é™¤åœ¨ `quarantineSet` çš„å…ƒç´ ã€‚
        * ç¬¬ 10 è¡Œ ï¼šæœ€å°å¯ç”¨çš„é˜€å€¼ï¼Œé…ç½® `eureka.retryableClientQuarantineRefreshPercentage` æ¥è®¾ç½®ç™¾åˆ†æ¯”ï¼Œé»˜è®¤å€¼ï¼š`0.66` ã€‚
        * æœ€ 13 è‡³ 15 è¡Œ ï¼š`quarantineSet` æ•°é‡è¶…è¿‡é˜€å€¼ï¼Œæ¸…ç©º `quarantineSet` ï¼Œå…¨éƒ¨ `candidateHosts` é‡è¯•ã€‚
        * ç¬¬ 17 è‡³ 24 è¡Œ ï¼š`quarantineSet` æ•°é‡æœªè¶…è¿‡é˜€å€¼ï¼Œç§»é™¤ `candidateHosts` ä¸­åœ¨ `quarantineSet` çš„å…ƒç´ ã€‚
 
* ç¬¬ 19 è‡³ 22 è¡Œ ï¼šè¶…è¿‡ `candidateHosts` ä¸Šé™ï¼Œå…¨éƒ¨ Eureka-Server è¯·æ±‚å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
* ç¬¬ 24 è‡³ 26 è¡Œ ï¼šåˆ›å»ºå§”æ‰˜çš„ EurekaHttpClient ï¼Œç”¨äºä¸‹é¢è¯·æ±‚æ‰§è¡Œã€‚
* ç¬¬ 31 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚ã€‚
* ç¬¬ 33 è¡Œ ï¼šè°ƒç”¨ `ServerStatusEvaluator#accept()` æ–¹æ³•ï¼Œåˆ¤æ–­å“åº”çŠ¶æ€ç å’Œè¯·æ±‚ç±»å‹æ˜¯å¦èƒ½å¤Ÿæ¥å—ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // ServerStatusEvaluators.java
    private static final ServerStatusEvaluator LEGACY_EVALUATOR = new ServerStatusEvaluator() {
       @Override
       public boolean accept(int statusCode, RequestType requestType) {
           if (statusCode >= 200 && statusCode < 300 || statusCode == 302) {
               return true;
           } else if (requestType == RequestType.Register && statusCode == 404) { // æ³¨å†Œï¼Œ404 å¯æ¥å—
               return true;
           } else if (requestType == RequestType.SendHeartBeat && statusCode == 404) { // å¿ƒè·³ï¼Œ404 å¯æ¥å—
               return true;
           } else if (requestType == RequestType.Cancel) {  // cancel is best effort ä¸‹çº¿ï¼Œæ¥å—å…¨éƒ¨
               return true;
           } else if (requestType == RequestType.GetDelta && (statusCode == 403 || statusCode == 404)) { // å¢é‡è·å–æ³¨å†Œä¿¡æ¯ï¼Œ403 404 å¯æ¥å—
               return true;
           }
           return false;
       }
    };
    ```

* ç¬¬ 34 è¡Œ ï¼šè¯·æ±‚æˆåŠŸï¼Œè®¾ç½® `delegate` ã€‚ä¸‹æ¬¡è¯·æ±‚ï¼Œä¼˜å…ˆä½¿ç”¨ `delegate` ï¼Œå¤±è´¥æ‰è¿›è¡Œå€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„é‡è¯•ã€‚
* ç¬¬ 47 è¡Œ ï¼šè¯·æ±‚å¤±è´¥ï¼Œ`delegate` è‹¥ç­‰äº `currentHttpClient` ï¼Œè¿›è¡Œæ¸…é™¤ã€‚
* ç¬¬ 50 è‡³ 52 è¡Œ ï¼šè¯·æ±‚å¤±è´¥ï¼Œå°†è¯·æ±‚çš„ Eureka-Server åœ°å€æ·»åŠ åˆ° `quarantineSet` ã€‚
* æ€»ç»“æ¥è¯´ï¼š
    * ã€ç¬¬ä¸€æ­¥ã€‘è‹¥å½“å‰æœ‰è¯·æ±‚æˆåŠŸçš„ EurekaHttpClient ï¼Œç»§ç»­ä½¿ç”¨ã€‚è‹¥è¯·æ±‚å¤±è´¥ï¼Œæ‰§è¡Œã€ç¬¬äºŒæ­¥ã€‘ã€‚
    * ã€ç¬¬äºŒæ­¥ã€‘è‹¥å½“å‰æ— è¯·æ±‚æˆåŠŸçš„ EurekaHttpClient ï¼Œè·å–å€™é€‰çš„ Eureka-Server åœ°å€æ•°ç»„**é¡ºåº**åˆ›å»ºæ–°çš„ EurekaHttpClientï¼Œç›´åˆ°æˆåŠŸï¼Œæˆ–è€…è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚å½“è¯·æ±‚æˆåŠŸï¼Œä¿å­˜è¯¥ EurekaHttpClient ï¼Œä¸‹æ¬¡ç»§ç»­ä½¿ç”¨ï¼Œç›´åˆ°è¯·æ±‚å¤±è´¥ã€‚
 
### 5.3.1 å·¥å‚

RetryableEurekaHttpClient æä¾› `#createFactory(...)` **é™æ€æ–¹æ³•**è·å¾—åˆ›å»ºå…¶çš„å·¥å‚ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/eureka/blob/94a4a1ebd35a3350893369a05757c01b2534b702/eureka-client/src/main/java/com/netflix/discovery/shared/transport/decorator/RetryableEurekaHttpClient.java#L135) æŸ¥çœ‹ã€‚

## 5.4 SessionedEurekaHttpClient

`com.netflix.discovery.shared.transport.decorator.SessionedEurekaHttpClient` ï¼Œæ”¯æŒä¼šè¯çš„ EurekaHttpClient ã€‚æ‰§è¡Œå®šæœŸçš„é‡å»ºä¼šè¯ï¼Œé˜²æ­¢ä¸€ä¸ª Eureka-Client æ°¸è¿œåªè¿æ¥ä¸€ä¸ªç‰¹å®šçš„ Eureka-Server ã€‚åè¿‡æ¥ï¼Œè¿™ä¹Ÿä¿è¯äº† Eureka-Server é›†ç¾¤å˜æ›´æ—¶ï¼ŒEureka-Client å¯¹ Eureka-Server è¿æ¥çš„è´Ÿè½½å‡è¡¡ã€‚

`#execute(...)` ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
  1: @Override
  2: protected <R> EurekaHttpResponse<R> execute(RequestExecutor<R> requestExecutor) {
  3:     long now = System.currentTimeMillis();
  4:     long delay = now - lastReconnectTimeStamp;
  5: 
  6:     // è¶…è¿‡ å½“å‰ä¼šè¯æ—¶é—´ï¼Œå…³é—­å½“å‰å§”æ‰˜çš„ EurekaHttpClient ã€‚
  7:     if (delay >= currentSessionDurationMs) {
  8:         logger.debug("Ending a session and starting anew");
  9:         lastReconnectTimeStamp = now;
 10:         currentSessionDurationMs = randomizeSessionDuration(sessionDurationMs);
 11:         TransportUtils.shutdown(eurekaHttpClientRef.getAndSet(null));
 12:     }
 13: 
 14:     // è·å¾—å§”æ‰˜çš„ EurekaHttpClient ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°çš„å§”æ‰˜çš„ EurekaHttpClient ã€‚
 15:     EurekaHttpClient eurekaHttpClient = eurekaHttpClientRef.get();
 16:     if (eurekaHttpClient == null) {
 17:         eurekaHttpClient = TransportUtils.getOrSetAnotherClient(eurekaHttpClientRef, clientFactory.newClient());
 18:     }
 19:     return requestExecutor.execute(eurekaHttpClient);
 20: }
```

* ç¬¬ 7 è‡³ 12 è¡Œ ï¼šè¶…è¿‡å½“å‰ä¼šè¯æ—¶é—´ï¼Œå…³é—­å½“å‰å§”æ‰˜çš„ EurekaHttpClient ã€‚
    * ç¬¬ 10 è¡Œ ï¼šè°ƒç”¨ `#randomizeSessionDuration(...)` æ–¹æ³•ï¼Œè®¡ç®—è®¡ç®—ä¸‹ä¸€æ¬¡ä¼šè¯è¶…æ—¶æ—¶é•¿ï¼Œå…¬å¼ä¸º `sessionDurationMs * (0.5, 1.5)` ï¼Œä»£ç å¦‚ä¸‹ï¼š

        ```Java
        protected long randomizeSessionDuration(long sessionDurationMs) {
           long delta = (long) (sessionDurationMs * (random.nextDouble() - 0.5));
           return sessionDurationMs + delta;
        }
        ```
        * å¢åŠ ä¼šè¯è¿‡æœŸçš„éšæœºæ€§ï¼Œå®ç°æ‰€æœ‰ Eureka-Client çš„ä¼šè¯è¿‡æœŸé‡è¿çš„å‘ç”Ÿæ—¶é—´æ›´åŠ ç¦»æ•£ï¼Œé¿å…é›†ä¸­æ—¶é—´è¿‡æœŸã€‚ç›®å‰çŒœæµ‹è¿™ä¹ˆåšçš„ç›®çš„å’Œ TODO[0028]ï¼šå†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤ æœ‰å…³ï¼Œå³è¿”å› 302 ã€‚å…³è” [1.x new transport enhancements](https://github.com/Netflix/eureka/pull/687) ã€‚

* ç¬¬ 15 è‡³ 18 è¡Œ ï¼šè·å¾—å§”æ‰˜çš„ EurekaHttpClient ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„å§”æ‰˜çš„ EurekaHttpClient ã€‚`TransportUtils#getOrSetAnotherClient(...)` æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

    ```Java
      1: public static EurekaHttpClient getOrSetAnotherClient(AtomicReference<EurekaHttpClient> eurekaHttpClientRef, EurekaHttpClient another) {
      2:     EurekaHttpClient existing = eurekaHttpClientRef.get();
      3:     // ä¸ºç©ºæ‰è®¾ç½®
      4:     if (eurekaHttpClientRef.compareAndSet(null, another)) {
      5:         return another;
      6:     }
      7:     // è®¾ç½®å¤±è´¥ï¼Œæ„å‘³ç€å¦å¤–ä¸€ä¸ªçº¿ç¨‹å·²ç»è®¾ç½®
      8:     another.shutdown();
      9:     return existing;
     10: }
    ```
    * è¯¥æ–¹æ³•å®ç°ï¼Œè·å¾— `eurekaHttpClientRef` é‡Œçš„ EurekaHttpClient ã€‚è‹¥è·å–ä¸åˆ°ï¼Œå°† `another` è®¾ç½®åˆ° `eurekaHttpClientRef` ã€‚å½“æœ‰å¤šä¸ªçº¿ç¨‹è®¾ç½®æ—¶ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¾ç½®æˆåŠŸï¼Œå¦å¤–çš„è®¾ç½®å¤±è´¥çš„çº¿ç¨‹ä»¬ï¼Œæ„å‘³ç€å½“å‰ `eurekaHttpClientRef` æœ‰ EurekaHttpClient ï¼Œè¿”å› `eurekaHttpClientRef` ã€‚
    * ç›®å‰è¯¥æ–¹æ³•å­˜åœ¨ BUG ï¼Œå¤±è´¥çš„çº¿ç¨‹ç›´æ¥è¿”å› `existing` çš„æ˜¯ `null` ï¼Œéœ€è¦ä¿®æ”¹æˆ `return eurekaHttpClientRef.get()` ã€‚æ¨¡æ‹Ÿé‡ç°è¯¥ BUG ä»£ç å¦‚ä¸‹ ï¼š

        ![](http://www.iocoder.cn/images/Eureka/2018_07_31/04.png)

* ç¬¬ 19 è¡Œ ï¼šæ‰§è¡Œè¯·æ±‚ã€‚

### 5.4.1 æ²¡æœ‰å·¥å‚
     
åœ¨ SessionedEurekaHttpClient ç±»é‡Œï¼Œæ²¡æœ‰å®ç°åˆ›å»ºå…¶çš„å·¥å‚ã€‚åœ¨ [ã€Œ6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯ã€æœç´¢ `canonicalClientFactory`](#) ï¼Œå¯ä»¥çœ‹åˆ° `EurekaHttpClients#canonicalClientFactory(...)` æ–¹æ³•ï¼Œå†…éƒ¨æœ‰ SessionedEurekaHttpClient çš„åˆ›å»ºå·¥å‚ã€‚
     
# 6. åˆ›å»ºç½‘ç»œé€šè®¯å®¢æˆ·ç«¯

å¯¹äº Eureka-Server æ¥è¯´ï¼Œè°ƒç”¨ `JerseyReplicationClient#createReplicationClient(...)` **é™æ€æ–¹æ³•**å³å¯åˆ›å»ºç”¨äº Eureka-Server é›†ç¾¤å†…ï¼ŒEureka-Server è¯·æ±‚ **å…¶å®ƒçš„Eureka-Server** çš„ç½‘ç»œé€šä¿¡å®¢æˆ·ç«¯ã€‚

å¯¹äº Eureka-Client æ¥è¯´ï¼Œåˆ†æˆç”¨äº**æ³¨å†Œåº”ç”¨å®ä¾‹( `registrationClient` )**å’Œ**æŸ¥è¯¢æ³¨å†Œä¿¡æ¯( `newQueryClient` )**çš„**ä¸¤ä¸ªä¸åŒ**ç½‘ç»œé€šä¿¡å®¢æˆ·ç«¯ã€‚åœ¨ DiscoveryClient åˆå§‹åŒ–æ—¶è¿›è¡Œåˆ›å»ºï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
// DiscoveryClient.class
  1: private void scheduleServerEndpointTask(EurekaTransport eurekaTransport,
  2:                                         AbstractDiscoveryClientOptionalArgs args) {
  3:         
  4:     Collection<?> additionalFilters = args == null
  5:             ? Collections.emptyList()
  6:             : args.additionalFilters;
  7: 
  8:     EurekaJerseyClient providedJerseyClient = args == null
  9:             ? null
 10:             : args.eurekaJerseyClient;
 11:     
 12:     TransportClientFactories argsTransportClientFactories = null;
 13:     if (args != null && args.getTransportClientFactories() != null) {
 14:         argsTransportClientFactories = args.getTransportClientFactories();
 15:     }
 16:     
 17:     // Ignore the raw types warnings since the client filter interface changed between jersey 1/2
 18:     @SuppressWarnings("rawtypes")
 19:     TransportClientFactories transportClientFactories = argsTransportClientFactories == null
 20:             ? new Jersey1TransportClientFactories()
 21:             : argsTransportClientFactories;
 22: 
 23:     // If the transport factory was not supplied with args, assume they are using jersey 1 for passivity
 24:     // noinspection unchecked
 25:     eurekaTransport.transportClientFactory = providedJerseyClient == null
 26:             ? transportClientFactories.newTransportClientFactory(clientConfig, additionalFilters, applicationInfoManager.getInfo())
 27:             : transportClientFactories.newTransportClientFactory(additionalFilters, providedJerseyClient);
 28: 
 29:     // ï¼ˆçœç•¥ä»£ç ï¼‰åˆå§‹åŒ– åº”ç”¨è§£æå™¨çš„åº”ç”¨å®ä¾‹æ•°æ®æº TODO[0028]å†™å…¥é›†ç¾¤å’Œè¯»å–é›†ç¾¤
 30: 
 31:     // ï¼ˆçœç•¥ä»£ç ï¼‰åˆ›å»º EndPoint è§£æå™¨
 32:     eurekaTransport.bootstrapResolver = EurekaHttpClients.newBootstrapResolver(...)
 33: 
 34:     if (clientConfig.shouldRegisterWithEureka()) {
 35:         EurekaHttpClientFactory newRegistrationClientFactory = null;
 36:         EurekaHttpClient newRegistrationClient = null;
 37:         try {
 38:             newRegistrationClientFactory = EurekaHttpClients.registrationClientFactory(
 39:                     eurekaTransport.bootstrapResolver,
 40:                     eurekaTransport.transportClientFactory,
 41:                     transportConfig
 42:             );
 43:             newRegistrationClient = newRegistrationClientFactory.newClient();
 44:         } catch (Exception e) {
 45:             logger.warn("Transport initialization failure", e);
 46:         }
 47:         eurekaTransport.registrationClientFactory = newRegistrationClientFactory;
 48:         eurekaTransport.registrationClient = newRegistrationClient;
 49:     }
 50: 
 51:     // new method (resolve from primary servers for read)
 52:     // Configure new transport layer (candidate for injecting in the future)
 53:     if (clientConfig.shouldFetchRegistry()) {
 54:         EurekaHttpClientFactory newQueryClientFactory = null;
 55:         EurekaHttpClient newQueryClient = null;
 56:         try {
 57:             newQueryClientFactory = EurekaHttpClients.queryClientFactory(
 58:                     eurekaTransport.bootstrapResolver,
 59:                     eurekaTransport.transportClientFactory,
 60:                     clientConfig,
 61:                     transportConfig,
 62:                     applicationInfoManager.getInfo(),
 63:                     applicationsSource
 64:             );
 65:             newQueryClient = newQueryClientFactory.newClient();
 66:         } catch (Exception e) {
 67:             logger.warn("Transport initialization failure", e);
 68:         }
 69:         eurekaTransport.queryClientFactory = newQueryClientFactory;
 70:         eurekaTransport.queryClient = newQueryClient;
 71:     }
 72: }
```

* ç¬¬ 18 è‡³ 27 è¡Œ ï¼šè°ƒç”¨ `Jersey1TransportClientFactories#newTransportClientFactory(...)` æ–¹æ³•ï¼Œåˆ›å»º `registrationClient` å’Œ `queryClient` å…¬ç”¨çš„å§”æ‰˜çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```Java
    // Jersey1TransportClientFactories.java
    public TransportClientFactory newTransportClientFactory(final EurekaClientConfig clientConfig,
                                                                  final Collection<ClientFilter> additionalFilters,
                                                                  final InstanceInfo myInstanceInfo) {
       // JerseyEurekaHttpClientFactory
       final TransportClientFactory jerseyFactory = JerseyEurekaHttpClientFactory.create(
               clientConfig,
               additionalFilters,
               myInstanceInfo,
               new EurekaClientIdentity(myInstanceInfo.getIPAddr())
       );
    
       // TransportClientFactory
       final TransportClientFactory metricsFactory = MetricsCollectingEurekaHttpClient.createFactory(jerseyFactory); // å§”æ‰˜ TransportClientFactory
    
       return new TransportClientFactory() {
           @Override
           public EurekaHttpClient newClient(EurekaEndpoint serviceUrl) {
               return metricsFactory.newClient(serviceUrl);
           }
    
           @Override
           public void shutdown() {
               metricsFactory.shutdown();
               jerseyFactory.shutdown();
           }
       };
    }
    ```
    * åœ¨ TransportClientFactory é‡Œ**å§”æ‰˜** JerseyEurekaHttpClientFactory ã€‚

* ç¬¬ 34 è‡³ 49 è¡Œ ï¼šè°ƒç”¨ `EurekaHttpClients#registrationClientFactory(...)` æ–¹æ³•ï¼Œåˆ›å»º `registrationClient` çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ ï¼š

    ```Java
    // EurekaHttpClients.java
    public static EurekaHttpClientFactory registrationClientFactory(ClusterResolver bootstrapResolver,
                                                                    TransportClientFactory transportClientFactory,
                                                                    EurekaTransportConfig transportConfig) {
        return canonicalClientFactory(EurekaClientNames.REGISTRATION, transportConfig, bootstrapResolver, transportClientFactory);
    }
    
    static EurekaHttpClientFactory canonicalClientFactory(final String name,
                                                         final EurekaTransportConfig transportConfig,
                                                         final ClusterResolver<EurekaEndpoint> clusterResolver,
                                                         final TransportClientFactory transportClientFactory) {
    
       return new EurekaHttpClientFactory() { // SessionedEurekaHttpClientFactory
           @Override
           public EurekaHttpClient newClient() {
               return new SessionedEurekaHttpClient(
                       name,
                       RetryableEurekaHttpClient.createFactory( // RetryableEurekaHttpClient
                               name,
                               transportConfig,
                               clusterResolver,
                               RedirectingEurekaHttpClient.createFactory(transportClientFactory), // RedirectingEurekaHttpClient
                               ServerStatusEvaluators.legacyEvaluator()),
                       transportConfig.getSessionedClientReconnectIntervalSeconds() * 1000
               );
           }
    
           @Override
           public void shutdown() {
               wrapClosable(clusterResolver).shutdown();
           }
       };
    }
    ```

* ç¬¬ 51 è‡³ 71 è¡Œ ï¼šè°ƒç”¨ `EurekaHttpClients#queryClientFactory(...)` æ–¹æ³•ï¼Œåˆ›å»º `queryClient` çš„ EurekaHttpClientFactory ï¼Œä»£ç å¦‚ä¸‹ ï¼š

    ```Java
    // EurekaHttpClients.java
    public static EurekaHttpClientFactory queryClientFactory(ClusterResolver bootstrapResolver,
                                                            TransportClientFactory transportClientFactory,
                                                            EurekaClientConfig clientConfig,
                                                            EurekaTransportConfig transportConfig,
                                                            InstanceInfo myInstanceInfo,
                                                            ApplicationsResolver.ApplicationsSource applicationsSource) {
    
       ClosableResolver queryResolver = transportConfig.useBootstrapResolverForQuery()
               ? wrapClosable(bootstrapResolver)
               : queryClientResolver(bootstrapResolver, transportClientFactory,
               clientConfig, transportConfig, myInstanceInfo, applicationsSource);
       return canonicalClientFactory(EurekaClientNames.QUERY, transportConfig, queryResolver, transportClientFactory); // è¯¥æ–¹æ³•ä¸Šé¢æœ‰
    }
    ```

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

è¿™æ¬¡çœŸçš„æ˜¯å½©è›‹ï¼Œæˆ‘ä»¬å°†æ•´ä½“è°ƒç”¨å…³ç³»è°ƒæ•´å¦‚ä¸‹å¦‚ä¸‹( [æ‰“å¼€å¤§å›¾](http://www.iocoder.cn/images/Eureka/2018_07_31/05.png) )ï¼š

![](http://www.iocoder.cn/images/Eureka/2018_07_31/05.png)

èƒ–å‹ï¼Œä½ å­¦ä¼šäº†ä¹ˆï¼Ÿ

èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( **èŠ‹é“æºç ** ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ

