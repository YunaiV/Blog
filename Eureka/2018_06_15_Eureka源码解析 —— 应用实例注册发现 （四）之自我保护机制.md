title: Eureka æºç è§£æ â€”â€” åº”ç”¨å®ä¾‹æ³¨å†Œå‘ç°ï¼ˆå››ï¼‰ä¹‹è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶
date: 2018-06-15
tags:
categories: Eureka
permalink: Eureka/instance-registry-self-preservation

---

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Eureka/instance-registry-self-preservation/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

**æœ¬æ–‡ä¸»è¦åŸºäº Eureka 1.8.X ç‰ˆæœ¬** 

- [1. æ¦‚è¿°](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/)
- [2. å®šä¹‰](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/)
- [3. å®ç°](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/)
  - [3.1 è§¦å‘æ¡ä»¶](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/)
  - [3.2 è®¡ç®—å…¬å¼](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/)
  - [3.3 è®¡ç®—æ—¶æœº](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/)
- [666. å½©è›‹](http://www.iocoder.cn/Eureka/instance-registry-self-preservation/)

---

![](http://www.iocoder.cn/images/common/wechat_mp_2018_05_18.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š  
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨  
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**  
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚  
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚  
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

---

# 1. æ¦‚è¿°

æœ¬æ–‡ä¸»è¦åˆ†äº« **è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶**ï¼Œä¸ºåº”ç”¨å®ä¾‹è¿‡æœŸä¸‹çº¿åšé“ºå«ã€‚

**æ¨è Spring Cloud ä¹¦ç±**ï¼š

* è¯·æ”¯æŒæ­£ç‰ˆã€‚ä¸‹è½½ç›—ç‰ˆï¼Œ**ç­‰äºä¸»åŠ¨ç¼–å†™ä½çº§ BUG** ã€‚
* ç¨‹åºçŒ¿DD â€”â€” [ã€ŠSpring Cloudå¾®æœåŠ¡å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=505Twi)
* å‘¨ç«‹ â€”â€” [ã€ŠSpring Cloudä¸Dockerå¾®æœåŠ¡æ¶æ„å®æˆ˜ã€‹](https://union-click.jd.com/jdc?d=k3sAaK)



# 2. å®šä¹‰

è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶å®šä¹‰å¦‚ä¸‹ï¼š

> FROM [å‘¨ç«‹ â€”â€” ã€Šç†è§£Eurekaçš„è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‹](http://www.itmuch.com/spring-cloud-sum/understanding-eureka-self-preservation/?from=www.iocoder.cn)  
> å½“Eureka ServerèŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯æ—¶ï¼ˆå¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºæ•…éšœï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚ä¸€æ—¦è¿›å…¥è¯¥æ¨¡å¼ï¼ŒEureka Serverå°±ä¼šä¿æŠ¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ä¿¡æ¯ï¼Œä¸å†åˆ é™¤æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šæ³¨é”€ä»»ä½•å¾®æœåŠ¡ï¼‰ã€‚å½“ç½‘ç»œæ•…éšœæ¢å¤åï¼Œè¯¥Eureka ServerèŠ‚ç‚¹ä¼šè‡ªåŠ¨é€€å‡ºè‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶** ï¼Ÿä½ ä¹Ÿå¯ä»¥ä»å‘¨ç«‹å…„çš„**è¿™ç¯‡æ–‡ç« å¾—åˆ°ç­”æ¡ˆ**ï¼Œè¿™é‡Œç¬”è€…å°±ä¸ä¸€æœ¬æ­£ç»çš„èƒ¡è¯´å…«é“äº†ã€‚

# 3. å®ç°

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹åœ¨è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶é‡Œæ‰®æ¼”**é‡è¦**è§’è‰²çš„ä¸¤ä¸ªå˜é‡ï¼š

```Java
// AbstractInstanceRegistry.java
/**
* æœŸæœ›æœ€å°æ¯åˆ†é’Ÿç»­ç§Ÿæ¬¡æ•°
*/
protected volatile int numberOfRenewsPerMinThreshold;
/**
* æœŸæœ›æœ€å¤§æ¯åˆ†é’Ÿç»­ç§Ÿæ¬¡æ•°
*/
protected volatile int expectedNumberOfRenewsPerMin;
```

* `expectedNumberOfRenewsPerMin` ï¼ŒæœŸæœ›**æœ€å¤§**æ¯åˆ†é’Ÿ**ç»­ç§Ÿ**æ¬¡æ•°ã€‚
* `numberOfRenewsPerMinThreshold` ï¼ŒæœŸæœ›**æœ€å°**æ¯åˆ†é’Ÿ**ç»­ç§Ÿ**æ¬¡æ•°ã€‚

## 3.1 è§¦å‘æ¡ä»¶

å½“æ¯åˆ†é’Ÿå¿ƒè·³æ¬¡æ•°( `renewsLastMin` ) **å°äº** `numberOfRenewsPerMinThreshold` æ—¶ï¼Œå¹¶ä¸”å¼€å¯è‡ªåŠ¨ä¿æŠ¤æ¨¡å¼å¼€å…³( `eureka.enableSelfPreservation = true` ) æ—¶ï¼Œ**è§¦å‘è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ï¼Œä¸å†è‡ªåŠ¨è¿‡æœŸç§Ÿçº¦**ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// AbstractInstanceRegistry.java
public void evict(long additionalLeaseMs) {

   if (!isLeaseExpirationEnabled()) {
       logger.debug("DS: lease expiration is currently disabled.");
       return;
   }

   // ... çœç•¥è¿‡æœŸç§Ÿçº¦é€»è¾‘
}

// PeerAwareInstanceRegistryImpl.java
@Override
public boolean isLeaseExpirationEnabled() {
   if (!isSelfPreservationModeEnabled()) {
       // The self preservation mode is disabled, hence allowing the instances to expire.
       return true;
   }
   return numberOfRenewsPerMinThreshold > 0 && getNumOfRenewsInLastMin() > numberOfRenewsPerMinThreshold;
}
```

## 3.2 è®¡ç®—å…¬å¼

è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

* `expectedNumberOfRenewsPerMin` = å½“å‰æ³¨å†Œçš„åº”ç”¨å®ä¾‹æ•° `x` 2 
* `numberOfRenewsPerMinThreshold` = `expectedNumberOfRenewsPerMin` `*` ç»­ç§Ÿç™¾åˆ†æ¯”( `eureka.renewalPercentThreshold` )

**ä¸ºä»€ä¹ˆä¹˜ä»¥ 2**

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ³¨å†Œçš„åº”ç”¨å®ä¾‹æ¯åŠåˆ†é’Ÿç»­ç§Ÿä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€åˆ†é’Ÿå¿ƒè·³**ä¸¤æ¬¡**ï¼Œå› æ­¤ x 2 ã€‚

è¿™å—ä¼šæœ‰ä¸€äº›ç¡¬ç¼–ç çš„æƒ…å†µï¼Œ**å› æ­¤ä¸å¤ªå»ºè®®ä¿®æ”¹åº”ç”¨å®ä¾‹çš„ç»­ç§Ÿé¢‘ç‡**ã€‚

**ä¸ºä»€ä¹ˆä¹˜ä»¥ç»­ç§Ÿç™¾åˆ†æ¯”**

ä½äºè¿™ä¸ªç™¾åˆ†æ¯”ï¼Œæ„å‘³ç€å¼€å¯è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`eureka.renewalPercentThreshold = 0.85` ã€‚

å¦‚æœä½ çœŸçš„è°ƒæ•´äº†**ç»­ç§Ÿé¢‘ç‡**ï¼Œå¯ä»¥ç­‰æ¯”å»ç»­ç§Ÿç™¾åˆ†æ¯”ï¼Œä»¥ä¿è¯åˆé€‚çš„è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶çš„é˜€å€¼ã€‚å¦å¤–ï¼Œä½ éœ€è¦æ³¨æ„ï¼Œç»­ç§Ÿé¢‘ç‡æ˜¯ Client çº§åˆ«ï¼Œç»­ç§Ÿç™¾åˆ†æ¯”æ˜¯ Server çº§åˆ«ã€‚

## 3.3 è®¡ç®—æ—¶æœº

ç›®å‰æœ‰**å››**ä¸ªåœ°æ–¹ä¼šè®¡ç®— `numberOfRenewsPerMinThreshold` ã€ `expectedNumberOfRenewsPerMin`ï¼Œæˆ‘ä»¬é€å°èŠ‚æ¥çœ‹ã€‚

### 3.3.1 Eureka-Server åˆå§‹åŒ–

Eureka-Server åœ¨å¯åŠ¨æ—¶ï¼Œä» Eureka-Server é›†ç¾¤è·å–æ³¨å†Œä¿¡æ¯ï¼Œå¹¶**é¦–æ¬¡**åˆå§‹åŒ– `numberOfRenewsPerMinThreshold` ã€ `expectedNumberOfRenewsPerMin` ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š


```Java
// EurekaBootStrap.java
protected void initEurekaServerContext() throws Exception {

    // ... çœç•¥å…¶å®ƒä»£ç 

    // ã€2.2.10ã€‘ä»å…¶ä»– Eureka-Server æ‹‰å–æ³¨å†Œä¿¡æ¯
    // Copy registry from neighboring eureka node
    int registryCount = registry.syncUp();
    registry.openForTraffic(applicationInfoManager, registryCount);
    
    // ... çœç•¥å…¶å®ƒä»£ç 
}

// PeerAwareInstanceRegistryImpl.java
@Override
public void openForTraffic(ApplicationInfoManager applicationInfoManager, int count) {
   // Renewals happen every 30 seconds and for a minute it should be a factor of 2.
   this.expectedNumberOfRenewsPerMin = count * 2;
   this.numberOfRenewsPerMinThreshold =
           (int) (this.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());
           
   // ... çœç•¥å…¶å®ƒä»£ç 
}   
```

### 3.3.2 å®šæ—¶é‡ç½®

Eureka-Server **å®šæ—¶**é‡æ–°è®¡ç®— `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin` ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// PeerAwareInstanceRegistryImpl.java
private void scheduleRenewalThresholdUpdateTask() {
   timer.schedule(new TimerTask() {
                      @Override
                      public void run() {
                          updateRenewalThreshold();
                      }
                  }, serverConfig.getRenewalThresholdUpdateIntervalMs(),
           serverConfig.getRenewalThresholdUpdateIntervalMs());
}

// AbstractInstanceRegistry.java
/**
* è‡ªæˆ‘ä¿æŠ¤æœºé”
*
* å½“è®¡ç®—å¦‚ä¸‹å‚æ•°æ—¶ä½¿ç”¨ï¼š
*  1. {@link #numberOfRenewsPerMinThreshold}
*  2. {@link #expectedNumberOfRenewsPerMin}
*/
protected final Object lock = new Object();

private void updateRenewalThreshold() {
   try {
       // è®¡ç®— åº”ç”¨å®ä¾‹æ•°
       Applications apps = eurekaClient.getApplications();
       int count = 0;
       for (Application app : apps.getRegisteredApplications()) {
           for (InstanceInfo instance : app.getInstances()) {
               if (this.isRegisterable(instance)) {
                   ++count;
               }
           }
       }
       // è®¡ç®— expectedNumberOfRenewsPerMin ã€ numberOfRenewsPerMinThreshold å‚æ•°
       synchronized (lock) {
           // Update threshold only if the threshold is greater than the
           // current expected threshold of if the self preservation is disabled.
           if ((count * 2) > (serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold)
                   || (!this.isSelfPreservationModeEnabled())) {
               this.expectedNumberOfRenewsPerMin = count * 2;
               this.numberOfRenewsPerMinThreshold = (int) ((count * 2) * serverConfig.getRenewalPercentThreshold());
           }
       }
       logger.info("Current renewal threshold is : {}", numberOfRenewsPerMinThreshold);
   } catch (Throwable e) {
       logger.error("Cannot update renewal threshold", e);
   }
}
```

* é…ç½® `eureka.renewalThresholdUpdateIntervalMs` å‚æ•°ï¼Œå®šæ—¶é‡æ–°è®¡ç®—ã€‚é»˜è®¤ï¼Œ15 åˆ†é’Ÿã€‚
* **ä»£ç å—** `!this.isSelfPreservationModeEnabled()` ï¼šå½“**æœªå¼€å¯**è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æ—¶ï¼Œæ¯æ¬¡éƒ½è¿›è¡Œé‡æ–°è®¡ç®—ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸ä»…ä»…è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ä¼šä½¿ç”¨åˆ°ï¼Œé…åˆ [Netflix Servo](https://github.com/Netflix/servo) å®ç°ç›‘æ§ä¿¡æ¯é‡‡é›† `numberOfRenewsPerMinThreshold`ã€`expectedNumberOfRenewsPerMin`ã€‚
* **ä»£ç å—** `(count * 2) > (serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold)` ï¼šå½“**å¼€å¯**è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æ—¶ï¼Œåº”ç”¨å®ä¾‹æ¯åˆ†é’Ÿæœ€å¤§å¿ƒè·³æ•°( `count * 2` ) å°äºæœŸæœ›**æœ€å°**æ¯åˆ†é’Ÿ**ç»­ç§Ÿ**æ¬¡æ•°( `serverConfig.getRenewalPercentThreshold() * numberOfRenewsPerMinThreshold` )ï¼Œä¸é‡æ–°è®¡ç®—ã€‚**å¦‚æœé‡æ–°è®¡ç®—ï¼Œè‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ä¼šæ¯æ¬¡å®šæ—¶æ‰§è¡Œåå¤±æ•ˆ**ã€‚

### 3.3.3 åº”ç”¨å®ä¾‹æ³¨å†Œ

åº”ç”¨å®ä¾‹æ³¨å†Œæ—¶ï¼Œå¢åŠ  `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin` ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// 
public void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) {
    
    // ... çœç•¥æ— å…³ä»£ç 
    
    // The lease does not exist and hence it is a new registration
    // ã€è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‘å¢åŠ  `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin`
    synchronized (lock) {
         if (this.expectedNumberOfRenewsPerMin > 0) {
             // Since the client wants to cancel it, reduce the threshold
             // (1
             // for 30 seconds, 2 for a minute)
             this.expectedNumberOfRenewsPerMin = this.expectedNumberOfRenewsPerMin + 2;
             this.numberOfRenewsPerMinThreshold =
                     (int) (this.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());
         }
     }

     // ... çœç•¥æ— å…³ä»£ç 
}
```

### 3.3.4 åº”ç”¨å®ä¾‹ä¸‹çº¿

åº”ç”¨å®ä¾‹ä¸‹çº¿æ—¶ï¼Œå‡å°‘ `numberOfRenewsPerMinThreshold` ã€`expectedNumberOfRenewsPerMin` ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š

```Java
// PeerAwareInstanceRegistryImpl.java
@Override
public boolean cancel(final String appName, final String id,
                     final boolean isReplication) {
   // ... çœç•¥æ— å…³ä»£ç 
                     
   synchronized (lock) {
        if (this.expectedNumberOfRenewsPerMin > 0) {
               // Since the client wants to cancel it, reduce the threshold (1 for 30 seconds, 2 for a minute)
               this.expectedNumberOfRenewsPerMin = this.expectedNumberOfRenewsPerMin - 2;
               this.numberOfRenewsPerMinThreshold = (int) (this.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());
        }
   }
   
   // ... çœç•¥æ— å…³ä»£ç 
}
```

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)

ğŸ˜ˆ ç»ˆäºå®Œæ•´ç†è§£ Eureka-Server è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œæ»¡è¶³ã€‚å™¶~~~~~~

æ¨èå¦ä¸€ç¯‡ Eureka-Server è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶æºç åˆ†ææ–‡ç« ï¼š[ã€Šç†è§£eurekaçš„è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‹](https://segmentfault.com/a/1190000009795944) ã€‚

èƒ–å‹ï¼Œåˆ†äº«æˆ‘çš„å…¬ä¼—å·( **èŠ‹é“æºç ** ) ç»™ä½ çš„èƒ–å‹å¯å¥½ï¼Ÿ


