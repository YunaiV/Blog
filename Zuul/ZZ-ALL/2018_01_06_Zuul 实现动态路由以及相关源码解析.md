title: Zuul å®ç°åŠ¨æ€è·¯ç”±ä»¥åŠç›¸å…³æºç è§£æ
date: 2018-01-06
tag: 
categories: Zuul
permalink: Zuul/yanghui/dynamic-route
author: æ¨è¾‰
from_url: https://segmentfault.com/a/1190000009191419
wechat_url: 

-------

æ‘˜è¦: åŸåˆ›å‡ºå¤„ https://segmentfault.com/a/1190000009191419 ã€Œæ¨è¾‰ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼


-------

![](http://www.iocoder.cn/images/common/wechat_mp_2017_07_31.jpg)

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š
> 1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
> 2. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
> 3. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
> 4. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
> 5. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

-------

å…³äºzuulå¦‚ä½•å®ç°åŠ¨æ€è·¯ç”±ï¼Œå·²ç»æœ‰å¤§ç¥å†™åšå®¢è¯¦è§£è¿‡ï¼Œè¿™é‡Œä¸å•°å—¦äº†ï¼Œæ–‡ç« åœ°å€ï¼š[Spring Cloud Zuulå®ç°åŠ¨æ€è·¯ç”±](http://mp.weixin.qq.com/s/4d-epBiq5b69fZTCSkiOzA)ï¼Œå’±ä»¬å°±ä»è¿™ç¯‡æ–‡ç« æœ€åçš„ä¸€ä¸ªé—®é¢˜è®²èµ·ï¼Œä½œè€…åœ¨æœ€åå®ç°åŠ¨æ€åˆ·æ–°è·¯ç”±è§„åˆ™æ—¶è¯´ï¼šä¸ºä»€ä¹ˆä¸è‡ªå·±æ˜¯æ‰‹åŠ¨é‡æ–°åŠ è½½Locator.dorefreshï¼Ÿéè¦ç”¨äº‹ä»¶å»åˆ·æ–°ï¼Ÿè¿™ç‰µæ‰¯åˆ°å†…éƒ¨çš„zuulå†…éƒ¨ç»„ä»¶çš„å·¥ä½œæµç¨‹ï¼Œä¸ä»…ä»…æ˜¯Locatoræœ¬èº«çš„ä¸€ä¸ªå˜é‡ï¼Œå…·ä½“æƒ³è¦äº†è§£çš„è¿˜å¾—å»çœ‹æºç ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸‹zuulçš„æºç çœ‹çœ‹ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿ
è¦è®²æ¸…æ¥šzuulçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œè¿˜å¾—çŸ¥é“springçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œå› ä¸ºzuulçš„å®ç°æ­£æ˜¯åˆ©ç”¨äº†springçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹å®ç°çš„ã€‚ä¸‹é¢çœ‹çœ‹springæä¾›çš„äº‹ä»¶æ¨¡å‹å›¾ï¼š![å›¾ç‰‡æè¿°](https://segmentfault.com/img/bVMJag?w=691&h=510)

åœ¨zuulä¸­æœ‰è¿™æ ·ä¸€ä¸ªå®ç°äº†ApplicationListenerçš„ç›‘å¬å™¨ZuulRefreshListener ï¼Œä»£ç å¦‚ä¸‹ï¼š

```Java
private static class ZuulRefreshListener implements ApplicationListener<ApplicationEvent> {

        @Autowired
        private ZuulHandlerMapping zuulHandlerMapping;

        private HeartbeatMonitor heartbeatMonitor = new HeartbeatMonitor();

        @Override
        public void onApplicationEvent(ApplicationEvent event) {
            if (event instanceof ContextRefreshedEvent
                    || event instanceof RefreshScopeRefreshedEvent
                    || event instanceof RoutesRefreshedEvent) {
                this.zuulHandlerMapping.setDirty(true);
            }
            else if (event instanceof HeartbeatEvent) {
                if (this.heartbeatMonitor.update(((HeartbeatEvent) event).getValue())) {
                    this.zuulHandlerMapping.setDirty(true);
                }
            }
        }

    }
```

ç”±æ­¤å¯çŸ¥åœ¨å‘ç”ŸContextRefreshedEventå’ŒRoutesRefreshedEventäº‹ä»¶æ—¶ä¼šæ‰§è¡Œthis.zuulHandlerMapping.setDirty(true);

```Java
public void setDirty(boolean dirty) {
        this.dirty = dirty;
        if (this.routeLocator instanceof RefreshableRouteLocator) {
            ((RefreshableRouteLocator) this.routeLocator).refresh();
        }
    }
```

è¿™æ ·åœ¨springå®¹å™¨å¯åŠ¨å®Œæˆåå°±åˆ·æ–°äº†è·¯ç”±è§„åˆ™ã€‚å› æ­¤æˆ‘ä»¬å¦‚æœè¦ä¸»åŠ¨åˆ·æ–°è·¯ç”±è§„åˆ™ï¼Œåªéœ€è¦å‘å¸ƒä¸€ä¸ªRoutesRefreshedEventäº‹ä»¶å³å¯ï¼Œä»£ç å¦‚ä¸‹

```Java
public void refreshRoute() {
        RoutesRefreshedEvent routesRefreshedEvent = new RoutesRefreshedEvent(routeLocator);
        this.publisher.publishEvent(routesRefreshedEvent);
        logger.info("åˆ·æ–°äº†è·¯ç”±è§„åˆ™......");
    }
```

# 666. å½©è›‹

å¦‚æœä½ å¯¹ Zuul  æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„çŸ¥è¯†æ˜Ÿçƒä¸€èµ·äº¤æµã€‚

![çŸ¥è¯†æ˜Ÿçƒ](http://www.iocoder.cn/images/Architecture/2017_12_29/01.png)